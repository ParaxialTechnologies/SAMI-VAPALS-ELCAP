KIDS Distribution saved on Jul 14, 2021@12:40:17
Test Patch SAMI*18.0*12 SEQ #12 T3 (1.18.0.12-t3+i12)
**KIDS**:SAMI*18.0*12^

**INSTALL NAME**
SAMI*18.0*12
"BLD",11510,0)
SAMI*18.0*12^SAMI^0^3210714^n
"BLD",11510,4,0)
^9.64PA^311.14^2
"BLD",11510,4,311.12,0)
311.12
"BLD",11510,4,311.12,222)
y^y^f^^^^n
"BLD",11510,4,311.14,0)
311.14
"BLD",11510,4,311.14,222)
y^y^f^^n^^y^o^n
"BLD",11510,4,"B",311.12,311.12)

"BLD",11510,4,"B",311.14,311.14)

"BLD",11510,6)
3^12
"BLD",11510,6.3)
6
"BLD",11510,"INID")
^n
"BLD",11510,"INIT")
POS1812^SAMIPAT
"BLD",11510,"KRN",0)
^9.67PA^1.5^25
"BLD",11510,"KRN",.4,0)
.4
"BLD",11510,"KRN",.401,0)
.401
"BLD",11510,"KRN",.402,0)
.402
"BLD",11510,"KRN",.403,0)
.403
"BLD",11510,"KRN",.5,0)
.5
"BLD",11510,"KRN",.84,0)
.84
"BLD",11510,"KRN",1.5,0)
1.5
"BLD",11510,"KRN",1.6,0)
1.6
"BLD",11510,"KRN",1.61,0)
1.61
"BLD",11510,"KRN",1.62,0)
1.62
"BLD",11510,"KRN",3.6,0)
3.6
"BLD",11510,"KRN",3.8,0)
3.8
"BLD",11510,"KRN",9.2,0)
9.2
"BLD",11510,"KRN",9.8,0)
9.8
"BLD",11510,"KRN",9.8,"NM",0)
^9.68A^22^22
"BLD",11510,"KRN",9.8,"NM",1,0)
SAMICAS2^^0^B443014182
"BLD",11510,"KRN",9.8,"NM",2,0)
SAMICAS3^^0^B495988167
"BLD",11510,"KRN",9.8,"NM",3,0)
SAMICASE^^0^B2476673
"BLD",11510,"KRN",9.8,"NM",4,0)
SAMICLOG^^0^B37383898
"BLD",11510,"KRN",9.8,"NM",5,0)
SAMICUL^^0^B144065
"BLD",11510,"KRN",9.8,"NM",6,0)
SAMIHOM3^^0^B168256875
"BLD",11510,"KRN",9.8,"NM",7,0)
SAMIHOM4^^0^B899962251
"BLD",11510,"KRN",9.8,"NM",8,0)
SAMIHUL^^0^B121785
"BLD",11510,"KRN",9.8,"NM",9,0)
SAMIJS1^^0^B33800885
"BLD",11510,"KRN",9.8,"NM",10,0)
SAMIJS2^^0^B50763648
"BLD",11510,"KRN",9.8,"NM",11,0)
SAMINOT1^^0^B476873160
"BLD",11510,"KRN",9.8,"NM",12,0)
SAMINOT2^^0^B473986639
"BLD",11510,"KRN",9.8,"NM",13,0)
SAMINUL^^0^B108214
"BLD",11510,"KRN",9.8,"NM",14,0)
SAMIORM^^0^B175905084
"BLD",11510,"KRN",9.8,"NM",15,0)
SAMIOUL^^0^B103895
"BLD",11510,"KRN",9.8,"NM",16,0)
SAMIPARM^^0^B7351392
"BLD",11510,"KRN",9.8,"NM",17,0)
SAMIPAT^^0^B576661
"BLD",11510,"KRN",9.8,"NM",18,0)
SAMISITE^^0^B91065013
"BLD",11510,"KRN",9.8,"NM",19,0)
SAMITTW^^0^B5460827
"BLD",11510,"KRN",9.8,"NM",20,0)
SAMIUR^^0^B504449514
"BLD",11510,"KRN",9.8,"NM",21,0)
SAMIUR2^^0^B1203305457
"BLD",11510,"KRN",9.8,"NM",22,0)
SAMIURUL^^0^B108116
"BLD",11510,"KRN",9.8,"NM","B","SAMICAS2",1)

"BLD",11510,"KRN",9.8,"NM","B","SAMICAS3",2)

"BLD",11510,"KRN",9.8,"NM","B","SAMICASE",3)

"BLD",11510,"KRN",9.8,"NM","B","SAMICLOG",4)

"BLD",11510,"KRN",9.8,"NM","B","SAMICUL",5)

"BLD",11510,"KRN",9.8,"NM","B","SAMIHOM3",6)

"BLD",11510,"KRN",9.8,"NM","B","SAMIHOM4",7)

"BLD",11510,"KRN",9.8,"NM","B","SAMIHUL",8)

"BLD",11510,"KRN",9.8,"NM","B","SAMIJS1",9)

"BLD",11510,"KRN",9.8,"NM","B","SAMIJS2",10)

"BLD",11510,"KRN",9.8,"NM","B","SAMINOT1",11)

"BLD",11510,"KRN",9.8,"NM","B","SAMINOT2",12)

"BLD",11510,"KRN",9.8,"NM","B","SAMINUL",13)

"BLD",11510,"KRN",9.8,"NM","B","SAMIORM",14)

"BLD",11510,"KRN",9.8,"NM","B","SAMIOUL",15)

"BLD",11510,"KRN",9.8,"NM","B","SAMIPARM",16)

"BLD",11510,"KRN",9.8,"NM","B","SAMIPAT",17)

"BLD",11510,"KRN",9.8,"NM","B","SAMISITE",18)

"BLD",11510,"KRN",9.8,"NM","B","SAMITTW",19)

"BLD",11510,"KRN",9.8,"NM","B","SAMIUR",20)

"BLD",11510,"KRN",9.8,"NM","B","SAMIUR2",21)

"BLD",11510,"KRN",9.8,"NM","B","SAMIURUL",22)

"BLD",11510,"KRN",19,0)
19
"BLD",11510,"KRN",19,"NM",0)
^9.68A^^
"BLD",11510,"KRN",19.1,0)
19.1
"BLD",11510,"KRN",101,0)
101
"BLD",11510,"KRN",409.61,0)
409.61
"BLD",11510,"KRN",771,0)
771
"BLD",11510,"KRN",779.2,0)
779.2
"BLD",11510,"KRN",870,0)
870
"BLD",11510,"KRN",8989.51,0)
8989.51
"BLD",11510,"KRN",8989.52,0)
8989.52
"BLD",11510,"KRN",8993,0)
8993
"BLD",11510,"KRN",8994,0)
8994
"BLD",11510,"KRN","B",.4,.4)

"BLD",11510,"KRN","B",.401,.401)

"BLD",11510,"KRN","B",.402,.402)

"BLD",11510,"KRN","B",.403,.403)

"BLD",11510,"KRN","B",.5,.5)

"BLD",11510,"KRN","B",.84,.84)

"BLD",11510,"KRN","B",1.5,1.5)

"BLD",11510,"KRN","B",1.6,1.6)

"BLD",11510,"KRN","B",1.61,1.61)

"BLD",11510,"KRN","B",1.62,1.62)

"BLD",11510,"KRN","B",3.6,3.6)

"BLD",11510,"KRN","B",3.8,3.8)

"BLD",11510,"KRN","B",9.2,9.2)

"BLD",11510,"KRN","B",9.8,9.8)

"BLD",11510,"KRN","B",19,19)

"BLD",11510,"KRN","B",19.1,19.1)

"BLD",11510,"KRN","B",101,101)

"BLD",11510,"KRN","B",409.61,409.61)

"BLD",11510,"KRN","B",771,771)

"BLD",11510,"KRN","B",779.2,779.2)

"BLD",11510,"KRN","B",870,870)

"BLD",11510,"KRN","B",8989.51,8989.51)

"BLD",11510,"KRN","B",8989.52,8989.52)

"BLD",11510,"KRN","B",8993,8993)

"BLD",11510,"KRN","B",8994,8994)

"BLD",11510,"QUES",0)
^9.62^^
"BLD",11510,"REQB",0)
^9.611^10^10
"BLD",11510,"REQB",1,0)
SAMI*18.0*1^0
"BLD",11510,"REQB",2,0)
SAMI*18.0*2^0
"BLD",11510,"REQB",3,0)
SAMI*18.0*3^0
"BLD",11510,"REQB",4,0)
SAMI*18.0*4^0
"BLD",11510,"REQB",5,0)
SAMI 18.0T05^0
"BLD",11510,"REQB",6,0)
SAMI*18.0*6^0
"BLD",11510,"REQB",7,0)
SAMI*18.0*8^0
"BLD",11510,"REQB",8,0)
SAMI*18.0*9^0
"BLD",11510,"REQB",9,0)
SAMI*18.0*10^0
"BLD",11510,"REQB",10,0)
SAMI*18.0*11^0
"BLD",11510,"REQB","B","SAMI 18.0T05",5)

"BLD",11510,"REQB","B","SAMI*18.0*1",1)

"BLD",11510,"REQB","B","SAMI*18.0*10",9)

"BLD",11510,"REQB","B","SAMI*18.0*11",10)

"BLD",11510,"REQB","B","SAMI*18.0*2",2)

"BLD",11510,"REQB","B","SAMI*18.0*3",3)

"BLD",11510,"REQB","B","SAMI*18.0*4",4)

"BLD",11510,"REQB","B","SAMI*18.0*6",6)

"BLD",11510,"REQB","B","SAMI*18.0*8",7)

"BLD",11510,"REQB","B","SAMI*18.0*9",8)

"DATA",311.14,1,0)
Non VA
"DATA",311.14,1,1,0)
^311.141^5^5
"DATA",311.14,1,1,1,0)
socialSecurityNumber^Patient ID
"DATA",311.14,1,1,2,0)
socialSecurityNumber.short^PID
"DATA",311.14,1,1,3,0)
socialSecurityNumber.mask
"DATA",311.14,1,1,4,0)
socialSecurityNumber.regex
"DATA",311.14,1,1,5,0)
matchingReportEnabled^false
"DATA",311.14,2,0)
VHA
"DATA",311.14,2,1,0)
^311.141^5^5
"DATA",311.14,2,1,1,0)
socialSecurityNumber^Social Security Number
"DATA",311.14,2,1,2,0)
socialSecurityNumber.short^SSN
"DATA",311.14,2,1,3,0)
socialSecurityNumber.mask^000-00-0000
"DATA",311.14,2,1,4,0)
socialSecurityNumber.regex^`(?!(000|666|9(?!99)))\d{3}-(?!00)\d{2}-(?!0000)\d{4}$
"DATA",311.14,2,1,5,0)
matchingReportEnabled^false
"FIA",311.12)
SAMI SITE
"FIA",311.12,0)
^SAMI(311.12,
"FIA",311.12,0,0)
311.12PI
"FIA",311.12,0,1)
y^y^f^^^^n
"FIA",311.12,0,10)

"FIA",311.12,0,11)

"FIA",311.12,0,"RLRO")

"FIA",311.12,0,"VR")
18.0^SAMI
"FIA",311.12,311.12)
0
"FIA",311.12,311.121)
0
"FIA",311.14)
SAMI PARAMETER DEFAULTS
"FIA",311.14,0)
^SAMI(311.14,
"FIA",311.14,0,0)
311.14
"FIA",311.14,0,1)
y^y^f^^n^^y^o^n
"FIA",311.14,0,10)

"FIA",311.14,0,11)

"FIA",311.14,0,"RLRO")

"FIA",311.14,0,"VR")
18.0^SAMI
"FIA",311.14,311.14)
0
"FIA",311.14,311.141)
0
"INIT")
POS1812^SAMIPAT
"IX",311.12,311.12,"D",0)
311.12^D^PARAMETER VALUES^MU^^F^IR^W^311.121^^^^^LS
"IX",311.12,311.12,"D",1)
S ^SAMI(311.12,"D",X(1),X(3))=$TR(X(2),"`","^")
"IX",311.12,311.12,"D",2)
K ^SAMI(311.12,"D",X(1),X(3))
"IX",311.12,311.12,"D",2.5)
K ^SAMI(311.12,"D")
"IX",311.12,311.12,"D",11.1,0)
^.114IA^3^3
"IX",311.12,311.12,"D",11.1,1,0)
1^C^^^30^1
"IX",311.12,311.12,"D",11.1,1,1.5)
S X=$$GET1^DIQ(311.12,DA(1)_",",.02)
"IX",311.12,311.12,"D",11.1,2,0)
2^C
"IX",311.12,311.12,"D",11.1,2,1.5)
S X=$$GET1^DIQ(311.121,DA_","_DA(1)_",",.02)
"IX",311.12,311.12,"D",11.1,3,0)
3^F^311.121^.01^30^2^F
"IX",311.12,311.12,"SYM",0)
311.12^SYM^REGULAR XREF ON THE SYMBOL FIELD^R^^F^IR^I^311.12^^^^^LS
"IX",311.12,311.12,"SYM",1)
S ^SAMI(311.12,"SYM",$E(X,1,3),DA)=""
"IX",311.12,311.12,"SYM",2)
K ^SAMI(311.12,"SYM",$E(X,1,3),DA)
"IX",311.12,311.12,"SYM",2.5)
K ^SAMI(311.12,"SYM")
"IX",311.12,311.12,"SYM",11.1,0)
^.114IA^1^1
"IX",311.12,311.12,"SYM",11.1,1,0)
1^F^311.12^.02^3^1^F
"IX",311.14,311.14,"D",0)
311.14^D^PARMS^MU^^F^IR^W^311.141^^^^^LS
"IX",311.14,311.14,"D",1)
S ^SAMI(311.14,"D",X(1),X(3))=$TR(X(2),"`","^")
"IX",311.14,311.14,"D",2)
K ^SAMI(311.14,"D",X(1))
"IX",311.14,311.14,"D",2.5)
K ^SAMI(311.14,"D")
"IX",311.14,311.14,"D",11.1,0)
^.114IA^3^3
"IX",311.14,311.14,"D",11.1,1,0)
1^C^^^30^1
"IX",311.14,311.14,"D",11.1,1,1.5)
S X=$$GET1^DIQ(311.14,DA(1)_",",.01)
"IX",311.14,311.14,"D",11.1,2,0)
2^C
"IX",311.14,311.14,"D",11.1,2,1.5)
S X=$$GET1^DIQ(311.141,DA_","_DA(1)_",",.02)
"IX",311.14,311.14,"D",11.1,3,0)
3^F^311.141^.01^^2^F
"IX",311.14,311.14,"D",11.1,3,3)

"MBREQ")
0
"PKG",230,-1)
1^1
"PKG",230,0)
SAMI^SAMI^SCREENING APPLICATIONS MANAGEMENT - IELCAP
"PKG",230,22,0)
^9.49I^1^1
"PKG",230,22,1,0)
18.0^3191203
"PKG",230,22,1,"PAH",1,0)
12^3210714^66
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
22
"RTN","SAMICAS2")
0^1^B443014182
"RTN","SAMICAS2",1,0)
SAMICAS2 ;ven/gpl - case review cont ;2021-07-01t15:42z
"RTN","SAMICAS2",2,0)
 ;;18.0;SAMI;**1,5,9,12**;2020-01;Build 6
"RTN","SAMICAS2",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMICAS2",4,0)
 ;
"RTN","SAMICAS2",5,0)
 ; SAMICAS2 contains ppis and other subroutines to support processing
"RTN","SAMICAS2",6,0)
 ; of the VAPALS case review page.
"RTN","SAMICAS2",7,0)
 ;
"RTN","SAMICAS2",8,0)
 quit  ; no entry from top
"RTN","SAMICAS2",9,0)
 ;
"RTN","SAMICAS2",10,0)
 ;
"RTN","SAMICAS2",11,0)
 ;
"RTN","SAMICAS2",12,0)
 ;@section 0 primary development
"RTN","SAMICAS2",13,0)
 ;
"RTN","SAMICAS2",14,0)
 ;
"RTN","SAMICAS2",15,0)
 ;
"RTN","SAMICAS2",16,0)
 ;@routine-credits
"RTN","SAMICAS2",17,0)
 ;@license see routine SAMIUL
"RTN","SAMICAS2",18,0)
 ;@documentation see SAMICUL
"RTN","SAMICAS2",19,0)
 ;@contents
"RTN","SAMICAS2",20,0)
 ; WSCASE wri-code WSCASE^SAMICASE, post vapals casereview:
"RTN","SAMICAS2",21,0)
 ;  generate case review page
"RTN","SAMICAS2",22,0)
 ; $$NOTEHREF ppi-code $$NOTEHREF^SAMICASE, 
"RTN","SAMICAS2",23,0)
 ;  html list of notes for form
"RTN","SAMICAS2",24,0)
 ; GETTMPL ppi-code GETTMPL^SAMICASE, get html template
"RTN","SAMICAS2",25,0)
 ; $$CNTITEMS = # forms patient has used before deleting patient
"RTN","SAMICAS2",26,0)
 ; GETITEMS ppi-code GETITEMS^SAMICASE
"RTN","SAMICAS2",27,0)
 ;  get items available for studyid
"RTN","SAMICAS2",28,0)
 ; $$GETDTKEY date part of form key
"RTN","SAMICAS2",29,0)
 ; $$KEY2DSPD date in elcap format from key date
"RTN","SAMICAS2",30,0)
 ; $$VAPALSDT ppi-code $$VAPALSDT^SAMICASE, vapals format for dates
"RTN","SAMICAS2",31,0)
 ;
"RTN","SAMICAS2",32,0)
 ; WSNUFORM wri-code WSNUFORM^SAMICASE, post vapals nuform:
"RTN","SAMICAS2",33,0)
 ;  new form for patient
"RTN","SAMICAS2",34,0)
 ; $$KEY2FM ppi-code $$KEY2FM^SAMICASE, convert key to fileman date
"RTN","SAMICAS2",35,0)
 ;
"RTN","SAMICAS2",36,0)
 ; $$GSAMISTA value of 'samistatus' from form
"RTN","SAMICAS2",37,0)
 ; SSAMISTA ppi-code SSAMISTA^SAMICASE, set samistatus to val in form
"RTN","SAMICAS2",38,0)
 ; DELFORM wri-code DELFORM^SAMICASE, post vapals deleteform:
"RTN","SAMICAS2",39,0)
 ;  delete incomplete form
"RTN","SAMICAS2",40,0)
 ; INITSTAT set all forms to 'incomplete'
"RTN","SAMICAS2",41,0)
 ;
"RTN","SAMICAS2",42,0)
 ;
"RTN","SAMICAS2",43,0)
 ;
"RTN","SAMICAS2",44,0)
 ;@section 1 wsCASE & related ppis
"RTN","SAMICAS2",45,0)
 ;
"RTN","SAMICAS2",46,0)
 ;
"RTN","SAMICAS2",47,0)
 ;
"RTN","SAMICAS2",48,0)
 ;@wri-code WSCASE^SAMICASE
"RTN","SAMICAS2",49,0)
WSCASE ; post vapals casereview: generate case review page
"RTN","SAMICAS2",50,0)
 ;
"RTN","SAMICAS2",51,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",52,0)
 ;
"RTN","SAMICAS2",53,0)
 ;ven/gpl;wri;procedure;silent;clean;sac;??% tests
"RTN","SAMICAS2",54,0)
 ;@signature
"RTN","SAMICAS2",55,0)
 ; do WSCASE^SAMICASE(rtn,filter)
"RTN","SAMICAS2",56,0)
 ;@branches-from
"RTN","SAMICAS2",57,0)
 ; WSCASE^SAMICASE
"RTN","SAMICAS2",58,0)
 ;@wri-called-by
"RTN","SAMICAS2",59,0)
 ; wsPostForm^%wfhform
"RTN","SAMICAS2",60,0)
 ; DELFORM^SAMICASE
"RTN","SAMICAS2",61,0)
 ; WSNFPOST^SAMICASE
"RTN","SAMICAS2",62,0)
 ; WSVAPALS^SAMIHOM3 [wsi for ws post vapals]
"RTN","SAMICAS2",63,0)
 ; WSLOOKUP^SAMISRC2
"RTN","SAMICAS2",64,0)
 ; wsPostForm^SAMIZ2
"RTN","SAMICAS2",65,0)
 ;@called-by none
"RTN","SAMICAS2",66,0)
 ;@calls
"RTN","SAMICAS2",67,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",68,0)
 ; GETTMPL^SAMICASE
"RTN","SAMICAS2",69,0)
 ; GETITEMS^SAMICASE
"RTN","SAMICAS2",70,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS2",71,0)
 ; findReplace^%ts
"RTN","SAMICAS2",72,0)
 ; FIXHREF^SAMIFORM
"RTN","SAMICAS2",73,0)
 ; FIXSRC^SAMIFORM
"RTN","SAMICAS2",74,0)
 ; $$GETDTKEY
"RTN","SAMICAS2",75,0)
 ; $$KEY2DSPD
"RTN","SAMICAS2",76,0)
 ; $$GETLAST5^SAMIFORM
"RTN","SAMICAS2",77,0)
 ; $$GETSSN^SAMIFORM
"RTN","SAMICAS2",78,0)
 ; $$GETNAME^SAMIFORM
"RTN","SAMICAS2",79,0)
 ; $$GSAMISTA
"RTN","SAMICAS2",80,0)
 ; D ADDCRLF^VPRJRUT
"RTN","SAMICAS2",81,0)
 ;@input
"RTN","SAMICAS2",82,0)
 ; .filter =
"RTN","SAMICAS2",83,0)
 ; .filter("studyid")=studyid of the patient
"RTN","SAMICAS2",84,0)
 ;@output
"RTN","SAMICAS2",85,0)
 ; .rtn
"RTN","SAMICAS2",86,0)
 ;@tests
"RTN","SAMICAS2",87,0)
 ; UTWSCAS^SAMIUTS2
"RTN","SAMICAS2",88,0)
 ;
"RTN","SAMICAS2",89,0)
 ;
"RTN","SAMICAS2",90,0)
 ;@stanza 2 initialize
"RTN","SAMICAS2",91,0)
 ;
"RTN","SAMICAS2",92,0)
 kill rtn
"RTN","SAMICAS2",93,0)
 ;
"RTN","SAMICAS2",94,0)
 new groot set groot=$$setroot^%wd("vapals-patients") ; root of patient graphs
"RTN","SAMICAS2",95,0)
 ;
"RTN","SAMICAS2",96,0)
 new temp ; html template
"RTN","SAMICAS2",97,0)
 do GETTMPL^SAMICASE("temp","vapals:casereview")
"RTN","SAMICAS2",98,0)
 quit:'$data(temp)
"RTN","SAMICAS2",99,0)
 ;
"RTN","SAMICAS2",100,0)
 new sid set sid=$get(filter("studyid"))
"RTN","SAMICAS2",101,0)
 if sid="" set sid=$get(filter("studyId"))
"RTN","SAMICAS2",102,0)
 if sid="" set sid=$get(filter("fvalue"))
"RTN","SAMICAS2",103,0)
 quit:sid=""
"RTN","SAMICAS2",104,0)
 ;
"RTN","SAMICAS2",105,0)
 new items
"RTN","SAMICAS2",106,0)
 do GETITEMS^SAMICASE("items",sid)
"RTN","SAMICAS2",107,0)
 quit:'$data(items)
"RTN","SAMICAS2",108,0)
 ;
"RTN","SAMICAS2",109,0)
 new gien set gien=$$SID2NUM^SAMIHOM3(sid) ; graph ien
"RTN","SAMICAS2",110,0)
 new name set name=$get(@groot@(gien,"saminame"))
"RTN","SAMICAS2",111,0)
 quit:name=""
"RTN","SAMICAS2",112,0)
 new fname set fname=$piece(name,",",2)
"RTN","SAMICAS2",113,0)
 new lname set lname=$piece(name,",")
"RTN","SAMICAS2",114,0)
 ;
"RTN","SAMICAS2",115,0)
 ;
"RTN","SAMICAS2",116,0)
 ;@stanza 3 change resource paths to /see/
"RTN","SAMICAS2",117,0)
 ;
"RTN","SAMICAS2",118,0)
 new cnt set cnt=0
"RTN","SAMICAS2",119,0)
 new zi set zi=0
"RTN","SAMICAS2",120,0)
 ;for  set zi=$order(temp(zi)) quit:+zi=0  quit:temp(zi)["VEP0001"  do  ;
"RTN","SAMICAS2",121,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  quit:temp(zi)["tbody"  do  ;
"RTN","SAMICAS2",122,0)
 . new ln set ln=temp(zi)
"RTN","SAMICAS2",123,0)
 . new touched set touched=0
"RTN","SAMICAS2",124,0)
 . ;
"RTN","SAMICAS2",125,0)
 . if ln["@@SITE@@" do  ; insert site id
"RTN","SAMICAS2",126,0)
 . . n siteid s siteid=$g(filter("siteid"))
"RTN","SAMICAS2",127,0)
 . . i siteid="" s siteid=$g(filter("site"))
"RTN","SAMICAS2",128,0)
 . . q:siteid=""
"RTN","SAMICAS2",129,0)
 . . do findReplace^%ts(.ln,"@@SITE@@",siteid)
"RTN","SAMICAS2",130,0)
 . . s temp(zi)=ln
"RTN","SAMICAS2",131,0)
 . ;
"RTN","SAMICAS2",132,0)
 . if ln["@@SITETITLE@@" do  ; insert site title
"RTN","SAMICAS2",133,0)
 . . n sitetit s sitetit=$g(filter("sitetitle"))
"RTN","SAMICAS2",134,0)
 . . if sitetit="" d  ;
"RTN","SAMICAS2",135,0)
 . . . n tsite s tsite=$g(filter("site"))
"RTN","SAMICAS2",136,0)
 . . . q:tsite=""
"RTN","SAMICAS2",137,0)
 . . . s sitetit=$$SITENM2^SAMISITE(tsite)_" - "_tsite
"RTN","SAMICAS2",138,0)
 . . q:sitetit=""
"RTN","SAMICAS2",139,0)
 . . do findReplace^%ts(.ln,"@@SITETITLE@@",sitetit)
"RTN","SAMICAS2",140,0)
 . . s temp(zi)=ln
"RTN","SAMICAS2",141,0)
 . ;
"RTN","SAMICAS2",142,0)
 . if ln["id" if ln["studyIdMenu" do  ;
"RTN","SAMICAS2",143,0)
 . . set zi=zi+4
"RTN","SAMICAS2",144,0)
 . ;
"RTN","SAMICAS2",145,0)
 . if ln["home.html" do  ;
"RTN","SAMICAS2",146,0)
 . . do findReplace^%ts(.ln,"home.html","/vapals")
"RTN","SAMICAS2",147,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",148,0)
 . . set touched=1
"RTN","SAMICAS2",149,0)
 . ;
"RTN","SAMICAS2",150,0)
 . if ln["href" if 'touched do  ;
"RTN","SAMICAS2",151,0)
 . . do FIXHREF^SAMIFORM(.ln)
"RTN","SAMICAS2",152,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",153,0)
 . ;
"RTN","SAMICAS2",154,0)
 . if ln["src" do  ;
"RTN","SAMICAS2",155,0)
 . . do FIXSRC^SAMIFORM(.ln)
"RTN","SAMICAS2",156,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",157,0)
 . ;
"RTN","SAMICAS2",158,0)
 . if ln["@@ERROR_MESSAGE@@" do  ; insert error message
"RTN","SAMICAS2",159,0)
 . . n zerr s zerr=$g(filter("errorMessage"))
"RTN","SAMICAS2",160,0)
 . . i zerr="" q  ;
"RTN","SAMICAS2",161,0)
 . . do findReplace^%ts(.ln,"@@ERROR_MESSAGE@@",zerr)
"RTN","SAMICAS2",162,0)
 . . s temp(zi)=ln
"RTN","SAMICAS2",163,0)
 . ;
"RTN","SAMICAS2",164,0)
 . set cnt=cnt+1
"RTN","SAMICAS2",165,0)
 . set rtn(cnt)=temp(zi)
"RTN","SAMICAS2",166,0)
 . quit
"RTN","SAMICAS2",167,0)
 ;
"RTN","SAMICAS2",168,0)
 ; ready to insert rows for selection
"RTN","SAMICAS2",169,0)
 ;
"RTN","SAMICAS2",170,0)
 ;
"RTN","SAMICAS2",171,0)
 ;@stanza 4 intake form
"RTN","SAMICAS2",172,0)
 ;
"RTN","SAMICAS2",173,0)
 new sikey set sikey=$order(items("sifor"))
"RTN","SAMICAS2",174,0)
 if sikey="" set sikey="siform-2017-12-10"
"RTN","SAMICAS2",175,0)
 new sidate set sidate=$$GETDTKEY(sikey)
"RTN","SAMICAS2",176,0)
 set sikey="vapals:"_sikey
"RTN","SAMICAS2",177,0)
 new sidispdate set sidispdate=$$KEY2DSPD(sidate)
"RTN","SAMICAS2",178,0)
 ;new geturl set geturl="/form?form=vapals:siform&studyid="_sid_"&key="_sikey
"RTN","SAMICAS2",179,0)
 new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMICAS2",180,0)
 set nuhref=nuhref_"<td><input type=hidden name=""samiroute"" value=""nuform"">"
"RTN","SAMICAS2",181,0)
 set nuhref=nuhref_"<input type=hidden name=""studyid"" value="_sid_">"
"RTN","SAMICAS2",182,0)
 set nuhref=nuhref_"<input value=""New Form"" class=""btn label label-warning"" role=""link"" type=""submit""></form></td>"
"RTN","SAMICAS2",183,0)
 ; new intake notes table
"RTN","SAMICAS2",184,0)
 n notehref,form
"RTN","SAMICAS2",185,0)
 set form=$p(sikey,":",2)
"RTN","SAMICAS2",186,0)
 set notehref=$$NOTEHREF^SAMICASE(sid,form) ; table of notes
"RTN","SAMICAS2",187,0)
 set cnt=cnt+1
"RTN","SAMICAS2",188,0)
 ;new facilitycode set facilitycode=$$GETPRFX^SAMIFORM()
"RTN","SAMICAS2",189,0)
 n siteid s siteid=$g(filter("siteid"))
"RTN","SAMICAS2",190,0)
 i siteid="" s siteid=$g(filter("site"))
"RTN","SAMICAS2",191,0)
 new facilitycode set facilitycode=siteid
"RTN","SAMICAS2",192,0)
 new last5 set last5=$$GETLAST5^SAMIFORM(sid)
"RTN","SAMICAS2",193,0)
 new pssn set pssn=$$GETSSN^SAMIFORM(sid)
"RTN","SAMICAS2",194,0)
 new pname set pname=$$GETNAME^SAMIFORM(sid)
"RTN","SAMICAS2",195,0)
 new useid set useid=pssn
"RTN","SAMICAS2",196,0)
 if useid="" set useid=last5
"RTN","SAMICAS2",197,0)
 set rtn(cnt)="<tr><td> "_useid_" </td><td> "_pname_" </td><td> "_facilitycode_" </td><td>"_sidispdate_"</td><td>"_$char(13)
"RTN","SAMICAS2",198,0)
 set cnt=cnt+1
"RTN","SAMICAS2",199,0)
 set rtn(cnt)="<form method=""post"" action=""/vapals"">"
"RTN","SAMICAS2",200,0)
 set cnt=cnt+1
"RTN","SAMICAS2",201,0)
 set rtn(cnt)="<input name=""samiroute"" value=""form"" type=""hidden"">"
"RTN","SAMICAS2",202,0)
 set rtn(cnt)=rtn(cnt)_" <input name=""studyid"" value="""_sid_""" type=""hidden"">"
"RTN","SAMICAS2",203,0)
 set rtn(cnt)=rtn(cnt)_" <input name=""form"" value="""_sikey_""" type=""hidden"">"
"RTN","SAMICAS2",204,0)
 set rtn(cnt)=rtn(cnt)_" <input value=""Intake"" class=""btn btn-link"" role=""link"" type=""submit"">"
"RTN","SAMICAS2",205,0)
 ;
"RTN","SAMICAS2",206,0)
 new samistatus set samistatus=""
"RTN","SAMICAS2",207,0)
 if $$GSAMISTA(sid,sikey)="incomplete" set samistatus="(incomplete)"
"RTN","SAMICAS2",208,0)
 set cnt=cnt+1
"RTN","SAMICAS2",209,0)
 set rtn(cnt)="</form>"_samistatus_notehref_"</td>"_$char(13)
"RTN","SAMICAS2",210,0)
 set cnt=cnt+1
"RTN","SAMICAS2",211,0)
 set rtn(cnt)=nuhref_"</tr>"
"RTN","SAMICAS2",212,0)
 ;
"RTN","SAMICAS2",213,0)
 ;
"RTN","SAMICAS2",214,0)
 ;@stanza 6 rest of the forms
"RTN","SAMICAS2",215,0)
 ;
"RTN","SAMICAS2",216,0)
 new zj set zj="" ; each of the rest of the forms
"RTN","SAMICAS2",217,0)
 if $data(items("sort")) do  ; we have more forms
"RTN","SAMICAS2",218,0)
 . for  set zj=$order(items("sort",zj)) quit:zj=""  do  ;
"RTN","SAMICAS2",219,0)
 . . new cdate set cdate=zj
"RTN","SAMICAS2",220,0)
 . . new zk set zk=""
"RTN","SAMICAS2",221,0)
 . . for  set zk=$order(items("sort",cdate,zk)) q:zk=""  do  ;
"RTN","SAMICAS2",222,0)
 . . . new zform set zform=zk
"RTN","SAMICAS2",223,0)
 . . . new zkey set zkey=$order(items("sort",cdate,zform,""))
"RTN","SAMICAS2",224,0)
 . . . new zname set zname=$order(items("sort",cdate,zform,zkey,""))
"RTN","SAMICAS2",225,0)
 . . . new dispdate set dispdate=$$KEY2DSPD(cdate)
"RTN","SAMICAS2",226,0)
 . . . set zform="vapals:"_zkey ; all the new forms are vapals:key
"RTN","SAMICAS2",227,0)
 . . . ;new geturl set geturl="/form?form="_zform_"&studyid="_sid_"&key="_zkey
"RTN","SAMICAS2",228,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",229,0)
 . . . ;set rtn(cnt)="<tr><td> "_sid_" </td><td> - </td><td> - </td><td> - </td><td>"_dispdate_"</td><td>"
"RTN","SAMICAS2",230,0)
 . . . set rtn(cnt)="<tr><td> "_useid_" </td><td> - </td><td> - </td><td>"_dispdate_"</td><td>"
"RTN","SAMICAS2",231,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",232,0)
 . . . set rtn(cnt)="<form method=""post"" action=""/vapals"">"_$char(13)
"RTN","SAMICAS2",233,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",234,0)
 . . . set rtn(cnt)="<input name=""samiroute"" value=""form"" type=""hidden"">"_$char(13)
"RTN","SAMICAS2",235,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",236,0)
 . . . set rtn(cnt)=" <input name=""studyid"" value="""_sid_""" type=""hidden"">"_$char(13)
"RTN","SAMICAS2",237,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",238,0)
 . . . set rtn(cnt)=" <input name=""form"" value="""_zform_""" type=""hidden"">"_$char(13)
"RTN","SAMICAS2",239,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",240,0)
 . . . set rtn(cnt)=" <input value="""_zname_""" class=""btn btn-link"" role=""link"" type=""submit"">"_$char(13)
"RTN","SAMICAS2",241,0)
 . . . ;
"RTN","SAMICAS2",242,0)
 . . . new samistatus set samistatus=""
"RTN","SAMICAS2",243,0)
 . . . if $$GSAMISTA(sid,zform)="incomplete" set samistatus="(incomplete)"
"RTN","SAMICAS2",244,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",245,0)
 . . . set rtn(cnt)="</form>"_samistatus_$$NOTEHREF^SAMICASE(sid,zkey)_"</td>"
"RTN","SAMICAS2",246,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",247,0)
 . . . if zform["ceform" do  ;
"RTN","SAMICAS2",248,0)
 . . . . new rpthref set rpthref="<form method=POST action=""/vapals"">"
"RTN","SAMICAS2",249,0)
 . . . . set rpthref=rpthref_"<td><input type=hidden name=""samiroute"" value=""ctreport"">"
"RTN","SAMICAS2",250,0)
 . . . . set rpthref=rpthref_"<input type=hidden name=""form"" value="_$p(zform,":",2)_">"
"RTN","SAMICAS2",251,0)
 . . . . set rpthref=rpthref_"<input type=hidden name=""studyid"" value="_sid_">"
"RTN","SAMICAS2",252,0)
 . . . . set rpthref=rpthref_"<input value=""Report"" class=""btn label label-warning"" role=""link"" type=""submit""></form></td>"
"RTN","SAMICAS2",253,0)
 . . . . set rtn(cnt)=rpthref_"</tr>"
"RTN","SAMICAS2",254,0)
 . . . . ;set rtn(cnt)="</tr>" ; turn off report
"RTN","SAMICAS2",255,0)
 . . . else  set rtn(cnt)="<td></td></tr>"
"RTN","SAMICAS2",256,0)
 . . . quit
"RTN","SAMICAS2",257,0)
 . . quit
"RTN","SAMICAS2",258,0)
 . quit
"RTN","SAMICAS2",259,0)
 ;
"RTN","SAMICAS2",260,0)
 ;
"RTN","SAMICAS2",261,0)
 ;@stanza 7 skip ahead in template to tbody
"RTN","SAMICAS2",262,0)
 ;
"RTN","SAMICAS2",263,0)
 new loc set loc=zi+1
"RTN","SAMICAS2",264,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  quit:temp(zi)["/tbody"  do  ;
"RTN","SAMICAS2",265,0)
 . set x=$get(x)
"RTN","SAMICAS2",266,0)
 . quit
"RTN","SAMICAS2",267,0)
 set zi=zi-1
"RTN","SAMICAS2",268,0)
 ;
"RTN","SAMICAS2",269,0)
 ;
"RTN","SAMICAS2",270,0)
 ;@stanza 8 rest of lines
"RTN","SAMICAS2",271,0)
 ;
"RTN","SAMICAS2",272,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMICAS2",273,0)
 . new line
"RTN","SAMICAS2",274,0)
 . set line=temp(zi)
"RTN","SAMICAS2",275,0)
 . ;
"RTN","SAMICAS2",276,0)
 . if line["@@SITE@@" do  ; insert site id
"RTN","SAMICAS2",277,0)
 . . n siteid s siteid=$g(filter("siteid"))
"RTN","SAMICAS2",278,0)
 . . i siteid="" s siteid=$g(filter("site"))
"RTN","SAMICAS2",279,0)
 . . q:siteid=""
"RTN","SAMICAS2",280,0)
 . . do findReplace^%ts(.line,"@@SITE@@",siteid)
"RTN","SAMICAS2",281,0)
 . ;
"RTN","SAMICAS2",282,0)
 . if line["@@SITETITLE@@" do  ; insert site title
"RTN","SAMICAS2",283,0)
 . . n sitetit s sitetit=$g(filter("sitetitle"))
"RTN","SAMICAS2",284,0)
 . . if sitetit="" d  ;
"RTN","SAMICAS2",285,0)
 . . . n tsite s tsite=$g(filter("site"))
"RTN","SAMICAS2",286,0)
 . . . q:tsite=""
"RTN","SAMICAS2",287,0)
 . . . s sitetit=$$SITENM2^SAMISITE(tsite)_" - "_tsite
"RTN","SAMICAS2",288,0)
 . . q:sitetit=""
"RTN","SAMICAS2",289,0)
 . . do findReplace^%ts(.line,"@@SITETITLE@@",sitetit)
"RTN","SAMICAS2",290,0)
 . ;
"RTN","SAMICAS2",291,0)
 . if line["XX0002" do  ;
"RTN","SAMICAS2",292,0)
 . . do findReplace^%ts(.line,"XX0002",sid)
"RTN","SAMICAS2",293,0)
 . ;
"RTN","SAMICAS2",294,0)
 . if line["@@ERROR_MESSAGE@@" do  ;
"RTN","SAMICAS2",295,0)
 . . n zerr
"RTN","SAMICAS2",296,0)
 . . k ^gpl("error")
"RTN","SAMICAS2",297,0)
 . . m ^gpl("error")=filter
"RTN","SAMICAS2",298,0)
 . . s zerr=$g(filter("errorMessage"))
"RTN","SAMICAS2",299,0)
 . . ;i err="" q  ;
"RTN","SAMICAS2",300,0)
 . . s ^gpl("error","zerr")=zerr
"RTN","SAMICAS2",301,0)
 . . do findReplace^%ts(.line,"@@ERROR_MESSAGE@@",zerr)
"RTN","SAMICAS2",302,0)
 . . s ^gpl("error","newline")=line
"RTN","SAMICAS2",303,0)
 . set cnt=cnt+1
"RTN","SAMICAS2",304,0)
 . set rtn(cnt)=line
"RTN","SAMICAS2",305,0)
 . quit
"RTN","SAMICAS2",306,0)
 ;
"RTN","SAMICAS2",307,0)
 do ADDCRLF^VPRJRUT(.rtn)
"RTN","SAMICAS2",308,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMICAS2",309,0)
 ;
"RTN","SAMICAS2",310,0)
 ;
"RTN","SAMICAS2",311,0)
 ;@stanza 9 termination
"RTN","SAMICAS2",312,0)
 ;
"RTN","SAMICAS2",313,0)
 quit  ; end of ppi WSCASE^SAMICAS2
"RTN","SAMICAS2",314,0)
 ;
"RTN","SAMICAS2",315,0)
 ;
"RTN","SAMICAS2",316,0)
 ;
"RTN","SAMICAS2",317,0)
 ;@ppi-code $$NOTEHREF^SAMICASE
"RTN","SAMICAS2",318,0)
NOTEHREF ; html list of notes for form
"RTN","SAMICAS2",319,0)
 ;
"RTN","SAMICAS2",320,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",321,0)
 ;
"RTN","SAMICAS2",322,0)
 ;ven/gpl;ppi;function;clean;silent;sac;??? tests
"RTN","SAMICAS2",323,0)
 ;@signature
"RTN","SAMICAS2",324,0)
 ; $$NOTEHREF^SAMICASE(sid,form)
"RTN","SAMICAS2",325,0)
 ;@branches-from
"RTN","SAMICAS2",326,0)
 ; NOTEHREF^SAMICASE
"RTN","SAMICAS2",327,0)
 ;@ppi-called-by
"RTN","SAMICAS2",328,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICAS2",329,0)
 ;@called-by none
"RTN","SAMICAS2",330,0)
 ;@calls
"RTN","SAMICAS2",331,0)
 ; NTLIST^SAMINOT1
"RTN","SAMICAS2",332,0)
 ;@input
"RTN","SAMICAS2",333,0)
 ; sid = study id
"RTN","SAMICAS2",334,0)
 ; form
"RTN","SAMICAS2",335,0)
 ;@output = html list of notes
"RTN","SAMICAS2",336,0)
 ;@examples [tbd]
"RTN","SAMICAS2",337,0)
 ;@tests [tbd]
"RTN","SAMICAS2",338,0)
 ;
"RTN","SAMICAS2",339,0)
 ;
"RTN","SAMICAS2",340,0)
 ;@stanza 2 get list of notes
"RTN","SAMICAS2",341,0)
 ;
"RTN","SAMICAS2",342,0)
 new notehref set notehref=""
"RTN","SAMICAS2",343,0)
 new ntlist
"RTN","SAMICAS2",344,0)
 if form["sifor" do NTLIST^SAMINOT1("ntlist",sid,form)
"RTN","SAMICAS2",345,0)
 if form["fufor" do NTLIST^SAMINOT2("ntlist",sid,form)
"RTN","SAMICAS2",346,0)
 if $order(ntlist(""))="" quit notehref
"RTN","SAMICAS2",347,0)
 ;
"RTN","SAMICAS2",348,0)
 set notehref="<table>"
"RTN","SAMICAS2",349,0)
 new zi set zi=0
"RTN","SAMICAS2",350,0)
 for  do  quit:'zi
"RTN","SAMICAS2",351,0)
 . set zi=$order(ntlist(zi))
"RTN","SAMICAS2",352,0)
 . quit:'zi
"RTN","SAMICAS2",353,0)
 . ;
"RTN","SAMICAS2",354,0)
 . set notehref=notehref_"<td><form method=POST action=""/vapals"">"
"RTN","SAMICAS2",355,0)
 . set notehref=notehref_"<input type=hidden name=""nien"" value="""_$get(ntlist(zi,"nien"))_""">"
"RTN","SAMICAS2",356,0)
 . set notehref=notehref_"<input type=hidden name=""samiroute"" value=""note"">"
"RTN","SAMICAS2",357,0)
 . set notehref=notehref_"<input type=hidden name=""studyid"" value="_sid_">"
"RTN","SAMICAS2",358,0)
 . set notehref=notehref_"<input type=hidden name=""form"" value="_form_">"
"RTN","SAMICAS2",359,0)
 . set notehref=notehref_"<input value="""_$get(ntlist(zi,"name"))_""" class=""btn btn-link"" role=""link"" type=""submit""></form></td></tr>"
"RTN","SAMICAS2",360,0)
 . quit
"RTN","SAMICAS2",361,0)
 set notehref=notehref_"</table>"
"RTN","SAMICAS2",362,0)
 ;
"RTN","SAMICAS2",363,0)
 ;
"RTN","SAMICAS2",364,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",365,0)
 ;
"RTN","SAMICAS2",366,0)
 quit notehref ; end of ppi $$NOTEHREF^SAMICASE
"RTN","SAMICAS2",367,0)
 ;
"RTN","SAMICAS2",368,0)
 ;
"RTN","SAMICAS2",369,0)
 ;
"RTN","SAMICAS2",370,0)
 ;@ppi-code GETTMPL^SAMICASE
"RTN","SAMICAS2",371,0)
GETTMPL ; get html template
"RTN","SAMICAS2",372,0)
 ;
"RTN","SAMICAS2",373,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",374,0)
 ;
"RTN","SAMICAS2",375,0)
 ;ven/gpl;ppi;procedure;clean;silent;sac;??% tests
"RTN","SAMICAS2",376,0)
 ;@signature
"RTN","SAMICAS2",377,0)
 ; do GETTMPL^SAMICASE(return,form)
"RTN","SAMICAS2",378,0)
 ;@branches-from
"RTN","SAMICAS2",379,0)
 ; GETTMPL^SAMICASE
"RTN","SAMICAS2",380,0)
 ;@ppi-called-by
"RTN","SAMICAS2",381,0)
 ; WSCASE^SAMICAS2
"RTN","SAMICAS2",382,0)
 ; GETHOME^SAMIHOM4
"RTN","SAMICAS2",383,0)
 ; WSNOTE^SAMINOT1
"RTN","SAMICAS2",384,0)
 ; WSNOTE^SAMINOT2
"RTN","SAMICAS2",385,0)
 ; WSNOTE^SAMINOT3
"RTN","SAMICAS2",386,0)
 ; WSNOTE^SAMINOTI
"RTN","SAMICAS2",387,0)
 ;@called-by none
"RTN","SAMICAS2",388,0)
 ;@calls
"RTN","SAMICAS2",389,0)
 ; $$getTemplate^%wf
"RTN","SAMICAS2",390,0)
 ; getThis^%wd
"RTN","SAMICAS2",391,0)
 ;@input
"RTN","SAMICAS2",392,0)
 ; return = name of array to return template
"RTN","SAMICAS2",393,0)
 ; form = name of form
"RTN","SAMICAS2",394,0)
 ;@output
"RTN","SAMICAS2",395,0)
 ; @return = template
"RTN","SAMICAS2",396,0)
 ;@examples [tbd]
"RTN","SAMICAS2",397,0)
 ;@tests
"RTN","SAMICAS2",398,0)
 ; UTGTMPL^SAMIUTS2
"RTN","SAMICAS2",399,0)
 ;
"RTN","SAMICAS2",400,0)
 ;
"RTN","SAMICAS2",401,0)
 ;@stanza 2 get html template
"RTN","SAMICAS2",402,0)
 ;
"RTN","SAMICAS2",403,0)
 quit:$get(form)=""
"RTN","SAMICAS2",404,0)
 ;
"RTN","SAMICAS2",405,0)
 new fn set fn=$$getTemplate^%wf(form)
"RTN","SAMICAS2",406,0)
 do getThis^%wd(return,fn)
"RTN","SAMICAS2",407,0)
 ;
"RTN","SAMICAS2",408,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMICAS2",409,0)
 ;
"RTN","SAMICAS2",410,0)
 ;
"RTN","SAMICAS2",411,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",412,0)
 ;
"RTN","SAMICAS2",413,0)
 quit  ; end of ppi GETTMPL^SAMICASE
"RTN","SAMICAS2",414,0)
 ;
"RTN","SAMICAS2",415,0)
 ;
"RTN","SAMICAS2",416,0)
 ;
"RTN","SAMICAS2",417,0)
CNTITEMS(sid) ; extrinsic returns how many forms the patient has
"RTN","SAMICAS2",418,0)
 ; used before deleting a patient
"RTN","SAMICAS2",419,0)
 ;
"RTN","SAMICAS2",420,0)
 ;@called by : none
"RTN","SAMICAS2",421,0)
 ;@calls :
"RTN","SAMICAS2",422,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",423,0)
 ;@input ;
"RTN","SAMICAS2",424,0)
 ; sid = patient's study ID (e.g. "XXX00001")
"RTN","SAMICAS2",425,0)
 ;@output ;
"RTN","SAMICAS2",426,0)
 ;@tests :
"RTN","SAMICAS2",427,0)
 ; SAMIUTS2
"RTN","SAMICAS2",428,0)
 new groot set groot=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",429,0)
 quit:'$data(@groot@("graph",sid)) 0  ; nothing there
"RTN","SAMICAS2",430,0)
 new cnt,zi
"RTN","SAMICAS2",431,0)
 set zi=""
"RTN","SAMICAS2",432,0)
 set cnt=0
"RTN","SAMICAS2",433,0)
 for  set zi=$o(@groot@("graph",sid,zi)) quit:zi=""  do  ;
"RTN","SAMICAS2",434,0)
 . set cnt=cnt+1
"RTN","SAMICAS2",435,0)
 ;
"RTN","SAMICAS2",436,0)
 quit cnt  ; end of CNTITEMS
"RTN","SAMICAS2",437,0)
 ;
"RTN","SAMICAS2",438,0)
 ;
"RTN","SAMICAS2",439,0)
 ;
"RTN","SAMICAS2",440,0)
 ;@ppi-code GETITEMS^SAMICASE
"RTN","SAMICAS2",441,0)
GETITEMS ; get items available for studyid
"RTN","SAMICAS2",442,0)
 ;
"RTN","SAMICAS2",443,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",444,0)
 ;
"RTN","SAMICAS2",445,0)
 ;ven/gpl;ppi;procedure;clean;silent;sac;??% tests
"RTN","SAMICAS2",446,0)
 ;@signature
"RTN","SAMICAS2",447,0)
 ; do GETITEMS^SAMICASE(ary,sid)
"RTN","SAMICAS2",448,0)
 ;@branches-from
"RTN","SAMICAS2",449,0)
 ; GETITEMS^SAMICASE
"RTN","SAMICAS2",450,0)
 ;@ppi-called-by
"RTN","SAMICAS2",451,0)
 ; WSCASE^SAMICAS2
"RTN","SAMICAS2",452,0)
 ; $$BASELNDT^SAMICAS3
"RTN","SAMICAS2",453,0)
 ; MKCEFORM^SAMICAS3
"RTN","SAMICAS2",454,0)
 ; GETFILTR^SAMICTR0
"RTN","SAMICAS2",455,0)
 ; GETFILTR^SAMICTT0
"RTN","SAMICAS2",456,0)
 ; SELECT^SAMIUR
"RTN","SAMICAS2",457,0)
 ; SELECT^SAMIUR1
"RTN","SAMICAS2",458,0)
 ; CUMPY^SAMIUR2
"RTN","SAMICAS2",459,0)
 ;@called-by none
"RTN","SAMICAS2",460,0)
 ;@calls
"RTN","SAMICAS2",461,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",462,0)
 ;@input
"RTN","SAMICAS2",463,0)
 ; ary = name of return array
"RTN","SAMICAS2",464,0)
 ; sid = patient's study ID (e.g. "XXX00001")
"RTN","SAMICAS2",465,0)
 ;@output
"RTN","SAMICAS2",466,0)
 ; @ary = returned items available
"RTN","SAMICAS2",467,0)
 ;@examples [tbd]
"RTN","SAMICAS2",468,0)
 ;@tests
"RTN","SAMICAS2",469,0)
 ; UTCNTITM^SAMIUTS2
"RTN","SAMICAS2",470,0)
 ;
"RTN","SAMICAS2",471,0)
 ;
"RTN","SAMICAS2",472,0)
 ;@stanza 2 get items
"RTN","SAMICAS2",473,0)
 ;
"RTN","SAMICAS2",474,0)
 new groot set groot=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",475,0)
 quit:'$data(@groot@("graph",sid))  ; nothing there
"RTN","SAMICAS2",476,0)
 ;
"RTN","SAMICAS2",477,0)
 kill @ary
"RTN","SAMICAS2",478,0)
 new zi set zi=""
"RTN","SAMICAS2",479,0)
 for  set zi=$order(@groot@("graph",sid,zi)) quit:zi=""  do  ;
"RTN","SAMICAS2",480,0)
 . set @ary@(zi)=""
"RTN","SAMICAS2",481,0)
 . quit
"RTN","SAMICAS2",482,0)
 ;
"RTN","SAMICAS2",483,0)
 ;
"RTN","SAMICAS2",484,0)
 ;@stanza 3 get rest of forms (many-to-one, get dates)
"RTN","SAMICAS2",485,0)
 ;
"RTN","SAMICAS2",486,0)
 new tary
"RTN","SAMICAS2",487,0)
 for  set zi=$order(@ary@(zi)) quit:zi=""  do  ;
"RTN","SAMICAS2",488,0)
 . new zkey1,zform set zkey1=$piece(zi,"-",1)
"RTN","SAMICAS2",489,0)
 . ; if zkey1="sbform" quit  ;
"RTN","SAMICAS2",490,0)
 . if zkey1="siform" quit  ;
"RTN","SAMICAS2",491,0)
 . new fname
"RTN","SAMICAS2",492,0)
 . if zkey1="ceform" set fname="CT Evaluation"
"RTN","SAMICAS2",493,0)
 . set zform=zkey1
"RTN","SAMICAS2",494,0)
 . if zkey1="sbform" set zform="vapals:sbform"
"RTN","SAMICAS2",495,0)
 . if zkey1="sbform" set fname="Background"
"RTN","SAMICAS2",496,0)
 . if zkey1="ceform" set zform="vapals:ceform"
"RTN","SAMICAS2",497,0)
 . if zkey1="fuform" set zform="vapals:fuform"
"RTN","SAMICAS2",498,0)
 . if zkey1="fuform" set fname="Follow-up"
"RTN","SAMICAS2",499,0)
 . if zkey1="bxform" set fname="Biopsy"
"RTN","SAMICAS2",500,0)
 . if zkey1="bxform" set zform="vapals:bxform"
"RTN","SAMICAS2",501,0)
 . if zkey1="ptform" set zform="vapals:ptform"
"RTN","SAMICAS2",502,0)
 . if zkey1="ptform" set fname="PET Evaluation"
"RTN","SAMICAS2",503,0)
 . if zkey1="itform" set zform="vapals:itform"
"RTN","SAMICAS2",504,0)
 . if zkey1="itform" set fname="Intervention"
"RTN","SAMICAS2",505,0)
 . if $get(fname)="" set fname="unknown"
"RTN","SAMICAS2",506,0)
 . ;
"RTN","SAMICAS2",507,0)
 . new zdate set zdate=$extract(zi,$length(zkey1)+2,$length(zi))
"RTN","SAMICAS2",508,0)
 . quit:$get(zdate)=""
"RTN","SAMICAS2",509,0)
 . quit:$get(zform)=""
"RTN","SAMICAS2",510,0)
 . quit:$get(zi)=""
"RTN","SAMICAS2",511,0)
 . quit:$get(fname)=""
"RTN","SAMICAS2",512,0)
 . ;
"RTN","SAMICAS2",513,0)
 . set tary("sort",zdate,zform,zi,fname)=""
"RTN","SAMICAS2",514,0)
 . set tary("type",zform,zi,fname)=""
"RTN","SAMICAS2",515,0)
 . quit
"RTN","SAMICAS2",516,0)
 merge @ary=tary
"RTN","SAMICAS2",517,0)
 ;
"RTN","SAMICAS2",518,0)
 ;
"RTN","SAMICAS2",519,0)
 ;@stanza 4 termination
"RTN","SAMICAS2",520,0)
 ;
"RTN","SAMICAS2",521,0)
 quit  ; end of ppi GETITEMS^SAMICASE
"RTN","SAMICAS2",522,0)
 ;
"RTN","SAMICAS2",523,0)
 ;
"RTN","SAMICAS2",524,0)
 ;
"RTN","SAMICAS2",525,0)
GETDTKEY(formid) ; date portion of form key
"RTN","SAMICAS2",526,0)
 ;
"RTN","SAMICAS2",527,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",528,0)
 ;
"RTN","SAMICAS2",529,0)
 ;ven/gpl;private;function;
"RTN","SAMICAS2",530,0)
 ;@called by
"RTN","SAMICAS2",531,0)
 ;  WSCASE^SAMICAS2
"RTN","SAMICAS2",532,0)
 ;@calls :
"RTN","SAMICAS2",533,0)
 ;@input
"RTN","SAMICAS2",534,0)
 ; formid form key
"RTN","SAMICAS2",535,0)
 ;@output
"RTN","SAMICAS2",536,0)
 ; date from form key
"RTN","SAMICAS2",537,0)
 ;@examples
"RTN","SAMICAS2",538,0)
 ; $$GETDTKEY("sbform-2018-02-26") = "2018-02-26"
"RTN","SAMICAS2",539,0)
 ;@tests :
"RTN","SAMICAS2",540,0)
 ; SAMIUTS2
"RTN","SAMICAS2",541,0)
 ;
"RTN","SAMICAS2",542,0)
 ;@stanza 2 calculate date from key
"RTN","SAMICAS2",543,0)
 ;
"RTN","SAMICAS2",544,0)
 new frm set frm=$piece(formid,"-")
"RTN","SAMICAS2",545,0)
 new date set date=$piece(formid,frm_"-",2)
"RTN","SAMICAS2",546,0)
 ;
"RTN","SAMICAS2",547,0)
 ;@stanza 3 return & termination
"RTN","SAMICAS2",548,0)
 ;
"RTN","SAMICAS2",549,0)
 quit date ; return date; end of $$GETDTKEY
"RTN","SAMICAS2",550,0)
 ;
"RTN","SAMICAS2",551,0)
 ;
"RTN","SAMICAS2",552,0)
 ;
"RTN","SAMICAS2",553,0)
KEY2DSPD(zkey) ; date in elcap format from key date
"RTN","SAMICAS2",554,0)
 ;
"RTN","SAMICAS2",555,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",556,0)
 ;
"RTN","SAMICAS2",557,0)
 ;ven/gpl;private;function;
"RTN","SAMICAS2",558,0)
 ;@called by
"RTN","SAMICAS2",559,0)
 ;  WSCASE^SAMICAS2
"RTN","SAMICAS2",560,0)
 ;@calls
"RTN","SAMICAS2",561,0)
 ; ^%DT
"RTN","SAMICAS2",562,0)
 ; $$FMTE^XLFDT
"RTN","SAMICAS2",563,0)
 ; $$VAPALSDT^SAMICAS2
"RTN","SAMICAS2",564,0)
 ;@input
"RTN","SAMICAS2",565,0)
 ; zkey = date in any format %DT can process
"RTN","SAMICAS2",566,0)
 ;@output
"RTN","SAMICAS2",567,0)
 ; date in elcap format
"RTN","SAMICAS2",568,0)
 ;@examples
"RTN","SAMICAS2",569,0)
 ; date 2018-02-26 => 26/Feb/2018
"RTN","SAMICAS2",570,0)
 ;@tests
"RTN","SAMICAS2",571,0)
 ; SAMIUTS2
"RTN","SAMICAS2",572,0)
 ;
"RTN","SAMICAS2",573,0)
 ;@stanza 2 convert date to elcap display format
"RTN","SAMICAS2",574,0)
 ;
"RTN","SAMICAS2",575,0)
 new X set X=zkey
"RTN","SAMICAS2",576,0)
 new Y
"RTN","SAMICAS2",577,0)
 do ^%DT
"RTN","SAMICAS2",578,0)
 ;new Z set Z=$$FMTE^XLFDT(Y,"9D")
"RTN","SAMICAS2",579,0)
 ;set Z=$translate(Z," ","/")
"RTN","SAMICAS2",580,0)
 new zdate
"RTN","SAMICAS2",581,0)
 set zdate=$$VAPALSDT^SAMICASE(Y)
"RTN","SAMICAS2",582,0)
 ;
"RTN","SAMICAS2",583,0)
 ;@stanza 3 return & termination
"RTN","SAMICAS2",584,0)
 ;
"RTN","SAMICAS2",585,0)
 quit zdate  ; return date; end of $$KEY2DSPD
"RTN","SAMICAS2",586,0)
 ;
"RTN","SAMICAS2",587,0)
 ;
"RTN","SAMICAS2",588,0)
 ;
"RTN","SAMICAS2",589,0)
 ;@ppi-code $$VAPALSDT^SAMICASE
"RTN","SAMICAS2",590,0)
VAPALSDT ; vapals format for dates
"RTN","SAMICAS2",591,0)
 ;
"RTN","SAMICAS2",592,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",593,0)
 ;
"RTN","SAMICAS2",594,0)
 ;ven/gpl;ppi;function;clean;silent;sac;100% tests
"RTN","SAMICAS2",595,0)
 ;@signature
"RTN","SAMICAS2",596,0)
 ; $$VAPALSDT^SAMICASE(fmdate)
"RTN","SAMICAS2",597,0)
 ;@branches-from
"RTN","SAMICAS2",598,0)
 ; VAPALSDT^SAMICASE
"RTN","SAMICAS2",599,0)
 ;@ppi-called-by
"RTN","SAMICAS2",600,0)
 ; KEY2DSPD^SAMICAS2
"RTN","SAMICAS2",601,0)
 ; LASTCMP^SAMICAS3
"RTN","SAMICAS2",602,0)
 ; KEY2DT^SAMICAS3
"RTN","SAMICAS2",603,0)
 ; MKCEFORM^SAMICAS3
"RTN","SAMICAS2",604,0)
 ; MKFUFORM^SAMICAS3
"RTN","SAMICAS2",605,0)
 ; MKITFORM^SAMICAS3
"RTN","SAMICAS2",606,0)
 ; MKPTFORM^SAMICAS3
"RTN","SAMICAS2",607,0)
 ; LOGIT^SAMICLOG
"RTN","SAMICAS2",608,0)
 ; MKSIFORM^SAMIHOM3
"RTN","SAMICAS2",609,0)
 ; PREFILL^SAMIHOM3
"RTN","SAMICAS2",610,0)
 ; SELECT^SAMIUR
"RTN","SAMICAS2",611,0)
 ; SELECT^SAMIUR1
"RTN","SAMICAS2",612,0)
 ; IFORM^SAMIUR2
"RTN","SAMICAS2",613,0)
 ;@called-by none
"RTN","SAMICAS2",614,0)
 ;@calls
"RTN","SAMICAS2",615,0)
 ; $$FMTE^XLFDT
"RTN","SAMICAS2",616,0)
 ;@input
"RTN","SAMICAS2",617,0)
 ; fmdate = date in fileman format
"RTN","SAMICAS2",618,0)
 ;@output = vapals date format
"RTN","SAMICAS2",619,0)
 ;@tests
"RTN","SAMICAS2",620,0)
 ; UTVPLSD^SAMIUTS2
"RTN","SAMICAS2",621,0)
 ;
"RTN","SAMICAS2",622,0)
 ;
"RTN","SAMICAS2",623,0)
 ;@stanza 2 convert date
"RTN","SAMICAS2",624,0)
 ;
"RTN","SAMICAS2",625,0)
 ; new vdate set vdate=$$FMTE^XLFDT(fmdate,"9D")
"RTN","SAMICAS2",626,0)
 ; set vdate=$translate(vdate," ","/")
"RTN","SAMICAS2",627,0)
 ;
"RTN","SAMICAS2",628,0)
 new vdate set vdate=$$FMTE^XLFDT(fmdate,"5D")
"RTN","SAMICAS2",629,0)
 ;
"RTN","SAMICAS2",630,0)
 ;
"RTN","SAMICAS2",631,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",632,0)
 ;
"RTN","SAMICAS2",633,0)
 quit vdate ; end of ppi $$VAPALSDT^SAMICASE
"RTN","SAMICAS2",634,0)
 ;
"RTN","SAMICAS2",635,0)
 ;
"RTN","SAMICAS2",636,0)
 ;
"RTN","SAMICAS2",637,0)
 ;@section 2 WSNUFORM & related ppis
"RTN","SAMICAS2",638,0)
 ;
"RTN","SAMICAS2",639,0)
 ;
"RTN","SAMICAS2",640,0)
 ;
"RTN","SAMICAS2",641,0)
 ;@wri-code WSNUFORM^SAMICASE
"RTN","SAMICAS2",642,0)
WSNUFORM ; post vapals nuform: new form for patient
"RTN","SAMICAS2",643,0)
 ;
"RTN","SAMICAS2",644,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",645,0)
 ;
"RTN","SAMICAS2",646,0)
 ;ven/gpl;wri;procedure;clean;silent;sac;?? tests
"RTN","SAMICAS2",647,0)
 ;@signature
"RTN","SAMICAS2",648,0)
 ; do WSNUFORM^SAMICASE(rtn,filter)
"RTN","SAMICAS2",649,0)
 ;@branches-from
"RTN","SAMICAS2",650,0)
 ; WSNUFORM^SAMICASE
"RTN","SAMICAS2",651,0)
 ;@wri-called-by
"RTN","SAMICAS2",652,0)
 ; WSVAPALS^SAMIHOM3 [wr nuform of ws post vapals]
"RTN","SAMICAS2",653,0)
 ;@called-by none
"RTN","SAMICAS2",654,0)
 ;@calls
"RTN","SAMICAS2",655,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS2",656,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",657,0)
 ; GETTMPL^SAMICAS2
"RTN","SAMICAS2",658,0)
 ; findReplace^%ts
"RTN","SAMICAS2",659,0)
 ; FIXHREF^SAMIFORM
"RTN","SAMICAS2",660,0)
 ; FIXSRC^SAMIFORM
"RTN","SAMICAS2",661,0)
 ; findReplace^%ts
"RTN","SAMICAS2",662,0)
 ;@input
"RTN","SAMICAS2",663,0)
 ; .filter =
"RTN","SAMICAS2",664,0)
 ; .filter("studyid")=studyid of the patient
"RTN","SAMICAS2",665,0)
 ;@output
"RTN","SAMICAS2",666,0)
 ; @rtn
"RTN","SAMICAS2",667,0)
 ;@tests
"RTN","SAMICAS2",668,0)
 ; UTWSNF^SAMIUTS2
"RTN","SAMICAS2",669,0)
 ;
"RTN","SAMICAS2",670,0)
 ;
"RTN","SAMICAS2",671,0)
 ;@stanza 2 get select-new-form form
"RTN","SAMICAS2",672,0)
 ;
"RTN","SAMICAS2",673,0)
 new sid set sid=$get(filter("studyid"))
"RTN","SAMICAS2",674,0)
 quit:sid=""
"RTN","SAMICAS2",675,0)
 new sien set sien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICAS2",676,0)
 quit:+sien=0
"RTN","SAMICAS2",677,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",678,0)
 new groot set groot=$name(@root@(sien))
"RTN","SAMICAS2",679,0)
 ;
"RTN","SAMICAS2",680,0)
 new saminame set saminame=$get(@groot@("saminame"))
"RTN","SAMICAS2",681,0)
 quit:saminame=""
"RTN","SAMICAS2",682,0)
 ;
"RTN","SAMICAS2",683,0)
 new temp,tout,form
"RTN","SAMICAS2",684,0)
 set return="temp",form="vapals:nuform"
"RTN","SAMICAS2",685,0)
 do GETTMPL
"RTN","SAMICAS2",686,0)
 quit:'$data(temp)
"RTN","SAMICAS2",687,0)
 ;
"RTN","SAMICAS2",688,0)
 new cnt set cnt=0
"RTN","SAMICAS2",689,0)
 new zi set zi=0
"RTN","SAMICAS2",690,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMICAS2",691,0)
 . new ln set ln=temp(zi)
"RTN","SAMICAS2",692,0)
 . new touched set touched=0
"RTN","SAMICAS2",693,0)
 . ;
"RTN","SAMICAS2",694,0)
 . if ln["href" if 'touched do  ;
"RTN","SAMICAS2",695,0)
 . . do FIXHREF^SAMIFORM(.ln)
"RTN","SAMICAS2",696,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",697,0)
 . ;
"RTN","SAMICAS2",698,0)
 . if ln["src" d  ;
"RTN","SAMICAS2",699,0)
 . . do FIXSRC^SAMIFORM(.ln)
"RTN","SAMICAS2",700,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",701,0)
 . ;
"RTN","SAMICAS2",702,0)
 . if ln["@@SID@@" do  ;
"RTN","SAMICAS2",703,0)
 . . do findReplace^%ts(.ln,"@@SID@@",sid)
"RTN","SAMICAS2",704,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",705,0)
 . . quit
"RTN","SAMICAS2",706,0)
 . ;
"RTN","SAMICAS2",707,0)
 . if ln["@@SITE@@" do  ; insert site id
"RTN","SAMICAS2",708,0)
 . . n siteid s siteid=$g(filter("siteid"))
"RTN","SAMICAS2",709,0)
 . . i siteid="" s siteid=$g(filter("site"))
"RTN","SAMICAS2",710,0)
 . . q:siteid=""
"RTN","SAMICAS2",711,0)
 . . do findReplace^%ts(.ln,"@@SITE@@",siteid)
"RTN","SAMICAS2",712,0)
 . . s temp(zi)=ln
"RTN","SAMICAS2",713,0)
 . ;
"RTN","SAMICAS2",714,0)
 . if ln["@@SITETITLE@@" do  ; insert site title
"RTN","SAMICAS2",715,0)
 . . n sitetit s sitetit=$g(filter("sitetitle"))
"RTN","SAMICAS2",716,0)
 . . if sitetit="" d  ;
"RTN","SAMICAS2",717,0)
 . . . n tsite s tsite=$g(filter("site"))
"RTN","SAMICAS2",718,0)
 . . . q:tsite=""
"RTN","SAMICAS2",719,0)
 . . . s sitetit=$$SITENM2^SAMISITE(tsite)_" - "_tsite
"RTN","SAMICAS2",720,0)
 . . q:sitetit=""
"RTN","SAMICAS2",721,0)
 . . do findReplace^%ts(.ln,"@@SITETITLE@@",sitetit)
"RTN","SAMICAS2",722,0)
 . . s temp(zi)=ln
"RTN","SAMICAS2",723,0)
 . ;
"RTN","SAMICAS2",724,0)
 . set cnt=cnt+1
"RTN","SAMICAS2",725,0)
 . set rtn(cnt)=temp(zi)
"RTN","SAMICAS2",726,0)
 ;
"RTN","SAMICAS2",727,0)
 ;
"RTN","SAMICAS2",728,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",729,0)
 ;
"RTN","SAMICAS2",730,0)
 quit  ; end of wri WSNUFORM^SAMICASE
"RTN","SAMICAS2",731,0)
 ;
"RTN","SAMICAS2",732,0)
 ;
"RTN","SAMICAS2",733,0)
 ;
"RTN","SAMICAS2",734,0)
 ;@ppi-code $$KEY2FM^SAMICASE
"RTN","SAMICAS2",735,0)
KEY2FM ; convert key to fileman date
"RTN","SAMICAS2",736,0)
 ;
"RTN","SAMICAS2",737,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",738,0)
 ;
"RTN","SAMICAS2",739,0)
 ;ven/gpl;wri;procedure;silent;clean;sac;??% tests
"RTN","SAMICAS2",740,0)
 ;@signature
"RTN","SAMICAS2",741,0)
 ; $$KEY2FM^SAMICASE(key)
"RTN","SAMICAS2",742,0)
 ;@branches-from
"RTN","SAMICAS2",743,0)
 ; KEY2FM^SAMICASE
"RTN","SAMICAS2",744,0)
 ;@ppi-called-by
"RTN","SAMICAS2",745,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICAS2",746,0)
 ; $$LASTCMP^SAMICAS3
"RTN","SAMICAS2",747,0)
 ; $$KEY2DT^SAMICAS3
"RTN","SAMICAS2",748,0)
 ; SAVFILTR^SAMISAV
"RTN","SAMICAS2",749,0)
 ; SELECT^SAMIUR
"RTN","SAMICAS2",750,0)
 ; SELECT^SAMIUR1
"RTN","SAMICAS2",751,0)
 ; IFORM^SAMIUM2
"RTN","SAMICAS2",752,0)
 ;@called-by none
"RTN","SAMICAS2",753,0)
 ;@calls
"RTN","SAMICAS2",754,0)
 ; ^%DT
"RTN","SAMICAS2",755,0)
 ;@input
"RTN","SAMICAS2",756,0)
 ; key = vapals key (e.g.
"RTN","SAMICAS2",757,0)
 ;@output
"RTN","SAMICAS2",758,0)
 ;@examples
"RTN","SAMICAS2",759,0)
 ;  $$KEY2FM("sbform-2018-02-26") = 3180226
"RTN","SAMICAS2",760,0)
 ;@tests
"RTN","SAMICAS2",761,0)
 ; UTK2FM^SAMIUTS2
"RTN","SAMICAS2",762,0)
 ;
"RTN","SAMICAS2",763,0)
 ;
"RTN","SAMICAS2",764,0)
 ;@stanza 2 convert key to fm date
"RTN","SAMICAS2",765,0)
 ;
"RTN","SAMICAS2",766,0)
 new datepart set datepart=key
"RTN","SAMICAS2",767,0)
 ; allow key to be the whole key ie ceform-2018-10-3
"RTN","SAMICAS2",768,0)
 if $length(key,"-")=4 do
"RTN","SAMICAS2",769,0)
 . new frm set frm=$piece(key,"-")
"RTN","SAMICAS2",770,0)
 . set datepart=$piece(key,frm_"-",2)
"RTN","SAMICAS2",771,0)
 . quit
"RTN","SAMICAS2",772,0)
 new X set X=datepart
"RTN","SAMICAS2",773,0)
 new Y
"RTN","SAMICAS2",774,0)
 do ^%DT ; call fileman to convert date
"RTN","SAMICAS2",775,0)
 ;
"RTN","SAMICAS2",776,0)
 ;
"RTN","SAMICAS2",777,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",778,0)
 ;
"RTN","SAMICAS2",779,0)
 quit Y ; end of ppi $$KEY2FM^SAMICASE
"RTN","SAMICAS2",780,0)
 ;
"RTN","SAMICAS2",781,0)
 ;
"RTN","SAMICAS2",782,0)
 ;
"RTN","SAMICAS2",783,0)
 ;@section 3 casetbl
"RTN","SAMICAS2",784,0)
 ;
"RTN","SAMICAS2",785,0)
 ;
"RTN","SAMICAS2",786,0)
 ;
"RTN","SAMICAS2",787,0)
 ;@ppi $$GSAMISTA^SAMICAS2 = value of 'samistatus' from form
"RTN","SAMICAS2",788,0)
GSAMISTA(sid,form) ; extrinsic returns value of 'samistatus' from form
"RTN","SAMICAS2",789,0)
 ;
"RTN","SAMICAS2",790,0)
 ;@called by
"RTN","SAMICAS2",791,0)
 ; WSCASE^SAMICAS2
"RTN","SAMICAS2",792,0)
 ;@calls
"RTN","SAMICAS2",793,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",794,0)
 ;@input
"RTN","SAMICAS2",795,0)
 ; sid  = patient's studyid
"RTN","SAMICAS2",796,0)
 ; form = specific study form (e.g. "sbform-2018-02-26")
"RTN","SAMICAS2",797,0)
 ;@output
"RTN","SAMICAS2",798,0)
 ; status of the form
"RTN","SAMICAS2",799,0)
 ;@tests
"RTN","SAMICAS2",800,0)
 ; SAMIUTS2
"RTN","SAMICAS2",801,0)
 ;
"RTN","SAMICAS2",802,0)
 new stat,root,useform
"RTN","SAMICAS2",803,0)
 set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",804,0)
 set useform=form
"RTN","SAMICAS2",805,0)
 if form["vapals:" set useform=$p(form,"vapals:",2)
"RTN","SAMICAS2",806,0)
 set stat=$get(@root@("graph",sid,useform,"samistatus"))
"RTN","SAMICAS2",807,0)
 ;
"RTN","SAMICAS2",808,0)
 quit stat ; end of ppi $$GSAMISTA^SAMICAS2
"RTN","SAMICAS2",809,0)
 ;
"RTN","SAMICAS2",810,0)
 ;
"RTN","SAMICAS2",811,0)
 ;
"RTN","SAMICAS2",812,0)
 ;@ppi-code SSAMISTA^SAMICASE
"RTN","SAMICAS2",813,0)
SSAMISTA ; set samistatus to val in form
"RTN","SAMICAS2",814,0)
 ;
"RTN","SAMICAS2",815,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",816,0)
 ;
"RTN","SAMICAS2",817,0)
 ;ven/gpl;ppi;procedure;silent;clean;sac;??% tests
"RTN","SAMICAS2",818,0)
 ;@signature
"RTN","SAMICAS2",819,0)
 ; do SSAMISTA^SAMICASE(sid,form,val)
"RTN","SAMICAS2",820,0)
 ;@branches-from
"RTN","SAMICAS2",821,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS2",822,0)
 ;@ppi-called-by
"RTN","SAMICAS2",823,0)
 ; INITSTAT^SAMICAS2
"RTN","SAMICAS2",824,0)
 ; MKSBFORM^SAMICAS3
"RTN","SAMICAS2",825,0)
 ; MKCEFORM^SAMICAS3
"RTN","SAMICAS2",826,0)
 ; MKFUFORM^SAMICAS3
"RTN","SAMICAS2",827,0)
 ; MKPTFORM^SAMICAS3
"RTN","SAMICAS2",828,0)
 ; MKITFORM^SAMICAS3
"RTN","SAMICAS2",829,0)
 ; MKBXFORM^SAMICAS3
"RTN","SAMICAS2",830,0)
 ; MKSBFORM^SAMIHOM3
"RTN","SAMICAS2",831,0)
 ; MKSIFORM^SAMIHOM3
"RTN","SAMICAS2",832,0)
 ;@called-by none
"RTN","SAMICAS2",833,0)
 ;@calls
"RTN","SAMICAS2",834,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",835,0)
 ;@input
"RTN","SAMICAS2",836,0)
 ; sid   = patient's studyid
"RTN","SAMICAS2",837,0)
 ; form  = specific study form (e.g. "sbform-2018-02-26")
"RTN","SAMICAS2",838,0)
 ; value = status (complete, incomplete)
"RTN","SAMICAS2",839,0)
 ;@output
"RTN","SAMICAS2",840,0)
 ; sets 'samistatus' to val in form
"RTN","SAMICAS2",841,0)
 ;@examples [tbd]
"RTN","SAMICAS2",842,0)
 ;@tests
"RTN","SAMICAS2",843,0)
 ; UTSSAMIS^SAMIUTS2
"RTN","SAMICAS2",844,0)
 ;
"RTN","SAMICAS2",845,0)
 ;
"RTN","SAMICAS2",846,0)
 ;@stanza 2 set status
"RTN","SAMICAS2",847,0)
 ;
"RTN","SAMICAS2",848,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",849,0)
 new useform set useform=form
"RTN","SAMICAS2",850,0)
 if form["vapals:" set useform=$piece(form,"vapals:",2)
"RTN","SAMICAS2",851,0)
 if '$data(@root@("graph",sid,useform)) quit  ; no form
"RTN","SAMICAS2",852,0)
 set @root@("graph",sid,useform,"samistatus")=val
"RTN","SAMICAS2",853,0)
 ;
"RTN","SAMICAS2",854,0)
 ;
"RTN","SAMICAS2",855,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",856,0)
 ;
"RTN","SAMICAS2",857,0)
 quit  ; end of ppi SSAMISTA^SAMICASE
"RTN","SAMICAS2",858,0)
 ;
"RTN","SAMICAS2",859,0)
 ;
"RTN","SAMICAS2",860,0)
 ;
"RTN","SAMICAS2",861,0)
 ;@wri-code DELFORM^SAMICASE
"RTN","SAMICAS2",862,0)
DELFORM ; post vapals deleteform: delete incomplete form
"RTN","SAMICAS2",863,0)
 ;
"RTN","SAMICAS2",864,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",865,0)
 ;
"RTN","SAMICAS2",866,0)
 ;ven/gpl;wri;procedure;silent;clean;sac;??% tests
"RTN","SAMICAS2",867,0)
 ;@signature
"RTN","SAMICAS2",868,0)
 ; do DELFORM^SAMICASE(RESULT,ARGS)
"RTN","SAMICAS2",869,0)
 ;@branches-from
"RTN","SAMICAS2",870,0)
 ; DELFORM^SAMICASE
"RTN","SAMICAS2",871,0)
 ;@wri-called-by
"RTN","SAMICAS2",872,0)
 ; WSVAPALS^SAMIHOM3 [wr deleteform of ws post vapals]
"RTN","SAMICAS2",873,0)
 ;@called-by none
"RTN","SAMICAS2",874,0)
 ;@calls
"RTN","SAMICAS2",875,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",876,0)
 ; $$GSAMISTA
"RTN","SAMICAS2",877,0)
 ; WSCASE^SAMICASE
"RTN","SAMICAS2",878,0)
 ;@input
"RTN","SAMICAS2",879,0)
 ; .ARGS=
"RTN","SAMICAS2",880,0)
 ; .ARGS("studyid")
"RTN","SAMICAS2",881,0)
 ; .ARGS("form")
"RTN","SAMICAS2",882,0)
 ;@output
"RTN","SAMICAS2",883,0)
 ; @RESULT
"RTN","SAMICAS2",884,0)
 ;@tests
"RTN","SAMICAS2",885,0)
 ; UTDELFM^SAMIUTS2
"RTN","SAMICAS2",886,0)
 ;
"RTN","SAMICAS2",887,0)
 ; will not delete intake or background form
"RTN","SAMICAS2",888,0)
 ;
"RTN","SAMICAS2",889,0)
 ;
"RTN","SAMICAS2",890,0)
 ;@stanza 2 delete form
"RTN","SAMICAS2",891,0)
 ;
"RTN","SAMICAS2",892,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",893,0)
 new sid set sid=$get(ARGS("studyid"))
"RTN","SAMICAS2",894,0)
 quit:sid=""
"RTN","SAMICAS2",895,0)
 ;
"RTN","SAMICAS2",896,0)
 new form set form=$get(ARGS("form"))
"RTN","SAMICAS2",897,0)
 quit:form=""
"RTN","SAMICAS2",898,0)
 ;
"RTN","SAMICAS2",899,0)
 quit:form["siform"
"RTN","SAMICAS2",900,0)
 ;
"RTN","SAMICAS2",901,0)
 ; quit:'$data(@root@("graph",sid,form))  ; form does not exist
"RTN","SAMICAS2",902,0)
 if $$GSAMISTA(sid,form)="incomplete" do
"RTN","SAMICAS2",903,0)
 . kill @root@("graph",sid,form)
"RTN","SAMICAS2",904,0)
 . quit
"RTN","SAMICAS2",905,0)
 ;
"RTN","SAMICAS2",906,0)
 kill ARGS("samiroute")
"RTN","SAMICAS2",907,0)
 do WSCASE^SAMICASE(.RESULT,.ARGS) ; post vapals casereview:
"RTN","SAMICAS2",908,0)
 ; generate case review page
"RTN","SAMICAS2",909,0)
 ;
"RTN","SAMICAS2",910,0)
 ;
"RTN","SAMICAS2",911,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",912,0)
 ;
"RTN","SAMICAS2",913,0)
 quit  ; end of wri DELFORM^SAMICASE
"RTN","SAMICAS2",914,0)
 ;
"RTN","SAMICAS2",915,0)
 ;
"RTN","SAMICAS2",916,0)
 ;
"RTN","SAMICAS2",917,0)
INITSTAT ; set all forms to 'incomplete'
"RTN","SAMICAS2",918,0)
 ;
"RTN","SAMICAS2",919,0)
 ;@called by : none
"RTN","SAMICAS2",920,0)
 ;@calls
"RTN","SAMICAS2",921,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS2",922,0)
 ;@input : none
"RTN","SAMICAS2",923,0)
 ;@output
"RTN","SAMICAS2",924,0)
 ; set all forms to 'incomplete'
"RTN","SAMICAS2",925,0)
 ;@tests
"RTN","SAMICAS2",926,0)
 ;
"RTN","SAMICAS2",927,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",928,0)
 new zi,zj set (zi,zj)=""
"RTN","SAMICAS2",929,0)
 for  set zi=$order(@root@("graph",zi)) quit:zi=""  do  ;
"RTN","SAMICAS2",930,0)
 . for  set zj=$order(@root@("graph",zi,zj)) quit:zj=""  do  ;
"RTN","SAMICAS2",931,0)
 . . if zj["siform" do SSAMISTA^SAMICASE(zi,zj,"complete") quit  ;
"RTN","SAMICAS2",932,0)
 . . do SSAMISTA^SAMICASE(zi,zj,"incomplete")
"RTN","SAMICAS2",933,0)
 ;
"RTN","SAMICAS2",934,0)
 quit  ; end of INITSTAT
"RTN","SAMICAS2",935,0)
 ;
"RTN","SAMICAS2",936,0)
 ;
"RTN","SAMICAS2",937,0)
 ;
"RTN","SAMICAS2",938,0)
EOR ; end of routine SAMICAS2
"RTN","SAMICAS3")
0^2^B495988167
"RTN","SAMICAS3",1,0)
SAMICAS3 ;ven/gpl - case review cont ;2021-07-01t15:42z
"RTN","SAMICAS3",2,0)
 ;;18.0;SAMI;**3,9,11,12**;2020-01;Build 6
"RTN","SAMICAS3",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMICAS3",4,0)
 ;
"RTN","SAMICAS3",5,0)
 ; SAMICAS3 contains ppis and other subroutines to support processing
"RTN","SAMICAS3",6,0)
 ; of the VAPALS-IELCAP case review page.
"RTN","SAMICAS3",7,0)
 ;
"RTN","SAMICAS3",8,0)
 quit  ; no entry from top
"RTN","SAMICAS3",9,0)
 ;
"RTN","SAMICAS3",10,0)
 ;
"RTN","SAMICAS3",11,0)
 ;
"RTN","SAMICAS3",12,0)
 ;@section 0 primary development: see routine %wful
"RTN","SAMICAS3",13,0)
 ;
"RTN","SAMICAS3",14,0)
 ;
"RTN","SAMICAS3",15,0)
 ;
"RTN","SAMICAS3",16,0)
 ;@license see routine SAMIUL
"RTN","SAMICAS3",17,0)
 ;@documentation see SAMICUL
"RTN","SAMICAS3",18,0)
 ;@contents
"RTN","SAMICAS3",19,0)
 ; WSNFPOST wri-code WSNFPOST^SAMICAS3, post vapals addform: new form
"RTN","SAMICAS3",20,0)
 ; MKSBFORM create background form
"RTN","SAMICAS3",21,0)
 ;
"RTN","SAMICAS3",22,0)
 ; $$PREVNOD key of latest form including nodule grid
"RTN","SAMICAS3",23,0)
 ; $$LASTCMP date & key of last comparison scan
"RTN","SAMICAS3",24,0)
 ; $$PRIORCMP dates of all scans before last comparison scan
"RTN","SAMICAS3",25,0)
 ; $$KEY2DT date to put in prior scans field
"RTN","SAMICAS3",26,0)
 ; SORTFRMS sorts all forms for patient sid by date
"RTN","SAMICAS3",27,0)
 ;
"RTN","SAMICAS3",28,0)
 ; MKCEFORM create ct evaluation form
"RTN","SAMICAS3",29,0)
 ; MKFUFORM create follow-up form
"RTN","SAMICAS3",30,0)
 ; $$BASELNDT last previous baseline ct date
"RTN","SAMICAS3",31,0)
 ; MKPTFORM create pet evaluation form
"RTN","SAMICAS3",32,0)
 ; MKITFORM create intervention form
"RTN","SAMICAS3",33,0)
 ; MKBXFORM create biopsy form
"RTN","SAMICAS3",34,0)
 ; CASETBL generates case review table
"RTN","SAMICAS3",35,0)
 ;
"RTN","SAMICAS3",36,0)
 ;
"RTN","SAMICAS3",37,0)
 ;
"RTN","SAMICAS3",38,0)
 ;@section 1 WSNFPOST & related subroutines
"RTN","SAMICAS3",39,0)
 ;
"RTN","SAMICAS3",40,0)
 ;
"RTN","SAMICAS3",41,0)
 ;
"RTN","SAMICAS3",42,0)
 ;@wri-code WSNFPOST^SAMICAS3
"RTN","SAMICAS3",43,0)
WSNFPOST ; post vapals addform: new form
"RTN","SAMICAS3",44,0)
 ;
"RTN","SAMICAS3",45,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",46,0)
 ;
"RTN","SAMICAS3",47,0)
 ;ven/gpl;wri;procedure;clean;silent;sac;??% tests
"RTN","SAMICAS3",48,0)
 ;@signature
"RTN","SAMICAS3",49,0)
 ; do WSNFPOST^SAMICASE(ARGS,BODY,RESULT)
"RTN","SAMICAS3",50,0)
 ;@branches-from
"RTN","SAMICAS3",51,0)
 ; WSNFPOST^SAMICASE
"RTN","SAMICAS3",52,0)
 ;@ppi-called-by
"RTN","SAMICAS3",53,0)
 ; WSVAPALS^SAMIHOME [wr addform of ws post vapals]
"RTN","SAMICAS3",54,0)
 ;@called-by none
"RTN","SAMICAS3",55,0)
 ;@calls
"RTN","SAMICAS3",56,0)
 ; parseBody^%wf
"RTN","SAMICAS3",57,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMICAS3",58,0)
 ; $$KEYDATE^SAMIHOM3
"RTN","SAMICAS3",59,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",60,0)
 ; $$KEY2FM^SAMICAS2
"RTN","SAMICAS3",61,0)
 ; $$FMADD^XLFDT
"RTN","SAMICAS3",62,0)
 ; WSCASE^SAMICASE
"RTN","SAMICAS3",63,0)
 ; MKSBFORM^SAMICAS3
"RTN","SAMICAS3",64,0)
 ; MKCEFORM^SAMICAS3
"RTN","SAMICAS3",65,0)
 ; MKFUFORM^SAMICAS3
"RTN","SAMICAS3",66,0)
 ; MKBXFORM^SAMICAS3
"RTN","SAMICAS3",67,0)
 ; MKPTFORM^SAMICAS3
"RTN","SAMICAS3",68,0)
 ; MKITFORM^SAMICAS3
"RTN","SAMICAS3",69,0)
 ; wsGetForm^%wf
"RTN","SAMICAS3",70,0)
 ;@input
"RTN","SAMICAS3",71,0)
 ; .ARGS
"RTN","SAMICAS3",72,0)
 ; .ARGS("form")
"RTN","SAMICAS3",73,0)
 ; .ARGS("studyid")
"RTN","SAMICAS3",74,0)
 ; .ARGS("sid")
"RTN","SAMICAS3",75,0)
 ; .BODY
"RTN","SAMICAS3",76,0)
 ; .BODY(1) (e.g. "samiroute=casereview&dfn="_dfn_"&studyid="_studyid)
"RTN","SAMICAS3",77,0)
 ;@output
"RTN","SAMICAS3",78,0)
 ; @RESULT
"RTN","SAMICAS3",79,0)
 ;@tests
"RTN","SAMICAS3",80,0)
 ; UTNFPST^SAMIUTS2
"RTN","SAMICAS3",81,0)
 ;
"RTN","SAMICAS3",82,0)
 ;
"RTN","SAMICAS3",83,0)
 ;@stanza 2 get new form
"RTN","SAMICAS3",84,0)
 ;
"RTN","SAMICAS3",85,0)
 new vars,bdy
"RTN","SAMICAS3",86,0)
 set bdy=$get(BODY(1))
"RTN","SAMICAS3",87,0)
 do parseBody^%wf("vars",.bdy)
"RTN","SAMICAS3",88,0)
 merge vars=ARGS
"RTN","SAMICAS3",89,0)
 merge ^SAMIUL("nuform","vars")=vars
"RTN","SAMICAS3",90,0)
 ;
"RTN","SAMICAS3",91,0)
 new sid set sid=$get(vars("studyid"))
"RTN","SAMICAS3",92,0)
 if sid="" set sid=$get(ARGS("sid"))
"RTN","SAMICAS3",93,0)
 if sid="" do  quit  ;
"RTN","SAMICAS3",94,0)
 . do GETHOME^SAMIHOM3(.RESULT,.ARGS) ; on error return to home page
"RTN","SAMICAS3",95,0)
 . quit
"RTN","SAMICAS3",96,0)
 ;
"RTN","SAMICAS3",97,0)
 set nuform=$get(vars("form"))
"RTN","SAMICAS3",98,0)
 if nuform="" set nuform="ceform"
"RTN","SAMICAS3",99,0)
 ;
"RTN","SAMICAS3",100,0)
 new datekey set datekey=$$KEYDATE^SAMIHOM3($$NOW^XLFDT)
"RTN","SAMICAS3",101,0)
 ;
"RTN","SAMICAS3",102,0)
 ; check to see if form already exists
"RTN","SAMICAS3",103,0)
 ;
"RTN","SAMICAS3",104,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",105,0)
 new collide set collide=0 ; duplicate form for today - backdate forms scenario
"RTN","SAMICAS3",106,0)
 if $data(@root@("graph",sid,nuform_"-"_datekey)) do  ; already exists
"RTN","SAMICAS3",107,0)
 . set collide=1
"RTN","SAMICAS3",108,0)
 . if nuform="siform" quit
"RTN","SAMICAS3",109,0)
 . if nuform="sbform" quit  ; do not create multiple background forms
"RTN","SAMICAS3",110,0)
 . new lastone
"RTN","SAMICAS3",111,0)
 . set lastone=$order(@root@("graph",sid,nuform_"-a  "),-1)
"RTN","SAMICAS3",112,0)
 . quit:lastone=""
"RTN","SAMICAS3",113,0)
 . set newfm=$$KEY2FM^SAMICASE(lastone)
"RTN","SAMICAS3",114,0)
 . set datekey=$$KEYDATE^SAMIHOM3($$FMADD^XLFDT(newfm,1)) ; add one day to the last form
"RTN","SAMICAS3",115,0)
 . quit
"RTN","SAMICAS3",116,0)
 ;
"RTN","SAMICAS3",117,0)
 ; code to not allow two same forms for a patient a day
"RTN","SAMICAS3",118,0)
 ;
"RTN","SAMICAS3",119,0)
 if collide=1 do  quit  ;
"RTN","SAMICAS3",120,0)
 . set ARGS("errorMessage")="Form already exists for today"
"RTN","SAMICAS3",121,0)
 . set ARGS("studyid")=sid
"RTN","SAMICAS3",122,0)
 . do WSCASE^SAMICASE(.RESULT,.ARGS)
"RTN","SAMICAS3",123,0)
 . quit
"RTN","SAMICAS3",124,0)
 ;
"RTN","SAMICAS3",125,0)
 if nuform="sbform" do  ;
"RTN","SAMICAS3",126,0)
 . new oldkey set oldkey=$order(@root@("graph",sid,"sbform"))
"RTN","SAMICAS3",127,0)
 . if $extract(oldkey,1,6)="sbform" do  quit  ;
"RTN","SAMICAS3",128,0)
 . . set ARGS("key")=oldkey
"RTN","SAMICAS3",129,0)
 . . set ARGS("studyid")=sid
"RTN","SAMICAS3",130,0)
 . . set ARGS("form")="vapals:sbform"
"RTN","SAMICAS3",131,0)
 . . quit
"RTN","SAMICAS3",132,0)
 . new key set key="sbform-"_datekey
"RTN","SAMICAS3",133,0)
 . set ARGS("key")=key
"RTN","SAMICAS3",134,0)
 . set ARGS("studyid")=sid
"RTN","SAMICAS3",135,0)
 . set ARGS("form")="vapals:sbform"
"RTN","SAMICAS3",136,0)
 . do MKSBFORM(sid,key)
"RTN","SAMICAS3",137,0)
 . quit
"RTN","SAMICAS3",138,0)
 ;
"RTN","SAMICAS3",139,0)
 if nuform="ceform" do  ;
"RTN","SAMICAS3",140,0)
 . new key set key="ceform-"_datekey
"RTN","SAMICAS3",141,0)
 . set ARGS("key")=key
"RTN","SAMICAS3",142,0)
 . set ARGS("studyid")=sid
"RTN","SAMICAS3",143,0)
 . set ARGS("form")="vapals:ceform"
"RTN","SAMICAS3",144,0)
 . do MKCEFORM(sid,key)
"RTN","SAMICAS3",145,0)
 . quit
"RTN","SAMICAS3",146,0)
 ;
"RTN","SAMICAS3",147,0)
 if nuform="fuform" do  ;
"RTN","SAMICAS3",148,0)
 . new key set key="fuform-"_datekey
"RTN","SAMICAS3",149,0)
 . set ARGS("key")=key
"RTN","SAMICAS3",150,0)
 . set ARGS("studyid")=sid
"RTN","SAMICAS3",151,0)
 . set ARGS("form")="vapals:fuform"
"RTN","SAMICAS3",152,0)
 . do MKFUFORM(sid,key)
"RTN","SAMICAS3",153,0)
 . quit
"RTN","SAMICAS3",154,0)
 ;
"RTN","SAMICAS3",155,0)
 if nuform="bxform" do  ;
"RTN","SAMICAS3",156,0)
 . new key set key="bxform-"_datekey
"RTN","SAMICAS3",157,0)
 . set ARGS("key")=key
"RTN","SAMICAS3",158,0)
 . set ARGS("studyid")=sid
"RTN","SAMICAS3",159,0)
 . set ARGS("form")="vapals:bxform"
"RTN","SAMICAS3",160,0)
 . do MKBXFORM(sid,key)
"RTN","SAMICAS3",161,0)
 . quit
"RTN","SAMICAS3",162,0)
 ;
"RTN","SAMICAS3",163,0)
 if nuform="ptform" do  ;
"RTN","SAMICAS3",164,0)
 . new key set key="ptform-"_datekey
"RTN","SAMICAS3",165,0)
 . set ARGS("key")=key
"RTN","SAMICAS3",166,0)
 . set ARGS("studyid")=sid
"RTN","SAMICAS3",167,0)
 . set ARGS("form")="vapals:ptform"
"RTN","SAMICAS3",168,0)
 . do MKPTFORM(sid,key)
"RTN","SAMICAS3",169,0)
 . quit
"RTN","SAMICAS3",170,0)
 ;
"RTN","SAMICAS3",171,0)
 if nuform="itform" do  ;
"RTN","SAMICAS3",172,0)
 . new key set key="itform-"_datekey
"RTN","SAMICAS3",173,0)
 . set ARGS("key")=key
"RTN","SAMICAS3",174,0)
 . set ARGS("studyid")=sid
"RTN","SAMICAS3",175,0)
 . set ARGS("form")="vapals:itform"
"RTN","SAMICAS3",176,0)
 . do MKITFORM(sid,key)
"RTN","SAMICAS3",177,0)
 . quit
"RTN","SAMICAS3",178,0)
 ;
"RTN","SAMICAS3",179,0)
 do wsGetForm^%wf(.RESULT,.ARGS)
"RTN","SAMICAS3",180,0)
 ;
"RTN","SAMICAS3",181,0)
 ;
"RTN","SAMICAS3",182,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",183,0)
 ;
"RTN","SAMICAS3",184,0)
 quit  ; end of wri WSNFPOST^SAMICASE
"RTN","SAMICAS3",185,0)
 ;
"RTN","SAMICAS3",186,0)
 ;
"RTN","SAMICAS3",187,0)
 ;
"RTN","SAMICAS3",188,0)
MKSBFORM(sid,key) ; create background form
"RTN","SAMICAS3",189,0)
 ;
"RTN","SAMICAS3",190,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",191,0)
 ;
"RTN","SAMICAS3",192,0)
 ;ven/gpl;private;procedure;
"RTN","SAMICAS3",193,0)
 ;@called-by
"RTN","SAMICAS3",194,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICAS3",195,0)
 ;@calls
"RTN","SAMICAS3",196,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",197,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS3",198,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS3",199,0)
 ;@input
"RTN","SAMICAS3",200,0)
 ; sid = study id
"RTN","SAMICAS3",201,0)
 ; key = form key, e.g. sbform-2021-05-25
"RTN","SAMICAS3",202,0)
 ;@output
"RTN","SAMICAS3",203,0)
 ; @root@("graph",sid,key)
"RTN","SAMICAS3",204,0)
 ;@examples [tbd]
"RTN","SAMICAS3",205,0)
 ;@tests [tbd]
"RTN","SAMICAS3",206,0)
 ;
"RTN","SAMICAS3",207,0)
 ;@stanza 2 create background form
"RTN","SAMICAS3",208,0)
 ;
"RTN","SAMICAS3",209,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",210,0)
 new sien set sien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICAS3",211,0)
 quit:+sien=0
"RTN","SAMICAS3",212,0)
 ;
"RTN","SAMICAS3",213,0)
 new cdate set cdate=$piece(key,"sbform-",2)
"RTN","SAMICAS3",214,0)
 merge @root@("graph",sid,key)=@root@(sien)
"RTN","SAMICAS3",215,0)
 set @root@("graph",sid,key,"samicreatedate")=cdate
"RTN","SAMICAS3",216,0)
 do SSAMISTA^SAMICASE(sid,key,"incomplete")
"RTN","SAMICAS3",217,0)
 ;
"RTN","SAMICAS3",218,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",219,0)
 ;
"RTN","SAMICAS3",220,0)
 quit  ; end of MKSBFORM
"RTN","SAMICAS3",221,0)
 ;
"RTN","SAMICAS3",222,0)
 ;
"RTN","SAMICAS3",223,0)
 ;
"RTN","SAMICAS3",224,0)
PREVNOD(sid) ; key of latest form including nodule grid
"RTN","SAMICAS3",225,0)
 ;
"RTN","SAMICAS3",226,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",227,0)
 ;
"RTN","SAMICAS3",228,0)
 ;ven/gpl;private;function;clean;silent;sac;
"RTN","SAMICAS3",229,0)
 ;@called-by none [commented out in MKCEFORM,MKPTFORM,MKBXFORM]
"RTN","SAMICAS3",230,0)
 ;@calls
"RTN","SAMICAS3",231,0)
 ; SORTFRMS
"RTN","SAMICAS3",232,0)
 ;@input
"RTN","SAMICAS3",233,0)
 ; sid = study id
"RTN","SAMICAS3",234,0)
 ;@output = key of latest form incl nodule grid
"RTN","SAMICAS3",235,0)
 ;@examples [tbd]
"RTN","SAMICAS3",236,0)
 ;@tests [tbd]
"RTN","SAMICAS3",237,0)
 ;
"RTN","SAMICAS3",238,0)
 ; used for nodule copy
"RTN","SAMICAS3",239,0)
 ;
"RTN","SAMICAS3",240,0)
 ;
"RTN","SAMICAS3",241,0)
 ;@stanza 2 calculate key of latest form incl nodule grid
"RTN","SAMICAS3",242,0)
 ;
"RTN","SAMICAS3",243,0)
 new retkey set retkey=""
"RTN","SAMICAS3",244,0)
 new fary
"RTN","SAMICAS3",245,0)
 do SORTFRMS(.fary,sid)
"RTN","SAMICAS3",246,0)
 ;
"RTN","SAMICAS3",247,0)
 new tdt set tdt=""
"RTN","SAMICAS3",248,0)
 for  set tdt=$order(fary(tdt),-1) quit:tdt=""  quit:retkey'=""  do  ; 
"RTN","SAMICAS3",249,0)
 . new tmpkey set tmpkey=""
"RTN","SAMICAS3",250,0)
 . for  set tmpkey=$order(fary(tdt,tmpkey)) quit:tmpkey=""  quit:retkey'=""  do  ; 
"RTN","SAMICAS3",251,0)
 . . if tmpkey["ceform" set retkey=tmpkey
"RTN","SAMICAS3",252,0)
 . . if tmpkey["ptform" set retkey=tmpkey
"RTN","SAMICAS3",253,0)
 . . if tmpkey["bxform" set retkey=tmpkey
"RTN","SAMICAS3",254,0)
 . . quit
"RTN","SAMICAS3",255,0)
 . quit
"RTN","SAMICAS3",256,0)
 ;
"RTN","SAMICAS3",257,0)
 ;
"RTN","SAMICAS3",258,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",259,0)
 ;
"RTN","SAMICAS3",260,0)
 quit retkey ; end of $$PREVNOD
"RTN","SAMICAS3",261,0)
 ;
"RTN","SAMICAS3",262,0)
 ;
"RTN","SAMICAS3",263,0)
 ;
"RTN","SAMICAS3",264,0)
LASTCMP(sid,retkey) ; date & key of last comparison scan
"RTN","SAMICAS3",265,0)
 ;
"RTN","SAMICAS3",266,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",267,0)
 ;
"RTN","SAMICAS3",268,0)
 ;ven/gpl;private;function;clean;silent;sac;
"RTN","SAMICAS3",269,0)
 ;@called-by
"RTN","SAMICAS3",270,0)
 ; MKBXFORM
"RTN","SAMICAS3",271,0)
 ; MKCEFORM
"RTN","SAMICAS3",272,0)
 ; MKFUFORM
"RTN","SAMICAS3",273,0)
 ; MKITFORM
"RTN","SAMICAS3",274,0)
 ; MKPTFORM
"RTN","SAMICAS3",275,0)
 ;@calls
"RTN","SAMICAS3",276,0)
 ; SORTFRMS
"RTN","SAMICAS3",277,0)
 ; $$NOW^XLFDT
"RTN","SAMICAS3",278,0)
 ; $$KEY2FM^SAMICASE
"RTN","SAMICAS3",279,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMICAS3",280,0)
 ;@input
"RTN","SAMICAS3",281,0)
 ; sid = study id
"RTN","SAMICAS3",282,0)
 ;@output = date of last comparison scan
"RTN","SAMICAS3",283,0)
 ; .retkey = key of last comparison scan
"RTN","SAMICAS3",284,0)
 ;@examples [tbd]
"RTN","SAMICAS3",285,0)
 ;@tests [tbd]
"RTN","SAMICAS3",286,0)
 ;
"RTN","SAMICAS3",287,0)
 ;
"RTN","SAMICAS3",288,0)
 ;@stanza 2 calculate date & key of last comparison scan
"RTN","SAMICAS3",289,0)
 ;
"RTN","SAMICAS3",290,0)
 set retkey=""
"RTN","SAMICAS3",291,0)
 new fary
"RTN","SAMICAS3",292,0)
 do SORTFRMS(.fary,sid)
"RTN","SAMICAS3",293,0)
 ;
"RTN","SAMICAS3",294,0)
 new tdt set tdt=$piece($$NOW^XLFDT,".",1)+1 ; start with today
"RTN","SAMICAS3",295,0)
 ;new tdt set tdt=$piece($$NOW^XLFDT,".",1) ; start with before today
"RTN","SAMICAS3",296,0)
 for  set tdt=$order(fary(tdt),-1) quit:tdt=""  quit:retkey'=""  do  ; 
"RTN","SAMICAS3",297,0)
 . new tmpkey set tmpkey=""
"RTN","SAMICAS3",298,0)
 . for  set tmpkey=$order(fary(tdt,tmpkey)) quit:tmpkey=""  quit:retkey'=""  do  ; 
"RTN","SAMICAS3",299,0)
 . . if tmpkey["ceform" set retkey=tmpkey
"RTN","SAMICAS3",300,0)
 . . quit
"RTN","SAMICAS3",301,0)
 . quit
"RTN","SAMICAS3",302,0)
 ;
"RTN","SAMICAS3",303,0)
 new retdt set retdt=-1
"RTN","SAMICAS3",304,0)
 if retkey'="" do  ;
"RTN","SAMICAS3",305,0)
 . new fmdt set fmdt=$$KEY2FM^SAMICASE(retkey)
"RTN","SAMICAS3",306,0)
 . set retdt=$$VAPALSDT^SAMICASE(fmdt)
"RTN","SAMICAS3",307,0)
 . quit
"RTN","SAMICAS3",308,0)
 ;
"RTN","SAMICAS3",309,0)
 ;
"RTN","SAMICAS3",310,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",311,0)
 ;
"RTN","SAMICAS3",312,0)
 quit retdt ; end of $$LASTCMP
"RTN","SAMICAS3",313,0)
 ;
"RTN","SAMICAS3",314,0)
 ;
"RTN","SAMICAS3",315,0)
 ;
"RTN","SAMICAS3",316,0)
PRIORCMP(sid) ; dates of all scans before last comparison scan
"RTN","SAMICAS3",317,0)
 ;
"RTN","SAMICAS3",318,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",319,0)
 ;
"RTN","SAMICAS3",320,0)
 ;ven/gpl;private;function;clean;silent;sac;
"RTN","SAMICAS3",321,0)
 ;@called-by
"RTN","SAMICAS3",322,0)
 ; MKCEFORM
"RTN","SAMICAS3",323,0)
 ; MKPTFORM
"RTN","SAMICAS3",324,0)
 ; MKITFORM
"RTN","SAMICAS3",325,0)
 ;@calls
"RTN","SAMICAS3",326,0)
 ; SORTFRMS
"RTN","SAMICAS3",327,0)
 ; $$NOW^XLFDT
"RTN","SAMICAS3",328,0)
 ; $$KEY2DT
"RTN","SAMICAS3",329,0)
 ;@input
"RTN","SAMICAS3",330,0)
 ; sid = study id
"RTN","SAMICAS3",331,0)
 ;@output = dates of all scans before last comparison scan
"RTN","SAMICAS3",332,0)
 ;@examples [tbd]
"RTN","SAMICAS3",333,0)
 ;@tests [tbd]
"RTN","SAMICAS3",334,0)
 ;
"RTN","SAMICAS3",335,0)
 ;
"RTN","SAMICAS3",336,0)
 ;@stanza 2 calculate dates of all scans before last comparison scan
"RTN","SAMICAS3",337,0)
 ;
"RTN","SAMICAS3",338,0)
 new retstr set retstr=""
"RTN","SAMICAS3",339,0)
 new lastcmp set lastcmp=""
"RTN","SAMICAS3",340,0)
 new fary
"RTN","SAMICAS3",341,0)
 do SORTFRMS(.fary,sid)
"RTN","SAMICAS3",342,0)
 ;
"RTN","SAMICAS3",343,0)
 ; new tdt set tdt=$piece($$NOW^XLFDT,".",1)+1 ; start with today
"RTN","SAMICAS3",344,0)
 new tdt set tdt=$piece($$NOW^XLFDT,".",1) ; start with before today
"RTN","SAMICAS3",345,0)
 for  set tdt=$order(fary(tdt),-1) quit:tdt=""  do  ; 
"RTN","SAMICAS3",346,0)
 . ;
"RTN","SAMICAS3",347,0)
 . if lastcmp="" do  ; first find the last comparison scan
"RTN","SAMICAS3",348,0)
 . . new tmpkey set tmpkey=""
"RTN","SAMICAS3",349,0)
 . . for  set tmpkey=$order(fary(tdt,tmpkey)) quit:tmpkey=""  quit:lastcmp'=""  do  ; 
"RTN","SAMICAS3",350,0)
 . . . if tmpkey["ceform" set lastcmp=tmpkey
"RTN","SAMICAS3",351,0)
 . . . quit
"RTN","SAMICAS3",352,0)
 . . quit
"RTN","SAMICAS3",353,0)
 . ;
"RTN","SAMICAS3",354,0)
 . do  ;
"RTN","SAMICAS3",355,0)
 . . ; next add all previous scans to retstr
"RTN","SAMICAS3",356,0)
 . . new tmpkey2 set tmpkey2=""
"RTN","SAMICAS3",357,0)
 . . for  set tmpkey2=$order(fary(tdt,tmpkey2)) quit:tmpkey2=""  do  ; 
"RTN","SAMICAS3",358,0)
 . . . if tmpkey2["ceform" do  ; convert to external date
"RTN","SAMICAS3",359,0)
 . . . . set retstr=$$KEY2DT(tmpkey2)_retstr
"RTN","SAMICAS3",360,0)
 . . . . quit
"RTN","SAMICAS3",361,0)
 . . . quit
"RTN","SAMICAS3",362,0)
 . . quit
"RTN","SAMICAS3",363,0)
 . quit
"RTN","SAMICAS3",364,0)
 ;
"RTN","SAMICAS3",365,0)
 if $extract(retstr,$length(retstr))="," do
"RTN","SAMICAS3",366,0)
 . set retstr=$extract(retstr,1,$length(retstr)-1)
"RTN","SAMICAS3",367,0)
 . quit
"RTN","SAMICAS3",368,0)
 ;
"RTN","SAMICAS3",369,0)
 ;
"RTN","SAMICAS3",370,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",371,0)
 ;
"RTN","SAMICAS3",372,0)
 quit retstr ; end of $$PRIORCMP
"RTN","SAMICAS3",373,0)
 ;
"RTN","SAMICAS3",374,0)
 ;
"RTN","SAMICAS3",375,0)
 ;
"RTN","SAMICAS3",376,0)
KEY2DT(key) ; date to put in prior scans field
"RTN","SAMICAS3",377,0)
 ;
"RTN","SAMICAS3",378,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",379,0)
 ;
"RTN","SAMICAS3",380,0)
 ;ven/gpl;private;function;clean;silent;sac;
"RTN","SAMICAS3",381,0)
 ;@called-by
"RTN","SAMICAS3",382,0)
 ; $$PRIORCMP
"RTN","SAMICAS3",383,0)
 ;@calls
"RTN","SAMICAS3",384,0)
 ; $$KEY2FM^SAMICASE
"RTN","SAMICAS3",385,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMICAS3",386,0)
 ;@input
"RTN","SAMICAS3",387,0)
 ; key = form key, e.g. ctform-2021-05-25
"RTN","SAMICAS3",388,0)
 ;@output = date to put in prior scans field
"RTN","SAMICAS3",389,0)
 ;@examples [tbd]
"RTN","SAMICAS3",390,0)
 ;@tests [tbd]
"RTN","SAMICAS3",391,0)
 ;
"RTN","SAMICAS3",392,0)
 ;
"RTN","SAMICAS3",393,0)
 ;@stanza 2 calculate prior scans date
"RTN","SAMICAS3",394,0)
 ;
"RTN","SAMICAS3",395,0)
 new retstr2 set retstr2=""
"RTN","SAMICAS3",396,0)
 new fmdt set fmdt=$$KEY2FM^SAMICASE(tmpkey2)
"RTN","SAMICAS3",397,0)
 set retstr2=$$VAPALSDT^SAMICASE(fmdt)_","_retstr2
"RTN","SAMICAS3",398,0)
 ;
"RTN","SAMICAS3",399,0)
 ;
"RTN","SAMICAS3",400,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",401,0)
 ;
"RTN","SAMICAS3",402,0)
 quit retstr2 ; end of $$KEY2DT
"RTN","SAMICAS3",403,0)
 ;
"RTN","SAMICAS3",404,0)
 ;
"RTN","SAMICAS3",405,0)
 ;
"RTN","SAMICAS3",406,0)
SORTFRMS(ARY,sid) ; sorts all forms for patient sid by date
"RTN","SAMICAS3",407,0)
 ;
"RTN","SAMICAS3",408,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",409,0)
 ;
"RTN","SAMICAS3",410,0)
 ;ven/gpl;private;procedure;clean;silent;sac;
"RTN","SAMICAS3",411,0)
 ;@called-by
"RTN","SAMICAS3",412,0)
 ; $$PREVNOD
"RTN","SAMICAS3",413,0)
 ; $$LASTCMP
"RTN","SAMICAS3",414,0)
 ; $$PRIORCMP
"RTN","SAMICAS3",415,0)
 ;@calls
"RTN","SAMICAS3",416,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",417,0)
 ; ^%DT
"RTN","SAMICAS3",418,0)
 ; ^%ZTER
"RTN","SAMICAS3",419,0)
 ;@input
"RTN","SAMICAS3",420,0)
 ; sid = study id
"RTN","SAMICAS3",421,0)
 ;@output
"RTN","SAMICAS3",422,0)
 ; .ARY: sorted array of all forms for patient by date
"RTN","SAMICAS3",423,0)
 ;  ARY(fmdate,key)=""
"RTN","SAMICAS3",424,0)
 ;@examples [tbd]
"RTN","SAMICAS3",425,0)
 ;@tests [tbd]
"RTN","SAMICAS3",426,0)
 ;
"RTN","SAMICAS3",427,0)
 ;
"RTN","SAMICAS3",428,0)
 ;@stanza 2 sort patient's forms by date
"RTN","SAMICAS3",429,0)
 ;
"RTN","SAMICAS3",430,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",431,0)
 quit:'$data(@root@("graph",sid))
"RTN","SAMICAS3",432,0)
 new froot set froot=$name(@root@("graph",sid))
"RTN","SAMICAS3",433,0)
 ;
"RTN","SAMICAS3",434,0)
 new zi set zi=""
"RTN","SAMICAS3",435,0)
 for  set zi=$order(@froot@(zi)) quit:zi=""  do  ;
"RTN","SAMICAS3",436,0)
 . new ftype set ftype=$piece(zi,"-",1)
"RTN","SAMICAS3",437,0)
 . new fdate set fdate=$piece(zi,ftype_"-",2)
"RTN","SAMICAS3",438,0)
 . new X,Y
"RTN","SAMICAS3",439,0)
 . set X=fdate
"RTN","SAMICAS3",440,0)
 . do ^%DT
"RTN","SAMICAS3",441,0)
 . if Y=-1 do ^%ZTER quit  ;
"RTN","SAMICAS3",442,0)
 . set ARY(Y,zi)=""
"RTN","SAMICAS3",443,0)
 . quit
"RTN","SAMICAS3",444,0)
 ;
"RTN","SAMICAS3",445,0)
 ;
"RTN","SAMICAS3",446,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",447,0)
 ;
"RTN","SAMICAS3",448,0)
 quit  ; end of SORTFRMS
"RTN","SAMICAS3",449,0)
 ;
"RTN","SAMICAS3",450,0)
 ;
"RTN","SAMICAS3",451,0)
 ;
"RTN","SAMICAS3",452,0)
MKCEFORM(sid,key) ; create ct evaluation form
"RTN","SAMICAS3",453,0)
 ;
"RTN","SAMICAS3",454,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",455,0)
 ;
"RTN","SAMICAS3",456,0)
 ;ven/gpl;private;procedure;clean;silent;sac;
"RTN","SAMICAS3",457,0)
 ;@called-by
"RTN","SAMICAS3",458,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICAS3",459,0)
 ;@calls
"RTN","SAMICAS3",460,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",461,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS3",462,0)
 ; $$LASTCMP
"RTN","SAMICAS3",463,0)
 ; CTCOPY^SAMICTC1
"RTN","SAMICAS3",464,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS3",465,0)
 ; $$BASELNDT^SAMICAS3
"RTN","SAMICAS3",466,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMICAS3",467,0)
 ; $$LASTCMP^SAMICAS3
"RTN","SAMICAS3",468,0)
 ; $$PRIORCMP^SAMICAS3
"RTN","SAMICAS3",469,0)
 ;@input
"RTN","SAMICAS3",470,0)
 ; sid = study id
"RTN","SAMICAS3",471,0)
 ; key = form key, e.g. ceform-2021-05-25
"RTN","SAMICAS3",472,0)
 ;@output
"RTN","SAMICAS3",473,0)
 ; @root@("graph",sid,key)
"RTN","SAMICAS3",474,0)
 ;@examples [tbd]
"RTN","SAMICAS3",475,0)
 ;@tests [tbd]
"RTN","SAMICAS3",476,0)
 ;
"RTN","SAMICAS3",477,0)
 ;
"RTN","SAMICAS3",478,0)
 ;@stanza 2 create ct eval form
"RTN","SAMICAS3",479,0)
 ;
"RTN","SAMICAS3",480,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",481,0)
 new sien set sien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICAS3",482,0)
 quit:+sien=0
"RTN","SAMICAS3",483,0)
 new cdate set cdate=$piece(key,"ceform-",2)
"RTN","SAMICAS3",484,0)
 ;
"RTN","SAMICAS3",485,0)
 ; nodule copy
"RTN","SAMICAS3",486,0)
 ; new srckey set srckey=$$PREVNOD(sid)
"RTN","SAMICAS3",487,0)
 new srckey,srcdate set srcdate=$$LASTCMP(sid,.srckey)
"RTN","SAMICAS3",488,0)
 if srckey'="" do  ;
"RTN","SAMICAS3",489,0)
 . new source set source=$name(@root@("graph",sid,srckey))
"RTN","SAMICAS3",490,0)
 . new target set target=$name(@root@("graph",sid,key))
"RTN","SAMICAS3",491,0)
 . do CTCOPY^SAMICTC1(source,target,key)
"RTN","SAMICAS3",492,0)
 . quit
"RTN","SAMICAS3",493,0)
 ; end nodule copy
"RTN","SAMICAS3",494,0)
 ;
"RTN","SAMICAS3",495,0)
 ; new items,prevct
"RTN","SAMICAS3",496,0)
 ; do GETITEMS^SAMICASE("items",sid)
"RTN","SAMICAS3",497,0)
 ; set prevct=""
"RTN","SAMICAS3",498,0)
 ; if $data(items("type","vapals:ceform")) do  ; previous cteval exists
"RTN","SAMICAS3",499,0)
 ; . set prevct=$order(items("type","vapals:ceform",""),-1) ; latest ceform
"RTN","SAMICAS3",500,0)
 ; . quit
"RTN","SAMICAS3",501,0)
 ; if prevct'="" do  ;
"RTN","SAMICAS3",502,0)
 ; . new target,source
"RTN","SAMICAS3",503,0)
 ; . set source=$name(@root@("graph",sid,prevct))
"RTN","SAMICAS3",504,0)
 ; . set target=$name(@root@("graph",sid,key))
"RTN","SAMICAS3",505,0)
 ; . do CTCOPY^SAMICTC1(source,target,key)
"RTN","SAMICAS3",506,0)
 ; . quit
"RTN","SAMICAS3",507,0)
 ;
"RTN","SAMICAS3",508,0)
 merge @root@("graph",sid,key)=@root@(sien)
"RTN","SAMICAS3",509,0)
 set @root@("graph",sid,key,"samicreatedate")=cdate
"RTN","SAMICAS3",510,0)
 do SSAMISTA^SAMICASE(sid,key,"incomplete")
"RTN","SAMICAS3",511,0)
 ;
"RTN","SAMICAS3",512,0)
 ; set baseline CT date and last comparison scan date
"RTN","SAMICAS3",513,0)
 do  ;
"RTN","SAMICAS3",514,0)
 . new basedt
"RTN","SAMICAS3",515,0)
 . set basedt=$$BASELNDT^SAMICAS3(sid)
"RTN","SAMICAS3",516,0)
 . if basedt=-1 set basedt=$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMICAS3",517,0)
 . new lastdt set lastdt=$$LASTCMP^SAMICAS3(sid)
"RTN","SAMICAS3",518,0)
 . if lastdt=-1 set lastdt=basedt
"RTN","SAMICAS3",519,0)
 . new priordt set priordt=$$PRIORCMP^SAMICAS3(sid)
"RTN","SAMICAS3",520,0)
 . if priordt=-1 set priordt=lastdt
"RTN","SAMICAS3",521,0)
 . if priordt="" set priordt=lastdt
"RTN","SAMICAS3",522,0)
 . set @root@("graph",sid,key,"sidoe")=basedt
"RTN","SAMICAS3",523,0)
 . set @root@("graph",sid,key,"cedcs")=lastdt
"RTN","SAMICAS3",524,0)
 . set @root@("graph",sid,key,"cedps")=priordt
"RTN","SAMICAS3",525,0)
 . quit
"RTN","SAMICAS3",526,0)
 ;
"RTN","SAMICAS3",527,0)
 ;
"RTN","SAMICAS3",528,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",529,0)
 ;
"RTN","SAMICAS3",530,0)
 quit  ; end of MKCEFORM
"RTN","SAMICAS3",531,0)
 ;
"RTN","SAMICAS3",532,0)
 ;
"RTN","SAMICAS3",533,0)
 ;
"RTN","SAMICAS3",534,0)
MKFUFORM(sid,key) ; create Follow-up form
"RTN","SAMICAS3",535,0)
 ;
"RTN","SAMICAS3",536,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",537,0)
 ;
"RTN","SAMICAS3",538,0)
 ;ven/gpl;private;procedure;clean;silent;sac;
"RTN","SAMICAS3",539,0)
 ;@called-by
"RTN","SAMICAS3",540,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICAS3",541,0)
 ;@calls
"RTN","SAMICAS3",542,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",543,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS3",544,0)
 ; $$KEY2DSPD^SAMICAS2
"RTN","SAMICAS3",545,0)
 ; $$BASELNDT
"RTN","SAMICAS3",546,0)
 ; $$LASTCMP
"RTN","SAMICAS3",547,0)
 ; $$NOW^XLFDT
"RTN","SAMICAS3",548,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMICAS3",549,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS3",550,0)
 ;@input
"RTN","SAMICAS3",551,0)
 ; sid = study id
"RTN","SAMICAS3",552,0)
 ; key = form key, e.g. fuform-2021-05-25
"RTN","SAMICAS3",553,0)
 ;@output
"RTN","SAMICAS3",554,0)
 ; @root@("graph",sid,key)
"RTN","SAMICAS3",555,0)
 ;@examples [tbd]
"RTN","SAMICAS3",556,0)
 ;@tests [tbd]
"RTN","SAMICAS3",557,0)
 ;
"RTN","SAMICAS3",558,0)
 ;
"RTN","SAMICAS3",559,0)
 ;@stanza 2 create Follow-up form
"RTN","SAMICAS3",560,0)
 ;
"RTN","SAMICAS3",561,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",562,0)
 new sien set sien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICAS3",563,0)
 quit:+sien=0
"RTN","SAMICAS3",564,0)
 ;
"RTN","SAMICAS3",565,0)
 new cdate set cdate=$piece(key,"fuform-",2)
"RTN","SAMICAS3",566,0)
 merge @root@("graph",sid,key)=@root@(sien)
"RTN","SAMICAS3",567,0)
 ;
"RTN","SAMICAS3",568,0)
 set @root@("graph",sid,key,"samicreatedate")=cdate
"RTN","SAMICAS3",569,0)
 set @root@("graph",sid,key,"sidof")=$$KEY2DSPD^SAMICAS2(cdate)
"RTN","SAMICAS3",570,0)
 new basedt
"RTN","SAMICAS3",571,0)
 set basedt=$$BASELNDT^SAMICAS3(sid)
"RTN","SAMICAS3",572,0)
 if basedt=-1 set basedt=$$LASTCMP^SAMICAS3(sid)
"RTN","SAMICAS3",573,0)
 if basedt=-1 set basedt=$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMICAS3",574,0)
 set @root@("graph",sid,key,"sidoe")=basedt
"RTN","SAMICAS3",575,0)
 do SSAMISTA^SAMICASE(sid,key,"incomplete")
"RTN","SAMICAS3",576,0)
 ;
"RTN","SAMICAS3",577,0)
 ;
"RTN","SAMICAS3",578,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",579,0)
 ;
"RTN","SAMICAS3",580,0)
 quit  ; end of MKFUFORM
"RTN","SAMICAS3",581,0)
 ;
"RTN","SAMICAS3",582,0)
 ;
"RTN","SAMICAS3",583,0)
 ;
"RTN","SAMICAS3",584,0)
BASELNDT(sid) ; last previous baseline ct date
"RTN","SAMICAS3",585,0)
 ;
"RTN","SAMICAS3",586,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",587,0)
 ;
"RTN","SAMICAS3",588,0)
 ;ven/gpl;private;function;clean;silent;sac
"RTN","SAMICAS3",589,0)
 ;@called-by
"RTN","SAMICAS3",590,0)
 ; MKCEFORM
"RTN","SAMICAS3",591,0)
 ; MKFUFORM
"RTN","SAMICAS3",592,0)
 ; MKPTFORM
"RTN","SAMICAS3",593,0)
 ; MKITFORM
"RTN","SAMICAS3",594,0)
 ;@calls
"RTN","SAMICAS3",595,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",596,0)
 ; GETITEMS^SAMICASE
"RTN","SAMICAS3",597,0)
 ; $$KEY2DSPD^SAMICAS2
"RTN","SAMICAS3",598,0)
 ;@input
"RTN","SAMICAS3",599,0)
 ; sid = study id
"RTN","SAMICAS3",600,0)
 ;@output = last previous baseline ct date
"RTN","SAMICAS3",601,0)
 ;@examples [tbd]
"RTN","SAMICAS3",602,0)
 ;@tests [tbd]
"RTN","SAMICAS3",603,0)
 ;
"RTN","SAMICAS3",604,0)
 ;
"RTN","SAMICAS3",605,0)
 ;@stanza 2 calculate last previous baseline ct date
"RTN","SAMICAS3",606,0)
 ;
"RTN","SAMICAS3",607,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",608,0)
 new groot set groot=$name(@root@("graph",sid))
"RTN","SAMICAS3",609,0)
 new items set items=""
"RTN","SAMICAS3",610,0)
 do GETITEMS^SAMICASE("items",sid)
"RTN","SAMICAS3",611,0)
 quit:'$data(items) ""
"RTN","SAMICAS3",612,0)
 ;
"RTN","SAMICAS3",613,0)
 new bdate set bdate=""
"RTN","SAMICAS3",614,0)
 new bkey set bkey=""
"RTN","SAMICAS3",615,0)
 new done set done=0
"RTN","SAMICAS3",616,0)
 for  set bkey=$order(items("type","vapals:ceform",bkey)) quit:bkey=""  do  ;
"RTN","SAMICAS3",617,0)
 . ; write !,bkey," ",$get(@groot@(bkey,"cetex"))
"RTN","SAMICAS3",618,0)
 . if $get(@groot@(bkey,"cetex"))="b" do  ;
"RTN","SAMICAS3",619,0)
 . . set done=1
"RTN","SAMICAS3",620,0)
 . . set bdate=$piece(bkey,"ceform-",2)
"RTN","SAMICAS3",621,0)
 . . quit
"RTN","SAMICAS3",622,0)
 . quit
"RTN","SAMICAS3",623,0)
 set bdate=$$KEY2DSPD^SAMICAS2(bdate)
"RTN","SAMICAS3",624,0)
 ;
"RTN","SAMICAS3",625,0)
 ;
"RTN","SAMICAS3",626,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",627,0)
 ;
"RTN","SAMICAS3",628,0)
 quit bdate ; end of $$BASELNDT
"RTN","SAMICAS3",629,0)
 ;
"RTN","SAMICAS3",630,0)
 ;
"RTN","SAMICAS3",631,0)
 ;
"RTN","SAMICAS3",632,0)
MKPTFORM(sid,key) ; create pet evaluation form
"RTN","SAMICAS3",633,0)
 ;
"RTN","SAMICAS3",634,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",635,0)
 ;
"RTN","SAMICAS3",636,0)
 ;ven/gpl;private;procedure;clean;silent;sac
"RTN","SAMICAS3",637,0)
 ;@called-by
"RTN","SAMICAS3",638,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICAS3",639,0)
 ;@calls
"RTN","SAMICAS3",640,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",641,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS3",642,0)
 ; $$LASTCMP
"RTN","SAMICAS3",643,0)
 ; CTCOPY^SAMICTC1
"RTN","SAMICAS3",644,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS3",645,0)
 ; $$BASELNDT^SAMICAS3
"RTN","SAMICAS3",646,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMICAS3",647,0)
 ; $$LASTCMP^SAMICAS3
"RTN","SAMICAS3",648,0)
 ; $$PRIORCMP^SAMICAS3
"RTN","SAMICAS3",649,0)
 ;@input
"RTN","SAMICAS3",650,0)
 ; sid = study id
"RTN","SAMICAS3",651,0)
 ; key = form key, e.g. ptform-2021-05-25
"RTN","SAMICAS3",652,0)
 ;@output
"RTN","SAMICAS3",653,0)
 ; @root@("graph",sid,key)
"RTN","SAMICAS3",654,0)
 ;@examples [tbd]
"RTN","SAMICAS3",655,0)
 ;@tests [tbd]
"RTN","SAMICAS3",656,0)
 ;
"RTN","SAMICAS3",657,0)
 ;
"RTN","SAMICAS3",658,0)
 ;@stanza 2 create pet eval form
"RTN","SAMICAS3",659,0)
 ;
"RTN","SAMICAS3",660,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",661,0)
 new sien set sien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICAS3",662,0)
 quit:+sien=0
"RTN","SAMICAS3",663,0)
 ;
"RTN","SAMICAS3",664,0)
 ; nodule copy
"RTN","SAMICAS3",665,0)
 ; new srckey set srckey=$$PREVNOD(sid)
"RTN","SAMICAS3",666,0)
 new srckey,srcdate set srcdate=$$LASTCMP(sid,.srckey)
"RTN","SAMICAS3",667,0)
 if srckey'="" do  ;
"RTN","SAMICAS3",668,0)
 . new source set source=$name(@root@("graph",sid,srckey))
"RTN","SAMICAS3",669,0)
 . new target set target=$name(@root@("graph",sid,key))
"RTN","SAMICAS3",670,0)
 . do CTCOPY^SAMICTC1(source,target,key)
"RTN","SAMICAS3",671,0)
 . quit
"RTN","SAMICAS3",672,0)
 ; end nodule copy
"RTN","SAMICAS3",673,0)
 ;
"RTN","SAMICAS3",674,0)
 new cdate set cdate=$piece(key,"ptform-",2)
"RTN","SAMICAS3",675,0)
 merge @root@("graph",sid,key)=@root@(sien)
"RTN","SAMICAS3",676,0)
 set @root@("graph",sid,key,"samicreatedate")=cdate
"RTN","SAMICAS3",677,0)
 do SSAMISTA^SAMICASE(sid,key,"incomplete")
"RTN","SAMICAS3",678,0)
 ;
"RTN","SAMICAS3",679,0)
 do  ;
"RTN","SAMICAS3",680,0)
 . new basedt
"RTN","SAMICAS3",681,0)
 . set basedt=$$BASELNDT^SAMICAS3(sid)
"RTN","SAMICAS3",682,0)
 . if basedt=-1 set basedt=$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMICAS3",683,0)
 . new lastdt set lastdt=$$LASTCMP^SAMICAS3(sid)
"RTN","SAMICAS3",684,0)
 . if lastdt=-1 set lastdt=basedt
"RTN","SAMICAS3",685,0)
 . new priordt set priordt=$$PRIORCMP^SAMICAS3(sid)
"RTN","SAMICAS3",686,0)
 . if priordt=-1 set priordt=lastdt
"RTN","SAMICAS3",687,0)
 . set @root@("graph",sid,key,"sidoe")=basedt
"RTN","SAMICAS3",688,0)
 . ; set @root@("graph",sid,key,"cedcs")=lastdt
"RTN","SAMICAS3",689,0)
 . set @root@("graph",sid,key,"cedos")=lastdt ; it's different than on the ce
"RTN","SAMICAS3",690,0)
 . ; set @root@("graph",sid,key,"cedps")=priordt
"RTN","SAMICAS3",691,0)
 . quit
"RTN","SAMICAS3",692,0)
 ;
"RTN","SAMICAS3",693,0)
 ;
"RTN","SAMICAS3",694,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",695,0)
 ;
"RTN","SAMICAS3",696,0)
 quit  ; end of MKPTFORM
"RTN","SAMICAS3",697,0)
 ;
"RTN","SAMICAS3",698,0)
 ;
"RTN","SAMICAS3",699,0)
 ;
"RTN","SAMICAS3",700,0)
MKITFORM(sid,key) ; create intervention form
"RTN","SAMICAS3",701,0)
 ;
"RTN","SAMICAS3",702,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",703,0)
 ;
"RTN","SAMICAS3",704,0)
 ;ven/gpl;private;procedure;clean;silent;sac
"RTN","SAMICAS3",705,0)
 ;@called-by
"RTN","SAMICAS3",706,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICAS3",707,0)
 ;@calls
"RTN","SAMICAS3",708,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",709,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS3",710,0)
 ; $$PREVNODE [commented out]
"RTN","SAMICAS3",711,0)
 ; $$LASTCMP
"RTN","SAMICAS3",712,0)
 ; CTCOPY^SAMICTC1
"RTN","SAMICAS3",713,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS3",714,0)
 ; $$BASELNDT^SAMICAS3
"RTN","SAMICAS3",715,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMICAS3",716,0)
 ; $$LASTCMP^SAMICAS3
"RTN","SAMICAS3",717,0)
 ; $$PRIORCMP^SAMICAS3
"RTN","SAMICAS3",718,0)
 ;@input
"RTN","SAMICAS3",719,0)
 ; sid = study id
"RTN","SAMICAS3",720,0)
 ; key = form key, e.g. itform-2021-05-25
"RTN","SAMICAS3",721,0)
 ;@output
"RTN","SAMICAS3",722,0)
 ; @root@("graph",sid,key)
"RTN","SAMICAS3",723,0)
 ;@examples [tbd]
"RTN","SAMICAS3",724,0)
 ;@tests [tbd]
"RTN","SAMICAS3",725,0)
 ;
"RTN","SAMICAS3",726,0)
 ;
"RTN","SAMICAS3",727,0)
 ;@stanza 2 create intervention form
"RTN","SAMICAS3",728,0)
 ;
"RTN","SAMICAS3",729,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",730,0)
 new sien set sien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICAS3",731,0)
 quit:+sien=0
"RTN","SAMICAS3",732,0)
 ;
"RTN","SAMICAS3",733,0)
 new cdate set cdate=$piece(key,"itform-",2)
"RTN","SAMICAS3",734,0)
 ;
"RTN","SAMICAS3",735,0)
 ; nodule copy
"RTN","SAMICAS3",736,0)
 ; new srckey set srckey=$$PREVNOD(sid)
"RTN","SAMICAS3",737,0)
 new srckey,srcdate set srcdate=$$LASTCMP(sid,.srckey)
"RTN","SAMICAS3",738,0)
 if srckey'="" do  ;
"RTN","SAMICAS3",739,0)
 . new source set source=$name(@root@("graph",sid,srckey))
"RTN","SAMICAS3",740,0)
 . new target set target=$name(@root@("graph",sid,key))
"RTN","SAMICAS3",741,0)
 . do CTCOPY^SAMICTC1(source,target,key)
"RTN","SAMICAS3",742,0)
 . quit
"RTN","SAMICAS3",743,0)
 ; end nodule copy
"RTN","SAMICAS3",744,0)
 ;
"RTN","SAMICAS3",745,0)
 merge @root@("graph",sid,key)=@root@(sien)
"RTN","SAMICAS3",746,0)
 set @root@("graph",sid,key,"samicreatedate")=cdate
"RTN","SAMICAS3",747,0)
 do SSAMISTA^SAMICASE(sid,key,"incomplete")
"RTN","SAMICAS3",748,0)
 ;
"RTN","SAMICAS3",749,0)
 do  ;
"RTN","SAMICAS3",750,0)
 . new basedt
"RTN","SAMICAS3",751,0)
 . set basedt=$$BASELNDT^SAMICAS3(sid)
"RTN","SAMICAS3",752,0)
 . if basedt=-1 set basedt=$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMICAS3",753,0)
 . new lastdt set lastdt=$$LASTCMP^SAMICAS3(sid)
"RTN","SAMICAS3",754,0)
 . if lastdt=-1 set lastdt=basedt
"RTN","SAMICAS3",755,0)
 . new priordt set priordt=$$PRIORCMP^SAMICAS3(sid)
"RTN","SAMICAS3",756,0)
 . if priordt=-1 set priordt=lastdt
"RTN","SAMICAS3",757,0)
 . set @root@("graph",sid,key,"sidoe")=basedt
"RTN","SAMICAS3",758,0)
 . ; set @root@("graph",sid,key,"cedcs")=lastdt
"RTN","SAMICAS3",759,0)
 . set @root@("graph",sid,key,"cedos")=lastdt ; it's different than on the ce
"RTN","SAMICAS3",760,0)
 . ; set @root@("graph",sid,key,"cedps")=priordt
"RTN","SAMICAS3",761,0)
 . quit
"RTN","SAMICAS3",762,0)
 ;
"RTN","SAMICAS3",763,0)
 ;
"RTN","SAMICAS3",764,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",765,0)
 ;
"RTN","SAMICAS3",766,0)
 quit  ; end of MKITFORM
"RTN","SAMICAS3",767,0)
 ;
"RTN","SAMICAS3",768,0)
 ;
"RTN","SAMICAS3",769,0)
 ;
"RTN","SAMICAS3",770,0)
MKBXFORM(sid,key) ; create biopsy form
"RTN","SAMICAS3",771,0)
 ;
"RTN","SAMICAS3",772,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",773,0)
 ;
"RTN","SAMICAS3",774,0)
 ;ven/gpl;private;procedure;clean;silent;sac
"RTN","SAMICAS3",775,0)
 ;@called-by
"RTN","SAMICAS3",776,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICAS3",777,0)
 ;@calls
"RTN","SAMICAS3",778,0)
 ; $$setroot^%wd
"RTN","SAMICAS3",779,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS3",780,0)
 ; $$LASTCMP
"RTN","SAMICAS3",781,0)
 ; CTCOPY^SAMICTC1
"RTN","SAMICAS3",782,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS3",783,0)
 ;@input
"RTN","SAMICAS3",784,0)
 ; sid = study id
"RTN","SAMICAS3",785,0)
 ; key = form key, e.g. bxform-2021-05-25
"RTN","SAMICAS3",786,0)
 ;@output
"RTN","SAMICAS3",787,0)
 ; @root@("graph",sid,key)
"RTN","SAMICAS3",788,0)
 ;@examples [tbd]
"RTN","SAMICAS3",789,0)
 ;@tests [tbd]
"RTN","SAMICAS3",790,0)
 ;
"RTN","SAMICAS3",791,0)
 ;
"RTN","SAMICAS3",792,0)
 ;@stanza 2 create background form
"RTN","SAMICAS3",793,0)
 ;
"RTN","SAMICAS3",794,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS3",795,0)
 new sien set sien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICAS3",796,0)
 quit:+sien=0
"RTN","SAMICAS3",797,0)
 new cdate set cdate=$piece(key,"bxform-",2)
"RTN","SAMICAS3",798,0)
 ;
"RTN","SAMICAS3",799,0)
 ; nodule copy
"RTN","SAMICAS3",800,0)
 ; new srckey set srckey=$$PREVNOD(sid)
"RTN","SAMICAS3",801,0)
 new srckey,srcdate set srcdate=$$LASTCMP(sid,.srckey)
"RTN","SAMICAS3",802,0)
 if srckey'="" do  ;
"RTN","SAMICAS3",803,0)
 . new source set source=$name(@root@("graph",sid,srckey))
"RTN","SAMICAS3",804,0)
 . new target set target=$name(@root@("graph",sid,key))
"RTN","SAMICAS3",805,0)
 . do CTCOPY^SAMICTC1(source,target,key)
"RTN","SAMICAS3",806,0)
 . quit
"RTN","SAMICAS3",807,0)
 ; end nodule copy
"RTN","SAMICAS3",808,0)
 ;
"RTN","SAMICAS3",809,0)
 merge @root@("graph",sid,key)=@root@(sien)
"RTN","SAMICAS3",810,0)
 set @root@("graph",sid,key,"samicreatedate")=cdate
"RTN","SAMICAS3",811,0)
 do SSAMISTA^SAMICASE(sid,key,"incomplete")
"RTN","SAMICAS3",812,0)
 ;
"RTN","SAMICAS3",813,0)
 ;
"RTN","SAMICAS3",814,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",815,0)
 ;
"RTN","SAMICAS3",816,0)
 quit  ; end of MKBXFORM
"RTN","SAMICAS3",817,0)
 ;
"RTN","SAMICAS3",818,0)
 ;
"RTN","SAMICAS3",819,0)
 ;
"RTN","SAMICAS3",820,0)
CASETBL(ary) ; generates case review table
"RTN","SAMICAS3",821,0)
 ;
"RTN","SAMICAS3",822,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS3",823,0)
 ;
"RTN","SAMICAS3",824,0)
 ;ven/gpl;private;procedure;clean;silent;sac
"RTN","SAMICAS3",825,0)
 ;@called by none
"RTN","SAMICAS3",826,0)
 ;@calls
"RTN","SAMICAS3",827,0)
 ;@input
"RTN","SAMICAS3",828,0)
 ; ary = name of array (passed by name, will be cleared)
"RTN","SAMICAS3",829,0)
 ;@output
"RTN","SAMICAS3",830,0)
 ; @ary
"RTN","SAMICAS3",831,0)
 ;@tests
"RTN","SAMICAS3",832,0)
 ; SAMIUTS2
"RTN","SAMICAS3",833,0)
 ;
"RTN","SAMICAS3",834,0)
 ;
"RTN","SAMICAS3",835,0)
 ;@stanza 2 build table
"RTN","SAMICAS3",836,0)
 ;
"RTN","SAMICAS3",837,0)
 kill @ary
"RTN","SAMICAS3",838,0)
 ;
"RTN","SAMICAS3",839,0)
 set @ary@("siform","form")="siform"
"RTN","SAMICAS3",840,0)
 set @ary@("siform","js")="subPr"
"RTN","SAMICAS3",841,0)
 set @ary@("siform","name")="Intake"
"RTN","SAMICAS3",842,0)
 set @ary@("siform","image")="preview.gif"
"RTN","SAMICAS3",843,0)
 ;
"RTN","SAMICAS3",844,0)
 set @ary@("nuform","form")="nuform"
"RTN","SAMICAS3",845,0)
 set @ary@("nuform","js")="subFr"
"RTN","SAMICAS3",846,0)
 set @ary@("nuform","name")="New Form"
"RTN","SAMICAS3",847,0)
 set @ary@("nuform","image")="nform.gif"
"RTN","SAMICAS3",848,0)
 ;
"RTN","SAMICAS3",849,0)
 set @ary@("sched","form")="sched"
"RTN","SAMICAS3",850,0)
 set @ary@("sched","js")="subSc"
"RTN","SAMICAS3",851,0)
 set @ary@("sched","name")="Schedule"
"RTN","SAMICAS3",852,0)
 set @ary@("sched","image")="schedule.gif"
"RTN","SAMICAS3",853,0)
 ;
"RTN","SAMICAS3",854,0)
 set @ary@("sbform","form")="sbform"
"RTN","SAMICAS3",855,0)
 set @ary@("sbform","js")="subPr"
"RTN","SAMICAS3",856,0)
 set @ary@("sbform","name")="Background"
"RTN","SAMICAS3",857,0)
 set @ary@("sbform","image")="preview.gif"
"RTN","SAMICAS3",858,0)
 ;
"RTN","SAMICAS3",859,0)
 set @ary@("ceform","form")="ceform"
"RTN","SAMICAS3",860,0)
 set @ary@("ceform","js")="subPr"
"RTN","SAMICAS3",861,0)
 set @ary@("ceform","name")="CT Evaluation"
"RTN","SAMICAS3",862,0)
 set @ary@("ceform","image")="preview.gif"
"RTN","SAMICAS3",863,0)
 ;
"RTN","SAMICAS3",864,0)
 set @ary@("report","form")="report"
"RTN","SAMICAS3",865,0)
 set @ary@("report","js")="subRp"
"RTN","SAMICAS3",866,0)
 set @ary@("report","name")="Report"
"RTN","SAMICAS3",867,0)
 set @ary@("report","image")="report.gif"
"RTN","SAMICAS3",868,0)
 ;
"RTN","SAMICAS3",869,0)
 set @ary@("ptform","form")="ptform"
"RTN","SAMICAS3",870,0)
 set @ary@("ptform","js")="subPr"
"RTN","SAMICAS3",871,0)
 set @ary@("ptform","name")="PET Evaluation"
"RTN","SAMICAS3",872,0)
 set @ary@("ptform","image")="preview.gif"
"RTN","SAMICAS3",873,0)
 ;
"RTN","SAMICAS3",874,0)
 set @ary@("bxform","form")="bxform"
"RTN","SAMICAS3",875,0)
 set @ary@("bxform","js")="subPr"
"RTN","SAMICAS3",876,0)
 set @ary@("bxform","name")="Biopsy"
"RTN","SAMICAS3",877,0)
 set @ary@("bxform","image")="preview.gif"
"RTN","SAMICAS3",878,0)
 ;
"RTN","SAMICAS3",879,0)
 set @ary@("rbform","form")="rbform"
"RTN","SAMICAS3",880,0)
 set @ary@("rbform","js")="subPr"
"RTN","SAMICAS3",881,0)
 set @ary@("rbform","name")="Intervention"
"RTN","SAMICAS3",882,0)
 set @ary@("rbform","image")="preview.gif"
"RTN","SAMICAS3",883,0)
 ;
"RTN","SAMICAS3",884,0)
 set @ary@("ceform","form")="ceform"
"RTN","SAMICAS3",885,0)
 set @ary@("ceform","js")="subPr"
"RTN","SAMICAS3",886,0)
 set @ary@("ceform","name")="CT Evaluation"
"RTN","SAMICAS3",887,0)
 set @ary@("ceform","image")="preview.gif"
"RTN","SAMICAS3",888,0)
 ;
"RTN","SAMICAS3",889,0)
 ;
"RTN","SAMICAS3",890,0)
 ;@stanza 3 termination
"RTN","SAMICAS3",891,0)
 ;
"RTN","SAMICAS3",892,0)
 quit  ; end of CASETBL
"RTN","SAMICAS3",893,0)
 ;
"RTN","SAMICAS3",894,0)
 ;
"RTN","SAMICAS3",895,0)
 ;
"RTN","SAMICAS3",896,0)
EOR ; end of routine SAMICAS3
"RTN","SAMICASE")
0^3^B2476673
"RTN","SAMICASE",1,0)
SAMICASE ;ven/gpl - case review library ;2021-07-06T15:44Z
"RTN","SAMICASE",2,0)
 ;;18.0;SAMI;**1,12**;2020-01;Build 6
"RTN","SAMICASE",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMICASE",4,0)
 ;
"RTN","SAMICASE",5,0)
 ; SAMICASE contains ppis and other services to support processing
"RTN","SAMICASE",6,0)
 ; of the VAPALS-IELCAP case review page.
"RTN","SAMICASE",7,0)
 ;
"RTN","SAMICASE",8,0)
 quit  ; no entry from top
"RTN","SAMICASE",9,0)
 ;
"RTN","SAMICASE",10,0)
 ;
"RTN","SAMICASE",11,0)
 ;
"RTN","SAMICASE",12,0)
 ;@section 0 primary development
"RTN","SAMICASE",13,0)
 ;
"RTN","SAMICASE",14,0)
 ;
"RTN","SAMICASE",15,0)
 ;
"RTN","SAMICASE",16,0)
 ;@license see routine SAMIUL
"RTN","SAMICASE",17,0)
 ;@documentation see SAMICUL
"RTN","SAMICASE",18,0)
 ;@contents
"RTN","SAMICASE",19,0)
 ; (all public interfaces)
"RTN","SAMICASE",20,0)
 ; 
"RTN","SAMICASE",21,0)
 ;
"RTN","SAMICASE",22,0)
 ;
"RTN","SAMICASE",23,0)
 ;@section 1 web-route interfaces
"RTN","SAMICASE",24,0)
 ;
"RTN","SAMICASE",25,0)
 ;
"RTN","SAMICASE",26,0)
 ;
"RTN","SAMICASE",27,0)
 ;@wri WSCASE^SAMICASE, post vapals casereview: generate case review page
"RTN","SAMICASE",28,0)
WSCASE(rtn,filter) goto WSCASE^SAMICAS2
"RTN","SAMICASE",29,0)
 ;
"RTN","SAMICASE",30,0)
 ;
"RTN","SAMICASE",31,0)
 ;
"RTN","SAMICASE",32,0)
 ;@wri WSNUFORM^SAMICASE, post vapals nuform: new form for patient
"RTN","SAMICASE",33,0)
WSNUFORM(rtn,filter) goto WSNUFORM^SAMICAS2
"RTN","SAMICASE",34,0)
 ;
"RTN","SAMICASE",35,0)
 ;
"RTN","SAMICASE",36,0)
 ;
"RTN","SAMICASE",37,0)
 ;@wri DELFORM^SAMICASE, post vapals deleteform: delete incomplete form
"RTN","SAMICASE",38,0)
DELFORM(RESULT,ARGS) goto DELFORM^SAMICAS2
"RTN","SAMICASE",39,0)
 ;
"RTN","SAMICASE",40,0)
 ;
"RTN","SAMICASE",41,0)
 ;
"RTN","SAMICASE",42,0)
 ;@wri WSNFPOST^SAMICASE, post vapals addform: new form
"RTN","SAMICASE",43,0)
WSNFPOST(ARGS,BODY,RESULT) goto WSNFPOST^SAMICAS3
"RTN","SAMICASE",44,0)
 ;
"RTN","SAMICASE",45,0)
 ;
"RTN","SAMICASE",46,0)
 ;
"RTN","SAMICASE",47,0)
 ;@section 2 private program interfaces
"RTN","SAMICASE",48,0)
 ;
"RTN","SAMICASE",49,0)
 ;
"RTN","SAMICASE",50,0)
 ;
"RTN","SAMICASE",51,0)
 ;@ppi GETTMPL^SAMICASE, get html template
"RTN","SAMICASE",52,0)
GETTMPL(return,form) goto GETTMPL^SAMICAS2
"RTN","SAMICASE",53,0)
 ;
"RTN","SAMICASE",54,0)
 ;
"RTN","SAMICASE",55,0)
 ;
"RTN","SAMICASE",56,0)
 ;@ppi GETITEMS^SAMICASE, get items available for studyid
"RTN","SAMICASE",57,0)
GETITEMS(ary,sid) goto GETITEMS^SAMICAS2
"RTN","SAMICASE",58,0)
 ;
"RTN","SAMICASE",59,0)
 ;
"RTN","SAMICASE",60,0)
 ;
"RTN","SAMICASE",61,0)
 ;@ppi $$NOTEHREF^SAMICASE, html list of notes for form
"RTN","SAMICASE",62,0)
NOTEHREF(sid,form) goto NOTEHREF^SAMICAS2
"RTN","SAMICASE",63,0)
 ;
"RTN","SAMICASE",64,0)
 ;
"RTN","SAMICASE",65,0)
 ;
"RTN","SAMICASE",66,0)
 ;@ppi $$VAPALSDT^SAMICASE, date in vapals format
"RTN","SAMICASE",67,0)
VAPALSDT(fmdate) goto VAPALSDT^SAMICAS2
"RTN","SAMICASE",68,0)
 ;
"RTN","SAMICASE",69,0)
 ;
"RTN","SAMICASE",70,0)
 ;
"RTN","SAMICASE",71,0)
 ;@ppi $$KEY2FM^SAMICASE, convert key to fileman date
"RTN","SAMICASE",72,0)
KEY2FM(key) goto KEY2FM^SAMICAS2
"RTN","SAMICASE",73,0)
 ;
"RTN","SAMICASE",74,0)
 ;
"RTN","SAMICASE",75,0)
 ;
"RTN","SAMICASE",76,0)
 ;@ppi SSAMISTA^SAMICASE, set samistatus to val in form
"RTN","SAMICASE",77,0)
SSAMISTA(sid,form,val) goto SSAMISTA^SAMICAS2
"RTN","SAMICASE",78,0)
 ;
"RTN","SAMICASE",79,0)
 ;
"RTN","SAMICASE",80,0)
 ;
"RTN","SAMICASE",81,0)
EOR ; end of routine SAMICASE
"RTN","SAMICLOG")
0^4^B37383898
"RTN","SAMICLOG",1,0)
SAMICLOG ;ven/gpl - intake form change log ;2021-07-01t16:28z
"RTN","SAMICLOG",2,0)
 ;;18.0;SAMI;**12**;2020-01;Build 6
"RTN","SAMICLOG",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMICLOG",4,0)
 ;
"RTN","SAMICLOG",5,0)
 ; Routine SAMICLOG contains subroutines for implementing the VAPALS-
"RTN","SAMICLOG",6,0)
 ; ELCAP Intake Form's Change Log field.
"RTN","SAMICLOG",7,0)
 ;
"RTN","SAMICLOG",8,0)
 quit  ; no entry from top
"RTN","SAMICLOG",9,0)
 ;
"RTN","SAMICLOG",10,0)
 ;
"RTN","SAMICLOG",11,0)
 ;
"RTN","SAMICLOG",12,0)
 ;@section 0 primary development
"RTN","SAMICLOG",13,0)
 ;
"RTN","SAMICLOG",14,0)
 ;
"RTN","SAMICLOG",15,0)
 ;
"RTN","SAMICLOG",16,0)
 ;@routine-credits
"RTN","SAMICLOG",17,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMICLOG",18,0)
 ; gpl@vistaexpertise.net
"RTN","SAMICLOG",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMICLOG",20,0)
 ; http://vistaexpertise.net
"RTN","SAMICLOG",21,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMICLOG",22,0)
 ;@license see routine SAMIUL
"RTN","SAMICLOG",23,0)
 ;
"RTN","SAMICLOG",24,0)
 ;@last-updated 2021-07-01t16:28z
"RTN","SAMICLOG",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMICLOG",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMICLOG",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMICLOG",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMICLOG",29,0)
 ;@release-date 2020-01
"RTN","SAMICLOG",30,0)
 ;@patch-list **12**
"RTN","SAMICLOG",31,0)
 ;
"RTN","SAMICLOG",32,0)
 ;@additional-dev Larry G. Carlson (lgc)
"RTN","SAMICLOG",33,0)
 ; lgc@vistaexpertise.net
"RTN","SAMICLOG",34,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMICLOG",35,0)
 ; toad@vistaexpertise.net
"RTN","SAMICLOG",36,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMICLOG",37,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMICLOG",38,0)
 ;
"RTN","SAMICLOG",39,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMICLOG",40,0)
 ; 2019-03-20 ven/gpl 1.18.0-t4 e1e7c136
"RTN","SAMICLOG",41,0)
 ;  SAMICLOG progress on intake form change log.
"RTN","SAMICLOG",42,0)
 ;
"RTN","SAMICLOG",43,0)
 ; 2019-03-25/26 ven/lgc 1.18.0-t4 12ab8234,b9a71a56,e0106403,fb73dfe5
"RTN","SAMICLOG",44,0)
 ;  SAMICLOG update change log & tests, repair var name, inhibit
"RTN","SAMICLOG",45,0)
 ; change log during 1st entry.
"RTN","SAMICLOG",46,0)
 ;
"RTN","SAMICLOG",47,0)
 ; 2019-08-03 ven/gpl 1.18.0-t4 bea65f7b
"RTN","SAMICLOG",48,0)
 ;  SAMICLOG fix bugs in Have you ever smoked processing in change log
"RTN","SAMICLOG",49,0)
 ; & intake note.
"RTN","SAMICLOG",50,0)
 ;
"RTN","SAMICLOG",51,0)
 ; 2021-06-18 ven/gpl 1.18.0.12-t2+i12 68ebd6fa
"RTN","SAMICLOG",52,0)
 ;  SAMICLOG fix crash in processing text field for change log: in
"RTN","SAMICLOG",53,0)
 ; DOLOGIT add screens if "field","C",var node undefined.
"RTN","SAMICLOG",54,0)
 ;
"RTN","SAMICLOG",55,0)
 ; 2021-07-01 ven/mcglk&toad 1.18.0.12-t2+i12 cbf7e46b
"RTN","SAMICLOG",56,0)
 ;  SAMICLOG bump version & dates, add hdr comments & dev log.
"RTN","SAMICLOG",57,0)
 ;
"RTN","SAMICLOG",58,0)
 ;@contents
"RTN","SAMICLOG",59,0)
 ; CLOG adds to the intake form change log
"RTN","SAMICLOG",60,0)
 ; RUNVARS ???
"RTN","SAMICLOG",61,0)
 ; DOLOGIT ???
"RTN","SAMICLOG",62,0)
 ; LOGIT add an entry to the log
"RTN","SAMICLOG",63,0)
 ; INTKVARS variables on intake form
"RTN","SAMICLOG",64,0)
 ;
"RTN","SAMICLOG",65,0)
 ;
"RTN","SAMICLOG",66,0)
 ;
"RTN","SAMICLOG",67,0)
 ;@section 1 subroutines
"RTN","SAMICLOG",68,0)
 ;
"RTN","SAMICLOG",69,0)
 ;
"RTN","SAMICLOG",70,0)
 ;
"RTN","SAMICLOG",71,0)
CLOG(sid,form,vars) ; adds to the intake form change log 
"RTN","SAMICLOG",72,0)
 ; if changes have been made
"RTN","SAMICLOG",73,0)
 ;
"RTN","SAMICLOG",74,0)
 n root,CLOGROOT,var
"RTN","SAMICLOG",75,0)
 s root=$$setroot^%wd("vapals-patients")
"RTN","SAMICLOG",76,0)
 ;
"RTN","SAMICLOG",77,0)
 ;If samifirsttime is true, then this is the first submission
"RTN","SAMICLOG",78,0)
 ;  for the intake form and we will not need to check
"RTN","SAMICLOG",79,0)
 ;  for changes
"RTN","SAMICLOG",80,0)
 q:($g(@root@("graph",sid,form,"samifirsttime"))="true")
"RTN","SAMICLOG",81,0)
 ;
"RTN","SAMICLOG",82,0)
 s CLOGROOT=$na(@root@("graph",sid,form,"changelog"))
"RTN","SAMICLOG",83,0)
 ;
"RTN","SAMICLOG",84,0)
 n old
"RTN","SAMICLOG",85,0)
 s old=$na(@root@("graph",sid,form)) ; location of saved old variables
"RTN","SAMICLOG",86,0)
 ;
"RTN","SAMICLOG",87,0)
 ; date of contact
"RTN","SAMICLOG",88,0)
 ;
"RTN","SAMICLOG",89,0)
 n ndoc,odoc
"RTN","SAMICLOG",90,0)
 s ndoc=$g(@vars@("sidc"))
"RTN","SAMICLOG",91,0)
 s odoc=$g(@old@("sidc"))
"RTN","SAMICLOG",92,0)
 if ndoc'=odoc d  ;
"RTN","SAMICLOG",93,0)
 . n entry s entry="Date of contact changed from "_odoc_" to "_ndoc
"RTN","SAMICLOG",94,0)
 . d LOGIT(CLOGROOT,entry)
"RTN","SAMICLOG",95,0)
 ;
"RTN","SAMICLOG",96,0)
 ; contacted via
"RTN","SAMICLOG",97,0)
 ;
"RTN","SAMICLOG",98,0)
 n ovia,nvia,zg
"RTN","SAMICLOG",99,0)
 s (ovia,nvia)=""
"RTN","SAMICLOG",100,0)
 f zg="ovia","nvia" d  ;
"RTN","SAMICLOG",101,0)
 . n zn
"RTN","SAMICLOG",102,0)
 . if zg="ovia" s zn=old
"RTN","SAMICLOG",103,0)
 . if zg="nvia" s zn=vars
"RTN","SAMICLOG",104,0)
 . i $g(@zn@("silnip"))=1 d  ;
"RTN","SAMICLOG",105,0)
 . . s @zg="in person"
"RTN","SAMICLOG",106,0)
 . i $g(@zn@("silnph"))=1 d  ;
"RTN","SAMICLOG",107,0)
 . . s @zg=$s(@zg'="":@zg_",",1:@zg)_" telephone"
"RTN","SAMICLOG",108,0)
 . i $g(@zn@("silnth"))=1 d  ;
"RTN","SAMICLOG",109,0)
 . . s @zg=$s(@zg'="":@zg_",",1:@zg)_" telehealth"
"RTN","SAMICLOG",110,0)
 . i $g(@zn@("silnml"))=1 d  ;
"RTN","SAMICLOG",111,0)
 . . s @zg=$s(@zg'="":@zg_",",1:@zg)_" mailed letter"
"RTN","SAMICLOG",112,0)
 . i $g(@zn@("silnpp"))=1 d  ;
"RTN","SAMICLOG",113,0)
 . . s @zg=$s(@zg'="":@zg_",",1:@zg)_" patient portal"
"RTN","SAMICLOG",114,0)
 . i $g(@zn@("silnvd"))=1 d  ;
"RTN","SAMICLOG",115,0)
 . . s @zg=$s(@zg'="":@zg_",",1:@zg)_" VOD"
"RTN","SAMICLOG",116,0)
 . i $g(@zn@("silnot"))=1 d  ;
"RTN","SAMICLOG",117,0)
 . . s @zg=$s(@zg'="":@zg_",",1:@zg)_" Other contact method YN"
"RTN","SAMICLOG",118,0)
 s ovia=$s(ovia="":"null",1:ovia)
"RTN","SAMICLOG",119,0)
 s nvia=$s(nvia="":"null",1:nvia)
"RTN","SAMICLOG",120,0)
 i ovia'=nvia d  ;
"RTN","SAMICLOG",121,0)
 . d LOGIT(CLOGROOT,"Contacted via changed from "_ovia_" to "_nvia)
"RTN","SAMICLOG",122,0)
 ;
"RTN","SAMICLOG",123,0)
 ;
"RTN","SAMICLOG",124,0)
 ;
"RTN","SAMICLOG",125,0)
RUNVARS n cnt s cnt=0
"RTN","SAMICLOG",126,0)
 f  s cnt=cnt+1 s var=$p($t(INTKVARS+cnt),";;",2) q:(var="")  d
"RTN","SAMICLOG",127,0)
 . s var=$p($p($t(INTKVARS+cnt),";;",2),"^")
"RTN","SAMICLOG",128,0)
 . s entry=$p($p($t(INTKVARS+cnt),";;",2),"^",2)_" changed from "
"RTN","SAMICLOG",129,0)
 . d DOLOGIT(.vars,.old,var,entry)
"RTN","SAMICLOG",130,0)
 q
"RTN","SAMICLOG",131,0)
 ;
"RTN","SAMICLOG",132,0)
 ;
"RTN","SAMICLOG",133,0)
 ;
"RTN","SAMICLOG",134,0)
DOLOGIT(vars,old,var,entry) ;
"RTN","SAMICLOG",135,0)
 ;Input
"RTN","SAMICLOG",136,0)
 ;   vars   = name of array with new results (e.g. poo("sildct")=1)
"RTN","SAMICLOG",137,0)
 ;   old    = $na(@root@("graph",sid,form)) ; location of saved old variables
"RTN","SAMICLOG",138,0)
 ;   var    = name of VAPALS variable whose value changed (e.g. sildct)
"RTN","SAMICLOG",139,0)
 ;   entry  = prompt for entering value (e.g. Patient opted to)
"RTN","SAMICLOG",140,0)
 ;Exit
"RTN","SAMICLOG",141,0)
 ;   sets new "changelog" node in vapals-patients graphstore documenting
"RTN","SAMICLOG",142,0)
 ;
"RTN","SAMICLOG",143,0)
 n rootdd s rootdd=$$setroot^%wd("form fields - intake")
"RTN","SAMICLOG",144,0)
 n newval,oldval,nvtrans,ovtrans
"RTN","SAMICLOG",145,0)
 s newval=$g(@vars@(var)) i '(newval="") d
"RTN","SAMICLOG",146,0)
 . q:'$d(@rootdd@("field","C",var))
"RTN","SAMICLOG",147,0)
 . s nvtrans=$o(@rootdd@("field","C",var,newval,""))
"RTN","SAMICLOG",148,0)
 . s:'(nvtrans="") newval=nvtrans
"RTN","SAMICLOG",149,0)
 s:(newval="") newval="null"
"RTN","SAMICLOG",150,0)
 s oldval=$g(@old@(var)) i '(oldval="") d
"RTN","SAMICLOG",151,0)
 . q:'$d(@rootdd@("field","C",var))
"RTN","SAMICLOG",152,0)
 . s ovtrans=$o(@rootdd@("field","C",var,oldval,""))
"RTN","SAMICLOG",153,0)
 . s:'(ovtrans="") oldval=ovtrans
"RTN","SAMICLOG",154,0)
 s:(oldval="") oldval="null"
"RTN","SAMICLOG",155,0)
 q:(newval=oldval)
"RTN","SAMICLOG",156,0)
 s entry=entry_oldval_" to: "_newval
"RTN","SAMICLOG",157,0)
 d LOGIT(CLOGROOT,entry)
"RTN","SAMICLOG",158,0)
 q
"RTN","SAMICLOG",159,0)
 ;
"RTN","SAMICLOG",160,0)
 ;
"RTN","SAMICLOG",161,0)
 ;
"RTN","SAMICLOG",162,0)
LOGIT(CLOGROOT,ENTRY) ; add an entry to the log
"RTN","SAMICLOG",163,0)
 ; CLOGROOT points to the log
"RTN","SAMICLOG",164,0)
 ;
"RTN","SAMICLOG",165,0)
 n logdt
"RTN","SAMICLOG",166,0)
 ;s logdt=$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMICLOG",167,0)
 s logdt=$$FMTE^XLFDT($$NOW^XLFDT,5)
"RTN","SAMICLOG",168,0)
 n lien
"RTN","SAMICLOG",169,0)
 s lien=$o(@CLOGROOT@(""),-1)+1
"RTN","SAMICLOG",170,0)
 s @CLOGROOT@(lien)="["_logdt_"] "_$g(ENTRY)
"RTN","SAMICLOG",171,0)
 q
"RTN","SAMICLOG",172,0)
 ;
"RTN","SAMICLOG",173,0)
 ;
"RTN","SAMICLOG",174,0)
 ;
"RTN","SAMICLOG",175,0)
INTKVARS ; Varibles on intake form
"RTN","SAMICLOG",176,0)
 ;;silnoo^Other contact method
"RTN","SAMICLOG",177,0)
 ;;sipav^Primary address verified
"RTN","SAMICLOG",178,0)
 ;;sipsa^Preferred address
"RTN","SAMICLOG",179,0)
 ;;sipan^Apt#
"RTN","SAMICLOG",180,0)
 ;;spicn^County
"RTN","SAMICLOG",181,0)
 ;;sipc^City
"RTN","SAMICLOG",182,0)
 ;;sips^State
"RTN","SAMICLOG",183,0)
 ;;sipz^Zip
"RTN","SAMICLOG",184,0)
 ;;sipcr^Country
"RTN","SAMICLOG",185,0)
 ;;sippn^Phone number
"RTN","SAMICLOG",186,0)
 ;;sirs^Rural status
"RTN","SAMICLOG",187,0)
 ;;siesm^Have you ever smoked
"RTN","SAMICLOG",188,0)
 ;;siesq^Willing to quit smoking
"RTN","SAMICLOG",189,0)
 ;;sicpd^Cigarettes per day
"RTN","SAMICLOG",190,0)
 ;;sisny^Number of years a smoker
"RTN","SAMICLOG",191,0)
 ;;siq^Date quit smoking
"RTN","SAMICLOG",192,0)
 ;;sicep^Smoking cessation education provided
"RTN","SAMICLOG",193,0)
 ;;siadx^Lung CA Dx date
"RTN","SAMICLOG",194,0)
 ;;siadxl^Lung CA Dx location not VA
"RTN","SAMICLOG",195,0)
 ;;siptct^CT date
"RTN","SAMICLOG",196,0)
 ;;siptctl^CT location not VA
"RTN","SAMICLOG",197,0)
 ;;siidmdc^Informed decision making discussion complete
"RTN","SAMICLOG",198,0)
 ;;sildct^Patient opted to
"RTN","SAMICLOG",199,0)
 ;;siclin^Clinical idications for screening
"RTN","SAMICLOG",200,0)
 ;;sistatus^Enrollment status
"RTN","SAMICLOG",201,0)
 ;;
"RTN","SAMICLOG",202,0)
 ;
"RTN","SAMICLOG",203,0)
 ;
"RTN","SAMICLOG",204,0)
 ;
"RTN","SAMICLOG",205,0)
EOR ; end of routine SAMICLOG
"RTN","SAMICUL")
0^5^B144065
"RTN","SAMICUL",1,0)
SAMICUL ;ven/gpl - case review log ;2021-07-06t15:44z
"RTN","SAMICUL",2,0)
 ;;18.0;SAMI;**9,11,12**;2020-01;Build 6
"RTN","SAMICUL",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMICUL",4,0)
 ;
"RTN","SAMICUL",5,0)
 ; SAMICUL contains the development log for the VAPALS-IELCAP Case
"RTN","SAMICUL",6,0)
 ; Review Page (SAMICA* routines).
"RTN","SAMICUL",7,0)
 ; It contains no executable code.
"RTN","SAMICUL",8,0)
 ;
"RTN","SAMICUL",9,0)
 quit  ; no entry from top
"RTN","SAMICUL",10,0)
 ;
"RTN","SAMICUL",11,0)
 ;
"RTN","SAMICUL",12,0)
 ;
"RTN","SAMICUL",13,0)
 ;@section 0 primary development
"RTN","SAMICUL",14,0)
 ;
"RTN","SAMICUL",15,0)
 ;
"RTN","SAMICUL",16,0)
 ;
"RTN","SAMICUL",17,0)
 ;@routine-credits
"RTN","SAMICUL",18,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMICUL",19,0)
 ; gpl@vistaexpertise.net
"RTN","SAMICUL",20,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMICUL",21,0)
 ; http://vistaexpertise.net
"RTN","SAMICUL",22,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMICUL",23,0)
 ;@license see routine SAMIUL
"RTN","SAMICUL",24,0)
 ;
"RTN","SAMICUL",25,0)
 ;@last-updated 2021-07-06t15:44z
"RTN","SAMICUL",26,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMICUL",27,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMICUL",28,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMICUL",29,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMICUL",30,0)
 ;@release-date 2020-01
"RTN","SAMICUL",31,0)
 ;@patch-list **9,11,12**
"RTN","SAMICUL",32,0)
 ;
"RTN","SAMICUL",33,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMICUL",34,0)
 ; toad@vistaexpertise.net
"RTN","SAMICUL",35,0)
 ;@additional-dev Linda M. R. Yaw (lmry)
"RTN","SAMICUL",36,0)
 ; linda.yaw@vistaexpertise.net
"RTN","SAMICUL",37,0)
 ;@additional-dev Larry G. Carlson (lgc)
"RTN","SAMICUL",38,0)
 ; larry.g.carlson@gmail.com
"RTN","SAMICUL",39,0)
 ;@additional-dev Domenick DiNatale (ddn)
"RTN","SAMICUL",40,0)
 ; domenic@intellitechinnovations.com
"RTN","SAMICUL",41,0)
 ;@additional-dev Kenneth McGlothlen (mcglk)
"RTN","SAMICUL",42,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMICUL",43,0)
 ;
"RTN","SAMICUL",44,0)
 ;@module-credits
"RTN","SAMICUL",45,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMICUL",46,0)
 ; (VA-PALS)
"RTN","SAMICUL",47,0)
 ; http://va-pals.org/
"RTN","SAMICUL",48,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMICUL",49,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMICUL",50,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMICUL",51,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMICUL",52,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMICUL",53,0)
 ; http://ielcap.com/
"RTN","SAMICUL",54,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMICUL",55,0)
 ; http://paraxialtech.com/
"RTN","SAMICUL",56,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMICUL",57,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMICUL",58,0)
 ;
"RTN","SAMICUL",59,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMICUL",60,0)
 ;
"RTN","SAMICUL",61,0)
 ; 2018-01-14 ven/gpl 1.18.0-t04
"RTN","SAMICUL",62,0)
 ;  SAMICASE split from routine SAMIFRM, incl wsCASE,GETTMPL,GETITEMS,
"RTN","SAMICUL",63,0)
 ; casetbl.
"RTN","SAMICUL",64,0)
 ;
"RTN","SAMICUL",65,0)
 ; 2018-02-05/08 ven/toad 1.18.0-t04
"RTN","SAMICUL",66,0)
 ;  SAMICASE update style, license, & attribution, spell out language
"RTN","SAMICUL",67,0)
 ; elements, add white space & do-dot quits, r/replaceAll^%wfhfrom w/
"RTN","SAMICUL",68,0)
 ; replaceAll^%wf, r/$$getTemplate^%wfhform w/$$getTemplate^%wf.
"RTN","SAMICUL",69,0)
 ;
"RTN","SAMICUL",70,0)
 ; 2018-02-14 ven/toad 1.18.0-t04
"RTN","SAMICUL",71,0)
 ;  SAMICASE r/replaceAll^%wf w/findReplaceAll^%wf, r/ln w/line, add
"RTN","SAMICUL",72,0)
 ; @calls & @called-by tags, break up some long lines.
"RTN","SAMICUL",73,0)
 ;
"RTN","SAMICUL",74,0)
 ; 2018-02-27 ven/gpl 1.18.0-t04
"RTN","SAMICUL",75,0)
 ;  SAMICASE new subroutines $$KEY2DSPD, $$GETDTKEY; in wsCASE get
"RTN","SAMICUL",76,0)
 ; 1st & last names from graph, fix paths, key forms in graph w/date.
"RTN","SAMICUL",77,0)
 ;
"RTN","SAMICUL",78,0)
 ; 2018-03-01 ven/toad 1.18.0-t04
"RTN","SAMICUL",79,0)
 ;  SAMICASE refactor & reorganize new code, add header comments, r/
"RTN","SAMICUL",80,0)
 ; findReplaceAll^%wf w/findReplace^%ts.
"RTN","SAMICUL",81,0)
 ;
"RTN","SAMICUL",82,0)
 ; 2018-03-06 ven/gpl 1.18.0-t04
"RTN","SAMICUL",83,0)
 ;  SAMICASE add New Form button, list rest of forms for patient, add
"RTN","SAMICUL",84,0)
 ; web services wsNuForm & wsNuFormPost & method MKCEFORM, extend
"RTN","SAMICUL",85,0)
 ; GETITEMS to get rest of forms.
"RTN","SAMICUL",86,0)
 ;
"RTN","SAMICUL",87,0)
 ; 2018-03-07/08 ven/toad 1.18.0-t04
"RTN","SAMICUL",88,0)
 ;  SAMICASE merge George changes w/ rest, add white space, spell out
"RTN","SAMICUL",89,0)
 ; M elements, add hdr comments to new subroutines, r/findReplace^%wf
"RTN","SAMICUL",90,0)
 ; & replaceAll^%wf w/findReplace^%ts.
"RTN","SAMICUL",91,0)
 ;
"RTN","SAMICUL",92,0)
 ; 2018-03-11 ven/gpl 1.18.0-t04 9bd663ee
"RTN","SAMICUL",93,0)
 ;  SAMICAS2 vapals forms working.
"RTN","SAMICUL",94,0)
 ;
"RTN","SAMICUL",95,0)
 ; 2018-03-12 ven/gpl 1.18.0-t04 8c36c6a7
"RTN","SAMICUL",96,0)
 ;  SAMICAS2 new form works now & charts on home page.
"RTN","SAMICUL",97,0)
 ;
"RTN","SAMICUL",98,0)
 ; 2018-03-14 ven/gpl 1.18.0-t04 9653650a
"RTN","SAMICUL",99,0)
 ;  SAMICAS2 revised casereview page link, fixed external url
"RTN","SAMICUL",100,0)
 ; preservation.
"RTN","SAMICUL",101,0)
 ;
"RTN","SAMICUL",102,0)
 ; 2018-03-21 ven/gpl 1.18.0-t04 48868561
"RTN","SAMICUL",103,0)
 ;  SAMICAS2 max date insertion, case review navigation changed to
"RTN","SAMICUL",104,0)
 ; post, date order for CT Eval in case review.
"RTN","SAMICUL",105,0)
 ;
"RTN","SAMICUL",106,0)
 ; 2018-03-26 ven/gpl 1.18.0-t04 5fa4ee96
"RTN","SAMICUL",107,0)
 ;  SAMICAS2 changes to support incomplete forms display &
"RTN","SAMICUL",108,0)
 ; processing.
"RTN","SAMICUL",109,0)
 ;
"RTN","SAMICUL",110,0)
 ; 2018-03-27 ven/gpl 1.18.0-t04 cace9756
"RTN","SAMICUL",111,0)
 ;  SAMICAS2 siforms are always complete.
"RTN","SAMICUL",112,0)
 ;
"RTN","SAMICUL",113,0)
 ; 2018-04-02 ven/gpl 1.18.0-t04 00da9146
"RTN","SAMICUL",114,0)
 ;  SAMICAS2 added followup form.
"RTN","SAMICUL",115,0)
 ;
"RTN","SAMICUL",116,0)
 ; 2018-04-24 ven/gpl 1.18.0-t04 22e39d87
"RTN","SAMICUL",117,0)
 ;  SAMICAS2 added pet & biopsy forms.
"RTN","SAMICUL",118,0)
 ;
"RTN","SAMICUL",119,0)
 ; 2018-05-01 ven/gpl 1.18.0-t04 f1751c43
"RTN","SAMICUL",120,0)
 ;  SAMICAS2 fix problem with new forms: followup & pet.
"RTN","SAMICUL",121,0)
 ;
"RTN","SAMICUL",122,0)
 ; 2018-05-18 ven/lgc 1.18.0-t04 9eba8f8c
"RTN","SAMICUL",123,0)
 ;  SAMICAS2 conversion to new graph and simplified forms processing.
"RTN","SAMICUL",124,0)
 ;
"RTN","SAMICUL",125,0)
 ; 2018-05-21 ven/lgc 1.18.0-t04 0d7ed2f7
"RTN","SAMICUL",126,0)
 ;  SAMICAS2 changes for new navigation html.
"RTN","SAMICUL",127,0)
 ;
"RTN","SAMICUL",128,0)
 ; 2018-06-14 ven/lgc 1.18.0-t04 d71f4fe4
"RTN","SAMICUL",129,0)
 ;  SAMICAS2 changes to make the background form optional.
"RTN","SAMICUL",130,0)
 ;
"RTN","SAMICUL",131,0)
 ; 2018-06-20 ven/lgc 1.18.0-t04 bf03b07f
"RTN","SAMICUL",132,0)
 ;  SAMICAS2 corrections for new forms processing navigation.
"RTN","SAMICUL",133,0)
 ;
"RTN","SAMICUL",134,0)
 ; 2018-07-01 ven/lgc 1.18.0-t04 2e1541dc,8b0a4329
"RTN","SAMICUL",135,0)
 ;  SAMICAS2 add intervention forms to case review page, 1st version
"RTN","SAMICUL",136,0)
 ; of ct eval report.
"RTN","SAMICUL",137,0)
 ;
"RTN","SAMICUL",138,0)
 ; 2018-07-04 ven/lgc 1.18.0-t04 b28c1658
"RTN","SAMICUL",139,0)
 ;  SAMICAS2 fix a typo.
"RTN","SAMICUL",140,0)
 ;
"RTN","SAMICUL",141,0)
 ; 2018-07-10 ven/lgc 1.18.0-t04 2e9662b4
"RTN","SAMICUL",142,0)
 ;  SAMICAS2 repair SAMIHOM3 & redact report link.
"RTN","SAMICUL",143,0)
 ;
"RTN","SAMICUL",144,0)
 ; 2018-08-19 ven/lgc 1.18.0-t04 2ce0cab4
"RTN","SAMICUL",145,0)
 ;  SAMICAS2 use ssn instead of last5 where available.
"RTN","SAMICUL",146,0)
 ;
"RTN","SAMICUL",147,0)
 ; 2018-08-20 ven/lgc 1.18.0-t04 955fd484
"RTN","SAMICUL",148,0)
 ;  SAMICAS2 fix case review page cr lf issue.
"RTN","SAMICUL",149,0)
 ;
"RTN","SAMICUL",150,0)
 ; 2018-08-22 ven/gpl 1.18.0-t04 d67a2fe5
"RTN","SAMICUL",151,0)
 ;  SAMICAS2 turn off ctreport.
"RTN","SAMICUL",152,0)
 ;
"RTN","SAMICUL",153,0)
 ; 2018-08-30 ven/lgc 1.18.0-t04 125f1c8b
"RTN","SAMICUL",154,0)
 ;  SAMICAS2 add type index to getItems to help find last previous
"RTN","SAMICUL",155,0)
 ; form of a type.
"RTN","SAMICUL",156,0)
 ;
"RTN","SAMICUL",157,0)
 ; 2018-09-04 ven/lgc 1.18.0-t04 3e6e326f
"RTN","SAMICUL",158,0)
 ;  SAMICAS2 hide report link.
"RTN","SAMICUL",159,0)
 ;
"RTN","SAMICUL",160,0)
 ; 2018-10-14 ven/lgc 1.18.0-t04 f6e1229f
"RTN","SAMICUL",161,0)
 ;  SAMICAS2 turn on copy forward for cteval new forms.
"RTN","SAMICUL",162,0)
 ;
"RTN","SAMICUL",163,0)
 ; 2018-10-26 ven/lgc 1.18.0-t04 f19bf1ae
"RTN","SAMICUL",164,0)
 ;  SAMICAS2 ability to add multiple forms on same day.
"RTN","SAMICUL",165,0)
 ;
"RTN","SAMICUL",166,0)
 ; 2018-11-07 ven/gpl 1.18.0-t04 c76b2eac
"RTN","SAMICUL",167,0)
 ;  SAMICAS2 defend against unit test patient 1.
"RTN","SAMICUL",168,0)
 ;
"RTN","SAMICUL",169,0)
 ; 2018-11-13 ven/toad 1.18.0-t04
"RTN","SAMICUL",170,0)
 ;  SAMICAS2 SAMIHOM2 > SAMIHOM3.
"RTN","SAMICUL",171,0)
 ;
"RTN","SAMICUL",172,0)
 ; 2018-11-14 ven/lgc 1.18.0-t04 6e9799ba
"RTN","SAMICUL",173,0)
 ;  SAMICUL fix graphstore forms.
"RTN","SAMICUL",174,0)
 ;
"RTN","SAMICUL",175,0)
 ; 2018-11-28 ven/lgc 1.18.0-t04 a9539464
"RTN","SAMICUL",176,0)
 ;  SAMICAS2 work on sac compliance.
"RTN","SAMICUL",177,0)
 ;
"RTN","SAMICUL",178,0)
 ; 2018-12-11 ven/lgc 1.18.0-t04 3ceb74b5
"RTN","SAMICUL",179,0)
 ;  SAMICAS2 update for sac compliance.
"RTN","SAMICUL",180,0)
 ;
"RTN","SAMICUL",181,0)
 ; 2018-12-19/20 ven/lgc 1.18.0-t04 7a5d3400,a14554c1
"RTN","SAMICUL",182,0)
 ;  SAMICAS2 more sac compliance, r/^gpl w/^SAMIGPL.
"RTN","SAMICUL",183,0)
 ;
"RTN","SAMICUL",184,0)
 ; 2018-12-26 ven/lgc 1.18.0-t04 8dd6f34d,51eb1635
"RTN","SAMICUL",185,0)
 ;  SAMICAS2 update for sac compliance, fix accidental reversions.
"RTN","SAMICUL",186,0)
 ;
"RTN","SAMICUL",187,0)
 ; 2019-01-10 ven/lgc 1.18.0-t04 2daba010
"RTN","SAMICUL",188,0)
 ;  SAMICAS2 update for SAC compliance.
"RTN","SAMICUL",189,0)
 ;
"RTN","SAMICUL",190,0)
 ; 2019-01-22 ven/lgc 1.18.0-t04 53681219,5ddb29c5
"RTN","SAMICUL",191,0)
 ;  SAMICAS2 add license info to each SAMI routine; edit for lower
"RTN","SAMICUL",192,0)
 ; case initials.
"RTN","SAMICUL",193,0)
 ;
"RTN","SAMICUL",194,0)
 ; 2019-02-18 ven/lgc 1.18.0-t04 76874314
"RTN","SAMICUL",195,0)
 ;  SAMICAS2,SAMICAS3 update recently edited routines.
"RTN","SAMICUL",196,0)
 ;
"RTN","SAMICUL",197,0)
 ; 2019-03-13 ven/lmry 1.18.0-t04 ef66ef16
"RTN","SAMICUL",198,0)
 ;  SAMICAS2 spell out some elements missed earlier.
"RTN","SAMICUL",199,0)
 ;
"RTN","SAMICUL",200,0)
 ; 2019-03-14 ven/lmry 1.18.0-t04 038507e2
"RTN","SAMICUL",201,0)
 ;  SAMICAS3 spell out some missed M elements, fix copy/paste errors
"RTN","SAMICUL",202,0)
 ; in comments for MKFUFORM, MKBXFORM, & MKPTFORM.
"RTN","SAMICUL",203,0)
 ;
"RTN","SAMICUL",204,0)
 ; 2019-04-16 ven/lgc 1.18.0-t04 e54b76d1
"RTN","SAMICUL",205,0)
 ;  SAMICAS2 update for SAMIFORM project.
"RTN","SAMICUL",206,0)
 ;
"RTN","SAMICUL",207,0)
 ; 2019-04-23 ven/gpl 1.18.0-t04 ce322911
"RTN","SAMICUL",208,0)
 ;  SAMICAS2 add intake notes to case review page.
"RTN","SAMICUL",209,0)
 ;
"RTN","SAMICUL",210,0)
 ; 2019-06-18 ven/lgc 1.18.0-t04 91022482
"RTN","SAMICUL",211,0)
 ;  SAMICAS3 switch fr/global ^SAMIGPL to/^SAMIUL.
"RTN","SAMICUL",212,0)
 ;
"RTN","SAMICUL",213,0)
 ; 2019-07-01 ven/gpl 1.18.0-t04 cc87cc44
"RTN","SAMICUL",214,0)
 ;  SAMICAS3 prevent >1 bkgd form/patient.
"RTN","SAMICUL",215,0)
 ;
"RTN","SAMICUL",216,0)
 ; 2019-07-07 ven/gpl 1.18.0-t04 776f7451
"RTN","SAMICUL",217,0)
 ;  SAMICAS3 resolving can't create bkgd form, branch messed up.
"RTN","SAMICUL",218,0)
 ;
"RTN","SAMICUL",219,0)
 ; 2019-08-01 ven/lgc 1.18.0-t04 d710f27d
"RTN","SAMICUL",220,0)
 ;  SAMICAS2 pull displayed facility code from Vista parameter.
"RTN","SAMICUL",221,0)
 ;
"RTN","SAMICUL",222,0)
 ; 2019-09-26 ven/gpl 1.18.0-t04 92b12324 vap-420
"RTN","SAMICUL",223,0)
 ;  SAMICAS3 prefill form date & date of baseline ct on new followup
"RTN","SAMICUL",224,0)
 ; form.
"RTN","SAMICUL",225,0)
 ;
"RTN","SAMICUL",226,0)
 ; 2019-10-01 par/ddn 1.18.0-t04 4caf1a98 vap-344
"RTN","SAMICUL",227,0)
 ;  SAMICAS2 use proper capitalization of the word "veteran".
"RTN","SAMICUL",228,0)
 ;
"RTN","SAMICUL",229,0)
 ; 2020-01-11 ven/lgc 1.18.0.1+i1 5651698a
"RTN","SAMICUL",230,0)
 ;  SAMICAS2,SAMICAS3 fix duplicate form overwriting.
"RTN","SAMICUL",231,0)
 ;
"RTN","SAMICUL",232,0)
 ; 2020-01-17 ven/lgc 1.18.0.1+i1 8557207f
"RTN","SAMICUL",233,0)
 ;  SAMICAS2 followup note.
"RTN","SAMICUL",234,0)
 ;
"RTN","SAMICUL",235,0)
 ; 2020-01-25 ven/lgc 1.18.0.3+i3 6a07a860,6a947567
"RTN","SAMICUL",236,0)
 ;  SAMICAS3 nodule copy & fix to ru, fix subtle bug in nodule copy.
"RTN","SAMICUL",237,0)
 ;
"RTN","SAMICUL",238,0)
 ; 2020-04-11 ven/gpl 1.18.0.5+i5 666f5b91,2f2c29c1
"RTN","SAMICUL",239,0)
 ;  SAMICAS2 multi-tenancy.
"RTN","SAMICUL",240,0)
 ;
"RTN","SAMICUL",241,0)
 ; 2020-05-12 ven/gpl 1.18.0.5+i5 ad11e0ea
"RTN","SAMICUL",242,0)
 ;  SAMICAS2 fix SITE on case review page.
"RTN","SAMICUL",243,0)
 ;
"RTN","SAMICUL",244,0)
 ; 2020-11-12 ven/gpl 1.18.0.9+i9 cec1ccd6
"RTN","SAMICUL",245,0)
 ;  SAMICAS2,SAMICAS3 ceform date refill upgrade.
"RTN","SAMICUL",246,0)
 ;
"RTN","SAMICUL",247,0)
 ; 2020-11-13 ven/gpl 1.18.0.9+i9 dce3c568
"RTN","SAMICUL",248,0)
 ;  SAMICAS3 prefill ceform prior scans text field.
"RTN","SAMICUL",249,0)
 ;
"RTN","SAMICUL",250,0)
 ; 2021-02-18 ven/gpl 1.18.0.9+i9 af2a0b8a
"RTN","SAMICUL",251,0)
 ;  SAMICAS3 copy last previous CT nodules instead of last nodules in
"RTN","SAMICUL",252,0)
 ; any form.
"RTN","SAMICUL",253,0)
 ;
"RTN","SAMICUL",254,0)
 ; 2021-02-21 ven/gpl 1.18.0.9+i9 3fd704fb
"RTN","SAMICUL",255,0)
 ;  SAMICAS3 fix bug in prefill logic.
"RTN","SAMICUL",256,0)
 ;
"RTN","SAMICUL",257,0)
 ; 2021-03-02 ven/gpl 1.18.0.9+i9 479dc041
"RTN","SAMICUL",258,0)
 ;  SAMICAS2 return error msg if no CT Eval form exists when
"RTN","SAMICUL",259,0)
 ; generating a FU note.
"RTN","SAMICUL",260,0)
 ;
"RTN","SAMICUL",261,0)
 ; 2021-03-10 ven/toad 1.18.0.9+i9 a46a2cc1
"RTN","SAMICUL",262,0)
 ;  SAMICUL update log, convert to new vistaver schema.
"RTN","SAMICUL",263,0)
 ;  SAMICAS2,SAMICAS3 bump date & patch list, update contents, lt
"RTN","SAMICUL",264,0)
 ; refactor.
"RTN","SAMICUL",265,0)
 ;
"RTN","SAMICUL",266,0)
 ; 2021-03-17 ven/toad 1.18.0.9+i9 62da30b
"RTN","SAMICUL",267,0)
 ;  SAMICAS2 fix xindex errors: in WSCASE add missing space between
"RTN","SAMICUL",268,0)
 ; do & comment to prevent syntax error reported as block mismatch.
"RTN","SAMICUL",269,0)
 ;  SAMICAS3 remove extra spaces at ends of 3 lines.
"RTN","SAMICUL",270,0)
 ;
"RTN","SAMICUL",271,0)
 ; 2021-04-16 ven/gpl 1.18.0.11+i11 ac82eec
"RTN","SAMICUL",272,0)
 ;  SAMICAS3 include baseline scan in prior scans field on prefill.
"RTN","SAMICUL",273,0)
 ;
"RTN","SAMICUL",274,0)
 ; 2021-05-14/19 ven/gpl 1.18.0.11+i11 0cbee7b,a21b056,139c6a5,0a0cccc
"RTN","SAMICUL",275,0)
 ;  SAMICAS3 improved CT eval prefill of past scan dates, urgent
"RTN","SAMICUL",276,0)
 ; fixes to CT Report & intervention & pet form prefill.
"RTN","SAMICUL",277,0)
 ;
"RTN","SAMICUL",278,0)
 ; 2021-05-20/21 ven/mcglk&toad 1.18.0.11+i11 43a4557,424ea11,129e96b
"RTN","SAMICUL",279,0)
 ;  SAMICAS3 bump version & dates.
"RTN","SAMICUL",280,0)
 ;
"RTN","SAMICUL",281,0)
 ; 2021-05-24 ven/gpl 1.18.0.11+i11 4aba1a9
"RTN","SAMICUL",282,0)
 ;  SAMICAS3 in MKCEFORM,MKPTFORM,MKBXFORM pass key to
"RTN","SAMICUL",283,0)
 ; CTCOPY^SAMICTC1 to modulate node-copy operation; critical fix to
"RTN","SAMICUL",284,0)
 ; copy forward for is it new field for new ct eval forms.
"RTN","SAMICUL",285,0)
 ;
"RTN","SAMICUL",286,0)
 ; 2021-05-25 ven/toad 1.18.0.11+i11 801d7c74
"RTN","SAMICUL",287,0)
 ;  SAMICAS3 bump date; passim lt refactor.
"RTN","SAMICUL",288,0)
 ;
"RTN","SAMICUL",289,0)
 ; 2021-05-26/27 ven/gpl 1.18.0.11+i11 6edc0610,73728821
"RTN","SAMICUL",290,0)
 ;  SAMICAS3 in MKITFORM add new nodule-copy block to copy forward
"RTN","SAMICUL",291,0)
 ; for intervention form; in LASTCMP,PRIORCMP init tdt to today to
"RTN","SAMICUL",292,0)
 ; start before today, to fix last comp & prior scan field prefill in
"RTN","SAMICUL",293,0)
 ; ct eval form.
"RTN","SAMICUL",294,0)
 ;
"RTN","SAMICUL",295,0)
 ; 2021-06-01 ven/toad 1.18.0.11+i11 7dd9410c
"RTN","SAMICUL",296,0)
 ;  SAMICAS3 fold in gpl chgs fr 2021-05-26/27, annotate, adjust news
"RTN","SAMICUL",297,0)
 ; in nodule copy blocks, bump date.
"RTN","SAMICUL",298,0)
 ;
"RTN","SAMICUL",299,0)
 ; 2021-06-29 ven/gpl 1.18.0.12-t2+i12 50d3998b,a5bbd37a
"RTN","SAMICUL",300,0)
 ;  SAMICAS3 in LASTCMP fix bug that excluded ct forms from today in
"RTN","SAMICUL",301,0)
 ; date list, init tdt to today+1 to start today; text-box formatting
"RTN","SAMICUL",302,0)
 ; for intake & followup notes, new text-processing utils; in MKFUFORM
"RTN","SAMICUL",303,0)
 ; set basedt to $$BASELNDT or $$LASTCMP or now.
"RTN","SAMICUL",304,0)
 ;
"RTN","SAMICUL",305,0)
 ; 2021-06-30/07-06 ven/mcglk&toad&gpl 1.18.0.12-t2+i12 cbf7e46b,
"RTN","SAMICUL",306,0)
 ; d8296fda,b248664b
"RTN","SAMICUL",307,0)
 ;  SAMICASE,2,3 bump version & dates.
"RTN","SAMICUL",308,0)
 ;  SAMICAS3 in MKFUFORM,LASTCMP update calls & called-by.
"RTN","SAMICUL",309,0)
 ;  SAMICASE,2,3 finish converting to ppi format, annotate; fix typos.
"RTN","SAMICUL",310,0)
 ;
"RTN","SAMICUL",311,0)
 ;@contents
"RTN","SAMICUL",312,0)
 ; SAMICASE case review
"RTN","SAMICUL",313,0)
 ; SAMICAS2 case review continued
"RTN","SAMICUL",314,0)
 ; SAMICAS3 case review continued
"RTN","SAMICUL",315,0)
 ; SAMICUL case review log
"RTN","SAMICUL",316,0)
 ;
"RTN","SAMICUL",317,0)
 ;
"RTN","SAMICUL",318,0)
 ;
"RTN","SAMICUL",319,0)
EOR ; end of routine SAMICUL
"RTN","SAMIHOM3")
0^6^B168256875
"RTN","SAMIHOM3",1,0)
SAMIHOM3 ;ven/gpl - homepage web service ;2021-07-01t21:35z
"RTN","SAMIHOM3",2,0)
 ;;18.0;SAMI;**5,12**;2020-01;Build 6
"RTN","SAMIHOM3",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIHOM3",4,0)
 ;
"RTN","SAMIHOM3",5,0)
 ; Routine SAMIHOM3 contains subroutines for implementing the IELCAP
"RTN","SAMIHOM3",6,0)
 ; Home Page and to provide binding to VistA.
"RTN","SAMIHOM3",7,0)
 ;
"RTN","SAMIHOM3",8,0)
 quit  ; no entry from top
"RTN","SAMIHOM3",9,0)
 ;
"RTN","SAMIHOM3",10,0)
 ;
"RTN","SAMIHOM3",11,0)
 ;
"RTN","SAMIHOM3",12,0)
 ;@section 0 primary development
"RTN","SAMIHOM3",13,0)
 ;
"RTN","SAMIHOM3",14,0)
 ;
"RTN","SAMIHOM3",15,0)
 ;
"RTN","SAMIHOM3",16,0)
 ;@routine-credits
"RTN","SAMIHOM3",17,0)
 ;@license see routine SAMIUL
"RTN","SAMIHOM3",18,0)
 ;@documentation see SAMIHUL
"RTN","SAMIHOM3",19,0)
 ;
"RTN","SAMIHOM3",20,0)
 ;@routine-credits
"RTN","SAMIHOM3",21,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMIHOM3",22,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIHOM3",23,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIHOM3",24,0)
 ; http://vistaexpertise.net
"RTN","SAMIHOM3",25,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIHOM3",26,0)
 ;@license Apache 2.0
"RTN","SAMIHOM3",27,0)
 ; https://www.apache.org/licenses/LICENSE-2.0.html
"RTN","SAMIHOM3",28,0)
 ;
"RTN","SAMIHOM3",29,0)
 ;@last-updated 2021-07-01t21:35z
"RTN","SAMIHOM3",30,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIHOM3",31,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIHOM3",32,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIHOM3",33,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIHOM3",34,0)
 ;@release-date 2020-01
"RTN","SAMIHOM3",35,0)
 ;@patch-list **5,12**
"RTN","SAMIHOM3",36,0)
 ;
"RTN","SAMIHOM3",37,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIHOM3",38,0)
 ; toad@vistaexpertise.net
"RTN","SAMIHOM3",39,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMIHOM3",40,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIHOM3",41,0)
 ;
"RTN","SAMIHOM3",42,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIHOM3",43,0)
 ; see routine SAMIHUL
"RTN","SAMIHOM3",44,0)
 ;@contents
"RTN","SAMIHOM3",45,0)
 ;
"RTN","SAMIHOM3",46,0)
 ;  web services get vapals & post vapals
"RTN","SAMIHOM3",47,0)
 ;
"RTN","SAMIHOM3",48,0)
 ; WSHOME wsi WSHOME^SAMIHOM3, get vapals (SAMI homepage)
"RTN","SAMIHOM3",49,0)
 ; WSVAPALS wsi WSVAPALS^SAMIHOM3, post vapals (main gateway)
"RTN","SAMIHOM3",50,0)
 ;
"RTN","SAMIHOM3",51,0)
 ;  web pages & web routes
"RTN","SAMIHOM3",52,0)
 ;
"RTN","SAMIHOM3",53,0)
 ; DEVHOME wpi DEVHOME^SAMIHOM3, development home page
"RTN","SAMIHOM3",54,0)
 ; GETHOME wpi GETHOME^SAMIHOM3, get homepage (not subsequent visit)
"RTN","SAMIHOM3",55,0)
 ; WSNEWCAS wri WSNEWCAS^SAMIHOM3, newcase (creates new case)
"RTN","SAMIHOM3",56,0)
 ;
"RTN","SAMIHOM3",57,0)
 ;  private program interfaces
"RTN","SAMIHOM3",58,0)
 ;
"RTN","SAMIHOM3",59,0)
 ; $$SID2NUM number part of studyid (XXX0001 -> 1)
"RTN","SAMIHOM3",60,0)
 ; $$GENSTDID studyID for number
"RTN","SAMIHOM3",61,0)
 ; $$PREFIX letters to use to begin studyId
"RTN","SAMIHOM3",62,0)
 ; $$KEYDATE date in StudyId format (yyyy-mm-dd)
"RTN","SAMIHOM3",63,0)
 ; PREFILL prefill fields for forms
"RTN","SAMIHOM3",64,0)
 ;
"RTN","SAMIHOM3",65,0)
 ;  private subroutines
"RTN","SAMIHOM3",66,0)
 ;
"RTN","SAMIHOM3",67,0)
 ; PATLIST returns a list of patients in ary, passed by name
"RTN","SAMIHOM3",68,0)
 ; MKSIFORM create intake form
"RTN","SAMIHOM3",69,0)
 ;
"RTN","SAMIHOM3",70,0)
 ;  unused &/or deprecated subroutines
"RTN","SAMIHOM3",71,0)
 ;
"RTN","SAMIHOM3",72,0)
 ; $$SCANFOR scan array looking for value, return index
"RTN","SAMIHOM3",73,0)
 ; $$NEXTNUM next number for studyid
"RTN","SAMIHOM3",74,0)
 ; $$VALDTNM validate a new name
"RTN","SAMIHOM3",75,0)
 ; MKSBFORM create background form
"RTN","SAMIHOM3",76,0)
 ; ADDPAT-INDEX calls newCase to add patient dfn to vapals
"RTN","SAMIHOM3",77,0)
 ;
"RTN","SAMIHOM3",78,0)
 ;
"RTN","SAMIHOM3",79,0)
 ;
"RTN","SAMIHOM3",80,0)
 ;@section 1 web services get vapals & post vapals
"RTN","SAMIHOM3",81,0)
 ;
"RTN","SAMIHOM3",82,0)
 ;
"RTN","SAMIHOM3",83,0)
 ;
"RTN","SAMIHOM3",84,0)
 ;@wsi WSHOME^SAMIHOM3, web service get vapals (SAMI homepage)
"RTN","SAMIHOM3",85,0)
WSHOME(SAMIRTN,SAMIFILTER) goto WSHOME^SAMIHOM4
"RTN","SAMIHOM3",86,0)
 ;
"RTN","SAMIHOM3",87,0)
 ;
"RTN","SAMIHOM3",88,0)
 ;
"RTN","SAMIHOM3",89,0)
 ;@wsi WSVAPALS^SAMIHOM3, web service post vapals (main gateway)
"RTN","SAMIHOM3",90,0)
WSVAPALS(SAMIARG,SAMIBODY,SAMIRESULT) goto WSVAPALS^SAMIHOM4
"RTN","SAMIHOM3",91,0)
 ; (all calls come through this gateway)
"RTN","SAMIHOM3",92,0)
 ;
"RTN","SAMIHOM3",93,0)
 ;
"RTN","SAMIHOM3",94,0)
 ;
"RTN","SAMIHOM3",95,0)
 ;@section 2 web pages & web routes
"RTN","SAMIHOM3",96,0)
 ;
"RTN","SAMIHOM3",97,0)
 ;
"RTN","SAMIHOM3",98,0)
 ;
"RTN","SAMIHOM3",99,0)
 ;@wri WSNEWCAS^SAMIHOM3, newcase (creates new case)
"RTN","SAMIHOM3",100,0)
WSNEWCAS(SAMIARGS,SAMIBODY,SAMIRESULT) goto WSNEWCAS^SAMIHOM4
"RTN","SAMIHOM3",101,0)
 ;
"RTN","SAMIHOM3",102,0)
 ;
"RTN","SAMIHOM3",103,0)
 ;
"RTN","SAMIHOM3",104,0)
 ;@wpi DEVHOME^SAMIHOM3, development home page
"RTN","SAMIHOM3",105,0)
DEVHOME(SAMIRTN,SAMIFILTER) goto DEVHOME^SAMIHOM4
"RTN","SAMIHOM3",106,0)
 ;
"RTN","SAMIHOM3",107,0)
 ;
"RTN","SAMIHOM3",108,0)
 ;
"RTN","SAMIHOM3",109,0)
 ;@wpi GETHOME^SAMIHOM3, get homepage (not subsequent visit)
"RTN","SAMIHOM3",110,0)
GETHOME(SAMIRTN,SAMIFILTER) goto GETHOME^SAMIHOM4
"RTN","SAMIHOM3",111,0)
 ;
"RTN","SAMIHOM3",112,0)
 ;
"RTN","SAMIHOM3",113,0)
 ;
"RTN","SAMIHOM3",114,0)
 ;@section 3 private program interfaces
"RTN","SAMIHOM3",115,0)
 ;
"RTN","SAMIHOM3",116,0)
 ;
"RTN","SAMIHOM3",117,0)
 ;
"RTN","SAMIHOM3",118,0)
 ;@API $$SID2NUM^SAMIHOM3, number part of study id
"RTN","SAMIHOM3",119,0)
SID2NUM(sid) ; number part of studyid (XXX0001 -> 1)
"RTN","SAMIHOM3",120,0)
 ;
"RTN","SAMIHOM3",121,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",122,0)
 ;
"RTN","SAMIHOM3",123,0)
 ;ven/gpl;public;function;clean;silent;sac;tests
"RTN","SAMIHOM3",124,0)
 ;@called-by
"RTN","SAMIHOM3",125,0)
 ; getVals^%wfhform
"RTN","SAMIHOM3",126,0)
 ; WSCASE^SAMICASE
"RTN","SAMIHOM3",127,0)
 ; WSNUFORM^SAMICASE
"RTN","SAMIHOM3",128,0)
 ; MKBXFORM^SAMICAS3
"RTN","SAMIHOM3",129,0)
 ; MKCEFORM^SAMICAS3
"RTN","SAMIHOM3",130,0)
 ; MKFUFORM^SAMICAS3
"RTN","SAMIHOM3",131,0)
 ; MKITFORM^SAMICAS3
"RTN","SAMIHOM3",132,0)
 ; MKPTFORM^SAMICAS3
"RTN","SAMIHOM3",133,0)
 ; MKSBFORM^SAMICAS3
"RTN","SAMIHOM3",134,0)
 ; filename^SAMICTRT
"RTN","SAMIHOM3",135,0)
 ; getVals^SAMIZ1
"RTN","SAMIHOM3",136,0)
 ;@calls
"RTN","SAMIHOM3",137,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",138,0)
 ;@input
"RTN","SAMIHOM3",139,0)
 ; sid = study id
"RTN","SAMIHOM3",140,0)
 ;@output = number from study id
"RTN","SAMIHOM3",141,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",142,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",143,0)
 ;
"RTN","SAMIHOM3",144,0)
 ;@stanza 2 calculate number
"RTN","SAMIHOM3",145,0)
 ;
"RTN","SAMIHOM3",146,0)
 ;new number set number=+$extract(sid,4,$length(sid))
"RTN","SAMIHOM3",147,0)
 ; we have to look up the number (pien) instead of computing it
"RTN","SAMIHOM3",148,0)
 new proot set proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",149,0)
 new number set number=$order(@proot@("sid",sid,""))
"RTN","SAMIHOM3",150,0)
 ;
"RTN","SAMIHOM3",151,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",152,0)
 ;
"RTN","SAMIHOM3",153,0)
 quit number ; return number; end of $$sid2num
"RTN","SAMIHOM3",154,0)
 ;
"RTN","SAMIHOM3",155,0)
 ;
"RTN","SAMIHOM3",156,0)
 ;
"RTN","SAMIHOM3",157,0)
GENSTDID(num,ARG) ; studyID for number
"RTN","SAMIHOM3",158,0)
 ;
"RTN","SAMIHOM3",159,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",160,0)
 ;
"RTN","SAMIHOM3",161,0)
 ;ven/gpl;private;function;clean;silent;sac;tests
"RTN","SAMIHOM3",162,0)
 ;@called-by
"RTN","SAMIHOM3",163,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",164,0)
 ; WSSBFORM^SAMIFWS
"RTN","SAMIHOM3",165,0)
 ; WSSIFORM^SAMIFWS
"RTN","SAMIHOM3",166,0)
 ; WSCEFORM^SAMIFWS
"RTN","SAMIHOM3",167,0)
 ; MOV^SAMIMOV
"RTN","SAMIHOM3",168,0)
 ; WSLOOKUP^SAMISRCH
"RTN","SAMIHOM3",169,0)
 ;@calls none
"RTN","SAMIHOM3",170,0)
 ; $$GETPRFX^SAMIFORM [commented out]
"RTN","SAMIHOM3",171,0)
 ;@input
"RTN","SAMIHOM3",172,0)
 ; num = number of study id
"RTN","SAMIHOM3",173,0)
 ;@output = study id corresponding to number
"RTN","SAMIHOM3",174,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",175,0)
 ;@tests
"RTN","SAMIHOM3",176,0)
 ; UTSTDID^SAMIUTH3
"RTN","SAMIHOM3",177,0)
 ;
"RTN","SAMIHOM3",178,0)
 ;
"RTN","SAMIHOM3",179,0)
 ;@stanza 2 calculate study id
"RTN","SAMIHOM3",180,0)
 ;
"RTN","SAMIHOM3",181,0)
 new zl set zl=$length(num)
"RTN","SAMIHOM3",182,0)
 new zz set zz="00000"
"RTN","SAMIHOM3",183,0)
 ;
"RTN","SAMIHOM3",184,0)
 ; new studyid set studyid=$$GETPRFX^SAMIFORM(.ARG)_$extract(zz,1,5-zl)_num
"RTN","SAMIHOM3",185,0)
 ;
"RTN","SAMIHOM3",186,0)
 ; the prefix is determined by the site or siteid, which should be passed
"RTN","SAMIHOM3",187,0)
 ; in ARG
"RTN","SAMIHOM3",188,0)
 new tsite set tsite=$get(ARG("siteid"))
"RTN","SAMIHOM3",189,0)
 if tsite="" set tsite=$get(ARG("site"))
"RTN","SAMIHOM3",190,0)
 if tsite="" set tsite="UNK"
"RTN","SAMIHOM3",191,0)
 new studyid set studyid=tsite_$extract(zz,1,5-zl)_num
"RTN","SAMIHOM3",192,0)
 ;
"RTN","SAMIHOM3",193,0)
 ;
"RTN","SAMIHOM3",194,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",195,0)
 ;
"RTN","SAMIHOM3",196,0)
 quit studyid ; return study id; end of $$GENSTDID
"RTN","SAMIHOM3",197,0)
 ;
"RTN","SAMIHOM3",198,0)
 ;
"RTN","SAMIHOM3",199,0)
 ;
"RTN","SAMIHOM3",200,0)
KEYDATE(fmdt) ; date in StudyId format (yyyy-mm-dd)
"RTN","SAMIHOM3",201,0)
 ;
"RTN","SAMIHOM3",202,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",203,0)
 ;
"RTN","SAMIHOM3",204,0)
 ;ven/gpl;private;function;clean;silent;sac;tests
"RTN","SAMIHOM3",205,0)
 ;@called-by
"RTN","SAMIHOM3",206,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",207,0)
 ; WSNFPOST^SAMICASE
"RTN","SAMIHOM3",208,0)
 ; SAVFILTR^SAMISAV
"RTN","SAMIHOM3",209,0)
 ;@calls
"RTN","SAMIHOM3",210,0)
 ; $$FMTE^XLFDT
"RTN","SAMIHOM3",211,0)
 ;@input
"RTN","SAMIHOM3",212,0)
 ; fmdt = date in fileman format
"RTN","SAMIHOM3",213,0)
 ;@output = date in study id format
"RTN","SAMIHOM3",214,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",215,0)
 ;@tests
"RTN","SAMIHOM3",216,0)
 ; UTKEYDT^SAMIUTH3
"RTN","SAMIHOM3",217,0)
 ;
"RTN","SAMIHOM3",218,0)
 ;
"RTN","SAMIHOM3",219,0)
 ;@stanza 2 calculate studyid format
"RTN","SAMIHOM3",220,0)
 ;
"RTN","SAMIHOM3",221,0)
 new zdt set zdt=$$FMTE^XLFDT(fmdt,"7D")
"RTN","SAMIHOM3",222,0)
 ;
"RTN","SAMIHOM3",223,0)
 new zy set zy=$piece(zdt,"/",1) ; year
"RTN","SAMIHOM3",224,0)
 new zm set zm=$piece(zdt,"/",2) ; month
"RTN","SAMIHOM3",225,0)
 if $length(zm)=1 set zm="0"_zm
"RTN","SAMIHOM3",226,0)
 ;
"RTN","SAMIHOM3",227,0)
 new zd set zd=$piece(zdt,"/",3) ; day
"RTN","SAMIHOM3",228,0)
 if $length(zd)=1 set zd="0"_zd
"RTN","SAMIHOM3",229,0)
 ;
"RTN","SAMIHOM3",230,0)
 new studydate set studydate=zy_"-"_zm_"-"_zd
"RTN","SAMIHOM3",231,0)
 ;
"RTN","SAMIHOM3",232,0)
 ;
"RTN","SAMIHOM3",233,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",234,0)
 ;
"RTN","SAMIHOM3",235,0)
 quit studydate ; return date; end of $$KEYDATE
"RTN","SAMIHOM3",236,0)
 ;
"RTN","SAMIHOM3",237,0)
 ;
"RTN","SAMIHOM3",238,0)
 ;
"RTN","SAMIHOM3",239,0)
PREFILL(dfn) ; prefill fields for form
"RTN","SAMIHOM3",240,0)
 ;
"RTN","SAMIHOM3",241,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",242,0)
 ;
"RTN","SAMIHOM3",243,0)
 ;ven/gpl;private;procedure;clean;silent;sac;tests
"RTN","SAMIHOM3",244,0)
 ;@called-by
"RTN","SAMIHOM3",245,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",246,0)
 ; GETHDR^SAMIFLD
"RTN","SAMIHOM3",247,0)
 ;@calls
"RTN","SAMIHOM3",248,0)
 ; PTINFO^SAMIVSTA
"RTN","SAMIHOM3",249,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",250,0)
 ; ^%DT
"RTN","SAMIHOM3",251,0)
 ;@input
"RTN","SAMIHOM3",252,0)
 ; dfn = patient ien
"RTN","SAMIHOM3",253,0)
 ;@output
"RTN","SAMIHOM3",254,0)
 ; @root(gien) = ...
"RTN","SAMIHOM3",255,0)
 ;  where root = graph root for elcap patients
"RTN","SAMIHOM3",256,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",257,0)
 ;@tests [tbd]
"RTN","SAMIHOM3",258,0)
 ;
"RTN","SAMIHOM3",259,0)
 ;
"RTN","SAMIHOM3",260,0)
 ;@stanza 2 prefill fields
"RTN","SAMIHOM3",261,0)
 ;
"RTN","SAMIHOM3",262,0)
 ; pull data from VistA
"RTN","SAMIHOM3",263,0)
 ;
"RTN","SAMIHOM3",264,0)
 ; new ok set ok=$$PTINFO^SAMIVSTA(dfn)
"RTN","SAMIHOM3",265,0)
 ; if +ok<1 do ^%ZTER
"RTN","SAMIHOM3",266,0)
 ;
"RTN","SAMIHOM3",267,0)
 do PTINFO^SAMIVSTA(dfn) ; get additional info on patient
"RTN","SAMIHOM3",268,0)
 ;
"RTN","SAMIHOM3",269,0)
 ; prefills fields from patient-lookup graph
"RTN","SAMIHOM3",270,0)
 ;
"RTN","SAMIHOM3",271,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",272,0)
 new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM3",273,0)
 ;
"RTN","SAMIHOM3",274,0)
 new lien set lien=$order(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM3",275,0)
 quit:lien=""
"RTN","SAMIHOM3",276,0)
 ;
"RTN","SAMIHOM3",277,0)
 new gien set gien=$order(@root@("dfn",dfn,"")) ; 
"RTN","SAMIHOM3",278,0)
 quit:gien=""
"RTN","SAMIHOM3",279,0)
 ;
"RTN","SAMIHOM3",280,0)
 ; merge prefill fields
"RTN","SAMIHOM3",281,0)
 merge @root@(gien)=@lroot@(lien)
"RTN","SAMIHOM3",282,0)
 ;
"RTN","SAMIHOM3",283,0)
 ; fix format problems
"RTN","SAMIHOM3",284,0)
 new saminame set saminame=$get(@root@(gien,"saminame"))
"RTN","SAMIHOM3",285,0)
 ;
"RTN","SAMIHOM3",286,0)
 ; dob format
"RTN","SAMIHOM3",287,0)
 new dob set dob=$get(@lroot@(lien,"sbdob"))
"RTN","SAMIHOM3",288,0)
 new X set X=dob
"RTN","SAMIHOM3",289,0)
 new Y
"RTN","SAMIHOM3",290,0)
 do ^%DT ; convert date to fileman format
"RTN","SAMIHOM3",291,0)
 quit:Y=-1
"RTN","SAMIHOM3",292,0)
 set dob=Y
"RTN","SAMIHOM3",293,0)
 if dob'="" set @root@(gien,"sbdob")=$$VAPALSDT^SAMICASE(dob)
"RTN","SAMIHOM3",294,0)
 if dob'="" set @root@(gien,"sidob")=$$VAPALSDT^SAMICASE(dob)
"RTN","SAMIHOM3",295,0)
 ;
"RTN","SAMIHOM3",296,0)
 ; ssn format
"RTN","SAMIHOM3",297,0)
 new ssn set ssn=$get(@lroot@(lien,"ssn"))
"RTN","SAMIHOM3",298,0)
 if $length(ssn)=9 set @root@(gien,"sissn")=$extract(ssn,1,3)_"-"_$extract(ssn,4,5)_"-"_$extract(ssn,6,9)
"RTN","SAMIHOM3",299,0)
 ;
"RTN","SAMIHOM3",300,0)
 ; studyid
"RTN","SAMIHOM3",301,0)
 set @root@(gien,"sisid")=@root@(gien,"samistudyid")
"RTN","SAMIHOM3",302,0)
 ;
"RTN","SAMIHOM3",303,0)
 ;
"RTN","SAMIHOM3",304,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",305,0)
 ;
"RTN","SAMIHOM3",306,0)
 quit  ; end of PREFILL
"RTN","SAMIHOM3",307,0)
 ;
"RTN","SAMIHOM3",308,0)
 ;
"RTN","SAMIHOM3",309,0)
 ;
"RTN","SAMIHOM3",310,0)
 ;@section 4 private subroutines
"RTN","SAMIHOM3",311,0)
 ;
"RTN","SAMIHOM3",312,0)
 ;
"RTN","SAMIHOM3",313,0)
 ;
"RTN","SAMIHOM3",314,0)
PATLIST(ARY) ; returns a list of patients in ary, passed by name
"RTN","SAMIHOM3",315,0)
 ;
"RTN","SAMIHOM3",316,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",317,0)
 ;
"RTN","SAMIHOM3",318,0)
 ;ven/gpl;private;procedure;clean;silent;sac;tests
"RTN","SAMIHOM3",319,0)
 ;@called-by
"RTN","SAMIHOM3",320,0)
 ; DEVHOME
"RTN","SAMIHOM3",321,0)
 ;@calls
"RTN","SAMIHOM3",322,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",323,0)
 ;@input
"RTN","SAMIHOM3",324,0)
 ; ARY = name of array to return patient list in
"RTN","SAMIHOM3",325,0)
 ;@output
"RTN","SAMIHOM3",326,0)
 ; @ary = array containing list of patients
"RTN","SAMIHOM3",327,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",328,0)
 ;@tests
"RTN","SAMIHOM3",329,0)
 ; UTPTLST^SAMIUTH3
"RTN","SAMIHOM3",330,0)
 ;
"RTN","SAMIHOM3",331,0)
 ;
"RTN","SAMIHOM3",332,0)
 ;@stanza 2 build list of patients
"RTN","SAMIHOM3",333,0)
 ;
"RTN","SAMIHOM3",334,0)
 new GROOT set GROOT=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",335,0)
 ;
"RTN","SAMIHOM3",336,0)
 kill @ARY
"RTN","SAMIHOM3",337,0)
 new zi set zi=""
"RTN","SAMIHOM3",338,0)
 for  do  quit:zi=""
"RTN","SAMIHOM3",339,0)
 . set zi=$order(@GROOT@("graph",zi))
"RTN","SAMIHOM3",340,0)
 . quit:zi=""
"RTN","SAMIHOM3",341,0)
 . set @ARY@(zi)=""
"RTN","SAMIHOM3",342,0)
 . quit
"RTN","SAMIHOM3",343,0)
 ;
"RTN","SAMIHOM3",344,0)
 ;
"RTN","SAMIHOM3",345,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",346,0)
 ;
"RTN","SAMIHOM3",347,0)
 quit  ; end of PATLIST
"RTN","SAMIHOM3",348,0)
 ;
"RTN","SAMIHOM3",349,0)
 ;
"RTN","SAMIHOM3",350,0)
 ;
"RTN","SAMIHOM3",351,0)
MKSIFORM(num) ; create intake form
"RTN","SAMIHOM3",352,0)
 ;
"RTN","SAMIHOM3",353,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",354,0)
 ;
"RTN","SAMIHOM3",355,0)
 ;ven/gpl;private;procedure;clean;silent;sac;tests
"RTN","SAMIHOM3",356,0)
 ;@called-by
"RTN","SAMIHOM3",357,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",358,0)
 ;@calls
"RTN","SAMIHOM3",359,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",360,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMIHOM3",361,0)
 ; $$URBRUR^SAMIVSTA
"RTN","SAMIHOM3",362,0)
 ; $$NOW^XLFDT
"RTN","SAMIHOM3",363,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMIHOM3",364,0)
 ;@input
"RTN","SAMIHOM3",365,0)
 ; num = index where new form should be built
"RTN","SAMIHOM3",366,0)
 ;@output
"RTN","SAMIHOM3",367,0)
 ; @root(num) = ...
"RTN","SAMIHOM3",368,0)
 ;  where root = graph root for elcap patients
"RTN","SAMIHOM3",369,0)
 ; @root@("graph")
"RTN","SAMIHOM3",370,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",371,0)
 ;@tests
"RTN","SAMIHOM3",372,0)
 ; UTSIFRM^SAMIUTH3
"RTN","SAMIHOM3",373,0)
 ;
"RTN","SAMIHOM3",374,0)
 ;
"RTN","SAMIHOM3",375,0)
 ;@stanza 2 create & place graph for new intake form
"RTN","SAMIHOM3",376,0)
 ;
"RTN","SAMIHOM3",377,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",378,0)
 new sid set sid=$get(@root@(num,"samistudyid"))
"RTN","SAMIHOM3",379,0)
 quit:sid=""
"RTN","SAMIHOM3",380,0)
 ;
"RTN","SAMIHOM3",381,0)
 new cdate set cdate=$get(@root@(num,"samicreatedate"))
"RTN","SAMIHOM3",382,0)
 quit:cdate=""
"RTN","SAMIHOM3",383,0)
 ;
"RTN","SAMIHOM3",384,0)
 merge @root@("graph",sid,"siform-"_cdate)=@root@(num)
"RTN","SAMIHOM3",385,0)
 ;
"RTN","SAMIHOM3",386,0)
 ; update form samistatus to complete
"RTN","SAMIHOM3",387,0)
 do SSAMISTA^SAMICASE(sid,"siform-"_cdate,"complete")
"RTN","SAMIHOM3",388,0)
 ;
"RTN","SAMIHOM3",389,0)
 ;
"RTN","SAMIHOM3",390,0)
 ;@stanza 3 init new intake form from vista data
"RTN","SAMIHOM3",391,0)
 ;
"RTN","SAMIHOM3",392,0)
 new zf set zf=$name(@root@("graph",sid,"siform-"_cdate))
"RTN","SAMIHOM3",393,0)
 set @zf@("sipsa")=$get(@root@(num,"address1")) ; primary address
"RTN","SAMIHOM3",394,0)
 set @zf@("sipan")=$get(@root@(num,"address2")) ; apartment #
"RTN","SAMIHOM3",395,0)
 set @zf@("sipc")=$get(@root@(num,"city")) ; city
"RTN","SAMIHOM3",396,0)
 set @zf@("sips")=$get(@root@(num,"state")) ; state
"RTN","SAMIHOM3",397,0)
 set @zf@("sipcn")=$get(@root@(num,"county")) ; county
"RTN","SAMIHOM3",398,0)
 set @zf@("sipcr")="USA" ; country
"RTN","SAMIHOM3",399,0)
 ;
"RTN","SAMIHOM3",400,0)
 set @zf@("sipz")=$get(@root@(num,"zip")) ; zip
"RTN","SAMIHOM3",401,0)
 if @zf@("sipz")'="" do
"RTN","SAMIHOM3",402,0)
 . new zip set zip=@zf@("sipz")
"RTN","SAMIHOM3",403,0)
 . quit:zip=""
"RTN","SAMIHOM3",404,0)
 . ;
"RTN","SAMIHOM3",405,0)
 . new ru set ru=$$URBRUR^SAMIVSTA(zip) ; urban/rural from zip
"RTN","SAMIHOM3",406,0)
 . if ru=0 set ru="n"
"RTN","SAMIHOM3",407,0)
 . if ru="r"!(ru="u")!(ru="n") set @zf@("sirs")=ru
"RTN","SAMIHOM3",408,0)
 . set @root@(num,"sirs")=$get(@zf@("sirs"))
"RTN","SAMIHOM3",409,0)
 . quit
"RTN","SAMIHOM3",410,0)
 ;
"RTN","SAMIHOM3",411,0)
 new phn set phn=$get(@root@(num,"phone")) ; phone #
"RTN","SAMIHOM3",412,0)
 if phn["x" set phn=$piece(phn," x",1)
"RTN","SAMIHOM3",413,0)
 set @zf@("sippn")=phn
"RTN","SAMIHOM3",414,0)
 ;
"RTN","SAMIHOM3",415,0)
 set @zf@("sidc")=$$VAPALSDT^SAMICASE($$NOW^XLFDT) ; intake discussion
"RTN","SAMIHOM3",416,0)
 set @zf@("sipedc")=$$VAPALSDT^SAMICASE($$NOW^XLFDT) ; pre-enroll disc
"RTN","SAMIHOM3",417,0)
 ; set samifirsttime variable for intake form
"RTN","SAMIHOM3",418,0)
 set @zf@("samifirsttime")="true"
"RTN","SAMIHOM3",419,0)
 ;
"RTN","SAMIHOM3",420,0)
 ;
"RTN","SAMIHOM3",421,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",422,0)
 ;
"RTN","SAMIHOM3",423,0)
 quit "siform-"_cdate ; end of MKSIFORM
"RTN","SAMIHOM3",424,0)
 ;
"RTN","SAMIHOM3",425,0)
 ;
"RTN","SAMIHOM3",426,0)
 ;
"RTN","SAMIHOM3",427,0)
 ;@section 5 unused &/or deprecated subroutines
"RTN","SAMIHOM3",428,0)
 ;
"RTN","SAMIHOM3",429,0)
 ;
"RTN","SAMIHOM3",430,0)
 ;
"RTN","SAMIHOM3",431,0)
SCANFOR(ary,start,what) ; scan array looking for value
"RTN","SAMIHOM3",432,0)
 ;
"RTN","SAMIHOM3",433,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",434,0)
 ;
"RTN","SAMIHOM3",435,0)
 ;ven/gpl;private;function;clean;silent;sac;tests
"RTN","SAMIHOM3",436,0)
 ;@called-by none
"RTN","SAMIHOM3",437,0)
 ;@calls: none
"RTN","SAMIHOM3",438,0)
 ;@input
"RTN","SAMIHOM3",439,0)
 ; .ary = array to scan
"RTN","SAMIHOM3",440,0)
 ; start = index to begin scanning at
"RTN","SAMIHOM3",441,0)
 ; what = value to scan array for
"RTN","SAMIHOM3",442,0)
 ;@output = array index where value was found
"RTN","SAMIHOM3",443,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",444,0)
 ;@tests
"RTN","SAMIHOM3",445,0)
 ; UTSCAN4^SAMIUTH3
"RTN","SAMIHOM3",446,0)
 ;
"RTN","SAMIHOM3",447,0)
 ;
"RTN","SAMIHOM3",448,0)
 ;@stanza 2 scan array
"RTN","SAMIHOM3",449,0)
 ;
"RTN","SAMIHOM3",450,0)
 new %1 set %1=start
"RTN","SAMIHOM3",451,0)
 new limit
"RTN","SAMIHOM3",452,0)
 for limit=0:1:1001  do  quit:'%1  quit:ary(%1)[what
"RTN","SAMIHOM3",453,0)
 . set %1=$order(ary(%1))
"RTN","SAMIHOM3",454,0)
 . quit:'%1
"RTN","SAMIHOM3",455,0)
 . quit:ary(%1)[what
"RTN","SAMIHOM3",456,0)
 . ; write !,ary(%1)
"RTN","SAMIHOM3",457,0)
 . quit
"RTN","SAMIHOM3",458,0)
 ;
"RTN","SAMIHOM3",459,0)
 new zrtn set zrtn=%1
"RTN","SAMIHOM3",460,0)
 if %1<start set zrtn=start
"RTN","SAMIHOM3",461,0)
 if %1>1000 set zrtn=start
"RTN","SAMIHOM3",462,0)
 ;
"RTN","SAMIHOM3",463,0)
 ;
"RTN","SAMIHOM3",464,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",465,0)
 ;
"RTN","SAMIHOM3",466,0)
 quit zrtn ; return array index; end of $$$SCANFOR
"RTN","SAMIHOM3",467,0)
 ;
"RTN","SAMIHOM3",468,0)
 ;
"RTN","SAMIHOM3",469,0)
 ;
"RTN","SAMIHOM3",470,0)
NEXTNUM() ; next number for studyid
"RTN","SAMIHOM3",471,0)
 ;
"RTN","SAMIHOM3",472,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",473,0)
 ;
"RTN","SAMIHOM3",474,0)
 ;ven/gpl;private;variable;clean;silent;sac;tests
"RTN","SAMIHOM3",475,0)
 ;@called-by none
"RTN","SAMIHOM3",476,0)
 ; WSNEWCAS [commented out]
"RTN","SAMIHOM3",477,0)
 ;@calls
"RTN","SAMIHOM3",478,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",479,0)
 ;@input: none
"RTN","SAMIHOM3",480,0)
 ;@output = next number for study id
"RTN","SAMIHOM3",481,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",482,0)
 ;@tests
"RTN","SAMIHOM3",483,0)
 ; UTNXTN^SAMIUTH3
"RTN","SAMIHOM3",484,0)
 ;
"RTN","SAMIHOM3",485,0)
 ;
"RTN","SAMIHOM3",486,0)
 ;@stanza 2 calculate next number
"RTN","SAMIHOM3",487,0)
 ;
"RTN","SAMIHOM3",488,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",489,0)
 new number set number=$order(@root@("  "),-1)+1
"RTN","SAMIHOM3",490,0)
 ;
"RTN","SAMIHOM3",491,0)
 ;
"RTN","SAMIHOM3",492,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",493,0)
 ;
"RTN","SAMIHOM3",494,0)
 quit number ; return #; end of $$NEXTNUM
"RTN","SAMIHOM3",495,0)
 ;
"RTN","SAMIHOM3",496,0)
 ;
"RTN","SAMIHOM3",497,0)
 ;
"RTN","SAMIHOM3",498,0)
VALDTNM(nm,args) ; validate new name
"RTN","SAMIHOM3",499,0)
 ;
"RTN","SAMIHOM3",500,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",501,0)
 ;
"RTN","SAMIHOM3",502,0)
 ;ven/gpl;private;function;clean;silent;sac;tests
"RTN","SAMIHOM3",503,0)
 ;@called-by none
"RTN","SAMIHOM3",504,0)
 ; WSNEWCAS [commented out]
"RTN","SAMIHOM3",505,0)
 ;@calls none
"RTN","SAMIHOM3",506,0)
 ;@input
"RTN","SAMIHOM3",507,0)
 ; nm = name to validate
"RTN","SAMIHOM3",508,0)
 ; .args = array to return error messages
"RTN","SAMIHOM3",509,0)
 ;@output = 1 if valid, -1 if not
"RTN","SAMIHOM3",510,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",511,0)
 ;@tests
"RTN","SAMIHOM3",512,0)
 ; UTVALNM^SAMIUTH3
"RTN","SAMIHOM3",513,0)
 ;
"RTN","SAMIHOM3",514,0)
 ;
"RTN","SAMIHOM3",515,0)
 ;@stanza 2 screen for invalid name
"RTN","SAMIHOM3",516,0)
 ;
"RTN","SAMIHOM3",517,0)
 if nm'["," do  quit -1
"RTN","SAMIHOM3",518,0)
 . set args("saminuerror")="invalid name"
"RTN","SAMIHOM3",519,0)
 . quit
"RTN","SAMIHOM3",520,0)
 ;
"RTN","SAMIHOM3",521,0)
 ;
"RTN","SAMIHOM3",522,0)
 ;@stanza 3 return & termination
"RTN","SAMIHOM3",523,0)
 ;
"RTN","SAMIHOM3",524,0)
 quit 1 ; return success; end of $$VALDTNM
"RTN","SAMIHOM3",525,0)
 ;
"RTN","SAMIHOM3",526,0)
 ;
"RTN","SAMIHOM3",527,0)
 ;
"RTN","SAMIHOM3",528,0)
MKSBFORM(num) ; create background form [deprecated]
"RTN","SAMIHOM3",529,0)
 ;
"RTN","SAMIHOM3",530,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",531,0)
 ;
"RTN","SAMIHOM3",532,0)
 ;ven/gpl;private;procedure;clean;silent;sac;tests
"RTN","SAMIHOM3",533,0)
 ;@called-by none
"RTN","SAMIHOM3",534,0)
 ; WSNEWCAS [commented out by gpl 2018-06-15]
"RTN","SAMIHOM3",535,0)
 ;@calls
"RTN","SAMIHOM3",536,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",537,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMIHOM3",538,0)
 ;@input
"RTN","SAMIHOM3",539,0)
 ; num = index where new form should be built
"RTN","SAMIHOM3",540,0)
 ;@output
"RTN","SAMIHOM3",541,0)
 ; @root(num) = ...
"RTN","SAMIHOM3",542,0)
 ;  where root = graph root for elcap patients
"RTN","SAMIHOM3",543,0)
 ; @root@("graph")
"RTN","SAMIHOM3",544,0)
 ;@examples [tbd]
"RTN","SAMIHOM3",545,0)
 ;@tests
"RTN","SAMIHOM3",546,0)
 ; UTSBFRM^SAMIUTH3
"RTN","SAMIHOM3",547,0)
 ;
"RTN","SAMIHOM3",548,0)
 ;
"RTN","SAMIHOM3",549,0)
 ;@stanza 2 build background form & place graph
"RTN","SAMIHOM3",550,0)
 ;
"RTN","SAMIHOM3",551,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",552,0)
 new sid set sid=$get(@root@(num,"samistudyid"))
"RTN","SAMIHOM3",553,0)
 quit:sid=""
"RTN","SAMIHOM3",554,0)
 ;
"RTN","SAMIHOM3",555,0)
 new cdate set cdate=$get(@root@(num,"samicreatedate"))
"RTN","SAMIHOM3",556,0)
 quit:cdate=""
"RTN","SAMIHOM3",557,0)
 ;
"RTN","SAMIHOM3",558,0)
 merge @root@("graph",sid,"sbform-"_cdate)=@root@(num)
"RTN","SAMIHOM3",559,0)
 ;
"RTN","SAMIHOM3",560,0)
 ; update form samistatus to complete
"RTN","SAMIHOM3",561,0)
 do SSAMISTA^SAMICASE(sid,"sbform-"_cdate,"incomplete")
"RTN","SAMIHOM3",562,0)
 ;
"RTN","SAMIHOM3",563,0)
 ;
"RTN","SAMIHOM3",564,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",565,0)
 ;
"RTN","SAMIHOM3",566,0)
 quit  ; end of MKSBFORM
"RTN","SAMIHOM3",567,0)
 ;
"RTN","SAMIHOM3",568,0)
 ;
"RTN","SAMIHOM3",569,0)
 ;
"RTN","SAMIHOM3",570,0)
ADDPAT(dfn) ; calls newCase to add patient dfn to vapals
"RTN","SAMIHOM3",571,0)
 ;
"RTN","SAMIHOM3",572,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM3",573,0)
 ;
"RTN","SAMIHOM3",574,0)
 ;;private;procedure;clean;silent;sac;tests
"RTN","SAMIHOM3",575,0)
 ;@called-by none
"RTN","SAMIHOM3",576,0)
 ;@calls
"RTN","SAMIHOM3",577,0)
 ; $$setroot^%wd
"RTN","SAMIHOM3",578,0)
 ; WSNEWCAS
"RTN","SAMIHOM3",579,0)
 ;@falls-thru-to
"RTN","SAMIHOM3",580,0)
 ; INDEX
"RTN","SAMIHOM3",581,0)
 ;@input
"RTN","SAMIHOM3",582,0)
 ; dfn = patient ien
"RTN","SAMIHOM3",583,0)
 ;@output
"RTN","SAMIHOM3",584,0)
 ; new patient is added to vapals graphstore
"RTN","SAMIHOM3",585,0)
 ;@tests
"RTN","SAMIHOM3",586,0)
 ; UTADDPT^SAMIUTH3
"RTN","SAMIHOM3",587,0)
 ;
"RTN","SAMIHOM3",588,0)
 ;
"RTN","SAMIHOM3",589,0)
 ;@stanza 2 add patient to graphstore
"RTN","SAMIHOM3",590,0)
 ;
"RTN","SAMIHOM3",591,0)
 new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM3",592,0)
 new lien set lien=$order(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM3",593,0)
 quit:lien=""
"RTN","SAMIHOM3",594,0)
 ;
"RTN","SAMIHOM3",595,0)
 new name set name=$get(@lroot@(lien,"saminame"))
"RTN","SAMIHOM3",596,0)
 quit:name=""
"RTN","SAMIHOM3",597,0)
 ;
"RTN","SAMIHOM3",598,0)
 new bdy set bdy(1)="saminame="_name_"&dfn="_dfn
"RTN","SAMIHOM3",599,0)
 new ARGS,result
"RTN","SAMIHOM3",600,0)
 ;
"RTN","SAMIHOM3",601,0)
 do WSNEWCAS(.ARGS,.bdy,.result) ; add to graphstore
"RTN","SAMIHOM3",602,0)
 ; zwrite result
"RTN","SAMIHOM3",603,0)
 ;
"RTN","SAMIHOM3",604,0)
 ;
"RTN","SAMIHOM3",605,0)
INDEX ;@stanza 3 reindex vapals-patients graph
"RTN","SAMIHOM3",606,0)
 ;
"RTN","SAMIHOM3",607,0)
 ;@falls-thru-from
"RTN","SAMIHOM3",608,0)
 ; ADDPAT
"RTN","SAMIHOM3",609,0)
 ;
"RTN","SAMIHOM3",610,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM3",611,0)
 ;
"RTN","SAMIHOM3",612,0)
 new zi set zi=0
"RTN","SAMIHOM3",613,0)
 for  do  quit:+zi=0
"RTN","SAMIHOM3",614,0)
 . set zi=$order(@root@(zi))
"RTN","SAMIHOM3",615,0)
 . quit:+zi=0
"RTN","SAMIHOM3",616,0)
 . ;
"RTN","SAMIHOM3",617,0)
 . new dfn set dfn=@root@(zi,"dfn") ; patient ien
"RTN","SAMIHOM3",618,0)
 . new sid set sid=@root@(zi,"samistudyid") ; study id
"RTN","SAMIHOM3",619,0)
 . set @root@("dfn",dfn,zi)="" ; patient ien index
"RTN","SAMIHOM3",620,0)
 . set @root@("sid",sid,zi)="" ; study id index
"RTN","SAMIHOM3",621,0)
 . quit
"RTN","SAMIHOM3",622,0)
 ;
"RTN","SAMIHOM3",623,0)
 ;
"RTN","SAMIHOM3",624,0)
 ;@stanza 3 termination
"RTN","SAMIHOM3",625,0)
 ;
"RTN","SAMIHOM3",626,0)
 quit  ; end of ADDPAT-INDEX
"RTN","SAMIHOM3",627,0)
 ;
"RTN","SAMIHOM3",628,0)
 ;
"RTN","SAMIHOM3",629,0)
 ;
"RTN","SAMIHOM3",630,0)
EOR ; end of routine SAMIHOM3
"RTN","SAMIHOM4")
0^7^B899962251
"RTN","SAMIHOM4",1,0)
SAMIHOM4 ;ven/gpl,arc - homepage web services ;2021-06-16t18:09z
"RTN","SAMIHOM4",2,0)
 ;;18.0;SAMI;**1,4,5,6,9,12**;;Build 6
"RTN","SAMIHOM4",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIHOM4",4,0)
 ;
"RTN","SAMIHOM4",5,0)
 ; SAMIHOM4 contains web services & other subroutines for producing
"RTN","SAMIHOM4",6,0)
 ; the ELCAP Home Page.
"RTN","SAMIHOM4",7,0)
 ;
"RTN","SAMIHOM4",8,0)
 quit  ; no entry from top
"RTN","SAMIHOM4",9,0)
 ;
"RTN","SAMIHOM4",10,0)
 ;
"RTN","SAMIHOM4",11,0)
 ;
"RTN","SAMIHOM4",12,0)
 ;@section 0 primary development
"RTN","SAMIHOM4",13,0)
 ;
"RTN","SAMIHOM4",14,0)
 ;
"RTN","SAMIHOM4",15,0)
 ;
"RTN","SAMIHOM4",16,0)
 ;@license see routine SAMIUL
"RTN","SAMIHOM4",17,0)
 ;@documentation see SAMIHUL
"RTN","SAMIHOM4",18,0)
 ;@contents
"RTN","SAMIHOM4",19,0)
 ;
"RTN","SAMIHOM4",20,0)
 ;  web service get vapals & related subroutines
"RTN","SAMIHOM4",21,0)
 ;
"RTN","SAMIHOM4",22,0)
 ; WSHOME code for wsi WSHOME^SAMIHOM3
"RTN","SAMIHOM4",23,0)
 ;    get vapals (vapals-elcap homepage)
"RTN","SAMIHOM4",24,0)
 ; DEVHOME code for wpi DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",25,0)
 ;    development home page
"RTN","SAMIHOM4",26,0)
 ; GETHOME code for wpi GETHOME^SAMIHOM3
"RTN","SAMIHOM4",27,0)
 ;    get homepage (not subsequent visit)
"RTN","SAMIHOM4",28,0)
 ;
"RTN","SAMIHOM4",29,0)
 ;  web service post vapals & related subroutines
"RTN","SAMIHOM4",30,0)
 ;
"RTN","SAMIHOM4",31,0)
 ; WSVAPALS code for wsi WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",32,0)
 ;    post vapals (main gateway)
"RTN","SAMIHOM4",33,0)
 ;
"RTN","SAMIHOM4",34,0)
 ;  other
"RTN","SAMIHOM4",35,0)
 ;
"RTN","SAMIHOM4",36,0)
 ; REG: manual registration
"RTN","SAMIHOM4",37,0)
 ; MKPTLK: creates patient-lookup record
"RTN","SAMIHOM4",38,0)
 ; UPDTFRMS: update demographics in all forms for patient
"RTN","SAMIHOM4",39,0)
 ; MERGE: merge participant records
"RTN","SAMIHOM4",40,0)
 ; ADDUNMAT: adds unmatched report web service to system
"RTN","SAMIHOM4",41,0)
 ; DELUNMAT: deletes unmatched web service
"RTN","SAMIHOM4",42,0)
 ; WSUNMAT: navigates to unmatched report
"RTN","SAMIHOM4",43,0)
 ; $$DUPSSN = true if duplicate ssn
"RTN","SAMIHOM4",44,0)
 ; $$DUPICN = true if duplicate icn
"RTN","SAMIHOM4",45,0)
 ; $$BADICN = true if ICN checkdigits are wrong
"RTN","SAMIHOM4",46,0)
 ; SAVE: save patient-lookup record after edit
"RTN","SAMIHOM4",47,0)
 ; $$REMATCH = possible match ien
"RTN","SAMIHOM4",48,0)
 ; SETINFO: set information message text
"RTN","SAMIHOM4",49,0)
 ; SETWARN: set warning message text
"RTN","SAMIHOM4",50,0)
 ; RTNERR: redisplay page w/error message
"RTN","SAMIHOM4",51,0)
 ; RTNPAGE: display page
"RTN","SAMIHOM4",52,0)
 ; REINDXPL: reindex patient lookup
"RTN","SAMIHOM4",53,0)
 ; INDXPTLK: generate index entries in patient-lookup graph
"RTN","SAMIHOM4",54,0)
 ; UNINDXPT: remove index entries from patient-lookup graph
"RTN","SAMIHOM4",55,0)
 ; $$UCASE = uppercase
"RTN","SAMIHOM4",56,0)
 ; WSNEWCAS code for wr newcase (creates new case)
"RTN","SAMIHOM4",57,0)
 ;
"RTN","SAMIHOM4",58,0)
 ;@to-do
"RTN","SAMIHOM4",59,0)
 ; Add label comments
"RTN","SAMIHOM4",60,0)
 ;
"RTN","SAMIHOM4",61,0)
 ;
"RTN","SAMIHOM4",62,0)
 ;
"RTN","SAMIHOM4",63,0)
 ;@section 1 web service get vapals & related subroutines
"RTN","SAMIHOM4",64,0)
 ;
"RTN","SAMIHOM4",65,0)
 ;
"RTN","SAMIHOM4",66,0)
 ;
"RTN","SAMIHOM4",67,0)
 ;@wsi-code WSHOME^SAMIHOM3
"RTN","SAMIHOM4",68,0)
WSHOME ; get vapals (vapals-elcap homepage)
"RTN","SAMIHOM4",69,0)
 ;
"RTN","SAMIHOM4",70,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",71,0)
 ;
"RTN","SAMIHOM4",72,0)
 ;ven/gpl;wsi;procedure;clean;silent;sac;tests
"RTN","SAMIHOM4",73,0)
 ;@signature
"RTN","SAMIHOM4",74,0)
 ; do WSHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",75,0)
 ;@branches-from
"RTN","SAMIHOM4",76,0)
 ; WSHOME^SAMIHOM3
"RTN","SAMIHOM4",77,0)
 ;@wsi-called-by
"RTN","SAMIHOM4",78,0)
 ; web service get vapals
"RTN","SAMIHOM4",79,0)
 ; WSVAPALS^SAMIHOM4
"RTN","SAMIHOM4",80,0)
 ; LOGIN^SAMISITE
"RTN","SAMIHOM4",81,0)
 ;@called-by none
"RTN","SAMIHOM4",82,0)
 ;@calls
"RTN","SAMIHOM4",83,0)
 ; DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",84,0)
 ; WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",85,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMIHOM4",86,0)
 ;@input
"RTN","SAMIHOM4",87,0)
 ; SAMIFILTER (no parameters required)
"RTN","SAMIHOM4",88,0)
 ;@output
"RTN","SAMIHOM4",89,0)
 ; .SAMIRTN
"RTN","SAMIHOM4",90,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",91,0)
 ;@tests
"RTN","SAMIHOM4",92,0)
 ; UTWSHM^SAMIUTH3
"RTN","SAMIHOM4",93,0)
 ; UTWSHM1^SAMIUTH3
"RTN","SAMIHOM4",94,0)
 ; UTWSHM2^SAMIUTH3
"RTN","SAMIHOM4",95,0)
 ;
"RTN","SAMIHOM4",96,0)
 ;
"RTN","SAMIHOM4",97,0)
 ;@stanza 2 route to appropriate homepage or bypass to other webpage
"RTN","SAMIHOM4",98,0)
 ;
"RTN","SAMIHOM4",99,0)
 ; present development homepage for testing
"RTN","SAMIHOM4",100,0)
 if $get(SAMIFILTER("test"))=1 do  quit
"RTN","SAMIHOM4",101,0)
 . do DEVHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER)
"RTN","SAMIHOM4",102,0)
 . quit
"RTN","SAMIHOM4",103,0)
 ;
"RTN","SAMIHOM4",104,0)
 ; bypass for get access to pages
"RTN","SAMIHOM4",105,0)
 if $g(SAMIFILTER("samiroute"))'="" do  quit
"RTN","SAMIHOM4",106,0)
 . new SAMIBODY set SAMIBODY(1)=""
"RTN","SAMIHOM4",107,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",108,0)
 . quit
"RTN","SAMIHOM4",109,0)
 ;
"RTN","SAMIHOM4",110,0)
 ; V4W/DLW - bypass for get access from CPRS
"RTN","SAMIHOM4",111,0)
 if $get(SAMIFILTER("dfn"))'="" do  quit
"RTN","SAMIHOM4",112,0)
 . new dfn set dfn=$get(SAMIFILTER("dfn"))
"RTN","SAMIHOM4",113,0)
 . new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",114,0)
 . new studyid set studyid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIHOM4",115,0)
 . new SAMIBODY
"RTN","SAMIHOM4",116,0)
 . if studyid'="" do
"RTN","SAMIHOM4",117,0)
 . . set SAMIBODY(1)="samiroute=casereview&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",118,0)
 . . quit
"RTN","SAMIHOM4",119,0)
 . else  do
"RTN","SAMIHOM4",120,0)
 . . set SAMIBODY(1)="samiroute=lookup&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",121,0)
 . . quit
"RTN","SAMIHOM4",122,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",123,0)
 . quit
"RTN","SAMIHOM4",124,0)
 ;
"RTN","SAMIHOM4",125,0)
 ; default to VAPALS homepage
"RTN","SAMIHOM4",126,0)
 do GETHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER)
"RTN","SAMIHOM4",127,0)
 ;
"RTN","SAMIHOM4",128,0)
 ;
"RTN","SAMIHOM4",129,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",130,0)
 ;
"RTN","SAMIHOM4",131,0)
 quit  ; end of wsi WSHOME^SAMIHOM3
"RTN","SAMIHOM4",132,0)
 ;
"RTN","SAMIHOM4",133,0)
 ;
"RTN","SAMIHOM4",134,0)
 ;
"RTN","SAMIHOM4",135,0)
 ;@wpi-code DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",136,0)
DEVHOME ; development home page
"RTN","SAMIHOM4",137,0)
 ;
"RTN","SAMIHOM4",138,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",139,0)
 ;
"RTN","SAMIHOM4",140,0)
 ;ven/gpl;wpi;procedure;clean;silent;sac;tests
"RTN","SAMIHOM4",141,0)
 ;@signature
"RTN","SAMIHOM4",142,0)
 ; do DEVHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",143,0)
 ;@branches-from
"RTN","SAMIHOM4",144,0)
 ; DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",145,0)
 ;@wpi-called-by
"RTN","SAMIHOM4",146,0)
 ; wsi WSHOME^SAMIHOM3 [web service get vapals]
"RTN","SAMIHOM4",147,0)
 ;@called-by none
"RTN","SAMIHOM4",148,0)
 ;@calls
"RTN","SAMIHOM4",149,0)
 ; htmltb2^%yottaweb
"RTN","SAMIHOM4",150,0)
 ; PATLIST^SAMIHOM3
"RTN","SAMIHOM4",151,0)
 ; genhtml^%yottautl
"RTN","SAMIHOM4",152,0)
 ; addary^%yottautl
"RTN","SAMIHOM4",153,0)
 ;@input
"RTN","SAMIHOM4",154,0)
 ; SAMIFILTER =
"RTN","SAMIHOM4",155,0)
 ;@output
"RTN","SAMIHOM4",156,0)
 ;.SAMIRTN =
"RTN","SAMIHOM4",157,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",158,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",159,0)
 ;
"RTN","SAMIHOM4",160,0)
 ;
"RTN","SAMIHOM4",161,0)
 ;@stanza 2 present development homepage
"RTN","SAMIHOM4",162,0)
 ;
"RTN","SAMIHOM4",163,0)
 new gtop,gbot
"RTN","SAMIHOM4",164,0)
 do htmltb2^%yottaweb(.gtop,.gbot,"SAMI Test Patients")
"RTN","SAMIHOM4",165,0)
 ;
"RTN","SAMIHOM4",166,0)
 new html,ary,hpat
"RTN","SAMIHOM4",167,0)
 do PATLIST^SAMIHOM3("hpat")
"RTN","SAMIHOM4",168,0)
 quit:'$data(hpat)
"RTN","SAMIHOM4",169,0)
 ;
"RTN","SAMIHOM4",170,0)
 set ary("title")="SAMI Test Patients on this system"
"RTN","SAMIHOM4",171,0)
 set ary("header",1)="StudyId"
"RTN","SAMIHOM4",172,0)
 set ary("header",2)="Name"
"RTN","SAMIHOM4",173,0)
 ;
"RTN","SAMIHOM4",174,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",175,0)
 new zi set zi=""
"RTN","SAMIHOM4",176,0)
 for  do  quit:zi=""
"RTN","SAMIHOM4",177,0)
 . set zi=$order(hpat(zi))
"RTN","SAMIHOM4",178,0)
 . quit:zi=""
"RTN","SAMIHOM4",179,0)
 . ;
"RTN","SAMIHOM4",180,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",181,0)
 . new url set url="<a href=""/cform.cgi?studyId="_zi_""">"_zi_"</a>"
"RTN","SAMIHOM4",182,0)
 . set ary(cnt,1)=url
"RTN","SAMIHOM4",183,0)
 . set ary(cnt,2)=""
"RTN","SAMIHOM4",184,0)
 . quit
"RTN","SAMIHOM4",185,0)
 ;
"RTN","SAMIHOM4",186,0)
 do genhtml^%yottautl("html","ary")
"RTN","SAMIHOM4",187,0)
 ;
"RTN","SAMIHOM4",188,0)
 do addary^%yottautl("SAMIRTN","gtop")
"RTN","SAMIHOM4",189,0)
 do addary^%yottautl("SAMIRTN","html")
"RTN","SAMIHOM4",190,0)
 set SAMIRTN($order(SAMIRTN(""),-1)+1)=gbot
"RTN","SAMIHOM4",191,0)
 kill SAMIRTN(0)
"RTN","SAMIHOM4",192,0)
 ;
"RTN","SAMIHOM4",193,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMIHOM4",194,0)
 ;
"RTN","SAMIHOM4",195,0)
 ;
"RTN","SAMIHOM4",196,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",197,0)
 ;
"RTN","SAMIHOM4",198,0)
 quit  ; end of wpi DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",199,0)
 ;
"RTN","SAMIHOM4",200,0)
 ;
"RTN","SAMIHOM4",201,0)
 ;
"RTN","SAMIHOM4",202,0)
 ;@wpi-code GETHOME^SAMIHOM3
"RTN","SAMIHOM4",203,0)
GETHOME ; get homepage (not subsequent visit)
"RTN","SAMIHOM4",204,0)
 ;
"RTN","SAMIHOM4",205,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",206,0)
 ;
"RTN","SAMIHOM4",207,0)
 ;ven/gpl;wpi;procedure;clean;silent;sac;tests
"RTN","SAMIHOM4",208,0)
 ;@signature
"RTN","SAMIHOM4",209,0)
 ; do GETHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",210,0)
 ;@branches-from
"RTN","SAMIHOM4",211,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMIHOM4",212,0)
 ;@wpi-called-by
"RTN","SAMIHOM4",213,0)
 ; WSHOME
"RTN","SAMIHOM4",214,0)
 ; WSVAPALS
"RTN","SAMIHOM4",215,0)
 ; SAVE
"RTN","SAMIHOM4",216,0)
 ;  WSNEWCAS [commented out]
"RTN","SAMIHOM4",217,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMIHOM4",218,0)
 ; WSLOOKUP^SAMISRC2
"RTN","SAMIHOM4",219,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIHOM4",220,0)
 ; WSREPORT^SAMIUR1
"RTN","SAMIHOM4",221,0)
 ;@called-by none
"RTN","SAMIHOM4",222,0)
 ;@calls
"RTN","SAMIHOM4",223,0)
 ; $$FINDSITE^SAMISITE
"RTN","SAMIHOM4",224,0)
 ; GETTMPL^SAMICASE
"RTN","SAMIHOM4",225,0)
 ; MERGEHTM^%wf
"RTN","SAMIHOM4",226,0)
 ; ADDCRLF^VPRJRUT
"RTN","SAMIHOM4",227,0)
 ;@input
"RTN","SAMIHOM4",228,0)
 ; SAMIFILTER
"RTN","SAMIHOM4",229,0)
 ;@output
"RTN","SAMIHOM4",230,0)
 ; .SAMIRTN
"RTN","SAMIHOM4",231,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",232,0)
 ;@tests
"RTN","SAMIHOM4",233,0)
 ; UTGETHM^SAMIUTH3
"RTN","SAMIHOM4",234,0)
 ; UTSCAN4^SAMIUTH3
"RTN","SAMIHOM4",235,0)
 ;
"RTN","SAMIHOM4",236,0)
 ;
"RTN","SAMIHOM4",237,0)
 ;@stanza 2 get template for homepage
"RTN","SAMIHOM4",238,0)
 ;
"RTN","SAMIHOM4",239,0)
 ; Processing for multi-tenancy
"RTN","SAMIHOM4",240,0)
 ;
"RTN","SAMIHOM4",241,0)
 if $get(SAMIFILTER("siteid"))="" if '$$FINDSITE^SAMISITE(.SAMIRTN,.SAMIFILTER) quit 0
"RTN","SAMIHOM4",242,0)
 new SAMISITE,SAMITITL
"RTN","SAMIHOM4",243,0)
 set SAMISITE=$get(SAMIFILTER("siteid"))
"RTN","SAMIHOM4",244,0)
 set SAMITITL=$get(SAMIFILTER("sitetitle"))
"RTN","SAMIHOM4",245,0)
 ;
"RTN","SAMIHOM4",246,0)
 new temp,tout,form
"RTN","SAMIHOM4",247,0)
 set form="vapals:home"
"RTN","SAMIHOM4",248,0)
 do GETTMPL^SAMICASE("temp",form)
"RTN","SAMIHOM4",249,0)
 quit:'$data(temp)
"RTN","SAMIHOM4",250,0)
 ;
"RTN","SAMIHOM4",251,0)
 ;
"RTN","SAMIHOM4",252,0)
 ;@stanza 3 process homepage template
"RTN","SAMIHOM4",253,0)
 ;
"RTN","SAMIHOM4",254,0)
 new err
"RTN","SAMIHOM4",255,0)
 do MERGEHTM^%wf(.temp,.SAMIFILTER,.err)
"RTN","SAMIHOM4",256,0)
 ;
"RTN","SAMIHOM4",257,0)
 do ADDCRLF^VPRJRUT(.temp)
"RTN","SAMIHOM4",258,0)
 merge SAMIRTN=temp
"RTN","SAMIHOM4",259,0)
 ;
"RTN","SAMIHOM4",260,0)
 ;
"RTN","SAMIHOM4",261,0)
 ;@stanza 4 termination
"RTN","SAMIHOM4",262,0)
 ;
"RTN","SAMIHOM4",263,0)
 quit  ; end of wpi GETHOME^SAMIHOM3
"RTN","SAMIHOM4",264,0)
 ;
"RTN","SAMIHOM4",265,0)
 ;
"RTN","SAMIHOM4",266,0)
 ;
"RTN","SAMIHOM4",267,0)
 ; below is redacted from GETHOME^SAMIHOM3
"RTN","SAMIHOM4",268,0)
 ;
"RTN","SAMIHOM4",269,0)
 ;@old-calls
"RTN","SAMIHOM4",270,0)
 ; FIXHREF^SAMIFORM
"RTN","SAMIHOM4",271,0)
 ; FIXSRC^SAMIFORM
"RTN","SAMIHOM4",272,0)
 ; $$GET^XPAR
"RTN","SAMIHOM4",273,0)
 ; findReplace^%ts
"RTN","SAMIHOM4",274,0)
 ; ADDCRLF^VPRJRUT
"RTN","SAMIHOM4",275,0)
 ;
"RTN","SAMIHOM4",276,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",277,0)
 new zi set zi=0
"RTN","SAMIHOM4",278,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMIHOM4",279,0)
 . ;
"RTN","SAMIHOM4",280,0)
 . n ln s ln=temp(zi)
"RTN","SAMIHOM4",281,0)
 . n touched s touched=0
"RTN","SAMIHOM4",282,0)
 . ;
"RTN","SAMIHOM4",283,0)
 . i ln["href" i 'touched d  ;
"RTN","SAMIHOM4",284,0)
 . . d FIXHREF^SAMIFORM(.ln)
"RTN","SAMIHOM4",285,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",286,0)
 . ;
"RTN","SAMIHOM4",287,0)
 . i ln["src" d  ;
"RTN","SAMIHOM4",288,0)
 . . d FIXSRC^SAMIFORM(.ln)
"RTN","SAMIHOM4",289,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",290,0)
 . ;
"RTN","SAMIHOM4",291,0)
 . i ln["id" i ln["studyIdMenu" d  ;
"RTN","SAMIHOM4",292,0)
 . . s zi=zi+4
"RTN","SAMIHOM4",293,0)
 . ;
"RTN","SAMIHOM4",294,0)
 . if ln["@@MANUALREGISTRATION@@" do  ; turn off manual registration
"RTN","SAMIHOM4",295,0)
 . . n setman,setparm
"RTN","SAMIHOM4",296,0)
 . . s setman="true"
"RTN","SAMIHOM4",297,0)
 . . s setparm=$$GET^XPAR("SYS","SAMI ALLOW MANUAL ENTRY",,"Q")
"RTN","SAMIHOM4",298,0)
 . . i setparm=0 s setman="false"
"RTN","SAMIHOM4",299,0)
 . . do findReplace^%ts(.ln,"@@MANUALREGISTRATION@@",setman)
"RTN","SAMIHOM4",300,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",301,0)
 . . quit 
"RTN","SAMIHOM4",302,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",303,0)
 . set tout(cnt)=temp(zi)
"RTN","SAMIHOM4",304,0)
 . quit
"RTN","SAMIHOM4",305,0)
 ;
"RTN","SAMIHOM4",306,0)
 ;
"RTN","SAMIHOM4",307,0)
 ;@old-stanza 4 add cr/lf & save to return array
"RTN","SAMIHOM4",308,0)
 ;
"RTN","SAMIHOM4",309,0)
 do ADDCRLF^VPRJRUT(.tout)
"RTN","SAMIHOM4",310,0)
 merge SAMIRTN=tout
"RTN","SAMIHOM4",311,0)
 ;
"RTN","SAMIHOM4",312,0)
 ;
"RTN","SAMIHOM4",313,0)
 ;@old-stanza 5 termination
"RTN","SAMIHOM4",314,0)
 ;
"RTN","SAMIHOM4",315,0)
 quit  ; old end of wpi GETHOME^SAMIHOM3
"RTN","SAMIHOM4",316,0)
 ;
"RTN","SAMIHOM4",317,0)
 ;
"RTN","SAMIHOM4",318,0)
 ;
"RTN","SAMIHOM4",319,0)
 ;@section 2 web service post vapals & related subroutines
"RTN","SAMIHOM4",320,0)
 ;
"RTN","SAMIHOM4",321,0)
 ;
"RTN","SAMIHOM4",322,0)
 ;
"RTN","SAMIHOM4",323,0)
 ;@wsi-code WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",324,0)
WSVAPALS ; post vapals (main gateway)
"RTN","SAMIHOM4",325,0)
 ;
"RTN","SAMIHOM4",326,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",327,0)
 ;
"RTN","SAMIHOM4",328,0)
 ;ven/gpl;wsi;procedure;clean;silent;sac;tests
"RTN","SAMIHOM4",329,0)
 ;@signature
"RTN","SAMIHOM4",330,0)
 ; do WSVAPALS^SAMIHOM3(SAMIARG,SAMIBODY,SAMIRESULT)
"RTN","SAMIHOM4",331,0)
 ;@branches-from
"RTN","SAMIHOM4",332,0)
 ; WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",333,0)
 ;@wsi-called-by
"RTN","SAMIHOM4",334,0)
 ;@called-by
"RTN","SAMIHOM4",335,0)
 ;@calls
"RTN","SAMIHOM4",336,0)
 ;@input [tbd]
"RTN","SAMIHOM4",337,0)
 ;@output [tbd]
"RTN","SAMIHOM4",338,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",339,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",340,0)
 ;
"RTN","SAMIHOM4",341,0)
 ; all calls come through this gateway
"RTN","SAMIHOM4",342,0)
 ;
"RTN","SAMIHOM4",343,0)
 k ^SAMIUL("vapals")
"RTN","SAMIHOM4",344,0)
 m ^SAMIUL("vapals")=SAMIARG
"RTN","SAMIHOM4",345,0)
 m ^SAMIUL("vapals","BODY")=SAMIBODY
"RTN","SAMIHOM4",346,0)
 ;
"RTN","SAMIHOM4",347,0)
 new vars,SAMIBDY
"RTN","SAMIHOM4",348,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",349,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",350,0)
 m vars=SAMIARG
"RTN","SAMIHOM4",351,0)
 i $g(vars("siteid"))'="" d  ;
"RTN","SAMIHOM4",352,0)
 . i $g(vars("site"))'=$g(vars("siteid")) s vars("site")=$g(vars("siteid"))
"RTN","SAMIHOM4",353,0)
 m SAMIARG=vars
"RTN","SAMIHOM4",354,0)
 m SAMIARG=SAMIBODY
"RTN","SAMIHOM4",355,0)
 ;
"RTN","SAMIHOM4",356,0)
 ; Processing for multi-tenancy
"RTN","SAMIHOM4",357,0)
 ;
"RTN","SAMIHOM4",358,0)
 if '$d(vars("siteid")) d  ;
"RTN","SAMIHOM4",359,0)
 . if $g(vars("studyid"))="" q
"RTN","SAMIHOM4",360,0)
 . n sym s sym=$e(vars("studyid"),1,3) ; first 3 chars in studyid
"RTN","SAMIHOM4",361,0)
 . i $$SITENM2^SAMISITE(sym)=-1 q
"RTN","SAMIHOM4",362,0)
 . s vars("siteid")=sym
"RTN","SAMIHOM4",363,0)
 . s vars("site")=sym
"RTN","SAMIHOM4",364,0)
 ;
"RTN","SAMIHOM4",365,0)
 if $G(vars("site"))'="" d  ;
"RTN","SAMIHOM4",366,0)
 . n siteid s siteid=vars("site")
"RTN","SAMIHOM4",367,0)
 . s SAMIARG("siteid")=siteid
"RTN","SAMIHOM4",368,0)
 . s SAMIARG("sitetitle")=$$SITENM2^SAMISITE(siteid)_" - "_siteid
"RTN","SAMIHOM4",369,0)
 k ^gpl("siteselect")
"RTN","SAMIHOM4",370,0)
 m ^gpl("siteselect")=SAMIARG
"RTN","SAMIHOM4",371,0)
 m ^gpl("siteselect","vars")=vars
"RTN","SAMIHOM4",372,0)
 if $G(SAMIARG("siteid"))="" if '$$FINDSITE^SAMISITE(.SAMIRESULT,.SAMIARG) Q 0
"RTN","SAMIHOM4",373,0)
 new SAMISITE,SAMITITL
"RTN","SAMIHOM4",374,0)
 s SAMISITE=$G(SAMIARG("siteid"))
"RTN","SAMIHOM4",375,0)
 i $G(SAMIARG("sitetitle"))="" d  ;
"RTN","SAMIHOM4",376,0)
 . s SAMIARG("sitetitle")=$$SITENM2^SAMISITE(SAMISITE)_" - "_SAMISITE
"RTN","SAMIHOM4",377,0)
 s SAMITITL=$G(SAMIARG("sitetitle"))
"RTN","SAMIHOM4",378,0)
 m vars=SAMIARG
"RTN","SAMIHOM4",379,0)
 ;
"RTN","SAMIHOM4",380,0)
 k ^SAMIUL("vapals","vars")
"RTN","SAMIHOM4",381,0)
 merge ^SAMIUL("vapals","vars")=vars
"RTN","SAMIHOM4",382,0)
 merge ^SAMIUL("vapals","vars")=SAMIBODY
"RTN","SAMIHOM4",383,0)
 ;
"RTN","SAMIHOM4",384,0)
 n route s route=$g(vars("samiroute"))
"RTN","SAMIHOM4",385,0)
 i route=""  d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",386,0)
 ;
"RTN","SAMIHOM4",387,0)
 i route="lookup" d  q 0
"RTN","SAMIHOM4",388,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",389,0)
 . d WSLOOKUP^SAMISRC2(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",390,0)
 ;
"RTN","SAMIHOM4",391,0)
 i route="login" d  q 0
"RTN","SAMIHOM4",392,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",393,0)
 . d LOGIN^SAMISITE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",394,0)
 ;
"RTN","SAMIHOM4",395,0)
 i route="home" d  q 0
"RTN","SAMIHOM4",396,0)
 . k ^gpl("home")
"RTN","SAMIHOM4",397,0)
 . m ^gpl("home")=SAMIARG
"RTN","SAMIHOM4",398,0)
 . s SAMIARG("samiroute")=""
"RTN","SAMIHOM4",399,0)
 . d WSHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",400,0)
 ;
"RTN","SAMIHOM4",401,0)
 i route="logout" d  q 0
"RTN","SAMIHOM4",402,0)
 . ;s SAMIARG("samiroute")="home"
"RTN","SAMIHOM4",403,0)
 . ;do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIARG,.SAMIRESULT)
"RTN","SAMIHOM4",404,0)
 . ;Q
"RTN","SAMIHOM4",405,0)
 . s SAMIARG("sitetitle")="Unknown Site"
"RTN","SAMIHOM4",406,0)
 . s SAMIARG("siteid")=""
"RTN","SAMIHOM4",407,0)
 . s SAMIARG("errorMessage")=""
"RTN","SAMIHOM4",408,0)
 . d RTNERR^SAMIHOM4(.SAMIRESULT,"vapals:login",.SAMIARG)
"RTN","SAMIHOM4",409,0)
 ;
"RTN","SAMIHOM4",410,0)
 i route="newcase" d  q 0
"RTN","SAMIHOM4",411,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",412,0)
 . d WSNEWCAS^SAMIHOM3(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",413,0)
 ;
"RTN","SAMIHOM4",414,0)
 i route="casereview" d  q 0
"RTN","SAMIHOM4",415,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",416,0)
 . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",417,0)
 ;
"RTN","SAMIHOM4",418,0)
 i route="nuform" d  q 0
"RTN","SAMIHOM4",419,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",420,0)
 . d WSNUFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",421,0)
 ;
"RTN","SAMIHOM4",422,0)
 i route="addform" d  q 0
"RTN","SAMIHOM4",423,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",424,0)
 . d WSNFPOST^SAMICASE(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",425,0)
 ;
"RTN","SAMIHOM4",426,0)
 i route="form" d  q 0
"RTN","SAMIHOM4",427,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",428,0)
 . d wsGetForm^%wf(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",429,0)
 ;
"RTN","SAMIHOM4",430,0)
 i route="postform" d  q 0
"RTN","SAMIHOM4",431,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",432,0)
 . d wsPostForm^%wf(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",433,0)
 . i $g(SAMIARG("form"))["siform" d  ;
"RTN","SAMIHOM4",434,0)
 . . n notr s notr=0 ; note return 0 if failure, 1 or greater if success
"RTN","SAMIHOM4",435,0)
 . . ; returns the ien of the note that was created and should be sent
"RTN","SAMIHOM4",436,0)
 . . s notr=$$NOTE^SAMINOT1(.SAMIARG)
"RTN","SAMIHOM4",437,0)
 . . if +notr>0 d  ;
"RTN","SAMIHOM4",438,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",439,0)
 . . . s SAMIFILTER("sid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",440,0)
 . . . s SAMIFILTER("key")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",441,0)
 . . . n tiuien
"RTN","SAMIHOM4",442,0)
 . . . s tiuien=+notr
"RTN","SAMIHOM4",443,0)
 . . . s SAMIFILTER("notenmbr")=tiuien
"RTN","SAMIHOM4",444,0)
 . . . n sendrslt
"RTN","SAMIHOM4",445,0)
 . . . ;s sendrslt="1^MSG9239010"
"RTN","SAMIHOM4",446,0)
 . . . s sendrslt=$$EN^SAMIORU(.SAMIFILTER) ; send the note to VistA
"RTN","SAMIHOM4",447,0)
 . . . i +sendrslt>0 d  ; success
"RTN","SAMIHOM4",448,0)
 . . . . n rtnid s rtnid=$p(sendrslt,"^",2) ; return id from HL7
"RTN","SAMIHOM4",449,0)
 . . . . ; post the id to the graph here
"RTN","SAMIHOM4",450,0)
 . . . . n sid s sid=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",451,0)
 . . . . n form s form=$G(SAMIARG("form"))
"RTN","SAMIHOM4",452,0)
 . . . . n nien s nien=$$NTIEN^SAMINOT1(sid,form) ; latest note ien
"RTN","SAMIHOM4",453,0)
 . . . . n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",454,0)
 . . . . s @root@("graph",sid,form,"notes",nien,"hl7id")=rtnid
"RTN","SAMIHOM4",455,0)
 . . . . s SAMIARG("errorMessage")="Note successfully sent to VistA ID: "_rtnid
"RTN","SAMIHOM4",456,0)
 . . . else  d  ;
"RTN","SAMIHOM4",457,0)
 . . . . n rtnmsg s rtnmsg=$p(sendrslt,"^",2)
"RTN","SAMIHOM4",458,0)
 . . . . s SAMIARG("errorMessage")=rtnmsg
"RTN","SAMIHOM4",459,0)
 . . . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",460,0)
 . i $g(SAMIARG("form"))["fuform" d  ;
"RTN","SAMIHOM4",461,0)
 . . n notr s notr=0 ; note return 0 if failure, 1 or greater if success
"RTN","SAMIHOM4",462,0)
 . . ; returns the ien of the note that was created and should be sent
"RTN","SAMIHOM4",463,0)
 . . s notr=$$NOTE^SAMINOT2(.SAMIARG)
"RTN","SAMIHOM4",464,0)
 . . if +notr>0 d  ;
"RTN","SAMIHOM4",465,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",466,0)
 . . . s SAMIFILTER("sid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",467,0)
 . . . s SAMIFILTER("key")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",468,0)
 . . . n tiuien
"RTN","SAMIHOM4",469,0)
 . . . s tiuien=+notr
"RTN","SAMIHOM4",470,0)
 . . . s SAMIFILTER("notenmbr")=tiuien
"RTN","SAMIHOM4",471,0)
 . . . n sendrslt
"RTN","SAMIHOM4",472,0)
 . . . ;s sendrslt="0^Missing ORM Message"
"RTN","SAMIHOM4",473,0)
 . . . s sendrslt=$$EN^SAMIORU(.SAMIFILTER) ; send the note to VistA
"RTN","SAMIHOM4",474,0)
 . . . i +sendrslt>0 d  ; success
"RTN","SAMIHOM4",475,0)
 . . . . n rtnid s rtnid=$p(sendrslt,"^",2) ; return id from HL7
"RTN","SAMIHOM4",476,0)
 . . . . ; post the id to the graph here
"RTN","SAMIHOM4",477,0)
 . . . . n sid s sid=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",478,0)
 . . . . n form s form=$G(SAMIARG("form"))
"RTN","SAMIHOM4",479,0)
 . . . . n nien s nien=$$NTIEN^SAMINOT1(sid,form) ; latest note ien
"RTN","SAMIHOM4",480,0)
 . . . . n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",481,0)
 . . . . s @root@("graph",sid,form,"notes",nien,"hl7id")=rtnid
"RTN","SAMIHOM4",482,0)
 . . . . s SAMIARG("errorMessage")="Note successfully sent to VistA ID: "_rtnid
"RTN","SAMIHOM4",483,0)
 . . . else  d  ;
"RTN","SAMIHOM4",484,0)
 . . . . n rtnmsg s rtnmsg=$p(sendrslt,"^",2)
"RTN","SAMIHOM4",485,0)
 . . . . i $g(SAMIARG("errorMessage"))="" d  ;
"RTN","SAMIHOM4",486,0)
 . . . . . s SAMIARG("errorMessage")=rtnmsg
"RTN","SAMIHOM4",487,0)
 . . . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",488,0)
 . . e  d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",489,0)
 . e  d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",490,0)
 ;
"RTN","SAMIHOM4",491,0)
 i route="deleteform" d  q 0
"RTN","SAMIHOM4",492,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",493,0)
 . d DELFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",494,0)
 ;
"RTN","SAMIHOM4",495,0)
 i route="ctreport" d  q 0
"RTN","SAMIHOM4",496,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",497,0)
 . n format s format="html"
"RTN","SAMIHOM4",498,0)
 . s format="text"
"RTN","SAMIHOM4",499,0)
 . i format="text" d WSNOTE^SAMINOT3(.SAMIRESULT,.SAMIARG) q  ;
"RTN","SAMIHOM4",500,0)
 . i format="html" d WSREPORT^SAMICTR0(.SAMIRESULT,.SAMIARG) q  ;
"RTN","SAMIHOM4",501,0)
 . ;d wsReport^SAMICTRT(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",502,0)
 ;
"RTN","SAMIHOM4",503,0)
 i route="note" d  q 0
"RTN","SAMIHOM4",504,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",505,0)
 . d WSNOTE^SAMINOT1(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",506,0)
 ;
"RTN","SAMIHOM4",507,0)
 i route="report" d  q 0
"RTN","SAMIHOM4",508,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",509,0)
 . d WSREPORT^SAMIUR(.SAMIRESULT,.vars)
"RTN","SAMIHOM4",510,0)
 ;
"RTN","SAMIHOM4",511,0)
 i route="addperson" d  q 0
"RTN","SAMIHOM4",512,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",513,0)
 . n form
"RTN","SAMIHOM4",514,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",515,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",516,0)
 ;
"RTN","SAMIHOM4",517,0)
 i route="editperson" d  q 0
"RTN","SAMIHOM4",518,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",519,0)
 . n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",520,0)
 . i dfn="" d  q  ;
"RTN","SAMIHOM4",521,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",522,0)
 . n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",523,0)
 . n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",524,0)
 . i sien="" d  q  ;
"RTN","SAMIHOM4",525,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",526,0)
 . s vars("name")=$g(@root@(sien,"saminame"))
"RTN","SAMIHOM4",527,0)
 . s tdob=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",528,0)
 . s vars("dob")=$p(tdob,"-",2)_"/"_$p(tdob,"-",3)_"/"_$p(tdob,"-",1)
"RTN","SAMIHOM4",529,0)
 . s vars("sbdob")=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",530,0)
 . s vars("gender")=$g(@root@(sien,"sex"))
"RTN","SAMIHOM4",531,0)
 . ; s vars("icn")=$g(@root@(sien,"icn"))
"RTN","SAMIHOM4",532,0)
 . n tssn s tssn=$g(@root@(sien,"ssn"))
"RTN","SAMIHOM4",533,0)
 . s vars("ssn")=$e(tssn,1,3)_"-"_$e(tssn,4,5)_"-"_$e(tssn,6,9)
"RTN","SAMIHOM4",534,0)
 . s vars("last5")=$g(@root@(sien,"last5"))
"RTN","SAMIHOM4",535,0)
 . s vars("dfn")=$g(@root@(sien,"dfn"))
"RTN","SAMIHOM4",536,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",537,0)
 . n form,err,zhtml
"RTN","SAMIHOM4",538,0)
 . s form="vapals:editparticipant"
"RTN","SAMIHOM4",539,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",540,0)
 ;
"RTN","SAMIHOM4",541,0)
 i route="register" d  q 0
"RTN","SAMIHOM4",542,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",543,0)
 . d REG^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",544,0)
 ; 
"RTN","SAMIHOM4",545,0)
 i route="editsave" d  q 0
"RTN","SAMIHOM4",546,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",547,0)
 . d SAVE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",548,0)
 ;
"RTN","SAMIHOM4",549,0)
 i route="merge" d  q 0
"RTN","SAMIHOM4",550,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",551,0)
 . d MERGE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",552,0)
 ;
"RTN","SAMIHOM4",553,0)
 quit 0  ; end of wsi WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",554,0)
 ;
"RTN","SAMIHOM4",555,0)
 ;
"RTN","SAMIHOM4",556,0)
 ;
"RTN","SAMIHOM4",557,0)
 ;@section 3 other
"RTN","SAMIHOM4",558,0)
 ;
"RTN","SAMIHOM4",559,0)
 ;
"RTN","SAMIHOM4",560,0)
 ;
"RTN","SAMIHOM4",561,0)
REG(SAMIRTN,SAMIARG) ; manual registration
"RTN","SAMIHOM4",562,0)
 ;
"RTN","SAMIHOM4",563,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",564,0)
 ;
"RTN","SAMIHOM4",565,0)
 m ^gpl("reg")=SAMIARG
"RTN","SAMIHOM4",566,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",567,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",568,0)
 s SAMIARG("errorMessage")=""
"RTN","SAMIHOM4",569,0)
 s SAMIARG("errorField")=""
"RTN","SAMIHOM4",570,0)
 ; test for duplicate ssn
"RTN","SAMIHOM4",571,0)
 ;
"RTN","SAMIHOM4",572,0)
 ;i $$DUPSSN(ssn) d  ;
"RTN","SAMIHOM4",573,0)
 ;. ;s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN."
"RTN","SAMIHOM4",574,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN error. A person with that SSN is already entered in the system."
"RTN","SAMIHOM4",575,0)
 ;. s SAMIARG("errorField")="ssn"
"RTN","SAMIHOM4",576,0)
 ;
"RTN","SAMIHOM4",577,0)
 ; test for duplicate icn
"RTN","SAMIHOM4",578,0)
 ;
"RTN","SAMIHOM4",579,0)
 ;n icn s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",580,0)
 ;i icn'="" i $$DUPICN(icn) d  ;
"RTN","SAMIHOM4",581,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate ICN error. A person with that ICN is already entered in the system."
"RTN","SAMIHOM4",582,0)
 ;. s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",583,0)
 ;;
"RTN","SAMIHOM4",584,0)
 ;; test for wellformed ICN
"RTN","SAMIHOM4",585,0)
 ;;
"RTN","SAMIHOM4",586,0)
 ;i icn'="" i $$BADICN(icn) d  ;
"RTN","SAMIHOM4",587,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Invalid ICN error. The check digits in the ICN do not match"
"RTN","SAMIHOM4",588,0)
 ;. s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",589,0)
 ;;
"RTN","SAMIHOM4",590,0)
 ; if there is an error, send back to edit with error message
"RTN","SAMIHOM4",591,0)
 i $g(SAMIARG("errorMessage"))'="" d  q  ;
"RTN","SAMIHOM4",592,0)
 . n form
"RTN","SAMIHOM4",593,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",594,0)
 . d RTNERR(.SAMIRESULT,form,.SAMIARG)
"RTN","SAMIHOM4",595,0)
 ;
"RTN","SAMIHOM4",596,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",597,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",598,0)
 n ptlkien s ptlkien=""
"RTN","SAMIHOM4",599,0)
 n dfn s dfn=""
"RTN","SAMIHOM4",600,0)
 n sien s sien=""
"RTN","SAMIHOM4",601,0)
 i ptlkien="" s ptlkien=$o(@root@("AAAAAA"),-1)+1
"RTN","SAMIHOM4",602,0)
 n zm
"RTN","SAMIHOM4",603,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",604,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",605,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",606,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",607,0)
 d MKPTLK(ptlkien,.SAMIARG) ; make the patient-lookup record
"RTN","SAMIHOM4",608,0)
 ;
"RTN","SAMIHOM4",609,0)
 s dfn=$o(@root@("dfn"," "),-1)+1
"RTN","SAMIHOM4",610,0)
 n pdfn
"RTN","SAMIHOM4",611,0)
 s pdfn=$o(@proot@("dfn"," "),-1)+1
"RTN","SAMIHOM4",612,0)
 i pdfn>dfn s dfn=pdfn ; need a dfn that has not been used
"RTN","SAMIHOM4",613,0)
 i dfn<9000001 s dfn=9000001
"RTN","SAMIHOM4",614,0)
 s @root@(ptlkien,"dfn")=dfn
"RTN","SAMIHOM4",615,0)
 d INDXPTLK(ptlkien)
"RTN","SAMIHOM4",616,0)
 s SAMIFILTER("samiroute")="addperson"
"RTN","SAMIHOM4",617,0)
 s SAMIFILTER("siteid")=$G(SAMIARG("siteid"))
"RTN","SAMIHOM4",618,0)
 s SAMIFILTER("sitetitle")=$G(SAMIARG("sitetitle"))
"RTN","SAMIHOM4",619,0)
 k SAMIARG ; return to a blank manual registration form
"RTN","SAMIHOM4",620,0)
 s SAMIARG("siteid")=$G(SAMIFILTER("siteid"))
"RTN","SAMIHOM4",621,0)
 s SAMIARG("sitetitle")=$G(SAMIFILTER("sitetitle"))
"RTN","SAMIHOM4",622,0)
 d SETINFO(.SAMIFILTER,name_" was successfully entered")
"RTN","SAMIHOM4",623,0)
 ;d SETWARN(.SAMIFILTER,"We might want to give you a warning")
"RTN","SAMIHOM4",624,0)
 do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIARG,.SAMIRESULT)
"RTN","SAMIHOM4",625,0)
 ;
"RTN","SAMIHOM4",626,0)
 quit  ; end of REG
"RTN","SAMIHOM4",627,0)
 ;
"RTN","SAMIHOM4",628,0)
 ;
"RTN","SAMIHOM4",629,0)
 ;
"RTN","SAMIHOM4",630,0)
MKPTLK(ptlkien,SAMIARG) ; creates patient-lookup record
"RTN","SAMIHOM4",631,0)
 ;
"RTN","SAMIHOM4",632,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",633,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",634,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",635,0)
 n sinamef,sinamel
"RTN","SAMIHOM4",636,0)
 s sinamel=$p(name,","),sinamel=$$TRIM^XLFSTR(sinamel,"LR")
"RTN","SAMIHOM4",637,0)
 s sinamef=$p(name,",",2),sinamef=$$TRIM^XLFSTR(sinamef,"LR")
"RTN","SAMIHOM4",638,0)
 s name=sinamel_","_sinamef
"RTN","SAMIHOM4",639,0)
 n siteid s siteid=$g(SAMIARG("siteid"))
"RTN","SAMIHOM4",640,0)
 i siteid="" s siteid=$g(SAMIARG("site"))
"RTN","SAMIHOM4",641,0)
 ;
"RTN","SAMIHOM4",642,0)
 s @root@(ptlkien,"siteid")=siteid
"RTN","SAMIHOM4",643,0)
 s @root@(ptlkien,"saminame")=name
"RTN","SAMIHOM4",644,0)
 s @root@(ptlkien,"sinamef")=sinamef
"RTN","SAMIHOM4",645,0)
 s @root@(ptlkien,"sinamel")=sinamel
"RTN","SAMIHOM4",646,0)
 n fmdob s fmdob=$$FMDT^SAMIUR2(SAMIARG("dob"))
"RTN","SAMIHOM4",647,0)
 n ptlkdob s ptlkdob=$$FMTE^XLFDT(fmdob,7)
"RTN","SAMIHOM4",648,0)
 s ptlkdob=$TR(ptlkdob,"/","-")
"RTN","SAMIHOM4",649,0)
 s @root@(ptlkien,"dob")=ptlkdob
"RTN","SAMIHOM4",650,0)
 s @root@(ptlkien,"sbdob")=ptlkdob
"RTN","SAMIHOM4",651,0)
 n gender s gender=SAMIARG("gender")
"RTN","SAMIHOM4",652,0)
 s @root@(ptlkien,"gender")=$s(gender="M":"M^MALE",1:"F^FEMALE")
"RTN","SAMIHOM4",653,0)
 s @root@(ptlkien,"sex")=SAMIARG("gender")
"RTN","SAMIHOM4",654,0)
 ; s @root@(ptlkien,"icn")=SAMIARG("icn")
"RTN","SAMIHOM4",655,0)
 s @root@(ptlkien,"ssn")=ssn
"RTN","SAMIHOM4",656,0)
 n last5 s last5=$$UCASE($e(name,1))_$e(ssn,6,9)
"RTN","SAMIHOM4",657,0)
 s @root@(ptlkien,"last5")=last5
"RTN","SAMIHOM4",658,0)
 n mymatch s mymatch=$g(SAMIARG("MATCHLOG"))
"RTN","SAMIHOM4",659,0)
 i mymatch'="" s @root@(ptlkien,"MATCHLOG")=mymatch
"RTN","SAMIHOM4",660,0)
 ;
"RTN","SAMIHOM4",661,0)
 quit  ; end of MKPTLK
"RTN","SAMIHOM4",662,0)
 ;
"RTN","SAMIHOM4",663,0)
 ;
"RTN","SAMIHOM4",664,0)
 ;
"RTN","SAMIHOM4",665,0)
UPDTFRMS(dfn) ; update demographics in all forms for patient
"RTN","SAMIHOM4",666,0)
 ;
"RTN","SAMIHOM4",667,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",668,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",669,0)
 n lien s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM4",670,0)
 q:lien=""
"RTN","SAMIHOM4",671,0)
 n pien s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIHOM4",672,0)
 q:pien=""
"RTN","SAMIHOM4",673,0)
 ; this patient has forms
"RTN","SAMIHOM4",674,0)
 m @proot@(pien)=@lroot@(lien) ; refresh the demos in the patient record
"RTN","SAMIHOM4",675,0)
 n ssn s ssn=$g(@proot@(pien,"ssn"))
"RTN","SAMIHOM4",676,0)
 s @proot@(pien,"sissn")=$e(ssn,1,3)_"-"_$e(ssn,4,5)_"-"_$e(ssn,6,9)
"RTN","SAMIHOM4",677,0)
 n sid s sid=$g(@proot@("sisid")) ; studyid 
"RTN","SAMIHOM4",678,0)
 q:sid=""  ; no studyid
"RTN","SAMIHOM4",679,0)
 n zi s zi=""
"RTN","SAMIHOM4",680,0)
 f  s zi=$o(@proot@("graph",sid,zi)) q:zi=""  d  ; for each form
"RTN","SAMIHOM4",681,0)
 . m @proot@("graph",sid,zi)=@proot@(pien) ; stamp each form with new demos
"RTN","SAMIHOM4",682,0)
 ;
"RTN","SAMIHOM4",683,0)
 quit  ; end of UPDTFRMS
"RTN","SAMIHOM4",684,0)
 ;
"RTN","SAMIHOM4",685,0)
 ;
"RTN","SAMIHOM4",686,0)
 ;
"RTN","SAMIHOM4",687,0)
MERGE(SAMIRESULT,SAMIARGS) ; merge participant records
"RTN","SAMIHOM4",688,0)
 ;
"RTN","SAMIHOM4",689,0)
 ; called from pressing the merge button on the unmatched report
"RTN","SAMIHOM4",690,0)
 ;
"RTN","SAMIHOM4",691,0)
 n toien s toien=$g(SAMIARGS("toien"))
"RTN","SAMIHOM4",692,0)
 i toien="" d  q  ;
"RTN","SAMIHOM4",693,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",694,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",695,0)
 n fromien s fromien=$g(@lroot@(toien,"MATCHLOG"))
"RTN","SAMIHOM4",696,0)
 i fromien="" d  q  ;
"RTN","SAMIHOM4",697,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",698,0)
 ;
"RTN","SAMIHOM4",699,0)
 ; test for remotedfn in from record - not valid if absent
"RTN","SAMIHOM4",700,0)
 ;
"RTN","SAMIHOM4",701,0)
 i $g(@lroot@(fromien,"remotedfn"))="" d  q  ;
"RTN","SAMIHOM4",702,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",703,0)
 ;
"RTN","SAMIHOM4",704,0)
 ; remove index entries for from and to records
"RTN","SAMIHOM4",705,0)
 ;
"RTN","SAMIHOM4",706,0)
 d UNINDXPT(fromien) ; delete index entries
"RTN","SAMIHOM4",707,0)
 d UNINDXPT(toien)
"RTN","SAMIHOM4",708,0)
 ;
"RTN","SAMIHOM4",709,0)
 ; create changelog entry in to record - contains from record
"RTN","SAMIHOM4",710,0)
 ;
"RTN","SAMIHOM4",711,0)
 m @lroot@(toien,"changelog",$$FMTE^XLFDT($$NOW^XLFDT,5))=@lroot@(fromien)
"RTN","SAMIHOM4",712,0)
 ;
"RTN","SAMIHOM4",713,0)
 ; change the dfn in the from record to the to record dfn for merging
"RTN","SAMIHOM4",714,0)
 ;
"RTN","SAMIHOM4",715,0)
 s @lroot@(fromien,"dfn")=@lroot@(toien,"dfn")
"RTN","SAMIHOM4",716,0)
 n dfn s dfn=@lroot@(toien,"dfn") ; for use in updating forms
"RTN","SAMIHOM4",717,0)
 ;
"RTN","SAMIHOM4",718,0)
 ; merge the from record to the to record
"RTN","SAMIHOM4",719,0)
 ;
"RTN","SAMIHOM4",720,0)
 m @lroot@(toien)=@lroot@(fromien)
"RTN","SAMIHOM4",721,0)
 ;
"RTN","SAMIHOM4",722,0)
 ; delete the from record
"RTN","SAMIHOM4",723,0)
 ;
"RTN","SAMIHOM4",724,0)
 k @lroot@(fromien)
"RTN","SAMIHOM4",725,0)
 ;
"RTN","SAMIHOM4",726,0)
 ; reindex the to record
"RTN","SAMIHOM4",727,0)
 ;
"RTN","SAMIHOM4",728,0)
 d INDXPTLK(toien)
"RTN","SAMIHOM4",729,0)
 ;
"RTN","SAMIHOM4",730,0)
 ; propagate the updated from record to every form
"RTN","SAMIHOM4",731,0)
 ;
"RTN","SAMIHOM4",732,0)
 d UPDTFRMS(dfn) ; updates the patient in the vapals-patient graph
"RTN","SAMIHOM4",733,0)
 ;
"RTN","SAMIHOM4",734,0)
 ; leave and return to the unmatched report
"RTN","SAMIHOM4",735,0)
 ;   note that the form and to records will no longer be in the report
"RTN","SAMIHOM4",736,0)
 ;
"RTN","SAMIHOM4",737,0)
 d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",738,0)
 ;
"RTN","SAMIHOM4",739,0)
 quit  ; end of MERGE
"RTN","SAMIHOM4",740,0)
 ;
"RTN","SAMIHOM4",741,0)
 ;
"RTN","SAMIHOM4",742,0)
 ;
"RTN","SAMIHOM4",743,0)
ADDUNMAT ; adds unmatched report web service to system
"RTN","SAMIHOM4",744,0)
 ;
"RTN","SAMIHOM4",745,0)
 d addService^%webutils("GET","unmatched","WSUNMAT^SAMIHOM4")
"RTN","SAMIHOM4",746,0)
 ;
"RTN","SAMIHOM4",747,0)
 quit  ; end of ADDUNMAT
"RTN","SAMIHOM4",748,0)
 ;
"RTN","SAMIHOM4",749,0)
 ;
"RTN","SAMIHOM4",750,0)
 ;
"RTN","SAMIHOM4",751,0)
DELUNMAT ; deletes unmatched web service
"RTN","SAMIHOM4",752,0)
 ;
"RTN","SAMIHOM4",753,0)
 d deleteService^%webutils("GET","unmatched")
"RTN","SAMIHOM4",754,0)
 ;
"RTN","SAMIHOM4",755,0)
 quit  ; end of DELUNMAT
"RTN","SAMIHOM4",756,0)
 ;
"RTN","SAMIHOM4",757,0)
 ;
"RTN","SAMIHOM4",758,0)
 ;
"RTN","SAMIHOM4",759,0)
WSUNMAT(SAMIRESULT,SAMIARGS) ; navigates to unmatched report
"RTN","SAMIHOM4",760,0)
 ; 
"RTN","SAMIHOM4",761,0)
 n filter,bdy
"RTN","SAMIHOM4",762,0)
 s bdy=""
"RTN","SAMIHOM4",763,0)
 ;s filter("siteid")="PHX"
"RTN","SAMIHOM4",764,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",765,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",766,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",767,0)
 ;
"RTN","SAMIHOM4",768,0)
 quit  ; end of WSUNMAT
"RTN","SAMIHOM4",769,0)
 ;
"RTN","SAMIHOM4",770,0)
 ;
"RTN","SAMIHOM4",771,0)
 ;
"RTN","SAMIHOM4",772,0)
DUPSSN(ssn) ; extrinsic returns true if duplicate ssn
"RTN","SAMIHOM4",773,0)
 ;
"RTN","SAMIHOM4",774,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",775,0)
 i $d(@proot@("ssn",ssn)) q 1
"RTN","SAMIHOM4",776,0)
 ;
"RTN","SAMIHOM4",777,0)
 quit 0 ; end of $$DUPSSN
"RTN","SAMIHOM4",778,0)
 ;
"RTN","SAMIHOM4",779,0)
 ;
"RTN","SAMIHOM4",780,0)
 ;
"RTN","SAMIHOM4",781,0)
DUPICN(icn) ; extrinsic returns true if duplicate icn
"RTN","SAMIHOM4",782,0)
 ;
"RTN","SAMIHOM4",783,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",784,0)
 n tmpicn s tmpicn=$p(icn,"V",1)
"RTN","SAMIHOM4",785,0)
 i $d(@proot@("icn",icn)) q 1
"RTN","SAMIHOM4",786,0)
 i $d(@proot@("icn",tmpicn)) q 1
"RTN","SAMIHOM4",787,0)
 ;
"RTN","SAMIHOM4",788,0)
 quit 0 ; end of $$DUPICN
"RTN","SAMIHOM4",789,0)
 ;
"RTN","SAMIHOM4",790,0)
 ;
"RTN","SAMIHOM4",791,0)
 ;
"RTN","SAMIHOM4",792,0)
BADICN(icn) ; extrinsic returns true if ICN checkdigits are wrong
"RTN","SAMIHOM4",793,0)
 ;
"RTN","SAMIHOM4",794,0)
 n zchk s zchk=$p(icn,"V",2)
"RTN","SAMIHOM4",795,0)
 n zicn s zicn=$p(icn,"V",1)
"RTN","SAMIHOM4",796,0)
 q:zchk="" 1
"RTN","SAMIHOM4",797,0)
 i zchk'=$$CHECKDG^MPIFSPC(zicn) q 1
"RTN","SAMIHOM4",798,0)
 ;
"RTN","SAMIHOM4",799,0)
 quit 0
"RTN","SAMIHOM4",800,0)
 ;
"RTN","SAMIHOM4",801,0)
 ;
"RTN","SAMIHOM4",802,0)
 ;
"RTN","SAMIHOM4",803,0)
SAVE(SAMIRESULT,SAMIARG) ; save patient-lookup record after edit
"RTN","SAMIHOM4",804,0)
 ;
"RTN","SAMIHOM4",805,0)
 n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",806,0)
 i dfn="" d  q  ;
"RTN","SAMIHOM4",807,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",808,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",809,0)
 n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",810,0)
 i sien="" d  q  ;
"RTN","SAMIHOM4",811,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",812,0)
 d UNINDXPT(sien) ; remove old index entries
"RTN","SAMIHOM4",813,0)
 n zm
"RTN","SAMIHOM4",814,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",815,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",816,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",817,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",818,0)
 d MKPTLK(sien,.SAMIARG) ; add the updated fields
"RTN","SAMIHOM4",819,0)
 d INDXPTLK(sien) ; create new index entries
"RTN","SAMIHOM4",820,0)
 d UPDTFRMS(dfn) ; update demographic info in all forms
"RTN","SAMIHOM4",821,0)
 n filter,bdy
"RTN","SAMIHOM4",822,0)
 s bdy=""
"RTN","SAMIHOM4",823,0)
 m filter=SAMIARG
"RTN","SAMIHOM4",824,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",825,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",826,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",827,0)
 ;
"RTN","SAMIHOM4",828,0)
 quit  ; end of SAVE
"RTN","SAMIHOM4",829,0)
 ;
"RTN","SAMIHOM4",830,0)
 ;
"RTN","SAMIHOM4",831,0)
 ;
"RTN","SAMIHOM4",832,0)
REMATCH(sien,SAMIARG) ; extrinsic returns possible match ien
"RTN","SAMIHOM4",833,0)
 ;
"RTN","SAMIHOM4",834,0)
 ; else zero
"RTN","SAMIHOM4",835,0)
 ;
"RTN","SAMIHOM4",836,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",837,0)
 n ssn,name,icn,x,y
"RTN","SAMIHOM4",838,0)
 s ssn=$g(SAMIARG("ssn"))
"RTN","SAMIHOM4",839,0)
 i ssn["-" s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",840,0)
 s name=$g(SAMIARG("saminame"))
"RTN","SAMIHOM4",841,0)
 i name="" s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",842,0)
 s name=$$UCASE(name)
"RTN","SAMIHOM4",843,0)
 ; s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",844,0)
 s x=0
"RTN","SAMIHOM4",845,0)
 i ssn'="" s x=$o(@lroot@("ssn",ssn,""))
"RTN","SAMIHOM4",846,0)
 i x=sien s x=$o(@lroot@("ssn",ssn,x))
"RTN","SAMIHOM4",847,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",848,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",849,0)
 . ;i y>9000000 s x=0
"RTN","SAMIHOM4",850,0)
 i x>0 q x
"RTN","SAMIHOM4",851,0)
 i name'="" s x=$o(@lroot@("name",name,""))
"RTN","SAMIHOM4",852,0)
 i x=sien s x=$o(@lroot@("name",name,x))
"RTN","SAMIHOM4",853,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",854,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",855,0)
 . ;i y>9000000 s x=0
"RTN","SAMIHOM4",856,0)
 i x>0 q x
"RTN","SAMIHOM4",857,0)
 ;i icn'="" s x=$o(@lroot@("icn",icn,""))
"RTN","SAMIHOM4",858,0)
 ;i x=sien s x=$o(@lroot@("icn",icn,x))
"RTN","SAMIHOM4",859,0)
 ;i +x'=0 d  ;
"RTN","SAMIHOM4",860,0)
 ;. s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",861,0)
 ;. i y>9000000 s x=0
"RTN","SAMIHOM4",862,0)
 ;i x>0 q x
"RTN","SAMIHOM4",863,0)
 ;
"RTN","SAMIHOM4",864,0)
 quit 0 ; end of $$REMATCH
"RTN","SAMIHOM4",865,0)
 ;
"RTN","SAMIHOM4",866,0)
 ;
"RTN","SAMIHOM4",867,0)
 ;
"RTN","SAMIHOM4",868,0)
SETINFO(vars,msg) ; set information message text
"RTN","SAMIHOM4",869,0)
 ;
"RTN","SAMIHOM4",870,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",871,0)
 ;
"RTN","SAMIHOM4",872,0)
 s vars("infoMessage")=msg
"RTN","SAMIHOM4",873,0)
 ;
"RTN","SAMIHOM4",874,0)
 quit  ; end of SETINFO
"RTN","SAMIHOM4",875,0)
 ;
"RTN","SAMIHOM4",876,0)
 ;
"RTN","SAMIHOM4",877,0)
 ;
"RTN","SAMIHOM4",878,0)
SETWARN(vars,msg) ; set warning message text
"RTN","SAMIHOM4",879,0)
 ;
"RTN","SAMIHOM4",880,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",881,0)
 ;
"RTN","SAMIHOM4",882,0)
 s vars("warnMessage")=msg
"RTN","SAMIHOM4",883,0)
 ;
"RTN","SAMIHOM4",884,0)
 quit  ; end of SETWARN
"RTN","SAMIHOM4",885,0)
 ;
"RTN","SAMIHOM4",886,0)
 ;
"RTN","SAMIHOM4",887,0)
 ; 
"RTN","SAMIHOM4",888,0)
RTNERR(rtn,form,vals,msg,fld) ; redisplay page w/error message
"RTN","SAMIHOM4",889,0)
 ;
"RTN","SAMIHOM4",890,0)
 ; rtn is the return array
"RTN","SAMIHOM4",891,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",892,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",893,0)
 ; msg is the error message to be displayed
"RTN","SAMIHOM4",894,0)
 ; fld is the name of the field where the cursor should be put
"RTN","SAMIHOM4",895,0)
 ;
"RTN","SAMIHOM4",896,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",897,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",898,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",899,0)
 m rtn=zhtml
"RTN","SAMIHOM4",900,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",901,0)
 ;
"RTN","SAMIHOM4",902,0)
 quit  ; end of RTNERR
"RTN","SAMIHOM4",903,0)
 ;
"RTN","SAMIHOM4",904,0)
 ;
"RTN","SAMIHOM4",905,0)
 ;
"RTN","SAMIHOM4",906,0)
RTNPAGE(rtn,form,vals) ; display page
"RTN","SAMIHOM4",907,0)
 ;
"RTN","SAMIHOM4",908,0)
 ; rtn is the return array
"RTN","SAMIHOM4",909,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",910,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",911,0)
 ;
"RTN","SAMIHOM4",912,0)
 n err
"RTN","SAMIHOM4",913,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",914,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",915,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",916,0)
 m SAMIRESULT=zhtml
"RTN","SAMIHOM4",917,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",918,0)
 ;
"RTN","SAMIHOM4",919,0)
 quit  ; end of RTNPAGE
"RTN","SAMIHOM4",920,0)
 ;
"RTN","SAMIHOM4",921,0)
 ;
"RTN","SAMIHOM4",922,0)
 ;
"RTN","SAMIHOM4",923,0)
REINDXPL ; reindex patient lookup
"RTN","SAMIHOM4",924,0)
 ;
"RTN","SAMIHOM4",925,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",926,0)
 n zi s zi=0
"RTN","SAMIHOM4",927,0)
 k @root@("ssn")
"RTN","SAMIHOM4",928,0)
 k @root@("name")
"RTN","SAMIHOM4",929,0)
 k @root@("last5")
"RTN","SAMIHOM4",930,0)
 k @root@("sinamef")
"RTN","SAMIHOM4",931,0)
 k @root@("sinamel")
"RTN","SAMIHOM4",932,0)
 ; k @root@("icn")
"RTN","SAMIHOM4",933,0)
 f  s zi=$o(@root@(zi)) q:+zi=0  d  ;
"RTN","SAMIHOM4",934,0)
 . d INDXPTLK(zi)
"RTN","SAMIHOM4",935,0)
 ;
"RTN","SAMIHOM4",936,0)
 quit  ; end of REINDXPL
"RTN","SAMIHOM4",937,0)
 ;
"RTN","SAMIHOM4",938,0)
 ;
"RTN","SAMIHOM4",939,0)
 ;
"RTN","SAMIHOM4",940,0)
INDXPTLK(ien) ; generate index entries in patient-lookup graph
"RTN","SAMIHOM4",941,0)
 ;
"RTN","SAMIHOM4",942,0)
 ; for entry ien
"RTN","SAMIHOM4",943,0)
 ;
"RTN","SAMIHOM4",944,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",945,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",946,0)
 s @proot@("name",name,ien)=""
"RTN","SAMIHOM4",947,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",948,0)
 s @proot@("name",ucname,ien)=""
"RTN","SAMIHOM4",949,0)
 n x
"RTN","SAMIHOM4",950,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",951,0)
 s:x'="" @proot@("dfn",x,ien)=""
"RTN","SAMIHOM4",952,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",953,0)
 s:x'="" @proot@("last5",x,ien)=""
"RTN","SAMIHOM4",954,0)
 ;
"RTN","SAMIHOM4",955,0)
 ; s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",956,0)
 ; i x'["V" d  ;
"RTN","SAMIHOM4",957,0)
 ; . i x="" q
"RTN","SAMIHOM4",958,0)
 ; . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",959,0)
 ; . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",960,0)
 ; . s x=x_"V"_chk
"RTN","SAMIHOM4",961,0)
 ; s:x'="" @proot@("icn",x,ien)=""
"RTN","SAMIHOM4",962,0)
 ;
"RTN","SAMIHOM4",963,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",964,0)
 s:x'="" @proot@("ssn",x,ien)=""
"RTN","SAMIHOM4",965,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",966,0)
 s:x'="" @proot@("sinamef",x,ien)=""
"RTN","SAMIHOM4",967,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",968,0)
 s:x'="" @proot@("sinamel",x,ien)=""
"RTN","SAMIHOM4",969,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",970,0)
 ;
"RTN","SAMIHOM4",971,0)
 quit  ; end of INDXPTLK
"RTN","SAMIHOM4",972,0)
 ;
"RTN","SAMIHOM4",973,0)
 ;
"RTN","SAMIHOM4",974,0)
 ;
"RTN","SAMIHOM4",975,0)
UNINDXPT(ien) ; remove index entries from patient-lookup graph
"RTN","SAMIHOM4",976,0)
 ;
"RTN","SAMIHOM4",977,0)
 ; for entry ien
"RTN","SAMIHOM4",978,0)
 ;
"RTN","SAMIHOM4",979,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",980,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",981,0)
 k @proot@("name",name,ien)
"RTN","SAMIHOM4",982,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",983,0)
 k @proot@("name",ucname,ien)
"RTN","SAMIHOM4",984,0)
 n x
"RTN","SAMIHOM4",985,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",986,0)
 k:x'="" @proot@("dfn",x,ien)
"RTN","SAMIHOM4",987,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",988,0)
 k:x'="" @proot@("last5",x,ien)
"RTN","SAMIHOM4",989,0)
 ;
"RTN","SAMIHOM4",990,0)
 ; s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",991,0)
 ; i x'["V" d  ;
"RTN","SAMIHOM4",992,0)
 ; . i x="" q
"RTN","SAMIHOM4",993,0)
 ; . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",994,0)
 ; . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",995,0)
 ; . s x=x_"V"_chk
"RTN","SAMIHOM4",996,0)
 ; k:x'="" @proot@("icn",x,ien)
"RTN","SAMIHOM4",997,0)
 ;
"RTN","SAMIHOM4",998,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",999,0)
 k:x'="" @proot@("ssn",x,ien)
"RTN","SAMIHOM4",1000,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",1001,0)
 k:x'="" @proot@("sinamef",x,ien)
"RTN","SAMIHOM4",1002,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",1003,0)
 k:x'="" @proot@("sinamel",x,ien)
"RTN","SAMIHOM4",1004,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",1005,0)
 ;
"RTN","SAMIHOM4",1006,0)
 quit  ; end of UNINDXPT
"RTN","SAMIHOM4",1007,0)
 ;
"RTN","SAMIHOM4",1008,0)
 ;
"RTN","SAMIHOM4",1009,0)
 ;
"RTN","SAMIHOM4",1010,0)
UCASE(STR) ; extrinsic returns uppercase of STR
"RTN","SAMIHOM4",1011,0)
 ;
"RTN","SAMIHOM4",1012,0)
 N X,Y
"RTN","SAMIHOM4",1013,0)
 S X=STR
"RTN","SAMIHOM4",1014,0)
 X ^%ZOSF("UPPERCASE")
"RTN","SAMIHOM4",1015,0)
 ;
"RTN","SAMIHOM4",1016,0)
 quit Y ; end of $$UCASE
"RTN","SAMIHOM4",1017,0)
 ;
"RTN","SAMIHOM4",1018,0)
 ;
"RTN","SAMIHOM4",1019,0)
 ;
"RTN","SAMIHOM4",1020,0)
 ;@wri-code WSNEWCAS^SAMIHOM3
"RTN","SAMIHOM4",1021,0)
WSNEWCAS ; web route newcase (creates new case)
"RTN","SAMIHOM4",1022,0)
 ;
"RTN","SAMIHOM4",1023,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",1024,0)
 ;
"RTN","SAMIHOM4",1025,0)
 ;ven/gpl;wri;procedure;
"RTN","SAMIHOM4",1026,0)
 ;@signature
"RTN","SAMIHOM4",1027,0)
 ; do WSNEWCAS^SAMIHOM3(SAMIARGS,SAMIBODY,SAMIRESULT)
"RTN","SAMIHOM4",1028,0)
 ;@branches-from
"RTN","SAMIHOM4",1029,0)
 ; wri WSNEWCAS^SAMIHOM3 [wr newcase]
"RTN","SAMIHOM4",1030,0)
 ;@wri-called-by
"RTN","SAMIHOM4",1031,0)
 ; wsi WSVAPALS^SAMIHOM3 [ws post vapals]
"RTN","SAMIHOM4",1032,0)
 ;@called-by none
"RTN","SAMIHOM4",1033,0)
 ;@calls
"RTN","SAMIHOM4",1034,0)
 ; parseBody^%wf
"RTN","SAMIHOM4",1035,0)
 ; $$setroot^%wd
"RTN","SAMIHOM4",1036,0)
 ;  $$VALDTNM [commented out]
"RTN","SAMIHOM4",1037,0)
 ;  GETHOME [commented out]
"RTN","SAMIHOM4",1038,0)
 ;  $$NEXTNUM [commented out]
"RTN","SAMIHOM4",1039,0)
 ; $$GENSTDID^SAMIHOM3
"RTN","SAMIHOM4",1040,0)
 ; $$NOW^XLFDT
"RTN","SAMIHOM4",1041,0)
 ; $$KEYDATE^SAMIHOM3
"RTN","SAMIHOM4",1042,0)
 ; PREFILL^SAMIHOM3
"RTN","SAMIHOM4",1043,0)
 ;  makeSbform [commented out]
"RTN","SAMIHOM4",1044,0)
 ; $$MKSIFORM^SAMIHOM3
"RTN","SAMIHOM4",1045,0)
 ; wsGetForm^%wf
"RTN","SAMIHOM4",1046,0)
 ;  WSCASE^SAMICASE [commented out]
"RTN","SAMIHOM4",1047,0)
 ;@input
"RTN","SAMIHOM4",1048,0)
 ;.ARGS =
"RTN","SAMIHOM4",1049,0)
 ; BODY =
"RTN","SAMIHOM4",1050,0)
 ;.RESULT =
"RTN","SAMIHOM4",1051,0)
 ;@output: ?
"RTN","SAMIHOM4",1052,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",1053,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",1054,0)
 ;
"RTN","SAMIHOM4",1055,0)
 ;
"RTN","SAMIHOM4",1056,0)
 ;@stanza 2 create new case
"RTN","SAMIHOM4",1057,0)
 ;
"RTN","SAMIHOM4",1058,0)
 merge ^SAMIUL("newCase","ARGS")=SAMIARGS
"RTN","SAMIHOM4",1059,0)
 merge ^SAMIUL("newCase","BODY")=SAMIBODY
"RTN","SAMIHOM4",1060,0)
 ;
"RTN","SAMIHOM4",1061,0)
 new vars,bdy
"RTN","SAMIHOM4",1062,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",1063,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",1064,0)
 merge ^SAMIUL("newCase","vars")=vars
"RTN","SAMIHOM4",1065,0)
 ;
"RTN","SAMIHOM4",1066,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",1067,0)
 ;
"RTN","SAMIHOM4",1068,0)
 new saminame set saminame=$get(vars("name"))
"RTN","SAMIHOM4",1069,0)
 if saminame="" s saminame=$get(vars("saminame"))
"RTN","SAMIHOM4",1070,0)
 ;if $$VALDTNM(saminame,.ARGS)=-1 do  quit  ;
"RTN","SAMIHOM4",1071,0)
 ;. new r1
"RTN","SAMIHOM4",1072,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",1073,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",1074,0)
 ;. quit
"RTN","SAMIHOM4",1075,0)
 ;
"RTN","SAMIHOM4",1076,0)
 new dfn s dfn=$get(vars("dfn"))
"RTN","SAMIHOM4",1077,0)
 ;if dfn="" do  quit  ;
"RTN","SAMIHOM4",1078,0)
 ;. new r1
"RTN","SAMIHOM4",1079,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",1080,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",1081,0)
 ;. quit
"RTN","SAMIHOM4",1082,0)
 ;
"RTN","SAMIHOM4",1083,0)
 ; new gien set gien=$$NEXTNUM
"RTN","SAMIHOM4",1084,0)
 new gien set gien=dfn
"RTN","SAMIHOM4",1085,0)
 ;
"RTN","SAMIHOM4",1086,0)
 merge ^SAMIUL("newCase","G1")=root
"RTN","SAMIHOM4",1087,0)
 ; create dfn index
"RTN","SAMIHOM4",1088,0)
 set @root@("dfn",dfn,gien)=""
"RTN","SAMIHOM4",1089,0)
 ;
"RTN","SAMIHOM4",1090,0)
 set @root@(gien,"saminum")=gien
"RTN","SAMIHOM4",1091,0)
 set @root@(gien,"saminame")=saminame
"RTN","SAMIHOM4",1092,0)
 ;
"RTN","SAMIHOM4",1093,0)
 new studyid set studyid=$$GENSTDID^SAMIHOM3(gien,.SAMIARGS)
"RTN","SAMIHOM4",1094,0)
 set @root@(gien,"samistudyid")=studyid
"RTN","SAMIHOM4",1095,0)
 set @root@("sid",studyid,gien)=""
"RTN","SAMIHOM4",1096,0)
 ;
"RTN","SAMIHOM4",1097,0)
 new datekey set datekey=$$KEYDATE^SAMIHOM3($$NOW^XLFDT)
"RTN","SAMIHOM4",1098,0)
 set @root@(gien,"samicreatedate")=datekey
"RTN","SAMIHOM4",1099,0)
 ;
"RTN","SAMIHOM4",1100,0)
 merge ^SAMIUL("newCase",gien)=@root@(gien)
"RTN","SAMIHOM4",1101,0)
 ;
"RTN","SAMIHOM4",1102,0)
 ;
"RTN","SAMIHOM4",1103,0)
 do PREFILL^SAMIHOM3(dfn) ; prefills from the "patient-lookup" graph
"RTN","SAMIHOM4",1104,0)
 ;
"RTN","SAMIHOM4",1105,0)
 new siformkey
"RTN","SAMIHOM4",1106,0)
 ; do makeSbform(gien) ; create background form for new patient
"RTN","SAMIHOM4",1107,0)
 set siformkey=$$MKSIFORM^SAMIHOM3(gien) ; create intake for new patient
"RTN","SAMIHOM4",1108,0)
 ;
"RTN","SAMIHOM4",1109,0)
 set SAMIARGS("studyid")=studyid
"RTN","SAMIHOM4",1110,0)
 set SAMIARGS("form")="vapals:"_siformkey
"RTN","SAMIHOM4",1111,0)
 do wsGetForm^%wf(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",1112,0)
 ; do WSCASE^SAMICASE(.SAMIRESULT,.SAMIARGS) ; navigate to case review page
"RTN","SAMIHOM4",1113,0)
 ;
"RTN","SAMIHOM4",1114,0)
 ;
"RTN","SAMIHOM4",1115,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",1116,0)
 ;
"RTN","SAMIHOM4",1117,0)
 quit  ; end of wri WSNEWCAS^SAMIHOM3
"RTN","SAMIHOM4",1118,0)
 ;
"RTN","SAMIHOM4",1119,0)
 ;
"RTN","SAMIHOM4",1120,0)
 ;
"RTN","SAMIHOM4",1121,0)
EOR ; end of routine SAMIHOM4
"RTN","SAMIHUL")
0^8^B121785
"RTN","SAMIHUL",1,0)
SAMIHUL ;ven/gpl - ielcap: home page log ;2021-07-01t16:19z
"RTN","SAMIHUL",2,0)
 ;;18.0;SAMI;**9,12**;;Build 6
"RTN","SAMIHUL",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIHUL",4,0)
 ;
"RTN","SAMIHUL",5,0)
 ; SAMIHOME contains subroutines for producing the ELCAP Home Page.
"RTN","SAMIHUL",6,0)
 ; SAMIHUL contains the development log for the SAMIHOM* routines.
"RTN","SAMIHUL",7,0)
 ; It contains no executable code.
"RTN","SAMIHUL",8,0)
 ;
"RTN","SAMIHUL",9,0)
 quit  ; no entry from top
"RTN","SAMIHUL",10,0)
 ;
"RTN","SAMIHUL",11,0)
 ;
"RTN","SAMIHUL",12,0)
 ;
"RTN","SAMIHUL",13,0)
 ;@section 0 primary development
"RTN","SAMIHUL",14,0)
 ;
"RTN","SAMIHUL",15,0)
 ;
"RTN","SAMIHUL",16,0)
 ;
"RTN","SAMIHUL",17,0)
 ;@routine-credits
"RTN","SAMIHUL",18,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMIHUL",19,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIHUL",20,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIHUL",21,0)
 ; http://vistaexpertise.net
"RTN","SAMIHUL",22,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIHUL",23,0)
 ;@license see routine SAMIUL
"RTN","SAMIHUL",24,0)
 ;
"RTN","SAMIHUL",25,0)
 ;@last-updated 2021-07-01t16:19z
"RTN","SAMIHUL",26,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIHUL",27,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIHUL",28,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIHUL",29,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIHUL",30,0)
 ;@release-date 2020-01
"RTN","SAMIHUL",31,0)
 ;@patch-list **9,12**
"RTN","SAMIHUL",32,0)
 ;
"RTN","SAMIHUL",33,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIHUL",34,0)
 ; toad@vistaexpertise.net
"RTN","SAMIHUL",35,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMIHUL",36,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIHUL",37,0)
 ;@additional-dev Linda M. R. Yaw (lmry)
"RTN","SAMIHUL",38,0)
 ; linda.yaw@vistaexpertise.net
"RTN","SAMIHUL",39,0)
 ;@additional-dev Larry G. Carlson (lgc)
"RTN","SAMIHUL",40,0)
 ; larry.g.carlson@gmail.com
"RTN","SAMIHUL",41,0)
 ;@additional-dev Alexis R. Carlson (arc)
"RTN","SAMIHUL",42,0)
 ; whatisthehumanspirit@gmail.com
"RTN","SAMIHUL",43,0)
 ;@additional-dev Domenick DiNatale (ddn)
"RTN","SAMIHUL",44,0)
 ; domenic@intellitechinnovations.com
"RTN","SAMIHUL",45,0)
 ;
"RTN","SAMIHUL",46,0)
 ;@module-credits
"RTN","SAMIHUL",47,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMIHUL",48,0)
 ; (VA-PALS)
"RTN","SAMIHUL",49,0)
 ; http://va-pals.org/
"RTN","SAMIHUL",50,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMIHUL",51,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMIHUL",52,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMIHUL",53,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMIHUL",54,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMIHUL",55,0)
 ; http://ielcap.com/
"RTN","SAMIHUL",56,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMIHUL",57,0)
 ; http://paraxialtech.com/
"RTN","SAMIHUL",58,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMIHUL",59,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMIHUL",60,0)
 ;
"RTN","SAMIHUL",61,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIHUL",62,0)
 ;
"RTN","SAMIHUL",63,0)
 ; 2018-01-13 ven/gpl 1.18.0-t4
"RTN","SAMIHUL",64,0)
 ;  SAMIHOM3: create routine from SAMIFRM to implement ELCAP Home Page.
"RTN","SAMIHUL",65,0)
 ;
"RTN","SAMIHUL",66,0)
 ; 2018-02-05 ven/toad 1.18.0-t4
"RTN","SAMIHUL",67,0)
 ;  SAMIHOM3: update license & attribution & hdr comments, add white
"RTN","SAMIHUL",68,0)
 ; space & do-dot quits, spell out language elements.
"RTN","SAMIHUL",69,0)
 ;
"RTN","SAMIHUL",70,0)
 ; 2018-02-27 ven/gpl 1.18.0-t4
"RTN","SAMIHUL",71,0)
 ;  SAMIHOM3: new subroutines PREFIX,GETHOME,SCANFOR,WSNEWCAS,PREFILL,
"RTN","SAMIHUL",72,0)
 ; MKSBFORM,MKSIFORM,VALDTNM,SID2NUM,KEYDATE,GENSTDID,NEXTNUM to
"RTN","SAMIHUL",73,0)
 ; support creation of new cases.
"RTN","SAMIHUL",74,0)
 ;
"RTN","SAMIHUL",75,0)
 ; 2018-03-01 ven/toad 1.18.0-t4
"RTN","SAMIHUL",76,0)
 ;  SAMIHOM3 refactor & reorganize new code, add hdr comments,
"RTN","SAMIHUL",77,0)
 ; r/findReplaceAll^%wf w/findReplace^%ts.
"RTN","SAMIHUL",78,0)
 ;
"RTN","SAMIHUL",79,0)
 ; 2018-03-06 ven/gpl 1.18.0-t4
"RTN","SAMIHUL",80,0)
 ;  SAMIHOM3: ?
"RTN","SAMIHUL",81,0)
 ;
"RTN","SAMIHUL",82,0)
 ; 2018-03-07 ven/toad 1.18.0-t4
"RTN","SAMIHUL",83,0)
 ;  SAMIHOM3: in $$SID2NUM add WSNUFORM^SAMICASE to called-by; in
"RTN","SAMIHUL",84,0)
 ; keyDate,GETHOME update called-by.
"RTN","SAMIHUL",85,0)
 ;
"RTN","SAMIHUL",86,0)
 ; 2018-05-18/25 ven/lgc&arc 1.18.0-t4 76020fd,81b1048,65afd99
"RTN","SAMIHUL",87,0)
 ;  SAMIHOM3: new SAMIHOM3 for new patient search page, chg submit
"RTN","SAMIHUL",88,0)
 ; processing on forms, fix bug in postform.
"RTN","SAMIHUL",89,0)
 ;
"RTN","SAMIHUL",90,0)
 ; 2018-06-14/07-10 ven/lgc&arc 1.18.0-t4 d71f4fe,8b0a432,ce345db,
"RTN","SAMIHUL",91,0)
 ; 402b6a8,14f991d,2e9662b
"RTN","SAMIHUL",92,0)
 ;  SAMIHOM3: make background form optional; 1st version of CT Eval
"RTN","SAMIHUL",93,0)
 ; Report; reorg ctreport routines & 1st crack at impressions &
"RTN","SAMIHUL",94,0)
 ; recommendations; note produced for intake form on submit; add
"RTN","SAMIHUL",95,0)
 ; support for routing by patient in CPRS Tools Menu, modify
"RTN","SAMIHUL",96,0)
 ; wsHOME^SAMIHOM3 to properly route VA-PALS web app when launced via
"RTN","SAMIHUL",97,0)
 ; CPRS Tools Menu; repair SAMIHOM3 & redact report link.
"RTN","SAMIHUL",98,0)
 ;
"RTN","SAMIHUL",99,0)
 ; 2018-08-22 ven/gpl 1.18.0-t4 6e696a9
"RTN","SAMIHUL",100,0)
 ;  SAMIHOM3: add PTINFO call to vista to pull ssn.
"RTN","SAMIHUL",101,0)
 ;
"RTN","SAMIHUL",102,0)
 ; 2018-09-30/11-01 ven/lgc&arc 1.18.0-t4 d93c640,482f522,a8e4226,
"RTN","SAMIHUL",103,0)
 ; ee5e8a1
"RTN","SAMIHUL",104,0)
 ;  SAMIHOM3: hdr & prefill of intake; new input form features, report
"RTN","SAMIHUL",105,0)
 ; menu fix; set urban/rural status at siform setup; handle zip code
"RTN","SAMIHUL",106,0)
 ; unknown.
"RTN","SAMIHUL",107,0)
 ;
"RTN","SAMIHUL",108,0)
 ; 2018-11-09/2019-01-22 ven/lgc&arc&lmry 1.18.0-t4 bac4f73,5400035,
"RTN","SAMIHUL",109,0)
 ; dd341e0,a953946,e2a44e6,2356c2b,3ceb74b,3088307,4271b46,7a5d340,
"RTN","SAMIHUL",110,0)
 ; dfbb0bc,fd1bcee,8dd6f34,51eb163,dbdb5a4,0880027,ccba017,5368121
"RTN","SAMIHUL",111,0)
 ;  SAMIHOM3: unit tests, annotation, sac compliance, XINDEX bugs, fix
"RTN","SAMIHUL",112,0)
 ; accidental reversions, add license info.
"RTN","SAMIHUL",113,0)
 ;
"RTN","SAMIHUL",114,0)
 ; 2018-12-18/20 ven/arc 1.18.0-t04 3088307f,4271b46b,dfbb0bca,
"RTN","SAMIHUL",115,0)
 ;  b8ff6da9,fd1bceee
"RTN","SAMIHUL",116,0)
 ;  SAMIHOM4: va sac compliance & variable namespacing.
"RTN","SAMIHUL",117,0)
 ;
"RTN","SAMIHUL",118,0)
 ; 2019-01-01/02-18 ven/lgc 1.18.0-t04 0880027c,18aa0fec,fcd635c1,
"RTN","SAMIHUL",119,0)
 ;  53681219,76874314
"RTN","SAMIHUL",120,0)
 ;  SAMIHOM3: update w/ recent changes.
"RTN","SAMIHUL",121,0)
 ;  SAMIHOM4: updates for va sac & code coverage, add license info.
"RTN","SAMIHUL",122,0)
 ;
"RTN","SAMIHUL",123,0)
 ; 2019-04-15 ven/gpl 1.18.0-t04 b403bf01
"RTN","SAMIHUL",124,0)
 ;  SAMIHOM4: support for new intake notes.
"RTN","SAMIHUL",125,0)
 ;
"RTN","SAMIHUL",126,0)
 ; 2019-04-16 ven/lgc 1.18.0-t04 e54b76d1
"RTN","SAMIHUL",127,0)
 ;  SAMIHOM4: update for SAMIFORM project.
"RTN","SAMIHUL",128,0)
 ;
"RTN","SAMIHUL",129,0)
 ; 2019-04-17 ven/gpl 1.18.0-t4 7d1f86db
"RTN","SAMIHUL",130,0)
 ;  SAMIHOM3: prefill date on intake prelim discussion section.
"RTN","SAMIHUL",131,0)
 ;
"RTN","SAMIHUL",132,0)
 ; 2019-06-18 ven/arc 1.18.0-t04 91022482
"RTN","SAMIHUL",133,0)
 ;  SAMIHOM4: switch fr/global ^SAMIGPL to/^SAMIUL.
"RTN","SAMIHUL",134,0)
 ;
"RTN","SAMIHUL",135,0)
 ; 2019-08-05 ven/gpl 1.18.0-t4 9c0c2ed3
"RTN","SAMIHUL",136,0)
 ;  SAMIHOM3: add GETPRFX to get right prefix at registration.
"RTN","SAMIHUL",137,0)
 ;
"RTN","SAMIHUL",138,0)
 ; 2019-08-07 ven/lgc&arc 1.18.0-t4 603194b9,37967fc5
"RTN","SAMIHUL",139,0)
 ;  SAMIHOM3: consolidate calls to retrieve facility prefix.
"RTN","SAMIHUL",140,0)
 ;
"RTN","SAMIHUL",141,0)
 ; 2019-11-22 par/ddn 1.18.0-t04 b2cc389d vap-458
"RTN","SAMIHUL",142,0)
 ;  SAMIHOM4: manual registration.
"RTN","SAMIHUL",143,0)
 ;
"RTN","SAMIHUL",144,0)
 ; 2020-01-01/05 ven/lgc 1.18.0 c169f4b1,5928064a,62e3200f
"RTN","SAMIHUL",145,0)
 ;  SAMIHOM4: support for unmatched patient processing, more changes
"RTN","SAMIHUL",146,0)
 ; for participant matching, unmatched participant processing ready
"RTN","SAMIHUL",147,0)
 ; for testing.
"RTN","SAMIHUL",148,0)
 ;
"RTN","SAMIHUL",149,0)
 ; 2020-01-08/10 ven/gpl 1.18.0 a002f850,47dfe3cd
"RTN","SAMIHUL",150,0)
 ;  SAMIHOM4: bug fix for unmatched processing, turn off & on manual
"RTN","SAMIHUL",151,0)
 ; registration link on home page.
"RTN","SAMIHUL",152,0)
 ;
"RTN","SAMIHUL",153,0)
 ; 2020-01-10 ven/gpl 1.18.0 4c8e6ebc,76b465cb
"RTN","SAMIHUL",154,0)
 ;  SAMIHOM4: 3 quits with returns for cache.
"RTN","SAMIHUL",155,0)
 ;
"RTN","SAMIHUL",156,0)
 ; 2020-01-16 ven/lgc 1.18.0 0a2af965
"RTN","SAMIHUL",157,0)
 ;  SAMIHOM4: bulk commit due to switch to cache.
"RTN","SAMIHUL",158,0)
 ;
"RTN","SAMIHUL",159,0)
 ; 2020-01-17/20 ven/lgc 1.18.0.1+i1 8557207f,dc5f618c
"RTN","SAMIHUL",160,0)
 ;  SAMIHOM4: followup note, limit to one note per followup form.
"RTN","SAMIHUL",161,0)
 ;
"RTN","SAMIHUL",162,0)
 ; 2020-02-01/02 ven/lgc 1.18.0.4+i4 3065146d,36ae0ed1
"RTN","SAMIHUL",163,0)
 ;  SAMIHOM4: set options for text based ctreport, switch default
"RTN","SAMIHUL",164,0)
 ; ctreport to text.
"RTN","SAMIHUL",165,0)
 ;
"RTN","SAMIHUL",166,0)
 ; 2020-04-02/11 ven/gpl 1.18.0.5+i5 d36b7cad,36607664,befde317,
"RTN","SAMIHUL",167,0)
 ;  56bfaed6,666f5b91,2f2c29c1
"RTN","SAMIHUL",168,0)
 ;  SAMIHOM3: multitenancy; in GENSTDID add ARG param, determin prefix
"RTN","SAMIHUL",169,0)
 ; from site or siteid (ARG) instead of calling $$GETPRFX^SAMIFORM.
"RTN","SAMIHUL",170,0)
 ;  SAMIHOM4: multitenancy + fix bug in WSVAPALS.
"RTN","SAMIHUL",171,0)
 ;
"RTN","SAMIHUL",172,0)
 ; 2020-04-18/05-07 ven/gpl 1.18.0.5+i5 29d7dba7,d55de214,521e0bdc,
"RTN","SAMIHUL",173,0)
 ;  d018f52e,476b2ff4,61c7d208
"RTN","SAMIHUL",174,0)
 ;  SAMIHOM4: fix bug & weird error in manual registration, fix bug in
"RTN","SAMIHUL",175,0)
 ; logout, logout working, superuser site selection, worklist
"RTN","SAMIHUL",176,0)
 ; functionality.
"RTN","SAMIHUL",177,0)
 ;
"RTN","SAMIHUL",178,0)
 ; 2020-08-06 ven/gpl 1.18.0.6+i6 781744c3
"RTN","SAMIHUL",179,0)
 ;  SAMIHOM4: changes to support hl7 transmission of notes.
"RTN","SAMIHUL",180,0)
 ;
"RTN","SAMIHUL",181,0)
 ; 2020-09-22 ven/gpl 1.18.0.9+i9 06459eda
"RTN","SAMIHUL",182,0)
 ;  SAMIHOM4: correct to match kids file.
"RTN","SAMIHUL",183,0)
 ;
"RTN","SAMIHUL",184,0)
 ; 2021-03-02 ven/gpl 1.18.0.9+i9 479dc041
"RTN","SAMIHUL",185,0)
 ;  SAMIHOM4: return error message if no ct eval form exists when
"RTN","SAMIHUL",186,0)
 ; generating a fu note.
"RTN","SAMIHUL",187,0)
 ;
"RTN","SAMIHUL",188,0)
 ; 2021-03-11 ven/toad 1.18.0.9+i9 a46a2cc1
"RTN","SAMIHUL",189,0)
 ;  SAMIHUL: create routine.
"RTN","SAMIHUL",190,0)
 ;  SAMIHOM4: bump date & patch list, add contents, lt refactor.
"RTN","SAMIHUL",191,0)
 ;
"RTN","SAMIHUL",192,0)
 ; 2021-03-17 ven/toad 1.18.0.9+i9
"RTN","SAMIHUL",193,0)
 ; SAMIHOM4: remove blank from end of 1 line.
"RTN","SAMIHUL",194,0)
 ;
"RTN","SAMIHUL",195,0)
 ; 2021-05-29 ven/gpl 1.18.0.12-t2+i12 59ea0811
"RTN","SAMIHUL",196,0)
 ;  SAMIHOM3: in SID2NUM look up by pien instead of relying on sid
"RTN","SAMIHUL",197,0)
 ; containing pien.
"RTN","SAMIHUL",198,0)
 ;
"RTN","SAMIHUL",199,0)
 ; 2021-06-15 ven/gpl 1.18.0.12-t2+i12 e247ea59
"RTN","SAMIHUL",200,0)
 ;  SAMIHOM4: eliminate icn.
"RTN","SAMIHUL",201,0)
 ;
"RTN","SAMIHUL",202,0)
 ; 2021-06-15/16 ven/mcglk&toad 1.18.0.12-t2+i12 cbf7e46b,fa794d60
"RTN","SAMIHUL",203,0)
 ;  SAMIHOM3 move log to SAMIHUL, bump dates & versions, annotate,
"RTN","SAMIHUL",204,0)
 ; reorg, lt refactor.
"RTN","SAMIHUL",205,0)
 ;  SAMIHOM4 bump dates & versions; begin annotate, reorg, lt refactor
"RTN","SAMIHUL",206,0)
 ; but interrupted by addition of critical fix to patch & bronchitis,
"RTN","SAMIHUL",207,0)
 ; so leave refactor unfinished (but stable as far as it went).
"RTN","SAMIHUL",208,0)
 ;  SAMIUTH3 bump dates & versions, lt refactor, add COVER, in UTSCAN4
"RTN","SAMIHUL",209,0)
 ; fix $random bug, but after discovering the SAMI test suite is so
"RTN","SAMIHUL",210,0)
 ; far out of date that it fails catastrophically with thousands of
"RTN","SAMIHUL",211,0)
 ; errors, back out changes and leave as it was.
"RTN","SAMIHUL",212,0)
 ;
"RTN","SAMIHUL",213,0)
 ;@contents
"RTN","SAMIHUL",214,0)
 ; SAMIHOM3 homepage interface library
"RTN","SAMIHUL",215,0)
 ; SAMIHOM4 homepage subroutines
"RTN","SAMIHUL",216,0)
 ; SAMIHUL homepage development log
"RTN","SAMIHUL",217,0)
 ; SAMIUTH3 tests for SAMIHOM3
"RTN","SAMIHUL",218,0)
 ; SAMIUTH4 tests for SAMIHOM4
"RTN","SAMIHUL",219,0)
 ;
"RTN","SAMIHUL",220,0)
 ;
"RTN","SAMIHUL",221,0)
 ;
"RTN","SAMIHUL",222,0)
EOR ; end of routine SAMIHUL
"RTN","SAMIJS1")
0^9^B33800885
"RTN","SAMIJS1",1,0)
SAMIJS1 ;ven/gpl - json archive export ;2021-07-01t16:58z
"RTN","SAMIJS1",2,0)
 ;;18.0;SAMI;**8,12**;2020-01;Build 6
"RTN","SAMIJS1",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIJS1",4,0)
 ;
"RTN","SAMIJS1",5,0)
 ; Routine SAMIJS1 contains subroutines for exporting VAPALS-ELCAP
"RTN","SAMIJS1",6,0)
 ; JSON archives, which are used for import, export, & migration of
"RTN","SAMIJS1",7,0)
 ; SAMI data.
"RTN","SAMIJS1",8,0)
 ;
"RTN","SAMIJS1",9,0)
 quit  ; no entry from top
"RTN","SAMIJS1",10,0)
 ;
"RTN","SAMIJS1",11,0)
 ;
"RTN","SAMIJS1",12,0)
 ;
"RTN","SAMIJS1",13,0)
 ;@section 0 primary development
"RTN","SAMIJS1",14,0)
 ;
"RTN","SAMIJS1",15,0)
 ;
"RTN","SAMIJS1",16,0)
 ;
"RTN","SAMIJS1",17,0)
 ;@routine-credits
"RTN","SAMIJS1",18,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMIJS1",19,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIJS1",20,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIJS1",21,0)
 ; http://vistaexpertise.net
"RTN","SAMIJS1",22,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIJS1",23,0)
 ;@license see routine SAMIUL
"RTN","SAMIJS1",24,0)
 ;
"RTN","SAMIJS1",25,0)
 ;@last-updated 2021-07-01t16:58z
"RTN","SAMIJS1",26,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIJS1",27,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIJS1",28,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIJS1",29,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIJS1",30,0)
 ;@release-date 2020-01
"RTN","SAMIJS1",31,0)
 ;@patch-list **8,12**
"RTN","SAMIJS1",32,0)
 ;
"RTN","SAMIJS1",33,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIJS1",34,0)
 ; toad@vistaexpertise.net
"RTN","SAMIJS1",35,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMIJS1",36,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIJS1",37,0)
 ;
"RTN","SAMIJS1",38,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIJS1",39,0)
 ; 2020-12-11 ven/gpl 1.18.0.8+i8 0c73272b,92138cdb
"RTN","SAMIJS1",40,0)
 ;  SAMIJS1 initial data migration export, add DETAIL^SAMIJS1 for
"RTN","SAMIJS1",41,0)
 ; debugging.
"RTN","SAMIJS1",42,0)
 ;
"RTN","SAMIJS1",43,0)
 ; 2021-05-29 ven/gpl 1.18.0.12-t2+i12 0a3b184f
"RTN","SAMIJS1",44,0)
 ;  SAMIJS1,SAMIJS2 update data migration routines; new SAMIJS2.
"RTN","SAMIJS1",45,0)
 ;
"RTN","SAMIJS1",46,0)
 ; 2021-07-01 ven/mcglk&toad 1.18.0.12-t2+i12 cbf7e46b
"RTN","SAMIJS1",47,0)
 ;  SAMIJS1,SAMIJS2 bump version & dates, add hdr comments & dev log.
"RTN","SAMIJS1",48,0)
 ;
"RTN","SAMIJS1",49,0)
 ;@contents
"RTN","SAMIJS1",50,0)
 ; EN ???
"RTN","SAMIJS1",51,0)
 ; EXSITE ???
"RTN","SAMIJS1",52,0)
 ; $$dfn2lien lookup ien of patient dfn
"RTN","SAMIJS1",53,0)
 ; $$dfn2pien patient graph ien of patient dfn
"RTN","SAMIJS1",54,0)
 ; $$getaien ien for patient dfn in vapals-archive
"RTN","SAMIJS1",55,0)
 ; mkarch create archive record for patient dfn
"RTN","SAMIJS1",56,0)
 ; outarch write archive record to external file
"RTN","SAMIJS1",57,0)
 ; DETAIL display archive record for patient
"RTN","SAMIJS1",58,0)
 ; 
"RTN","SAMIJS1",59,0)
 ;
"RTN","SAMIJS1",60,0)
 ;
"RTN","SAMIJS1",61,0)
 ;@section 1 subroutines
"RTN","SAMIJS1",62,0)
 ;
"RTN","SAMIJS1",63,0)
 ;
"RTN","SAMIJS1",64,0)
 ;
"RTN","SAMIJS1",65,0)
EN ;
"RTN","SAMIJS1",66,0)
 n site,dfn,pat
"RTN","SAMIJS1",67,0)
 s site=$$PICSITE^SAMIMOV()
"RTN","SAMIJS1",68,0)
 q:site="^"
"RTN","SAMIJS1",69,0)
 d PICPAT^SAMIMOV(.pat,site)
"RTN","SAMIJS1",70,0)
 w "   ",$g(pat("name"))
"RTN","SAMIJS1",71,0)
 s dfn=$g(pat("dfn"))
"RTN","SAMIJS1",72,0)
 w !,"dfn=",dfn
"RTN","SAMIJS1",73,0)
 d mkarch(dfn)
"RTN","SAMIJS1",74,0)
 d outarch(dfn)
"RTN","SAMIJS1",75,0)
 q
"RTN","SAMIJS1",76,0)
 ;
"RTN","SAMIJS1",77,0)
 ;
"RTN","SAMIJS1",78,0)
 ;
"RTN","SAMIJS1",79,0)
EXSITE ;
"RTN","SAMIJS1",80,0)
 n site,dfn,pat
"RTN","SAMIJS1",81,0)
 s site=$$PICSITE^SAMIMOV()
"RTN","SAMIJS1",82,0)
 q:site="^"
"RTN","SAMIJS1",83,0)
 n lroot,proot,aroot
"RTN","SAMIJS1",84,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIJS1",85,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIJS1",86,0)
 s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",87,0)
 n dfn,lien s dfn=""
"RTN","SAMIJS1",88,0)
 f  s dfn=$o(@lroot@("dfn",dfn)) q:+dfn=0  d  ;
"RTN","SAMIJS1",89,0)
 . s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIJS1",90,0)
 . i $g(@lroot@(lien,"siteid"))'=site q  ;
"RTN","SAMIJS1",91,0)
 . d mkarch(dfn)
"RTN","SAMIJS1",92,0)
 . d outarch(dfn)
"RTN","SAMIJS1",93,0)
 q
"RTN","SAMIJS1",94,0)
 ;
"RTN","SAMIJS1",95,0)
 ;
"RTN","SAMIJS1",96,0)
 ;
"RTN","SAMIJS1",97,0)
dfn2lien(dfn) ; extrinsic return the lookup ien of patient dfn
"RTN","SAMIJS1",98,0)
 n lroot,lien
"RTN","SAMIJS1",99,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIJS1",100,0)
 s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIJS1",101,0)
 q lien
"RTN","SAMIJS1",102,0)
 ;
"RTN","SAMIJS1",103,0)
 ;
"RTN","SAMIJS1",104,0)
 ;
"RTN","SAMIJS1",105,0)
dfn2pien(dfn) ; extrinsic return the patient graph ien of patient dfn
"RTN","SAMIJS1",106,0)
 n proot,pien
"RTN","SAMIJS1",107,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIJS1",108,0)
 s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIJS1",109,0)
 q pien
"RTN","SAMIJS1",110,0)
 ;
"RTN","SAMIJS1",111,0)
 ;
"RTN","SAMIJS1",112,0)
 ;
"RTN","SAMIJS1",113,0)
getaien(dfn) ; returns the ien for patient dfn in vapals-archive
"RTN","SAMIJS1",114,0)
 ; is laygo
"RTN","SAMIJS1",115,0)
 n aroot s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",116,0)
 n aien
"RTN","SAMIJS1",117,0)
 s aien=$o(@aroot@(" "),-1)+1
"RTN","SAMIJS1",118,0)
 q aien
"RTN","SAMIJS1",119,0)
 ;
"RTN","SAMIJS1",120,0)
 ;
"RTN","SAMIJS1",121,0)
 ;
"RTN","SAMIJS1",122,0)
mkarch(dfn) ; create an archive record for patient dfn
"RTN","SAMIJS1",123,0)
 n lroot,proot,aroot
"RTN","SAMIJS1",124,0)
 n lien,pien,aien
"RTN","SAMIJS1",125,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIJS1",126,0)
 w !,"patient-lookup: ",lroot
"RTN","SAMIJS1",127,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIJS1",128,0)
 w !,"vapals-patients: ",proot
"RTN","SAMIJS1",129,0)
 s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",130,0)
 w !,"vapals-archive: ",aroot
"RTN","SAMIJS1",131,0)
 ;
"RTN","SAMIJS1",132,0)
 s lien=$$dfn2lien(dfn)
"RTN","SAMIJS1",133,0)
 w !,"lien=",lien
"RTN","SAMIJS1",134,0)
 s pien=$$dfn2pien(dfn)
"RTN","SAMIJS1",135,0)
 w !,"pien=",pien
"RTN","SAMIJS1",136,0)
 ;
"RTN","SAMIJS1",137,0)
 i lien="" d  q  ;
"RTN","SAMIJS1",138,0)
 . w !,"error, lookup ien not found for patient dfn=",dfn
"RTN","SAMIJS1",139,0)
 ;
"RTN","SAMIJS1",140,0)
 s aien=$o(@aroot@("dfn",dfn,""))
"RTN","SAMIJS1",141,0)
 i aien'="" d  ;
"RTN","SAMIJS1",142,0)
 . k @aroot@(aien)
"RTN","SAMIJS1",143,0)
 i aien="" s aien=$$getaien(dfn)
"RTN","SAMIJS1",144,0)
 w !,"aien=",aien
"RTN","SAMIJS1",145,0)
 ;
"RTN","SAMIJS1",146,0)
 m @aroot@(aien,"patient","lookup")=@lroot@(lien)
"RTN","SAMIJS1",147,0)
 s @aroot@("dfn",dfn,aien)=""
"RTN","SAMIJS1",148,0)
 ;
"RTN","SAMIJS1",149,0)
 n sid s sid=""
"RTN","SAMIJS1",150,0)
 d:pien'=""
"RTN","SAMIJS1",151,0)
 . m @aroot@(aien,"patient","demos")=@proot@(pien)
"RTN","SAMIJS1",152,0)
 . s sid=$g(@proot@(pien,"samistudyid"))
"RTN","SAMIJS1",153,0)
 . i sid="" s sid=$g(@proot@(pien,"sisid"))
"RTN","SAMIJS1",154,0)
 . q:sid=""
"RTN","SAMIJS1",155,0)
 . m @aroot@(aien,"patient","graph")=@proot@("graph",sid)
"RTN","SAMIJS1",156,0)
 ;
"RTN","SAMIJS1",157,0)
 q
"RTN","SAMIJS1",158,0)
 ;
"RTN","SAMIJS1",159,0)
 ;
"RTN","SAMIJS1",160,0)
 ;
"RTN","SAMIJS1",161,0)
outarch(dfn) ; write out an archive record to an external file
"RTN","SAMIJS1",162,0)
 n aroot s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",163,0)
 n aien s aien=$o(@aroot@("dfn",dfn,""),-1)
"RTN","SAMIJS1",164,0)
 q:aien=""
"RTN","SAMIJS1",165,0)
 ;
"RTN","SAMIJS1",166,0)
 n sid s sid=$g(@aroot@(aien,"patient","demos","samistudyid"))
"RTN","SAMIJS1",167,0)
 n tmpout s tmpout=$na(^TMP("VAPALS-ARCH",$J))
"RTN","SAMIJS1",168,0)
 k @tmpout
"RTN","SAMIJS1",169,0)
 n arec s arec=$na(@aroot@(aien))
"RTN","SAMIJS1",170,0)
 d encode^%webjson(arec,tmpout)
"RTN","SAMIJS1",171,0)
 ;
"RTN","SAMIJS1",172,0)
 n adir,fname
"RTN","SAMIJS1",173,0)
 s adir="/home/osehra/www/archive"
"RTN","SAMIJS1",174,0)
 s fname="vapals-"_sid_"-"_dfn_"-"_DT_".json"
"RTN","SAMIJS1",175,0)
 i $$GTF^%ZISH($NA(@tmpout@(1)),3,adir,fname) d  ;
"RTN","SAMIJS1",176,0)
 . w !,"file "_fname_" written to "_adir
"RTN","SAMIJS1",177,0)
 ;
"RTN","SAMIJS1",178,0)
 q
"RTN","SAMIJS1",179,0)
 ;
"RTN","SAMIJS1",180,0)
 ;
"RTN","SAMIJS1",181,0)
 ;
"RTN","SAMIJS1",182,0)
DETAIL() ; displays the archive record for a patient
"RTN","SAMIJS1",183,0)
 ;
"RTN","SAMIJS1",184,0)
 n site,dfn,pat
"RTN","SAMIJS1",185,0)
 s site=$$PICSITE^SAMIMOV()
"RTN","SAMIJS1",186,0)
 q:site="^"
"RTN","SAMIJS1",187,0)
 d PICPAT^SAMIMOV(.pat,site)
"RTN","SAMIJS1",188,0)
 w "   ",$g(pat("name"))
"RTN","SAMIJS1",189,0)
 s dfn=$g(pat("dfn"))
"RTN","SAMIJS1",190,0)
 w !,"dfn=",dfn
"RTN","SAMIJS1",191,0)
 q:dfn=""
"RTN","SAMIJS1",192,0)
 n aroot ; archive root
"RTN","SAMIJS1",193,0)
 s aroot=$$setroot^%wd("vapals-archive")
"RTN","SAMIJS1",194,0)
 d mkarch(dfn)
"RTN","SAMIJS1",195,0)
 n aien
"RTN","SAMIJS1",196,0)
 s aien=$o(@aroot@("dfn",dfn,""))
"RTN","SAMIJS1",197,0)
 i aien="" d  q  ;
"RTN","SAMIJS1",198,0)
 . w !,"patient not found in archive"
"RTN","SAMIJS1",199,0)
 n groot
"RTN","SAMIJS1",200,0)
 s groot=$na(@aroot@(aien))
"RTN","SAMIJS1",201,0)
 n OUT s OUT=$na(^TMP("SAMIOUT",$J))
"RTN","SAMIJS1",202,0)
 k @OUT
"RTN","SAMIJS1",203,0)
 D GTREE^SYNVPR(groot,9,,,OUT)
"RTN","SAMIJS1",204,0)
 D BROWSE^DDBR(OUT,"N","Patient")
"RTN","SAMIJS1",205,0)
 k @OUT
"RTN","SAMIJS1",206,0)
 q
"RTN","SAMIJS1",207,0)
 ;
"RTN","SAMIJS1",208,0)
 ;
"RTN","SAMIJS1",209,0)
 ;
"RTN","SAMIJS1",210,0)
EOR ; end of routine SAMIJS1
"RTN","SAMIJS2")
0^10^B50763648
"RTN","SAMIJS2",1,0)
SAMIJS2 ;ven/gpl - json archive import ;2021-07-01t17:08z
"RTN","SAMIJS2",2,0)
 ;;18.0;SAMI;**12**;2020-01;Build 6
"RTN","SAMIJS2",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIJS2",4,0)
 ;
"RTN","SAMIJS2",5,0)
 ; Routine SAMIJS2 contains more subroutines for importing VAPALS-
"RTN","SAMIJS2",6,0)
 ; ELCAP JSON archives, which are used for import, export, & migration
"RTN","SAMIJS2",7,0)
 ; of SAMI data.
"RTN","SAMIJS2",8,0)
 ;
"RTN","SAMIJS2",9,0)
 quit  ; no entry from top
"RTN","SAMIJS2",10,0)
 ;
"RTN","SAMIJS2",11,0)
 ;
"RTN","SAMIJS2",12,0)
 ;
"RTN","SAMIJS2",13,0)
 ;@section 0 primary development
"RTN","SAMIJS2",14,0)
 ;
"RTN","SAMIJS2",15,0)
 ;
"RTN","SAMIJS2",16,0)
 ;
"RTN","SAMIJS2",17,0)
 ;@routine-credits
"RTN","SAMIJS2",18,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMIJS2",19,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIJS2",20,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIJS2",21,0)
 ; http://vistaexpertise.net
"RTN","SAMIJS2",22,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIJS2",23,0)
 ;@license see routine SAMIUL
"RTN","SAMIJS2",24,0)
 ;
"RTN","SAMIJS2",25,0)
 ;@last-updated 2021-07-01t17:08z
"RTN","SAMIJS2",26,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIJS2",27,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIJS2",28,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIJS2",29,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIJS2",30,0)
 ;@release-date 2020-01
"RTN","SAMIJS2",31,0)
 ;@patch-list **12**
"RTN","SAMIJS2",32,0)
 ;
"RTN","SAMIJS2",33,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIJS2",34,0)
 ; toad@vistaexpertise.net
"RTN","SAMIJS2",35,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMIJS2",36,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIJS2",37,0)
 ;
"RTN","SAMIJS2",38,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIJS2",39,0)
 ; see routine SAMIJS1 for dev log.
"RTN","SAMIJS2",40,0)
 ;
"RTN","SAMIJS2",41,0)
 ;@contents
"RTN","SAMIJS2",42,0)
 ; FILE load files from file system
"RTN","SAMIJS2",43,0)
 ; wsPostSAMI accept incoming SAMI record in VAPALS
"RTN","SAMIJS2",44,0)
 ; $$loaded is filename already loaded?
"RTN","SAMIJS2",45,0)
 ; 
"RTN","SAMIJS2",46,0)
 ;
"RTN","SAMIJS2",47,0)
 ;
"RTN","SAMIJS2",48,0)
 ;@section 1 subroutines
"RTN","SAMIJS2",49,0)
 ;
"RTN","SAMIJS2",50,0)
 ;
"RTN","SAMIJS2",51,0)
 ;
"RTN","SAMIJS2",52,0)
FILE(directory) ; [Public] Load files from the file system; OPT: SAMI LOAD FILES
"RTN","SAMIJS2",53,0)
 ;
"RTN","SAMIJS2",54,0)
 if '$data(directory) do
"RTN","SAMIJS2",55,0)
 . N DIR,X,Y,DA,DIRUT,DTOUT,DUOUT,DIROUT
"RTN","SAMIJS2",56,0)
 . S DIR(0)="F^0:1024"
"RTN","SAMIJS2",57,0)
 . S DIR("A")="Enter directory from which to load Patients"
"RTN","SAMIJS2",58,0)
 . D ^DIR
"RTN","SAMIJS2",59,0)
 . W !
"RTN","SAMIJS2",60,0)
 . if '$data(DIRUT) set directory=Y
"RTN","SAMIJS2",61,0)
 quit:'$data(directory)
"RTN","SAMIJS2",62,0)
 ;
"RTN","SAMIJS2",63,0)
 ; Load files from directory
"RTN","SAMIJS2",64,0)
 new samifiles
"RTN","SAMIJS2",65,0)
 new samimask set samimask("*.json")=""
"RTN","SAMIJS2",66,0)
 new % set %=$$LIST^%ZISH(directory,$na(samimask),$na(samifiles))
"RTN","SAMIJS2",67,0)
 if '% write "Failed to read any files. Check directory.",! quit
"RTN","SAMIJS2",68,0)
 ;
"RTN","SAMIJS2",69,0)
 new file set file=""
"RTN","SAMIJS2",70,0)
 for  set file=$order(samifiles(file)) q:file=""  do
"RTN","SAMIJS2",71,0)
 . if file["Information" quit  ; We don't process information files yet...
"RTN","SAMIJS2",72,0)
 . ;
"RTN","SAMIJS2",73,0)
 . write "Loading ",file,"...",!
"RTN","SAMIJS2",74,0)
 . if $$loaded(file) d  q  ;
"RTN","SAMIJS2",75,0)
 .. w "already loaded, skipping "_file,!
"RTN","SAMIJS2",76,0)
 . ;
"RTN","SAMIJS2",77,0)
 . kill ^TMP("SAMIFILE",$J)
"RTN","SAMIJS2",78,0)
 . new % set %=$$FTG^%ZISH(directory,file,$name(^TMP("SAMIFILE",$J,1)),3)
"RTN","SAMIJS2",79,0)
 . i '% write "Failed to read the file. Please debug me.",! quit
"RTN","SAMIJS2",80,0)
 . ;
"RTN","SAMIJS2",81,0)
 . ; Normalize overflow nodes (and hope for the best that we don't go over 32k)
"RTN","SAMIJS2",82,0)
 . new i,j set (i,j)=""
"RTN","SAMIJS2",83,0)
 . for  set i=$order(^TMP("SAMIFILE",$J,i)) quit:'i  for  set j=$order(^TMP("SAMIFILE",$J,i,"OVF",j)) quit:'j  do
"RTN","SAMIJS2",84,0)
 .. set ^TMP("SAMIFILE",$J,i)=^TMP("SAMIFILE",$J,i)_^TMP("SAMIFILE",$J,i,"OVF",j)  ; ** NOT TESTED **
"RTN","SAMIJS2",85,0)
 . ;
"RTN","SAMIJS2",86,0)
 . ; Now load the file into Vapals
"RTN","SAMIJS2",87,0)
 . write "Ingesting ",file,"...",!
"RTN","SAMIJS2",88,0)
 . ;
"RTN","SAMIJS2",89,0)
 . do
"RTN","SAMIJS2",90,0)
 .. new samifiles,file,directory
"RTN","SAMIJS2",91,0)
 .. do KILL^XUSCLEAN ; VistA leaks like hell
"RTN","SAMIJS2",92,0)
 . ;
"RTN","SAMIJS2",93,0)
 . new root set root=$$setroot^%wd("vapals-intake")
"RTN","SAMIJS2",94,0)
 . new ien set ien=$order(@root@(" "),-1)+1
"RTN","SAMIJS2",95,0)
 . new gr set gr=$name(@root@(ien,"json"))
"RTN","SAMIJS2",96,0)
 . do decode^%webjson($na(^TMP("SAMIFILE",$J)),gr)
"RTN","SAMIJS2",97,0)
 . set @root@("file",file,ien)=""
"RTN","SAMIJS2",98,0)
 . new args,samijsonreturn
"RTN","SAMIJS2",99,0)
 . new % set %=$$wsPostSAMI(.args,,.samijsonreturn,ien) ; ignore % which always comes out at 1
"RTN","SAMIJS2",100,0)
 . ;
"RTN","SAMIJS2",101,0)
 . ; Get the status back from JSON
"RTN","SAMIJS2",102,0)
 . new samireturn,samijsonerror
"RTN","SAMIJS2",103,0)
 . do decode^%webjson($na(samijsonreturn),$na(samireturn),$na(samijsonerror))
"RTN","SAMIJS2",104,0)
 . if $data(samijsonerror) write "There is an error decoding the return. Debug me." quit
"RTN","SAMIJS2",105,0)
 . ;
"RTN","SAMIJS2",106,0)
 . q:'$d(samireturn)
"RTN","SAMIJS2",107,0)
 . if $get(samireturn("loadMessage"))["Duplicate" write "Patient Already Loaded",! quit
"RTN","SAMIJS2",108,0)
 . n errmsg s errmsg=$get(samireturn("loadMessage"))
"RTN","SAMIJS2",109,0)
 . if errmsg["Error" d  q  ;
"RTN","SAMIJS2",110,0)
 . . write errmsg,!
"RTN","SAMIJS2",111,0)
 . write " ",errmsg,!
"RTN","SAMIJS2",112,0)
 . ;
"RTN","SAMIJS2",113,0)
 . write " Loaded with following data: ",!
"RTN","SAMIJS2",114,0)
 . write "DFN: ",$g(samireturn("dfn")),?15,"STUDYID: ",$g(samireturn("sid")),?25," LIEN: ",$g(samireturn("ien")),?50,"Name: ",$g(samireturn("name")),!
"RTN","SAMIJS2",115,0)
 . write "--------------------------------------------------------------------------",!
"RTN","SAMIJS2",116,0)
 . ;b
"RTN","SAMIJS2",117,0)
 q
"RTN","SAMIJS2",118,0)
 ;
"RTN","SAMIJS2",119,0)
 ;
"RTN","SAMIJS2",120,0)
 ;
"RTN","SAMIJS2",121,0)
wsPostSAMI(args,body,return,ien) ; accept incoming SAMI record in VAPALS
"RTN","SAMIJS2",122,0)
 ;
"RTN","SAMIJS2",123,0)
 n rtn
"RTN","SAMIJS2",124,0)
 n lroot,proot,iroot
"RTN","SAMIJS2",125,0)
 s iroot=$$setroot^%wd("vapals-intake")
"RTN","SAMIJS2",126,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIJS2",127,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIJS2",128,0)
 n lien,pien,grloaded,dfn,sid
"RTN","SAMIJS2",129,0)
 s (lien,pien,grloaded)=0
"RTN","SAMIJS2",130,0)
 i '$d(@iroot@(ien,"json","patient","lookup")) d  q  ;
"RTN","SAMIJS2",131,0)
 . s rtn("loadMessage")="Error, patient lookup missing"
"RTN","SAMIJS2",132,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",133,0)
 ; so, what is the dfn.. it is the number for this patient on this system
"RTN","SAMIJS2",134,0)
 ;s dfn=$g(@iroot@(ien,"json","patient","lookup","dfn"))
"RTN","SAMIJS2",135,0)
 ;i dfn="" d  q  ;
"RTN","SAMIJS2",136,0)
 ;. s rtn("loadMessage")="Error, dfn missing"
"RTN","SAMIJS2",137,0)
 ;. d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",138,0)
 ;n newdfn s newdfn=0
"RTN","SAMIJS2",139,0)
 ;i $d(@lroot@("dfn",dfn)) d  ; oops need a new dfn for this system
"RTN","SAMIJS2",140,0)
 ;. s dfn=$o(@lroot@("dfn"," "),-1)+1
"RTN","SAMIJS2",141,0)
 ;. s newdfn=1 ; remember to propogate the new dfn
"RTN","SAMIJS2",142,0)
 s dfn=$o(@lroot@("dfn"," "),-1)+1
"RTN","SAMIJS2",143,0)
 i $o(@proot@("dfn"," "),-1)+1>dfn s dfn=$o(@proot@("dfn"," "),-1)+1
"RTN","SAMIJS2",144,0)
 s rtn("dfn")=dfn
"RTN","SAMIJS2",145,0)
 i '$d(@lroot@(dfn)) s lien=dfn
"RTN","SAMIJS2",146,0)
 e  s lien=$o(@lroot@(" "),-1)+1
"RTN","SAMIJS2",147,0)
 s rtn("ien")=lien
"RTN","SAMIJS2",148,0)
 ;i newdfn=1 s @lroot@(lien,"dfn")=dfn
"RTN","SAMIJS2",149,0)
 n name s name=$g(@iroot@(ien,"json","patient","lookup","saminame"))
"RTN","SAMIJS2",150,0)
 i name="" d  q  ;
"RTN","SAMIJS2",151,0)
 . s rtn("loadMessage")="Error, name missing"
"RTN","SAMIJS2",152,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",153,0)
 s rtn("name")=name
"RTN","SAMIJS2",154,0)
 m @lroot@(lien)=@iroot@(ien,"json","patient","lookup")
"RTN","SAMIJS2",155,0)
 s @lroot@(lien,"dfn")=dfn
"RTN","SAMIJS2",156,0)
 d INDXPTLK^SAMIHOM4(lien)
"RTN","SAMIJS2",157,0)
 ;
"RTN","SAMIJS2",158,0)
 ; detect if enrolled
"RTN","SAMIJS2",159,0)
 ;
"RTN","SAMIJS2",160,0)
 i '$d(@iroot@(ien,"json","patient","demos")) d  q  ;
"RTN","SAMIJS2",161,0)
 . s rtn("loadMessage")="Load sucessful, not enrolled"
"RTN","SAMIJS2",162,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",163,0)
 ; 
"RTN","SAMIJS2",164,0)
 ; determine pien in vapals-patients
"RTN","SAMIJS2",165,0)
 ;
"RTN","SAMIJS2",166,0)
 ;i '$d(@proot@(dfn)) s pien=dfn
"RTN","SAMIJS2",167,0)
 ;e  s pien=$$NEXTNUM^SAMIHOM3()
"RTN","SAMIJS2",168,0)
 s pien=$$NEXTNUM^SAMIHOM3()
"RTN","SAMIJS2",169,0)
 m @proot@(pien)=@iroot@(ien,"json","patient","demos")
"RTN","SAMIJS2",170,0)
 s @proot@("dfn",dfn,pien)=""
"RTN","SAMIJS2",171,0)
 ;i newdfn s @proot@(pien,"dfn")=dfn
"RTN","SAMIJS2",172,0)
 s @proot@(pien,"dfn")=dfn
"RTN","SAMIJS2",173,0)
 ;
"RTN","SAMIJS2",174,0)
 ; determine studyid (sid)
"RTN","SAMIJS2",175,0)
 ;
"RTN","SAMIJS2",176,0)
 n sid s sid=$g(@proot@(pien,"samistudyid"))
"RTN","SAMIJS2",177,0)
 i sid="" d  q  ;
"RTN","SAMIJS2",178,0)
 . s rtn("loadMessage")="Error, studyid missing"
"RTN","SAMIJS2",179,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",180,0)
 i $d(@proot@("sid",sid)) d  q  ; opps we need a new sid for this system
"RTN","SAMIJS2",181,0)
 . s rtn("loadMessage")="Error, studyid is not unique"
"RTN","SAMIJS2",182,0)
 . d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",183,0)
 s rtn("sid")=sid
"RTN","SAMIJS2",184,0)
 s @proot@("sid",sid,pien)=""
"RTN","SAMIJS2",185,0)
 ;
"RTN","SAMIJS2",186,0)
 ; merge in all the forms
"RTN","SAMIJS2",187,0)
 ;
"RTN","SAMIJS2",188,0)
 m @proot@("graph",sid)=@iroot@(ien,"json","patient","graph")
"RTN","SAMIJS2",189,0)
 ;
"RTN","SAMIJS2",190,0)
 ; encode the successful return
"RTN","SAMIJS2",191,0)
 ;
"RTN","SAMIJS2",192,0)
 s rtn("loadMessage")="Load successful, enrolled"
"RTN","SAMIJS2",193,0)
 d encode^%webjson("rtn","return","zerr")
"RTN","SAMIJS2",194,0)
 q
"RTN","SAMIJS2",195,0)
 ;
"RTN","SAMIJS2",196,0)
 ;
"RTN","SAMIJS2",197,0)
 ;
"RTN","SAMIJS2",198,0)
loaded(filenm,graph) ;extrinsic returns 1 if the filename is already loaded
"RTN","SAMIJS2",199,0)
 ; in the graph default for graph is vapals-intake
"RTN","SAMIJS2",200,0)
 if $g(graph)="" s graph="vapals-intake"
"RTN","SAMIJS2",201,0)
 n tmproot s tmproot=$$setroot^%wd(graph)
"RTN","SAMIJS2",202,0)
 i $d(@tmproot@("file",filenm)) q 1
"RTN","SAMIJS2",203,0)
 q 0
"RTN","SAMIJS2",204,0)
 ;
"RTN","SAMIJS2",205,0)
 ;
"RTN","SAMIJS2",206,0)
 ;
"RTN","SAMIJS2",207,0)
EOR ; end of routine SAMIJS2
"RTN","SAMINOT1")
0^11^B476873160
"RTN","SAMINOT1",1,0)
SAMINOT1 ;ven/gpl - text notes ;2021-07-01t17:21z
"RTN","SAMINOT1",2,0)
 ;;18.0;SAMI;**2,6,8,10,11,12**;2020-01;Build 6
"RTN","SAMINOT1",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMINOT1",4,0)
 ;
"RTN","SAMINOT1",5,0)
 ; SAMINOT1 contains a web service & associated subroutines to produce
"RTN","SAMINOT1",6,0)
 ; VAPALS-ELCAP text notes.
"RTN","SAMINOT1",7,0)
 ;
"RTN","SAMINOT1",8,0)
 quit  ; no entry from top
"RTN","SAMINOT1",9,0)
 ;
"RTN","SAMINOT1",10,0)
 ;
"RTN","SAMINOT1",11,0)
 ;
"RTN","SAMINOT1",12,0)
 ;@section 0 primary development
"RTN","SAMINOT1",13,0)
 ;
"RTN","SAMINOT1",14,0)
 ;
"RTN","SAMINOT1",15,0)
 ;
"RTN","SAMINOT1",16,0)
 ;@routine-credits
"RTN","SAMINOT1",17,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMINOT1",18,0)
 ; gpl@vistaexpertise.net
"RTN","SAMINOT1",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMINOT1",20,0)
 ; http://vistaexpertise.net
"RTN","SAMINOT1",21,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMINOT1",22,0)
 ;@license see routine SAMIUL
"RTN","SAMINOT1",23,0)
 ;
"RTN","SAMINOT1",24,0)
 ;@last-updated 2021-07-01t17:21z
"RTN","SAMINOT1",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMINOT1",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMINOT1",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMINOT1",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMINOT1",29,0)
 ;@release-date 2020-01
"RTN","SAMINOT1",30,0)
 ;@patch-list **2,6,8,10,11,12**
"RTN","SAMINOT1",31,0)
 ;
"RTN","SAMINOT1",32,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMINOT1",33,0)
 ; toad@vistaexpertise.net
"RTN","SAMINOT1",34,0)
 ;@additional-dev Larry G. Carlson (lgc)
"RTN","SAMINOT1",35,0)
 ; larry.g.carlson@gmail.com
"RTN","SAMINOT1",36,0)
 ;@additional-dev Linda M. R. Yaw (lmry)
"RTN","SAMINOT1",37,0)
 ; linda.yaw@vistaexpertise.net
"RTN","SAMINOT1",38,0)
 ;@additional-dev Alexis R. Carlson (arc)
"RTN","SAMINOT1",39,0)
 ; whatisthehumanspirit@gmail.com
"RTN","SAMINOT1",40,0)
 ;@additional-dev Domenic DiNatale (dom)
"RTN","SAMINOT1",41,0)
 ; domenic.dinatale@paraxialtech.com
"RTN","SAMINOT1",42,0)
 ;
"RTN","SAMINOT1",43,0)
 ;@module-credits
"RTN","SAMINOT1",44,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMINOT1",45,0)
 ; (VA-PALS)
"RTN","SAMINOT1",46,0)
 ; http://va-pals.org/
"RTN","SAMINOT1",47,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMINOT1",48,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMINOT1",49,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMINOT1",50,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMINOT1",51,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMINOT1",52,0)
 ; http://ielcap.com/
"RTN","SAMINOT1",53,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMINOT1",54,0)
 ; http://paraxialtech.com/
"RTN","SAMINOT1",55,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMINOT1",56,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMINOT1",57,0)
 ;
"RTN","SAMINOT1",58,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMINOT1",59,0)
 ; see routine SAMINUL
"RTN","SAMINOT1",60,0)
 ;
"RTN","SAMINOT1",61,0)
 ;@contents
"RTN","SAMINOT1",62,0)
 ; $$EXISTCE does chart eligibility note exist?
"RTN","SAMINOT1",63,0)
 ; $$EXISTPRE does pre-enrollment note exist?
"RTN","SAMINOT1",64,0)
 ; $$EXISTINT does intake note exist?
"RTN","SAMINOT1",65,0)
 ; WSNOTE web service: text note
"RTN","SAMINOT1",66,0)
 ; NOTE create note
"RTN","SAMINOT1",67,0)
 ; $$HASINNT is intake note present?
"RTN","SAMINOT1",68,0)
 ; MKEL make eligibility note
"RTN","SAMINOT1",69,0)
 ; MKPRE make pre-enrollment note
"RTN","SAMINOT1",70,0)
 ; MKIN make intake note
"RTN","SAMINOT1",71,0)
 ; $$MKNT make note
"RTN","SAMINOT1",72,0)
 ; $$MKNTLOC location for note
"RTN","SAMINOT1",73,0)
 ; $$NTDTTM date & time in note format
"RTN","SAMINOT1",74,0)
 ; $$NTLOCN location of nth note
"RTN","SAMINOT1",75,0)
 ; $$NTLAST location of latest note
"RTN","SAMINOT1",76,0)
 ; $$NTIEN latest note for this form
"RTN","SAMINOT1",77,0)
 ; $$NTLIST note list
"RTN","SAMINOT1",78,0)
 ; TLST ???
"RTN","SAMINOT1",79,0)
 ; ELNOTE eligibility note text
"RTN","SAMINOT1",80,0)
 ; PRENOTE pre-enrollment note
"RTN","SAMINOT1",81,0)
 ; SUBRSLT translation of discussion result
"RTN","SAMINOT1",82,0)
 ; INNOTE intake note
"RTN","SAMINOT1",83,0)
 ; SDM add shared decision making text to array
"RTN","SAMINOT1",84,0)
 ; GLOUT glob out, 1st wrap ln, then put in dest
"RTN","SAMINOT1",85,0)
 ; OUT ???
"RTN","SAMINOT1",86,0)
 ; $$XVAL patient value for variable
"RTN","SAMINOT1",87,0)
 ;
"RTN","SAMINOT1",88,0)
 ;
"RTN","SAMINOT1",89,0)
 ;
"RTN","SAMINOT1",90,0)
 ;@section 1 wsi WSNOTE^SAMINOT1 & related subroutines
"RTN","SAMINOT1",91,0)
 ;
"RTN","SAMINOT1",92,0)
 ;
"RTN","SAMINOT1",93,0)
 ;
"RTN","SAMINOT1",94,0)
EXISTCE(SID,FORM) ; extrinsic returns "true" or "false"
"RTN","SAMINOT1",95,0)
 ;
"RTN","SAMINOT1",96,0)
 ; if a Chart Eligibility Note exists
"RTN","SAMINOT1",97,0)
 ;
"RTN","SAMINOT1",98,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT1",99,0)
 n gvals s gvals=$na(@root@("graph",SID,FORM))
"RTN","SAMINOT1",100,0)
 ;i $g(@root@("graph",SID,FORM,"sicechrt"))="y" q "true"
"RTN","SAMINOT1",101,0)
 i $g(@gvals@("chart-eligibility-complete"))="true" q "true"
"RTN","SAMINOT1",102,0)
 ;
"RTN","SAMINOT1",103,0)
 quit "false" ; end of $$EXISTCE
"RTN","SAMINOT1",104,0)
 ;
"RTN","SAMINOT1",105,0)
 ;
"RTN","SAMINOT1",106,0)
 ;
"RTN","SAMINOT1",107,0)
EXISTPRE(SID,FORM) ; extrinsic returns "true" or "false"
"RTN","SAMINOT1",108,0)
 ;
"RTN","SAMINOT1",109,0)
 ; if a Pre-enrollment Note exists
"RTN","SAMINOT1",110,0)
 ;
"RTN","SAMINOT1",111,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT1",112,0)
 n gvals s gvals=$na(@root@("graph",SID,FORM))
"RTN","SAMINOT1",113,0)
 ;i $g(@root@("graph",SID,FORM,"sipedisc"))="y" q "true"
"RTN","SAMINOT1",114,0)
 ;i $g(@gvals@("pre-note-complete"))="true" i $g(@gvals@("siperslt"))="y" q "true"
"RTN","SAMINOT1",115,0)
 i $g(@gvals@("pre-note-complete"))="true" q "true"
"RTN","SAMINOT1",116,0)
 ;
"RTN","SAMINOT1",117,0)
 quit "false" ; end of $$EXISTPRE
"RTN","SAMINOT1",118,0)
 ;
"RTN","SAMINOT1",119,0)
 ;
"RTN","SAMINOT1",120,0)
 ;
"RTN","SAMINOT1",121,0)
EXISTINT(SID,FORM) ; extrinsic returns "true" or "false"
"RTN","SAMINOT1",122,0)
 ;
"RTN","SAMINOT1",123,0)
 ; if an Intake Note exists
"RTN","SAMINOT1",124,0)
 ;
"RTN","SAMINOT1",125,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT1",126,0)
 i $g(@root@("graph",SID,FORM,"sistatus"))="y" q "true"
"RTN","SAMINOT1",127,0)
 ;
"RTN","SAMINOT1",128,0)
 quit "false" ; end of $$EXISTINT
"RTN","SAMINOT1",129,0)
 ;
"RTN","SAMINOT1",130,0)
 ;
"RTN","SAMINOT1",131,0)
 ;
"RTN","SAMINOT1",132,0)
WSNOTE(return,filter) ; web service which returns a text note
"RTN","SAMINOT1",133,0)
 ;
"RTN","SAMINOT1",134,0)
 n debug s debug=0
"RTN","SAMINOT1",135,0)
 i $g(filter("debug"))=1 s debug=1
"RTN","SAMINOT1",136,0)
 ;
"RTN","SAMINOT1",137,0)
 k return
"RTN","SAMINOT1",138,0)
 s HTTPRSP("mime")="text/html"
"RTN","SAMINOT1",139,0)
 ;
"RTN","SAMINOT1",140,0)
 n si
"RTN","SAMINOT1",141,0)
 s si=$g(filter("studyid"))
"RTN","SAMINOT1",142,0)
 i si="" d  ;
"RTN","SAMINOT1",143,0)
 . s si="XXX00333"
"RTN","SAMINOT1",144,0)
 q:si=""
"RTN","SAMINOT1",145,0)
 ;
"RTN","SAMINOT1",146,0)
 n samikey
"RTN","SAMINOT1",147,0)
 s samikey=$g(filter("form"))
"RTN","SAMINOT1",148,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT1",149,0)
 i samikey="" d  ;
"RTN","SAMINOT1",150,0)
 . s samikey=$o(@root@("graph",si,"siform"))
"RTN","SAMINOT1",151,0)
 . ;w !,samikey
"RTN","SAMINOT1",152,0)
 . ;b
"RTN","SAMINOT1",153,0)
 ;
"RTN","SAMINOT1",154,0)
 n vals
"RTN","SAMINOT1",155,0)
 m vals=@root@("graph",si,samikey)
"RTN","SAMINOT1",156,0)
 ;
"RTN","SAMINOT1",157,0)
 n note,nien,ntype
"RTN","SAMINOT1",158,0)
 s ntype=""
"RTN","SAMINOT1",159,0)
 s note=""
"RTN","SAMINOT1",160,0)
 s nien=$g(filter("nien"))
"RTN","SAMINOT1",161,0)
 i nien="" d
"RTN","SAMINOT1",162,0)
 . s:$g(vals("samistatus"))="complete" ntype="intake"
"RTN","SAMINOT1",163,0)
 . s:$g(vals("samistatus"))="chart-eligibility" ntype="eligibility"
"RTN","SAMINOT1",164,0)
 . s:$g(vals("samistatus"))="pre-enrollment-discussion" ntype="pre-note"
"RTN","SAMINOT1",165,0)
 . q:ntype=""
"RTN","SAMINOT1",166,0)
 . ;d nien=$$NTTYPE add code to pull the latest note by type
"RTN","SAMINOT1",167,0)
 q:nien=""
"RTN","SAMINOT1",168,0)
 n notebase
"RTN","SAMINOT1",169,0)
 s notebase=$$NTLOCN(si,samikey,nien) ; global location for the note
"RTN","SAMINOT1",170,0)
 s note=$na(@notebase@("text"))
"RTN","SAMINOT1",171,0)
 i '$d(@note) q
"RTN","SAMINOT1",172,0)
 ;
"RTN","SAMINOT1",173,0)
 new temp,tout
"RTN","SAMINOT1",174,0)
 do GETTMPL^SAMICASE("temp","vapals:note")
"RTN","SAMINOT1",175,0)
 quit:'$data(temp)
"RTN","SAMINOT1",176,0)
 ;
"RTN","SAMINOT1",177,0)
 n cnt s cnt=0
"RTN","SAMINOT1",178,0)
 n zi s zi=""
"RTN","SAMINOT1",179,0)
 ;
"RTN","SAMINOT1",180,0)
 f  s zi=$o(temp(zi)) q:zi=""  d  ;
"RTN","SAMINOT1",181,0)
 . ;
"RTN","SAMINOT1",182,0)
 . n line s line=temp(zi)
"RTN","SAMINOT1",183,0)
 . D LOAD^SAMIFORM(.line,samikey,si,.filter,.vals)
"RTN","SAMINOT1",184,0)
 . s temp(zi)=line
"RTN","SAMINOT1",185,0)
 . ;
"RTN","SAMINOT1",186,0)
 . s cnt=cnt+1
"RTN","SAMINOT1",187,0)
 . s tout(cnt)=temp(zi)
"RTN","SAMINOT1",188,0)
 . ;
"RTN","SAMINOT1",189,0)
 . i temp(zi)["report-text" d  ;
"RTN","SAMINOT1",190,0)
 . . i temp(zi)["#" q  ;
"RTN","SAMINOT1",191,0)
 . . n zj s zj=""
"RTN","SAMINOT1",192,0)
 . . f  s zj=$o(@note@(zj)) q:zj=""  d  ;
"RTN","SAMINOT1",193,0)
 . . . s cnt=cnt+1
"RTN","SAMINOT1",194,0)
 . . . ;s tout(cnt)=@note@(zj)_"<br>"
"RTN","SAMINOT1",195,0)
 . . . s tout(cnt)=@note@(zj)_$char(13,10)
"RTN","SAMINOT1",196,0)
 m return=tout
"RTN","SAMINOT1",197,0)
 ;
"RTN","SAMINOT1",198,0)
 quit  ; end of WSNOTE
"RTN","SAMINOT1",199,0)
 ;
"RTN","SAMINOT1",200,0)
 ;
"RTN","SAMINOT1",201,0)
 ;
"RTN","SAMINOT1",202,0)
NOTE(filter) ; extrnisic which creates a note
"RTN","SAMINOT1",203,0)
 ;
"RTN","SAMINOT1",204,0)
 ; returns 1 if successful, 0 if not
"RTN","SAMINOT1",205,0)
 ;
"RTN","SAMINOT1",206,0)
 ; set up patient values
"RTN","SAMINOT1",207,0)
 ;
"RTN","SAMINOT1",208,0)
 n vals
"RTN","SAMINOT1",209,0)
 ;
"RTN","SAMINOT1",210,0)
 n si
"RTN","SAMINOT1",211,0)
 s si=$g(filter("studyid"))
"RTN","SAMINOT1",212,0)
 i si="" d  ;
"RTN","SAMINOT1",213,0)
 . s si="XXX00333"
"RTN","SAMINOT1",214,0)
 q:si=""
"RTN","SAMINOT1",215,0)
 ;
"RTN","SAMINOT1",216,0)
 n samikey
"RTN","SAMINOT1",217,0)
 s samikey=$g(filter("form"))
"RTN","SAMINOT1",218,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT1",219,0)
 i samikey="" d  ;
"RTN","SAMINOT1",220,0)
 . s samikey=$o(@root@("graph",si,"siform"))
"RTN","SAMINOT1",221,0)
 . ;w !,samikey
"RTN","SAMINOT1",222,0)
 . ;b
"RTN","SAMINOT1",223,0)
 ;
"RTN","SAMINOT1",224,0)
 s vals=$na(@root@("graph",si,samikey))
"RTN","SAMINOT1",225,0)
 ;
"RTN","SAMINOT1",226,0)
 i '$d(@vals) d  q 0 ;
"RTN","SAMINOT1",227,0)
 . ;w !,"error, patient values not found"
"RTN","SAMINOT1",228,0)
 ;zwr @vals@(*)
"RTN","SAMINOT1",229,0)
 ;
"RTN","SAMINOT1",230,0)
 k ^SAMIUL("NOTE")
"RTN","SAMINOT1",231,0)
 m ^SAMIUL("NOTE","vals")=@vals
"RTN","SAMINOT1",232,0)
 m ^SAMIUL("NOTE","filter")=filter
"RTN","SAMINOT1",233,0)
 ;
"RTN","SAMINOT1",234,0)
 n didnote s didnote=0
"RTN","SAMINOT1",235,0)
 ;
"RTN","SAMINOT1",236,0)
 i $g(@vals@("samistatus"))="chart-eligibility" d  ;
"RTN","SAMINOT1",237,0)
 . q:$g(@vals@("chart-eligibility-complete"))="true"
"RTN","SAMINOT1",238,0)
 . d MKEL(si,samikey,vals,.filter) ;
"RTN","SAMINOT1",239,0)
 . s didnote=1
"RTN","SAMINOT1",240,0)
 ;
"RTN","SAMINOT1",241,0)
 i $g(@vals@("samistatus"))="pre-enrollment-discussion" d  ;
"RTN","SAMINOT1",242,0)
 . q:$g(@vals@("pre-note-complete"))="true"
"RTN","SAMINOT1",243,0)
 . d MKPRE(si,samikey,vals,.filter) ;
"RTN","SAMINOT1",244,0)
 . s didnote=1
"RTN","SAMINOT1",245,0)
 ;
"RTN","SAMINOT1",246,0)
 i $g(@vals@("samistatus"))="complete" d  ;
"RTN","SAMINOT1",247,0)
 . q:$$HASINNT(vals)
"RTN","SAMINOT1",248,0)
 . d MKIN(si,samikey,vals,.filter) ;
"RTN","SAMINOT1",249,0)
 . s didnote=1
"RTN","SAMINOT1",250,0)
 ;
"RTN","SAMINOT1",251,0)
 n nien s nien=0
"RTN","SAMINOT1",252,0)
 i didnote=1 s nien=$$NTIEN(si,samikey)
"RTN","SAMINOT1",253,0)
 ;
"RTN","SAMINOT1",254,0)
 quit nien ; end of $$NOTE
"RTN","SAMINOT1",255,0)
 ;
"RTN","SAMINOT1",256,0)
 ;
"RTN","SAMINOT1",257,0)
 ;
"RTN","SAMINOT1",258,0)
HASINNT(vals) ; extrinsic returns 1 if intake note is present
"RTN","SAMINOT1",259,0)
 ;
"RTN","SAMINOT1",260,0)
 ; else returns 0
"RTN","SAMINOT1",261,0)
 ;
"RTN","SAMINOT1",262,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT1",263,0)
 q:'$d(@vals)
"RTN","SAMINOT1",264,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT1",265,0)
 . i $g(@vals@("notes",zzi,"name"))["Intake" s zzrtn=1
"RTN","SAMINOT1",266,0)
 ;
"RTN","SAMINOT1",267,0)
 quit zzrtn ; end of $$HASINNT
"RTN","SAMINOT1",268,0)
 ;
"RTN","SAMINOT1",269,0)
 ;
"RTN","SAMINOT1",270,0)
 ;
"RTN","SAMINOT1",271,0)
MKEL(sid,form,vals,filter) ;
"RTN","SAMINOT1",272,0)
 ;
"RTN","SAMINOT1",273,0)
 n cnt s cnt=0
"RTN","SAMINOT1",274,0)
 ;n dest s dest=$na(@vals@("eligibility-note"))
"RTN","SAMINOT1",275,0)
 n dest s dest=$$MKNT(vals,"Eligibility Note","eligibility",.filter)
"RTN","SAMINOT1",276,0)
 k @dest
"RTN","SAMINOT1",277,0)
 d OUT("Lung Screening Program Chart Eligibility Note")
"RTN","SAMINOT1",278,0)
 d OUT("")
"RTN","SAMINOT1",279,0)
 d ELNOTE(vals,dest,cnt)
"RTN","SAMINOT1",280,0)
 ;
"RTN","SAMINOT1",281,0)
 quit  ; end of MKEL
"RTN","SAMINOT1",282,0)
 ;
"RTN","SAMINOT1",283,0)
 ;
"RTN","SAMINOT1",284,0)
 ;
"RTN","SAMINOT1",285,0)
MKPRE(sid,form,vals,filter) ;
"RTN","SAMINOT1",286,0)
 ;
"RTN","SAMINOT1",287,0)
 n cnt s cnt=0
"RTN","SAMINOT1",288,0)
 ;n dest s dest=$na(@vals@("pre-note"))
"RTN","SAMINOT1",289,0)
 n dest s dest=$$MKNT(vals,"Pre-enrollment Discussion Note","prenote",.filter)
"RTN","SAMINOT1",290,0)
 k @dest
"RTN","SAMINOT1",291,0)
 i $g(@vals@("chart-eligibility-complete"))'="true" d  ;
"RTN","SAMINOT1",292,0)
 . d OUT("Lung Screening Program Chart Eligibility and Pre-enrollment Discussion Note")
"RTN","SAMINOT1",293,0)
 . d OUT("")
"RTN","SAMINOT1",294,0)
 . d ELNOTE(vals,dest,cnt)
"RTN","SAMINOT1",295,0)
 i $g(@vals@("chart-eligibility-complete"))="true" d  ;
"RTN","SAMINOT1",296,0)
 . d OUT("Lung Screening Program Pre-enrollment Discussion Note")
"RTN","SAMINOT1",297,0)
 . d OUT("")
"RTN","SAMINOT1",298,0)
 d PRENOTE(vals,dest,cnt)
"RTN","SAMINOT1",299,0)
 ;
"RTN","SAMINOT1",300,0)
 quit  ; end of MKPRE
"RTN","SAMINOT1",301,0)
 ;
"RTN","SAMINOT1",302,0)
 ;
"RTN","SAMINOT1",303,0)
 ;
"RTN","SAMINOT1",304,0)
MKIN(sid,form,vals,filter) ;
"RTN","SAMINOT1",305,0)
 ;
"RTN","SAMINOT1",306,0)
 n cnt s cnt=0
"RTN","SAMINOT1",307,0)
 ;n dest s dest=$na(@vals@("intake-note"))
"RTN","SAMINOT1",308,0)
 n dest s dest=$$MKNT(vals,"Intake Note","intake",.filter)
"RTN","SAMINOT1",309,0)
 k @dest
"RTN","SAMINOT1",310,0)
 d OUT("Lung Screening Program Intake Note")
"RTN","SAMINOT1",311,0)
 d OUT("")
"RTN","SAMINOT1",312,0)
 i $g(@vals@("chart-eligibility-complete"))'="true" d  ;
"RTN","SAMINOT1",313,0)
 . d ELNOTE(vals,dest,cnt)
"RTN","SAMINOT1",314,0)
 i $g(@vals@("pre-note-complete"))'="true" d  ;
"RTN","SAMINOT1",315,0)
 . d PRENOTE(vals,dest,cnt)
"RTN","SAMINOT1",316,0)
 d INNOTE(vals,dest,cnt)
"RTN","SAMINOT1",317,0)
 ;
"RTN","SAMINOT1",318,0)
 quit  ; end of MKIN
"RTN","SAMINOT1",319,0)
 ;
"RTN","SAMINOT1",320,0)
 ;
"RTN","SAMINOT1",321,0)
 ;
"RTN","SAMINOT1",322,0)
MKNT(vals,title,ntype,filter) ; extrinsic makes a note date=now returns 
"RTN","SAMINOT1",323,0)
 ;
"RTN","SAMINOT1",324,0)
 ; global addr. filter must be passed by reference
"RTN","SAMINOT1",325,0)
 ;
"RTN","SAMINOT1",326,0)
 n ntdt s ntdt=$$NTDTTM($$NOW^XLFDT)
"RTN","SAMINOT1",327,0)
 n ntptr
"RTN","SAMINOT1",328,0)
 s ntptr=$$MKNTLOC(vals,title,ntdt,$g(ntype),.filter)
"RTN","SAMINOT1",329,0)
 ;
"RTN","SAMINOT1",330,0)
 quit ntptr ; end of $$MKNT
"RTN","SAMINOT1",331,0)
 ;
"RTN","SAMINOT1",332,0)
 ;
"RTN","SAMINOT1",333,0)
 ;
"RTN","SAMINOT1",334,0)
MKNTLOC(vals,title,ndate,ntype,filter) ; extrinsic returns the 
"RTN","SAMINOT1",335,0)
 ;
"RTN","SAMINOT1",336,0)
 ;location for the note
"RTN","SAMINOT1",337,0)
 ;
"RTN","SAMINOT1",338,0)
 n nien
"RTN","SAMINOT1",339,0)
 s nien=$o(@vals@("notes",""),-1)+1
"RTN","SAMINOT1",340,0)
 s filter("nien")=nien
"RTN","SAMINOT1",341,0)
 n nloc s nloc=$na(@vals@("notes",nien))
"RTN","SAMINOT1",342,0)
 s @nloc@("name")=title_" "_$g(ndate)
"RTN","SAMINOT1",343,0)
 s @nloc@("date")=$g(ndate)
"RTN","SAMINOT1",344,0)
 s @nloc@("type")=$g(ntype)
"RTN","SAMINOT1",345,0)
 ;
"RTN","SAMINOT1",346,0)
 quit $name(@nloc@("text")) ; end of $$MKNTLOC
"RTN","SAMINOT1",347,0)
 ;
"RTN","SAMINOT1",348,0)
 ;
"RTN","SAMINOT1",349,0)
 ;
"RTN","SAMINOT1",350,0)
NTDTTM(ZFMDT) ; extrinsic returns the date and time in Note format
"RTN","SAMINOT1",351,0)
 ;
"RTN","SAMINOT1",352,0)
 ; ZFMDT is the fileman date/time to translate
"RTN","SAMINOT1",353,0)
 ;
"RTN","SAMINOT1",354,0)
 quit $$FMTE^XLFDT(ZFMDT,"5") ; end of $$NTDTTM
"RTN","SAMINOT1",355,0)
 ;
"RTN","SAMINOT1",356,0)
 ;
"RTN","SAMINOT1",357,0)
 ;
"RTN","SAMINOT1",358,0)
NTLOCN(sid,form,nien) ; extrinsic returns the location of the Nth note
"RTN","SAMINOT1",359,0)
 ;
"RTN","SAMINOT1",360,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT1",361,0)
 ;
"RTN","SAMINOT1",362,0)
 quit $name(@root@("graph",sid,form,"notes",nien)) ; end of $$NTLOCN
"RTN","SAMINOT1",363,0)
 ;
"RTN","SAMINOT1",364,0)
 ;
"RTN","SAMINOT1",365,0)
 ;
"RTN","SAMINOT1",366,0)
NTLAST(sid,form,ntype) ; extrinsic returns the location of the latest note
"RTN","SAMINOT1",367,0)
 ;
"RTN","SAMINOT1",368,0)
 ; of the type ntype
"RTN","SAMINOT1",369,0)
 ;
"RTN","SAMINOT1",370,0)
 quit  ; end of NTLAST
"RTN","SAMINOT1",371,0)
 ;
"RTN","SAMINOT1",372,0)
 ;
"RTN","SAMINOT1",373,0)
 ;
"RTN","SAMINOT1",374,0)
NTIEN(sid,form) ; extrinsic which returns the latest note for this form
"RTN","SAMINOT1",375,0)
 ;
"RTN","SAMINOT1",376,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT1",377,0)
 n rtn s rtn=$o(@root@("graph",sid,form,"notes"," "),-1)
"RTN","SAMINOT1",378,0)
 ;
"RTN","SAMINOT1",379,0)
 quit rtn ; end of $$NTIEN
"RTN","SAMINOT1",380,0)
 ;
"RTN","SAMINOT1",381,0)
 ;
"RTN","SAMINOT1",382,0)
 ;
"RTN","SAMINOT1",383,0)
NTLIST(nlist,sid,form) ; returns the note list in nlist, passed by ref
"RTN","SAMINOT1",384,0)
 ;
"RTN","SAMINOT1",385,0)
 n zn,root,gn
"RTN","SAMINOT1",386,0)
 s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT1",387,0)
 s zn=0
"RTN","SAMINOT1",388,0)
 s gn=$na(@root@("graph",sid,form,"notes"))
"RTN","SAMINOT1",389,0)
 q:'$d(@gn)
"RTN","SAMINOT1",390,0)
 f  s zn=$o(@gn@(zn)) q:+zn=0  d  ;
"RTN","SAMINOT1",391,0)
 . s @nlist@(zn,"name")=@gn@(zn,"name")
"RTN","SAMINOT1",392,0)
 . s @nlist@(zn,"nien")=zn
"RTN","SAMINOT1",393,0)
 ;
"RTN","SAMINOT1",394,0)
 quit  ; end of NTLIST
"RTN","SAMINOT1",395,0)
 ;
"RTN","SAMINOT1",396,0)
 ;
"RTN","SAMINOT1",397,0)
 ;
"RTN","SAMINOT1",398,0)
TLST ;
"RTN","SAMINOT1",399,0)
 ;
"RTN","SAMINOT1",400,0)
 set SID="XXX00677"
"RTN","SAMINOT1",401,0)
 set FORM="siform-2019-04-23"
"RTN","SAMINOT1",402,0)
 do NTLIST("G",SID,FORM)
"RTN","SAMINOT1",403,0)
 ;ZWR G
"RTN","SAMINOT1",404,0)
 ;
"RTN","SAMINOT1",405,0)
 quit  ; end of TLST
"RTN","SAMINOT1",406,0)
 ;
"RTN","SAMINOT1",407,0)
 ;
"RTN","SAMINOT1",408,0)
 ;
"RTN","SAMINOT1",409,0)
ELNOTE(vals,dest,cnt) ; eligibility NOTE TEXT
"RTN","SAMINOT1",410,0)
 ;
"RTN","SAMINOT1",411,0)
 D OUT("")
"RTN","SAMINOT1",412,0)
 D OUT("Date of chart review: "_$$XVAL("sidc",vals))
"RTN","SAMINOT1",413,0)
 D GLOUT("The participant was identified as a potential lung screening candidate by: ")
"RTN","SAMINOT1",414,0)
 D GLOUT($$XVAL("siceiden",vals),4)
"RTN","SAMINOT1",415,0)
 if $$XVAL("siceiden",vals)="referral" d  ;
"RTN","SAMINOT1",416,0)
 . D OUT("Date of Referral: "_$$XVAL("sicerfdt",vals))
"RTN","SAMINOT1",417,0)
 . n spec s spec=""
"RTN","SAMINOT1",418,0)
 . s:$$XVAL("sicerfpc",vals)="y" spec=spec_" Primary Care"
"RTN","SAMINOT1",419,0)
 . s:$$XVAL("sicerfwh",vals)="y" spec=spec_" Women's Health"
"RTN","SAMINOT1",420,0)
 . s:$$XVAL("sicerfge",vals)="y" spec=spec_" Geriatrics"
"RTN","SAMINOT1",421,0)
 . s:$$XVAL("sicerfpu",vals)="y" spec=spec_" Pulmonology"
"RTN","SAMINOT1",422,0)
 . s:$$XVAL("sicerfon",vals)="y" spec=spec_" Oncology"
"RTN","SAMINOT1",423,0)
 . s:$$XVAL("sicerfsc",vals)="y" spec=spec_" Smoking Cessation"
"RTN","SAMINOT1",424,0)
 . s:$$XVAL("sicerfot",vals)="y" spec=spec_" "_$$XVAL("sicerfoo",vals)
"RTN","SAMINOT1",425,0)
 . D GLOUT("Specialty of referring provider: ")
"RTN","SAMINOT1",426,0)
 . D GLOUT(spec,4)
"RTN","SAMINOT1",427,0)
 n elig
"RTN","SAMINOT1",428,0)
 s elig=$$XVAL("sicechrt",vals)
"RTN","SAMINOT1",429,0)
 D OUT("The participant is eligible based on chart review: "_$s(elig="y":"Yes",1:"no"))
"RTN","SAMINOT1",430,0)
 D OUT("")
"RTN","SAMINOT1",431,0)
 s @vals@("chart-eligibility-complete")="true"
"RTN","SAMINOT1",432,0)
 ;
"RTN","SAMINOT1",433,0)
 quit  ; end of ELNOTE
"RTN","SAMINOT1",434,0)
 ;
"RTN","SAMINOT1",435,0)
 ;
"RTN","SAMINOT1",436,0)
 ;
"RTN","SAMINOT1",437,0)
PRENOTE(vals,dest,cnt) ;
"RTN","SAMINOT1",438,0)
 ;
"RTN","SAMINOT1",439,0)
 i $g(@vals@("sipedisc"))'="y" q  ; no prelim discussion
"RTN","SAMINOT1",440,0)
 D OUT("")
"RTN","SAMINOT1",441,0)
 ;d OUT("A pre-enrollment discussion was held.")
"RTN","SAMINOT1",442,0)
 ;[If Yes is selected then add the following 5 lines]
"RTN","SAMINOT1",443,0)
 D OUT("The program attempted to reach the Veteran to discuss lung screening.")
"RTN","SAMINOT1",444,0)
 D OUT("Date of pre-enrollment discussion: "_$$XVAL("sipedc",vals))
"RTN","SAMINOT1",445,0)
 n via s via=""
"RTN","SAMINOT1",446,0)
 s:$$XVAL("sipecnip",vals)="1" via=via_" In person"
"RTN","SAMINOT1",447,0)
 s:$$XVAL("sipecnte",vals)="1" via=via_" Telephone"
"RTN","SAMINOT1",448,0)
 s:$$XVAL("sipecnth",vals)="1" via=via_" TeleHealth"
"RTN","SAMINOT1",449,0)
 s:$$XVAL("sipecnml",vals)="1" via=via_" Mailed Letter"
"RTN","SAMINOT1",450,0)
 s:$$XVAL("sipecnpp",vals)="1" via=via_" Message in patient portal"
"RTN","SAMINOT1",451,0)
 s:$$XVAL("sipecnvd",vals)="1" via=via_" Video-on-Demand (VOD)"
"RTN","SAMINOT1",452,0)
 s:$$XVAL("sipecnot",vals)="1" via=via_" "_$$XVAL("sipecnoo",vals)
"RTN","SAMINOT1",453,0)
 ;D OUT("The lung screening program reached the potential candidate or was contacted via:"_via)
"RTN","SAMINOT1",454,0)
 D GLOUT("The lung screening program reached the potential candidate or was contacted via:")
"RTN","SAMINOT1",455,0)
 D GLOUT(via,4)
"RTN","SAMINOT1",456,0)
 ;D OUT("The pre-enrollment discussion with the participant resulted in: "_$$SUBRSLT($$XVAL("siperslt",vals)))
"RTN","SAMINOT1",457,0)
 D OUT("The pre-enrollment discussion with the participant resulted in: ")
"RTN","SAMINOT1",458,0)
 D GLOUT($$SUBRSLT($$XVAL("siperslt",vals)),4)
"RTN","SAMINOT1",459,0)
 D OUT("Comments: ")
"RTN","SAMINOT1",460,0)
 D GLOUT($$XVAL("sipecmnt",vals),4)
"RTN","SAMINOT1",461,0)
 ;
"RTN","SAMINOT1",462,0)
 s @vals@("pre-note-complete")="true"
"RTN","SAMINOT1",463,0)
 ;
"RTN","SAMINOT1",464,0)
 quit  ; end of PRENOTE
"RTN","SAMINOT1",465,0)
 ;
"RTN","SAMINOT1",466,0)
 ;
"RTN","SAMINOT1",467,0)
 ;
"RTN","SAMINOT1",468,0)
SUBRSLT(XVAL) ; translation of discussion result
"RTN","SAMINOT1",469,0)
 ;
"RTN","SAMINOT1",470,0)
 q:XVAL="y" "Participant is interested in discussing lung screening. The program will proceed with enrollment process."
"RTN","SAMINOT1",471,0)
 q:XVAL="u" "Participant is unsure of lung screening. Ok to contact in the future."
"RTN","SAMINOT1",472,0)
 q:XVAL="nn" "Participant is not interested in discussing lung screening at this time. Ok to contact in the future."
"RTN","SAMINOT1",473,0)
 q:XVAL="nf" "Participant is not interested in discussing lung screening in the future."
"RTN","SAMINOT1",474,0)
 q:XVAL="na" "Unable to reach participant at this time"
"RTN","SAMINOT1",475,0)
 ;
"RTN","SAMINOT1",476,0)
 quit "" ; end of $$SUBRSLT
"RTN","SAMINOT1",477,0)
 ;
"RTN","SAMINOT1",478,0)
 ;
"RTN","SAMINOT1",479,0)
 ;
"RTN","SAMINOT1",480,0)
INNOTE(vals,dest,cnt) ;
"RTN","SAMINOT1",481,0)
 ;
"RTN","SAMINOT1",482,0)
 ;Lung Screening Program Intake Note
"RTN","SAMINOT1",483,0)
 ;
"RTN","SAMINOT1",484,0)
 ;Date of intake discussion contact:       [Date]
"RTN","SAMINOT1",485,0)
 ;How did you learn about the Lung Screening Program?:  [Selection]
"RTN","SAMINOT1",486,0)
 ;Primary address verified:                 [Yes/No]
"RTN","SAMINOT1",487,0)
 ;Rural status:                                        [Urban/Rural/Unknown]
"RTN","SAMINOT1",488,0)
 ;Preferred address and contact number:
"RTN","SAMINOT1",489,0)
 ;     [Address 1]
"RTN","SAMINOT1",490,0)
 ;           [Address 2]
"RTN","SAMINOT1",491,0)
 ;              [Address]
"RTN","SAMINOT1",492,0)
 ;
"RTN","SAMINOT1",493,0)
 ;Ever smoked?:            [Ever Smoked Text]
"RTN","SAMINOT1",494,0)
 ;Smoking Status:          [Never Smoked/Past/Current/Willing to Quit]
"RTN","SAMINOT1",495,0)
 ;CIGs per day:               [Input Number]
"RTN","SAMINOT1",496,0)
 ;PPD:                              [Computed Number]
"RTN","SAMINOT1",497,0)
 ;# of years:                    [Input Number]
"RTN","SAMINOT1",498,0)
 ;Pack Years:                   [Computed Number]
"RTN","SAMINOT1",499,0)
 ;
"RTN","SAMINOT1",500,0)
 ;[If a Quit Date is entered add the following line]
"RTN","SAMINOT1",501,0)
 ;Quit smoking on:         [Date]
"RTN","SAMINOT1",502,0)
 ;
"RTN","SAMINOT1",503,0)
 ;[If Smoking Cessation education text is entered add the following line]
"RTN","SAMINOT1",504,0)
 ;Smoking cessation education provided: [Show Input Text]
"RTN","SAMINOT1",505,0)
 ;
"RTN","SAMINOT1",506,0)
 ;[If a Lung Cancer Dx date is entered show the following 1 to 2 lines]
"RTN","SAMINOT1",507,0)
 ;Prior lung cancer diagnosis date: [Date]
"RTN","SAMINOT1",508,0)
 ;[If a location not in the VA is specified show the next line]
"RTN","SAMINOT1",509,0)
 ;Location where prior lung cancer diagnosis was made: [Location Text]
"RTN","SAMINOT1",510,0)
 ;
"RTN","SAMINOT1",511,0)
 ;[If Any Prior CT Date is entered show the following 1 to 2 lines]
"RTN","SAMINOT1",512,0)
 ;Prior CT:                   [Date]
"RTN","SAMINOT1",513,0)
 ;[If a location not in the VA is specified show the next line]
"RTN","SAMINOT1",514,0)
 ;Location where prior lung cancer diagnosis was made: [Location Text]
"RTN","SAMINOT1",515,0)
 ;
"RTN","SAMINOT1",516,0)
 ;Shared Decision Making:
"RTN","SAMINOT1",517,0)
 ;
"RTN","SAMINOT1",518,0)
 d OUT(" ")
"RTN","SAMINOT1",519,0)
 d OUT("   "_"Date of intake discussion contact: "_$$XVAL("sidc",vals))
"RTN","SAMINOT1",520,0)
 n learn s learn=""
"RTN","SAMINOT1",521,0)
 s:$$XVAL("silnip",vals) learn=learn_" In person"
"RTN","SAMINOT1",522,0)
 s:$$XVAL("silnph",vals) learn=learn_" Telephone"
"RTN","SAMINOT1",523,0)
 s:$$XVAL("silnth",vals) learn=learn_" TeleHealth"
"RTN","SAMINOT1",524,0)
 s:$$XVAL("silnml",vals) learn=learn_" Mailed letter"
"RTN","SAMINOT1",525,0)
 s:$$XVAL("silnpp",vals) learn=learn_" Message in patient portal"
"RTN","SAMINOT1",526,0)
 s:$$XVAL("silnvd",vals) learn=learn_" Video-on-Demand (VOD)"
"RTN","SAMINOT1",527,0)
 s:$$XVAL("silnot",vals) learn=learn_" "_$$XVAL("silnoo",vals)
"RTN","SAMINOT1",528,0)
 ;d GLOUT("   "_"How did you learn about the Lung Screening Program?: "_learn,4)
"RTN","SAMINOT1",529,0)
 d GLOUT("How did you learn about the Lung Screening Program?: ",4)
"RTN","SAMINOT1",530,0)
 d GLOUT(learn,6)
"RTN","SAMINOT1",531,0)
 n verified s verified=""
"RTN","SAMINOT1",532,0)
 s:$$XVAL("sipav",vals)="y" verified="Yes"
"RTN","SAMINOT1",533,0)
 s:$$XVAL("sipav",vals)="n" verified="No"
"RTN","SAMINOT1",534,0)
 d OUT("   "_"Primary address verified: "_verified)
"RTN","SAMINOT1",535,0)
 n rural s rural=""
"RTN","SAMINOT1",536,0)
 s:$$XVAL("sirs",vals)="r" rural="rural"
"RTN","SAMINOT1",537,0)
 s:$$XVAL("sirs",vals)="u" rural="urban"
"RTN","SAMINOT1",538,0)
 d OUT("   "_""_"Rural status: "_rural)
"RTN","SAMINOT1",539,0)
 d OUT("   "_"Preferred address and contact number: ")
"RTN","SAMINOT1",540,0)
 n pa s pa=""
"RTN","SAMINOT1",541,0)
 i $$XVAL("sipsa",vals)'="" d  ;
"RTN","SAMINOT1",542,0)
 . d OUT("      "_$$XVAL("sipsa",vals))
"RTN","SAMINOT1",543,0)
 . n csz s csz=""
"RTN","SAMINOT1",544,0)
 . s:$$XVAL("sipc",vals)'="" csz=$$XVAL("sipc",vals)
"RTN","SAMINOT1",545,0)
 . s:$$XVAL("sips",vals)'="" csz=csz_", "_$$XVAL("sips",vals)
"RTN","SAMINOT1",546,0)
 . s:$$XVAL("sipz",vals)'="" csz=csz_" "_$$XVAL("sipz",vals)
"RTN","SAMINOT1",547,0)
 . d OUT("      "_csz)
"RTN","SAMINOT1",548,0)
 d:$$XVAL("sippn",vals)'="" OUT("      "_$$XVAL("sippn",vals))
"RTN","SAMINOT1",549,0)
 d OUT("   "_"Ever smoked?: ")
"RTN","SAMINOT1",550,0)
 d GLOUT($$XVAL("sies",vals),6)
"RTN","SAMINOT1",551,0)
 n sstatus s sstatus=""
"RTN","SAMINOT1",552,0)
 s:$$XVAL("siesm",vals)="n" sstatus=sstatus_" Never smoked"
"RTN","SAMINOT1",553,0)
 s:$$XVAL("siesm",vals)="p" sstatus=sstatus_" Past"
"RTN","SAMINOT1",554,0)
 s:$$XVAL("siesm",vals)="c" sstatus=sstatus_" Current"
"RTN","SAMINOT1",555,0)
 s:$$XVAL("siesq",vals)=1 sstatus=sstatus_" Willing to quit"
"RTN","SAMINOT1",556,0)
 d OUT("   Smoking Status: "_sstatus)
"RTN","SAMINOT1",557,0)
 d OUT("   "_"CIGs per day: ")
"RTN","SAMINOT1",558,0)
 d OUT("      "_$$XVAL("sicpd",vals))
"RTN","SAMINOT1",559,0)
 d OUT("   "_"PPD: ")
"RTN","SAMINOT1",560,0)
 d OUT("      "_$$XVAL("sippd",vals))
"RTN","SAMINOT1",561,0)
 d OUT("   "_"# of years: ")
"RTN","SAMINOT1",562,0)
 d OUT("      "_$$XVAL("sisny",vals))
"RTN","SAMINOT1",563,0)
 d OUT("   "_"PPY: ")
"RTN","SAMINOT1",564,0)
 d OUT("      "_$$XVAL("sippy",vals))
"RTN","SAMINOT1",565,0)
 d OUT("")
"RTN","SAMINOT1",566,0)
 i $$XVAL("siq",vals)'="" d  ;
"RTN","SAMINOT1",567,0)
 . d OUT("Quit smoking on: "_$$XVAL("siq",vals))
"RTN","SAMINOT1",568,0)
 . d OUT("")
"RTN","SAMINOT1",569,0)
 i $$XVAL("sicep",vals)'="" d  ;
"RTN","SAMINOT1",570,0)
 . d OUT("Smoking cessation education provided:")
"RTN","SAMINOT1",571,0)
 . d GLOUT("    "_$$XVAL("sicep",vals),4)
"RTN","SAMINOT1",572,0)
 i $$XVAL("sicadx",vals)'="" d
"RTN","SAMINOT1",573,0)
 . d OUT("Prior lung cancer diagnosis date: "_$$XVAL("sicadx",vals))
"RTN","SAMINOT1",574,0)
 . i $$XVAL("sicadxl",vals)'="" d  ;
"RTN","SAMINOT1",575,0)
 . . d OUT("Location where prior lung cancer diagnosis was made:")
"RTN","SAMINOT1",576,0)
 . . d GLOUT("    "_$$XVAL("sicadxl",vals),4)
"RTN","SAMINOT1",577,0)
 i $$XVAL("siptct",vals)'="" d
"RTN","SAMINOT1",578,0)
 . d OUT("Prior CT: "_$$XVAL("siptct",vals))
"RTN","SAMINOT1",579,0)
 . i $$XVAL("siptctl",vals)'="" d  ;
"RTN","SAMINOT1",580,0)
 . . d OUT("Location where prior CT was made:")
"RTN","SAMINOT1",581,0)
 . . d GLOUT("    "_$$XVAL("siptctl",vals),4)
"RTN","SAMINOT1",582,0)
 d OUT(" ")
"RTN","SAMINOT1",583,0)
 d OUT("Shared Decision Making: ")
"RTN","SAMINOT1",584,0)
 d OUT(" ")
"RTN","SAMINOT1",585,0)
 n shareddm
"RTN","SAMINOT1",586,0)
 s shareddm=+$$XVAL("siidmdc",vals)
"RTN","SAMINOT1",587,0)
 i shareddm=1 d SDM(dest)
"RTN","SAMINOT1",588,0)
 e  d OUT("Shared decision making was not applicable")
"RTN","SAMINOT1",589,0)
 d OUT(" ")
"RTN","SAMINOT1",590,0)
 n ldct s ldct=""
"RTN","SAMINOT1",591,0)
 s:$$XVAL("sildct",vals)="n" ldct="No"
"RTN","SAMINOT1",592,0)
 s:$$XVAL("sildct",vals)="l" ldct="No"
"RTN","SAMINOT1",593,0)
 s:$$XVAL("sildct",vals)="y" ldct="Yes"
"RTN","SAMINOT1",594,0)
 d GLOUT("The veteran has decided to enroll in the Lung Screening Program: "_ldct)
"RTN","SAMINOT1",595,0)
 i $$XVAL("sildct",vals)="l" d  ;
"RTN","SAMINOT1",596,0)
 . d GLOUT("The veteran has indicated it is okay to contact in the future to discuss enrolling in the Lung Screening Program.",4)
"RTN","SAMINOT1",597,0)
 i ldct="Yes" d  ;
"RTN","SAMINOT1",598,0)
 . d OUT("LDCT ordered: "_ldct)
"RTN","SAMINOT1",599,0)
 . d OUT("    "_"Veteran enrolled in the LSS program. Results and coordination of care ")
"RTN","SAMINOT1",600,0)
 . d OUT("    "_"will be made by the LSS team.  ")
"RTN","SAMINOT1",601,0)
 . i $$XVAL("siclin",vals)'="" d  ;
"RTN","SAMINOT1",602,0)
 . . quit
"RTN","SAMINOT1",603,0)
 . quit
"RTN","SAMINOT1",604,0)
 n tmpclin s tmpclin=$$XVAL("siclin",vals)
"RTN","SAMINOT1",605,0)
 i tmpclin'="" d  ;
"RTN","SAMINOT1",606,0)
 . d OUT("Clinical Indications for Initial Screening CT:")
"RTN","SAMINOT1",607,0)
 . d GLOUT("    "_tmpclin,4)
"RTN","SAMINOT1",608,0)
 ;
"RTN","SAMINOT1",609,0)
 ;The veteran has decided to enroll in the Lung Screening Program: [Yes/No]
"RTN","SAMINOT1",610,0)
 ;
"RTN","SAMINOT1",611,0)
 ;[If Not enroll at this time but okay to contact in the future, add the following line]
"RTN","SAMINOT1",612,0)
 ;The veteran has indicated it is okay to contact in the future to discuss enrolling in the Lung Screening Program.
"RTN","SAMINOT1",613,0)
 ;
"RTN","SAMINOT1",614,0)
 ;[If Yes is answered for enrollment add the following two lines]
"RTN","SAMINOT1",615,0)
 ;LDCT ordered:                Yes
"RTN","SAMINOT1",616,0)
 ;Veteran enrolled in the Lung Screening Program. Results and coordination of care will be made by the Lung Screening Program team.
"RTN","SAMINOT1",617,0)
 ;
"RTN","SAMINOT1",618,0)
 ;[If Clinical Indication text is provided add them to the note]
"RTN","SAMINOT1",619,0)
 ;Clinical Indications:          [Show Input Text]
"RTN","SAMINOT1",620,0)
 ;
"RTN","SAMINOT1",621,0)
 ;
"RTN","SAMINOT1",622,0)
 quit  ; end of INNOTE
"RTN","SAMINOT1",623,0)
 ;
"RTN","SAMINOT1",624,0)
 ;
"RTN","SAMINOT1",625,0)
 ;
"RTN","SAMINOT1",626,0)
SDM(ary) ; adds Shared Decision Making text to array ary, passed by name
"RTN","SAMINOT1",627,0)
 ;
"RTN","SAMINOT1",628,0)
 n ii s ii=$o(@ary@(" "),-1)
"RTN","SAMINOT1",629,0)
 s ii=ii+1
"RTN","SAMINOT1",630,0)
 s @ary@(ii)="Veteran of age and exposure to cigarette smoke as described above, and "
"RTN","SAMINOT1",631,0)
 s ii=ii+1
"RTN","SAMINOT1",632,0)
 s @ary@(ii)="without a current diagnosis or obvious symptoms suggestive of lung cancer, "
"RTN","SAMINOT1",633,0)
 s ii=ii+1
"RTN","SAMINOT1",634,0)
 s @ary@(ii)="has been educated today about the estimated risk for lung cancer, the "
"RTN","SAMINOT1",635,0)
 s ii=ii+1
"RTN","SAMINOT1",636,0)
 s @ary@(ii)="possibility of cure or life prolonging if an early lung cancer were to be "
"RTN","SAMINOT1",637,0)
 s ii=ii+1
"RTN","SAMINOT1",638,0)
 s @ary@(ii)="found during screening, the possibility of imaging abnormalities not being "
"RTN","SAMINOT1",639,0)
 s ii=ii+1
"RTN","SAMINOT1",640,0)
 s @ary@(ii)="lung cancer, the possibility of complications from additional diagnostic "
"RTN","SAMINOT1",641,0)
 s ii=ii+1
"RTN","SAMINOT1",642,0)
 s @ary@(ii)="procedures, and the approximate amount of radiation exposure associated "
"RTN","SAMINOT1",643,0)
 s ii=ii+1
"RTN","SAMINOT1",644,0)
 s @ary@(ii)="with each screening procedure. In addition, the Veteran has been educated "
"RTN","SAMINOT1",645,0)
 s ii=ii+1
"RTN","SAMINOT1",646,0)
 s @ary@(ii)="today about the importance of adhering to annual lung screening, the "
"RTN","SAMINOT1",647,0)
 s ii=ii+1
"RTN","SAMINOT1",648,0)
 s @ary@(ii)="possible impact of other medical conditions on the overall health status, "
"RTN","SAMINOT1",649,0)
 s ii=ii+1
"RTN","SAMINOT1",650,0)
 s @ary@(ii)="the importance of avoiding exposure to cigarette smoke, available tobacco "
"RTN","SAMINOT1",651,0)
 s ii=ii+1
"RTN","SAMINOT1",652,0)
 s @ary@(ii)="cessation programs and available lung screening services at this site. "
"RTN","SAMINOT1",653,0)
 s ii=ii+1
"RTN","SAMINOT1",654,0)
 s @ary@(ii)="Education material was provided to the veteran. "
"RTN","SAMINOT1",655,0)
 s ii=ii+1
"RTN","SAMINOT1",656,0)
 ;s @ary@(ii)="Based on this information, the Veteran has opted for "
"RTN","SAMINOT1",657,0)
 ;
"RTN","SAMINOT1",658,0)
 quit  ; end of SDM
"RTN","SAMINOT1",659,0)
 ;
"RTN","SAMINOT1",660,0)
 ;
"RTN","SAMINOT1",661,0)
 ;
"RTN","SAMINOT1",662,0)
GLOUT(ln,indent) ; glob out first wrap ln then put it in dest
"RTN","SAMINOT1",663,0)
 ;
"RTN","SAMINOT1",664,0)
 i $$CRWRAP^SAMITTW(ln,dest,.cnt,80) q  ;
"RTN","SAMINOT1",665,0)
 n arytmp
"RTN","SAMINOT1",666,0)
 s arytmp(1)=ln
"RTN","SAMINOT1",667,0)
 i $g(indent)="" s indent=1
"RTN","SAMINOT1",668,0)
 d wrap^%tt("arytmp",indent_":80")
"RTN","SAMINOT1",669,0)
 n ii s ii=""
"RTN","SAMINOT1",670,0)
 f  s ii=$o(arytmp(ii)) q:ii=""  d  ;
"RTN","SAMINOT1",671,0)
 . d OUT(arytmp(ii))
"RTN","SAMINOT1",672,0)
 ;
"RTN","SAMINOT1",673,0)
 quit  ; end of GLOUT
"RTN","SAMINOT1",674,0)
 ;
"RTN","SAMINOT1",675,0)
 ;
"RTN","SAMINOT1",676,0)
 ;
"RTN","SAMINOT1",677,0)
OUT(ln) ;
"RTN","SAMINOT1",678,0)
 ;
"RTN","SAMINOT1",679,0)
 i $$CRWRAP^SAMITTW(ln,dest,.cnt,80) q  ;
"RTN","SAMINOT1",680,0)
 ;
"RTN","SAMINOT1",681,0)
 s cnt=cnt+1
"RTN","SAMINOT1",682,0)
 n lnn
"RTN","SAMINOT1",683,0)
 ;s debug=1
"RTN","SAMINOT1",684,0)
 s lnn=$o(@dest@(" "),-1)+1
"RTN","SAMINOT1",685,0)
 s @dest@(lnn)=ln
"RTN","SAMINOT1",686,0)
 ;
"RTN","SAMINOT1",687,0)
 ;i $g(debug)=1 d  ;
"RTN","SAMINOT1",688,0)
 ;. i ln["<" q  ; no markup
"RTN","SAMINOT1",689,0)
 ;. n zs s zs=$STACK
"RTN","SAMINOT1",690,0)
 ;. n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMINOT1",691,0)
 ;. s @dest@(lnn)=zp_":"_ln
"RTN","SAMINOT1",692,0)
 ;
"RTN","SAMINOT1",693,0)
 quit  ; end of OUT
"RTN","SAMINOT1",694,0)
 ;
"RTN","SAMINOT1",695,0)
 ;
"RTN","SAMINOT1",696,0)
 ;
"RTN","SAMINOT1",697,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMINOT1",698,0)
 ;
"RTN","SAMINOT1",699,0)
 ; vals is passed by name
"RTN","SAMINOT1",700,0)
 ;
"RTN","SAMINOT1",701,0)
 n zr
"RTN","SAMINOT1",702,0)
 s zr=$g(@vals@(var))
"RTN","SAMINOT1",703,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMINOT1",704,0)
 ;
"RTN","SAMINOT1",705,0)
 quit zr ; end of $$XVAL
"RTN","SAMINOT1",706,0)
 ;
"RTN","SAMINOT1",707,0)
 ;
"RTN","SAMINOT1",708,0)
 ;
"RTN","SAMINOT1",709,0)
EOR ; end of routine SAMINOT1
"RTN","SAMINOT2")
0^12^B473986639
"RTN","SAMINOT2",1,0)
SAMINOT2 ;ven/gpl - followup form notes ;2021-07-01t17:21z
"RTN","SAMINOT2",2,0)
 ;;18.0;SAMI;**1,9,12**;2020-01;Build 6
"RTN","SAMINOT2",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMINOT2",4,0)
 ;
"RTN","SAMINOT2",5,0)
 ; SAMINOT2 contains web services & other subroutines for producing
"RTN","SAMINOT2",6,0)
 ; the ELCAP Followup Form Notes.
"RTN","SAMINOT2",7,0)
 ;
"RTN","SAMINOT2",8,0)
 quit  ; no entry from top
"RTN","SAMINOT2",9,0)
 ;
"RTN","SAMINOT2",10,0)
 ;
"RTN","SAMINOT2",11,0)
 ;
"RTN","SAMINOT2",12,0)
 ;@section 0 primary development
"RTN","SAMINOT2",13,0)
 ;
"RTN","SAMINOT2",14,0)
 ;
"RTN","SAMINOT2",15,0)
 ;
"RTN","SAMINOT2",16,0)
 ;@license see routine SAMIUL
"RTN","SAMINOT2",17,0)
 ;@documentation see SAMINUL
"RTN","SAMINOT2",18,0)
 ;@contents
"RTN","SAMINOT2",19,0)
 ; WSNOTE web service to return text note
"RTN","SAMINOT2",20,0)
 ; $$NOTE create note
"RTN","SAMINOT2",21,0)
 ; $$HASINNT is intake note present?
"RTN","SAMINOT2",22,0)
 ; $$HASVCNT is communication note present?
"RTN","SAMINOT2",23,0)
 ; $$HASLCSNT is lung cancer screening note present?
"RTN","SAMINOT2",24,0)
 ; MKVC make communication note
"RTN","SAMINOT2",25,0)
 ; MKLCS make lung cancer screening note
"RTN","SAMINOT2",26,0)
 ; $$MKNT make note w/date=now
"RTN","SAMINOT2",27,0)
 ; $$MKNTLOC make note
"RTN","SAMINOT2",28,0)
 ; $$NTDTTM convert date/time fr/fm to/note format
"RTN","SAMINOT2",29,0)
 ; $$NTLOCN location of nth note
"RTN","SAMINOT2",30,0)
 ; $$NTLAST location of latest note of a type
"RTN","SAMINOT2",31,0)
 ; NTLIST return note list
"RTN","SAMINOT2",32,0)
 ; TLST test NTLIST
"RTN","SAMINOT2",33,0)
 ; VCNOTE veteran communication note
"RTN","SAMINOT2",34,0)
 ; SSTATUS smoking status
"RTN","SAMINOT2",35,0)
 ; LCSNOTE lung cancer screening note
"RTN","SAMINOT2",36,0)
 ; OUT output new line to note
"RTN","SAMINOT2",37,0)
 ; $$XVAL value of form variable
"RTN","SAMINOT2",38,0)
 ; $$PREVCT key to previous ct eval form
"RTN","SAMINOT2",39,0)
 ; CTINFO extracts from latest ct eval form
"RTN","SAMINOT2",40,0)
 ; IMPRESS impressions from ct eval report
"RTN","SAMINOT2",41,0)
 ; $$XSUB dictionary value for variable
"RTN","SAMINOT2",42,0)
 ;
"RTN","SAMINOT2",43,0)
 ;
"RTN","SAMINOT2",44,0)
 ;
"RTN","SAMINOT2",45,0)
 ;@section 1 wsi WSNOTE & related subroutines
"RTN","SAMINOT2",46,0)
 ;
"RTN","SAMINOT2",47,0)
 ;
"RTN","SAMINOT2",48,0)
 ;
"RTN","SAMINOT2",49,0)
 ;@wsi WSNOTE^SAMINOT2, vapals-elcap followup note
"RTN","SAMINOT2",50,0)
WSNOTE(return,filter) ; web service to return text note
"RTN","SAMINOT2",51,0)
 ;
"RTN","SAMINOT2",52,0)
 ;ven/gpl;web service;procedure;
"RTN","SAMINOT2",53,0)
 ;
"RTN","SAMINOT2",54,0)
 n debug s debug=0
"RTN","SAMINOT2",55,0)
 i $g(filter("debug"))=1 s debug=1
"RTN","SAMINOT2",56,0)
 ;
"RTN","SAMINOT2",57,0)
 k return
"RTN","SAMINOT2",58,0)
 s HTTPRSP("mime")="text/html"
"RTN","SAMINOT2",59,0)
 ;
"RTN","SAMINOT2",60,0)
 n si
"RTN","SAMINOT2",61,0)
 s si=$g(filter("studyid"))
"RTN","SAMINOT2",62,0)
 i si="" d  ;
"RTN","SAMINOT2",63,0)
 . s si="XXX00333"
"RTN","SAMINOT2",64,0)
 q:si=""
"RTN","SAMINOT2",65,0)
 ;
"RTN","SAMINOT2",66,0)
 n samikey
"RTN","SAMINOT2",67,0)
 s samikey=$g(filter("form"))
"RTN","SAMINOT2",68,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",69,0)
 i samikey="" d  ;
"RTN","SAMINOT2",70,0)
 . s samikey=$o(@root@("graph",si,"siform"))
"RTN","SAMINOT2",71,0)
 . ;w !,samikey
"RTN","SAMINOT2",72,0)
 . ;b
"RTN","SAMINOT2",73,0)
 ;
"RTN","SAMINOT2",74,0)
 n vals
"RTN","SAMINOT2",75,0)
 m vals=@root@("graph",si,samikey)
"RTN","SAMINOT2",76,0)
 ;
"RTN","SAMINOT2",77,0)
 n note,nien,ntype
"RTN","SAMINOT2",78,0)
 s ntype=""
"RTN","SAMINOT2",79,0)
 s note=""
"RTN","SAMINOT2",80,0)
 s nien=$g(filter("nien"))
"RTN","SAMINOT2",81,0)
 i nien="" d
"RTN","SAMINOT2",82,0)
 . s:$g(vals("samistatus"))="complete" ntype="intake"
"RTN","SAMINOT2",83,0)
 . s:$g(vals("samistatus"))="chart-eligibility" ntype="eligibility"
"RTN","SAMINOT2",84,0)
 . s:$g(vals("samistatus"))="pre-enrollment-discussion" ntype="pre-note"
"RTN","SAMINOT2",85,0)
 . q:ntype=""
"RTN","SAMINOT2",86,0)
 . ;d nien=$$NTTYPE add code to pull the latest note by type
"RTN","SAMINOT2",87,0)
 q:nien=""
"RTN","SAMINOT2",88,0)
 n notebase
"RTN","SAMINOT2",89,0)
 s notebase=$$NTLOCN(si,samikey,nien) ; global location for the note
"RTN","SAMINOT2",90,0)
 s note=$na(@notebase@("text"))
"RTN","SAMINOT2",91,0)
 i '$d(@note) q
"RTN","SAMINOT2",92,0)
 ;
"RTN","SAMINOT2",93,0)
 new temp,tout
"RTN","SAMINOT2",94,0)
 do GETTMPL^SAMICASE("temp","vapals:note")
"RTN","SAMINOT2",95,0)
 quit:'$data(temp)
"RTN","SAMINOT2",96,0)
 ;
"RTN","SAMINOT2",97,0)
 n cnt s cnt=0
"RTN","SAMINOT2",98,0)
 n zi s zi=""
"RTN","SAMINOT2",99,0)
 ;
"RTN","SAMINOT2",100,0)
 f  s zi=$o(temp(zi)) q:zi=""  d  ;
"RTN","SAMINOT2",101,0)
 . ;
"RTN","SAMINOT2",102,0)
 . n line s line=temp(zi)
"RTN","SAMINOT2",103,0)
 . D LOAD^SAMIFORM(.line,samikey,si,.filter,.vals)
"RTN","SAMINOT2",104,0)
 . s temp(zi)=line
"RTN","SAMINOT2",105,0)
 . ;
"RTN","SAMINOT2",106,0)
 . s cnt=cnt+1
"RTN","SAMINOT2",107,0)
 . s tout(cnt)=temp(zi)
"RTN","SAMINOT2",108,0)
 . ;
"RTN","SAMINOT2",109,0)
 . i temp(zi)["report-text" d  ;
"RTN","SAMINOT2",110,0)
 . . i temp(zi)["#" q  ;
"RTN","SAMINOT2",111,0)
 . . n zj s zj=""
"RTN","SAMINOT2",112,0)
 . . f  s zj=$o(@note@(zj)) q:zj=""  d  ;
"RTN","SAMINOT2",113,0)
 . . . s cnt=cnt+1
"RTN","SAMINOT2",114,0)
 . . . ;s tout(cnt)=@note@(zj)_"<br>"
"RTN","SAMINOT2",115,0)
 . . . s tout(cnt)=@note@(zj)_$char(13,10)
"RTN","SAMINOT2",116,0)
 m return=tout
"RTN","SAMINOT2",117,0)
 ;
"RTN","SAMINOT2",118,0)
 quit  ; end of wsi WSNOTE^SAMINOT2
"RTN","SAMINOT2",119,0)
 ;
"RTN","SAMINOT2",120,0)
 ;
"RTN","SAMINOT2",121,0)
 ;
"RTN","SAMINOT2",122,0)
NOTE(filter) ; extrnisic to create note
"RTN","SAMINOT2",123,0)
 ;
"RTN","SAMINOT2",124,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",125,0)
 ;@output = 1 if successful, 0 if not
"RTN","SAMINOT2",126,0)
 ;
"RTN","SAMINOT2",127,0)
 k ^gpl("funote")
"RTN","SAMINOT2",128,0)
 m ^gpl("funote")=filter
"RTN","SAMINOT2",129,0)
 ;q 0  ; while we are developing
"RTN","SAMINOT2",130,0)
 ;
"RTN","SAMINOT2",131,0)
 ; set up patient values
"RTN","SAMINOT2",132,0)
 ;
"RTN","SAMINOT2",133,0)
 n vals
"RTN","SAMINOT2",134,0)
 ;
"RTN","SAMINOT2",135,0)
 n si
"RTN","SAMINOT2",136,0)
 s si=$g(filter("studyid"))
"RTN","SAMINOT2",137,0)
 q:si="" 0
"RTN","SAMINOT2",138,0)
 ;
"RTN","SAMINOT2",139,0)
 n samikey
"RTN","SAMINOT2",140,0)
 s samikey=$g(filter("form"))
"RTN","SAMINOT2",141,0)
 q:samikey="" 0
"RTN","SAMINOT2",142,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",143,0)
 ;
"RTN","SAMINOT2",144,0)
 s vals=$na(@root@("graph",si,samikey))
"RTN","SAMINOT2",145,0)
 ;
"RTN","SAMINOT2",146,0)
 i '$d(@vals) d  q 0 ;
"RTN","SAMINOT2",147,0)
 . ;w !,"error, patient values not found"
"RTN","SAMINOT2",148,0)
 ;zwr @vals@(*)
"RTN","SAMINOT2",149,0)
 ;
"RTN","SAMINOT2",150,0)
 k ^SAMIUL("NOTE")
"RTN","SAMINOT2",151,0)
 m ^SAMIUL("NOTE","vals")=@vals
"RTN","SAMINOT2",152,0)
 m ^SAMIUL("NOTE","filter")=filter
"RTN","SAMINOT2",153,0)
 ;
"RTN","SAMINOT2",154,0)
 n didnote s didnote=0
"RTN","SAMINOT2",155,0)
 ;
"RTN","SAMINOT2",156,0)
 i $d(@vals@("notes")) d  q didnote ;
"RTN","SAMINOT2",157,0)
 . s filter("errorMessage")="Note already exists for this form."
"RTN","SAMINOT2",158,0)
 ;
"RTN","SAMINOT2",159,0)
 i $g(@vals@("futype"))="other" d  ;
"RTN","SAMINOT2",160,0)
 . i $g(@vals@("samistatus"))'="complete" q  ;
"RTN","SAMINOT2",161,0)
 . ;q:$$HASVCNT(vals)
"RTN","SAMINOT2",162,0)
 . d MKVC(si,samikey,vals,.filter) ;
"RTN","SAMINOT2",163,0)
 . s didnote=1
"RTN","SAMINOT2",164,0)
 ;
"RTN","SAMINOT2",165,0)
 i $g(@vals@("futype"))="ct" d  ;
"RTN","SAMINOT2",166,0)
 . i $g(@vals@("samistatus"))'="complete" q  ;
"RTN","SAMINOT2",167,0)
 . ;q:$$HASLCSNT(vals)
"RTN","SAMINOT2",168,0)
 . n ctdt,ctkey
"RTN","SAMINOT2",169,0)
 . s ctdt=$$LASTCMP^SAMICAS3(si,.ctkey)
"RTN","SAMINOT2",170,0)
 . i ctdt=-1 d  q  ;
"RTN","SAMINOT2",171,0)
 . . s filter("errorMessage")="No CT Eval form exists, followup note not created."
"RTN","SAMINOT2",172,0)
 . d MKLCS(si,samikey,vals,.filter) ;
"RTN","SAMINOT2",173,0)
 . s didnote=1
"RTN","SAMINOT2",174,0)
 ;
"RTN","SAMINOT2",175,0)
 ;i $g(@vals@("samistatus"))="complete" d  ;
"RTN","SAMINOT2",176,0)
 ;. q:$$HASVCNT(vals)
"RTN","SAMINOT2",177,0)
 ;. d MKVC(si,samikey,vals,.filter) ;
"RTN","SAMINOT2",178,0)
 ;. s didnote=1
"RTN","SAMINOT2",179,0)
 ;
"RTN","SAMINOT2",180,0)
 quit didnote ; end of $$NOTE
"RTN","SAMINOT2",181,0)
 ;
"RTN","SAMINOT2",182,0)
 ;
"RTN","SAMINOT2",183,0)
 ;
"RTN","SAMINOT2",184,0)
HASINNT(vals) ; is intake note present?
"RTN","SAMINOT2",185,0)
 ;
"RTN","SAMINOT2",186,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",187,0)
 ;@output = 1 if intake note is present, 0 if not
"RTN","SAMINOT2",188,0)
 ;
"RTN","SAMINOT2",189,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT2",190,0)
 q:'$d(@vals)
"RTN","SAMINOT2",191,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT2",192,0)
 . i $g(@vals@("notes",zzi,"name"))["Intake" s zzrtn=1
"RTN","SAMINOT2",193,0)
 ;
"RTN","SAMINOT2",194,0)
 quit zzrtn ; end of $$HASINNT
"RTN","SAMINOT2",195,0)
 ;
"RTN","SAMINOT2",196,0)
 ;
"RTN","SAMINOT2",197,0)
 ;
"RTN","SAMINOT2",198,0)
HASVCNT(vals) ; is communication note present?
"RTN","SAMINOT2",199,0)
 ;
"RTN","SAMINOT2",200,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",201,0)
 ;@output = 1 if communication note is present, 0 if not
"RTN","SAMINOT2",202,0)
 ;
"RTN","SAMINOT2",203,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT2",204,0)
 q:'$d(@vals)
"RTN","SAMINOT2",205,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT2",206,0)
 . i $g(@vals@("notes",zzi,"name"))["Communication" s zzrtn=1
"RTN","SAMINOT2",207,0)
 ;
"RTN","SAMINOT2",208,0)
 quit zzrtn ; end of $$HASVCNT
"RTN","SAMINOT2",209,0)
 ;
"RTN","SAMINOT2",210,0)
 ;
"RTN","SAMINOT2",211,0)
 ;
"RTN","SAMINOT2",212,0)
HASLCSNT(vals) ; is lung cancer screening note present?
"RTN","SAMINOT2",213,0)
 ;
"RTN","SAMINOT2",214,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",215,0)
 ;@output = 1 if communication note is present, 0 if not
"RTN","SAMINOT2",216,0)
 ;
"RTN","SAMINOT2",217,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT2",218,0)
 q:'$d(@vals)
"RTN","SAMINOT2",219,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT2",220,0)
 . i $g(@vals@("notes",zzi,"name"))["Lung" s zzrtn=1
"RTN","SAMINOT2",221,0)
 ;
"RTN","SAMINOT2",222,0)
 quit zzrtn ; end of $$HASLCSNT
"RTN","SAMINOT2",223,0)
 ;
"RTN","SAMINOT2",224,0)
 ;
"RTN","SAMINOT2",225,0)
 ;
"RTN","SAMINOT2",226,0)
MKVC(sid,form,vals,filter) ; make communication note
"RTN","SAMINOT2",227,0)
 ;
"RTN","SAMINOT2",228,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",229,0)
 ;
"RTN","SAMINOT2",230,0)
 n cnt s cnt=0
"RTN","SAMINOT2",231,0)
 ;n dest s dest=$na(@vals@("communication-note"))
"RTN","SAMINOT2",232,0)
 n dest s dest=$$MKNT(vals,"Communication Note","communication",.filter)
"RTN","SAMINOT2",233,0)
 k @dest
"RTN","SAMINOT2",234,0)
 d OUT("Veteran Communication Note")
"RTN","SAMINOT2",235,0)
 d OUT("")
"RTN","SAMINOT2",236,0)
 d VCNOTE(vals,dest,cnt)
"RTN","SAMINOT2",237,0)
 ;
"RTN","SAMINOT2",238,0)
 quit  ; end of MKVC
"RTN","SAMINOT2",239,0)
 ;
"RTN","SAMINOT2",240,0)
 ;
"RTN","SAMINOT2",241,0)
 ;
"RTN","SAMINOT2",242,0)
MKLCS(sid,form,vals,filter) ; make lung cancer screening note
"RTN","SAMINOT2",243,0)
 ;
"RTN","SAMINOT2",244,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",245,0)
 ;
"RTN","SAMINOT2",246,0)
 n cnt s cnt=0
"RTN","SAMINOT2",247,0)
 ;n dest s dest=$na(@vals@("lcs-note"))
"RTN","SAMINOT2",248,0)
 n dest s dest=$$MKNT(vals,"Lung Cancer Screening Note","lcs",.filter)
"RTN","SAMINOT2",249,0)
 k @dest
"RTN","SAMINOT2",250,0)
 d OUT("Lung Screening and Surveillance Follow up Note")
"RTN","SAMINOT2",251,0)
 d OUT("")
"RTN","SAMINOT2",252,0)
 d LCSNOTE(vals,dest,cnt)
"RTN","SAMINOT2",253,0)
 ;
"RTN","SAMINOT2",254,0)
 quit  ; end of MKLCS
"RTN","SAMINOT2",255,0)
 ;
"RTN","SAMINOT2",256,0)
 ;
"RTN","SAMINOT2",257,0)
 ;
"RTN","SAMINOT2",258,0)
MKNT(vals,title,ntype,filter) ; make note w/date=now
"RTN","SAMINOT2",259,0)
 ;
"RTN","SAMINOT2",260,0)
 ;ven/gpl;private;pseudo-function;
"RTN","SAMINOT2",261,0)
 ;@input
"RTN","SAMINOT2",262,0)
 ; .filter (passed by reference)
"RTN","SAMINOT2",263,0)
 ;@output = global address
"RTN","SAMINOT2",264,0)
 ;
"RTN","SAMINOT2",265,0)
 n ntdt s ntdt=$$NTDTTM($$NOW^XLFDT)
"RTN","SAMINOT2",266,0)
 n ntptr
"RTN","SAMINOT2",267,0)
 s ntptr=$$MKNTLOC(vals,title,ntdt,$g(ntype),.filter)
"RTN","SAMINOT2",268,0)
 ;
"RTN","SAMINOT2",269,0)
 quit ntptr ; end of $$MKNT
"RTN","SAMINOT2",270,0)
 ;
"RTN","SAMINOT2",271,0)
 ;
"RTN","SAMINOT2",272,0)
 ;
"RTN","SAMINOT2",273,0)
MKNTLOC(vals,title,ndate,ntype,filter) ; make note
"RTN","SAMINOT2",274,0)
 ;
"RTN","SAMINOT2",275,0)
 ;ven/gpl;private;pseudo-function;
"RTN","SAMINOT2",276,0)
 ;@output = note location (global address)
"RTN","SAMINOT2",277,0)
 ;
"RTN","SAMINOT2",278,0)
 n nien
"RTN","SAMINOT2",279,0)
 s nien=$o(@vals@("notes",""),-1)+1
"RTN","SAMINOT2",280,0)
 s filter("nien")=nien
"RTN","SAMINOT2",281,0)
 n nloc s nloc=$na(@vals@("notes",nien))
"RTN","SAMINOT2",282,0)
 s @nloc@("name")=title_" "_$g(ndate)
"RTN","SAMINOT2",283,0)
 s @nloc@("date")=$g(ndate)
"RTN","SAMINOT2",284,0)
 s @nloc@("type")=$g(ntype)
"RTN","SAMINOT2",285,0)
 ;
"RTN","SAMINOT2",286,0)
 quit $na(@nloc@("text"))
"RTN","SAMINOT2",287,0)
 ;
"RTN","SAMINOT2",288,0)
 ;
"RTN","SAMINOT2",289,0)
 ;
"RTN","SAMINOT2",290,0)
NTDTTM(ZFMDT) ; convert date/time fr/fm to/note format
"RTN","SAMINOT2",291,0)
 ;
"RTN","SAMINOT2",292,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",293,0)
 ;@input
"RTN","SAMINOT2",294,0)
 ; ZFMDT = fileman date/time to translate
"RTN","SAMINOT2",295,0)
 ;@output = date/time in note format
"RTN","SAMINOT2",296,0)
 ;
"RTN","SAMINOT2",297,0)
 quit $$FMTE^XLFDT(ZFMDT,"5") ; end of $$NTDTTM
"RTN","SAMINOT2",298,0)
 ;
"RTN","SAMINOT2",299,0)
 ;
"RTN","SAMINOT2",300,0)
 ;
"RTN","SAMINOT2",301,0)
NTLOCN(sid,form,nien) ; location of nth note
"RTN","SAMINOT2",302,0)
 ;
"RTN","SAMINOT2",303,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",304,0)
 ;@output = global location of Nth note
"RTN","SAMINOT2",305,0)
 ;
"RTN","SAMINOT2",306,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",307,0)
 ;
"RTN","SAMINOT2",308,0)
 quit $na(@root@("graph",sid,form,"notes",nien)) ; end of $$NTLOCN
"RTN","SAMINOT2",309,0)
 ;
"RTN","SAMINOT2",310,0)
 ;
"RTN","SAMINOT2",311,0)
 ;
"RTN","SAMINOT2",312,0)
NTLAST(sid,form,ntype) ; location of latest note of a type
"RTN","SAMINOT2",313,0)
 ;
"RTN","SAMINOT2",314,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",315,0)
 ;@input
"RTN","SAMINOT2",316,0)
 ; ntype = type of note
"RTN","SAMINOT2",317,0)
 ;@output = global location of latest note of type ntype
"RTN","SAMINOT2",318,0)
 ;
"RTN","SAMINOT2",319,0)
 ; not yet written
"RTN","SAMINOT2",320,0)
 ;
"RTN","SAMINOT2",321,0)
 quit  ; end of $$NTLAST
"RTN","SAMINOT2",322,0)
 ;
"RTN","SAMINOT2",323,0)
 ;
"RTN","SAMINOT2",324,0)
 ;
"RTN","SAMINOT2",325,0)
NTLIST(nlist,sid,form) ; return note list
"RTN","SAMINOT2",326,0)
 ;
"RTN","SAMINOT2",327,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",328,0)
 ;@output
"RTN","SAMINOT2",329,0)
 ; .nlist = note list [pass by reference]
"RTN","SAMINOT2",330,0)
 ;
"RTN","SAMINOT2",331,0)
 n zn,root,gn
"RTN","SAMINOT2",332,0)
 s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",333,0)
 s zn=0
"RTN","SAMINOT2",334,0)
 s gn=$na(@root@("graph",sid,form,"notes"))
"RTN","SAMINOT2",335,0)
 q:'$d(@gn)
"RTN","SAMINOT2",336,0)
 f  s zn=$o(@gn@(zn)) q:+zn=0  d  ;
"RTN","SAMINOT2",337,0)
 . s @nlist@(zn,"name")=@gn@(zn,"name")
"RTN","SAMINOT2",338,0)
 . s @nlist@(zn,"nien")=zn
"RTN","SAMINOT2",339,0)
 ;
"RTN","SAMINOT2",340,0)
 quit  ; end of NTLIST
"RTN","SAMINOT2",341,0)
 ;
"RTN","SAMINOT2",342,0)
 ;
"RTN","SAMINOT2",343,0)
 ;
"RTN","SAMINOT2",344,0)
TLST ; test NTLIST
"RTN","SAMINOT2",345,0)
 ;
"RTN","SAMINOT2",346,0)
 ;ven/gpl;test;procedure;
"RTN","SAMINOT2",347,0)
 ;
"RTN","SAMINOT2",348,0)
 set SID="XXX00677"
"RTN","SAMINOT2",349,0)
 set FORM="siform-2019-04-23"
"RTN","SAMINOT2",350,0)
 do NTLIST("G",SID,FORM)
"RTN","SAMINOT2",351,0)
 ;
"RTN","SAMINOT2",352,0)
 ; zwrite G
"RTN","SAMINOT2",353,0)
 ;
"RTN","SAMINOT2",354,0)
 quit  ; end of TLST
"RTN","SAMINOT2",355,0)
 ;
"RTN","SAMINOT2",356,0)
 ;
"RTN","SAMINOT2",357,0)
 ;
"RTN","SAMINOT2",358,0)
VCNOTE(vals,dest,cnt) ; veteran communication note
"RTN","SAMINOT2",359,0)
 ;
"RTN","SAMINOT2",360,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",361,0)
 ;
"RTN","SAMINOT2",362,0)
 ; do OUT("")
"RTN","SAMINOT2",363,0)
 ;
"RTN","SAMINOT2",364,0)
 d OUT("Veteran was contacted via:")
"RTN","SAMINOT2",365,0)
 n sp1 s sp1="    "
"RTN","SAMINOT2",366,0)
 d:$$XVAL("fucmotip",vals) OUT(sp1_"In person")
"RTN","SAMINOT2",367,0)
 d:$$XVAL("fucmotte",vals) OUT(sp1_"Telephone")
"RTN","SAMINOT2",368,0)
 d:$$XVAL("fucmotth",vals) OUT(sp1_"TeleHealth")
"RTN","SAMINOT2",369,0)
 d:$$XVAL("fucmotml",vals) OUT(sp1_"Mailed Letter")
"RTN","SAMINOT2",370,0)
 d:$$XVAL("fucmotpp",vals) OUT(sp1_"Message in patient portal")
"RTN","SAMINOT2",371,0)
 d:$$XVAL("fucmotvd",vals) OUT(sp1_"Video-on-demand (VOD)")
"RTN","SAMINOT2",372,0)
 d:$$XVAL("fucmotot",vals) OUT(sp1_"Other: "_$$XVAL("fucmotoo",vals))
"RTN","SAMINOT2",373,0)
 d OUT("")
"RTN","SAMINOT2",374,0)
 ;
"RTN","SAMINOT2",375,0)
 d:$$XVAL("fucmotde",vals)'=""
"RTN","SAMINOT2",376,0)
 . d OUT("Communication details:")
"RTN","SAMINOT2",377,0)
 . d OUT(sp1_$$XVAL("fucmotde",vals))
"RTN","SAMINOT2",378,0)
 ;
"RTN","SAMINOT2",379,0)
 d SSTATUS(vals) ; insert smoking status section
"RTN","SAMINOT2",380,0)
 ;
"RTN","SAMINOT2",381,0)
 quit  ; end of VCNOTE
"RTN","SAMINOT2",382,0)
 ;
"RTN","SAMINOT2",383,0)
 ;
"RTN","SAMINOT2",384,0)
 ;
"RTN","SAMINOT2",385,0)
SSTATUS(vals) ; smoking status
"RTN","SAMINOT2",386,0)
 ;
"RTN","SAMINOT2",387,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",388,0)
 ;
"RTN","SAMINOT2",389,0)
 n sstat s sstat=""
"RTN","SAMINOT2",390,0)
 i $$XVAL("sisa",vals)="y" d  ; 
"RTN","SAMINOT2",391,0)
 . s sstat="Current"
"RTN","SAMINOT2",392,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT2",393,0)
 . d OUT(sp1_"Current cigarette smoker (patient advised that active tobacco use")
"RTN","SAMINOT2",394,0)
 . d OUT(sp1_"increases risk of future lung cancer, heart disease and stroke,")
"RTN","SAMINOT2",395,0)
 . d OUT(sp1_"advised stability now does not guarantee will not develop future")
"RTN","SAMINOT2",396,0)
 . d OUT(sp1_"lung cancer or risks of premature death from tobacco related heart")
"RTN","SAMINOT2",397,0)
 . d OUT(sp1_"disease and stroke)")
"RTN","SAMINOT2",398,0)
 i $$XVAL("sisa",vals)="n" d  ;
"RTN","SAMINOT2",399,0)
 . s sstat="Former"
"RTN","SAMINOT2",400,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT2",401,0)
 . n qdate s qdate=""
"RTN","SAMINOT2",402,0)
 . s qdate=$$XVAL("siq",vals)
"RTN","SAMINOT2",403,0)
 . i qdate'="" d OUT(sp1_"Former cigarette smoker. Quit date: "_qdate)
"RTN","SAMINOT2",404,0)
 . e  d OUT(sp1_"Former cigarette smoker.")
"RTN","SAMINOT2",405,0)
 i $$XVAL("sisa",vals)="o" d  ;
"RTN","SAMINOT2",406,0)
 . s sstat="Never"
"RTN","SAMINOT2",407,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT2",408,0)
 . d OUT(sp1_"Never cigarette smoker")
"RTN","SAMINOT2",409,0)
 ;
"RTN","SAMINOT2",410,0)
 n cumary
"RTN","SAMINOT2",411,0)
 d CUMPY^SAMIUR2("cumary",sid,form)
"RTN","SAMINOT2",412,0)
 k ^gpl("funote","cumary")
"RTN","SAMINOT2",413,0)
 m ^gpl("funote","cumary")=cumary
"RTN","SAMINOT2",414,0)
 n cur s cur=$g(cumary("current"))
"RTN","SAMINOT2",415,0)
 n newcum s newcum=$g(cumary("rpt",cur,4)) ; new cumulative pack years
"RTN","SAMINOT2",416,0)
 ;
"RTN","SAMINOT2",417,0)
 i $$XVAL("sisa",vals)="y" d  ;  
"RTN","SAMINOT2",418,0)
 . d OUT("Smoking history (since last visit):")
"RTN","SAMINOT2",419,0)
 . d OUT(sp1_"Cigarettes/day: "_$$XVAL("sicpd",vals))
"RTN","SAMINOT2",420,0)
 . d OUT(sp1_"PPD: "_$$XVAL("sippd",vals))
"RTN","SAMINOT2",421,0)
 . d OUT(sp1_"Current cumulative pack years: "_newcum)
"RTN","SAMINOT2",422,0)
 i $$XVAL("sisa",vals)'="y" d  ;  
"RTN","SAMINOT2",423,0)
 . d OUT("Smoking History")
"RTN","SAMINOT2",424,0)
 n zi
"RTN","SAMINOT2",425,0)
 f zi=1:1:cur d  ;
"RTN","SAMINOT2",426,0)
 . d OUT(sp1_cumary("rpt",zi,1)_" "_cumary("rpt",zi,2))
"RTN","SAMINOT2",427,0)
 . d OUT(sp1_sp1_"Pack Years: "_cumary("rpt",zi,3))
"RTN","SAMINOT2",428,0)
 . d OUT(sp1_sp1_"Cumulative: "_cumary("rpt",zi,4))
"RTN","SAMINOT2",429,0)
 ;
"RTN","SAMINOT2",430,0)
 n tried s tried=$$XVAL("sittq",vals)
"RTN","SAMINOT2",431,0)
 n ptried s ptried=$s(tried="y":"Yes",tried="n":"No",tried="o":"Not applicable",1:"")
"RTN","SAMINOT2",432,0)
 i ptried'="" d OUT("Since your prior CT scan have you ever tried to quit smoking? "_ptried)
"RTN","SAMINOT2",433,0)
 ;
"RTN","SAMINOT2",434,0)
 n tryary,cnt
"RTN","SAMINOT2",435,0)
 s cnt=0
"RTN","SAMINOT2",436,0)
 i $$XVAL("sisca",vals)'="" s cnt=cnt+1 s tryary(cnt)="Have not tried to quit"
"RTN","SAMINOT2",437,0)
 i $$XVAL("siscb",vals)'="" s cnt=cnt+1 s tryary(cnt)="""Cold Turkey"" by completely stopping on your own with no other assistance"
"RTN","SAMINOT2",438,0)
 i $$XVAL("siscc",vals)'="" s cnt=cnt+1 s tryary(cnt)="Tapering or reducing number of cigarettes smoked per day"
"RTN","SAMINOT2",439,0)
 i $$XVAL("siscd",vals)'="" s cnt=cnt+1 s tryary(cnt)="Self-help material (e.g., brochure, cessation website)"
"RTN","SAMINOT2",440,0)
 i $$XVAL("sisce",vals)'="" s cnt=cnt+1 s tryary(cnt)="Individual consultation or cessation counseling"
"RTN","SAMINOT2",441,0)
 i $$XVAL("siscf",vals)'="" s cnt=cnt+1 s tryary(cnt)="Telephone cessation counseling hotline (e.g., 1-855-QUIT-VET, 1-800-QUIT-NOW)"
"RTN","SAMINOT2",442,0)
 i $$XVAL("siscg",vals)'="" s cnt=cnt+1 s tryary(cnt)="Peer support (e.g., Nicotine Anonymous)"
"RTN","SAMINOT2",443,0)
 i $$XVAL("sisch",vals)'="" s cnt=cnt+1 s tryary(cnt)="Nicotine replacement therapy (e.g., patch, gum, inhaler, nasal spray, lozenge)"
"RTN","SAMINOT2",444,0)
 i $$XVAL("sisci",vals)'="" s cnt=cnt+1 s tryary(cnt)="Zyban"
"RTN","SAMINOT2",445,0)
 i $$XVAL("siscj",vals)'="" s cnt=cnt+1 s tryary(cnt)="Hypnosis"
"RTN","SAMINOT2",446,0)
 i $$XVAL("sisck",vals)'="" s cnt=cnt+1 s tryary(cnt)="Acupuncture / acupressure"
"RTN","SAMINOT2",447,0)
 n tryot s tryot=""
"RTN","SAMINOT2",448,0)
 i $$XVAL("siscl",vals)'="" d  ;
"RTN","SAMINOT2",449,0)
 . s cnt=cnt+1 s tryary(cnt)="Other (specify)"
"RTN","SAMINOT2",450,0)
 . s tryot=$$XVAL("siscos",vals)
"RTN","SAMINOT2",451,0)
 ;
"RTN","SAMINOT2",452,0)
 i cnt>0 d  ;
"RTN","SAMINOT2",453,0)
 .  i ptried="" d OUT("Since your prior CT scan have you ever tried to quit smoking? ")
"RTN","SAMINOT2",454,0)
 . n zi s zi=""
"RTN","SAMINOT2",455,0)
 . f  s zi=$o(tryary(zi)) q:zi=""  d  ;
"RTN","SAMINOT2",456,0)
 . . d OUT(sp1_tryary(zi))
"RTN","SAMINOT2",457,0)
 . i tryot'="" d OUT(sp1_sp1_tryot)
"RTN","SAMINOT2",458,0)
 ;
"RTN","SAMINOT2",459,0)
 n cess,cess2 s cess="" s cess2=""
"RTN","SAMINOT2",460,0)
 i $$XVAL("siscmd",vals)="d" s cess="Declined"
"RTN","SAMINOT2",461,0)
 i $$XVAL("siscmd",vals)="a" s cess="Advised to quit smoking; VA resources provided"
"RTN","SAMINOT2",462,0)
 i $$XVAL("siscmd",vals)="i" d  ;
"RTN","SAMINOT2",463,0)
 . s cess="Interested in VA tobacco cessation medication. Encouraged Veteran"
"RTN","SAMINOT2",464,0)
 . s cess2="to talk to provider or pharmacist about which medication option is best for you."
"RTN","SAMINOT2",465,0)
 i cess'="" d  ;
"RTN","SAMINOT2",466,0)
 . d OUT("Tobacco cessation provided:")
"RTN","SAMINOT2",467,0)
 . d OUT(sp1_cess)
"RTN","SAMINOT2",468,0)
 . i cess2'="" d OUT(sp1_cess2)
"RTN","SAMINOT2",469,0)
 ;
"RTN","SAMINOT2",470,0)
 quit  ; end of SSTATUS
"RTN","SAMINOT2",471,0)
 ;
"RTN","SAMINOT2",472,0)
 ;
"RTN","SAMINOT2",473,0)
 ;
"RTN","SAMINOT2",474,0)
LCSNOTE(vals,dest,cnt) ; lung cancer screening note
"RTN","SAMINOT2",475,0)
 ;
"RTN","SAMINOT2",476,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",477,0)
 ;
"RTN","SAMINOT2",478,0)
 ; do OUT("")
"RTN","SAMINOT2",479,0)
 ;
"RTN","SAMINOT2",480,0)
 n sp1 s sp1="    "
"RTN","SAMINOT2",481,0)
 d OUT("Initial LDCT/Baseline: "_$$XVAL("sidoe",vals))
"RTN","SAMINOT2",482,0)
 d OUT("Date of most recent CT/LDCT: "_$$XVAL("fulctdt",vals))
"RTN","SAMINOT2",483,0)
 d OUT(sp1_"Notification of Results: "_$$XVAL("sidof",vals))
"RTN","SAMINOT2",484,0)
 n addcmt s addcmt=$$XVAL("fucmctde",vals)
"RTN","SAMINOT2",485,0)
 i addcmt'="" d  ;
"RTN","SAMINOT2",486,0)
 . d OUT("Additional comments:")
"RTN","SAMINOT2",487,0)
 . d OUT(sp1_addcmt)
"RTN","SAMINOT2",488,0)
 n impress s impress=""
"RTN","SAMINOT2",489,0)
 n ctary
"RTN","SAMINOT2",490,0)
 d CTINFO("ctary",sid,form)
"RTN","SAMINOT2",491,0)
 s impress=$g(ctary("impression"))
"RTN","SAMINOT2",492,0)
 ; get impression from lastest CT Eval here
"RTN","SAMINOT2",493,0)
 d IMPRESS("ctary",sid)
"RTN","SAMINOT2",494,0)
 ;i impress'="" d  ;
"RTN","SAMINOT2",495,0)
 ;. d OUT("Impression:")
"RTN","SAMINOT2",496,0)
 ;. d OUT(sp1_impress)
"RTN","SAMINOT2",497,0)
 ; smoking status follows
"RTN","SAMINOT2",498,0)
 d SSTATUS(vals)
"RTN","SAMINOT2",499,0)
 ;d OUT("Veteran was contacted via:")
"RTN","SAMINOT2",500,0)
 ;n sp1 s sp1="    "
"RTN","SAMINOT2",501,0)
 ;d:$$XVAL("fucmctip",vals) OUT(sp1_"In person")
"RTN","SAMINOT2",502,0)
 ;d:$$XVAL("fucmctte",vals) OUT(sp1_"Telephone")
"RTN","SAMINOT2",503,0)
 ;d:$$XVAL("fucmctth",vals) OUT(sp1_"TeleHealth")
"RTN","SAMINOT2",504,0)
 ;d:$$XVAL("fucmctml",vals) OUT(sp1_"Mailed Letter")
"RTN","SAMINOT2",505,0)
 ;d:$$XVAL("fucmctpp",vals) OUT(sp1_"Message in patient portal")
"RTN","SAMINOT2",506,0)
 ;d:$$XVAL("fucmctvd",vals) OUT(sp1_"Video-on-demand (VOD)")
"RTN","SAMINOT2",507,0)
 ;d:$$XVAL("fucmctot",vals) OUT(sp1_"Other: "_$$XVAL("fucmctoo",vals))
"RTN","SAMINOT2",508,0)
 ;d OUT("")
"RTN","SAMINOT2",509,0)
 ;
"RTN","SAMINOT2",510,0)
 ;d:$$XVAL("fucmctde",vals)'=""
"RTN","SAMINOT2",511,0)
 ;. d OUT("Communication details:")
"RTN","SAMINOT2",512,0)
 ;. d OUT(sp1_$$XVAL("fucmctde",vals))
"RTN","SAMINOT2",513,0)
 n recom s recom=""
"RTN","SAMINOT2",514,0)
 ; get recommendations from CT eval form here
"RTN","SAMINOT2",515,0)
 s recom=$g(ctary("followup"))
"RTN","SAMINOT2",516,0)
 i recom'="" d  ;
"RTN","SAMINOT2",517,0)
 . d OUT("Recommendations:")
"RTN","SAMINOT2",518,0)
 . d OUT(sp1_recom)
"RTN","SAMINOT2",519,0)
 . i $g(ctary("followup2"))'="" d  ;
"RTN","SAMINOT2",520,0)
 . . d OUT(sp1_ctary("followup2"))
"RTN","SAMINOT2",521,0)
 . i $g(ctary("followup3"))'="" d  ;
"RTN","SAMINOT2",522,0)
 . . d OUT(sp1_ctary("followup3"))
"RTN","SAMINOT2",523,0)
 n ordered s ordered=$$XVAL("funewct",vals)
"RTN","SAMINOT2",524,0)
 i ordered'="" d  ;
"RTN","SAMINOT2",525,0)
 . s ordered=$s(ordered="y":"Yes",ordered="n":"No",1:"")
"RTN","SAMINOT2",526,0)
 . d OUT("CT/LDCT ordered: "_ordered)
"RTN","SAMINOT2",527,0)
 n pulmon s pulmon=$$XVAL("fucompul",vals)
"RTN","SAMINOT2",528,0)
 i pulmon'="" d  ;
"RTN","SAMINOT2",529,0)
 . s pulmon=$s(pulmon="y":"Yes",pulmon="n":"No",1:"")
"RTN","SAMINOT2",530,0)
 . d OUT("Communicated to Pulmonary: "_pulmon)
"RTN","SAMINOT2",531,0)
 ;
"RTN","SAMINOT2",532,0)
 quit  ; end of LCSNOTE
"RTN","SAMINOT2",533,0)
 ;
"RTN","SAMINOT2",534,0)
 ;
"RTN","SAMINOT2",535,0)
TOUT(sid) ;
"RTN","SAMINOT2",536,0)
 s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",537,0)
 s groot=$na(@root@("graph",sid))
"RTN","SAMINOT2",538,0)
 s g=""
"RTN","SAMINOT2",539,0)
 f  s g=$o(@groot@(g)) q:g=""  d  ;
"RTN","SAMINOT2",540,0)
 . w !,g
"RTN","SAMINOT2",541,0)
 quit
"RTN","SAMINOT2",542,0)
 ;
"RTN","SAMINOT2",543,0)
OUT(ln) ; output new line to note
"RTN","SAMINOT2",544,0)
 ;
"RTN","SAMINOT2",545,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",546,0)
 ;
"RTN","SAMINOT2",547,0)
 i $$CRWRAP^SAMITTW(ln,dest,.cnt,80) q  ;
"RTN","SAMINOT2",548,0)
 ;
"RTN","SAMINOT2",549,0)
 s cnt=cnt+1
"RTN","SAMINOT2",550,0)
 n lnn
"RTN","SAMINOT2",551,0)
 ;s debug=1
"RTN","SAMINOT2",552,0)
 s lnn=$o(@dest@(" "),-1)+1
"RTN","SAMINOT2",553,0)
 s @dest@(lnn)=ln
"RTN","SAMINOT2",554,0)
 ;
"RTN","SAMINOT2",555,0)
 ;i $g(debug)=1 d  ;
"RTN","SAMINOT2",556,0)
 ;. i ln["<" q  ; no markup
"RTN","SAMINOT2",557,0)
 ;. n zs s zs=$STACK
"RTN","SAMINOT2",558,0)
 ;. n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMINOT2",559,0)
 ;. s @dest@(lnn)=zp_":"_ln
"RTN","SAMINOT2",560,0)
 ;
"RTN","SAMINOT2",561,0)
 quit  ; end of OUT
"RTN","SAMINOT2",562,0)
 ;
"RTN","SAMINOT2",563,0)
 ;
"RTN","SAMINOT2",564,0)
 ;
"RTN","SAMINOT2",565,0)
XVAL(var,vals) ; value of form variable
"RTN","SAMINOT2",566,0)
 ;
"RTN","SAMINOT2",567,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",568,0)
 ;@input
"RTN","SAMINOT2",569,0)
 ; var = name of form variable
"RTN","SAMINOT2",570,0)
 ; vals = global root of form variable array
"RTN","SAMINOT2",571,0)
 ; @vals = form variable array [pass by name]
"RTN","SAMINOT2",572,0)
 ;@output = value of form variable
"RTN","SAMINOT2",573,0)
 ;
"RTN","SAMINOT2",574,0)
 new zr
"RTN","SAMINOT2",575,0)
 set zr=$get(@vals@(var))
"RTN","SAMINOT2",576,0)
 ;
"RTN","SAMINOT2",577,0)
 ; i zr="" s zr="["_var_"]"
"RTN","SAMINOT2",578,0)
 ;
"RTN","SAMINOT2",579,0)
 quit zr ; end of $$XVAL
"RTN","SAMINOT2",580,0)
 ;
"RTN","SAMINOT2",581,0)
 ;
"RTN","SAMINOT2",582,0)
 ;
"RTN","SAMINOT2",583,0)
PREVCT(SID,FORM) ; key to previous ct eval form
"RTN","SAMINOT2",584,0)
 ;
"RTN","SAMINOT2",585,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",586,0)
 ;@input
"RTN","SAMINOT2",587,0)
 ; FORM = [not yet implemented, always treated as if FORM=""]
"RTN","SAMINOT2",588,0)
 ;@output = form key of CT Eval form previous to FORM
"RTN","SAMINOT2",589,0)
 ;
"RTN","SAMINOT2",590,0)
 ; $$PREVCT returns the form key to the CT Eval form previous to
"RTN","SAMINOT2",591,0)
 ; FORM. If FORM is null, the latest CT Eval form key is returned.
"RTN","SAMINOT2",592,0)
 ;
"RTN","SAMINOT2",593,0)
 new gn set gn=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",594,0)
 new prev set prev=$order(@gn@("graph",SID,"ceform-30"),-1)
"RTN","SAMINOT2",595,0)
 ;
"RTN","SAMINOT2",596,0)
 quit prev ; end of $$PREVCT
"RTN","SAMINOT2",597,0)
 ;
"RTN","SAMINOT2",598,0)
 ;
"RTN","SAMINOT2",599,0)
 ;
"RTN","SAMINOT2",600,0)
CTINFO(ARY,SID,FORM) ; extracts from latest CT Eval form
"RTN","SAMINOT2",601,0)
 ;
"RTN","SAMINOT2",602,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",603,0)
 ;@input
"RTN","SAMINOT2",604,0)
 ; ARY = name of output array
"RTN","SAMINOT2",605,0)
 ; SID
"RTN","SAMINOT2",606,0)
 ; FORM
"RTN","SAMINOT2",607,0)
 ;@output
"RTN","SAMINOT2",608,0)
 ; @ARY = extract from latest ct eval form [passed by name]
"RTN","SAMINOT2",609,0)
 ;
"RTN","SAMINOT2",610,0)
 n ctkey s ctkey=$$PREVCT(SID,$G(FORM))
"RTN","SAMINOT2",611,0)
 q:ctkey=""
"RTN","SAMINOT2",612,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",613,0)
 n ctroot s ctroot=$na(@root@("graph",SID,ctkey))
"RTN","SAMINOT2",614,0)
 ;
"RTN","SAMINOT2",615,0)
 s @ARY@("ctform")=ctkey
"RTN","SAMINOT2",616,0)
 s @ARY@("impression")=$g(@ctroot@("ceimre"))
"RTN","SAMINOT2",617,0)
 n futext
"RTN","SAMINOT2",618,0)
 s futext=$g(@ctroot@("cefuw"))
"RTN","SAMINOT2",619,0)
 n futbl
"RTN","SAMINOT2",620,0)
 s futbl("1y")="Annual repeat"
"RTN","SAMINOT2",621,0)
 s futbl("nw")="Now"
"RTN","SAMINOT2",622,0)
 s futbl("1m")="1 month"
"RTN","SAMINOT2",623,0)
 s futbl("3m")="3 months"
"RTN","SAMINOT2",624,0)
 s futbl("6m")="6 months"
"RTN","SAMINOT2",625,0)
 s futbl("os")="other"
"RTN","SAMINOT2",626,0)
 i futext'="" s futext=$g(futbl(futext))
"RTN","SAMINOT2",627,0)
 n fudate s fudate=$g(@ctroot@("cefud"))
"RTN","SAMINOT2",628,0)
 ; #Other followup
"RTN","SAMINOT2",629,0)
 n zfu,ofu,tofu,comma
"RTN","SAMINOT2",630,0)
 n vals s vals=ctroot
"RTN","SAMINOT2",631,0)
 s comma=0,tofu=""
"RTN","SAMINOT2",632,0)
 s ofu=""
"RTN","SAMINOT2",633,0)
 f zfu="cefuaf","cefucc","cefupe","cefufn","cefubr","cefupc","cefutb" d  ;
"RTN","SAMINOT2",634,0)
 . i $$XVAL(zfu,vals)="y" s ofu=ofu_zfu
"RTN","SAMINOT2",635,0)
 i $$XVAL("cefuo",vals)'="" s ofu=ofu_"cefuo"
"RTN","SAMINOT2",636,0)
 i ofu'="" d  ;
"RTN","SAMINOT2",637,0)
 . s tofu="Other followup: "
"RTN","SAMINOT2",638,0)
 . i ofu["cefuaf" s tofu=tofu_"Antibiotics" s comma=1
"RTN","SAMINOT2",639,0)
 . i ofu["cefucc" s tofu=tofu_$s(comma:", ",1:"")_"Diagnostic CT" s comma=1
"RTN","SAMINOT2",640,0)
 . i ofu["cefupe" s tofu=tofu_$s(comma:", ",1:"")_"PET" s comma=1
"RTN","SAMINOT2",641,0)
 . i ofu["cefufn" s tofu=tofu_$s(comma:", ",1:"")_"Percutaneous biopsy" s comma=1
"RTN","SAMINOT2",642,0)
 . i ofu["cefubr" s tofu=tofu_$s(comma:", ",1:"")_"Bronchoscopy" s comma=1
"RTN","SAMINOT2",643,0)
 . i ofu["cefupc" s tofu=tofu_$s(comma:", ",1:"")_"Pulmonary consultation" s comma=1
"RTN","SAMINOT2",644,0)
 . i ofu["cefutb" s tofu=tofu_$s(comma:", ",1:"")_"Refer to tumor board" s comma=1
"RTN","SAMINOT2",645,0)
 . i ofu["cefuo" s tofu=tofu_$s(comma:", ",1:"")_"Other:" s comma=1
"RTN","SAMINOT2",646,0)
 s @ARY@("followup")=futext_" "_fudate
"RTN","SAMINOT2",647,0)
 s @ARY@("followup2")=tofu
"RTN","SAMINOT2",648,0)
 s @ARY@("followup3")=$$XVAL("cefuoo",vals)
"RTN","SAMINOT2",649,0)
 ;
"RTN","SAMINOT2",650,0)
 quit  ; end of CTINFO
"RTN","SAMINOT2",651,0)
 ;
"RTN","SAMINOT2",652,0)
 ;
"RTN","SAMINOT2",653,0)
 ; 
"RTN","SAMINOT2",654,0)
IMPRESS(ARY,SID) ; impressions from ct eval report
"RTN","SAMINOT2",655,0)
 ;
"RTN","SAMINOT2",656,0)
 ;ven/gpl;private;procedure;
"RTN","SAMINOT2",657,0)
 ;@input
"RTN","SAMINOT2",658,0)
 ; ARY = name of output array
"RTN","SAMINOT2",659,0)
 ; SID
"RTN","SAMINOT2",660,0)
 ;@output
"RTN","SAMINOT2",661,0)
 ; @ARY = impressions from ct eval report [passed by name]
"RTN","SAMINOT2",662,0)
 ;
"RTN","SAMINOT2",663,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",664,0)
 n ctkey s ctkey=$g(@ARY@("ctform"))
"RTN","SAMINOT2",665,0)
 n vals s vals=$na(@root@("graph",SID,ctkey))
"RTN","SAMINOT2",666,0)
 n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMINOT2",667,0)
 s dict=$na(@dict@("cteval-dict"))
"RTN","SAMINOT2",668,0)
 n para s para=""
"RTN","SAMINOT2",669,0)
 n sp1 s sp1="    "
"RTN","SAMINOT2",670,0)
 ; 
"RTN","SAMINOT2",671,0)
 d OUT("Impression:")
"RTN","SAMINOT2",672,0)
 d OUT(sp1_$$XSUB("ceimn",vals,dict)_para)
"RTN","SAMINOT2",673,0)
 ;
"RTN","SAMINOT2",674,0)
 ;# Report CAC Score and Extent of Emphysema
"RTN","SAMINOT2",675,0)
 s cacval=0
"RTN","SAMINOT2",676,0)
 d  ;if $$XVAL("ceccv",vals)'="e" d  ;
"RTN","SAMINOT2",677,0)
 . set vcac=$$XVAL("cecccac",vals)
"RTN","SAMINOT2",678,0)
 . if vcac'="" d  ;
"RTN","SAMINOT2",679,0)
 . . s cacrec=""
"RTN","SAMINOT2",680,0)
 . . s cac="The Visual Coronary Artery Calcium (CAC) Score is "_vcac_". "
"RTN","SAMINOT2",681,0)
 . . s cacval=vcac
"RTN","SAMINOT2",682,0)
 . . i cacval>3 s cacrec=$g(@dict@("CAC_recommendation"))_para
"RTN","SAMINOT2",683,0)
 ;
"RTN","SAMINOT2",684,0)
 i cacval>0 d  ;
"RTN","SAMINOT2",685,0)
 . d OUT(sp1_cac_" "_cacrec_" "_para)
"RTN","SAMINOT2",686,0)
 . d  ;if $$XVAL("ceemv",vals)="e" d  ;
"RTN","SAMINOT2",687,0)
 . . if $$XVAL("ceem",vals)'="no" d  ;
"RTN","SAMINOT2",688,0)
 . . . if $$XVAL("ceem",vals)="nv" q  ;
"RTN","SAMINOT2",689,0)
 . . . d OUT(sp1_"Emphysema: "_$$XSUB("ceem",vals,dict)_"."_para)
"RTN","SAMINOT2",690,0)
 ;
"RTN","SAMINOT2",691,0)
 i $$XVAL("ceclini",vals)="y" d  ;
"RTN","SAMINOT2",692,0)
 . d OUT(sp1_$$XVAL("ceclin",vals)_"."_para)
"RTN","SAMINOT2",693,0)
 ;
"RTN","SAMINOT2",694,0)
 i $$XVAL("ceoppai",vals)="y" d  ;
"RTN","SAMINOT2",695,0)
 . d OUT(sp1_$$XVAL("ceoppa",vals)_"."_para)
"RTN","SAMINOT2",696,0)
 ;
"RTN","SAMINOT2",697,0)
 i $$XVAL("ceoppabi",vals)="y" d  ;
"RTN","SAMINOT2",698,0)
 . d OUT(sp1_$$XVAL("ceoppab",vals)_"."_para)
"RTN","SAMINOT2",699,0)
 ;
"RTN","SAMINOT2",700,0)
 i $$XVAL("cecommcai",vals)="y" d  ;
"RTN","SAMINOT2",701,0)
 . d OUT(sp1_$$XVAL("cecommca",vals)_"."_para)
"RTN","SAMINOT2",702,0)
 ;
"RTN","SAMINOT2",703,0)
 i $$XVAL("ceotabnmi",vals)="y" d  ;
"RTN","SAMINOT2",704,0)
 . d OUT(sp1_$$XVAL("ceotabnm",vals)_"."_para)
"RTN","SAMINOT2",705,0)
 ;
"RTN","SAMINOT2",706,0)
 i $$XVAL("ceobrci",vals)="y" d  ;
"RTN","SAMINOT2",707,0)
 . d OUT(sp1_$$XVAL("ceobrc",vals)_"."_para)
"RTN","SAMINOT2",708,0)
 ;
"RTN","SAMINOT2",709,0)
 i $$XVAL("ceaoabbi",vals)="y" d  ;
"RTN","SAMINOT2",710,0)
 . d OUT(sp1_$$XVAL("ceaoabb",vals)_"."_para)
"RTN","SAMINOT2",711,0)
 ;
"RTN","SAMINOT2",712,0)
 i $$XVAL("ceaoabi",vals)="y" d  ;
"RTN","SAMINOT2",713,0)
 . d OUT(sp1_$$XVAL("ceaoab",vals)_"."_para)
"RTN","SAMINOT2",714,0)
 ;
"RTN","SAMINOT2",715,0)
 ;# Impression Remarks
"RTN","SAMINOT2",716,0)
 i $$XVAL("ceimre",vals)'="" d  ;
"RTN","SAMINOT2",717,0)
 . d OUT(sp1_$$XVAL("ceimre",vals)_"."_para)
"RTN","SAMINOT2",718,0)
 ;
"RTN","SAMINOT2",719,0)
 quit  ; end of IMPRESS
"RTN","SAMINOT2",720,0)
 ;
"RTN","SAMINOT2",721,0)
 ;
"RTN","SAMINOT2",722,0)
 ;
"RTN","SAMINOT2",723,0)
XSUB(var,vals,dict,valdx) ; dictionary value for variable
"RTN","SAMINOT2",724,0)
 ;
"RTN","SAMINOT2",725,0)
 ;ven/gpl;private;function;
"RTN","SAMINOT2",726,0)
 ;@input
"RTN","SAMINOT2",727,0)
 ; var = name of dictionary value
"RTN","SAMINOT2",728,0)
 ; vals = name of variables array
"RTN","SAMINOT2",729,0)
 ; @vals = variables array [passed by name]
"RTN","SAMINOT2",730,0)
 ; dict = name of dictionary array
"RTN","SAMINOT2",731,0)
 ; @dict = dictionary array [passed by name]
"RTN","SAMINOT2",732,0)
 ; valdx = used for nodules ala cect2co with nodule # included
"RTN","SAMINOT2",733,0)
 ;@output = dictionary value for variable
"RTN","SAMINOT2",734,0)
 ;
"RTN","SAMINOT2",735,0)
 ; new dict set dict=$$setroot^%wd("cteval-dict")
"RTN","SAMINOT2",736,0)
 ;
"RTN","SAMINOT2",737,0)
 n zr,zv,zdx
"RTN","SAMINOT2",738,0)
 s zdx=$g(valdx)
"RTN","SAMINOT2",739,0)
 i zdx="" s zdx=var
"RTN","SAMINOT2",740,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMINOT2",741,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMINOT2",742,0)
 i zv="" s zr="" q zr
"RTN","SAMINOT2",743,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMINOT2",744,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMINOT2",745,0)
 ;
"RTN","SAMINOT2",746,0)
 quit zr ; end of $$XSUB
"RTN","SAMINOT2",747,0)
 ;
"RTN","SAMINOT2",748,0)
 ;
"RTN","SAMINOT2",749,0)
 ;
"RTN","SAMINOT2",750,0)
EOR ; end of routine SAMINOT2
"RTN","SAMINUL")
0^13^B108214
"RTN","SAMINUL",1,0)
SAMINUL ;ven/gpl - ielcap: note log ;2021-07-01t17:41z
"RTN","SAMINUL",2,0)
 ;;18.0;SAMI;**9,10,11,12**;2020-01;Build 6
"RTN","SAMINUL",3,0)
 ;;1.18.0.11-t3+i11
"RTN","SAMINUL",4,0)
 ;
"RTN","SAMINUL",5,0)
 ; SAMINOTE contains subroutines for producing the ELCAP Note Pages.
"RTN","SAMINUL",6,0)
 ; SAMINUL contains the development log for the SAMINOT* routines.
"RTN","SAMINUL",7,0)
 ; It contains no executable code.
"RTN","SAMINUL",8,0)
 ;
"RTN","SAMINUL",9,0)
 quit  ; no entry from top
"RTN","SAMINUL",10,0)
 ;
"RTN","SAMINUL",11,0)
 ;
"RTN","SAMINUL",12,0)
 ;
"RTN","SAMINUL",13,0)
 ;@section 0 primary development
"RTN","SAMINUL",14,0)
 ;
"RTN","SAMINUL",15,0)
 ;
"RTN","SAMINUL",16,0)
 ;
"RTN","SAMINUL",17,0)
 ;@routine-credits
"RTN","SAMINUL",18,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMINUL",19,0)
 ; gpl@vistaexpertise.net
"RTN","SAMINUL",20,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMINUL",21,0)
 ; http://vistaexpertise.net
"RTN","SAMINUL",22,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMINUL",23,0)
 ;@license see routine SAMIUL
"RTN","SAMINUL",24,0)
 ;
"RTN","SAMINUL",25,0)
 ;@last-updated 2021-07-01t17:41z
"RTN","SAMINUL",26,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMINUL",27,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMINUL",28,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMINUL",29,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMINUL",30,0)
 ;@release-date 2020-01
"RTN","SAMINUL",31,0)
 ;@patch-list **9,10,11,12**
"RTN","SAMINUL",32,0)
 ;
"RTN","SAMINUL",33,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMINUL",34,0)
 ; toad@vistaexpertise.net
"RTN","SAMINUL",35,0)
 ;@additional-dev Larry G. Carlson (lgc)
"RTN","SAMINUL",36,0)
 ; larry.g.carlson@gmail.com
"RTN","SAMINUL",37,0)
 ;@additional-dev Linda M. R. Yaw (lmry)
"RTN","SAMINUL",38,0)
 ; linda.yaw@vistaexpertise.net
"RTN","SAMINUL",39,0)
 ;@additional-dev Alexis R. Carlson (arc)
"RTN","SAMINUL",40,0)
 ; whatisthehumanspirit@gmail.com
"RTN","SAMINUL",41,0)
 ;@additional-dev Domenic DiNatale (dom)
"RTN","SAMINUL",42,0)
 ; domenic.dinatale@paraxialtech.com
"RTN","SAMINUL",43,0)
 ;@additional-dev Kenneth McGlothlen (mcglk)
"RTN","SAMINUL",44,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMINUL",45,0)
 ;
"RTN","SAMINUL",46,0)
 ;@module-credits
"RTN","SAMINUL",47,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMINUL",48,0)
 ; (VA-PALS)
"RTN","SAMINUL",49,0)
 ; http://va-pals.org/
"RTN","SAMINUL",50,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMINUL",51,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMINUL",52,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMINUL",53,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMINUL",54,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMINUL",55,0)
 ; http://ielcap.com/
"RTN","SAMINUL",56,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMINUL",57,0)
 ; http://paraxialtech.com/
"RTN","SAMINUL",58,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMINUL",59,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMINUL",60,0)
 ;
"RTN","SAMINUL",61,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMINUL",62,0)
 ;
"RTN","SAMINUL",63,0)
 ; 2019-04-04/18 ven/gpl 1.18.0-t04 c0bb7dbf,f7b48936,9d1f2cdc,
"RTN","SAMINUL",64,0)
 ;  ba5f366d,5b2e32dc,ce322911
"RTN","SAMINUL",65,0)
 ;  SAMINOT1: flags for intake form, fix crash on intake form, initial
"RTN","SAMINUL",66,0)
 ; version of new intake notes, revise text for pre-enrollment
"RTN","SAMINUL",67,0)
 ; discusstion note, complete new intake notes, add intake notes to
"RTN","SAMINUL",68,0)
 ; case review page.
"RTN","SAMINUL",69,0)
 ;
"RTN","SAMINUL",70,0)
 ; 2019-04-16/23 ven/lgc 1.18.0-t04 e54b76d1,21388d8a,f0505e51,
"RTN","SAMINUL",71,0)
 ;  89bffd3b
"RTN","SAMINUL",72,0)
 ;  SAMINOT1: SAMIFRM2 > SAMIFORM, remove spaces at end of lines,
"RTN","SAMINUL",73,0)
 ; control characters, SAMISUB2 > LOAD.
"RTN","SAMINUL",74,0)
 ;
"RTN","SAMINUL",75,0)
 ; 2019-04-23 ven/toad 1.18.0-t04 423a3946
"RTN","SAMINUL",76,0)
 ;  SAMINOT1: resolve gpl/lgc collision, restore SAMISUB2 > LOAD.
"RTN","SAMINUL",77,0)
 ;
"RTN","SAMINUL",78,0)
 ; 2019-04-30 ven/gpl 1.18.0-t04 cf73510c
"RTN","SAMINUL",79,0)
 ;  SAMINOT1: additions to intake note for prior scans & format.
"RTN","SAMINUL",80,0)
 ;
"RTN","SAMINUL",81,0)
 ; 2019-05-07 ven/lmry 1.18.0-t04 4a8ead45
"RTN","SAMINUL",82,0)
 ;  SAMINOT1: edit SAMINOT1 for XINDEX.
"RTN","SAMINUL",83,0)
 ;
"RTN","SAMINUL",84,0)
 ; 2019-05-07 ven/lgc 1.18.0-t04 f63ef57c
"RTN","SAMINUL",85,0)
 ;  SAMINOT1: cleanup for XINDEX.
"RTN","SAMINUL",86,0)
 ;
"RTN","SAMINUL",87,0)
 ; 2019-06-18 ven/arc 1.18.0-t04 91022482
"RTN","SAMINUL",88,0)
 ;  SAMINOT1: ^SAMIGPL > ^SAMIUL.
"RTN","SAMINUL",89,0)
 ;
"RTN","SAMINUL",90,0)
 ; 2019-07-01 ven/gpl 1.18.0-t04 72868e60
"RTN","SAMINUL",91,0)
 ;  SAMINOT1: update shared decision making text in intake note.
"RTN","SAMINUL",92,0)
 ;
"RTN","SAMINUL",93,0)
 ; 2019-08-03/14 ven/gpl 1.18.0-t04 bea65f7b,578f61d4
"RTN","SAMINUL",94,0)
 ;  SAMINOT1: fix bugs in Have you ever smoked processing in changelog
"RTN","SAMINUL",95,0)
 ; & intake note, restored ever smoked comment field to intake note.
"RTN","SAMINUL",96,0)
 ;
"RTN","SAMINUL",97,0)
 ; 2019-09-06 par/dom 1.18.0-t04 2ff47189 VAP-452
"RTN","SAMINUL",98,0)
 ;  SAMINOT1: patient > participant.
"RTN","SAMINUL",99,0)
 ;
"RTN","SAMINUL",100,0)
 ; 2019-09-26 ven/gpl 1.18.0-t04 92b12324 VAP-420
"RTN","SAMINUL",101,0)
 ;  SAMINOT1: smoking history.
"RTN","SAMINUL",102,0)
 ;
"RTN","SAMINUL",103,0)
 ; 2019-10-01 par/dom 1.18.0-t04 37c418a1,4caf1a98 VAP-457,344
"RTN","SAMINUL",104,0)
 ;  SAMINOT1: remove thorax, capitalization consistency.
"RTN","SAMINUL",105,0)
 ;
"RTN","SAMINUL",106,0)
 ; 2020-01-17/20 ven/lgc 1.18.0.1+i1 8557207f,d7d24834,0301ad95.
"RTN","SAMINUL",107,0)
 ;  659f2526,0ff2b83f,49615242,5bf7c398,dc5f618c
"RTN","SAMINUL",108,0)
 ;  SAMINOT2: followup note, fixed typos in VC note, followup LCS note
"RTN","SAMINUL",109,0)
 ; minus CT Eval pulls, LCS note with CT Eval extracts, fixed bug in
"RTN","SAMINUL",110,0)
 ; LSC CT eval extract, include entire impression section of CT Eval
"RTN","SAMINUL",111,0)
 ; report in LCS Note, improved import of impressions, limit to one
"RTN","SAMINUL",112,0)
 ; note per followup form.
"RTN","SAMINUL",113,0)
 ;
"RTN","SAMINUL",114,0)
 ; 2020-01-23 ven/arc 1.18.0.2+i2 9a24242a
"RTN","SAMINUL",115,0)
 ;  SAMINOT1: fix word wrap on intake note & typos in ct
"RTN","SAMINUL",116,0)
 ; eval report.
"RTN","SAMINUL",117,0)
 ;
"RTN","SAMINUL",118,0)
 ; 2020-08-12 ven/gpl 1.18.0.6+i6 781744c3
"RTN","SAMINUL",119,0)
 ;  SAMINOT1: chg to support hl7 transmission of notes.
"RTN","SAMINUL",120,0)
 ;
"RTN","SAMINUL",121,0)
 ; 2020-09-22 ven/gpl 1.18.0.6+i6 06459eda
"RTN","SAMINUL",122,0)
 ;  SAMINOT1: fix to match kids file.
"RTN","SAMINUL",123,0)
 ;
"RTN","SAMINUL",124,0)
 ; 2021-02-01/24 ven/gpl 1.18.0.8+i8 8e4ec441,cde71a55
"RTN","SAMINUL",125,0)
 ;  SAMINOT1: fix intake note format, fix error that sent note twice
"RTN","SAMINUL",126,0)
 ; to VistA.
"RTN","SAMINUL",127,0)
 ;
"RTN","SAMINUL",128,0)
 ; 2021-03-02 ven/gpl 1.18.0.9+i9 479dc041
"RTN","SAMINUL",129,0)
 ;  SAMINOT2: return error message if no ct eval form exists when
"RTN","SAMINUL",130,0)
 ; generating a fu note.
"RTN","SAMINUL",131,0)
 ;
"RTN","SAMINUL",132,0)
 ; 2021-03-15/16 ven/toad 1.18.0.9+i9 a46a2cc1
"RTN","SAMINUL",133,0)
 ;  SAMINUL: create routine.
"RTN","SAMINUL",134,0)
 ;  SAMINOT2: bump date & patch list, add contents, lt refactor.
"RTN","SAMINUL",135,0)
 ;
"RTN","SAMINUL",136,0)
 ; 2021-03-17 ven/toad 1.18.0.9+i9 62da30b4
"RTN","SAMINUL",137,0)
 ; SAMINOT2: remove blank from end of 1 line.
"RTN","SAMINUL",138,0)
 ;
"RTN","SAMINUL",139,0)
 ; 2021-03-22 ven/gpl 1.18.0.10+i10 6319a1eb
"RTN","SAMINUL",140,0)
 ;  SAMINOT1: fix logic bug in detecting pre-enrollment existing.
"RTN","SAMINUL",141,0)
 ;
"RTN","SAMINUL",142,0)
 ; 2021-03-23 ven/toad 1.18.0.10+i10 96f461d0
"RTN","SAMINUL",143,0)
 ;  SAMINOT1: bump date & patch list, lt refactor.
"RTN","SAMINUL",144,0)
 ;
"RTN","SAMINUL",145,0)
 ; 2021-03-29 ven/gpl 1.18.0.11+i11 6cd83445 VAP-483
"RTN","SAMINUL",146,0)
 ;  SAMINOT1: allow N/A for shared decision making on intake form:
"RTN","SAMINUL",147,0)
 ; in INNOTE new & set shareddm & use to call SDM or report n/a, based
"RTN","SAMINUL",148,0)
 ; on siidmdc.
"RTN","SAMINUL",149,0)
 ;
"RTN","SAMINUL",150,0)
 ; 2021-03-30/05-21 ven/mcglk&toad 1.18.0.11+i11 7b14bb2,
"RTN","SAMINUL",151,0)
 ;  SAMINOT1: bump version, date, log, add quit to stop block mismatch
"RTN","SAMINUL",152,0)
 ; complaint from XINDEX.
"RTN","SAMINUL",153,0)
 ;
"RTN","SAMINUL",154,0)
 ; 2021-06-29 ven/gpl 1.18.0.12-t2+i12 a5bbd37a,d865b0dc
"RTN","SAMINUL",155,0)
 ;  SAMINOT1,2 text box formatting for intake & followup notes, new
"RTN","SAMINUL",156,0)
 ; text processing utils; restrict follow forms to one generated note.
"RTN","SAMINUL",157,0)
 ;
"RTN","SAMINUL",158,0)
 ; 2021-07-01 ven/mcglk&toad 1.18.0.12-t2+i12 cbf7e46b
"RTN","SAMINUL",159,0)
 ;  SAMINOT1,2 bump dates & versions, update dev log, update contents.
"RTN","SAMINUL",160,0)
 ;
"RTN","SAMINUL",161,0)
 ;
"RTN","SAMINUL",162,0)
 ;
"RTN","SAMINUL",163,0)
EOR ; end of routine SAMINUL
"RTN","SAMIORM")
0^14^B175905084
"RTN","SAMIORM",1,0)
SAMIORM ;ven/lgc&arc - HL7: ORM > patient-lookup ;2021-06-08t20:07z
"RTN","SAMIORM",2,0)
 ;;18.0;SAMI;**11,12**;2020-01;Build 6
"RTN","SAMIORM",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIORM",4,0)
 ;
"RTN","SAMIORM",5,0)
 ; SAMIORM parses an incoming Order (ORM) message into the fields
"RTN","SAMIORM",6,0)
 ; array, then calls SAMIHL7 to use the array to update the patient-
"RTN","SAMIORM",7,0)
 ; lookup graph.
"RTN","SAMIORM",8,0)
 ;
"RTN","SAMIORM",9,0)
 ; SAMIOUL contains the development log for the SAMIHL7 & SAMIOR*
"RTN","SAMIORM",10,0)
 ; routines.
"RTN","SAMIORM",11,0)
 ;
"RTN","SAMIORM",12,0)
 quit  ; no entry from top
"RTN","SAMIORM",13,0)
 ;
"RTN","SAMIORM",14,0)
 ;
"RTN","SAMIORM",15,0)
 ;
"RTN","SAMIORM",16,0)
 ;@section 0 primary development
"RTN","SAMIORM",17,0)
 ;
"RTN","SAMIORM",18,0)
 ;
"RTN","SAMIORM",19,0)
 ;
"RTN","SAMIORM",20,0)
 ;@routine-credits
"RTN","SAMIORM",21,0)
 ;@primary-dev Larry G. Carlson (lgc)
"RTN","SAMIORM",22,0)
 ; larry@fiscientific.com
"RTN","SAMIORM",23,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIORM",24,0)
 ; http://vistaexpertise.net
"RTN","SAMIORM",25,0)
 ;@copyright 2020/2021, lgc, all rights reserved
"RTN","SAMIORM",26,0)
 ;@license see routine SAMIUL
"RTN","SAMIORM",27,0)
 ;
"RTN","SAMIORM",28,0)
 ;@last-updated 2021-06-08t20:07z
"RTN","SAMIORM",29,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIORM",30,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIORM",31,0)
 ;@submodule HL7 interface - SAMIHL* & SAMIOR*
"RTN","SAMIORM",32,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIORM",33,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIORM",34,0)
 ;@release-date 2020-01
"RTN","SAMIORM",35,0)
 ;@patch-list **11,12**
"RTN","SAMIORM",36,0)
 ;
"RTN","SAMIORM",37,0)
 ;@additional-dev Alexis R. Carlson (arc)
"RTN","SAMIORM",38,0)
 ; arc@vistaexpertise.net
"RTN","SAMIORM",39,0)
 ;@additional-dev George P. Lilly (gpl)
"RTN","SAMIORM",40,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIORM",41,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIORM",42,0)
 ; toad@vistaexpertise.net
"RTN","SAMIORM",43,0)
 ;@additional-dev Kenneth McGlothlen (mcglk)
"RTN","SAMIORM",44,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIORM",45,0)
 ;
"RTN","SAMIORM",46,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIORM",47,0)
 ; see routine SAMIOUL
"RTN","SAMIORM",48,0)
 ;@contents
"RTN","SAMIORM",49,0)
 ; EN-BLDARR-PMSG-UPDTPTL parse ORM msg > patient-lookup graph
"RTN","SAMIORM",50,0)
 ;
"RTN","SAMIORM",51,0)
 ; PARSEMSG get patient data f/ORM msg
"RTN","SAMIORM",52,0)
 ; PID-ORMADDR get patient data from PID segment
"RTN","SAMIORM",53,0)
 ; PV1 get patient data from PV1 segment
"RTN","SAMIORM",54,0)
 ; ORC get patient data from ORC segment
"RTN","SAMIORM",55,0)
 ; OBR get patient data from OBR segment
"RTN","SAMIORM",56,0)
 ;
"RTN","SAMIORM",57,0)
 ; TEST test hli EN^SAMIORM
"RTN","SAMIORM",58,0)
 ;
"RTN","SAMIORM",59,0)
 ;
"RTN","SAMIORM",60,0)
 ;
"RTN","SAMIORM",61,0)
 ;@section 1 hl7 applications & protocols that call hli EN^SAMIORM
"RTN","SAMIORM",62,0)
 ;
"RTN","SAMIORM",63,0)
 ;
"RTN","SAMIORM",64,0)
 ;
"RTN","SAMIORM",65,0)
 ; SAMI HL logical links
"RTN","SAMIORM",66,0)
 ;
"RTN","SAMIORM",67,0)
 ; NODE: LISTENER                          INSTITUTION: VISTA HEALTH CARE
"RTN","SAMIORM",68,0)
 ;   LLP TYPE: TCP                         DEVICE TYPE: Multi-threaded Server
"RTN","SAMIORM",69,0)
 ;   STATE: 7757 server                    AUTOSTART: Enabled
"RTN","SAMIORM",70,0)
 ;   MAILMAN DOMAIN: VAPALS.ELCAP.ORG      SHUTDOWN LLP ?: NO
"RTN","SAMIORM",71,0)
 ;   QUEUE SIZE: 10                        DO NOT PING: NO
"RTN","SAMIORM",72,0)
 ;   RE-TRANSMISSION ATTEMPTS: 5           READ TIMEOUT: 600
"RTN","SAMIORM",73,0)
 ;   ACK TIMEOUT: 600                      EXCEED RE-TRANSMIT ACTION: ignore
"RTN","SAMIORM",74,0)
 ;   TCP/IP PORT: 5000                     TCP/IP SERVICE TYPE: MULTI LISTENER
"RTN","SAMIORM",75,0)
 ;   PERSISTENT: YES                       STARTUP NODE: USER:VAPALS
"RTN","SAMIORM",76,0)
 ;   IN QUEUE BACK POINTER: 117            IN QUEUE FRONT POINTER: 105
"RTN","SAMIORM",77,0)
 ;   OUT QUEUE BACK POINTER: 76            OUT QUEUE FRONT POINTER: 76
"RTN","SAMIORM",78,0)
 ;
"RTN","SAMIORM",79,0)
 ;
"RTN","SAMIORM",80,0)
 ;
"RTN","SAMIORM",81,0)
 ; SAMI HL7 applications
"RTN","SAMIORM",82,0)
 ;
"RTN","SAMIORM",83,0)
 ; NAME: MCAR-INST                         ACTIVE/INACTIVE: ACTIVE
"RTN","SAMIORM",84,0)
 ;   FACILITY NAME: VISTA                  COUNTRY CODE: USA
"RTN","SAMIORM",85,0)
 ;   HL7 ENCODING CHARACTERS: ^~\&         HL7 FIELD SEPARATOR: |
"RTN","SAMIORM",86,0)
 ;
"RTN","SAMIORM",87,0)
 ;
"RTN","SAMIORM",88,0)
 ; NAME: INST-MCAR                         ACTIVE/INACTIVE: ACTIVE
"RTN","SAMIORM",89,0)
 ;   FACILITY NAME: VAPALS                 COUNTRY CODE: USA
"RTN","SAMIORM",90,0)
 ;   HL7 ENCODING CHARACTERS: ^~\&         HL7 FIELD SEPARATOR: |
"RTN","SAMIORM",91,0)
 ;
"RTN","SAMIORM",92,0)
 ;
"RTN","SAMIORM",93,0)
 ;
"RTN","SAMIORM",94,0)
 ; SAMI HL7 ORM protocols
"RTN","SAMIORM",95,0)
 ;
"RTN","SAMIORM",96,0)
 ; NAME: MCAR ORM SERVER
"RTN","SAMIORM",97,0)
 ;   ITEM TEXT: Clinical Procedures ORM Protocol Server
"RTN","SAMIORM",98,0)
 ;   TYPE: event driver                    CREATOR: LABTECH,FORTYEIGHT
"RTN","SAMIORM",99,0)
 ;   TIMESTAMP: 59921,33274                SENDING APPLICATION: MCAR-INST
"RTN","SAMIORM",100,0)
 ;   TRANSACTION MESSAGE TYPE: ORM         EVENT TYPE: O01
"RTN","SAMIORM",101,0)
 ;   VERSION ID: 2.3
"RTN","SAMIORM",102,0)
 ; SUBSCRIBERS: PHX ENROLL ORM
"RTN","SAMIORM",103,0)
 ;
"RTN","SAMIORM",104,0)
 ;
"RTN","SAMIORM",105,0)
 ; NAME: PHX ENROLL ORM EVN                TYPE: event driver
"RTN","SAMIORM",106,0)
 ;   CREATOR: CARLSON,LARRY G              SENDING APPLICATION: MCAR-INST
"RTN","SAMIORM",107,0)
 ;   TRANSACTION MESSAGE TYPE: ORM         EVENT TYPE: O01
"RTN","SAMIORM",108,0)
 ;   ACCEPT ACK CODE: AL                   APPLICATION ACK TYPE: NE
"RTN","SAMIORM",109,0)
 ;   VERSION ID: 2.3
"RTN","SAMIORM",110,0)
 ; SUBSCRIBERS: PHX ENROLL ORM
"RTN","SAMIORM",111,0)
 ;
"RTN","SAMIORM",112,0)
 ;
"RTN","SAMIORM",113,0)
 ; NAME: PHX ENROLL ORM                    TYPE: subscriber
"RTN","SAMIORM",114,0)
 ;   CREATOR: CARLSON,LARRY G              RECEIVING APPLICATION: INST-MCAR
"RTN","SAMIORM",115,0)
 ;   EVENT TYPE: O01                       RESPONSE MESSAGE TYPE: ACK
"RTN","SAMIORM",116,0)
 ;   PROCESSING ROUTINE: D EN^SAMIORM      SENDING FACILITY REQUIRED?: YES
"RTN","SAMIORM",117,0)
 ; 
"RTN","SAMIORM",118,0)
 ; RECEIVING FACILITY REQUIRED?: YES
"RTN","SAMIORM",119,0)
 ;
"RTN","SAMIORM",120,0)
 ;
"RTN","SAMIORM",121,0)
 ;
"RTN","SAMIORM",122,0)
 ;@section 2 main hli EN^SAMIORM
"RTN","SAMIORM",123,0)
 ;
"RTN","SAMIORM",124,0)
 ;
"RTN","SAMIORM",125,0)
 ;
"RTN","SAMIORM",126,0)
 ;@hli EN^SAMIORM
"RTN","SAMIORM",127,0)
EN ; parse ORM message into patient-lookup graph
"RTN","SAMIORM",128,0)
 ;
"RTN","SAMIORM",129,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIORM",130,0)
 ;
"RTN","SAMIORM",131,0)
 ;;hli;procedure;clean;silent;sac
"RTN","SAMIORM",132,0)
 ;@falls-thru-to
"RTN","SAMIORM",133,0)
 ; BLDARR-PMSG-UPDTPTL
"RTN","SAMIORM",134,0)
 ;@called-by [see section 1]
"RTN","SAMIORM",135,0)
 ;@calls
"RTN","SAMIORM",136,0)
 ; $$HTFM^XLFDT
"RTN","SAMIORM",137,0)
 ; ACK^SAMIHL7
"RTN","SAMIORM",138,0)
 ;@input [tbd]
"RTN","SAMIORM",139,0)
 ; ]HLNEXT = executable code that sets HLNODE to next line of hl7 msg
"RTN","SAMIORM",140,0)
 ; ]HL("ECH")
"RTN","SAMIORM",141,0)
 ; ]HL("FS")
"RTN","SAMIORM",142,0)
 ; ]HLREC("MID")
"RTN","SAMIORM",143,0)
 ;@output [tbd]
"RTN","SAMIORM",144,0)
 ; patient-lookup graph updated for patient
"RTN","SAMIORM",145,0)
 ; ^KBAP = debug array
"RTN","SAMIORM",146,0)
 ; hl7 ACK msg sent
"RTN","SAMIORM",147,0)
 ;
"RTN","SAMIORM",148,0)
 ;
"RTN","SAMIORM",149,0)
 ;@stanza 2 setup
"RTN","SAMIORM",150,0)
 ;
"RTN","SAMIORM",151,0)
 kill ^KBAP("SAMIORM")
"RTN","SAMIORM",152,0)
 set ^KBAP("SAMIORM","EN")=$$HTFM^XLFDT($horolog)_" TEST"
"RTN","SAMIORM",153,0)
 ;
"RTN","SAMIORM",154,0)
 ; immediately return COMM ACK  ***** TMP TURNED OFF
"RTN","SAMIORM",155,0)
 do ACK^SAMIHL7
"RTN","SAMIORM",156,0)
 ;
"RTN","SAMIORM",157,0)
 ;
"RTN","SAMIORM",158,0)
BLDARR ;@stanza 3 pull out message into samihl7 array
"RTN","SAMIORM",159,0)
 ;
"RTN","SAMIORM",160,0)
 ;@falls-thru-from
"RTN","SAMIORM",161,0)
 ; EN
"RTN","SAMIORM",162,0)
 ;@falls-thru-to
"RTN","SAMIORM",163,0)
 ; PMSG-UPDTPTL
"RTN","SAMIORM",164,0)
 ;@called-by none
"RTN","SAMIORM",165,0)
 ;@calls
"RTN","SAMIORM",166,0)
 ; $$HTFM^XLFDT
"RTN","SAMIORM",167,0)
 ;
"RTN","SAMIORM",168,0)
 new invdt set invdt=9999999.9999-$$HTFM^XLFDT($horolog)
"RTN","SAMIORM",169,0)
 ;
"RTN","SAMIORM",170,0)
 new HLARR ; hl7 msg array fetched by xecuting HLNEXT
"RTN","SAMIORM",171,0)
 new samihl7 ; ditto
"RTN","SAMIORM",172,0)
 new cnt set cnt=0 ; line count
"RTN","SAMIORM",173,0)
 for  do  quit:$get(HLNODE)=""
"RTN","SAMIORM",174,0)
 . xecute HLNEXT ; get next line of hl7 msg
"RTN","SAMIORM",175,0)
 . quit:$get(HLNODE)=""  ; done when out of lines
"RTN","SAMIORM",176,0)
 . set cnt=cnt+1 ; count line
"RTN","SAMIORM",177,0)
 . set HLARR(cnt)=HLNODE ; save line
"RTN","SAMIORM",178,0)
 . set samihl7(cnt)=HLNODE ; ditto
"RTN","SAMIORM",179,0)
 . quit
"RTN","SAMIORM",180,0)
 ;
"RTN","SAMIORM",181,0)
 kill ^KBAP("SAMIORM","BLDARR")
"RTN","SAMIORM",182,0)
 merge ^KBAP("SAMIORM","BLDARR","HLARR")=HLARR
"RTN","SAMIORM",183,0)
 ;
"RTN","SAMIORM",184,0)
 new INFS set INFS=$get(HL("FS"))
"RTN","SAMIORM",185,0)
 new INCC set INCC=$extract($get(HL("ECH")))
"RTN","SAMIORM",186,0)
 ;
"RTN","SAMIORM",187,0)
 ;
"RTN","SAMIORM",188,0)
PMSG ;@stanza 4 pull patient data in ORM message > fields array
"RTN","SAMIORM",189,0)
 ;
"RTN","SAMIORM",190,0)
 ;@falls-thru-from
"RTN","SAMIORM",191,0)
 ; EN-BLDARR
"RTN","SAMIORM",192,0)
 ;@falls-thru-to
"RTN","SAMIORM",193,0)
 ; UPDTPTL
"RTN","SAMIORM",194,0)
 ;@called-by none
"RTN","SAMIORM",195,0)
 ;@calls
"RTN","SAMIORM",196,0)
 ; PARSEMSG
"RTN","SAMIORM",197,0)
 ;
"RTN","SAMIORM",198,0)
 new fields set fields("ORM",invdt,"msgid")=$get(HLREC("MID"))
"RTN","SAMIORM",199,0)
 do PARSEMSG(.HLARR,.fields) ; get patient data f/ORM msg
"RTN","SAMIORM",200,0)
 ;
"RTN","SAMIORM",201,0)
 merge ^KBAP("SAMIORM","samihl7")=samihl7
"RTN","SAMIORM",202,0)
 merge ^KBAP("SAMIORM","fields")=fields
"RTN","SAMIORM",203,0)
 ;
"RTN","SAMIORM",204,0)
 ;
"RTN","SAMIORM",205,0)
UPDTPTL ;@stanza 5 update patient-lookup graph using fields array
"RTN","SAMIORM",206,0)
 ;
"RTN","SAMIORM",207,0)
 ;@falls-thru-from
"RTN","SAMIORM",208,0)
 ; EN-BLDARR-PMSG
"RTN","SAMIORM",209,0)
 ;@called-by none
"RTN","SAMIORM",210,0)
 ;@calls
"RTN","SAMIORM",211,0)
 ; UPDTPTL^SAMIHL7
"RTN","SAMIORM",212,0)
 ; $$setroot^%wd
"RTN","SAMIORM",213,0)
 ;
"RTN","SAMIORM",214,0)
 do UPDTPTL^SAMIHL7(.fields) ; update patient-lookup w/pat-flds array
"RTN","SAMIORM",215,0)
 ;
"RTN","SAMIORM",216,0)
 merge ^KBAP("SAMIORM","fields")=fields
"RTN","SAMIORM",217,0)
 ;
"RTN","SAMIORM",218,0)
 ;
"RTN","SAMIORM",219,0)
 ;@stanza 6 file hl7 msg in patient-lookup graph
"RTN","SAMIORM",220,0)
 ;
"RTN","SAMIORM",221,0)
 ; At this point the fields have been filed in the patient with ptien
"RTN","SAMIORM",222,0)
 ; into the patient lookup graph. I have the ptien in fields("ptien")
"RTN","SAMIORM",223,0)
 ; and I have the HL7 message segments in samihl7. Time to file the
"RTN","SAMIORM",224,0)
 ; actual hl7 message into patient lookup. 
"RTN","SAMIORM",225,0)
 ; NOTE: @rootpl@(ptien,"hl7 counter") was updated in UPDTPTL^SAMIHL7.
"RTN","SAMIORM",226,0)
 ;
"RTN","SAMIORM",227,0)
 new ptien set ptien=$get(fields("ptien"))
"RTN","SAMIORM",228,0)
 quit:'ptien
"RTN","SAMIORM",229,0)
 ;
"RTN","SAMIORM",230,0)
 new rootpl set rootpl=$$setroot^%wd("patient-lookup")
"RTN","SAMIORM",231,0)
 new hl7cnt set hl7cnt=$get(@rootpl@(ptien,"hl7 counter"))
"RTN","SAMIORM",232,0)
 set fields("ORM",hl7cnt,"msgid")=$get(HLREC("MID"))
"RTN","SAMIORM",233,0)
 ;
"RTN","SAMIORM",234,0)
 new cnt set cnt=0
"RTN","SAMIORM",235,0)
 for  set cnt=$order(samihl7(cnt)) quit:'cnt  do
"RTN","SAMIORM",236,0)
 . new seg set seg=$extract(samihl7(cnt),1,3)
"RTN","SAMIORM",237,0)
 . set @rootpl@(ptien,"hl7",hl7cnt,seg)=samihl7(cnt)
"RTN","SAMIORM",238,0)
 . quit
"RTN","SAMIORM",239,0)
 ;
"RTN","SAMIORM",240,0)
 ;
"RTN","SAMIORM",241,0)
 ;@stanza 7 termination
"RTN","SAMIORM",242,0)
 ;
"RTN","SAMIORM",243,0)
 quit  ; end of hli EN^SAMIORM
"RTN","SAMIORM",244,0)
 ;
"RTN","SAMIORM",245,0)
 ;
"RTN","SAMIORM",246,0)
 ;
"RTN","SAMIORM",247,0)
 ;@section 3 PARSEMSG subroutines
"RTN","SAMIORM",248,0)
 ;
"RTN","SAMIORM",249,0)
 ;
"RTN","SAMIORM",250,0)
 ;
"RTN","SAMIORM",251,0)
PARSEMSG(HLARR,fields) ; get patient data f/ORM msg
"RTN","SAMIORM",252,0)
 ;
"RTN","SAMIORM",253,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIORM",254,0)
 ;
"RTN","SAMIORM",255,0)
 ;;private;procedure;clean;silent;sac
"RTN","SAMIORM",256,0)
 ;@called-by
"RTN","SAMIORM",257,0)
 ; hli EN^SAMIORM
"RTN","SAMIORM",258,0)
 ;@calls
"RTN","SAMIORM",259,0)
 ; PID
"RTN","SAMIORM",260,0)
 ; PV1
"RTN","SAMIORM",261,0)
 ; ORC
"RTN","SAMIORM",262,0)
 ; OBR
"RTN","SAMIORM",263,0)
 ;@input [tbd]
"RTN","SAMIORM",264,0)
 ; .HLARR = hl7 msg array
"RTN","SAMIORM",265,0)
 ; ]INFS = field separator
"RTN","SAMIORM",266,0)
 ; ]INCC = subfield separator
"RTN","SAMIORM",267,0)
 ; ]HL("FS") = field separator
"RTN","SAMIORM",268,0)
 ;@output [tbd]
"RTN","SAMIORM",269,0)
 ; .fields = fields array
"RTN","SAMIORM",270,0)
 ; ^KBAP = debug array
"RTN","SAMIORM",271,0)
 ;
"RTN","SAMIORM",272,0)
 ;
"RTN","SAMIORM",273,0)
 ;@stanza 2 get patient data
"RTN","SAMIORM",274,0)
 ;
"RTN","SAMIORM",275,0)
 set ^KBAP("SAMIORM","PARSEMSG","INFS")=$get(INFS)
"RTN","SAMIORM",276,0)
 set ^KBAP("SAMIORM","PARSEMSG","INCC")=$get(INCC)
"RTN","SAMIORM",277,0)
 ;
"RTN","SAMIORM",278,0)
 ; get patient data from ORM message
"RTN","SAMIORM",279,0)
 new cnt set cnt=0
"RTN","SAMIORM",280,0)
 for  do  quit:'cnt
"RTN","SAMIORM",281,0)
 . set cnt=$order(HLARR(cnt))
"RTN","SAMIORM",282,0)
 . quit:'cnt
"RTN","SAMIORM",283,0)
 . ;
"RTN","SAMIORM",284,0)
 . new segment set segment=HLARR(cnt)
"RTN","SAMIORM",285,0)
 . new SEG set SEG=$piece(HLARR(cnt),HL("FS"))
"RTN","SAMIORM",286,0)
 . if SEG="PID" do PID(segment,.fields)
"RTN","SAMIORM",287,0)
 . if SEG="PV1" do PV1(segment,.fields)
"RTN","SAMIORM",288,0)
 . if SEG="ORC" do ORC(segment,.fields)
"RTN","SAMIORM",289,0)
 . if SEG="OBR" do OBR(segment,.fields)
"RTN","SAMIORM",290,0)
 . quit
"RTN","SAMIORM",291,0)
 ;
"RTN","SAMIORM",292,0)
 merge ^KBAP("SAMIORM","fields")=fields
"RTN","SAMIORM",293,0)
 ;
"RTN","SAMIORM",294,0)
 ;
"RTN","SAMIORM",295,0)
 ;@stanza 3 termination
"RTN","SAMIORM",296,0)
 ;
"RTN","SAMIORM",297,0)
 quit  ; end of PARSEMSG
"RTN","SAMIORM",298,0)
 ;
"RTN","SAMIORM",299,0)
 ;
"RTN","SAMIORM",300,0)
 ;
"RTN","SAMIORM",301,0)
PID(segment,fields) ; get patient data from PID segment
"RTN","SAMIORM",302,0)
 ;
"RTN","SAMIORM",303,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIORM",304,0)
 ;
"RTN","SAMIORM",305,0)
 ;;private;procedure;clean;silent;sac
"RTN","SAMIORM",306,0)
 ;@falls-thru-to
"RTN","SAMIORM",307,0)
 ; ORMADDR
"RTN","SAMIORM",308,0)
 ;@called-by
"RTN","SAMIORM",309,0)
 ; PARSEMSG
"RTN","SAMIORM",310,0)
 ;@calls
"RTN","SAMIORM",311,0)
 ; $$UP^XLFSTR
"RTN","SAMIORM",312,0)
 ;@input
"RTN","SAMIORM",313,0)
 ; .segment = PID segment of hl7 message
"RTN","SAMIORM",314,0)
 ; ]INFS = field separator
"RTN","SAMIORM",315,0)
 ; ]INCC = subfield separator
"RTN","SAMIORM",316,0)
 ;@output
"RTN","SAMIORM",317,0)
 ; .fields = fields array
"RTN","SAMIORM",318,0)
 ; ^KBAP = debug array
"RTN","SAMIORM",319,0)
 ;
"RTN","SAMIORM",320,0)
 ;
"RTN","SAMIORM",321,0)
 ;@stanza 2 get patient id #s
"RTN","SAMIORM",322,0)
 ;
"RTN","SAMIORM",323,0)
 set ^KBAP("SAMIORM","fields","PID","segment")=segment
"RTN","SAMIORM",324,0)
 ;
"RTN","SAMIORM",325,0)
 set fields("icn")="" ; not currently using integration control #
"RTN","SAMIORM",326,0)
 set fields("ssn")=$piece($piece(segment,INFS,4),INCC)
"RTN","SAMIORM",327,0)
 ;
"RTN","SAMIORM",328,0)
 ;
"RTN","SAMIORM",329,0)
 ;@stanza 3 get patient name
"RTN","SAMIORM",330,0)
 ;
"RTN","SAMIORM",331,0)
 new name set name=$$UP^XLFSTR($piece(segment,INFS,6)) ; full upper
"RTN","SAMIORM",332,0)
 new lname set lname=$piece(name,INCC) ; last
"RTN","SAMIORM",333,0)
 new fname set fname=$piece(name,INCC,2) ; first
"RTN","SAMIORM",334,0)
 ;
"RTN","SAMIORM",335,0)
 new mname set mname="" ; middle
"RTN","SAMIORM",336,0)
 if $length(name,INCC)>2 set mname=$piece(name,INCC,3)
"RTN","SAMIORM",337,0)
 ;
"RTN","SAMIORM",338,0)
 new suffix set suffix="" ; suffix, e.g., JR, 3RD, etc.
"RTN","SAMIORM",339,0)
 if $length(name,INCC)>3 set suffix=$piece(name,INCC,4)
"RTN","SAMIORM",340,0)
 ;
"RTN","SAMIORM",341,0)
 if $length(mname) set fname=fname_" "_mname
"RTN","SAMIORM",342,0)
 if $length(suffix) set lname=lname_" "_suffix
"RTN","SAMIORM",343,0)
 set name=lname_","_fname ; replace full
"RTN","SAMIORM",344,0)
 ;
"RTN","SAMIORM",345,0)
 set fields("saminame")=name
"RTN","SAMIORM",346,0)
 set fields("sinamef")=fname
"RTN","SAMIORM",347,0)
 set fields("sinamel")=lname
"RTN","SAMIORM",348,0)
 ;
"RTN","SAMIORM",349,0)
 ;
"RTN","SAMIORM",350,0)
 ;@stanza 4 get other patient demographics
"RTN","SAMIORM",351,0)
 ;
"RTN","SAMIORM",352,0)
 if $length(fields("ssn")),$length(fields("saminame")) do
"RTN","SAMIORM",353,0)
 . set fields("last5")=$extract(fields("saminame"))_$extract(fields("ssn"),6,9)
"RTN","SAMIORM",354,0)
 . set ^KBAP("SAMIORM","MadeLast5")=$get(fields("last5"))
"RTN","SAMIORM",355,0)
 . quit
"RTN","SAMIORM",356,0)
 ;
"RTN","SAMIORM",357,0)
 set fields("sbdob")=$piece(segment,INFS,8)
"RTN","SAMIORM",358,0)
 set fields("sex")=$piece(segment,INFS,9)
"RTN","SAMIORM",359,0)
 ;
"RTN","SAMIORM",360,0)
 ;
"RTN","SAMIORM",361,0)
ORMADDR ;@stanza 5 get address
"RTN","SAMIORM",362,0)
 ;
"RTN","SAMIORM",363,0)
 ;@falls-thru-from
"RTN","SAMIORM",364,0)
 ; PID
"RTN","SAMIORM",365,0)
 ;@called-by none
"RTN","SAMIORM",366,0)
 ;@calls none
"RTN","SAMIORM",367,0)
 ;
"RTN","SAMIORM",368,0)
 set fields("ORM",invdt,"fulladdress")=$piece(segment,INFS,12)
"RTN","SAMIORM",369,0)
 ;
"RTN","SAMIORM",370,0)
 set fields("address1")=$piece($piece(segment,INFS,12),INCC)
"RTN","SAMIORM",371,0)
 set fields("city")=$piece($piece(segment,INFS,12),INCC,3)
"RTN","SAMIORM",372,0)
 set fields("state")=$piece($piece(segment,INFS,12),INCC,4)
"RTN","SAMIORM",373,0)
 set fields("zip")=$piece($piece(segment,INFS,12),INCC,5)
"RTN","SAMIORM",374,0)
 set fields("phone")=$piece(segment,INFS,14)
"RTN","SAMIORM",375,0)
 ; set fields("ssn")=$piece(segment,INFS,20)
"RTN","SAMIORM",376,0)
 ;
"RTN","SAMIORM",377,0)
 ;
"RTN","SAMIORM",378,0)
 ;@stanza 6 termination
"RTN","SAMIORM",379,0)
 ;
"RTN","SAMIORM",380,0)
 quit  ; end of PID-ORMADDR
"RTN","SAMIORM",381,0)
 ;
"RTN","SAMIORM",382,0)
 ;
"RTN","SAMIORM",383,0)
 ;
"RTN","SAMIORM",384,0)
PV1(segment,fields) ; get patient data from PV1 segment
"RTN","SAMIORM",385,0)
 ;
"RTN","SAMIORM",386,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIORM",387,0)
 ;
"RTN","SAMIORM",388,0)
 ;;private;procedure;clean;silent;sac
"RTN","SAMIORM",389,0)
 ;@called-by
"RTN","SAMIORM",390,0)
 ; PARSEMSG
"RTN","SAMIORM",391,0)
 ;@calls none
"RTN","SAMIORM",392,0)
 ;@input [tbd]
"RTN","SAMIORM",393,0)
 ; .segment = PV1 segment of hl7 message
"RTN","SAMIORM",394,0)
 ; ]INFS = field separator
"RTN","SAMIORM",395,0)
 ; ]INCC = subfield separator
"RTN","SAMIORM",396,0)
 ;@output [tbd]
"RTN","SAMIORM",397,0)
 ; .fields = fields array
"RTN","SAMIORM",398,0)
 ; ^KBAP = debug array
"RTN","SAMIORM",399,0)
 ;
"RTN","SAMIORM",400,0)
 ;
"RTN","SAMIORM",401,0)
 ;@stanza 2 get patient data
"RTN","SAMIORM",402,0)
 ;
"RTN","SAMIORM",403,0)
 set ^KBAP("SAMIORM","fields","PIV","segment")=segment
"RTN","SAMIORM",404,0)
 ;
"RTN","SAMIORM",405,0)
 set fields("ORM",invdt,"patientclass")=$piece(segment,INFS,3)
"RTN","SAMIORM",406,0)
 set fields("ORM",invdt,"assignedlocation")=$piece(segment,INFS,4)
"RTN","SAMIORM",407,0)
 set fields("ORM",invdt,"providerien")=$piece($piece(segment,INFS,9),INCC)
"RTN","SAMIORM",408,0)
 set fields("ORM",invdt,"providernm")=$translate($piece($piece(segment,INFS,9),INCC,2,4),"^",",")
"RTN","SAMIORM",409,0)
 ;
"RTN","SAMIORM",410,0)
 ;
"RTN","SAMIORM",411,0)
 ;@stanza 3 termination
"RTN","SAMIORM",412,0)
 ;
"RTN","SAMIORM",413,0)
 quit  ; end of PV1
"RTN","SAMIORM",414,0)
 ;
"RTN","SAMIORM",415,0)
 ;
"RTN","SAMIORM",416,0)
 ;
"RTN","SAMIORM",417,0)
ORC(segment,fields) ; get patient data from ORC segment
"RTN","SAMIORM",418,0)
 ;
"RTN","SAMIORM",419,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIORM",420,0)
 ;
"RTN","SAMIORM",421,0)
 ;;private;procedure;clean;silent;sac
"RTN","SAMIORM",422,0)
 ;@called-by
"RTN","SAMIORM",423,0)
 ; PARSEMSG
"RTN","SAMIORM",424,0)
 ;@calls none
"RTN","SAMIORM",425,0)
 ;@input [tbd]
"RTN","SAMIORM",426,0)
 ; .segment = ORC segment of hl7 message
"RTN","SAMIORM",427,0)
 ; ]INFS = field separator
"RTN","SAMIORM",428,0)
 ;@output [tbd]
"RTN","SAMIORM",429,0)
 ; .fields = fields array
"RTN","SAMIORM",430,0)
 ; ^KBAP = debug array
"RTN","SAMIORM",431,0)
 ;
"RTN","SAMIORM",432,0)
 ;
"RTN","SAMIORM",433,0)
 ;@stanza 2 get patient data
"RTN","SAMIORM",434,0)
 ;
"RTN","SAMIORM",435,0)
 set ^KBAP("SAMIORM","fields","ORC","segment")=segment
"RTN","SAMIORM",436,0)
 ;
"RTN","SAMIORM",437,0)
 set fields("ORM",invdt,"ordercontrol")=$piece(segment,INFS,2)
"RTN","SAMIORM",438,0)
 set fields("ORM",invdt,"ordernumber")=$piece(segment,INFS,3)
"RTN","SAMIORM",439,0)
 set fields("ORM",invdt,"orderstatus")=$piece(segment,INFS,6)
"RTN","SAMIORM",440,0)
 set fields("ORM",invdt,"transactiondt")=$piece(segment,INFS,10)
"RTN","SAMIORM",441,0)
 set fields("ORM",invdt,"ordereffectivedt")=$piece(segment,INFS,16)
"RTN","SAMIORM",442,0)
 ;
"RTN","SAMIORM",443,0)
 ;
"RTN","SAMIORM",444,0)
 ;@stanza 3 termination
"RTN","SAMIORM",445,0)
 ;
"RTN","SAMIORM",446,0)
 quit  ; end of ORC
"RTN","SAMIORM",447,0)
 ;
"RTN","SAMIORM",448,0)
 ;
"RTN","SAMIORM",449,0)
 ;
"RTN","SAMIORM",450,0)
OBR(segment,fields) ; get patient data from OBR segment
"RTN","SAMIORM",451,0)
 ;
"RTN","SAMIORM",452,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIORM",453,0)
 ;
"RTN","SAMIORM",454,0)
 ;;private;procedure;clean;silent;sac
"RTN","SAMIORM",455,0)
 ;@called-by
"RTN","SAMIORM",456,0)
 ; PARSEMSG
"RTN","SAMIORM",457,0)
 ;@calls none
"RTN","SAMIORM",458,0)
 ;@input [tbd]
"RTN","SAMIORM",459,0)
 ; .segment = OBR segment of hl7 message
"RTN","SAMIORM",460,0)
 ; ]INFS = field separator
"RTN","SAMIORM",461,0)
 ; ]INCC = subfield separator
"RTN","SAMIORM",462,0)
 ;@output [tbd]
"RTN","SAMIORM",463,0)
 ; .fields = fields array
"RTN","SAMIORM",464,0)
 ; ^KBAP = debug array
"RTN","SAMIORM",465,0)
 ;
"RTN","SAMIORM",466,0)
 ;
"RTN","SAMIORM",467,0)
 ;@stanza 2 get patient data
"RTN","SAMIORM",468,0)
 ;
"RTN","SAMIORM",469,0)
 set ^KBAP("SAMIORM","fields","OBR","segment")=segment
"RTN","SAMIORM",470,0)
 ;
"RTN","SAMIORM",471,0)
 set fields("ORM",invdt,"order")=$piece($piece(segment,INFS,5),INCC)
"RTN","SAMIORM",472,0)
 ;
"RTN","SAMIORM",473,0)
 set fields("ORM",invdt,"siteid")=$piece($piece($piece(segment,INFS,5),INCC),"_")
"RTN","SAMIORM",474,0)
 set fields("siteid")=$piece($piece($piece(segment,INFS,5),INCC),"_")
"RTN","SAMIORM",475,0)
 ;
"RTN","SAMIORM",476,0)
 set fields("ORM",invdt,"order2")=$piece($piece(segment,INFS,5),INCC,2)
"RTN","SAMIORM",477,0)
 ;
"RTN","SAMIORM",478,0)
 ;
"RTN","SAMIORM",479,0)
 ;@stanza 3 termination
"RTN","SAMIORM",480,0)
 ;
"RTN","SAMIORM",481,0)
 quit  ; end of OBR
"RTN","SAMIORM",482,0)
 ;
"RTN","SAMIORM",483,0)
 ;
"RTN","SAMIORM",484,0)
 ;
"RTN","SAMIORM",485,0)
CAMELCAS(str) ; convert string to camel case
"RTN","SAMIORM",486,0)
 ;
"RTN","SAMIORM",487,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIORM",488,0)
 ;
"RTN","SAMIORM",489,0)
 ;;private;function;clean;silent;sac
"RTN","SAMIORM",490,0)
 ;@called-by
"RTN","SAMIORM",491,0)
 ; PID
"RTN","SAMIORM",492,0)
 ;@calls
"RTN","SAMIORM",493,0)
 ; $$LOW^XLFSTR
"RTN","SAMIORM",494,0)
 ; $$UP^XLFSTR
"RTN","SAMIORM",495,0)
 ;@input [tbd]
"RTN","SAMIORM",496,0)
 ; str = string to convert
"RTN","SAMIORM",497,0)
 ;@output = string in camel case
"RTN","SAMIORM",498,0)
 ;
"RTN","SAMIORM",499,0)
 ;
"RTN","SAMIORM",500,0)
 ;@stanza 2 convert string
"RTN","SAMIORM",501,0)
 ;
"RTN","SAMIORM",502,0)
 if $get(str)="" quit str
"RTN","SAMIORM",503,0)
 set str=$$LOW^XLFSTR(str)
"RTN","SAMIORM",504,0)
 set str=$$UP^XLFSTR($extract(str,1))_$extract(str,2,$length(str))
"RTN","SAMIORM",505,0)
 ;
"RTN","SAMIORM",506,0)
 ;
"RTN","SAMIORM",507,0)
 ;@stanza 3 termination
"RTN","SAMIORM",508,0)
 ;
"RTN","SAMIORM",509,0)
 quit str ; end of $$CAMELCAS
"RTN","SAMIORM",510,0)
 ;
"RTN","SAMIORM",511,0)
 ;
"RTN","SAMIORM",512,0)
 ;
"RTN","SAMIORM",513,0)
 ;@section 4 test subroutine
"RTN","SAMIORM",514,0)
 ;
"RTN","SAMIORM",515,0)
 ;
"RTN","SAMIORM",516,0)
 ;
"RTN","SAMIORM",517,0)
TEST ; test hli EN^SAMIORM
"RTN","SAMIORM",518,0)
 ;
"RTN","SAMIORM",519,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIORM",520,0)
 ;
"RTN","SAMIORM",521,0)
 ;;dmi-test;procedure;clean;silent;sac
"RTN","SAMIORM",522,0)
 ;@called-by
"RTN","SAMIORM",523,0)
 ; PID
"RTN","SAMIORM",524,0)
 ;@calls
"RTN","SAMIORM",525,0)
 ; $$LOW^XLFSTR
"RTN","SAMIORM",526,0)
 ; $$UP^XLFSTR
"RTN","SAMIORM",527,0)
 ;@input [tbd]
"RTN","SAMIORM",528,0)
 ; str = string to convert
"RTN","SAMIORM",529,0)
 ;@output = string in camel case
"RTN","SAMIORM",530,0)
 ;
"RTN","SAMIORM",531,0)
 ;
"RTN","SAMIORM",532,0)
 ;@stanza 2 convert string
"RTN","SAMIORM",533,0)
 ;
"RTN","SAMIORM",534,0)
 kill HLARR ; hl7 test orm msg
"RTN","SAMIORM",535,0)
 set HLARR(1)="MSH|^~\&|MCAR-INST|VISTA|INST-MCAR|VAPALS|20200616135751-0700||ORM^O01|6442288610689|P|2.3|||||USA"
"RTN","SAMIORM",536,0)
 set HLARR(2)="PID|1||000002341||ZZTEST^MACHO^^^^^L||19271106000000|M|||7726 W ORCHID ST^^PHOENIX^AZ^85017||||||||000002341|"
"RTN","SAMIORM",537,0)
 set HLARR(3)="PV1||O|PHX-PULM RN LSS PHONE|||||244088^GARCIA^DANIEL^P"
"RTN","SAMIORM",538,0)
 set HLARR(4)="ORC|NW|3200616135751|||NW||||20200616135751||||||20200616135751"
"RTN","SAMIORM",539,0)
 set HLARR(5)="OBR||||PHO_LUNG^LUNG|"
"RTN","SAMIORM",540,0)
 ;
"RTN","SAMIORM",541,0)
 do HLENV^SAMIORU("MCAR ORM SERVER") ; set hl7 variables for testing
"RTN","SAMIORM",542,0)
 ;
"RTN","SAMIORM",543,0)
 set HLNEXT="D HLNEXT^HLCSUTL" ; get-next-line qwik
"RTN","SAMIORM",544,0)
 set HLQUIT=0 ; curent ien of "IN" wp field in msg array in file 771
"RTN","SAMIORM",545,0)
 ;
"RTN","SAMIORM",546,0)
 do EN ; parse ORM msg > patient-lookup graph
"RTN","SAMIORM",547,0)
 ;
"RTN","SAMIORM",548,0)
 ;
"RTN","SAMIORM",549,0)
 ;@stanza 3 termination
"RTN","SAMIORM",550,0)
 ;
"RTN","SAMIORM",551,0)
 quit  ; end of TEST
"RTN","SAMIORM",552,0)
 ;
"RTN","SAMIORM",553,0)
 ;
"RTN","SAMIORM",554,0)
 ;
"RTN","SAMIORM",555,0)
EOR ; end of routine SAMIORM
"RTN","SAMIOUL")
0^15^B103895
"RTN","SAMIOUL",1,0)
SAMIOUL ;ven/toad - HL7 development log ;2021-06-08t19:27z
"RTN","SAMIOUL",2,0)
 ;;18.0;SAMI;**12**;2020-01;Build 6
"RTN","SAMIOUL",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIOUL",4,0)
 ;
"RTN","SAMIOUL",5,0)
 ; SAMIOUL is the development log for the SAMIHL7 & SAMIOR* routines,
"RTN","SAMIOUL",6,0)
 ; which support VAPALS-ELCAP HL7 processing.
"RTN","SAMIOUL",7,0)
 ;
"RTN","SAMIOUL",8,0)
 quit  ; no entry from top
"RTN","SAMIOUL",9,0)
 ;
"RTN","SAMIOUL",10,0)
 ;
"RTN","SAMIOUL",11,0)
 ;
"RTN","SAMIOUL",12,0)
 ;@section 0 primary development
"RTN","SAMIOUL",13,0)
 ;
"RTN","SAMIOUL",14,0)
 ;
"RTN","SAMIOUL",15,0)
 ;
"RTN","SAMIOUL",16,0)
 ;@routine-credits
"RTN","SAMIOUL",17,0)
 ;@primary-dev Larry G. Carlson (lgc)
"RTN","SAMIOUL",18,0)
 ; lgc@vistaexpertise.net
"RTN","SAMIOUL",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIOUL",20,0)
 ; http://vistaexpertise.net
"RTN","SAMIOUL",21,0)
 ;@copyright 2017/2021, lgc, all rights reserved
"RTN","SAMIOUL",22,0)
 ;@license see routine SAMIUL
"RTN","SAMIOUL",23,0)
 ;
"RTN","SAMIOUL",24,0)
 ;@last-updated 2021-06-08t19:27z
"RTN","SAMIOUL",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIOUL",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIOUL",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIOUL",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIOUL",29,0)
 ;@release-date 2020-01
"RTN","SAMIOUL",30,0)
 ;@patch-list **12**
"RTN","SAMIOUL",31,0)
 ;
"RTN","SAMIOUL",32,0)
 ;@additional-dev Alexis R. Carlson (arc)
"RTN","SAMIOUL",33,0)
 ; arc@vistaexpertise.net
"RTN","SAMIOUL",34,0)
 ;@additional-dev George P. Lilly (gpl)
"RTN","SAMIOUL",35,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIOUL",36,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIOUL",37,0)
 ; toad@vistaexpertise.net
"RTN","SAMIOUL",38,0)
 ;@additional-dev Kenneth McGlothlen (mcglk)
"RTN","SAMIOUL",39,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIOUL",40,0)
 ;
"RTN","SAMIOUL",41,0)
 ;@module-credits
"RTN","SAMIOUL",42,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMIOUL",43,0)
 ; (VA-PALS)
"RTN","SAMIOUL",44,0)
 ; http://va-pals.org/
"RTN","SAMIOUL",45,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMIOUL",46,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMIOUL",47,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMIOUL",48,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMIOUL",49,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMIOUL",50,0)
 ; http://ielcap.com/
"RTN","SAMIOUL",51,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMIOUL",52,0)
 ; http://paraxialtech.com/
"RTN","SAMIOUL",53,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMIOUL",54,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMIOUL",55,0)
 ;
"RTN","SAMIOUL",56,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIOUL",57,0)
 ;
"RTN","SAMIOUL",58,0)
 ; 2019-10-03/28 ven/lgc 1.18.0 d01fd10,ff6cea0,3670fb3,613e8ff
"RTN","SAMIOUL",59,0)
 ; ,82979cc
"RTN","SAMIOUL",60,0)
 ;  SAMIHL7: HL7 routines to populate & update patient-lookup graph,
"RTN","SAMIOUL",61,0)
 ; reorganize HL7 routines & work on unit tests, change how gender is
"RTN","SAMIOUL",62,0)
 ; handled, update unit test routines for dfn 1, further updates to
"RTN","SAMIOUL",63,0)
 ; SAMI unit tests.
"RTN","SAMIOUL",64,0)
 ;
"RTN","SAMIOUL",65,0)
 ; 2020-01-15 ven/lgc 1.18.0 0a2af96
"RTN","SAMIOUL",66,0)
 ;  SAMIHL7: bulk commit due to switch to cache, major overhaul:
"RTN","SAMIOUL",67,0)
 ; update capture of array structure; in UPDTPTL add UPDTPTL1,MATCHLOG
"RTN","SAMIOUL",68,0)
 ; & update indices; r/root w/rootpl; annotate; cut DELPTL & 2 lines,
"RTN","SAMIOUL",69,0)
 ; leaving rest of subroutine orphaned.
"RTN","SAMIOUL",70,0)
 ;
"RTN","SAMIOUL",71,0)
 ; 2020-01-16 ven/lgc 1.18.0 [no repo commit]
"RTN","SAMIOUL",72,0)
 ;  SAMIHL7: in MATCHLOG unbreak line MATCHLOG+13.
"RTN","SAMIOUL",73,0)
 ;
"RTN","SAMIOUL",74,0)
 ; 2020-02-04/12 ven/lgc 1.18.0.11+i11 ee53d8a
"RTN","SAMIOUL",75,0)
 ;  SAMIORM,SAMIORR ORM HL7 routines.
"RTN","SAMIOUL",76,0)
 ;
"RTN","SAMIOUL",77,0)
 ; 2020-07-24/28 ven/lgc 1.18.0.8/11+i8/i11 c08b051
"RTN","SAMIOUL",78,0)
 ;  SAMIHL7,SAMIORM,SAMIORU: update for ORU messaging.
"RTN","SAMIOUL",79,0)
 ;  SAMIHL7: in top update incoming fields array example; passim
"RTN","SAMIOUL",80,0)
 ; checkpoint into ^KBAP; in UPDTPTL1 add block to if new patient get
"RTN","SAMIOUL",81,0)
 ; next ptien to use & set dfn; in MATCHLOG r/MATCHLOG w/HL7MATCHLOG,
"RTN","SAMIOUL",82,0)
 ; if new patient load ORM msg data later, fix undef error, as didn't
"RTN","SAMIOUL",83,0)
 ; get dfn from va vista server (only ssn) do not try to set remotedfn
"RTN","SAMIOUL",84,0)
 ; field, build saminame index, call CAPTORM to save all ORM flds in
"RTN","SAMIOUL",85,0)
 ; patient-lookup; add CAPTORM; in ACK clear & set HLA("HLA").
"RTN","SAMIOUL",86,0)
 ;  SAMIORM: passim annotate, checkpoint into ^KBAP; in BLDAR get
"RTN","SAMIOUL",87,0)
 ; inverse date, put HL7 nodes in samihl7; in DEBUG save msg id; add
"RTN","SAMIOUL",88,0)
 ; PMSG; in PARSEMSG call PV1,ORC; in PID r/dfn w/ssn, get name flds,
"RTN","SAMIOUL",89,0)
 ; get last5; add tag ORMADDR; add PV1,ORC to handle those segments;
"RTN","SAMIOUL",90,0)
 ; in OBR reorg fields array; add CAMELCAS; update TEST.
"RTN","SAMIOUL",91,0)
 ;  SAMIORU: new routine?
"RTN","SAMIOUL",92,0)
 ;
"RTN","SAMIOUL",93,0)
 ; 2020-08-17/09-04 ven/lgc 1.18.0.11+i11 f3d7b38
"RTN","SAMIOUL",94,0)
 ;  SAMIORU: update to remove gtm mod: extensive chgs passim, incl add
"RTN","SAMIOUL",95,0)
 ; TESTALL,TESTOBXC; TESTOBX > TESTOBXV; PID2 > PID1; in DFN pull data
"RTN","SAMIOUL",96,0)
 ; from entry in patient-lookup graph; in HL7VARS if msg id returned,
"RTN","SAMIOUL",97,0)
 ; preface it with 1^; in ORMVARS don't confuse ORM msg id w/ORU msg
"RTN","SAMIOUL",98,0)
 ; id; etc.
"RTN","SAMIOUL",99,0)
 ;
"RTN","SAMIOUL",100,0)
 ; 2021-02-03 ven/gpl 1.18.0.8+i8 54a0c2e
"RTN","SAMIOUL",101,0)
 ;  SAMIORU: in EN chg line length limit (climit) to 81.
"RTN","SAMIOUL",102,0)
 ;
"RTN","SAMIOUL",103,0)
 ; 2021-03-12/13 ven/lgc 1.18.0.8+i8 6093b45
"RTN","SAMIOUL",104,0)
 ;  SAMIORU: larry's latest version of hl7 message building to
"RTN","SAMIOUL",105,0)
 ; preserve note formatting: in TESTALL cut dead code, chg patient &
"RTN","SAMIOUL",106,0)
 ; form, call EN&SAMIORU as function; in EN add debug code, cut climit
"RTN","SAMIOUL",107,0)
 ; lines & cache filter; in DFN add tag FINDORM; in OBX cut climit
"RTN","SAMIOUL",108,0)
 ; lines & dead code & BLDTXT.
"RTN","SAMIOUL",109,0)
 ;
"RTN","SAMIOUL",110,0)
 ; 2021-04-14/20 ven/gpl 1.18.0.11+i11 3a5756a,d7182d7
"RTN","SAMIOUL",111,0)
 ;  SAMIHL7: fix for duplicate patients fr/HL7, fix for updating 
"RTN","SAMIOUL",112,0)
 ; patient-lookup graph on receipt of 2nd order: in UPDTPTL1 uppercase
"RTN","SAMIOUL",113,0)
 ; names; in MATCHLOG prevent undef error.
"RTN","SAMIOUL",114,0)
 ;
"RTN","SAMIOUL",115,0)
 ; 2021-05-11 ven/lgc 1.18.0.11+i11 [no repo commit]
"RTN","SAMIOUL",116,0)
 ;  SAMIORM: in UPDTPTL stop updating hl7 counter node, because it was
"RTN","SAMIOUL",117,0)
 ; updated earlier, just set hl7cnt; in OBR set fields("siteid").
"RTN","SAMIOUL",118,0)
 ;
"RTN","SAMIOUL",119,0)
 ; 2021-05-20/21 ven/mcglk&toad 1.18.0.11+i11 43a4557,70fc6ba,129e96b
"RTN","SAMIOUL",120,0)
 ;  SAMIHL7: passim build hdr comments & dev log, lt refactor, bump
"RTN","SAMIOUL",121,0)
 ; version.
"RTN","SAMIOUL",122,0)
 ;
"RTN","SAMIOUL",123,0)
 ; 2021-05-27 ven/lgc 1.18.0.11+i11 2093bf0,a51e714
"RTN","SAMIOUL",124,0)
 ;  SAMIHL7,SAMIORM: new fixes for saving ORM & HL7 in patient-lookup
"RTN","SAMIOUL",125,0)
 ;  SAMIHL7: in section 1 update sample array; in MATCHLOG
"RTN","SAMIOUL",126,0)
 ; r/fields(field)'="" w/'(field=""); in CAPTORM annotate, r/invdt
"RTN","SAMIOUL",127,0)
 ; algo w/hl7cnt algo to align array structures of SAMIHL7 & SAMIORM,
"RTN","SAMIOUL",128,0)
 ; to use counters for subscripts instead of inverse dates.
"RTN","SAMIOUL",129,0)
 ;  SAMIORM: in BLDARR, new hl7cnt, cut tag DEBUG, move inits of INFS,
"RTN","SAMIOUL",130,0)
 ; INCC up to where DEBUG tag was; in PMSG fix KBaP typo, annotate,
"RTN","SAMIOUL",131,0)
 ; refactor block, get msgid; in PID get suffix.
"RTN","SAMIOUL",132,0)
 ;
"RTN","SAMIOUL",133,0)
 ; 2021-06-01/04 ven/mcglk&toad 1.18.0.11+i11 7dd9410c
"RTN","SAMIOUL",134,0)
 ;  SAMIHL7: update log, add SAMIORM,ORR,ORU to log.
"RTN","SAMIOUL",135,0)
 ;  SAMIORM,ORR,ORU: annotate, document hl7 call structure, refactor,
"RTN","SAMIOUL",136,0)
 ; bump version & dates.
"RTN","SAMIOUL",137,0)
 ;
"RTN","SAMIOUL",138,0)
 ; 2021-06-08 ven/toad 1.18.0.12-t1+i12 91baf32e,ba8c9192
"RTN","SAMIOUL",139,0)
 ;  SAMIORM: in BLDARR fix new cnt, bug introduced in 06-04 refactor,
"RTN","SAMIOUL",140,0)
 ; bump version; in PID uppercase patient name; cut CAMELCAS.
"RTN","SAMIOUL",141,0)
 ;  SAMIOUL < SAMIHL7: create routine from existing dev log.
"RTN","SAMIOUL",142,0)
 ;
"RTN","SAMIOUL",143,0)
 ;
"RTN","SAMIOUL",144,0)
 ;
"RTN","SAMIOUL",145,0)
 ;@contents
"RTN","SAMIOUL",146,0)
 ; SAMIHL7 HL7 utilities
"RTN","SAMIOUL",147,0)
 ; SAMIORM HL7 ORM > patient-lookup
"RTN","SAMIOUL",148,0)
 ; SAMIORR HL7 ORR enrollment response
"RTN","SAMIOUL",149,0)
 ; SAMIORU HL7 ORU enrollment response
"RTN","SAMIOUL",150,0)
 ; SAMIOUL HL7 development log
"RTN","SAMIOUL",151,0)
 ;
"RTN","SAMIOUL",152,0)
 ;
"RTN","SAMIOUL",153,0)
 ;
"RTN","SAMIOUL",154,0)
EOR ; end of routine SAMIOUL
"RTN","SAMIPARM")
0^16^B7351392
"RTN","SAMIPARM",1,0)
SAMIPARM ;ven/gpl - get params web service ;2021-07-01t17:45z
"RTN","SAMIPARM",2,0)
 ;;18.0;SAMI;**12**;2020-01;Build 6
"RTN","SAMIPARM",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIPARM",4,0)
 ;
"RTN","SAMIPARM",5,0)
 ; Routine SAMIPARM contains subroutines for implementing the VAPALS-
"RTN","SAMIPARM",6,0)
 ; ELCAP get params web service.
"RTN","SAMIPARM",7,0)
 ;
"RTN","SAMIPARM",8,0)
 quit  ; no entry from top
"RTN","SAMIPARM",9,0)
 ;
"RTN","SAMIPARM",10,0)
 ;
"RTN","SAMIPARM",11,0)
 ;
"RTN","SAMIPARM",12,0)
 ;@section 0 primary development
"RTN","SAMIPARM",13,0)
 ;
"RTN","SAMIPARM",14,0)
 ;
"RTN","SAMIPARM",15,0)
 ;
"RTN","SAMIPARM",16,0)
 ;@routine-credits
"RTN","SAMIPARM",17,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMIPARM",18,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIPARM",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIPARM",20,0)
 ; http://vistaexpertise.net
"RTN","SAMIPARM",21,0)
 ;@copyright 2021, gpl, all rights reserved
"RTN","SAMIPARM",22,0)
 ;@license see routine SAMIUL
"RTN","SAMIPARM",23,0)
 ;
"RTN","SAMIPARM",24,0)
 ;@last-updated 2021-07-01t17:45z
"RTN","SAMIPARM",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIPARM",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIPARM",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIPARM",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIPARM",29,0)
 ;@release-date 2020-01
"RTN","SAMIPARM",30,0)
 ;@patch-list **12**
"RTN","SAMIPARM",31,0)
 ;
"RTN","SAMIPARM",32,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIPARM",33,0)
 ; toad@vistaexpertise.net
"RTN","SAMIPARM",34,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMIPARM",35,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIPARM",36,0)
 ;
"RTN","SAMIPARM",37,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIPARM",38,0)
 ; 2021-05-29/06-05 ven/gpl 1.18.0.12-t2+i12 46bab765,223b5900
"RTN","SAMIPARM",39,0)
 ;  SAMIPARM new routine to implement new web service get params,
"RTN","SAMIPARM",40,0)
 ; update for ssn in report, also, matching report; upgrade PARM with
"RTN","SAMIPARM",41,0)
 ; SYS overrides, add systemDemoOnly & systemDemoUseDUZ.
"RTN","SAMIPARM",42,0)
 ;
"RTN","SAMIPARM",43,0)
 ; 2021-07-01 ven/mcglk&toad 1.18.0.12-t2+i12 cbf7e46b
"RTN","SAMIPARM",44,0)
 ;  SAMIPARM bump version & dates, add hdr comments & dev log.
"RTN","SAMIPARM",45,0)
 ;
"RTN","SAMIPARM",46,0)
 ;@contents
"RTN","SAMIPARM",47,0)
 ; WSPARAMS web service WSPARAMS^SAMIPARM, site paramters
"RTN","SAMIPARM",48,0)
 ; $$GET1PARM value of one parameter for site
"RTN","SAMIPARM",49,0)
 ; GETARY return parameter array
"RTN","SAMIPARM",50,0)
 ; ADDSVC init to install get params web service
"RTN","SAMIPARM",51,0)
 ;
"RTN","SAMIPARM",52,0)
 ;
"RTN","SAMIPARM",53,0)
 ;
"RTN","SAMIPARM",54,0)
 ;@section 1 subroutines
"RTN","SAMIPARM",55,0)
 ;
"RTN","SAMIPARM",56,0)
 ;
"RTN","SAMIPARM",57,0)
 ;
"RTN","SAMIPARM",58,0)
WSPARAMS(parmsjson,filter) ; web service that returns the paramters to use
"RTN","SAMIPARM",59,0)
 ; for the site, passed in as fliter("site"), as json
"RTN","SAMIPARM",60,0)
 d  ;
"RTN","SAMIPARM",61,0)
 . n site
"RTN","SAMIPARM",62,0)
 . s site=$g(filter("site"))
"RTN","SAMIPARM",63,0)
 . i site="" s site=$g(filter("siteid"))
"RTN","SAMIPARM",64,0)
 . q:site=""
"RTN","SAMIPARM",65,0)
 . n parms
"RTN","SAMIPARM",66,0)
 . d GETARY(.parms,site)
"RTN","SAMIPARM",67,0)
 . ;s parms("socialSecurityNumber")="Patient ID"
"RTN","SAMIPARM",68,0)
 . ;s parms("socialSecurityNumber.short")="PID"
"RTN","SAMIPARM",69,0)
 . ;s parms("socialSecurityNumber.mask")=""
"RTN","SAMIPARM",70,0)
 . ;s parms("socialSecurityNumber.regex")=""
"RTN","SAMIPARM",71,0)
 . ; and so on
"RTN","SAMIPARM",72,0)
 . ;n parmsjson
"RTN","SAMIPARM",73,0)
 . d ENCODE^%webjson("parms","parmsjson")
"RTN","SAMIPARM",74,0)
 . set HTTPRSP("mime")="application/json"
"RTN","SAMIPARM",75,0)
 q
"RTN","SAMIPARM",76,0)
 ;
"RTN","SAMIPARM",77,0)
 ;
"RTN","SAMIPARM",78,0)
 ;
"RTN","SAMIPARM",79,0)
GET1PARM(PARM,SITE) ; extrinsic returns the vale of PARM for site SITE
"RTN","SAMIPARM",80,0)
 ; both passed by value
"RTN","SAMIPARM",81,0)
 i '$d(SITE) S SITE=""
"RTN","SAMIPARM",82,0)
 n ary
"RTN","SAMIPARM",83,0)
 d GETARY(.ary,SITE)
"RTN","SAMIPARM",84,0)
 ;ZWR ary
"RTN","SAMIPARM",85,0)
 Q:'$D(ary) ""
"RTN","SAMIPARM",86,0)
 q $g(ary(PARM))
"RTN","SAMIPARM",87,0)
 ;
"RTN","SAMIPARM",88,0)
 ;
"RTN","SAMIPARM",89,0)
 ;
"RTN","SAMIPARM",90,0)
GETARY(ARY,SITE) ; return the parameter array ART, passed by reference
"RTN","SAMIPARM",91,0)
 ;
"RTN","SAMIPARM",92,0)
 N SITEIEN S SITEIEN=""
"RTN","SAMIPARM",93,0)
 I SITE'="" S SITEIEN=$O(^SAMI(311.12,"SYM",SITE,""))
"RTN","SAMIPARM",94,0)
 N DEFREC ; default record in SAMI PARAMETER DEFAULT 311.14
"RTN","SAMIPARM",95,0)
 I SITEIEN'="" S DEFREC=$$GET1^DIQ(311.12,SITEIEN_",",.04,"E")
"RTN","SAMIPARM",96,0)
 I $G(DEFREC)="" S DEFREC="VHA"
"RTN","SAMIPARM",97,0)
 M ARY=^SAMI(311.14,"D",DEFREC)
"RTN","SAMIPARM",98,0)
 I SITE'="" M ARY=^SAMI(311.12,"D",SITE)
"RTN","SAMIPARM",99,0)
 Q:'$D(^SAMI(311.14,"D","SYS"))
"RTN","SAMIPARM",100,0)
 M ARY=^SAMI(311.14,"D","SYS")
"RTN","SAMIPARM",101,0)
 Q
"RTN","SAMIPARM",102,0)
 ;
"RTN","SAMIPARM",103,0)
 ;
"RTN","SAMIPARM",104,0)
 ;
"RTN","SAMIPARM",105,0)
ADDSVC() ; add the params webservice to the system
"RTN","SAMIPARM",106,0)
 d addService^%webutils("GET","params","WSPARAMS^SAMIPARM")
"RTN","SAMIPARM",107,0)
 Q
"RTN","SAMIPARM",108,0)
 ;
"RTN","SAMIPARM",109,0)
 ;
"RTN","SAMIPARM",110,0)
 ;
"RTN","SAMIPARM",111,0)
EOR ; end of routine SAMIPARM
"RTN","SAMIPAT")
0^17^B576661
"RTN","SAMIPAT",1,0)
SAMIPAT ;ven/gpl - init subroutines ;2021-07-01t21:13z
"RTN","SAMIPAT",2,0)
 ;;18.0;SAMI;**12**;2020-01;Build 6
"RTN","SAMIPAT",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIPAT",4,0)
 ;
"RTN","SAMIPAT",5,0)
 ; Routine SAMIPAT contains VAPALS-ELCAP initialization subroutines
"RTN","SAMIPAT",6,0)
 ; to use as KIDS pre- & post-installs & environment checks.
"RTN","SAMIPAT",7,0)
 ;
"RTN","SAMIPAT",8,0)
 quit  ; no entry from top
"RTN","SAMIPAT",9,0)
 ;
"RTN","SAMIPAT",10,0)
 ;
"RTN","SAMIPAT",11,0)
 ;
"RTN","SAMIPAT",12,0)
 ;@section 0 primary development
"RTN","SAMIPAT",13,0)
 ;
"RTN","SAMIPAT",14,0)
 ;
"RTN","SAMIPAT",15,0)
 ;
"RTN","SAMIPAT",16,0)
 ;@routine-credits
"RTN","SAMIPAT",17,0)
 ;@primary-dev Frederick D. S. Marshall (toad)
"RTN","SAMIPAT",18,0)
 ; toad@vistaexpertise.net
"RTN","SAMIPAT",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIPAT",20,0)
 ; http://vistaexpertise.net
"RTN","SAMIPAT",21,0)
 ;@copyright 2021, toad, all rights reserved
"RTN","SAMIPAT",22,0)
 ;@license see routine SAMIUL
"RTN","SAMIPAT",23,0)
 ;
"RTN","SAMIPAT",24,0)
 ;@last-updated 2021-07-01t21:13z
"RTN","SAMIPAT",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIPAT",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIPAT",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIPAT",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIPAT",29,0)
 ;@release-date 2020-01
"RTN","SAMIPAT",30,0)
 ;@patch-list **12**
"RTN","SAMIPAT",31,0)
 ;
"RTN","SAMIPAT",32,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMIPAT",33,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIPAT",34,0)
 ;@additional-dev George P. Lilly (gpl)
"RTN","SAMIPAT",35,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIPAT",36,0)
 ;
"RTN","SAMIPAT",37,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIPAT",38,0)
 ; 2021-07-01 ven/mcglk&toad 1.18.0.12-t2+i12 cbf7e46b
"RTN","SAMIPAT",39,0)
 ;  SAMIPAT new routine, new POS1812 post-install for patch 12.
"RTN","SAMIPAT",40,0)
 ;
"RTN","SAMIPAT",41,0)
 ;@contents
"RTN","SAMIPAT",42,0)
 ; POS1812 kids post-install for sami 1.18.0.12-t2+i12
"RTN","SAMIPAT",43,0)
 ;
"RTN","SAMIPAT",44,0)
 ;
"RTN","SAMIPAT",45,0)
 ;
"RTN","SAMIPAT",46,0)
 ;@section 1 subroutines
"RTN","SAMIPAT",47,0)
 ;
"RTN","SAMIPAT",48,0)
 ;
"RTN","SAMIPAT",49,0)
 ;
"RTN","SAMIPAT",50,0)
POS1812 ; kids post-install for sami 1.18.0.12-t2+i12
"RTN","SAMIPAT",51,0)
 ;
"RTN","SAMIPAT",52,0)
 do ADDSVC^SAMIPARM ; install get params web service
"RTN","SAMIPAT",53,0)
 ;
"RTN","SAMIPAT",54,0)
 ; in honor of Tchaikovsky's overture: boom
"RTN","SAMIPAT",55,0)
 ;
"RTN","SAMIPAT",56,0)
 quit  ; end of POS1812
"RTN","SAMIPAT",57,0)
 ;
"RTN","SAMIPAT",58,0)
 ;
"RTN","SAMIPAT",59,0)
 ;
"RTN","SAMIPAT",60,0)
EOR ; end of routine SAMIPAT
"RTN","SAMISITE")
0^18^B91065013
"RTN","SAMISITE",1,0)
SAMISITE ;ven/gpl&arc - signon & site access ;2021-07-07t16:52z
"RTN","SAMISITE",2,0)
 ;;18.0;SAMI;**5,12**;2020-01;Build 6
"RTN","SAMISITE",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMISITE",4,0)
 ;
"RTN","SAMISITE",5,0)
 ; Routine SAMISITE contains subroutines for implementing the VAPALS-
"RTN","SAMISITE",6,0)
 ; ELCAP 
"RTN","SAMISITE",7,0)
 ;
"RTN","SAMISITE",8,0)
 quit  ; no entry from top
"RTN","SAMISITE",9,0)
 ;
"RTN","SAMISITE",10,0)
 ;
"RTN","SAMISITE",11,0)
 ;
"RTN","SAMISITE",12,0)
 ;@section 0 primary development
"RTN","SAMISITE",13,0)
 ;
"RTN","SAMISITE",14,0)
 ;
"RTN","SAMISITE",15,0)
 ;
"RTN","SAMISITE",16,0)
 ;@routine-credits
"RTN","SAMISITE",17,0)
 ;@primary-dev: George P. Lilly (gpl)
"RTN","SAMISITE",18,0)
 ; gpl@vistaexpertise.net
"RTN","SAMISITE",19,0)
 ;@primary-dev-org: Vista Expertise Network (ven)
"RTN","SAMISITE",20,0)
 ; http://vistaexpertise.net
"RTN","SAMISITE",21,0)
 ;@copyright: 2017/2021, gpl, all rights reserved
"RTN","SAMISITE",22,0)
 ;@license see routine SAMIUL
"RTN","SAMISITE",23,0)
 ;
"RTN","SAMISITE",24,0)
 ;@last-updated 2021-07-07t16:52z
"RTN","SAMISITE",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMISITE",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMISITE",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMISITE",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMISITE",29,0)
 ;@release-date 2020-01
"RTN","SAMISITE",30,0)
 ;@patch-list **5,12**
"RTN","SAMISITE",31,0)
 ;
"RTN","SAMISITE",32,0)
 ;@additional-dev: Alexis Carlson (arc)
"RTN","SAMISITE",33,0)
 ; alexis@vistaexpertise.net
"RTN","SAMISITE",34,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMISITE",35,0)
 ; toad@vistaexpertise.net
"RTN","SAMISITE",36,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMISITE",37,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMISITE",38,0)
 ;
"RTN","SAMISITE",39,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMISITE",40,0)
 ; 2020-04-02/05-26 ven/gpl 1.18.0.5+i5 d36b7cad,36607664,521e0bdc,
"RTN","SAMISITE",41,0)
 ; d018f52e,156be19e,476b2ff4,0a1538ef
"RTN","SAMISITE",42,0)
 ;  SAMISITE add multitenancy, fix bug in logout, fix sitetitle on 1st
"RTN","SAMISITE",43,0)
 ; time in, add superuser site selection feature, fix bug in cache.
"RTN","SAMISITE",44,0)
 ;
"RTN","SAMISITE",45,0)
 ; 2021-06-05 ven/gpl 1.18.0.12-t2+i12 223b5900
"RTN","SAMISITE",46,0)
 ;  SAMISITE upgrade parameter with system overrides, add
"RTN","SAMISITE",47,0)
 ; systemDemoOnly & systemDemoUseDUZ parameters.
"RTN","SAMISITE",48,0)
 ;
"RTN","SAMISITE",49,0)
 ; 2021-07-01/07 ven/mcglk&toad&gpl 1.18.0.12-t2+i12 cbf7e46b,
"RTN","SAMISITE",50,0)
 ; bfeea24b,1dd91fea
"RTN","SAMISITE",51,0)
 ;  SAMISITE bump version & dates, add hdr comments & dev log; in
"RTN","SAMISITE",52,0)
 ; FINDSITE add missing 0 to quit.
"RTN","SAMISITE",53,0)
 ;
"RTN","SAMISITE",54,0)
 ;@to-do
"RTN","SAMISITE",55,0)
 ; Add label comments
"RTN","SAMISITE",56,0)
 ;
"RTN","SAMISITE",57,0)
 ;@contents
"RTN","SAMISITE",58,0)
 ; $$FINDSITE current site for user
"RTN","SAMISITE",59,0)
 ; $$USER ien of user accessing system
"RTN","SAMISITE",60,0)
 ; $$SITE ien of institution file entry for user's site
"RTN","SAMISITE",61,0)
 ; $$SITEID symbol for site
"RTN","SAMISITE",62,0)
 ; $$SITEACTV is site active?
"RTN","SAMISITE",63,0)
 ; $$SITENM site name from ien
"RTN","SAMISITE",64,0)
 ; $$SITENM2 site name from symbol
"RTN","SAMISITE",65,0)
 ; LOGIN login processing
"RTN","SAMISITE",66,0)
 ; $$SIGNON signon with access & verify code
"RTN","SAMISITE",67,0)
 ; SUPER site selection page for super users
"RTN","SAMISITE",68,0)
 ; UPGRADE init: convert to multi-tenancy
"RTN","SAMISITE",69,0)
 ;
"RTN","SAMISITE",70,0)
 ;
"RTN","SAMISITE",71,0)
 ;
"RTN","SAMISITE",72,0)
 ;@section 1 subroutines
"RTN","SAMISITE",73,0)
 ;
"RTN","SAMISITE",74,0)
 ;
"RTN","SAMISITE",75,0)
 ;
"RTN","SAMISITE",76,0)
FINDSITE(SAMIRETURN,ARGS) ; extrinsic which returns the site
"RTN","SAMISITE",77,0)
 ; to be used by this user: ARGS("siteid")=siteid and
"RTN","SAMISITE",78,0)
 ; ARGS("sitetitle")=sitename - siteid
"RTN","SAMISITE",79,0)
 ; 1 for success 
"RTN","SAMISITE",80,0)
 ; 0 for fail - exit; page to be displayed is in SAMIRETURN
"RTN","SAMISITE",81,0)
 ;
"RTN","SAMISITE",82,0)
 ;d ^ZTER
"RTN","SAMISITE",83,0)
 n user
"RTN","SAMISITE",84,0)
 s user=$$USER()
"RTN","SAMISITE",85,0)
 i user=-1 d  q 0
"RTN","SAMISITE",86,0)
 . n vals
"RTN","SAMISITE",87,0)
 . s vals("siteid")=""
"RTN","SAMISITE",88,0)
 . s vals("sitetitle")="Unknown Site"
"RTN","SAMISITE",89,0)
 . s vals("errorMessage")=""
"RTN","SAMISITE",90,0)
 . d RTNERR^SAMIHOM4(.SAMIRETURN,"vapals:login",.vals)
"RTN","SAMISITE",91,0)
 . ;s ARGS("errorMessage")="Error, user not found"
"RTN","SAMISITE",92,0)
 . ;d RTNERR^SAMIHOM4(.SAMIRETURN,"vapals:syserror",.ARGS)
"RTN","SAMISITE",93,0)
 ;
"RTN","SAMISITE",94,0)
 ;d  q 0
"RTN","SAMISITE",95,0)
 ;. s ARGS("errorMessage")="User is found: "_user
"RTN","SAMISITE",96,0)
 ;. d RTNERR^SAMIHOM4(.SAMIRETURN,"vapals:syserror",.ARGS)
"RTN","SAMISITE",97,0)
 ;
"RTN","SAMISITE",98,0)
 n site,siteid,siteactv,sitenm
"RTN","SAMISITE",99,0)
 ;
"RTN","SAMISITE",100,0)
 i $o(^SAMI(311.13,"B",user,""))'="" d  q 0 ; superuser
"RTN","SAMISITE",101,0)
 . d SUPER("SAMIRETURN",.ARGS)
"RTN","SAMISITE",102,0)
 . s HTTPRSP("mime")="text/html"
"RTN","SAMISITE",103,0)
 ;
"RTN","SAMISITE",104,0)
 s site=$$SITE(user)
"RTN","SAMISITE",105,0)
 i site<1 s site=-1
"RTN","SAMISITE",106,0)
 i site=-1 d  q 0
"RTN","SAMISITE",107,0)
 . s ARGS("errorMessage")="Site not found for user "_user
"RTN","SAMISITE",108,0)
 . d RTNERR^SAMIHOM4(.SAMIRETURN,"vapals:syserror",.ARGS)
"RTN","SAMISITE",109,0)
 ;
"RTN","SAMISITE",110,0)
 s siteid=$$SITEID(site)
"RTN","SAMISITE",111,0)
 i siteid=-1 d  q 0
"RTN","SAMISITE",112,0)
 . s ARGS("errorMessage")="Site ID not found for site "_site
"RTN","SAMISITE",113,0)
 . d RTNERR^SAMIHOM4(.SAMIRETURN,"vapals:syserror",.ARGS)
"RTN","SAMISITE",114,0)
 ;
"RTN","SAMISITE",115,0)
 s siteactv=$$SITEACTV(site)
"RTN","SAMISITE",116,0)
 i siteactv<1 d  q 0
"RTN","SAMISITE",117,0)
 . s ARGS("errorMessage")="Site not active: "_siteid
"RTN","SAMISITE",118,0)
 . d RTNERR^SAMIHOM4(.SAMIRETURN,"vapals:syserror",.ARGS)
"RTN","SAMISITE",119,0)
 ;
"RTN","SAMISITE",120,0)
 s sitenm=$$SITENM(site)
"RTN","SAMISITE",121,0)
 i sitenm=-1 d  q 0
"RTN","SAMISITE",122,0)
 . s ARGS("errorMessage")="Site name not found: "_siteid
"RTN","SAMISITE",123,0)
 . d RTNERR^SAMIHOM4(.SAMIRETURN,"vapals:syserror",.ARGS)
"RTN","SAMISITE",124,0)
 ;
"RTN","SAMISITE",125,0)
 s ARGS("siteid")=siteid
"RTN","SAMISITE",126,0)
 s ARGS("sitetitle")=$$SITENM(site)_" - "_siteid
"RTN","SAMISITE",127,0)
 q 1
"RTN","SAMISITE",128,0)
 ;
"RTN","SAMISITE",129,0)
 ;
"RTN","SAMISITE",130,0)
 ;
"RTN","SAMISITE",131,0)
USER() ; extrinsic returns the DUZ of the user accessing the system
"RTN","SAMISITE",132,0)
 ; -1 means user not known
"RTN","SAMISITE",133,0)
 n rtn s rtn=-1
"RTN","SAMISITE",134,0)
 s rtn=+$G(DUZ)
"RTN","SAMISITE",135,0)
 i rtn=0 s rtn=-1
"RTN","SAMISITE",136,0)
 q rtn
"RTN","SAMISITE",137,0)
 ;
"RTN","SAMISITE",138,0)
 ;
"RTN","SAMISITE",139,0)
 ;
"RTN","SAMISITE",140,0)
SITE(USER) ; extrinsic returns the pointer to the Institution file
"RTN","SAMISITE",141,0)
 ; which is the site of the user
"RTN","SAMISITE",142,0)
 ; -1 means site not found
"RTN","SAMISITE",143,0)
 ; zero means site not active
"RTN","SAMISITE",144,0)
 n rtn
"RTN","SAMISITE",145,0)
 s rtn=$o(^VA(200,USER,2,0))
"RTN","SAMISITE",146,0)
 i +rtn="" s rtn=-1
"RTN","SAMISITE",147,0)
 q rtn
"RTN","SAMISITE",148,0)
 ;
"RTN","SAMISITE",149,0)
 ;
"RTN","SAMISITE",150,0)
 ;
"RTN","SAMISITE",151,0)
SITEID(SITE) ; extrinsic returns the Site Symbol for SITE
"RTN","SAMISITE",152,0)
 ; this is found in the SAMI SITE file
"RTN","SAMISITE",153,0)
 ; null means SITEID not found
"RTN","SAMISITE",154,0)
 n rtn s rtn=-1
"RTN","SAMISITE",155,0)
 n ien s ien=$o(^SAMI(311.12,"B",SITE,""))
"RTN","SAMISITE",156,0)
 q:ien="" -1
"RTN","SAMISITE",157,0)
 s rtn=$$GET1^DIQ(311.12,ien_",",.02)
"RTN","SAMISITE",158,0)
 q rtn
"RTN","SAMISITE",159,0)
 ;
"RTN","SAMISITE",160,0)
 ;
"RTN","SAMISITE",161,0)
 ; 
"RTN","SAMISITE",162,0)
SITEACTV(SITE) ; Extrinsic which returns 1 if the site is active
"RTN","SAMISITE",163,0)
 ; otherwise 0
"RTN","SAMISITE",164,0)
 n rtn s rtn=-1
"RTN","SAMISITE",165,0)
 n ien s ien=$o(^SAMI(311.12,"B",SITE,""))
"RTN","SAMISITE",166,0)
 q:ien="" -1
"RTN","SAMISITE",167,0)
 s rtn=$$GET1^DIQ(311.12,ien_",",.03,"I")
"RTN","SAMISITE",168,0)
 q rtn
"RTN","SAMISITE",169,0)
 ;
"RTN","SAMISITE",170,0)
 ;
"RTN","SAMISITE",171,0)
 ;
"RTN","SAMISITE",172,0)
SITENM(SITE) ; Extrinsic which returns the Site name
"RTN","SAMISITE",173,0)
 ;
"RTN","SAMISITE",174,0)
 n rtn s rtn=-1
"RTN","SAMISITE",175,0)
 s rtn=$$GET1^DIQ(4,SITE_",",.01)
"RTN","SAMISITE",176,0)
 i rtn="" s rtn=-1
"RTN","SAMISITE",177,0)
 q rtn
"RTN","SAMISITE",178,0)
 ;
"RTN","SAMISITE",179,0)
 ;
"RTN","SAMISITE",180,0)
 ;
"RTN","SAMISITE",181,0)
SITENM2(SITEID) ; Extrinsic which returns the Site name from the Site Symbol
"RTN","SAMISITE",182,0)
 ;
"RTN","SAMISITE",183,0)
 q:SITEID="" -1
"RTN","SAMISITE",184,0)
 n siteien
"RTN","SAMISITE",185,0)
 s siteien=$o(^SAMI(311.12,"SYM",SITEID,""))
"RTN","SAMISITE",186,0)
 n site
"RTN","SAMISITE",187,0)
 q $$GET1^DIQ(311.12,siteien_",",.01,"E")
"RTN","SAMISITE",188,0)
 ;
"RTN","SAMISITE",189,0)
 ;
"RTN","SAMISITE",190,0)
 ;
"RTN","SAMISITE",191,0)
LOGIN(RTN,VALS) ; login processing
"RTN","SAMISITE",192,0)
 ;
"RTN","SAMISITE",193,0)
 n access,verify
"RTN","SAMISITE",194,0)
 s access=$g(VALS("access"))
"RTN","SAMISITE",195,0)
 s verify=$g(VALS("verify"))
"RTN","SAMISITE",196,0)
 ;i verify="@demo123" s verify="@demo321"
"RTN","SAMISITE",197,0)
 ;i verify="@demo123" s verify="$#happy10"
"RTN","SAMISITE",198,0)
 ;i access="ZZZUSER1" s access="SUPER6"
"RTN","SAMISITE",199,0)
 ;i access="" d  ;
"RTN","SAMISITE",200,0)
 ;. s access="PHXNAV1"
"RTN","SAMISITE",201,0)
 ;. s verify="$#happy6"
"RTN","SAMISITE",202,0)
 I $$GET1PARM^SAMIPARM("systemDemoOnly")="true" D  Q  ;
"RTN","SAMISITE",203,0)
 . S DUZ=$$GET1PARM^SAMIPARM("systemDemoUseDUZ")
"RTN","SAMISITE",204,0)
 . I +DUZ=0 D  ;
"RTN","SAMISITE",205,0)
 . . S DUZ=$O(^SAMI(311.13,"B",""))
"RTN","SAMISITE",206,0)
 . s VALS("samiroute")=""
"RTN","SAMISITE",207,0)
 . s VALS("siteid")=""
"RTN","SAMISITE",208,0)
 . d WSHOME^SAMIHOM3(.RTN,.VALS)
"RTN","SAMISITE",209,0)
 n ACVC s ACVC=access_";"_verify
"RTN","SAMISITE",210,0)
 i $$SIGNON(ACVC) D  Q  ;
"RTN","SAMISITE",211,0)
 . s VALS("samiroute")=""
"RTN","SAMISITE",212,0)
 . s VALS("siteid")=""
"RTN","SAMISITE",213,0)
 . d WSHOME^SAMIHOM3(.RTN,.VALS)
"RTN","SAMISITE",214,0)
 else  D  Q  ;
"RTN","SAMISITE",215,0)
 . s VALS("errorMessage")="Invalid login"
"RTN","SAMISITE",216,0)
 . d RTNERR^SAMIHOM4(.RTN,"vapals:login",.VALS)
"RTN","SAMISITE",217,0)
 q
"RTN","SAMISITE",218,0)
 ;
"RTN","SAMISITE",219,0)
 ;
"RTN","SAMISITE",220,0)
 ;
"RTN","SAMISITE",221,0)
SIGNON(ACVC) ; extrinsic returns 1 if signon is successful, else 0
"RTN","SAMISITE",222,0)
 ; Sign-on
"RTN","SAMISITE",223,0)
 N IO S IO=$P
"RTN","SAMISITE",224,0)
 D SETUP^XUSRB() ; Only partition set-up; No single sign-on or CAPRI
"RTN","SAMISITE",225,0)
 N RTN D VALIDAV^XUSRB(.RTN,$$ENCRYP^XUSRB1(ACVC)) ; sign-on call
"RTN","SAMISITE",226,0)
 I RTN(0)>0,'RTN(2) Q 1 ; Sign on successful!
"RTN","SAMISITE",227,0)
 I RTN(0)=0,RTN(2) Q 0  ; Verify Code must be changed NOW!
"RTN","SAMISITE",228,0)
 I $L(RTN(3)) Q 0  ; Error Message
"RTN","SAMISITE",229,0)
 ;
"RTN","SAMISITE",230,0)
 q
"RTN","SAMISITE",231,0)
 ;
"RTN","SAMISITE",232,0)
 ;
"RTN","SAMISITE",233,0)
 ;
"RTN","SAMISITE",234,0)
SUPER(RTN,FILTER) ; returns site selection page for super users
"RTN","SAMISITE",235,0)
 ;
"RTN","SAMISITE",236,0)
 n temp
"RTN","SAMISITE",237,0)
 d getThis^%wd("temp","blank_no_nav.html")
"RTN","SAMISITE",238,0)
 q:'$d(temp)
"RTN","SAMISITE",239,0)
 n cnt s cnt=0
"RTN","SAMISITE",240,0)
 n zj s zj=0
"RTN","SAMISITE",241,0)
 f  s zj=$o(temp(zj)) q:temp(zj)["Insert"  q:+zj=0  d  ;
"RTN","SAMISITE",242,0)
 . n ln s ln=temp(zj)
"RTN","SAMISITE",243,0)
 . i ln["PAGE NAME" s ln="Site Selection"
"RTN","SAMISITE",244,0)
 . d LOAD^SAMIFORM(.ln,"","")
"RTN","SAMISITE",245,0)
 . s cnt=cnt+1
"RTN","SAMISITE",246,0)
 . s @RTN@(cnt)=ln
"RTN","SAMISITE",247,0)
 s cnt=cnt+1
"RTN","SAMISITE",248,0)
 s @RTN@(cnt)="<ul>"
"RTN","SAMISITE",249,0)
 n gn s gn=$na(^SAMI(311.12,"B"))
"RTN","SAMISITE",250,0)
 n zi s zi=0
"RTN","SAMISITE",251,0)
 f  s zi=$o(@gn@(zi)) q:+zi=0  d  ;
"RTN","SAMISITE",252,0)
 . n zien s zien=$o(@gn@(zi,""))
"RTN","SAMISITE",253,0)
 . n active
"RTN","SAMISITE",254,0)
 . s active=$$GET1^DIQ(311.12,zien_",",.03,"I")
"RTN","SAMISITE",255,0)
 . q:active=0
"RTN","SAMISITE",256,0)
 . n name
"RTN","SAMISITE",257,0)
 . s name=$$SITENM(zi)_" - "_$$SITEID(zi)
"RTN","SAMISITE",258,0)
 . n link
"RTN","SAMISITE",259,0)
 . s link="<li>"
"RTN","SAMISITE",260,0)
 . s link=link_"<a class=""navigation"" data-method=""post"""
"RTN","SAMISITE",261,0)
 . s link=link_" data-samiroute=""home"" data-siteid="""_$$SITEID(zi)_""""
"RTN","SAMISITE",262,0)
 . ;s link=link_" data-site="""_$$SITEID(zi)_""""
"RTN","SAMISITE",263,0)
 . ;s link=link_" href=""#!"">"_$$SITENM(zi)_" - "_$$SITEID(zi)
"RTN","SAMISITE",264,0)
 . s link=link_" href=""/vapals"">"_name
"RTN","SAMISITE",265,0)
 . s link=link_"</a></li>"
"RTN","SAMISITE",266,0)
 . ;n link
"RTN","SAMISITE",267,0)
 . ;s link="<form method=POST action=""/vapals"">"
"RTN","SAMISITE",268,0)
 . ;s link=link_"<input type=hidden name=""samiroute"" value=""home"">"
"RTN","SAMISITE",269,0)
 . ;s link=link_"<input type=hidden name=""siteid"" value="""_$$SITEID(zi)_""">"
"RTN","SAMISITE",270,0)
 . ;s link=link_"<input value="""_name_""" class=""btn btn-link"" role=""link"" type=""submit""></form>"
"RTN","SAMISITE",271,0)
 . s cnt=cnt+1
"RTN","SAMISITE",272,0)
 . s @RTN@(cnt)=link
"RTN","SAMISITE",273,0)
 s cnt=cnt+1
"RTN","SAMISITE",274,0)
 s @RTN@(cnt)="</ul>"
"RTN","SAMISITE",275,0)
 n zk s zk=zj+1
"RTN","SAMISITE",276,0)
 f  s zk=$o(temp(zk)) q:+zk=0  d  ;
"RTN","SAMISITE",277,0)
 . s cnt=cnt+1
"RTN","SAMISITE",278,0)
 . s @RTN@(cnt)=temp(zk)
"RTN","SAMISITE",279,0)
 q
"RTN","SAMISITE",280,0)
 ;
"RTN","SAMISITE",281,0)
 ;
"RTN","SAMISITE",282,0)
 ;
"RTN","SAMISITE",283,0)
UPGRADE() ; convert VAPALS system to Multi-tenancy by adding siteid
"RTN","SAMISITE",284,0)
 ; to all existing patients - runs one time as the Post Install 
"RTN","SAMISITE",285,0)
 ; to the installation
"RTN","SAMISITE",286,0)
 ;
"RTN","SAMISITE",287,0)
 n lroot,proot,lien,pien
"RTN","SAMISITE",288,0)
 s (lien,pien)=0
"RTN","SAMISITE",289,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMISITE",290,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMISITE",291,0)
 n site
"RTN","SAMISITE",292,0)
 s site=$$GET^XPAR("SYS","SAMI SID PREFIX",,"Q")
"RTN","SAMISITE",293,0)
 i site="" d  q  ;
"RTN","SAMISITE",294,0)
 . D MES^XPDUTL("No default site returned by SAMI SID PREFIX parameter, exiting")
"RTN","SAMISITE",295,0)
 n cnt s cnt=0
"RTN","SAMISITE",296,0)
 f  s lien=$o(@lroot@(lien)) q:+lien=0  d  ;
"RTN","SAMISITE",297,0)
 . q:$g(@lroot@(lien,"siteid"))'=""
"RTN","SAMISITE",298,0)
 . n nomatch s nomatch=0
"RTN","SAMISITE",299,0)
 . n dfn s dfn=$g(@lroot@(lien,"dfn"))
"RTN","SAMISITE",300,0)
 . i dfn="" d  q  ;
"RTN","SAMISITE",301,0)
 . . D MES^XPDUTL("Error, no dfn found for lien "_lien)
"RTN","SAMISITE",302,0)
 . s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMISITE",303,0)
 . ; make sure the first 3 chars of the studyid matches the site
"RTN","SAMISITE",304,0)
 . i pien'="" d  q:nomatch
"RTN","SAMISITE",305,0)
 . . n psite,psid
"RTN","SAMISITE",306,0)
 . . s psid=$g(@proot@(pien,"sisid"))
"RTN","SAMISITE",307,0)
 . . i psid="" s nomatch=1 q  ;
"RTN","SAMISITE",308,0)
 . . i $e(psid,1,3)'=site s nomatch=1 d  q  ;
"RTN","SAMISITE",309,0)
 . . . d MES^XPDUTL("skipping record - studyid "_psid_" does not match site "_site)
"RTN","SAMISITE",310,0)
 . ;w !,"lien "_lien_" being set to "_site
"RTN","SAMISITE",311,0)
 . s cnt=cnt+1
"RTN","SAMISITE",312,0)
 . s @lroot@(lien,"siteid")=site
"RTN","SAMISITE",313,0)
 i cnt>0 d  ;
"RTN","SAMISITE",314,0)
 . d MES^XPDUTL("Multi-tenancy upgrade successful")
"RTN","SAMISITE",315,0)
 . d MES^XPDUTL(cnt_" patient records set to site "_site)
"RTN","SAMISITE",316,0)
 q
"RTN","SAMISITE",317,0)
 ;
"RTN","SAMISITE",318,0)
 ;
"RTN","SAMISITE",319,0)
 ;
"RTN","SAMISITE",320,0)
EOR ; end of routine SAMISITE
"RTN","SAMITTW")
0^19^B5460827
"RTN","SAMITTW",1,0)
SAMITTW ;ven/gpl - text-processing utilities ;2021-07-01t21:37z
"RTN","SAMITTW",2,0)
 ;;18.0;SAMI;**12**;2020-01;Build 6
"RTN","SAMITTW",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMITTW",4,0)
 ;
"RTN","SAMITTW",5,0)
 ; Routine SAMITTW contains subroutines for formatting text fields for
"RTN","SAMITTW",6,0)
 ; VAPALS-ELCAP forms.
"RTN","SAMITTW",7,0)
 ;
"RTN","SAMITTW",8,0)
 quit  ; no entry from top
"RTN","SAMITTW",9,0)
 ;
"RTN","SAMITTW",10,0)
 ;
"RTN","SAMITTW",11,0)
 ;
"RTN","SAMITTW",12,0)
 ;@section 0 primary development
"RTN","SAMITTW",13,0)
 ;
"RTN","SAMITTW",14,0)
 ;
"RTN","SAMITTW",15,0)
 ;
"RTN","SAMITTW",16,0)
 ;@routine-credits
"RTN","SAMITTW",17,0)
 ;@primary-dev: George P. Lilly (gpl)
"RTN","SAMITTW",18,0)
 ; gpl@vistaexpertise.net
"RTN","SAMITTW",19,0)
 ;@primary-dev-org: Vista Expertise Network (ven)
"RTN","SAMITTW",20,0)
 ; http://vistaexpertise.net
"RTN","SAMITTW",21,0)
 ;@copyright: 2021, gpl, all rights reserved
"RTN","SAMITTW",22,0)
 ;@license see routine SAMIUL
"RTN","SAMITTW",23,0)
 ;
"RTN","SAMITTW",24,0)
 ;@last-updated 2021-07-01t21:37z
"RTN","SAMITTW",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMITTW",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMITTW",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMITTW",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMITTW",29,0)
 ;@release-date 2020-01
"RTN","SAMITTW",30,0)
 ;@patch-list **12**
"RTN","SAMITTW",31,0)
 ;
"RTN","SAMITTW",32,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMITTW",33,0)
 ; toad@vistaexpertise.net
"RTN","SAMITTW",34,0)
 ;@additional-dev Kenneth W. McGlothlen (mcglk)
"RTN","SAMITTW",35,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMITTW",36,0)
 ;
"RTN","SAMITTW",37,0)
 ;@routine-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMITTW",38,0)
 ; 2021-06-29 ven/gpl 1.18.0.12-t2+i12 a5bbd37a
"RTN","SAMITTW",39,0)
 ;  SAMITTW format text box for intake & followup notes; new text-
"RTN","SAMITTW",40,0)
 ; processing utils.
"RTN","SAMITTW",41,0)
 ;
"RTN","SAMITTW",42,0)
 ; 2021-07-01 ven/mcglk&toad 1.18.0.12-t2+i12 cbf7e46b,fa794d60
"RTN","SAMITTW",43,0)
 ;  SAMITTW bump version & dates, add hdr comments & dev log.
"RTN","SAMITTW",44,0)
 ;
"RTN","SAMITTW",45,0)
 ;@contents
"RTN","SAMITTW",46,0)
 ; $$PRNTABLE remove non-printable characters except CR
"RTN","SAMITTW",47,0)
 ; $$CRWRAP wrap text line based on margin or embedded CRLF
"RTN","SAMITTW",48,0)
 ;
"RTN","SAMITTW",49,0)
 ;
"RTN","SAMITTW",50,0)
 ;
"RTN","SAMITTW",51,0)
 ;@section 1 subroutines
"RTN","SAMITTW",52,0)
 ;
"RTN","SAMITTW",53,0)
 ;
"RTN","SAMITTW",54,0)
 ;
"RTN","SAMITTW",55,0)
PRNTABLE(ln) ; Extrinsic which removes all non-printable character except CR
"RTN","SAMITTW",56,0)
 n zi,zn,ln2
"RTN","SAMITTW",57,0)
 s ln2=""
"RTN","SAMITTW",58,0)
 f zi=1:1:$l(ln) d  ;
"RTN","SAMITTW",59,0)
 . s zn=$ASCII($e(ln,zi))
"RTN","SAMITTW",60,0)
 . q:zn>126
"RTN","SAMITTW",61,0)
 . q:zn<13
"RTN","SAMITTW",62,0)
 . q:((zn>13)&(zn<30))
"RTN","SAMITTW",63,0)
 . s ln2=ln2_$CHAR(zn)
"RTN","SAMITTW",64,0)
 ;
"RTN","SAMITTW",65,0)
 q ln2
"RTN","SAMITTW",66,0)
 ;
"RTN","SAMITTW",67,0)
 ;
"RTN","SAMITTW",68,0)
 ;
"RTN","SAMITTW",69,0)
CRWRAP(ln,dest,cnt,margin) ; extrinsic which will wrap a text line into
"RTN","SAMITTW",70,0)
 ; multiple lines based on margin, which defaults to 80, or imbedded CRLF
"RTN","SAMITTW",71,0)
 ; or CR. ln and margin are passed by value. dest is passed by name and
"RTN","SAMITTW",72,0)
 ; cnt is passed by reference and is updated.
"RTN","SAMITTW",73,0)
 ; extrinsic returns 1 if output was added to dest
"RTN","SAMITTW",74,0)
 ;
"RTN","SAMITTW",75,0)
 i $l(ln)<10 q 0  ; skip short fields
"RTN","SAMITTW",76,0)
 s ln=$$PRNTABLE^SAMITTW(ln)
"RTN","SAMITTW",77,0)
 ;s ^gpl("ln",$o(^gpl("ln"," "),-1)+1)=ln
"RTN","SAMITTW",78,0)
 i '$d(margin) s margin=80
"RTN","SAMITTW",79,0)
 i ln[$CHAR(13) d  q 1
"RTN","SAMITTW",80,0)
 . n cr s cr=$char(13)
"RTN","SAMITTW",81,0)
 . n crn s crn=$l(ln,$char(13))
"RTN","SAMITTW",82,0)
 . i $l(ln,$char(13,10))=crn s cr=$char(13,10)
"RTN","SAMITTW",83,0)
 . n i
"RTN","SAMITTW",84,0)
 . f i=1:1:crn d  ;
"RTN","SAMITTW",85,0)
 . . n eln s eln=""
"RTN","SAMITTW",86,0)
 . . i cr=$char(13) s eln(1)=$p(ln,$char(13),i)
"RTN","SAMITTW",87,0)
 . . i cr=$char(13,10) s eln(1)=$p(ln,$char(13,10),i)
"RTN","SAMITTW",88,0)
 . . ;s ^gpl("note",i)=eln(1)
"RTN","SAMITTW",89,0)
 . . q:eln(1)=""
"RTN","SAMITTW",90,0)
 . . i $l(eln(1))>margin d wrap^%tt("eln",margin,dest) q
"RTN","SAMITTW",91,0)
 . . n lnn s lnn=$o(@dest@(" "),-1)+1
"RTN","SAMITTW",92,0)
 . . s @dest@(lnn)=eln(1)
"RTN","SAMITTW",93,0)
 . ;
"RTN","SAMITTW",94,0)
 i $l(ln)>margin d  q 1 ;
"RTN","SAMITTW",95,0)
 . n eln s eln(1)=ln
"RTN","SAMITTW",96,0)
 . d wrap^%tt("eln",margin,dest)
"RTN","SAMITTW",97,0)
 ;
"RTN","SAMITTW",98,0)
 q 0
"RTN","SAMITTW",99,0)
 ;
"RTN","SAMITTW",100,0)
 ;
"RTN","SAMITTW",101,0)
 ;
"RTN","SAMITTW",102,0)
EOR ; end of routine SAMITTW
"RTN","SAMIUR")
0^20^B504449514
"RTN","SAMIUR",1,0)
SAMIUR ;ven/gpl - user reports ;2021-07-12t23:19z
"RTN","SAMIUR",2,0)
 ;;18.0;SAMI;**5,10,11,12**;2020-01;Build 6
"RTN","SAMIUR",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIUR",4,0)
 ;
"RTN","SAMIUR",5,0)
 ; SAMIUR contains a web service & associated subroutines to produce
"RTN","SAMIUR",6,0)
 ; VAPALS-ELCAP user reports.
"RTN","SAMIUR",7,0)
 ;
"RTN","SAMIUR",8,0)
 quit  ; no entry from top
"RTN","SAMIUR",9,0)
 ;
"RTN","SAMIUR",10,0)
 ;
"RTN","SAMIUR",11,0)
 ;
"RTN","SAMIUR",12,0)
 ;@section 0 primary development
"RTN","SAMIUR",13,0)
 ;
"RTN","SAMIUR",14,0)
 ;
"RTN","SAMIUR",15,0)
 ;
"RTN","SAMIUR",16,0)
 ;@routine-credits
"RTN","SAMIUR",17,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMIUR",18,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIUR",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIUR",20,0)
 ; http://vistaexpertise.net
"RTN","SAMIUR",21,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIUR",22,0)
 ;@license see routine SAMIUL
"RTN","SAMIUR",23,0)
 ;
"RTN","SAMIUR",24,0)
 ;@last-updated 2021-07-12t23:19z
"RTN","SAMIUR",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIUR",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIUR",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIUR",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIUR",29,0)
 ;@release-date 2020-01
"RTN","SAMIUR",30,0)
 ;@patch-list **5,10,11,12**
"RTN","SAMIUR",31,0)
 ;
"RTN","SAMIUR",32,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIUR",33,0)
 ; toad@vistaexpertise.net
"RTN","SAMIUR",34,0)
 ;@additional-dev Larry G. Carlson (lgc)
"RTN","SAMIUR",35,0)
 ; larry.g.carlson@gmail.com
"RTN","SAMIUR",36,0)
 ;@additional-dev Alexis R. Carlson (arc)
"RTN","SAMIUR",37,0)
 ; whatisthehumanspirit@gmail.com
"RTN","SAMIUR",38,0)
 ;@additional-dev Kenneth McGlothlen (mcglk)
"RTN","SAMIUR",39,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIUR",40,0)
 ;
"RTN","SAMIUR",41,0)
 ;@module-credits see SAMIHUL
"RTN","SAMIUR",42,0)
 ;
"RTN","SAMIUR",43,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIUR",44,0)
 ; see SAMIURUL
"RTN","SAMIUR",45,0)
 ;
"RTN","SAMIUR",46,0)
 ;@contents
"RTN","SAMIUR",47,0)
 ; WSREPORT generate report based on params in filter
"RTN","SAMIUR",48,0)
 ; SORT sort patients by name
"RTN","SAMIUR",49,0)
 ; NUHREF create nuhref link to casereview for all patients
"RTN","SAMIUR",50,0)
 ; PNAME page name for report
"RTN","SAMIUR",51,0)
 ;
"RTN","SAMIUR",52,0)
 ; SELECT select patients for report
"RTN","SAMIUR",53,0)
 ; UNMAT build unmatched persons list
"RTN","SAMIUR",54,0)
 ; WKLIST build work list
"RTN","SAMIUR",55,0)
 ;
"RTN","SAMIUR",56,0)
 ;
"RTN","SAMIUR",57,0)
 ;
"RTN","SAMIUR",58,0)
 ;@section 1 wsreport subroutines
"RTN","SAMIUR",59,0)
 ;
"RTN","SAMIUR",60,0)
 ;
"RTN","SAMIUR",61,0)
 ;
"RTN","SAMIUR",62,0)
WSREPORT(SAMIRTN,filter) ; generate report based on params in filter
"RTN","SAMIUR",63,0)
 ;
"RTN","SAMIUR",64,0)
 ;@called-by
"RTN","SAMIUR",65,0)
 ; WSVAPALS^SAMIHOM4
"RTN","SAMIUR",66,0)
 ; WSREPORT^SAMIUR1
"RTN","SAMIUR",67,0)
 ;@calls
"RTN","SAMIUR",68,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMIUR",69,0)
 ; getThis^%wd
"RTN","SAMIUR",70,0)
 ; SELECT
"RTN","SAMIUR",71,0)
 ; LOAD^SAMIFORM
"RTN","SAMIUR",72,0)
 ; $$PNAME
"RTN","SAMIUR",73,0)
 ; findReplace^%ts
"RTN","SAMIUR",74,0)
 ; RPTTBL^SAMIUR2
"RTN","SAMIUR",75,0)
 ; NUHREF
"RTN","SAMIUR",76,0)
 ; SORT
"RTN","SAMIUR",77,0)
 ; @RPT(ir,"routine"): [from report def table from RPTTBL^SAMIUR2]
"RTN","SAMIUR",78,0)
 ;  format = $$<tag>^SAMIUR2, where tag =
"RTN","SAMIUR",79,0)
 ;  AGE       BLINEDT   CONTACT   CTPROT   DOB      FUDATE    GENDER
"RTN","SAMIUR",80,0)
 ;  IFORM     LASTEXM   MANPAT    MATCH    NAME     PACKYRS   POSSIBLE
"RTN","SAMIUR",81,0)
 ;  RECOM     RURAL     SID       SMHIS    SMKSTAT  SSN       STUDYDT
"RTN","SAMIUR",82,0)
 ;  STUDYTYP  VALS      WHEN      WORKPAT
"RTN","SAMIUR",83,0)
 ;
"RTN","SAMIUR",84,0)
 ; here are the user reports that are defined:
"RTN","SAMIUR",85,0)
 ;  1. followup
"RTN","SAMIUR",86,0)
 ;  2. activity
"RTN","SAMIUR",87,0)
 ;  3. missingct
"RTN","SAMIUR",88,0)
 ;  4. incomplete
"RTN","SAMIUR",89,0)
 ;  5. outreach
"RTN","SAMIUR",90,0)
 ;  6. enrollment
"RTN","SAMIUR",91,0)
 ;  7. worklist
"RTN","SAMIUR",92,0)
 ; the report to generate is passed in parameter samireporttype
"RTN","SAMIUR",93,0)
 ;
"RTN","SAMIUR",94,0)
 new debug set debug=0
"RTN","SAMIUR",95,0)
 if $get(filter("debug"))=1 set debug=1
"RTN","SAMIUR",96,0)
 if $get(filter("debug"))=1 set debug=1
"RTN","SAMIUR",97,0)
 kill SAMIRTN
"RTN","SAMIUR",98,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMIUR",99,0)
 ;
"RTN","SAMIUR",100,0)
 new type,temp,site
"RTN","SAMIUR",101,0)
 s site=$g(filter("siteid"))
"RTN","SAMIUR",102,0)
 i site="" s site=$g(filter("site"))
"RTN","SAMIUR",103,0)
 i site="" d  q  ; report site missing
"RTN","SAMIUR",104,0)
 . d GETHOME^SAMIHOM3(.SAMIRTN,.filter) ; send them to home
"RTN","SAMIUR",105,0)
 ;
"RTN","SAMIUR",106,0)
 set type=$get(filter("samireporttype"))
"RTN","SAMIUR",107,0)
 if type="" do  quit  ; report type missing
"RTN","SAMIUR",108,0)
 . do GETHOME^SAMIHOM3(.SAMIRTN,.filter) ; send them to home
"RTN","SAMIUR",109,0)
 . quit
"RTN","SAMIUR",110,0)
 ;
"RTN","SAMIUR",111,0)
 if type="unmatched" i $$GET1PARM^SAMIPARM("matchingReportEnabled",site)'="true" do  quit  ;
"RTN","SAMIUR",112,0)
 . d GETHOME^SAMIHOM3(.SAMIRTN,.filter) ; send them to home
"RTN","SAMIUR",113,0)
 ;
"RTN","SAMIUR",114,0)
 do getThis^%wd("temp","table.html") ; page template
"RTN","SAMIUR",115,0)
 quit:'$data(temp)
"RTN","SAMIUR",116,0)
 ;
"RTN","SAMIUR",117,0)
 new SAMIPATS
"RTN","SAMIUR",118,0)
 ; set pats=""
"RTN","SAMIUR",119,0)
 new datephrase
"RTN","SAMIUR",120,0)
 do SELECT(.SAMIPATS,type,.datephrase,.filter) ; select pats for report
"RTN","SAMIUR",121,0)
 ; quit:'$data(SAMIPATS)
"RTN","SAMIUR",122,0)
 ;
"RTN","SAMIUR",123,0)
 new ln,cnt,ii
"RTN","SAMIUR",124,0)
 set (ii,ln,cnt)=0
"RTN","SAMIUR",125,0)
 for  do  quit:'ii  quit:$get(temp(ii))["<thead"
"RTN","SAMIUR",126,0)
 . set ii=$order(temp(ii))
"RTN","SAMIUR",127,0)
 . quit:'ii
"RTN","SAMIUR",128,0)
 . quit:$get(temp(ii))["<thead"
"RTN","SAMIUR",129,0)
 . ;
"RTN","SAMIUR",130,0)
 . set cnt=cnt+1
"RTN","SAMIUR",131,0)
 . set ln=$get(temp(ii))
"RTN","SAMIUR",132,0)
 . new samikey,si
"RTN","SAMIUR",133,0)
 . set (samikey,si)=""
"RTN","SAMIUR",134,0)
 . do LOAD^SAMIFORM(.ln,samikey,si,.filter)
"RTN","SAMIUR",135,0)
 . ; if ln["PAGE NAME" do
"RTN","SAMIUR",136,0)
 . ; . do findReplace^%ts(.ln,"PAGE NAME",$$PNAME(type,datephrase))
"RTN","SAMIUR",137,0)
 . ; . quit
"RTN","SAMIUR",138,0)
 . if ln["PAGE NAME" do
"RTN","SAMIUR",139,0)
 . . do findReplace^%ts(.ln,"PAGE NAME",$$PNAME(type,""))
"RTN","SAMIUR",140,0)
 . . quit
"RTN","SAMIUR",141,0)
 . if ln["CRITERIA" do
"RTN","SAMIUR",142,0)
 . . do findReplace^%ts(.ln,"CRITERIA",datephrase)
"RTN","SAMIUR",143,0)
 . . quit
"RTN","SAMIUR",144,0)
 . if ln["@@REPORTTYPE@@" do
"RTN","SAMIUR",145,0)
 . . do findReplace^%ts(.ln,"@@REPORTTYPE@@",type)
"RTN","SAMIUR",146,0)
 . . quit
"RTN","SAMIUR",147,0)
 . ;
"RTN","SAMIUR",148,0)
 . if ln["name=""start-date""" do
"RTN","SAMIUR",149,0)
 . . do findReplace^%ts(.ln,"start-date""","start-date"" value="""_$g(filter("start-date"))_"""")
"RTN","SAMIUR",150,0)
 . . quit
"RTN","SAMIUR",151,0)
 . if ln["name=""end-date""" do
"RTN","SAMIUR",152,0)
 . . do findReplace^%ts(.ln,"end-date""","end-date"" value="""_$g(filter("end-date"))_"""")
"RTN","SAMIUR",153,0)
 . . quit
"RTN","SAMIUR",154,0)
 . ;
"RTN","SAMIUR",155,0)
 . set SAMIRTN(cnt)=ln
"RTN","SAMIUR",156,0)
 . quit
"RTN","SAMIUR",157,0)
 ;
"RTN","SAMIUR",158,0)
 new RPT,ik
"RTN","SAMIUR",159,0)
 do RPTTBL^SAMIUR2(.RPT,type,site) ; load report definition table
"RTN","SAMIUR",160,0)
 if '$data(RPT) do  quit  ; don't know about this report
"RTN","SAMIUR",161,0)
 . do GETHOME^SAMIHOM3(.SAMIRTN,.filter) ; send them to home
"RTN","SAMIUR",162,0)
 . quit
"RTN","SAMIUR",163,0)
 ;
"RTN","SAMIUR",164,0)
 ; output header
"RTN","SAMIUR",165,0)
 ;
"RTN","SAMIUR",166,0)
 set cnt=cnt+1 set SAMIRTN(cnt)="<thead><tr>"
"RTN","SAMIUR",167,0)
 set cnt=cnt+1
"RTN","SAMIUR",168,0)
 new totcnt set totcnt=cnt
"RTN","SAMIUR",169,0)
 ;
"RTN","SAMIUR",170,0)
 set ir=""
"RTN","SAMIUR",171,0)
 for  do  quit:ir=""  ;
"RTN","SAMIUR",172,0)
 . set ir=$order(RPT(ir))
"RTN","SAMIUR",173,0)
 . quit:ir=""
"RTN","SAMIUR",174,0)
 . set cnt=cnt+1
"RTN","SAMIUR",175,0)
 . set SAMIRTN(cnt)="<th>"_$get(RPT(ir,"header"))_"</th>"
"RTN","SAMIUR",176,0)
 . quit
"RTN","SAMIUR",177,0)
 ;
"RTN","SAMIUR",178,0)
 set cnt=cnt+1 set SAMIRTN(cnt)="</tr></thead>"
"RTN","SAMIUR",179,0)
 ;
"RTN","SAMIUR",180,0)
 set cnt=cnt+1 set SAMIRTN(cnt)="<tbody>"
"RTN","SAMIUR",181,0)
 ;
"RTN","SAMIUR",182,0)
 if type'="worklist" do  ;
"RTN","SAMIUR",183,0)
 . do NUHREF(.SAMIPATS) ; create the nuhref link for all patients
"RTN","SAMIUR",184,0)
 . quit
"RTN","SAMIUR",185,0)
 ;
"RTN","SAMIUR",186,0)
 new SRT set SRT=""
"RTN","SAMIUR",187,0)
 if $get(filter("sort"))="" d  ; what kind of sort
"RTN","SAMIUR",188,0)
 . set filter("sort")="name"
"RTN","SAMIUR",189,0)
 . i type="missingct" s filter("sort")="cdate" ;sort by latest contact
"RTN","SAMIUR",190,0)
 do SORT(.SRT,.SAMIPATS,.filter)
"RTN","SAMIUR",191,0)
 ; zwrite SRT
"RTN","SAMIUR",192,0)
 ;
"RTN","SAMIUR",193,0)
 ; set ij=0
"RTN","SAMIUR",194,0)
 ; for  do  quit:'ij  ;
"RTN","SAMIUR",195,0)
 ; . set ij=$order(SAMIPATS(ij))
"RTN","SAMIUR",196,0)
 ; . quit:'ij  
"RTN","SAMIUR",197,0)
 ; . new ij2 set ij2=0
"RTN","SAMIUR",198,0)
 ; . for  do  quit:'ij2  ;
"RTN","SAMIUR",199,0)
 ; . . set ij2=$order(SAMIPATS(ij,ij2))
"RTN","SAMIUR",200,0)
 ; . . quit:'ij2  
"RTN","SAMIUR",201,0)
 ; . . new dfn set dfn=ij2
"RTN","SAMIUR",202,0)
 ; . . quit
"RTN","SAMIUR",203,0)
 ; . quit
"RTN","SAMIUR",204,0)
 ;
"RTN","SAMIUR",205,0)
 new iz,ij,ij2,dfn,rows
"RTN","SAMIUR",206,0)
 set rows=0
"RTN","SAMIUR",207,0)
 set (iz,ij,ij2,dfn)=""
"RTN","SAMIUR",208,0)
 for  do  quit:iz=""  ;
"RTN","SAMIUR",209,0)
 . set iz=$order(SRT(iz))
"RTN","SAMIUR",210,0)
 . quit:iz=""
"RTN","SAMIUR",211,0)
 . set ij=$order(SRT(iz,""))
"RTN","SAMIUR",212,0)
 . set dfn=$order(SRT(iz,ij,""))
"RTN","SAMIUR",213,0)
 . do  ;
"RTN","SAMIUR",214,0)
 . . set cnt=cnt+1 set SAMIRTN(cnt)="<tr>"
"RTN","SAMIUR",215,0)
 . . set ir=""
"RTN","SAMIUR",216,0)
 . . for  do  quit:ir=""  ;
"RTN","SAMIUR",217,0)
 . . . set ir=$order(RPT(ir))
"RTN","SAMIUR",218,0)
 . . . quit:ir=""
"RTN","SAMIUR",219,0)
 . . . set cnt=cnt+1
"RTN","SAMIUR",220,0)
 . . . new XR,XRV
"RTN","SAMIUR",221,0)
 . . . ; set XR=$get(RPT(ir,"routine"))_"("_ij_",.SAMIPATS)"
"RTN","SAMIUR",222,0)
 . . . set XR="set XRV="_$get(RPT(ir,"routine"))_"("_ij_","_dfn_",.SAMIPATS)"
"RTN","SAMIUR",223,0)
 . . . ; set XRV=@XR
"RTN","SAMIUR",224,0)
 . . . xecute XR ; call report-field handlers in ^SAMIUR2
"RTN","SAMIUR",225,0)
 . . . set SAMIRTN(cnt)="<td>"_$get(XRV)_"</td>"
"RTN","SAMIUR",226,0)
 . . . quit
"RTN","SAMIUR",227,0)
 . . ;
"RTN","SAMIUR",228,0)
 . . set cnt=cnt+1
"RTN","SAMIUR",229,0)
 . . set SAMIRTN(cnt)="</tr>"_$CHAR(10,13)
"RTN","SAMIUR",230,0)
 . . set rows=rows+1
"RTN","SAMIUR",231,0)
 . . quit
"RTN","SAMIUR",232,0)
 . quit
"RTN","SAMIUR",233,0)
 ;
"RTN","SAMIUR",234,0)
 set cnt=cnt+1
"RTN","SAMIUR",235,0)
 set SAMIRTN(cnt)="<tr><td>Total: "_rows_"</td></tr>"
"RTN","SAMIUR",236,0)
 set SAMIRTN(totcnt)="<td>Total: "_rows_"</td></tr><tr>"
"RTN","SAMIUR",237,0)
 ;
"RTN","SAMIUR",238,0)
 set cnt=cnt+1 set SAMIRTN(cnt)="</tbody>"
"RTN","SAMIUR",239,0)
 for  do  quit:temp(ii)["</tbody>"  ;
"RTN","SAMIUR",240,0)
 . set ii=$order(temp(ii))
"RTN","SAMIUR",241,0)
 . quit:temp(ii)["</tbody>"
"RTN","SAMIUR",242,0)
 . ; skip past template headers & blank body
"RTN","SAMIUR",243,0)
 . quit
"RTN","SAMIUR",244,0)
 ;
"RTN","SAMIUR",245,0)
 for  do  quit:'ii  ;
"RTN","SAMIUR",246,0)
 . set ii=$order(temp(ii))
"RTN","SAMIUR",247,0)
 . quit:'ii
"RTN","SAMIUR",248,0)
 . set cnt=cnt+1
"RTN","SAMIUR",249,0)
 . set ln=$get(temp(ii))
"RTN","SAMIUR",250,0)
 . new samikey,si
"RTN","SAMIUR",251,0)
 . set (samikey,si)=""
"RTN","SAMIUR",252,0)
 . do LOAD^SAMIFORM(.ln,samikey,si,.filter)
"RTN","SAMIUR",253,0)
 . set SAMIRTN(cnt)=ln
"RTN","SAMIUR",254,0)
 . quit
"RTN","SAMIUR",255,0)
 ;
"RTN","SAMIUR",256,0)
 quit  ; end of WSREPORT
"RTN","SAMIUR",257,0)
 ;
"RTN","SAMIUR",258,0)
 ;
"RTN","SAMIUR",259,0)
SORT(SRTN,SAMIPATS,FILTER) ; sort patients by name
"RTN","SAMIUR",260,0)
 ;
"RTN","SAMIUR",261,0)
 ;@called-by
"RTN","SAMIUR",262,0)
 ; WSREPORT
"RTN","SAMIUR",263,0)
 ;@calls
"RTN","SAMIUR",264,0)
 ; $$UPCASE^XLFMSMT
"RTN","SAMIUR",265,0)
 ;
"RTN","SAMIUR",266,0)
 new typ set typ=$get(FILTER("sort"))
"RTN","SAMIUR",267,0)
 ;
"RTN","SAMIUR",268,0)
 if typ="" set typ="name"
"RTN","SAMIUR",269,0)
 new iz,dt,dfn,nm,cdate
"RTN","SAMIUR",270,0)
 set (dt,dfn,nm)="" ; note: should dfn be initialized inside loop?
"RTN","SAMIUR",271,0)
 set iz=0
"RTN","SAMIUR",272,0)
 ;
"RTN","SAMIUR",273,0)
 new indx
"RTN","SAMIUR",274,0)
 for  do  quit:'dt  ;
"RTN","SAMIUR",275,0)
 . set dt=$order(SAMIPATS(dt))
"RTN","SAMIUR",276,0)
 . quit:'dt
"RTN","SAMIUR",277,0)
 . ; note: dfn not re-initialized to "" here; should it be?
"RTN","SAMIUR",278,0)
 . for  do  quit:'dfn  ;
"RTN","SAMIUR",279,0)
 . . set dfn=$order(SAMIPATS(dt,dfn))
"RTN","SAMIUR",280,0)
 . . quit:'dfn
"RTN","SAMIUR",281,0)
 . . if typ="name" do  ;
"RTN","SAMIUR",282,0)
 . . . set nm=$get(SAMIPATS(dt,dfn,"name"))
"RTN","SAMIUR",283,0)
 . . . set nm=$$UPCASE^XLFMSMT(nm)
"RTN","SAMIUR",284,0)
 . . . if nm="" set nm=" "
"RTN","SAMIUR",285,0)
 . . . set indx(nm,dt,dfn)=""
"RTN","SAMIUR",286,0)
 . . . quit
"RTN","SAMIUR",287,0)
 . . if typ="cdate" do  ;
"RTN","SAMIUR",288,0)
 . . . set cdate=$$LDOC^SAMIUR2(dt,dfn,.SAMIPATS)
"RTN","SAMIUR",289,0)
 . . . set cdate=$$FMDT^SAMIUR2(cdate)
"RTN","SAMIUR",290,0)
 . . . set indx(cdate,dt,dfn)=""
"RTN","SAMIUR",291,0)
 . . quit
"RTN","SAMIUR",292,0)
 . quit
"RTN","SAMIUR",293,0)
 ;
"RTN","SAMIUR",294,0)
 new iiz set iiz=""
"RTN","SAMIUR",295,0)
 set (dt,dfn)="" ; note: here, too, should inits be inside loops?
"RTN","SAMIUR",296,0)
 for  do  quit:iiz=""  ;
"RTN","SAMIUR",297,0)
 . set iiz=$order(indx(iiz))
"RTN","SAMIUR",298,0)
 . quit:iiz=""
"RTN","SAMIUR",299,0)
 . for  do  quit:dt=""  ;
"RTN","SAMIUR",300,0)
 . . set dt=$order(indx(iiz,dt))
"RTN","SAMIUR",301,0)
 . . quit:dt=""
"RTN","SAMIUR",302,0)
 . . for  do  quit:dfn=""  ;
"RTN","SAMIUR",303,0)
 . . . set dfn=$order(indx(iiz,dt,dfn))
"RTN","SAMIUR",304,0)
 . . . quit:dfn=""
"RTN","SAMIUR",305,0)
 . . . set iz=iz+1
"RTN","SAMIUR",306,0)
 . . . set SRTN(iz,dt,dfn)=iiz
"RTN","SAMIUR",307,0)
 . . . quit
"RTN","SAMIUR",308,0)
 . . quit
"RTN","SAMIUR",309,0)
 . quit
"RTN","SAMIUR",310,0)
 ;
"RTN","SAMIUR",311,0)
 quit  ; end of SORT
"RTN","SAMIUR",312,0)
 ;
"RTN","SAMIUR",313,0)
 ;
"RTN","SAMIUR",314,0)
 ;
"RTN","SAMIUR",315,0)
NUHREF(SAMIPATS) ; create nuhref link to casereview for all patients
"RTN","SAMIUR",316,0)
 ;
"RTN","SAMIUR",317,0)
 ;@called-by
"RTN","SAMIUR",318,0)
 ; WSREPORT
"RTN","SAMIUR",319,0)
 ;@calls
"RTN","SAMIUR",320,0)
 ; $$setroot^%wd
"RTN","SAMIUR",321,0)
 ; $$GETSSN^SAMIFORM
"RTN","SAMIUR",322,0)
 ;
"RTN","SAMIUR",323,0)
 new ij
"RTN","SAMIUR",324,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR",325,0)
 set ij=0
"RTN","SAMIUR",326,0)
 for  do  quit:'ij  ;
"RTN","SAMIUR",327,0)
 . set ij=$order(SAMIPATS(ij))
"RTN","SAMIUR",328,0)
 . quit:'ij
"RTN","SAMIUR",329,0)
 . new ij2 set ij2=0
"RTN","SAMIUR",330,0)
 . for  do  quit:'ij2  ;
"RTN","SAMIUR",331,0)
 . . set ij2=$order(SAMIPATS(ij,ij2))
"RTN","SAMIUR",332,0)
 . . quit:'ij2
"RTN","SAMIUR",333,0)
 . . ;
"RTN","SAMIUR",334,0)
 . . new dfn set dfn=ij2
"RTN","SAMIUR",335,0)
 . . set SAMIPATS(ij,dfn,"sid")=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR",336,0)
 . . set SAMIPATS(ij,dfn,"name")=$get(@root@(dfn,"saminame"))
"RTN","SAMIUR",337,0)
 . . ;
"RTN","SAMIUR",338,0)
 . . new sid set sid=SAMIPATS(ij,dfn,"sid")
"RTN","SAMIUR",339,0)
 . . set SAMIPATS(ij,dfn,"ssn")=$$GETSSN^SAMIFORM(sid)
"RTN","SAMIUR",340,0)
 . . new name set name=SAMIPATS(ij,dfn,"name")
"RTN","SAMIUR",341,0)
 . . ;
"RTN","SAMIUR",342,0)
 . . new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMIUR",343,0)
 . . set nuhref=nuhref_"<input type=hidden name=""samiroute"" value=""casereview"">"
"RTN","SAMIUR",344,0)
 . . set nuhref=nuhref_"<input type=hidden name=""studyid"" value="_sid_">"
"RTN","SAMIUR",345,0)
 . . set nuhref=nuhref_"<input value="""_name_""" class=""btn btn-link"" role=""link"" type=""submit""></form>"
"RTN","SAMIUR",346,0)
 . . set SAMIPATS(ij,dfn,"nuhref")=nuhref
"RTN","SAMIUR",347,0)
 . . quit
"RTN","SAMIUR",348,0)
 . quit
"RTN","SAMIUR",349,0)
 ;
"RTN","SAMIUR",350,0)
 quit  ; end of NUHREF
"RTN","SAMIUR",351,0)
 ;
"RTN","SAMIUR",352,0)
 ;
"RTN","SAMIUR",353,0)
 ;
"RTN","SAMIUR",354,0)
PNAME(type,phrase) ; page name for report
"RTN","SAMIUR",355,0)
 ;
"RTN","SAMIUR",356,0)
 ;@called-by
"RTN","SAMIUR",357,0)
 ; WSREPORT
"RTN","SAMIUR",358,0)
 ;@calls none
"RTN","SAMIUR",359,0)
 ;
"RTN","SAMIUR",360,0)
 ; extrinsic returns the PAGE NAME for the report
"RTN","SAMIUR",361,0)
 ;
"RTN","SAMIUR",362,0)
 ; if type="followup" quit "Followup next 30 days -"_$get(phrase)
"RTN","SAMIUR",363,0)
 if type="followup" quit "Followup "_$get(phrase)
"RTN","SAMIUR",364,0)
 ; if type="activity" quit "Activity last 30 days -"_$get(phrase)
"RTN","SAMIUR",365,0)
 if type="activity" quit "Activity "_$get(phrase)
"RTN","SAMIUR",366,0)
 if type="missingct" quit "Intake but no CT Evaluation"_$get(phrase)
"RTN","SAMIUR",367,0)
 if type="incomplete" quit "Incomplete Forms"_$get(phrase)
"RTN","SAMIUR",368,0)
 if type="outreach" quit "Outreach"_$get(phrase)
"RTN","SAMIUR",369,0)
 if type="enrollment" quit "Enrollment"_$get(phrase)
"RTN","SAMIUR",370,0)
 if type="inactive" quit "Inactive"_$get(phrase)
"RTN","SAMIUR",371,0)
 ;
"RTN","SAMIUR",372,0)
 quit "" ; end of $$PNAME
"RTN","SAMIUR",373,0)
 ;
"RTN","SAMIUR",374,0)
 ;
"RTN","SAMIUR",375,0)
 ;
"RTN","SAMIUR",376,0)
 ;@section 2 select subroutines
"RTN","SAMIUR",377,0)
 ;
"RTN","SAMIUR",378,0)
 ;
"RTN","SAMIUR",379,0)
 ;
"RTN","SAMIUR",380,0)
SELECT(SAMIPATS,ztype,datephrase,filter) ; select patients for report
"RTN","SAMIUR",381,0)
 ;
"RTN","SAMIUR",382,0)
 ;@called-by
"RTN","SAMIUR",383,0)
 ; WSREPORT
"RTN","SAMIUR",384,0)
 ;@calls
"RTN","SAMIUR",385,0)
 ; UNMAT
"RTN","SAMIUR",386,0)
 ; WKLIST
"RTN","SAMIUR",387,0)
 ; $$KEY2FM^SAMICASE
"RTN","SAMIUR",388,0)
 ; $$NOW^XLFDT
"RTN","SAMIUR",389,0)
 ; $$FMADD^XLFDT
"RTN","SAMIUR",390,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMIUR",391,0)
 ; $$setroot^%wd
"RTN","SAMIUR",392,0)
 ; GETITEMS^SAMICASE
"RTN","SAMIUR",393,0)
 ;
"RTN","SAMIUR",394,0)
 ; merge ^gpl("select")=filter
"RTN","SAMIUR",395,0)
 new type set type=ztype
"RTN","SAMIUR",396,0)
 if type="unmatched" do  quit  ;
"RTN","SAMIUR",397,0)
 . do UNMAT(.SAMIPATS,ztype,.datephrase,.filter)
"RTN","SAMIUR",398,0)
 . quit
"RTN","SAMIUR",399,0)
 if type="worklist" do  quit  ;
"RTN","SAMIUR",400,0)
 . do WKLIST(.SAMIPATS,ztype,.datephrase,.filter)
"RTN","SAMIUR",401,0)
 . quit
"RTN","SAMIUR",402,0)
 if $get(type)="" set type="enrollment"
"RTN","SAMIUR",403,0)
 if type="cumpy" set type="enrollment"
"RTN","SAMIUR",404,0)
 new site set site=$get(filter("siteid"))
"RTN","SAMIUR",405,0)
 ;
"RTN","SAMIUR",406,0)
 new strdt,enddt,fmstrdt,fmenddt
"RTN","SAMIUR",407,0)
 set strdt=$get(filter("start-date"))
"RTN","SAMIUR",408,0)
 set fmstrdt=$$KEY2FM^SAMICASE(strdt)
"RTN","SAMIUR",409,0)
 if fmstrdt=-1 do  ;
"RTN","SAMIUR",410,0)
 . set fmstrdt=2000101
"RTN","SAMIUR",411,0)
 . if type="followup" set fmstrdt=$$NOW^XLFDT
"RTN","SAMIUR",412,0)
 . if type="activity" set fmstrdt=$$FMADD^XLFDT($$NOW^XLFDT,-31)
"RTN","SAMIUR",413,0)
 . quit
"RTN","SAMIUR",414,0)
 if strdt="" set filter("start-date")=$$VAPALSDT^SAMICASE(fmstrdt)
"RTN","SAMIUR",415,0)
 ;
"RTN","SAMIUR",416,0)
 set enddt=$get(filter("end-date"))
"RTN","SAMIUR",417,0)
 set fmenddt=$$KEY2FM^SAMICASE(enddt)
"RTN","SAMIUR",418,0)
 if fmenddt=-1 do  ;
"RTN","SAMIUR",419,0)
 . set fmenddt=$$NOW^XLFDT
"RTN","SAMIUR",420,0)
 . if type="followup" set fmenddt=$$FMADD^XLFDT($$NOW^XLFDT,31)
"RTN","SAMIUR",421,0)
 . quit
"RTN","SAMIUR",422,0)
 if enddt="" set filter("end-date")=$$VAPALSDT^SAMICASE(fmenddt)
"RTN","SAMIUR",423,0)
 ;
"RTN","SAMIUR",424,0)
 set datephrase=""
"RTN","SAMIUR",425,0)
 new zi set zi=0
"RTN","SAMIUR",426,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR",427,0)
 ;
"RTN","SAMIUR",428,0)
 for  do  quit:'zi  ;
"RTN","SAMIUR",429,0)
 . set zi=$order(@root@(zi))
"RTN","SAMIUR",430,0)
 . quit:'zi
"RTN","SAMIUR",431,0)
 . ;
"RTN","SAMIUR",432,0)
 . new sid set sid=$get(@root@(zi,"samistudyid"))
"RTN","SAMIUR",433,0)
 . quit:sid=""
"RTN","SAMIUR",434,0)
 . quit:$extract(sid,1,3)'=site
"RTN","SAMIUR",435,0)
 . ;
"RTN","SAMIUR",436,0)
 . new items set items=""
"RTN","SAMIUR",437,0)
 . do GETITEMS^SAMICASE("items",sid)
"RTN","SAMIUR",438,0)
 . quit:'$data(items)
"RTN","SAMIUR",439,0)
 . ;
"RTN","SAMIUR",440,0)
 . new efmdate,edate,siform,ceform,cefud,fmcefud,cedos,fmcedos
"RTN","SAMIUR",441,0)
 . set siform=$order(items("siform-"))
"RTN","SAMIUR",442,0)
 . new status set status=$get(@root@("graph",sid,siform,"sistatus"))
"RTN","SAMIUR",443,0)
 . if type="inactive",status="active" quit  ; for inactive report
"RTN","SAMIUR",444,0)
 . if type'="inactive",status'="active" quit  ; for other reports
"RTN","SAMIUR",445,0)
 . ;
"RTN","SAMIUR",446,0)
 . set ceform=$order(items("ceform-a"),-1)
"RTN","SAMIUR",447,0)
 . set (cefud,fmcefud,cedos,fmcedos)=""
"RTN","SAMIUR",448,0)
 . if ceform'="" do  ;
"RTN","SAMIUR",449,0)
 . . set cefud=$get(@root@("graph",sid,ceform,"cefud"))
"RTN","SAMIUR",450,0)
 . . if cefud'="" set fmcefud=$$KEY2FM^SAMICASE(cefud)
"RTN","SAMIUR",451,0)
 . . set cedos=$get(@root@("graph",sid,ceform,"cedos"))
"RTN","SAMIUR",452,0)
 . . if cedos'="" set fmcedos=$$KEY2FM^SAMICASE(cedos)
"RTN","SAMIUR",453,0)
 . . quit
"RTN","SAMIUR",454,0)
 . ;
"RTN","SAMIUR",455,0)
 . set edate=$get(@root@("graph",sid,siform,"sidc"))
"RTN","SAMIUR",456,0)
 . if edate="" set edate=$get(@root@("graph",sid,siform,"samicreatedate"))
"RTN","SAMIUR",457,0)
 . set efmdate=$$KEY2FM^SAMICASE(edate)
"RTN","SAMIUR",458,0)
 . set edate=$$VAPALSDT^SAMICASE(efmdate)
"RTN","SAMIUR",459,0)
 . ;
"RTN","SAMIUR",460,0)
 . ;
"RTN","SAMIUR",461,0)
 . if type="followup" do  ;
"RTN","SAMIUR",462,0)
 . . ; new nplus30 set nplus30=$$FMADD^XLFDT($$NOW^XLFDT,31)
"RTN","SAMIUR",463,0)
 . . if +fmcefud<fmstrdt quit  ; before start date
"RTN","SAMIUR",464,0)
 . . if +fmcefud<(fmenddt+1) do  ; before end date
"RTN","SAMIUR",465,0)
 . . . quit:ceform=""  ; no ct eval so no followup date
"RTN","SAMIUR",466,0)
 . . . set SAMIPATS(fmcefud,zi,"edate")=edate
"RTN","SAMIUR",467,0)
 . . . set SAMIPATS(fmcefud,zi)=""
"RTN","SAMIUR",468,0)
 . . . if ceform="" set cefud="baseline"
"RTN","SAMIUR",469,0)
 . . . set SAMIPATS(fmcefud,zi,"cefud")=cefud
"RTN","SAMIUR",470,0)
 . . . set SAMIPATS(fmcefud,zi,"cedos")=cedos
"RTN","SAMIUR",471,0)
 . . . set SAMIPATS(fmcefud,zi,"ceform")=ceform
"RTN","SAMIUR",472,0)
 . . . set SAMIPATS(fmcefud,zi,"ceform-vals")=$name(@root@("graph",sid,ceform))
"RTN","SAMIUR",473,0)
 . . . set SAMIPATS(fmcefud,zi,"siform")=siform
"RTN","SAMIUR",474,0)
 . . . set SAMIPATS(fmcefud,zi,"siform-vals")=$name(@root@("graph",sid,siform))
"RTN","SAMIUR",475,0)
 . . . merge SAMIPATS(fmcefud,zi,"items")=items
"RTN","SAMIUR",476,0)
 . . . quit
"RTN","SAMIUR",477,0)
 . . set datephrase=" before "_$$VAPALSDT^SAMICASE(fmenddt)
"RTN","SAMIUR",478,0)
 . . quit
"RTN","SAMIUR",479,0)
 . ;
"RTN","SAMIUR",480,0)
 . if type="activity" do  ;
"RTN","SAMIUR",481,0)
 . . ; new nminus30 set nminus30=$$FMADD^XLFDT($$NOW^XLFDT,-31)
"RTN","SAMIUR",482,0)
 . . new anyform set anyform=$order(items("sort",""),-1)
"RTN","SAMIUR",483,0)
 . . new fmanyform set fmanyform=$$KEY2FM^SAMICASE(anyform)
"RTN","SAMIUR",484,0)
 . . if fmanyform<fmstrdt quit  ; before the start date
"RTN","SAMIUR",485,0)
 . . ; if fmanyform<(fmenddt+1)!(efmdate>fmenddt) do  ; need any new form
"RTN","SAMIUR",486,0)
 . . if fmanyform<(fmenddt+1)  do  ;
"RTN","SAMIUR",487,0)
 . . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",488,0)
 . . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",489,0)
 . . . if ceform="" set cefud="baseline"
"RTN","SAMIUR",490,0)
 . . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",491,0)
 . . . set SAMIPATS(efmdate,zi,"cedos")=cedos
"RTN","SAMIUR",492,0)
 . . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",493,0)
 . . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",494,0)
 . . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",495,0)
 . . . quit
"RTN","SAMIUR",496,0)
 . . set datephrase=" after "_$$VAPALSDT^SAMICASE(fmstrdt)
"RTN","SAMIUR",497,0)
 . . quit
"RTN","SAMIUR",498,0)
 . ;
"RTN","SAMIUR",499,0)
 . ; date filter for all the rest of the reports
"RTN","SAMIUR",500,0)
 . ;
"RTN","SAMIUR",501,0)
 . quit:efmdate<fmstrdt  ; before the start date
"RTN","SAMIUR",502,0)
 . quit:efmdate>(fmenddt+1)  ; after the end date
"RTN","SAMIUR",503,0)
 . ;
"RTN","SAMIUR",504,0)
 . if type="incomplete" do  ;
"RTN","SAMIUR",505,0)
 . . new complete set complete=1
"RTN","SAMIUR",506,0)
 . . new zj set zj=""
"RTN","SAMIUR",507,0)
 . . new gr set gr=$name(@root@("graph",sid))
"RTN","SAMIUR",508,0)
 . . for  do  quit:zj=""  ;
"RTN","SAMIUR",509,0)
 . . . set zj=$order(@gr@(zj))
"RTN","SAMIUR",510,0)
 . . . quit:zj=""
"RTN","SAMIUR",511,0)
 . . . if $get(@gr@(zj,"samistatus"))="incomplete" do  ;
"RTN","SAMIUR",512,0)
 . . . . set complete=0
"RTN","SAMIUR",513,0)
 . . . . set SAMIPATS(efmdate,zi,"iform")=$get(SAMIPATS(efmdate,zi,"iform"))_" "_zj
"RTN","SAMIUR",514,0)
 . . . . quit
"RTN","SAMIUR",515,0)
 . . . quit
"RTN","SAMIUR",516,0)
 . . ;
"RTN","SAMIUR",517,0)
 . . if complete=0 do  ; has incomplete form(s) 
"RTN","SAMIUR",518,0)
 . . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",519,0)
 . . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",520,0)
 . . . if ceform="" set cefud="baseline"
"RTN","SAMIUR",521,0)
 . . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",522,0)
 . . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",523,0)
 . . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",524,0)
 . . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",525,0)
 . . . quit
"RTN","SAMIUR",526,0)
 . . set datephrase=""
"RTN","SAMIUR",527,0)
 . . quit
"RTN","SAMIUR",528,0)
 . ;
"RTN","SAMIUR",529,0)
 . if type="missingct" do  ;
"RTN","SAMIUR",530,0)
 . . if ceform="" do  ; has incomplete form(s) 
"RTN","SAMIUR",531,0)
 . . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",532,0)
 . . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",533,0)
 . . . if ceform="" set cefud="baseline"
"RTN","SAMIUR",534,0)
 . . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",535,0)
 . . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",536,0)
 . . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",537,0)
 . . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",538,0)
 . . . quit
"RTN","SAMIUR",539,0)
 . . set datephrase=""
"RTN","SAMIUR",540,0)
 . . quit
"RTN","SAMIUR",541,0)
 . ;
"RTN","SAMIUR",542,0)
 . if type="outreach" do  ; no-op; hook for future development?
"RTN","SAMIUR",543,0)
 . . quit
"RTN","SAMIUR",544,0)
 . ;
"RTN","SAMIUR",545,0)
 . if type="enrollment" do  ;
"RTN","SAMIUR",546,0)
 . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",547,0)
 . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",548,0)
 . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",549,0)
 . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",550,0)
 . . set SAMIPATS(efmdate,zi,"cedos")=cedos
"RTN","SAMIUR",551,0)
 . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",552,0)
 . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",553,0)
 . . quit
"RTN","SAMIUR",554,0)
 . ;
"RTN","SAMIUR",555,0)
 . if type="inactive" do  ;
"RTN","SAMIUR",556,0)
 . . set SAMIPATS(efmdate,zi,"edate")=edate
"RTN","SAMIUR",557,0)
 . . set SAMIPATS(efmdate,zi)=""
"RTN","SAMIUR",558,0)
 . . set SAMIPATS(efmdate,zi,"cefud")=cefud
"RTN","SAMIUR",559,0)
 . . set SAMIPATS(efmdate,zi,"ceform")=ceform
"RTN","SAMIUR",560,0)
 . . set SAMIPATS(efmdate,zi,"cedos")=cedos
"RTN","SAMIUR",561,0)
 . . set SAMIPATS(efmdate,zi,"siform")=siform
"RTN","SAMIUR",562,0)
 . . merge SAMIPATS(efmdate,zi,"items")=items
"RTN","SAMIUR",563,0)
 . . quit
"RTN","SAMIUR",564,0)
 . ;
"RTN","SAMIUR",565,0)
 . set datephrase=" as of "_$$VAPALSDT^SAMICASE($$NOW^XLFDT)
"RTN","SAMIUR",566,0)
 . quit
"RTN","SAMIUR",567,0)
 ;
"RTN","SAMIUR",568,0)
 quit  ; end of SELECT
"RTN","SAMIUR",569,0)
 ;
"RTN","SAMIUR",570,0)
 ;
"RTN","SAMIUR",571,0)
 ;
"RTN","SAMIUR",572,0)
UNMAT(SAMIPATS,ztype,datephrase,filter) ; build unmatched persons list
"RTN","SAMIUR",573,0)
 ;
"RTN","SAMIUR",574,0)
 ;@called-by
"RTN","SAMIUR",575,0)
 ; SELECT
"RTN","SAMIUR",576,0)
 ;@calls
"RTN","SAMIUR",577,0)
 ; $$setroot^%wd
"RTN","SAMIUR",578,0)
 ;
"RTN","SAMIUR",579,0)
 set datephrase="Unmatched Persons"
"RTN","SAMIUR",580,0)
 new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIUR",581,0)
 new dfn set dfn=9000000
"RTN","SAMIUR",582,0)
 for  do  quit:'dfn  ;
"RTN","SAMIUR",583,0)
 . set dfn=$order(@lroot@("dfn",dfn))
"RTN","SAMIUR",584,0)
 . quit:'dfn
"RTN","SAMIUR",585,0)
 . ;
"RTN","SAMIUR",586,0)
 . new ien set ien=$order(@lroot@("dfn",dfn,""))
"RTN","SAMIUR",587,0)
 . quit:ien=""
"RTN","SAMIUR",588,0)
 . n ordern
"RTN","SAMIUR",589,0)
 . s ordern=$g(@lroot@(ien,"ORMORCordernumber"))
"RTN","SAMIUR",590,0)
 . i ordern="" s ordern=$g(@lroot@(ien,"ORM",1,"ordernumber"))
"RTN","SAMIUR",591,0)
 . i ordern'="" q  ;
"RTN","SAMIUR",592,0)
 . i $g(@lroot@(ien,"siteid"))'[site q  ;
"RTN","SAMIUR",593,0)
 . ;quit:$get(@lroot@(ien,"remotedfn"))'=""  ;
"RTN","SAMIUR",594,0)
 . ;
"RTN","SAMIUR",595,0)
 . merge SAMIPATS(ien,dfn)=@lroot@(ien)
"RTN","SAMIUR",596,0)
 . ;
"RTN","SAMIUR",597,0)
 . new name set name=$get(SAMIPATS(ien,dfn,"saminame"))
"RTN","SAMIUR",598,0)
 . ; new name set name=$get(SAMIPATS(ien,dfn,"sinamef"))
"RTN","SAMIUR",599,0)
 . ; set name=name_","_SAMIPATS(ien,dfn,"sinamel")
"RTN","SAMIUR",600,0)
 . new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMIUR",601,0)
 . set nuhref=nuhref_"<input type=hidden name=""samiroute"" value=""editperson"">"
"RTN","SAMIUR",602,0)
 . set nuhref=nuhref_"<input type=hidden name=""dfn"" value="_dfn_">"
"RTN","SAMIUR",603,0)
 . set nuhref=nuhref_"<input type=hidden name=""siteid"" value="_site_">"
"RTN","SAMIUR",604,0)
 . set nuhref=nuhref_"<input value="""_name_""" class=""btn btn-link"" role=""link"" type=""submit""></form>"
"RTN","SAMIUR",605,0)
 . set SAMIPATS(ien,dfn,"editref")=nuhref
"RTN","SAMIUR",606,0)
 . quit
"RTN","SAMIUR",607,0)
 ;
"RTN","SAMIUR",608,0)
 quit  ; end of UNMAT
"RTN","SAMIUR",609,0)
 ;
"RTN","SAMIUR",610,0)
 ;
"RTN","SAMIUR",611,0)
 ;
"RTN","SAMIUR",612,0)
WKLIST(SAMIPATS,ztype,datephrase,filter) ; build work list
"RTN","SAMIUR",613,0)
 ;
"RTN","SAMIUR",614,0)
 ;@called-by
"RTN","SAMIUR",615,0)
 ; SELECT
"RTN","SAMIUR",616,0)
 ;@calls
"RTN","SAMIUR",617,0)
 ; $$setroot^%wd
"RTN","SAMIUR",618,0)
 ;
"RTN","SAMIUR",619,0)
 ; add site
"RTN","SAMIUR",620,0)
 ; add compare to vapals-patients
"RTN","SAMIUR",621,0)
 ; add navigation to enrollment
"RTN","SAMIUR",622,0)
 ;
"RTN","SAMIUR",623,0)
 kill ^gpl("worklist")
"RTN","SAMIUR",624,0)
 merge ^gpl("worklist")=filter
"RTN","SAMIUR",625,0)
 new site
"RTN","SAMIUR",626,0)
 set site=$get(filter("siteid"))
"RTN","SAMIUR",627,0)
 quit:site=""
"RTN","SAMIUR",628,0)
 set datephrase="Work List"
"RTN","SAMIUR",629,0)
 new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIUR",630,0)
 new proot set proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR",631,0)
 ;
"RTN","SAMIUR",632,0)
 new dfn set dfn=0
"RTN","SAMIUR",633,0)
 for  set dfn=$order(@lroot@("dfn",dfn)) quit:+dfn=0  do  ;
"RTN","SAMIUR",634,0)
 . quit:$order(@proot@("dfn",dfn,""))'=""
"RTN","SAMIUR",635,0)
 . new ien set ien=$order(@lroot@("dfn",dfn,""))
"RTN","SAMIUR",636,0)
 . quit:ien=""
"RTN","SAMIUR",637,0)
 . ;
"RTN","SAMIUR",638,0)
 . ; write !,"dfn= ",dfn
"RTN","SAMIUR",639,0)
 . ; zwrite @lroot@(ien,*)
"RTN","SAMIUR",640,0)
 . ;
"RTN","SAMIUR",641,0)
 . quit:$get(@lroot@(ien,"siteid"))'=site
"RTN","SAMIUR",642,0)
 . ;
"RTN","SAMIUR",643,0)
 . merge ^gpl("worklist","lroot",ien)=@lroot@(ien)
"RTN","SAMIUR",644,0)
 . merge SAMIPATS(ien,dfn)=@lroot@(ien)
"RTN","SAMIUR",645,0)
 . new name set name=$get(SAMIPATS(ien,dfn,"saminame"))
"RTN","SAMIUR",646,0)
 . ; new name set name=$get(SAMIPATS(ien,dfn,"sinamef"))
"RTN","SAMIUR",647,0)
 . ; set name=name_","_SAMIPATS(ien,dfn,"sinamel")
"RTN","SAMIUR",648,0)
 . new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMIUR",649,0)
 . set nuhref=nuhref_"<input type=hidden name=""samiroute"" value=""newcase"">"
"RTN","SAMIUR",650,0)
 . set nuhref=nuhref_"<input type=hidden name=""dfn"" value="_dfn_">"
"RTN","SAMIUR",651,0)
 . set nuhref=nuhref_"<input type=hidden name=""siteid"" value="_site_">"
"RTN","SAMIUR",652,0)
 . set nuhref=nuhref_"<input value="""_name_""" class=""btn btn-link"" role=""link"" type=""submit""></form>"
"RTN","SAMIUR",653,0)
 . set SAMIPATS(ien,dfn,"workref")=nuhref
"RTN","SAMIUR",654,0)
 . quit
"RTN","SAMIUR",655,0)
 ;
"RTN","SAMIUR",656,0)
 merge ^gpl("worklist","pats")=SAMIPATS
"RTN","SAMIUR",657,0)
 ;
"RTN","SAMIUR",658,0)
 quit  ; end of WKLIST
"RTN","SAMIUR",659,0)
 ;
"RTN","SAMIUR",660,0)
 ;
"RTN","SAMIUR",661,0)
 ;
"RTN","SAMIUR",662,0)
EOR ; end of SAMIUR
"RTN","SAMIUR2")
0^21^B1203305457
"RTN","SAMIUR2",1,0)
SAMIUR2 ;ven/gpl - user reports cont ;2021-07-13t00:02z
"RTN","SAMIUR2",2,0)
 ;;18.0;SAMI;**5,11,12**;2020-01;Build 6
"RTN","SAMIUR2",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIUR2",4,0)
 ;
"RTN","SAMIUR2",5,0)
 ; SAMIUR2 contains subroutines for creating & implementing the
"RTN","SAMIUR2",6,0)
 ; report-definition table.
"RTN","SAMIUR2",7,0)
 ;
"RTN","SAMIUR2",8,0)
 quit  ; no entry from top
"RTN","SAMIUR2",9,0)
 ;
"RTN","SAMIUR2",10,0)
 ;
"RTN","SAMIUR2",11,0)
 ;
"RTN","SAMIUR2",12,0)
 ;@section 0 primary development
"RTN","SAMIUR2",13,0)
 ;
"RTN","SAMIUR2",14,0)
 ;
"RTN","SAMIUR2",15,0)
 ;
"RTN","SAMIUR2",16,0)
 ;@routine-credits
"RTN","SAMIUR2",17,0)
 ;@primary-dev George P. Lilly (gpl)
"RTN","SAMIUR2",18,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIUR2",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIUR2",20,0)
 ; http://vistaexpertise.net
"RTN","SAMIUR2",21,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIUR2",22,0)
 ;@license see routine SAMIUL
"RTN","SAMIUR2",23,0)
 ;
"RTN","SAMIUR2",24,0)
 ;@last-updated 2021-07-13t00:02z
"RTN","SAMIUR2",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIUR2",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIUR2",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIUR2",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIUR2",29,0)
 ;@release-date 2020-01
"RTN","SAMIUR2",30,0)
 ;@patch-list **5,11,12**
"RTN","SAMIUR2",31,0)
 ;
"RTN","SAMIUR2",32,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIUR2",33,0)
 ; toad@vistaexpertise.net
"RTN","SAMIUR2",34,0)
 ;@additional-dev Larry G. Carlson (lgc)
"RTN","SAMIUR2",35,0)
 ; larry.g.carlson@gmail.com
"RTN","SAMIUR2",36,0)
 ;@additional-dev Alexis R. Carlson (arc)
"RTN","SAMIUR2",37,0)
 ; whatisthehumanspirit@gmail.com
"RTN","SAMIUR2",38,0)
 ;@additional-dev Kenneth McGlothlen (mcglk)
"RTN","SAMIUR2",39,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIUR2",40,0)
 ;
"RTN","SAMIUR2",41,0)
 ;@module-credits see SAMIHUL
"RTN","SAMIUR2",42,0)
 ;
"RTN","SAMIUR2",43,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIUR2",44,0)
 ; see SAMIURUL
"RTN","SAMIUR2",45,0)
 ;
"RTN","SAMIUR2",46,0)
 ;@contents
"RTN","SAMIUR2",47,0)
 ; RPTTBL build report-definition table
"RTN","SAMIUR2",48,0)
 ;
"RTN","SAMIUR2",49,0)
 ; $$DFN2SID study id for patient DFN
"RTN","SAMIUR2",50,0)
 ; $$MKNAV html for navigation to form
"RTN","SAMIUR2",51,0)
 ;
"RTN","SAMIUR2",52,0)
 ; $$SHDET table contents for smoking history
"RTN","SAMIUR2",53,0)
 ; CUMPY forms array of cummulative pack year data
"RTN","SAMIUR2",54,0)
 ; $$FMDT convert date to fileman format
"RTN","SAMIUR2",55,0)
 ; $$PKYDT pack-years from start & end & cigs/day
"RTN","SAMIUR2",56,0)
 ; $$PKY pack-years from years & packs/day
"RTN","SAMIUR2",57,0)
 ;
"RTN","SAMIUR2",58,0)
 ; $$AGE age
"RTN","SAMIUR2",59,0)
 ; $$BLINEDT baseline date
"RTN","SAMIUR2",60,0)
 ; $$CONTACT patient street address
"RTN","SAMIUR2",61,0)
 ; $$CTPROT ct protocol
"RTN","SAMIUR2",62,0)
 ; $$DOB date of birth
"RTN","SAMIUR2",63,0)
 ; $$FUDATE followup date
"RTN","SAMIUR2",64,0)
 ; $$GENDER gender
"RTN","SAMIUR2",65,0)
 ; $$IFORM name(s) of incomplete forms
"RTN","SAMIUR2",66,0)
 ; $$LASTEXM patient last exam
"RTN","SAMIUR2",67,0)
 ; $$MANPAT unmatched patient cell
"RTN","SAMIUR2",68,0)
 ; $$MATCH match button cell
"RTN","SAMIUR2",69,0)
 ; $$NAME name w/hyperlink
"RTN","SAMIUR2",70,0)
 ; $$PACKYRS smoking status
"RTN","SAMIUR2",71,0)
 ; $$POSSIBLE possible match cell
"RTN","SAMIUR2",72,0)
 ; $$RECOM recommendation
"RTN","SAMIUR2",73,0)
 ; $$RURAL patient's rural/urban status
"RTN","SAMIUR2",74,0)
 ; $$SID study id
"RTN","SAMIUR2",75,0)
 ; $$SMHIS smoking history cell
"RTN","SAMIUR2",76,0)
 ; $$SMKSTAT smoking status
"RTN","SAMIUR2",77,0)
 ; $$SSN social security number
"RTN","SAMIUR2",78,0)
 ; $$STUDYDT latest study date
"RTN","SAMIUR2",79,0)
 ; $$STUDYTYP latest study type
"RTN","SAMIUR2",80,0)
 ; $$VALS form-values cell
"RTN","SAMIUR2",81,0)
 ; $$WHEN followup text
"RTN","SAMIUR2",82,0)
 ; $$WORKPAT worklist patient name cell
"RTN","SAMIUR2",83,0)
 ;
"RTN","SAMIUR2",84,0)
 ; EPAT patient name w/nav to enrollment
"RTN","SAMIUR2",85,0)
 ; ETHNCTY ethnicity
"RTN","SAMIUR2",86,0)
 ; RACE race
"RTN","SAMIUR2",87,0)
 ; STATUS patient status
"RTN","SAMIUR2",88,0)
 ; WSVALS display form values from graph
"RTN","SAMIUR2",89,0)
 ;
"RTN","SAMIUR2",90,0)
 ;
"RTN","SAMIUR2",91,0)
 ;
"RTN","SAMIUR2",92,0)
 ;@section 1 ppi RPTTBL^SAMIUR2
"RTN","SAMIUR2",93,0)
 ;
"RTN","SAMIUR2",94,0)
 ;
"RTN","SAMIUR2",95,0)
 ;
"RTN","SAMIUR2",96,0)
RPTTBL(RPT,TYPE,SITE) ; RPT is passed by reference and returns the 
"RTN","SAMIUR2",97,0)
 ; report definition table. TYPE is the report type to be returned
"RTN","SAMIUR2",98,0)
 ; This routine could use a file or a graph in the next version
"RTN","SAMIUR2",99,0)
 ;
"RTN","SAMIUR2",100,0)
 ;;private;procedure;clean;silent;sac
"RTN","SAMIUR2",101,0)
 ;@called-by
"RTN","SAMIUR2",102,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",103,0)
 ; WSREPORT^SAMIUR1 (which then calls WSREPORT^SAMIUR)
"RTN","SAMIUR2",104,0)
 ;@calls none (defines calls for WSREPORT^SAMIUR to call)
"RTN","SAMIUR2",105,0)
 ;@input
"RTN","SAMIUR2",106,0)
 ; TYPE = report type to return
"RTN","SAMIUR2",107,0)
 ;@output
"RTN","SAMIUR2",108,0)
 ; .RPT report-definition table
"RTN","SAMIUR2",109,0)
 ;
"RTN","SAMIUR2",110,0)
 ; This routine could use a file or a graph in the next version
"RTN","SAMIUR2",111,0)
 ;
"RTN","SAMIUR2",112,0)
 if TYPE="followup" do  quit  ;
"RTN","SAMIUR2",113,0)
 . set RPT(1,"header")="F/U Date"
"RTN","SAMIUR2",114,0)
 . set RPT(1,"routine")="$$FUDATE^SAMIUR2"
"RTN","SAMIUR2",115,0)
 . set RPT(2,"header")="Name"
"RTN","SAMIUR2",116,0)
 . set RPT(2,"routine")="$$NAME^SAMIUR2"
"RTN","SAMIUR2",117,0)
 . ;set RPT(3,"header")="SSN"
"RTN","SAMIUR2",118,0)
 . set RPT(3,"header")=$$SSNLABEL(SITE)
"RTN","SAMIUR2",119,0)
 . set RPT(3,"routine")="$$SSN^SAMIUR2"
"RTN","SAMIUR2",120,0)
 . set RPT(4,"header")="Baseline Date"
"RTN","SAMIUR2",121,0)
 . set RPT(4,"routine")="$$BLINEDT^SAMIUR2"
"RTN","SAMIUR2",122,0)
 . set RPT(6,"header")="Recommend"
"RTN","SAMIUR2",123,0)
 . set RPT(6,"routine")="$$RECOM^SAMIUR2"
"RTN","SAMIUR2",124,0)
 . set RPT(7,"header")="When"
"RTN","SAMIUR2",125,0)
 . set RPT(7,"routine")="$$WHEN^SAMIUR2"
"RTN","SAMIUR2",126,0)
 . set RPT(5,"header")="Last Exam"
"RTN","SAMIUR2",127,0)
 . set RPT(5,"routine")="$$LASTEXM^SAMIUR2"
"RTN","SAMIUR2",128,0)
 . set RPT(8,"header")="Contact Information"
"RTN","SAMIUR2",129,0)
 . set RPT(8,"routine")="$$CONTACT^SAMIUR2"
"RTN","SAMIUR2",130,0)
 . quit
"RTN","SAMIUR2",131,0)
 ;
"RTN","SAMIUR2",132,0)
 if TYPE="activity" do  quit  ;
"RTN","SAMIUR2",133,0)
 . set RPT(1,"header")="Name"
"RTN","SAMIUR2",134,0)
 . set RPT(1,"routine")="$$NAME^SAMIUR2"
"RTN","SAMIUR2",135,0)
 . set RPT(2,"header")=$$SSNLABEL(SITE)
"RTN","SAMIUR2",136,0)
 . set RPT(2,"routine")="$$SSN^SAMIUR2"
"RTN","SAMIUR2",137,0)
 . set RPT(3,"header")="CT Date"
"RTN","SAMIUR2",138,0)
 . set RPT(3,"routine")="$$STUDYDT^SAMIUR2"
"RTN","SAMIUR2",139,0)
 . set RPT(4,"header")="Type"
"RTN","SAMIUR2",140,0)
 . set RPT(4,"routine")="$$STUDYTYP^SAMIUR2"
"RTN","SAMIUR2",141,0)
 . set RPT(5,"header")="CT Protocol"
"RTN","SAMIUR2",142,0)
 . set RPT(5,"routine")="$$CTPROT^SAMIUR2"
"RTN","SAMIUR2",143,0)
 . set RPT(6,"header")="Follow-up"
"RTN","SAMIUR2",144,0)
 . set RPT(6,"routine")="$$RECOM^SAMIUR2"
"RTN","SAMIUR2",145,0)
 . set RPT(7,"header")="When"
"RTN","SAMIUR2",146,0)
 . set RPT(7,"routine")="$$WHEN^SAMIUR2"
"RTN","SAMIUR2",147,0)
 . set RPT(8,"header")="on Date"
"RTN","SAMIUR2",148,0)
 . set RPT(8,"routine")="$$FUDATE^SAMIUR2"
"RTN","SAMIUR2",149,0)
 . quit
"RTN","SAMIUR2",150,0)
 ;
"RTN","SAMIUR2",151,0)
 if TYPE="enrollment" do  quit  ;
"RTN","SAMIUR2",152,0)
 . set RPT(1,"header")="Name"
"RTN","SAMIUR2",153,0)
 . set RPT(1,"routine")="$$NAME^SAMIUR2"
"RTN","SAMIUR2",154,0)
 . set RPT(2,"header")=$$SSNLABEL(SITE)
"RTN","SAMIUR2",155,0)
 . set RPT(2,"routine")="$$SSN^SAMIUR2"
"RTN","SAMIUR2",156,0)
 . set RPT(3,"header")="CT Date"
"RTN","SAMIUR2",157,0)
 . set RPT(3,"routine")="$$STUDYDT^SAMIUR2"
"RTN","SAMIUR2",158,0)
 . set RPT(4,"header")="Gender"
"RTN","SAMIUR2",159,0)
 . set RPT(4,"routine")="$$GENDER^SAMIUR2"
"RTN","SAMIUR2",160,0)
 . ; set RPT(5,"header")="Race"
"RTN","SAMIUR2",161,0)
 . ; set RPT(5,"routine")="$$RACE^SAMIUR2"
"RTN","SAMIUR2",162,0)
 . set RPT(6,"header")="Age"
"RTN","SAMIUR2",163,0)
 . set RPT(6,"routine")="$$AGE^SAMIUR2"
"RTN","SAMIUR2",164,0)
 . set RPT(7,"header")="Urban/Rural"
"RTN","SAMIUR2",165,0)
 . set RPT(7,"routine")="$$RURAL^SAMIUR2"
"RTN","SAMIUR2",166,0)
 . set RPT(8,"header")="Smoking Status"
"RTN","SAMIUR2",167,0)
 . set RPT(8,"routine")="$$SMKSTAT^SAMIUR2"
"RTN","SAMIUR2",168,0)
 . set RPT(9,"header")="Pack Years at Intake"
"RTN","SAMIUR2",169,0)
 . set RPT(9,"routine")="$$PACKYRS^SAMIUR2"
"RTN","SAMIUR2",170,0)
 . quit
"RTN","SAMIUR2",171,0)
 ;
"RTN","SAMIUR2",172,0)
 if TYPE="inactive" do  quit  ;
"RTN","SAMIUR2",173,0)
 . set RPT(1,"header")="Name"
"RTN","SAMIUR2",174,0)
 . set RPT(1,"routine")="$$NAME^SAMIUR2"
"RTN","SAMIUR2",175,0)
 . set RPT(2,"header")=$$SSNLABEL(SITE)
"RTN","SAMIUR2",176,0)
 . set RPT(2,"routine")="$$SSN^SAMIUR2"
"RTN","SAMIUR2",177,0)
 . set RPT(3,"header")="Enrollment date"
"RTN","SAMIUR2",178,0)
 . set RPT(3,"routine")="$$BLINEDT^SAMIUR2"
"RTN","SAMIUR2",179,0)
 . ;set RPT(3,"header")="CT Date"
"RTN","SAMIUR2",180,0)
 . ;set RPT(3,"routine")="$$STUDYDT^SAMIUR2"
"RTN","SAMIUR2",181,0)
 . ;set RPT(4,"header")="Gender"
"RTN","SAMIUR2",182,0)
 . ;set RPT(4,"routine")="$$GENDER^SAMIUR2"
"RTN","SAMIUR2",183,0)
 . ; set RPT(5,"header")="Race"
"RTN","SAMIUR2",184,0)
 . ; set RPT(5,"routine")="$$RACE^SAMIUR2"
"RTN","SAMIUR2",185,0)
 . ;set RPT(6,"header")="Age"
"RTN","SAMIUR2",186,0)
 . ;set RPT(6,"routine")="$$AGE^SAMIUR2"
"RTN","SAMIUR2",187,0)
 . set RPT(4,"header")="Date of Death"
"RTN","SAMIUR2",188,0)
 . set RPT(4,"routine")="$$INACTDT^SAMIUR2"
"RTN","SAMIUR2",189,0)
 . set RPT(5,"header")="Inactive Reason"
"RTN","SAMIUR2",190,0)
 . set RPT(5,"routine")="$$INACTRE^SAMIUR2"
"RTN","SAMIUR2",191,0)
 . set RPT(6,"header")="Inactive Comment"
"RTN","SAMIUR2",192,0)
 . set RPT(6,"routine")="$$INACTCM^SAMIUR2"
"RTN","SAMIUR2",193,0)
 . ;set RPT(7,"header")="Urban/Rural"
"RTN","SAMIUR2",194,0)
 . ;set RPT(7,"routine")="$$RURAL^SAMIUR2"
"RTN","SAMIUR2",195,0)
 . ;set RPT(8,"header")="Smoking Status"
"RTN","SAMIUR2",196,0)
 . ;set RPT(8,"routine")="$$SMKSTAT^SAMIUR2"
"RTN","SAMIUR2",197,0)
 . ;set RPT(9,"header")="Pack Years at Intake"
"RTN","SAMIUR2",198,0)
 . ;set RPT(9,"routine")="$$PACKYRS^SAMIUR2"
"RTN","SAMIUR2",199,0)
 . quit
"RTN","SAMIUR2",200,0)
 ;
"RTN","SAMIUR2",201,0)
 if TYPE="incomplete" do  quit  ;
"RTN","SAMIUR2",202,0)
 . set RPT(1,"header")="Enrollment date"
"RTN","SAMIUR2",203,0)
 . set RPT(1,"routine")="$$BLINEDT^SAMIUR2"
"RTN","SAMIUR2",204,0)
 . set RPT(2,"header")="Name"
"RTN","SAMIUR2",205,0)
 . set RPT(2,"routine")="$$NAME^SAMIUR2"
"RTN","SAMIUR2",206,0)
 . set RPT(3,"header")=$$SSNLABEL(SITE)
"RTN","SAMIUR2",207,0)
 . set RPT(3,"routine")="$$SSN^SAMIUR2"
"RTN","SAMIUR2",208,0)
 . set RPT(4,"header")="Incomplete form"
"RTN","SAMIUR2",209,0)
 . set RPT(4,"routine")="$$IFORM^SAMIUR2"
"RTN","SAMIUR2",210,0)
 . quit
"RTN","SAMIUR2",211,0)
 ;
"RTN","SAMIUR2",212,0)
 if TYPE="missingct" do  quit  ;
"RTN","SAMIUR2",213,0)
 . set RPT(1,"header")="Last contact date"
"RTN","SAMIUR2",214,0)
 . set RPT(1,"routine")="$$LDOC^SAMIUR2"
"RTN","SAMIUR2",215,0)
 . set RPT(2,"header")="Last contact entry"
"RTN","SAMIUR2",216,0)
 . set RPT(2,"routine")="$$LENTRY^SAMIUR2"
"RTN","SAMIUR2",217,0)
 . set RPT(3,"header")="Name"
"RTN","SAMIUR2",218,0)
 . set RPT(3,"routine")="$$NAME^SAMIUR2"
"RTN","SAMIUR2",219,0)
 . set RPT(4,"header")=$$SSNLABEL(SITE)
"RTN","SAMIUR2",220,0)
 . set RPT(4,"routine")="$$SSN^SAMIUR2"
"RTN","SAMIUR2",221,0)
 . set RPT(5,"header")="Enrollment date"
"RTN","SAMIUR2",222,0)
 . set RPT(5,"routine")="$$BLINEDT^SAMIUR2"
"RTN","SAMIUR2",223,0)
 . quit
"RTN","SAMIUR2",224,0)
 ;
"RTN","SAMIUR2",225,0)
 if TYPE="cumpy" do  quit  ;
"RTN","SAMIUR2",226,0)
 . set RPT(1,"header")="Name"
"RTN","SAMIUR2",227,0)
 . set RPT(1,"routine")="$$NAME^SAMIUR2"
"RTN","SAMIUR2",228,0)
 . set RPT(2,"header")="Study ID"
"RTN","SAMIUR2",229,0)
 . set RPT(2,"routine")="$$SID^SAMIUR2"
"RTN","SAMIUR2",230,0)
 . set RPT(3,"header")="Form Values"
"RTN","SAMIUR2",231,0)
 . set RPT(3,"routine")="$$VALS^SAMIUR2"
"RTN","SAMIUR2",232,0)
 . set RPT(4,"header")="Smoking History"
"RTN","SAMIUR2",233,0)
 . set RPT(4,"routine")="$$SMHIS^SAMIUR2"
"RTN","SAMIUR2",234,0)
 . quit
"RTN","SAMIUR2",235,0)
 ;
"RTN","SAMIUR2",236,0)
 if TYPE="unmatched" do  ;
"RTN","SAMIUR2",237,0)
 . set RPT(1,"header")="Unmatched Manual Entry"
"RTN","SAMIUR2",238,0)
 . set RPT(1,"routine")="$$MANPAT^SAMIUR2"
"RTN","SAMIUR2",239,0)
 . set RPT(2,"header")="Possible HL7 Match"
"RTN","SAMIUR2",240,0)
 . set RPT(2,"routine")="$$POSSIBLE^SAMIUR2"
"RTN","SAMIUR2",241,0)
 . set RPT(3,"header")="Match Control"
"RTN","SAMIUR2",242,0)
 . set RPT(3,"routine")="$$MATCH^SAMIUR2"
"RTN","SAMIUR2",243,0)
 . quit
"RTN","SAMIUR2",244,0)
 ;
"RTN","SAMIUR2",245,0)
 if TYPE="worklist" do  quit  ;
"RTN","SAMIUR2",246,0)
 . set RPT(1,"header")="Name"
"RTN","SAMIUR2",247,0)
 . set RPT(1,"routine")="$$WORKPAT^SAMIUR2"
"RTN","SAMIUR2",248,0)
 . set RPT(2,"header")=$$SSNLABEL(SITE)
"RTN","SAMIUR2",249,0)
 . set RPT(2,"routine")="$$SSN^SAMIUR2"
"RTN","SAMIUR2",250,0)
 . set RPT(3,"header")="Date of birth"
"RTN","SAMIUR2",251,0)
 . set RPT(3,"routine")="$$DOB^SAMIUR2"
"RTN","SAMIUR2",252,0)
 . set RPT(4,"header")="Gender"
"RTN","SAMIUR2",253,0)
 . set RPT(4,"routine")="$$GENDER^SAMIUR2"
"RTN","SAMIUR2",254,0)
 . quit
"RTN","SAMIUR2",255,0)
 ;
"RTN","SAMIUR2",256,0)
 quit  ; end of ppi RPTTBL^SAMIUR2
"RTN","SAMIUR2",257,0)
 ;
"RTN","SAMIUR2",258,0)
 ;
"RTN","SAMIUR2",259,0)
 ;
"RTN","SAMIUR2",260,0)
 ;@section 2 shared subroutines
"RTN","SAMIUR2",261,0)
 ;
"RTN","SAMIUR2",262,0)
 ;
"RTN","SAMIUR2",263,0)
 ;
"RTN","SAMIUR2",264,0)
DFN2SID(DFN) ;studyid for patient DFN
"RTN","SAMIUR2",265,0)
 ;
"RTN","SAMIUR2",266,0)
 ;;private;function;clean;silent;sac
"RTN","SAMIUR2",267,0)
 ;@called-by
"RTN","SAMIUR2",268,0)
 ; $$SID^SAMIUR2
"RTN","SAMIUR2",269,0)
 ; $$IFORM^SAMIUR2
"RTN","SAMIUR2",270,0)
 ; $$VALS^SAMIUR2
"RTN","SAMIUR2",271,0)
 ; $$SMHIS^SAMIUR2
"RTN","SAMIUR2",272,0)
 ;@calls
"RTN","SAMIUR2",273,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",274,0)
 ;
"RTN","SAMIUR2",275,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",276,0)
 ;
"RTN","SAMIUR2",277,0)
 quit $get(@root@(DFN,"sisid")) ; end of $$DFN2SID
"RTN","SAMIUR2",278,0)
 ;
"RTN","SAMIUR2",279,0)
 ;
"RTN","SAMIUR2",280,0)
 ;
"RTN","SAMIUR2",281,0)
MKNAV(sid,zform,fname,form) ; html for navigation to form
"RTN","SAMIUR2",282,0)
 ;
"RTN","SAMIUR2",283,0)
 ;;private;function;clean;silent;sac
"RTN","SAMIUR2",284,0)
 ;@called-by
"RTN","SAMIUR2",285,0)
 ; $$IFORM^SAMIUR2
"RTN","SAMIUR2",286,0)
 ;@calls none
"RTN","SAMIUR2",287,0)
 ;
"RTN","SAMIUR2",288,0)
 new rtn set rtn="<form method=""post"" action=""/vapals"">"
"RTN","SAMIUR2",289,0)
 set rtn=rtn_"<input name=""samiroute"" value=""form"" type=""hidden"">"
"RTN","SAMIUR2",290,0)
 set rtn=rtn_" <input name=""studyid"" value="""_sid_""" type=""hidden"">"
"RTN","SAMIUR2",291,0)
 set rtn=rtn_" <input name=""form"" value=""vapals:"_zform_""" type=""hidden"">"
"RTN","SAMIUR2",292,0)
 set rtn=rtn_" <input value="""_fname_""" class=""btn btn-link"" role=""link"" type=""submit""></form>"_$char(13)
"RTN","SAMIUR2",293,0)
 ;
"RTN","SAMIUR2",294,0)
 quit rtn ; end of $$MKNAV
"RTN","SAMIUR2",295,0)
 ;
"RTN","SAMIUR2",296,0)
 ;
"RTN","SAMIUR2",297,0)
 ;
"RTN","SAMIUR2",298,0)
 ;@section 3 smoking history subroutines
"RTN","SAMIUR2",299,0)
 ;
"RTN","SAMIUR2",300,0)
 ;
"RTN","SAMIUR2",301,0)
 ;
"RTN","SAMIUR2",302,0)
SHDET(SID,KEY) ; table contents for smoking history
"RTN","SAMIUR2",303,0)
 ;
"RTN","SAMIUR2",304,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",305,0)
 ;@called-by
"RTN","SAMIUR2",306,0)
 ; LOAD^SAMIFLD
"RTN","SAMIUR2",307,0)
 ; $$SMHIS^SAMIUR2
"RTN","SAMIUR2",308,0)
 ;@calls
"RTN","SAMIUR2",309,0)
 ; CUMPY
"RTN","SAMIUR2",310,0)
 ;
"RTN","SAMIUR2",311,0)
 ; KEY is the form key of the caller for "current" marker insertion
"RTN","SAMIUR2",312,0)
 ;
"RTN","SAMIUR2",313,0)
 new pyary
"RTN","SAMIUR2",314,0)
 if $get(KEY)="" set KEY=""
"RTN","SAMIUR2",315,0)
 do CUMPY("pyary",SID,KEY)
"RTN","SAMIUR2",316,0)
 ;
"RTN","SAMIUR2",317,0)
 new current set current=$get(pyary("current"))
"RTN","SAMIUR2",318,0)
 new rptcnt set rptcnt=0
"RTN","SAMIUR2",319,0)
 new rptmax set rptmax=$order(pyary("rpt",""),-1)
"RTN","SAMIUR2",320,0)
 quit:+rptmax=0
"RTN","SAMIUR2",321,0)
 ;
"RTN","SAMIUR2",322,0)
 new return set return=""
"RTN","SAMIUR2",323,0)
 new zi set zi=""
"RTN","SAMIUR2",324,0)
 for zi=1:1:rptmax do  ;
"RTN","SAMIUR2",325,0)
 . set rptcnt=rptcnt+1
"RTN","SAMIUR2",326,0)
 . if rptcnt=current set return=return_"<tr data-current-form=""true"">"
"RTN","SAMIUR2",327,0)
 . else  set return=return_"<tr>"
"RTN","SAMIUR2",328,0)
 . set return=return_"<td>"_pyary("rpt",rptcnt,1)_"</td>"
"RTN","SAMIUR2",329,0)
 . set return=return_"<td class=""reported-date"">"_pyary("rpt",rptcnt,2)_"</td>"
"RTN","SAMIUR2",330,0)
 . set return=return_"<td class=""pack-years"">"_pyary("rpt",rptcnt,3)_"</td>"
"RTN","SAMIUR2",331,0)
 . set return=return_"<td class=""cumulative-pack-years"">"_pyary("rpt",rptcnt,4)_"</td>"
"RTN","SAMIUR2",332,0)
 . set return=return_"</tr>"
"RTN","SAMIUR2",333,0)
 . quit
"RTN","SAMIUR2",334,0)
 ;
"RTN","SAMIUR2",335,0)
 quit return ; end of ppi $$SHDET^SAMIUR2
"RTN","SAMIUR2",336,0)
 ;
"RTN","SAMIUR2",337,0)
 ;
"RTN","SAMIUR2",338,0)
 ;
"RTN","SAMIUR2",339,0)
CUMPY(PYARY,sid,KEY) ; forms array of cummulative pack year data
"RTN","SAMIUR2",340,0)
 ;
"RTN","SAMIUR2",341,0)
 ;;ppi;procedure;clean;silent;sac
"RTN","SAMIUR2",342,0)
 ;@called-by
"RTN","SAMIUR2",343,0)
 ; SSTATUS^SAMINOT2
"RTN","SAMIUR2",344,0)
 ; SSTATUS^SAMINOT3
"RTN","SAMIUR2",345,0)
 ; $$SHDET
"RTN","SAMIUR2",346,0)
 ;@calls
"RTN","SAMIUR2",347,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",348,0)
 ; GETITEMS^SAMICASE
"RTN","SAMIUR2",349,0)
 ; $$GETDTKEY^SAMICAS2
"RTN","SAMIUR2",350,0)
 ; $$KEY2DSPD^SAMICAS2
"RTN","SAMIUR2",351,0)
 ; $$FMDT
"RTN","SAMIUR2",352,0)
 ; $$PKYDT
"RTN","SAMIUR2",353,0)
 ;
"RTN","SAMIUR2",354,0)
 ; PYARY passed by name
"RTN","SAMIUR2",355,0)
 ; KEY is the current form key for matching to a row
"RTN","SAMIUR2",356,0)
 ;
"RTN","SAMIUR2",357,0)
 kill @PYARY
"RTN","SAMIUR2",358,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",359,0)
 ; new sid set sid=$get(@root@(DFN,"samistudyid"))
"RTN","SAMIUR2",360,0)
 ; quit:sid=""
"RTN","SAMIUR2",361,0)
 ;
"RTN","SAMIUR2",362,0)
 new items set items=""
"RTN","SAMIUR2",363,0)
 do GETITEMS^SAMICASE("items",sid)
"RTN","SAMIUR2",364,0)
 quit:'$data(items)
"RTN","SAMIUR2",365,0)
 merge @PYARY@("items")=items
"RTN","SAMIUR2",366,0)
 ;
"RTN","SAMIUR2",367,0)
 new siform set siform=$order(items("siform"))
"RTN","SAMIUR2",368,0)
 quit:siform=""
"RTN","SAMIUR2",369,0)
 if siform=$get(KEY) set @PYARY@("current")=1 ;this row is the current form
"RTN","SAMIUR2",370,0)
 ;
"RTN","SAMIUR2",371,0)
 set @PYARY@("rpt",1,1)="Intake" ; Form
"RTN","SAMIUR2",372,0)
 new kdate set kdate=$$GETDTKEY^SAMICAS2(siform)
"RTN","SAMIUR2",373,0)
 new keydate set keydate=$$KEY2DSPD^SAMICAS2(kdate)
"RTN","SAMIUR2",374,0)
 set @PYARY@("rpt",1,2)=keydate ; Reported Date
"RTN","SAMIUR2",375,0)
 ;
"RTN","SAMIUR2",376,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",377,0)
 new lastcum set lastcum=$get(@vals@("sippy"))
"RTN","SAMIUR2",378,0)
 set @PYARY@("rpt",1,3)=lastcum ; Pack Years
"RTN","SAMIUR2",379,0)
 set @PYARY@("rpt",1,4)=lastcum ; Cumulative
"RTN","SAMIUR2",380,0)
 ;
"RTN","SAMIUR2",381,0)
 new lastdt set lastdt=keydate
"RTN","SAMIUR2",382,0)
 new rptcnt set rptcnt=1
"RTN","SAMIUR2",383,0)
 new zi set zi=""
"RTN","SAMIUR2",384,0)
 for  do  quit:zi=""  ;
"RTN","SAMIUR2",385,0)
 . set zi=$order(items("type","vapals:fuform",zi))
"RTN","SAMIUR2",386,0)
 . quit:zi=""
"RTN","SAMIUR2",387,0)
 . ;
"RTN","SAMIUR2",388,0)
 . set rptcnt=rptcnt+1
"RTN","SAMIUR2",389,0)
 . set @PYARY@("rpt",rptcnt,1)="Follow-up"
"RTN","SAMIUR2",390,0)
 . new kdate set kdate=$$GETDTKEY^SAMICAS2(zi)
"RTN","SAMIUR2",391,0)
 . new keydate set keydate=$$KEY2DSPD^SAMICAS2(kdate)
"RTN","SAMIUR2",392,0)
 . set @PYARY@("rpt",rptcnt,2)=keydate ; Reported Date
"RTN","SAMIUR2",393,0)
 . ;
"RTN","SAMIUR2",394,0)
 . set vals=$name(@root@("graph",sid,zi))
"RTN","SAMIUR2",395,0)
 . new newpd set newpd=$g(@vals@("sippd"))
"RTN","SAMIUR2",396,0)
 . new usedate set usedate=keydate
"RTN","SAMIUR2",397,0)
 . new siq set siq=$get(@vals@("siq")) ; quit date on followup form
"RTN","SAMIUR2",398,0)
 . if siq'="" do  ; quit date provided
"RTN","SAMIUR2",399,0)
 . . quit:$$FMDT(siq)<$$FMDT(lastdt)  ; quit date out of range
"RTN","SAMIUR2",400,0)
 . . quit:$$FMDT(siq)>$$FMDT(keydate)  ; quit date out of range
"RTN","SAMIUR2",401,0)
 . . set usedate=siq ; use the quit date as end of range
"RTN","SAMIUR2",402,0)
 . . quit
"RTN","SAMIUR2",403,0)
 . new newpy set newpy=$$PKYDT(lastdt,usedate,newpd)
"RTN","SAMIUR2",404,0)
 . set @vals@("sippy")=newpy
"RTN","SAMIUR2",405,0)
 . ;
"RTN","SAMIUR2",406,0)
 . set ^gpl("current","KEY")=$get(KEY)
"RTN","SAMIUR2",407,0)
 . set ^gpl("current","zi")=zi
"RTN","SAMIUR2",408,0)
 . if zi=$get(KEY) do
"RTN","SAMIUR2",409,0)
 . . set @PYARY@("current")=rptcnt ;this row is the current form
"RTN","SAMIUR2",410,0)
 . . quit
"RTN","SAMIUR2",411,0)
 . ;
"RTN","SAMIUR2",412,0)
 . new newcum set newcum=""
"RTN","SAMIUR2",413,0)
 . if newpy'="" set newcum=lastcum+newpy
"RTN","SAMIUR2",414,0)
 . set @PYARY@("rpt",rptcnt,3)=newpy ; Pack Years
"RTN","SAMIUR2",415,0)
 . set @PYARY@("rpt",rptcnt,4)=newcum ; Cumulative
"RTN","SAMIUR2",416,0)
 . set lastdt=keydate
"RTN","SAMIUR2",417,0)
 . set lastcum=newcum
"RTN","SAMIUR2",418,0)
 . quit
"RTN","SAMIUR2",419,0)
 ;
"RTN","SAMIUR2",420,0)
 quit  ; end of ppi CUMPY^SAMIUR2
"RTN","SAMIUR2",421,0)
 ; 
"RTN","SAMIUR2",422,0)
 ;
"RTN","SAMIUR2",423,0)
 ;
"RTN","SAMIUR2",424,0)
FMDT(ZDT) ; convert date to fileman format
"RTN","SAMIUR2",425,0)
 ;
"RTN","SAMIUR2",426,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",427,0)
 ;@called-by
"RTN","SAMIUR2",428,0)
 ; MKPTLK^SAMIHOM4
"RTN","SAMIUR2",429,0)
 ; $$PKYDT
"RTN","SAMIUR2",430,0)
 ; CUMPY
"RTN","SAMIUR2",431,0)
 ;@calls
"RTN","SAMIUR2",432,0)
 ; ^%DT
"RTN","SAMIUR2",433,0)
 ;
"RTN","SAMIUR2",434,0)
 new Y
"RTN","SAMIUR2",435,0)
 new X set X=ZDT
"RTN","SAMIUR2",436,0)
 do ^%DT
"RTN","SAMIUR2",437,0)
 ;
"RTN","SAMIUR2",438,0)
 quit Y ; end of ppi $$FMDT^SAMIUR2
"RTN","SAMIUR2",439,0)
 ;
"RTN","SAMIUR2",440,0)
 ;
"RTN","SAMIUR2",441,0)
 ;
"RTN","SAMIUR2",442,0)
PKYDT(STDT,ENDT,PKS,CIGS) ; pack-years from start & end & cigs/day
"RTN","SAMIUR2",443,0)
 ;
"RTN","SAMIUR2",444,0)
 ;;private;function;clean;silent;sac
"RTN","SAMIUR2",445,0)
 ;@called-by
"RTN","SAMIUR2",446,0)
 ; CUMPY
"RTN","SAMIUR2",447,0)
 ;@calls
"RTN","SAMIUR2",448,0)
 ; $$FMDT
"RTN","SAMIUR2",449,0)
 ; $$FMDIFF^XLFDT
"RTN","SAMIUR2",450,0)
 ; $$PKY
"RTN","SAMIUR2",451,0)
 ;
"RTN","SAMIUR2",452,0)
 ; if PKS is not provided, 20/CIGS will be used for packs per day
"RTN","SAMIUR2",453,0)
 ;
"RTN","SAMIUR2",454,0)
 new pkyr set pkyr=""
"RTN","SAMIUR2",455,0)
 if $get(PKS)="" do  ;
"RTN","SAMIUR2",456,0)
 . if $get(CIGS)="" set PKS=0 quit  ;
"RTN","SAMIUR2",457,0)
 . set PKS=20/CIGS
"RTN","SAMIUR2",458,0)
 . quit
"RTN","SAMIUR2",459,0)
 new zst set zst=$$FMDT(STDT)
"RTN","SAMIUR2",460,0)
 set:zst=-1 zst=STDT
"RTN","SAMIUR2",461,0)
 ;
"RTN","SAMIUR2",462,0)
 new zend set zend=$$FMDT(ENDT)
"RTN","SAMIUR2",463,0)
 set:zend=-1 zend=ENDT ; probably a fileman date already
"RTN","SAMIUR2",464,0)
 ;
"RTN","SAMIUR2",465,0)
 new zdif set zdif=$$FMDIFF^XLFDT(zend,zst)/365.24
"RTN","SAMIUR2",466,0)
 ;
"RTN","SAMIUR2",467,0)
 set pkyr=$$PKY(zdif,PKS)
"RTN","SAMIUR2",468,0)
 ;
"RTN","SAMIUR2",469,0)
 quit pkyr ; end of $$PKYDT
"RTN","SAMIUR2",470,0)
 ;
"RTN","SAMIUR2",471,0)
 ;
"RTN","SAMIUR2",472,0)
 ;
"RTN","SAMIUR2",473,0)
PKY(YRS,PKS) ; pack-years from years & packs/day
"RTN","SAMIUR2",474,0)
 ;
"RTN","SAMIUR2",475,0)
 ;;private;function;clean;silent;sac
"RTN","SAMIUR2",476,0)
 ;@called-by
"RTN","SAMIUR2",477,0)
 ; $$PKYDT
"RTN","SAMIUR2",478,0)
 ;@calls none
"RTN","SAMIUR2",479,0)
 ;@input
"RTN","SAMIUR2",480,0)
 ; YRS = years
"RTN","SAMIUR2",481,0)
 ; PKS = packs/day
"RTN","SAMIUR2",482,0)
 ;
"RTN","SAMIUR2",483,0)
 new rtn set rtn=""
"RTN","SAMIUR2",484,0)
 set rtn=YRS*PKS
"RTN","SAMIUR2",485,0)
 if $length($piece(rtn,".",2))>2 do  ;
"RTN","SAMIUR2",486,0)
 . new zdec set zdec=$piece(rtn,".",2)
"RTN","SAMIUR2",487,0)
 . set rtn=$piece(rtn,".",1)_"."_$extract(zdec,1,2)
"RTN","SAMIUR2",488,0)
 . if $extract(zdec,3)>4 set rtn=rtn+.01
"RTN","SAMIUR2",489,0)
 . quit
"RTN","SAMIUR2",490,0)
 set:rtn'["." rtn=rtn_".0"
"RTN","SAMIUR2",491,0)
 ;
"RTN","SAMIUR2",492,0)
 quit rtn ; end of $$PKY
"RTN","SAMIUR2",493,0)
 ;
"RTN","SAMIUR2",494,0)
 ;
"RTN","SAMIUR2",495,0)
 ;
"RTN","SAMIUR2",496,0)
 ;@section 4 active column ppis
"RTN","SAMIUR2",497,0)
 ;
"RTN","SAMIUR2",498,0)
 ;
"RTN","SAMIUR2",499,0)
 ;
"RTN","SAMIUR2",500,0)
AGE(zdt,dfn,SAMIPATS) ; age
"RTN","SAMIUR2",501,0)
 ;
"RTN","SAMIUR2",502,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",503,0)
 ;@called-by
"RTN","SAMIUR2",504,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",505,0)
 ;@calls
"RTN","SAMIUR2",506,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",507,0)
 ; ^%DT
"RTN","SAMIUR2",508,0)
 ; $$NOW^XLFDT
"RTN","SAMIUR2",509,0)
 ; $$FMDIFF^XLFDT
"RTN","SAMIUR2",510,0)
 ;
"RTN","SAMIUR2",511,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",512,0)
 new dob set dob=$get(@root@(dfn,"sbdob")) ; dob in VAPALS format
"RTN","SAMIUR2",513,0)
 ;
"RTN","SAMIUR2",514,0)
 new Y
"RTN","SAMIUR2",515,0)
 new X set X=dob
"RTN","SAMIUR2",516,0)
 do ^%DT
"RTN","SAMIUR2",517,0)
 ;
"RTN","SAMIUR2",518,0)
 new age set age=$piece($$FMDIFF^XLFDT($$NOW^XLFDT,Y)/365,".")
"RTN","SAMIUR2",519,0)
 ;
"RTN","SAMIUR2",520,0)
 quit age ; end of ppi $$AGE^SAMIUR2
"RTN","SAMIUR2",521,0)
 ;
"RTN","SAMIUR2",522,0)
 ;
"RTN","SAMIUR2",523,0)
 ;
"RTN","SAMIUR2",524,0)
BLINEDT(zdt,dfn,SAMIPATS) ; baseline date
"RTN","SAMIUR2",525,0)
 ;
"RTN","SAMIUR2",526,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",527,0)
 ;@called-by
"RTN","SAMIUR2",528,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",529,0)
 ;@calls none
"RTN","SAMIUR2",530,0)
 ;
"RTN","SAMIUR2",531,0)
 new bldt set bldt=$get(SAMIPATS(zdt,dfn,"edate"))
"RTN","SAMIUR2",532,0)
 ;
"RTN","SAMIUR2",533,0)
 quit bldt ; end of ppi $$BLINEDT^SAMIUR2
"RTN","SAMIUR2",534,0)
 ;
"RTN","SAMIUR2",535,0)
 ;
"RTN","SAMIUR2",536,0)
 ;
"RTN","SAMIUR2",537,0)
CONTACT(zdt,dfn,SAMIPATS) ; patient street address
"RTN","SAMIUR2",538,0)
 ;
"RTN","SAMIUR2",539,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",540,0)
 ;@called-by
"RTN","SAMIUR2",541,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",542,0)
 ;@calls
"RTN","SAMIUR2",543,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",544,0)
 ;
"RTN","SAMIUR2",545,0)
 new contact set contact=""
"RTN","SAMIUR2",546,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",547,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",548,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",549,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",550,0)
 set contact=$get(@vals@("sinamef"))_" "_$get(@vals@("sinamel"))
"RTN","SAMIUR2",551,0)
 set contact=contact_"<br>"_$get(@vals@("sipsa"))
"RTN","SAMIUR2",552,0)
 if $get(@vals@("sipan"))'="" do
"RTN","SAMIUR2",553,0)
 . set contact=contact_" Apt "_$get(@vals@("sipan"))
"RTN","SAMIUR2",554,0)
 . quit
"RTN","SAMIUR2",555,0)
 if $get(@vals@("sipcn"))'="" do
"RTN","SAMIUR2",556,0)
 . set contact=contact_"<br>County "_@vals@("sipcn")
"RTN","SAMIUR2",557,0)
 . quit
"RTN","SAMIUR2",558,0)
 if $get(@vals@("sipc"))'="" do
"RTN","SAMIUR2",559,0)
 . set contact=contact_" <br>"_@vals@("sipc")_", "
"RTN","SAMIUR2",560,0)
 . quit
"RTN","SAMIUR2",561,0)
 set contact=contact_" "_$get(@vals@("sips"))_" "_$get(@vals@("sipz"))_"     "
"RTN","SAMIUR2",562,0)
 ;
"RTN","SAMIUR2",563,0)
 quit contact ; end of ppi $$CONTACT^SAMIUR2
"RTN","SAMIUR2",564,0)
 ;
"RTN","SAMIUR2",565,0)
 ;
"RTN","SAMIUR2",566,0)
 ;
"RTN","SAMIUR2",567,0)
CTPROT(zdt,dfn,SAMIPATS) ; ct protocol
"RTN","SAMIUR2",568,0)
 ;
"RTN","SAMIUR2",569,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",570,0)
 ;@called-by
"RTN","SAMIUR2",571,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",572,0)
 ;@calls
"RTN","SAMIUR2",573,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",574,0)
 ;
"RTN","SAMIUR2",575,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",576,0)
 new ceform set ceform=$get(SAMIPATS(zdt,dfn,"ceform"))
"RTN","SAMIUR2",577,0)
 quit:ceform="" ""
"RTN","SAMIUR2",578,0)
 ;
"RTN","SAMIUR2",579,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",580,0)
 new vals set vals=$name(@root@("graph",sid,ceform))
"RTN","SAMIUR2",581,0)
 new cectp set cectp=$get(@vals@("cectp"))
"RTN","SAMIUR2",582,0)
 new ctyp set ctyp=$select(cectp="l":"Low-Dose CT",cectp="d":"Standard CT",cectp="i":"Limited",1:"")
"RTN","SAMIUR2",583,0)
 ;
"RTN","SAMIUR2",584,0)
 quit ctyp ; end of ppi $$CTPROT^SAMIUR2
"RTN","SAMIUR2",585,0)
 ;
"RTN","SAMIUR2",586,0)
 ;
"RTN","SAMIUR2",587,0)
 ;
"RTN","SAMIUR2",588,0)
DOB(ien,dfn,SAMIPATS) ; date of birth
"RTN","SAMIUR2",589,0)
 ;
"RTN","SAMIUR2",590,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",591,0)
 ;@called-by
"RTN","SAMIUR2",592,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",593,0)
 ;@calls none
"RTN","SAMIUR2",594,0)
 ;
"RTN","SAMIUR2",595,0)
 new dob set dob=$get(SAMIPATS(ien,dfn,"dob"))
"RTN","SAMIUR2",596,0)
 if dob="" set dob=$get(SAMIPATS(ien,dfn,"sbdob"))
"RTN","SAMIUR2",597,0)
 ;
"RTN","SAMIUR2",598,0)
 quit dob ; end of ppi $$DOB^SAMIUR2
"RTN","SAMIUR2",599,0)
 ;
"RTN","SAMIUR2",600,0)
 ;
"RTN","SAMIUR2",601,0)
 ;
"RTN","SAMIUR2",602,0)
FUDATE(zdt,dfn,SAMIPATS) ; followup date
"RTN","SAMIUR2",603,0)
 ;
"RTN","SAMIUR2",604,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",605,0)
 ;@called-by
"RTN","SAMIUR2",606,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",607,0)
 ;@calls none
"RTN","SAMIUR2",608,0)
 ;
"RTN","SAMIUR2",609,0)
 new fud set fud="fudate"
"RTN","SAMIUR2",610,0)
 ;
"RTN","SAMIUR2",611,0)
 quit $get(SAMIPATS(zdt,dfn,"cefud")) ; end of ppi $$FUDATE^SAMIUR2
"RTN","SAMIUR2",612,0)
 ;
"RTN","SAMIUR2",613,0)
 ;
"RTN","SAMIUR2",614,0)
 ;
"RTN","SAMIUR2",615,0)
GENDER(zdt,dfn,SAMIPATS) ; gender
"RTN","SAMIUR2",616,0)
 ;
"RTN","SAMIUR2",617,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",618,0)
 ;@called-by
"RTN","SAMIUR2",619,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",620,0)
 ;@calls
"RTN","SAMIUR2",621,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",622,0)
 ;
"RTN","SAMIUR2",623,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",624,0)
 new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIUR2",625,0)
 ;
"RTN","SAMIUR2",626,0)
 new gend set gend=$get(SAMIPATS(zdt,dfn,"gender"))
"RTN","SAMIUR2",627,0)
 if gend="" do
"RTN","SAMIUR2",628,0)
 . new pien set pien=$order(@root@("dfn",dfn,""))
"RTN","SAMIUR2",629,0)
 . if pien'="" do  ;
"RTN","SAMIUR2",630,0)
 . . set gend=$get(@root@(pien,"sex"))
"RTN","SAMIUR2",631,0)
 . . if gend="" set gend=$get(@root@(pien,"gender"))
"RTN","SAMIUR2",632,0)
 . . quit
"RTN","SAMIUR2",633,0)
 . if gend="" do  ;
"RTN","SAMIUR2",634,0)
 . . new lien set lien=$order(@lroot@("dfn",dfn,""))
"RTN","SAMIUR2",635,0)
 . . set gend=$get(@lroot@(lien,"gender"))
"RTN","SAMIUR2",636,0)
 . . quit
"RTN","SAMIUR2",637,0)
 if gend["^" set gend=$piece(gend,"^",1)
"RTN","SAMIUR2",638,0)
 ;
"RTN","SAMIUR2",639,0)
 quit gend ; end of ppi $$GENDER^SAMIUR2
"RTN","SAMIUR2",640,0)
 ;
"RTN","SAMIUR2",641,0)
 ;
"RTN","SAMIUR2",642,0)
 ;
"RTN","SAMIUR2",643,0)
IFORM(zdt,dfn,SAMIPATS) ; name(s) of incomplete forms
"RTN","SAMIUR2",644,0)
 ;
"RTN","SAMIUR2",645,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",646,0)
 ;@called-by
"RTN","SAMIUR2",647,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",648,0)
 ;@calls
"RTN","SAMIUR2",649,0)
 ; $$DFN2SID^SAMIUR2
"RTN","SAMIUR2",650,0)
 ; $$KEY2FM^SAMICASE
"RTN","SAMIUR2",651,0)
 ; $$VAPALSDT^SAMICASE
"RTN","SAMIUR2",652,0)
 ; $$MKNAV
"RTN","SAMIUR2",653,0)
 ;
"RTN","SAMIUR2",654,0)
 new iform set iform=$get(SAMIPATS(zdt,dfn,"iform"))
"RTN","SAMIUR2",655,0)
 quit:iform="" ""  ;
"RTN","SAMIUR2",656,0)
 ;
"RTN","SAMIUR2",657,0)
 new zkey1,zn,typ
"RTN","SAMIUR2",658,0)
 new return set return="<table>"
"RTN","SAMIUR2",659,0)
 for zn=2:1  quit:$piece(iform," ",zn)=""  do  ;
"RTN","SAMIUR2",660,0)
 . set return=return_"<tr><td>"
"RTN","SAMIUR2",661,0)
 . set zkey1=$piece(iform," ",zn)
"RTN","SAMIUR2",662,0)
 . ;
"RTN","SAMIUR2",663,0)
 . new fname
"RTN","SAMIUR2",664,0)
 . if zkey1["ceform" set fname="CT Evaluation" set typ="ceform"
"RTN","SAMIUR2",665,0)
 . if zkey1["sbform" set fname="Background" set typ="sbform"
"RTN","SAMIUR2",666,0)
 . if zkey1["fuform" set fname="Follow-up" set typ="fuform"
"RTN","SAMIUR2",667,0)
 . if zkey1["bxform" set fname="Biopsy" set typ="bxform"
"RTN","SAMIUR2",668,0)
 . if zkey1["ptform" set fname="PET Evaluation" set typ="ptform"
"RTN","SAMIUR2",669,0)
 . if zkey1["itform" set fname="Intervention" set typ="itform"
"RTN","SAMIUR2",670,0)
 . if zkey1["siform" set fname="Intake Form" set typ="siform"
"RTN","SAMIUR2",671,0)
 . if $get(fname)="" set fname="unknown" set typ=""
"RTN","SAMIUR2",672,0)
 . ;
"RTN","SAMIUR2",673,0)
 . new sid set sid=$$DFN2SID^SAMIUR2(dfn)
"RTN","SAMIUR2",674,0)
 . new zdate set zdate=$$VAPALSDT^SAMICASE($$KEY2FM^SAMICASE(zkey1))
"RTN","SAMIUR2",675,0)
 . set return=return_$$MKNAV(sid,zkey1,fname_" - "_zdate,typ)
"RTN","SAMIUR2",676,0)
 . set return=return_"</td></tr>"
"RTN","SAMIUR2",677,0)
 . quit
"RTN","SAMIUR2",678,0)
 ;
"RTN","SAMIUR2",679,0)
 set return=return_"</table>"
"RTN","SAMIUR2",680,0)
 ;
"RTN","SAMIUR2",681,0)
 quit return ; end of ppi $$IFORM^SAMIUR2
"RTN","SAMIUR2",682,0)
 ;
"RTN","SAMIUR2",683,0)
 ;
"RTN","SAMIUR2",684,0)
 ;
"RTN","SAMIUR2",685,0)
LASTEXM(zdt,dfn,SAMIPATS) ; patient last exam
"RTN","SAMIUR2",686,0)
 ;
"RTN","SAMIUR2",687,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",688,0)
 ;@called-by
"RTN","SAMIUR2",689,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",690,0)
 ;@calls none
"RTN","SAMIUR2",691,0)
 ;
"RTN","SAMIUR2",692,0)
 new lexm set lexm=$get(SAMIPATS(zdt,dfn,"cedos"))
"RTN","SAMIUR2",693,0)
 ;
"RTN","SAMIUR2",694,0)
 quit lexm ; end of ppi $$LASTEXM^SAMIUR2
"RTN","SAMIUR2",695,0)
 ;
"RTN","SAMIUR2",696,0)
 ;
"RTN","SAMIUR2",697,0)
INACTDT(zdt,dfn,SAMIPATS) ; inactive date
"RTN","SAMIUR2",698,0)
 ;
"RTN","SAMIUR2",699,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",700,0)
 ;@called-by
"RTN","SAMIUR2",701,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",702,0)
 ;@calls
"RTN","SAMIUR2",703,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",704,0)
 ;
"RTN","SAMIUR2",705,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",706,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",707,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",708,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",709,0)
 ;
"RTN","SAMIUR2",710,0)
 q $g(@vals@("sidod"))
"RTN","SAMIUR2",711,0)
 ;
"RTN","SAMIUR2",712,0)
INACTRE(zdt,dfn,SAMIPATS) ; inactive date
"RTN","SAMIUR2",713,0)
 ;
"RTN","SAMIUR2",714,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",715,0)
 ;@called-by
"RTN","SAMIUR2",716,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",717,0)
 ;@calls
"RTN","SAMIUR2",718,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",719,0)
 ;
"RTN","SAMIUR2",720,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",721,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",722,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",723,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",724,0)
 ;
"RTN","SAMIUR2",725,0)
 q $g(@vals@("sistachg"))
"RTN","SAMIUR2",726,0)
 ;
"RTN","SAMIUR2",727,0)
INACTCM(zdt,dfn,SAMIPATS) ; inactive date
"RTN","SAMIUR2",728,0)
 ;
"RTN","SAMIUR2",729,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",730,0)
 ;@called-by
"RTN","SAMIUR2",731,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",732,0)
 ;@calls
"RTN","SAMIUR2",733,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",734,0)
 ;
"RTN","SAMIUR2",735,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",736,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",737,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",738,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",739,0)
 ;
"RTN","SAMIUR2",740,0)
 q $g(@vals@("sistreas"))
"RTN","SAMIUR2",741,0)
 ;
"RTN","SAMIUR2",742,0)
LDE(zdt,dfn,SAMIPATS) ; last date and entry in com log
"RTN","SAMIUR2",743,0)
 ;
"RTN","SAMIUR2",744,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",745,0)
 ;@called-by
"RTN","SAMIUR2",746,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",747,0)
 ;@calls
"RTN","SAMIUR2",748,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",749,0)
 ;
"RTN","SAMIUR2",750,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",751,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",752,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",753,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",754,0)
 ;
"RTN","SAMIUR2",755,0)
 n comien,comdt,comntry
"RTN","SAMIUR2",756,0)
 s (comdt,comntry)=""
"RTN","SAMIUR2",757,0)
 s comien=$o(@vals@("comlog"," "),-1)
"RTN","SAMIUR2",758,0)
 i comien="" d  q comdt
"RTN","SAMIUR2",759,0)
 . s comdt=$g(@vals@("sidc"))
"RTN","SAMIUR2",760,0)
 s comntry=$g(@vals@("comlog",comien))
"RTN","SAMIUR2",761,0)
 s comdt=$p($p(comntry,"[",2),"@",1)
"RTN","SAMIUR2",762,0)
 q comdt_"^"_comntry
"RTN","SAMIUR2",763,0)
 ;
"RTN","SAMIUR2",764,0)
LDOC(zdt,dfn,SAMIPATS) ; last date of contact
"RTN","SAMIUR2",765,0)
 ;
"RTN","SAMIUR2",766,0)
 q $P($$LDE(zdt,dfn,.SAMIPATS),"^",1)
"RTN","SAMIUR2",767,0)
 ;
"RTN","SAMIUR2",768,0)
LENTRY(zdt,dfn,SAMIPATS) ; last contact entry
"RTN","SAMIUR2",769,0)
 ;
"RTN","SAMIUR2",770,0)
 q $P($$LDE(zdt,dfn,.SAMIPATS),"^",2)
"RTN","SAMIUR2",771,0)
 ;
"RTN","SAMIUR2",772,0)
 ;
"RTN","SAMIUR2",773,0)
MANPAT(ien,dfn,SAMIPATS) ; unmatched patient cell
"RTN","SAMIUR2",774,0)
 ;
"RTN","SAMIUR2",775,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",776,0)
 ;@called-by
"RTN","SAMIUR2",777,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",778,0)
 ;@calls
"RTN","SAMIUR2",779,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",780,0)
 ;
"RTN","SAMIUR2",781,0)
 new zcell set zcell=""
"RTN","SAMIUR2",782,0)
 ; set zcell=zcell_$get(SAMIPATS(ien,dfn,"saminame"))
"RTN","SAMIUR2",783,0)
 set zcell=zcell_$get(SAMIPATS(ien,dfn,"editref"))
"RTN","SAMIUR2",784,0)
 set zcell=zcell_"<br>Date of Birth: "_$get(SAMIPATS(ien,dfn,"dob"))
"RTN","SAMIUR2",785,0)
 set zcell=zcell_" Gender: "_$get(SAMIPATS(ien,dfn,"sex"))
"RTN","SAMIUR2",786,0)
 ;
"RTN","SAMIUR2",787,0)
 new ssn set ssn=$get(SAMIPATS(ien,dfn,"ssn"))
"RTN","SAMIUR2",788,0)
 if ssn="" do  ;
"RTN","SAMIUR2",789,0)
 . new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIUR2",790,0)
 . new tssn set tssn=$get(@lroot@(ien,"ssn"))
"RTN","SAMIUR2",791,0)
 . set ssn=$extract(tssn,1,3)_"-"_$extract(tssn,4,5)_"-"_$extract(tssn,6,9)
"RTN","SAMIUR2",792,0)
 . quit
"RTN","SAMIUR2",793,0)
 set zcell=zcell_"<br>SSN: "_ssn
"RTN","SAMIUR2",794,0)
 ;
"RTN","SAMIUR2",795,0)
 set zcell=zcell_"<br>dfn: "_dfn
"RTN","SAMIUR2",796,0)
 ;
"RTN","SAMIUR2",797,0)
 quit zcell ; end of ppi $$MANPAT^SAMIUR2
"RTN","SAMIUR2",798,0)
 ;
"RTN","SAMIUR2",799,0)
 ;
"RTN","SAMIUR2",800,0)
 ;
"RTN","SAMIUR2",801,0)
MATCH(ien,dfn,SAMIPATS) ; match button cell
"RTN","SAMIUR2",802,0)
 ;
"RTN","SAMIUR2",803,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",804,0)
 ;@called-by
"RTN","SAMIUR2",805,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",806,0)
 ;@calls none
"RTN","SAMIUR2",807,0)
 ;
"RTN","SAMIUR2",808,0)
 new matien set matien=$get(SAMIPATS(ien,dfn,"MATCHLOG"))
"RTN","SAMIUR2",809,0)
 quit:matien="" ""
"RTN","SAMIUR2",810,0)
 ;
"RTN","SAMIUR2",811,0)
 new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMIUR2",812,0)
 set nuhref=nuhref_"<input type=hidden name=""samiroute"" value=""merge"">"
"RTN","SAMIUR2",813,0)
 set nuhref=nuhref_"<input type=hidden name=""toien"" value="_ien_">"
"RTN","SAMIUR2",814,0)
 set nuhref=nuhref_"<input value=""Merge"" class=""btn btn-link"" role=""link"" type=""submit""></form>"
"RTN","SAMIUR2",815,0)
 ;
"RTN","SAMIUR2",816,0)
 quit nuhref ; end of ppi $$MATCH^SAMIUR2
"RTN","SAMIUR2",817,0)
 ;
"RTN","SAMIUR2",818,0)
 ;
"RTN","SAMIUR2",819,0)
 ;
"RTN","SAMIUR2",820,0)
NAME(zdt,dfn,SAMIPATS) ; name w/hyperlink
"RTN","SAMIUR2",821,0)
 ;
"RTN","SAMIUR2",822,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",823,0)
 ;@called-by
"RTN","SAMIUR2",824,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",825,0)
 ;@calls none
"RTN","SAMIUR2",826,0)
 ;
"RTN","SAMIUR2",827,0)
 new nam set nam="Name"
"RTN","SAMIUR2",828,0)
 ;
"RTN","SAMIUR2",829,0)
 quit $get(SAMIPATS(zdt,dfn,"nuhref")) ; end of ppi $$NAME^SAMIUR2
"RTN","SAMIUR2",830,0)
 ;
"RTN","SAMIUR2",831,0)
 ;
"RTN","SAMIUR2",832,0)
 ;
"RTN","SAMIUR2",833,0)
PACKYRS(zdt,dfn,SAMIPATS) ; smoking status
"RTN","SAMIUR2",834,0)
 ;
"RTN","SAMIUR2",835,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",836,0)
 ;@called-by
"RTN","SAMIUR2",837,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",838,0)
 ;@calls
"RTN","SAMIUR2",839,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",840,0)
 ;
"RTN","SAMIUR2",841,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",842,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",843,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",844,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",845,0)
 new pkyrs set pkyrs=$get(@vals@("sippy"))
"RTN","SAMIUR2",846,0)
 ;
"RTN","SAMIUR2",847,0)
 quit pkyrs ; end of ppi $$PACKYRS^SAMIUR2
"RTN","SAMIUR2",848,0)
 ;
"RTN","SAMIUR2",849,0)
 ;
"RTN","SAMIUR2",850,0)
 ;
"RTN","SAMIUR2",851,0)
POSSIBLE(ien,dfn,SAMIPATS) ; possible match cell
"RTN","SAMIUR2",852,0)
 ;
"RTN","SAMIUR2",853,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",854,0)
 ;@called-by
"RTN","SAMIUR2",855,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",856,0)
 ;@calls
"RTN","SAMIUR2",857,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",858,0)
 ;
"RTN","SAMIUR2",859,0)
 new zcell set zcell=""
"RTN","SAMIUR2",860,0)
 new matien set matien=$get(SAMIPATS(ien,dfn,"MATCHLOG"))
"RTN","SAMIUR2",861,0)
 quit:matien="" zcell
"RTN","SAMIUR2",862,0)
 ;
"RTN","SAMIUR2",863,0)
 new lroot set lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIUR2",864,0)
 quit:'$data(@lroot@(matien)) zcell
"RTN","SAMIUR2",865,0)
 ;
"RTN","SAMIUR2",866,0)
 set zcell=zcell_$get(@lroot@(matien,"saminame"))
"RTN","SAMIUR2",867,0)
 set zcell=zcell_"<br>Date of Birth: "_$get(@lroot@(matien,"sbdob"))
"RTN","SAMIUR2",868,0)
 set zcell=zcell_" Gender: "_$get(@lroot@(matien,"sex"))
"RTN","SAMIUR2",869,0)
 ;
"RTN","SAMIUR2",870,0)
 new tssn set tssn=$get(@lroot@(matien,"ssn"))
"RTN","SAMIUR2",871,0)
 new ssn set ssn=tssn
"RTN","SAMIUR2",872,0)
 if tssn'["-" set ssn=$extract(tssn,1,3)_"-"_$extract(tssn,4,5)_"-"_$extract(tssn,6,9)
"RTN","SAMIUR2",873,0)
 set zcell=zcell_"<br>SSN: "_ssn
"RTN","SAMIUR2",874,0)
 ;
"RTN","SAMIUR2",875,0)
 set zcell=zcell_"<br>dfn: "_$get(@lroot@(matien,"dfn"))
"RTN","SAMIUR2",876,0)
 ;
"RTN","SAMIUR2",877,0)
 quit zcell ; end of ppi $$POSSIBLE^SAMIUR2
"RTN","SAMIUR2",878,0)
 ;
"RTN","SAMIUR2",879,0)
 ;
"RTN","SAMIUR2",880,0)
 ;
"RTN","SAMIUR2",881,0)
RECOM(zdt,dfn,SAMIPATS) ; recommendation
"RTN","SAMIUR2",882,0)
 ;
"RTN","SAMIUR2",883,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",884,0)
 ;@called-by
"RTN","SAMIUR2",885,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",886,0)
 ;@calls
"RTN","SAMIUR2",887,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",888,0)
 ;
"RTN","SAMIUR2",889,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",890,0)
 new ceform set ceform=$get(SAMIPATS(zdt,dfn,"ceform"))
"RTN","SAMIUR2",891,0)
 quit:ceform="" ""
"RTN","SAMIUR2",892,0)
 ;
"RTN","SAMIUR2",893,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",894,0)
 new vals set vals=$name(@root@("graph",sid,ceform))
"RTN","SAMIUR2",895,0)
 new cefuw set cefuw=$get(@vals@("cefuw"))
"RTN","SAMIUR2",896,0)
 ;
"RTN","SAMIUR2",897,0)
 new recom set recom=""
"RTN","SAMIUR2",898,0)
 set recom=$select(cefuw="1y":"Annual Repeat",cefuw="nw":"Now",cefuw="1m":"1 month",cefuw="3m":"3 months",cefuw="6m":"6 months",cefuw="os":"Other",1:"")
"RTN","SAMIUR2",899,0)
 if $get(@vals@("cefuaf"))="y" set recom=recom_", Antibiotics"
"RTN","SAMIUR2",900,0)
 if $get(@vals@("cefucc"))="y" set recom=recom_", Contrast CT"
"RTN","SAMIUR2",901,0)
 if $get(@vals@("cefupe"))="y" set recom=recom_", PET"
"RTN","SAMIUR2",902,0)
 if $get(@vals@("cefufn"))="y" set recom=recom_", Percutaneous biopsy"
"RTN","SAMIUR2",903,0)
 if $get(@vals@("cefubr"))="y" set recom=recom_", Bronchoscopy"
"RTN","SAMIUR2",904,0)
 if $get(@vals@("cefupc"))="y" set recom=recom_", Pulmonary consultation"
"RTN","SAMIUR2",905,0)
 if $get(@vals@("cefutb"))="y" set recom=recom_", Refer to tumor board"
"RTN","SAMIUR2",906,0)
 if $get(@vals@("cefunf"))="y" set recom=recom_", No other further follow-up"
"RTN","SAMIUR2",907,0)
 if $extract(recom,1,2)=", " set recom=$extract(recom,3,$length(recom))
"RTN","SAMIUR2",908,0)
 ;
"RTN","SAMIUR2",909,0)
 quit recom ; end of ppi $$RECOM^SAMIUR2
"RTN","SAMIUR2",910,0)
 ;
"RTN","SAMIUR2",911,0)
 ;
"RTN","SAMIUR2",912,0)
 ;
"RTN","SAMIUR2",913,0)
RURAL(zdt,dfn,SAMIPATS) ; patient's rural/urban status
"RTN","SAMIUR2",914,0)
 ;
"RTN","SAMIUR2",915,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",916,0)
 ;@called-by
"RTN","SAMIUR2",917,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",918,0)
 ;@calls
"RTN","SAMIUR2",919,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",920,0)
 ;
"RTN","SAMIUR2",921,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",922,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",923,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",924,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",925,0)
 new sirs set sirs=$get(@vals@("sirs"))
"RTN","SAMIUR2",926,0)
 set sirs=$select(sirs="r":"rural",sirs="u":"urban",sirs="n":"unknown",1:"unknown")
"RTN","SAMIUR2",927,0)
 ;
"RTN","SAMIUR2",928,0)
 quit sirs ; end of ppi $$RURAL^SAMIUR2
"RTN","SAMIUR2",929,0)
 ;
"RTN","SAMIUR2",930,0)
 ;
"RTN","SAMIUR2",931,0)
 ;
"RTN","SAMIUR2",932,0)
SID(zdt,dfn,SAMIPATS) ; study ID
"RTN","SAMIUR2",933,0)
 ;
"RTN","SAMIUR2",934,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",935,0)
 ;@called-by
"RTN","SAMIUR2",936,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",937,0)
 ;@calls
"RTN","SAMIUR2",938,0)
 ; $$DFN2SID
"RTN","SAMIUR2",939,0)
 ;
"RTN","SAMIUR2",940,0)
 quit $$DFN2SID(dfn) ; end of ppi $$SID^SAMIUR2
"RTN","SAMIUR2",941,0)
 ;
"RTN","SAMIUR2",942,0)
 ;
"RTN","SAMIUR2",943,0)
 ;
"RTN","SAMIUR2",944,0)
SMHIS(zdt,dfn,SAMIPATS) ; smoking history cell
"RTN","SAMIUR2",945,0)
 ;
"RTN","SAMIUR2",946,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",947,0)
 ;@called-by
"RTN","SAMIUR2",948,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",949,0)
 ;@calls
"RTN","SAMIUR2",950,0)
 ; $$DFN2SID
"RTN","SAMIUR2",951,0)
 ; $$SHDET
"RTN","SAMIUR2",952,0)
 ;
"RTN","SAMIUR2",953,0)
 new zrtn set zrtn=""
"RTN","SAMIUR2",954,0)
 set zrtn=zrtn_"<div class=""row""><div class=""col-md-12""><table class=""table"" id=""pack-years-history"">"
"RTN","SAMIUR2",955,0)
 set zrtn=zrtn_"<thead><tr><th>Form </th><th> Reported Date </th>"
"RTN","SAMIUR2",956,0)
 set zrtn=zrtn_"<th>Pack Years</th><th>Cumulative</th></tr></thead><tbody>"
"RTN","SAMIUR2",957,0)
 set zrtn=zrtn_$$SHDET($$DFN2SID(dfn))
"RTN","SAMIUR2",958,0)
 set zrtn=zrtn_"</tbody></table></div></div>"
"RTN","SAMIUR2",959,0)
 ;
"RTN","SAMIUR2",960,0)
 quit zrtn ; end of ppi $$SMHIS^SAMIUR2
"RTN","SAMIUR2",961,0)
 ;
"RTN","SAMIUR2",962,0)
 ;
"RTN","SAMIUR2",963,0)
 ;
"RTN","SAMIUR2",964,0)
SMKSTAT(zdt,dfn,SAMIPATS) ; smoking status
"RTN","SAMIUR2",965,0)
 ;
"RTN","SAMIUR2",966,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",967,0)
 ;@called-by
"RTN","SAMIUR2",968,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",969,0)
 ;@calls
"RTN","SAMIUR2",970,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",971,0)
 ;
"RTN","SAMIUR2",972,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",973,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",974,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",975,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",976,0)
 ;
"RTN","SAMIUR2",977,0)
 new smk set smk="unknown"
"RTN","SAMIUR2",978,0)
 if $get(@vals@("siesm"))="n" set smk="Never smoked"
"RTN","SAMIUR2",979,0)
 if $get(@vals@("siesm"))="p" set smk="Past smoker"
"RTN","SAMIUR2",980,0)
 if $get(@vals@("siesm"))="c" set smk="Current smoker"
"RTN","SAMIUR2",981,0)
 ; if $get(@vals@("siesq"))=1 set smk="Cu"
"RTN","SAMIUR2",982,0)
 ;
"RTN","SAMIUR2",983,0)
 quit smk ; end of ppi $$SMKSTAT^SAMIUR2
"RTN","SAMIUR2",984,0)
 ;
"RTN","SAMIUR2",985,0)
 ;
"RTN","SAMIUR2",986,0)
 ;
"RTN","SAMIUR2",987,0)
SSN(zdt,dfn,SAMIPATS) ; social security number
"RTN","SAMIUR2",988,0)
 ;
"RTN","SAMIUR2",989,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",990,0)
 ;@called-by
"RTN","SAMIUR2",991,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",992,0)
 ;@calls none
"RTN","SAMIUR2",993,0)
 ;
"RTN","SAMIUR2",994,0)
 new tssn set tssn=$get(SAMIPATS(zdt,dfn,"ssn"))
"RTN","SAMIUR2",995,0)
 new ssn set ssn=tssn
"RTN","SAMIUR2",996,0)
 if ssn'["-" do
"RTN","SAMIUR2",997,0)
 . set ssn=$extract(tssn,1,3)_"-"_$extract(tssn,4,5)_"-"_$extract(tssn,6,9)
"RTN","SAMIUR2",998,0)
 . quit
"RTN","SAMIUR2",999,0)
 ;
"RTN","SAMIUR2",1000,0)
 quit ssn ; end of ppi $$SSN^SAMIUR2
"RTN","SAMIUR2",1001,0)
 ;
"RTN","SAMIUR2",1002,0)
 ;
"RTN","SAMIUR2",1003,0)
SSNLABEL(SITE) ; extrinsic returns label for SSN (ie PID)
"RTN","SAMIUR2",1004,0)
 new RTN
"RTN","SAMIUR2",1005,0)
 set RTN=$$GET1PARM^SAMIPARM("socialSecurityNumber",SITE)
"RTN","SAMIUR2",1006,0)
 if RTN="" set RTN="SSN"
"RTN","SAMIUR2",1007,0)
 quit RTN
"RTN","SAMIUR2",1008,0)
 ; 
"RTN","SAMIUR2",1009,0)
 ;
"RTN","SAMIUR2",1010,0)
STUDYDT(zdt,dfn,SAMIPATS) ; latest study date
"RTN","SAMIUR2",1011,0)
 ;
"RTN","SAMIUR2",1012,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",1013,0)
 ;@called-by
"RTN","SAMIUR2",1014,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",1015,0)
 ;@calls none
"RTN","SAMIUR2",1016,0)
 ;
"RTN","SAMIUR2",1017,0)
 new stdt set stdt=$get(SAMIPATS(zdt,dfn,"cedos"))
"RTN","SAMIUR2",1018,0)
 ;
"RTN","SAMIUR2",1019,0)
 quit stdt ; end of ppi $$STUDYDT^SAMIUR2
"RTN","SAMIUR2",1020,0)
 ;
"RTN","SAMIUR2",1021,0)
 ;
"RTN","SAMIUR2",1022,0)
 ;
"RTN","SAMIUR2",1023,0)
STUDYTYP(zdt,dfn,SAMIPATS) ; latest study type
"RTN","SAMIUR2",1024,0)
 ;
"RTN","SAMIUR2",1025,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",1026,0)
 ;@called-by
"RTN","SAMIUR2",1027,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",1028,0)
 ;@calls
"RTN","SAMIUR2",1029,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",1030,0)
 ;
"RTN","SAMIUR2",1031,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",1032,0)
 new ceform set ceform=$get(SAMIPATS(zdt,dfn,"ceform"))
"RTN","SAMIUR2",1033,0)
 quit:ceform="" ""
"RTN","SAMIUR2",1034,0)
 ;
"RTN","SAMIUR2",1035,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",1036,0)
 new vals set vals=$name(@root@("graph",sid,ceform))
"RTN","SAMIUR2",1037,0)
 new stypx set stypx=$get(@vals@("cetex"))
"RTN","SAMIUR2",1038,0)
 new styp set styp=$select(stypx="a":"Annual",stypx="b":"Baseline",stypx="d":"Followup",1:"")
"RTN","SAMIUR2",1039,0)
 ;
"RTN","SAMIUR2",1040,0)
 quit styp ; end of ppi $$STUDYTYP^SAMIUR2
"RTN","SAMIUR2",1041,0)
 ;
"RTN","SAMIUR2",1042,0)
 ;
"RTN","SAMIUR2",1043,0)
 ;
"RTN","SAMIUR2",1044,0)
VALS(zdt,dfn,SAMIPATS) ; form-values cell
"RTN","SAMIUR2",1045,0)
 ;
"RTN","SAMIUR2",1046,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",1047,0)
 ;@called-by
"RTN","SAMIUR2",1048,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",1049,0)
 ;@calls
"RTN","SAMIUR2",1050,0)
 ; $$DFN2SID
"RTN","SAMIUR2",1051,0)
 ;
"RTN","SAMIUR2",1052,0)
 new vrtn set vrtn=""
"RTN","SAMIUR2",1053,0)
 new vsid set vsid=$$DFN2SID(dfn)
"RTN","SAMIUR2",1054,0)
 new vgr set vgr="/vals?sid="_vsid_"&form="
"RTN","SAMIUR2",1055,0)
 quit:'$data(SAMIPATS)
"RTN","SAMIUR2",1056,0)
 ;
"RTN","SAMIUR2",1057,0)
 new vzi set vzi=""
"RTN","SAMIUR2",1058,0)
 for  do  quit:vzi="sort"  quit:vzi=""
"RTN","SAMIUR2",1059,0)
 . set vzi=$order(SAMIPATS(zdt,dfn,"items",vzi))
"RTN","SAMIUR2",1060,0)
 . quit:vzi="sort"
"RTN","SAMIUR2",1061,0)
 . quit:vzi=""
"RTN","SAMIUR2",1062,0)
 . set vrtn=vrtn_"<a href="""_vgr_vzi_""">"_vzi_"</a><br>"
"RTN","SAMIUR2",1063,0)
 . quit
"RTN","SAMIUR2",1064,0)
 ;
"RTN","SAMIUR2",1065,0)
 quit vrtn ; end of $$VALS^SAMIUR2
"RTN","SAMIUR2",1066,0)
 ;
"RTN","SAMIUR2",1067,0)
 ;
"RTN","SAMIUR2",1068,0)
 ;
"RTN","SAMIUR2",1069,0)
WHEN(zdt,dfn,SAMIPATS) ; followup text
"RTN","SAMIUR2",1070,0)
 ;
"RTN","SAMIUR2",1071,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",1072,0)
 ;@called-by
"RTN","SAMIUR2",1073,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",1074,0)
 ;@calls
"RTN","SAMIUR2",1075,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",1076,0)
 ;
"RTN","SAMIUR2",1077,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",1078,0)
 new ceform set ceform=$get(SAMIPATS(zdt,dfn,"ceform"))
"RTN","SAMIUR2",1079,0)
 quit:ceform="" ""
"RTN","SAMIUR2",1080,0)
 ;
"RTN","SAMIUR2",1081,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",1082,0)
 new vals set vals=$name(@root@("graph",sid,ceform))
"RTN","SAMIUR2",1083,0)
 new whnx set whnx=$get(@vals@("cefuw"))
"RTN","SAMIUR2",1084,0)
 quit:whnx="" ""
"RTN","SAMIUR2",1085,0)
 ;
"RTN","SAMIUR2",1086,0)
 new DICT
"RTN","SAMIUR2",1087,0)
 set DICT("cefuw","1m")="in one month"
"RTN","SAMIUR2",1088,0)
 set DICT("cefuw","1y")="in one year"
"RTN","SAMIUR2",1089,0)
 set DICT("cefuw","3m")="in three months"
"RTN","SAMIUR2",1090,0)
 set DICT("cefuw","6m")="in six months"
"RTN","SAMIUR2",1091,0)
 set DICT("cefuw","os")="other as specified"
"RTN","SAMIUR2",1092,0)
 set whn=$get(DICT("cefuw",whnx))
"RTN","SAMIUR2",1093,0)
 ;
"RTN","SAMIUR2",1094,0)
 quit whn ; end of ppi $$WHEN^SAMIUR2
"RTN","SAMIUR2",1095,0)
 ;
"RTN","SAMIUR2",1096,0)
 ;
"RTN","SAMIUR2",1097,0)
 ;
"RTN","SAMIUR2",1098,0)
WORKPAT(ien,dfn,SAMIPATS) ; worklist patient name cell
"RTN","SAMIUR2",1099,0)
 ;
"RTN","SAMIUR2",1100,0)
 ;;ppi;function;clean;silent;sac
"RTN","SAMIUR2",1101,0)
 ;@called-by
"RTN","SAMIUR2",1102,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIUR2",1103,0)
 ;@calls none
"RTN","SAMIUR2",1104,0)
 ;
"RTN","SAMIUR2",1105,0)
 new zcell set zcell=""
"RTN","SAMIUR2",1106,0)
 set zcell=zcell_$get(SAMIPATS(ien,dfn,"workref"))
"RTN","SAMIUR2",1107,0)
 ;
"RTN","SAMIUR2",1108,0)
 quit zcell ; end of ppi $$WORKPAT^SAMIUR2
"RTN","SAMIUR2",1109,0)
 ;
"RTN","SAMIUR2",1110,0)
 ;
"RTN","SAMIUR2",1111,0)
 ;
"RTN","SAMIUR2",1112,0)
 ;@section 5 unused subroutines
"RTN","SAMIUR2",1113,0)
 ;
"RTN","SAMIUR2",1114,0)
 ;
"RTN","SAMIUR2",1115,0)
 ;
"RTN","SAMIUR2",1116,0)
EPAT(ien,dfn,SAMIPATS) ; patient name w/nav to enrollment
"RTN","SAMIUR2",1117,0)
 ;
"RTN","SAMIUR2",1118,0)
 ;;private;procedure;clean;silent;sac
"RTN","SAMIUR2",1119,0)
 ;@called-by none
"RTN","SAMIUR2",1120,0)
 ;@calls none
"RTN","SAMIUR2",1121,0)
 ;
"RTN","SAMIUR2",1122,0)
 quit  ; end of $$EPAT
"RTN","SAMIUR2",1123,0)
 ;
"RTN","SAMIUR2",1124,0)
 ;
"RTN","SAMIUR2",1125,0)
 ;
"RTN","SAMIUR2",1126,0)
ETHNCTY(zdt,dfn,SAMIPATS) ; ethnicity
"RTN","SAMIUR2",1127,0)
 ;
"RTN","SAMIUR2",1128,0)
 ;;private;function;clean;silent;sac
"RTN","SAMIUR2",1129,0)
 ;@called-by none
"RTN","SAMIUR2",1130,0)
 ;@calls none
"RTN","SAMIUR2",1131,0)
 ;
"RTN","SAMIUR2",1132,0)
 quit "ethnicity" ; end of $$ETHNCTY
"RTN","SAMIUR2",1133,0)
 ;
"RTN","SAMIUR2",1134,0)
 ;
"RTN","SAMIUR2",1135,0)
 ;
"RTN","SAMIUR2",1136,0)
RACE(zdt,dfn,SAMIPATS) ; race
"RTN","SAMIUR2",1137,0)
 ;
"RTN","SAMIUR2",1138,0)
 ;;private;function;clean;silent;sac
"RTN","SAMIUR2",1139,0)
 ;@called-by none [call commented out in RPTTBL]
"RTN","SAMIUR2",1140,0)
 ;@calls
"RTN","SAMIUR2",1141,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",1142,0)
 ;
"RTN","SAMIUR2",1143,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",1144,0)
 new race set race=$get(@root@(dfn,"race"))
"RTN","SAMIUR2",1145,0)
 ;
"RTN","SAMIUR2",1146,0)
 quit race ; end of $$RACE
"RTN","SAMIUR2",1147,0)
 ;
"RTN","SAMIUR2",1148,0)
 ;
"RTN","SAMIUR2",1149,0)
 ;
"RTN","SAMIUR2",1150,0)
STATUS(zdt,dfn,SAMIPATS) ; patient status
"RTN","SAMIUR2",1151,0)
 ;
"RTN","SAMIUR2",1152,0)
 ;;private;function;clean;silent;sac
"RTN","SAMIUR2",1153,0)
 ;@called-by none
"RTN","SAMIUR2",1154,0)
 ;@calls
"RTN","SAMIUR2",1155,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",1156,0)
 ;
"RTN","SAMIUR2",1157,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",1158,0)
 new sid set sid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIUR2",1159,0)
 new siform set siform=$get(SAMIPATS(zdt,dfn,"siform"))
"RTN","SAMIUR2",1160,0)
 new vals set vals=$name(@root@("graph",sid,siform))
"RTN","SAMIUR2",1161,0)
 new stat set stat=$get(@vals@("sistatus"))
"RTN","SAMIUR2",1162,0)
 ;
"RTN","SAMIUR2",1163,0)
 quit stat ; end of $$STATUS
"RTN","SAMIUR2",1164,0)
 ;
"RTN","SAMIUR2",1165,0)
 ;
"RTN","SAMIUR2",1166,0)
 ;
"RTN","SAMIUR2",1167,0)
WSVALS(RTN,FILTER) ; display form values from graph
"RTN","SAMIUR2",1168,0)
 ;
"RTN","SAMIUR2",1169,0)
 ;;web service;procedure;clean;silent;sac
"RTN","SAMIUR2",1170,0)
 ;@called-by none
"RTN","SAMIUR2",1171,0)
 ;@calls
"RTN","SAMIUR2",1172,0)
 ; $$setroot^%wd
"RTN","SAMIUR2",1173,0)
 ; wsGtree^SYNVPR
"RTN","SAMIUR2",1174,0)
 ;
"RTN","SAMIUR2",1175,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIUR2",1176,0)
 new sid set sid=$get(FILTER("sid"))
"RTN","SAMIUR2",1177,0)
 if sid="" set sid=$get(FILTER("studyid"))
"RTN","SAMIUR2",1178,0)
 quit:sid=""
"RTN","SAMIUR2",1179,0)
 ;
"RTN","SAMIUR2",1180,0)
 new zform set zform=$get(FILTER("form"))
"RTN","SAMIUR2",1181,0)
 new groot
"RTN","SAMIUR2",1182,0)
 if zform="" set groot=$name(@root@("graph",sid))
"RTN","SAMIUR2",1183,0)
 else  set groot=$name(@root@("graph",sid,zform))
"RTN","SAMIUR2",1184,0)
 set FILTER("root")=$extract(groot,2,$length(groot))
"RTN","SAMIUR2",1185,0)
 ;
"RTN","SAMIUR2",1186,0)
 do wsGtree^SYNVPR(.RTN,.FILTER)
"RTN","SAMIUR2",1187,0)
 ;
"RTN","SAMIUR2",1188,0)
 quit  ; end of ws WSVALS^SAMIUR2
"RTN","SAMIUR2",1189,0)
 ;
"RTN","SAMIUR2",1190,0)
 ;
"RTN","SAMIUR2",1191,0)
 ;
"RTN","SAMIUR2",1192,0)
EOR ; end of routine SAMIUR2
"RTN","SAMIURUL")
0^22^B108116
"RTN","SAMIURUL",1,0)
SAMIURUL ;ven/gpl - user reports log ;2021-07-14T18:25Z
"RTN","SAMIURUL",2,0)
 ;;18.0;SAMI;**12**;2020-01;Build 6
"RTN","SAMIURUL",3,0)
 ;;1.18.0.12-t3+i12
"RTN","SAMIURUL",4,0)
 ;
"RTN","SAMIURUL",5,0)
 ; SAMIURUL contains the development log & module documentation for
"RTN","SAMIURUL",6,0)
 ; the VAPALS-ELCAP user-reports routines SAMIUR & SAMIUR2.
"RTN","SAMIURUL",7,0)
 ;
"RTN","SAMIURUL",8,0)
 quit  ; no entry from top
"RTN","SAMIURUL",9,0)
 ;
"RTN","SAMIURUL",10,0)
 ;
"RTN","SAMIURUL",11,0)
 ;
"RTN","SAMIURUL",12,0)
 ;@section 0 primary development
"RTN","SAMIURUL",13,0)
 ;
"RTN","SAMIURUL",14,0)
 ;
"RTN","SAMIURUL",15,0)
 ;
"RTN","SAMIURUL",16,0)
 ;@routine-credits
"RTN","SAMIURUL",17,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIURUL",18,0)
 ; toad@vistaexpertise.net
"RTN","SAMIURUL",19,0)
 ;@primary-dev-org Vista Expertise Network (ven)
"RTN","SAMIURUL",20,0)
 ; http://vistaexpertise.net
"RTN","SAMIURUL",21,0)
 ;@copyright 2021, mcglk & toad, all rights reserved
"RTN","SAMIURUL",22,0)
 ;@license see routine SAMIUL
"RTN","SAMIURUL",23,0)
 ;
"RTN","SAMIURUL",24,0)
 ;@last-updated 2021-07-14T18:25Z
"RTN","SAMIURUL",25,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIURUL",26,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIURUL",27,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIURUL",28,0)
 ;@version 1.18.0.12-t3+i12
"RTN","SAMIURUL",29,0)
 ;@release-date 2020-01
"RTN","SAMIURUL",30,0)
 ;@patch-list **12**
"RTN","SAMIURUL",31,0)
 ;
"RTN","SAMIURUL",32,0)
 ;@additional-dev Frederick D. S. Marshall (toad)
"RTN","SAMIURUL",33,0)
 ; toad@vistaexpertise.net
"RTN","SAMIURUL",34,0)
 ;@additional-dev Kenneth McGlothlen (mcglk)
"RTN","SAMIURUL",35,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIURUL",36,0)
 ;
"RTN","SAMIURUL",37,0)
 ;@module-credits
"RTN","SAMIURUL",38,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMIURUL",39,0)
 ; (VA-PALS)
"RTN","SAMIURUL",40,0)
 ; http://va-pals.org/
"RTN","SAMIURUL",41,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMIURUL",42,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMIURUL",43,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMIURUL",44,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMIURUL",45,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMIURUL",46,0)
 ; http://ielcap.com/
"RTN","SAMIURUL",47,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMIURUL",48,0)
 ; http://paraxialtech.com/
"RTN","SAMIURUL",49,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMIURUL",50,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMIURUL",51,0)
 ;
"RTN","SAMIURUL",52,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIURUL",53,0)
 ;
"RTN","SAMIURUL",54,0)
 ; 2020-02-10/12 ven/gpl 1.18.0-t04 d543f7bb,f9869dfb,0e4d8b9a,5e67489
"RTN","SAMIURUL",55,0)
 ;  SAMIUR,SAMIUR2: 1st version of revised user reports, progress on
"RTN","SAMIURUL",56,0)
 ; user reports, fixed a bug in enrollment report, add rural/urban &
"RTN","SAMIURUL",57,0)
 ; compute.
"RTN","SAMIURUL",58,0)
 ;
"RTN","SAMIURUL",59,0)
 ; 2020-02-18 ven/lgc 1.18.0-t04 76874314
"RTN","SAMIURUL",60,0)
 ;  SAMIUR: update recently edited routines.
"RTN","SAMIURUL",61,0)
 ;
"RTN","SAMIURUL",62,0)
 ; 2020-03-10/12 ven/gpl 1.18.0-t04 8de06b06,4ad52d64
"RTN","SAMIURUL",63,0)
 ;  SAMIUR: user report date filtering, fix end date logic in UR.
"RTN","SAMIURUL",64,0)
 ;
"RTN","SAMIURUL",65,0)
 ; 2019-03-24/28 ven/gpl 1.18.0 1fd4a4c,0cebb36
"RTN","SAMIURUL",66,0)
 ;  SAMIUR2: revise incomplete form report, remove ethnicity from
"RTN","SAMIURUL",67,0)
 ; enrollment report (we can't get it).
"RTN","SAMIURUL",68,0)
 ;
"RTN","SAMIURUL",69,0)
 ; 2020-04-16/23 ven/lgc 1.18.0-t04 e54b76d1b,89bffd3b
"RTN","SAMIURUL",70,0)
 ;  SAMIUR: SAMIFRM2 > SAMIFORM, SAMISUB2 > LOAD.
"RTN","SAMIURUL",71,0)
 ;
"RTN","SAMIURUL",72,0)
 ; 2019-05-08 ven/lgc 1.18.0 2172e51
"RTN","SAMIURUL",73,0)
 ;  SAMIUR2: remove blank last line.
"RTN","SAMIURUL",74,0)
 ;
"RTN","SAMIURUL",75,0)
 ; 2019-06-21 par/dom 1.18.0 c6a4a57 VAP-352
"RTN","SAMIURUL",76,0)
 ;  SAMIUR2: proper spelling of "follow up."
"RTN","SAMIURUL",77,0)
 ;
"RTN","SAMIURUL",78,0)
 ; 2019-08-03/04 ven/gpl 1.18.0 ffc94f6,d03557d,cd865e2b VPA-438
"RTN","SAMIURUL",79,0)
 ;  SAMIUR: requested changes to followup report.
"RTN","SAMIURUL",80,0)
 ;  SAMIUR2: fix smoking status on enrollment report, fix change log
"RTN","SAMIURUL",81,0)
 ; display, add pack years at intake to enrollment report, add
"RTN","SAMIURUL",82,0)
 ; requested changes to followup report.
"RTN","SAMIURUL",83,0)
 ;
"RTN","SAMIURUL",84,0)
 ; 2019-09-26 ven/gpl 1.18.0 92b12324 VAP-420
"RTN","SAMIURUL",85,0)
 ;  SAMIUR: add smoking history.
"RTN","SAMIURUL",86,0)
 ;  SAMIUR2: smoking history, new cummulative packyear processing.
"RTN","SAMIURUL",87,0)
 ;
"RTN","SAMIURUL",88,0)
 ; 2019-10-01 par/dom 1.18.0 4caf1a9 VAP-344
"RTN","SAMIURUL",89,0)
 ;  SAMIUR2: make capitalization consistent.
"RTN","SAMIURUL",90,0)
 ;
"RTN","SAMIURUL",91,0)
 ; 2020-01-01/05 ven/arc 1.18.0 399f8547,62e3200f
"RTN","SAMIURUL",92,0)
 ;  SAMIUR: unmatched participant processing.
"RTN","SAMIURUL",93,0)
 ;  SAMIUR2: add unmatched patient processing.
"RTN","SAMIURUL",94,0)
 ;
"RTN","SAMIURUL",95,0)
 ; 2020-01-10 ven/gpl 1.18.0 1590577
"RTN","SAMIURUL",96,0)
 ;  SAMIUR2: fix return on RACE^SAMIUR2 for cache.
"RTN","SAMIURUL",97,0)
 ;
"RTN","SAMIURUL",98,0)
 ; 2020-04-29/05-13 ven/gpl 1.18.0.5+i5 e8b8ea2d,61c7d208
"RTN","SAMIURUL",99,0)
 ;  SAMIUR: fixes for reports, worklist functionality.
"RTN","SAMIURUL",100,0)
 ;
"RTN","SAMIURUL",101,0)
 ; 2020-05-13/14 ven/gpl 1.18.0.5+i5 61c7d20,b05df41
"RTN","SAMIURUL",102,0)
 ;  SAMIUR2: add worklist functionality, fix gender & dob detection on
"RTN","SAMIURUL",103,0)
 ; reports.
"RTN","SAMIURUL",104,0)
 ;
"RTN","SAMIURUL",105,0)
 ; 2021-03-22/23 ven/gpl 1.18.0.10+i10 256efe63,ba81b86a2
"RTN","SAMIURUL",106,0)
 ;  SAMIUR: sort all reports by name, added row totals to reports.
"RTN","SAMIURUL",107,0)
 ;
"RTN","SAMIURUL",108,0)
 ; 2021-03-23 ven/toad 1.18.0.10+i10 96f461d0,af86e0eb
"RTN","SAMIURUL",109,0)
 ;  SAMIUR: add version info & dev log, lt refactor, fix XINDEX
"RTN","SAMIURUL",110,0)
 ; errors.
"RTN","SAMIURUL",111,0)
 ;
"RTN","SAMIURUL",112,0)
 ; 2021-03-29 ven/gpl 1.18.0.11+i11 e809f2a2
"RTN","SAMIURUL",113,0)
 ;  SAMIUR: prevent crash when reports have no matches: in WSREPORT
"RTN","SAMIURUL",114,0)
 ; set SRT="" and uncomment zwrite SRT; in WKLIST add 2 commented-out
"RTN","SAMIURUL",115,0)
 ; debugging lines.
"RTN","SAMIURUL",116,0)
 ;
"RTN","SAMIURUL",117,0)
 ; 2021-03-30 ven/toad 1.18.0.11+i11 7b14bb2
"RTN","SAMIURUL",118,0)
 ;  SAMIUR: bump version, date, log; in WSREPORT comment zwrite SRT.
"RTN","SAMIURUL",119,0)
 ;
"RTN","SAMIURUL",120,0)
 ; 2021-03-31 ven/gpl 1.18.0.11+i11 66d89cd
"RTN","SAMIURUL",121,0)
 ;  SAMIUR: sort on all uppercase names for reports
"RTN","SAMIURUL",122,0)
 ;
"RTN","SAMIURUL",123,0)
 ; 2021-04-13 ven/gpl 1.18.0.11+i11 a12765b,f09ffef,fb399ab
"RTN","SAMIURUL",124,0)
 ;  SAMIUR: inactive report created.
"RTN","SAMIURUL",125,0)
 ;  SAMIUR2: in RPTTBL,GENDER create inactive report, move last exam
"RTN","SAMIURUL",126,0)
 ; column on followup report, fix gender being blank in reports.
"RTN","SAMIURUL",127,0)
 ;
"RTN","SAMIURUL",128,0)
 ; 2021-05-20/25 ven/mcglk&toad 1.18.0.11+i11
"RTN","SAMIURUL",129,0)
 ;  SAMIUR: annotate, lt refactor, bump version.
"RTN","SAMIURUL",130,0)
 ;  SAMIUR2: passim hdr comments, chg log, annotate, refactor, bump
"RTN","SAMIURUL",131,0)
 ; version.
"RTN","SAMIURUL",132,0)
 ;
"RTN","SAMIURUL",133,0)
 ; 2021-05-29 ven/gpl 1.18.0.12-t2+i12 e6fd5730,a3d6f9a0
"RTN","SAMIURUL",134,0)
 ;  SAMIUR,SAMIUR2 ssn params & matching report, update unmatched
"RTN","SAMIURUL",135,0)
 ; report headings.
"RTN","SAMIURUL",136,0)
 ;
"RTN","SAMIURUL",137,0)
 ; 2021-06-15 ven/gpl 1.18.0.12-t2+i12 7e481426
"RTN","SAMIURUL",138,0)
 ;  SAMIUR add site to editperson navigation.
"RTN","SAMIURUL",139,0)
 ;
"RTN","SAMIURUL",140,0)
 ; 2021-06-28 ven/gpl 1.18.0.12-t2+i12 df0aaea1,1137e2bb
"RTN","SAMIURUL",141,0)
 ;  SAMIUR change definition of inactive to not marked active, change
"RTN","SAMIURUL",142,0)
 ; definition of active to marked active.
"RTN","SAMIURUL",143,0)
 ;
"RTN","SAMIURUL",144,0)
 ; 2021-07-06 ven/mcglk&toad&gpl 1.18.0.12-t2+i12 cbf7e46b,2d642aa4,
"RTN","SAMIURUL",145,0)
 ; b248664b
"RTN","SAMIURUL",146,0)
 ;  SAMIURUL new routine for dev log.
"RTN","SAMIURUL",147,0)
 ;  SAMIUR,SAMIUR2,SAMIURUL move dev log & module docs to SAMIURUL,
"RTN","SAMIURUL",148,0)
 ; bump version & dates.
"RTN","SAMIURUL",149,0)
 ;  SAMIUR in SELECT r/inactive w/status, test for active instead of
"RTN","SAMIURUL",150,0)
 ; inactive.
"RTN","SAMIURUL",151,0)
 ;
"RTN","SAMIURUL",152,0)
 ; 2021-07-12 ven/gpl 1.18.0.12-t3+i12 60f4bb05,27c40485,d35bcb46
"RTN","SAMIURUL",153,0)
 ;  SAMIUR: in WSREPORT,SORT add contact date & entry to missingct
"RTN","SAMIURUL",154,0)
 ; report.
"RTN","SAMIURUL",155,0)
 ;  SAMIUR2: add contact date & entry to missingct report; add
"RTN","SAMIURUL",156,0)
 ; inactive date reason & comment to inactive report; chg inactive
"RTN","SAMIURUL",157,0)
 ; date to date of death.
"RTN","SAMIURUL",158,0)
 ;
"RTN","SAMIURUL",159,0)
 ;
"RTN","SAMIURUL",160,0)
 ;@contents
"RTN","SAMIURUL",161,0)
 ; SAMIUR user reports
"RTN","SAMIURUL",162,0)
 ; SAMIUR2 user reports cont
"RTN","SAMIURUL",163,0)
 ; SAMIURUL user reports log
"RTN","SAMIURUL",164,0)
 ;
"RTN","SAMIURUL",165,0)
 ; SAMIUR1 [to be added]
"RTN","SAMIURUL",166,0)
 ;
"RTN","SAMIURUL",167,0)
 ;
"RTN","SAMIURUL",168,0)
 ;
"RTN","SAMIURUL",169,0)
EOR ; end of SAMIURUL
"SEC","^DIC",311.12,311.12,0,"AUDIT")
@
"SEC","^DIC",311.12,311.12,0,"DD")
@
"SEC","^DIC",311.12,311.12,0,"DEL")
@
"SEC","^DIC",311.12,311.12,0,"LAYGO")
@
"SEC","^DIC",311.12,311.12,0,"RD")
@
"SEC","^DIC",311.12,311.12,0,"WR")
@
"SEC","^DIC",311.14,311.14,0,"AUDIT")
@
"SEC","^DIC",311.14,311.14,0,"DD")
@
"SEC","^DIC",311.14,311.14,0,"DEL")
@
"SEC","^DIC",311.14,311.14,0,"LAYGO")
@
"SEC","^DIC",311.14,311.14,0,"RD")
@
"SEC","^DIC",311.14,311.14,0,"WR")
@
"VER")
8.0^22.2
"^DD",311.12,311.12,0)
FIELD^^.04^5
"^DD",311.12,311.12,0,"DT")
3210707
"^DD",311.12,311.12,0,"ID","W.02")
W "   ",$P(^(0),U,2)
"^DD",311.12,311.12,0,"IX","B",311.12,.01)

"^DD",311.12,311.12,0,"NM","SAMI SITE")

"^DD",311.12,311.12,0,"VRPK")
SAMI
"^DD",311.12,311.12,.01,0)
SITE^RP4'^DIC(4,^0;1^Q
"^DD",311.12,311.12,.01,.1)
SAMI SITE
"^DD",311.12,311.12,.01,1,0)
^.1
"^DD",311.12,311.12,.01,1,1,0)
311.12^B
"^DD",311.12,311.12,.01,1,1,1)
S ^SAMI(311.12,"B",$E(X,1,30),DA)=""
"^DD",311.12,311.12,.01,1,1,2)
K ^SAMI(311.12,"B",$E(X,1,30),DA)
"^DD",311.12,311.12,.01,3)
NAME MUST BE 3-30 CHARACTERS, NOT NUMERIC OR STARTING WITH PUNCTUATION
"^DD",311.12,311.12,.01,"DT")
3200325
"^DD",311.12,311.12,.02,0)
SYMBOL^FJ3^^0;2^K:$L(X)>3!($L(X)<1) X
"^DD",311.12,311.12,.02,.1)
SITE SYMBOL
"^DD",311.12,311.12,.02,3)
Answer must be 1-3 characters in length.
"^DD",311.12,311.12,.02,"DT")
3200407
"^DD",311.12,311.12,.03,0)
ACTIVE^St11^^3;3^
"^DD",311.12,311.12,.03,.1)
IS THE SITE ACTIVE
"^DD",311.12,311.12,.03,"DT")
3200327
"^DD",311.12,311.12,.04,0)
DEFAULT PARAMETERS^P311.14'^SAMI(311.14,^5;1^Q
"^DD",311.12,311.12,.04,.1)
PARAMETER DEFAULT
"^DD",311.12,311.12,.04,"DT")
3210423
"^DD",311.12,311.12,1,0)
PARMS^311.121^^4;0
"^DD",311.12,311.121,0)
PARMS SUB-FIELD^^.02^2
"^DD",311.12,311.121,0,"DT")
3210419
"^DD",311.12,311.121,0,"IX","B",311.121,.01)

"^DD",311.12,311.121,0,"NM","PARMS")

"^DD",311.12,311.121,0,"UP")
311.12
"^DD",311.12,311.121,.01,0)
PARM^MFJ30^^0;1^K:$L(X)>30!($L(X)<1) X
"^DD",311.12,311.121,.01,.1)
PARAMETER
"^DD",311.12,311.121,.01,1,0)
^.1
"^DD",311.12,311.121,.01,1,1,0)
311.121^B
"^DD",311.12,311.121,.01,1,1,1)
S ^SAMI(311.12,DA(1),4,"B",$E(X,1,30),DA)=""
"^DD",311.12,311.121,.01,1,1,2)
K ^SAMI(311.12,DA(1),4,"B",$E(X,1,30),DA)
"^DD",311.12,311.121,.01,3)
Answer must be 1-30 characters in length.
"^DD",311.12,311.121,.01,"DT")
3210423
"^DD",311.12,311.121,.02,0)
VALUE^FJ180^^0;2^K:$L(X)>180!($L(X)<1) X
"^DD",311.12,311.121,.02,.1)
VALUE OF PARAMETER
"^DD",311.12,311.121,.02,3)
Answer must be 1-180 characters in length.
"^DD",311.12,311.121,.02,"DT")
3210423
"^DD",311.14,311.14,0)
FIELD^^1^2
"^DD",311.14,311.14,0,"DT")
3210707
"^DD",311.14,311.14,0,"IX","B",311.14,.01)

"^DD",311.14,311.14,0,"NM","SAMI PARAMETER DEFAULTS")

"^DD",311.14,311.14,0,"PT",311.12,.04)

"^DD",311.14,311.14,0,"VRPK")
SAMI
"^DD",311.14,311.14,.01,0)
NAME^RFJ30^^0;1^K:$L(X)>30!($L(X)<3)!'(X'?1P.E) X
"^DD",311.14,311.14,.01,.1)
DEFAULT PARAMETER SET NAME
"^DD",311.14,311.14,.01,1,0)
^.1
"^DD",311.14,311.14,.01,1,1,0)
311.14^B
"^DD",311.14,311.14,.01,1,1,1)
S ^SAMI(311.14,"B",$E(X,1,30),DA)=""
"^DD",311.14,311.14,.01,1,1,2)
K ^SAMI(311.14,"B",$E(X,1,30),DA)
"^DD",311.14,311.14,.01,3)
Answer must be 3-30 characters in length.
"^DD",311.14,311.14,.01,"DT")
3210419
"^DD",311.14,311.14,1,0)
PARM^311.141^^1;0
"^DD",311.14,311.141,0)
PARM SUB-FIELD^^.02^2
"^DD",311.14,311.141,0,"DT")
3210419
"^DD",311.14,311.141,0,"IX","B",311.141,.01)

"^DD",311.14,311.141,0,"NM","PARM")

"^DD",311.14,311.141,0,"UP")
311.14
"^DD",311.14,311.141,.01,0)
PARM^MMFJ30^^0;1^K:$L(X)>30!($L(X)<1) X
"^DD",311.14,311.141,.01,.1)
PARAMETER NAME
"^DD",311.14,311.141,.01,1,0)
^.1
"^DD",311.14,311.141,.01,1,1,0)
311.141^B
"^DD",311.14,311.141,.01,1,1,1)
S ^SAMI(311.14,DA(1),1,"B",$E(X,1,30),DA)=""
"^DD",311.14,311.141,.01,1,1,2)
K ^SAMI(311.14,DA(1),1,"B",$E(X,1,30),DA)
"^DD",311.14,311.141,.01,3)
Answer must be 1-30 characters in length.
"^DD",311.14,311.141,.01,"DT")
3210420
"^DD",311.14,311.141,.02,0)
VALUE^FJ180^^0;2^K:$L(X)>180!($L(X)<1) X
"^DD",311.14,311.141,.02,.1)
PARAMETER VALUE
"^DD",311.14,311.141,.02,3)
Answer must be 1-180 characters in length.
"^DD",311.14,311.141,.02,"DT")
3210419
"^DIC",311.12,311.12,0)
SAMI SITE^311.12
"^DIC",311.12,311.12,0,"GL")
^SAMI(311.12,
"^DIC",311.12,311.12,"%",0)
^1.005^^0
"^DIC",311.12,"B","SAMI SITE",311.12)

"^DIC",311.14,311.14,0)
SAMI PARAMETER DEFAULTS^311.14
"^DIC",311.14,311.14,0,"GL")
^SAMI(311.14,
"^DIC",311.14,"B","SAMI PARAMETER DEFAULTS",311.14)

**END**
**END**
