KIDS Distribution saved on Jan 19, 2022@13:30:07
Test Release SAMI*18.0*16 SEQ #16 (sami-18-16-t3)
**KIDS**:SAMI*18.0*16^

**INSTALL NAME**
SAMI*18.0*16
"BLD",11515,0)
SAMI*18.0*16^^0^3220119^n
"BLD",11515,1,0)
^^1^1^3220119^
"BLD",11515,1,1,0)
Test release SAMI*18.0*16 SEQ #16 T3.
"BLD",11515,4,0)
^9.64PA^^
"BLD",11515,6.3)
3
"BLD",11515,"KRN",0)
^9.67PA^1.5^25
"BLD",11515,"KRN",.4,0)
.4
"BLD",11515,"KRN",.401,0)
.401
"BLD",11515,"KRN",.402,0)
.402
"BLD",11515,"KRN",.403,0)
.403
"BLD",11515,"KRN",.5,0)
.5
"BLD",11515,"KRN",.84,0)
.84
"BLD",11515,"KRN",1.5,0)
1.5
"BLD",11515,"KRN",1.6,0)
1.6
"BLD",11515,"KRN",1.61,0)
1.61
"BLD",11515,"KRN",1.62,0)
1.62
"BLD",11515,"KRN",3.6,0)
3.6
"BLD",11515,"KRN",3.8,0)
3.8
"BLD",11515,"KRN",9.2,0)
9.2
"BLD",11515,"KRN",9.8,0)
9.8
"BLD",11515,"KRN",9.8,"NM",0)
^9.68A^7^7
"BLD",11515,"KRN",9.8,"NM",1,0)
SAMIHOM4^^0^B977083192
"BLD",11515,"KRN",9.8,"NM",2,0)
SAMIHUL^^0^B117874
"BLD",11515,"KRN",9.8,"NM",3,0)
SAMIZPH1^^0^B266456408
"BLD",11515,"KRN",9.8,"NM",4,0)
SAMIDCM1^^0^B102701967
"BLD",11515,"KRN",9.8,"NM",5,0)
SAMILD2^^0^B86184080
"BLD",11515,"KRN",9.8,"NM",6,0)
SAMILOAD^^0^B65426323
"BLD",11515,"KRN",9.8,"NM",7,0)
SAMISS^^0^B285157914
"BLD",11515,"KRN",9.8,"NM","B","SAMIDCM1",4)

"BLD",11515,"KRN",9.8,"NM","B","SAMIHOM4",1)

"BLD",11515,"KRN",9.8,"NM","B","SAMIHUL",2)

"BLD",11515,"KRN",9.8,"NM","B","SAMILD2",5)

"BLD",11515,"KRN",9.8,"NM","B","SAMILOAD",6)

"BLD",11515,"KRN",9.8,"NM","B","SAMISS",7)

"BLD",11515,"KRN",9.8,"NM","B","SAMIZPH1",3)

"BLD",11515,"KRN",19,0)
19
"BLD",11515,"KRN",19.1,0)
19.1
"BLD",11515,"KRN",101,0)
101
"BLD",11515,"KRN",409.61,0)
409.61
"BLD",11515,"KRN",771,0)
771
"BLD",11515,"KRN",779.2,0)
779.2
"BLD",11515,"KRN",870,0)
870
"BLD",11515,"KRN",8989.51,0)
8989.51
"BLD",11515,"KRN",8989.52,0)
8989.52
"BLD",11515,"KRN",8993,0)
8993
"BLD",11515,"KRN",8994,0)
8994
"BLD",11515,"KRN","B",.4,.4)

"BLD",11515,"KRN","B",.401,.401)

"BLD",11515,"KRN","B",.402,.402)

"BLD",11515,"KRN","B",.403,.403)

"BLD",11515,"KRN","B",.5,.5)

"BLD",11515,"KRN","B",.84,.84)

"BLD",11515,"KRN","B",1.5,1.5)

"BLD",11515,"KRN","B",1.6,1.6)

"BLD",11515,"KRN","B",1.61,1.61)

"BLD",11515,"KRN","B",1.62,1.62)

"BLD",11515,"KRN","B",3.6,3.6)

"BLD",11515,"KRN","B",3.8,3.8)

"BLD",11515,"KRN","B",9.2,9.2)

"BLD",11515,"KRN","B",9.8,9.8)

"BLD",11515,"KRN","B",19,19)

"BLD",11515,"KRN","B",19.1,19.1)

"BLD",11515,"KRN","B",101,101)

"BLD",11515,"KRN","B",409.61,409.61)

"BLD",11515,"KRN","B",771,771)

"BLD",11515,"KRN","B",779.2,779.2)

"BLD",11515,"KRN","B",870,870)

"BLD",11515,"KRN","B",8989.51,8989.51)

"BLD",11515,"KRN","B",8989.52,8989.52)

"BLD",11515,"KRN","B",8993,8993)

"BLD",11515,"KRN","B",8994,8994)

"BLD",11515,"QUES",0)
^9.62^^
"BLD",11515,"REQB",0)
^9.611^12^12
"BLD",11515,"REQB",1,0)
SAMI*18.0*1^0
"BLD",11515,"REQB",2,0)
SAMI*18.0*2^0
"BLD",11515,"REQB",3,0)
SAMI*18.0*3^0
"BLD",11515,"REQB",4,0)
SAMI*18.0*4^0
"BLD",11515,"REQB",5,0)
SAMI 18.0T05^0
"BLD",11515,"REQB",6,0)
SAMI*18.0*6^0
"BLD",11515,"REQB",7,0)
SAMI*18.0*8^0
"BLD",11515,"REQB",8,0)
SAMI*18.0*9^0
"BLD",11515,"REQB",9,0)
SAMI*18.0*10^0
"BLD",11515,"REQB",10,0)
SAMI*18.0*11^0
"BLD",11515,"REQB",11,0)
SAMI*18.0*12^0
"BLD",11515,"REQB",12,0)
SAMI*18.0*13^0
"BLD",11515,"REQB","B","SAMI 18.0T05",5)

"BLD",11515,"REQB","B","SAMI*18.0*1",1)

"BLD",11515,"REQB","B","SAMI*18.0*10",9)

"BLD",11515,"REQB","B","SAMI*18.0*11",10)

"BLD",11515,"REQB","B","SAMI*18.0*12",11)

"BLD",11515,"REQB","B","SAMI*18.0*13",12)

"BLD",11515,"REQB","B","SAMI*18.0*2",2)

"BLD",11515,"REQB","B","SAMI*18.0*3",3)

"BLD",11515,"REQB","B","SAMI*18.0*4",4)

"BLD",11515,"REQB","B","SAMI*18.0*6",6)

"BLD",11515,"REQB","B","SAMI*18.0*8",7)

"BLD",11515,"REQB","B","SAMI*18.0*9",8)

"MBREQ")
0
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
7
"RTN","SAMIDCM1")
0^4^B102701967
"RTN","SAMIDCM1",1,0)
SAMIDCM1 ;ven/gpl - VAPALS PATIENT IMPORT FROM SIEMANS AI ; 2022-01-18t00:42z
"RTN","SAMIDCM1",2,0)
 ;;18.0;SAMI;**16**;2020-01;Build 3
"RTN","SAMIDCM1",3,0)
 ;18-16
"RTN","SAMIDCM1",4,0)
 ;
"RTN","SAMIDCM1",5,0)
 ;@license: see routine SAMIUL
"RTN","SAMIDCM1",6,0)
 ;
"RTN","SAMIDCM1",7,0)
 ;@section 0 primary development
"RTN","SAMIDCM1",8,0)
 ;
"RTN","SAMIDCM1",9,0)
 ;
"RTN","SAMIDCM1",10,0)
 ;
"RTN","SAMIDCM1",11,0)
 ;@routine-credits
"RTN","SAMIDCM1",12,0)
 ;@dev-main George P. Lilly (gpl)
"RTN","SAMIDCM1",13,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIDCM1",14,0)
 ;@dev-org-main Vista Expertise Network (ven)
"RTN","SAMIDCM1",15,0)
 ; http://vistaexpertise.net
"RTN","SAMIDCM1",16,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIDCM1",17,0)
 ;@license see routine SAMIUL
"RTN","SAMIDCM1",18,0)
 ;
"RTN","SAMIDCM1",19,0)
 ;@last-update 2022-01-18t00:42z
"RTN","SAMIDCM1",20,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIDCM1",21,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIDCM1",22,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIDCM1",23,0)
 ;@version 18-16
"RTN","SAMIDCM1",24,0)
 ;@release-date 2020-01
"RTN","SAMIDCM1",25,0)
 ;@patch-list **16**
"RTN","SAMIDCM1",26,0)
 ;
"RTN","SAMIDCM1",27,0)
 ;
"RTN","SAMIDCM1",28,0)
 ;@module-credits
"RTN","SAMIDCM1",29,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMIDCM1",30,0)
 ; (VA-PALS)
"RTN","SAMIDCM1",31,0)
 ; http://va-pals.org/
"RTN","SAMIDCM1",32,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMIDCM1",33,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMIDCM1",34,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMIDCM1",35,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMIDCM1",36,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMIDCM1",37,0)
 ; http://ielcap.com/
"RTN","SAMIDCM1",38,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMIDCM1",39,0)
 ; http://paraxialtech.com/
"RTN","SAMIDCM1",40,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMIDCM1",41,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMIDCM1",42,0)
 ;
"RTN","SAMIDCM1",43,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIDCM1",44,0)
 ;
"RTN","SAMIDCM1",45,0)
 ;
"RTN","SAMIDCM1",46,0)
 ;
"RTN","SAMIDCM1",47,0)
 ;
"RTN","SAMIDCM1",48,0)
 Q
"RTN","SAMIDCM1",49,0)
 ;
"RTN","SAMIDCM1",50,0)
WSDCMIN(ARGS,BODY,RESULT,ien)    ; recieve from addpatient
"RTN","SAMIDCM1",51,0)
 ;
"RTN","SAMIDCM1",52,0)
 s U="^"
"RTN","SAMIDCM1",53,0)
 ;S DUZ=1
"RTN","SAMIDCM1",54,0)
 ;S DUZ("AG")="V"
"RTN","SAMIDCM1",55,0)
 ;S DUZ(2)=500
"RTN","SAMIDCM1",56,0)
 ;N USER S USER=$$DUZ^SYNDHP69
"RTN","SAMIDCM1",57,0)
 ;
"RTN","SAMIDCM1",58,0)
 new json,root,gr,id,return
"RTN","SAMIDCM1",59,0)
 set root=$$setroot^%wd("dcm-intake")
"RTN","SAMIDCM1",60,0)
 if $get(ien)="" do
"RTN","SAMIDCM1",61,0)
 . set ien=$order(@root@(" "),-1)+1
"RTN","SAMIDCM1",62,0)
 . set gr=$name(@root@(ien,"json"))
"RTN","SAMIDCM1",63,0)
 . do decode^%webjson("BODY",gr)
"RTN","SAMIDCM1",64,0)
 . kill BODY  ; 
"RTN","SAMIDCM1",65,0)
 ;
"RTN","SAMIDCM1",66,0)
 ;do indexFhir(ien)
"RTN","SAMIDCM1",67,0)
 ;
"RTN","SAMIDCM1",68,0)
 set site=$get(ARGS("siteid"))
"RTN","SAMIDCM1",69,0)
 if site="" set site="XXX" ; default to test site
"RTN","SAMIDCM1",70,0)
 if site'="" set @root@("SITE",site,ien)="" ;
"RTN","SAMIDCM1",71,0)
 ;
"RTN","SAMIDCM1",72,0)
 ; patient name
"RTN","SAMIDCM1",73,0)
 ;
"RTN","SAMIDCM1",74,0)
 ;
"RTN","SAMIDCM1",75,0)
 n gp s gp=$na(@root@(ien,"json","patient_study_details"))
"RTN","SAMIDCM1",76,0)
 i '$d(@gp) d  ;
"RTN","SAMIDCM1",77,0)
 . s gp=$na(@root@(ien,"patient_details"))
"RTN","SAMIDCM1",78,0)
 . q:$d(@gp)
"RTN","SAMIDCM1",79,0)
 . s return("error")="Missing patient study details"
"RTN","SAMIDCM1",80,0)
 ;
"RTN","SAMIDCM1",81,0)
 ;patient_study_details 
"RTN","SAMIDCM1",82,0)
 ;--Frame of Reference UID 1.3.6.1.4.1.14519.5.2.1.6279.6001.178796764874541005921876698858
"RTN","SAMIDCM1",83,0)
 ;--Manufacturer Siemens Healthineers
"RTN","SAMIDCM1",84,0)
 ;--Manufacturer's Model Name AIRC Research
"RTN","SAMIDCM1",85,0)
 ;--Patient ID LIDC-IDRI-0492
"RTN","SAMIDCM1",86,0)
 ;--Patient's Birth Date 
"RTN","SAMIDCM1",87,0)
 ;--\s 
"RTN","SAMIDCM1",88,0)
 ;--Patient's Name 
"RTN","SAMIDCM1",89,0)
 ;--\s 
"RTN","SAMIDCM1",90,0)
 ;--Patient's Sex F
"RTN","SAMIDCM1",91,0)
 ;--SOP Class UID 1.2.840.10008.5.1.4.1.1.88.34
"RTN","SAMIDCM1",92,0)
 ;--Series Description AIRC Research Structured Report
"RTN","SAMIDCM1",93,0)
 ;--Slice Thickness 1
"RTN","SAMIDCM1",94,0)
 ;--\n 1.0
"RTN","SAMIDCM1",95,0)
 ;--Study Date 20000101
"RTN","SAMIDCM1",96,0)
 ;--\s 
"RTN","SAMIDCM1",97,0)
 ;--Tracking Identifier L2
"RTN","SAMIDCM1",98,0)
 ;--Tracking Unique Identifier
"RTN","SAMIDCM1",99,0)
 ;
"RTN","SAMIDCM1",100,0)
 d  ; Extract Identifying information
"RTN","SAMIDCM1",101,0)
 . n vars
"RTN","SAMIDCM1",102,0)
 . n name s name=$g(@gp@("Patient's Name"))
"RTN","SAMIDCM1",103,0)
 . i name="" s vars("name")=name
"RTN","SAMIDCM1",104,0)
 . e  s vars("name")=$$normaliz(name)
"RTN","SAMIDCM1",105,0)
 . n dob s dob=$g(@gp@("Patient's Birth Date"))
"RTN","SAMIDCM1",106,0)
 . i dob="" s dob=20000302
"RTN","SAMIDCM1",107,0)
 . s vars("dob")=dob
"RTN","SAMIDCM1",108,0)
 . n gender s gender=$g(@gp@("Patient's Sex"))
"RTN","SAMIDCM1",109,0)
 . i gender="" s gender="M"
"RTN","SAMIDCM1",110,0)
 . s vars("gender")=gender
"RTN","SAMIDCM1",111,0)
 . n patid s patid=$g(@gp@("Patient ID"))
"RTN","SAMIDCM1",112,0)
 . s vars("patid")=patid
"RTN","SAMIDCM1",113,0)
 . n studyDate s studyDate=$g(@gp@("Study Date"))
"RTN","SAMIDCM1",114,0)
 . i studyDate'="" s vars("studyDate")=studyDate
"RTN","SAMIDCM1",115,0)
 . n trackingIdentifier
"RTN","SAMIDCM1",116,0)
 . s trackingIdentifier=$g(@gp@("Tracking Identifier"))
"RTN","SAMIDCM1",117,0)
 . s vars("trackingIdentifier")=trackingIdentifier
"RTN","SAMIDCM1",118,0)
 . s vars("site")=site
"RTN","SAMIDCM1",119,0)
 . s vars("ssn")=999999999
"RTN","SAMIDCM1",120,0)
 . s vars("sistatus")="active"
"RTN","SAMIDCM1",121,0)
 . ;
"RTN","SAMIDCM1",122,0)
 . i '$$MATCH^SAMIDCM1(.vars) d CREATE^SAMIZPH1(.vars)
"RTN","SAMIDCM1",123,0)
 . m @root@(ien)=vars
"RTN","SAMIDCM1",124,0)
 . s name=$g(vars("name"))
"RTN","SAMIDCM1",125,0)
 . i name'="" s @root@("name",name,ien)=""
"RTN","SAMIDCM1",126,0)
 . n studyid s studyid=$g(vars("studyid"))
"RTN","SAMIDCM1",127,0)
 . i studyid'="" s @root@("studyid",studyid,ien)=""
"RTN","SAMIDCM1",128,0)
 . n dfn s dfn=$g(vars("dfn"))
"RTN","SAMIDCM1",129,0)
 . i dfn'="" s @root@("dfn",dfn,ien)=""
"RTN","SAMIDCM1",130,0)
 . i patid'="" s @root@("patid",patid,ien)=""
"RTN","SAMIDCM1",131,0)
 ;
"RTN","SAMIDCM1",132,0)
 ;
"RTN","SAMIDCM1",133,0)
 set return("status")="ok"
"RTN","SAMIDCM1",134,0)
 set return("siteid")=site
"RTN","SAMIDCM1",135,0)
 set return("ien")=ien
"RTN","SAMIDCM1",136,0)
 ;
"RTN","SAMIDCM1",137,0)
 if $get(ARGS("returngraph"))=1 do  ;
"RTN","SAMIDCM1",138,0)
 . merge return("graph")=@root@(ien)
"RTN","SAMIDCM1",139,0)
 ;
"RTN","SAMIDCM1",140,0)
 n jary
"RTN","SAMIDCM1",141,0)
 m jary("result")=return
"RTN","SAMIDCM1",142,0)
 d encode^%webjson("jary","RESULT")
"RTN","SAMIDCM1",143,0)
 s HTTPRSP("mime")="application/json"
"RTN","SAMIDCM1",144,0)
 ;
"RTN","SAMIDCM1",145,0)
 q
"RTN","SAMIDCM1",146,0)
 ;
"RTN","SAMIDCM1",147,0)
MATCH(vars) ; extrinsic which tries to match the message with an
"RTN","SAMIDCM1",148,0)
 ; existing record
"RTN","SAMIDCM1",149,0)
 ;
"RTN","SAMIDCM1",150,0)
 n lroot,proot,droot
"RTN","SAMIDCM1",151,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIDCM1",152,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIDCM1",153,0)
 s droot=$$setroot^%wd("dcm-intake")
"RTN","SAMIDCM1",154,0)
 n found s found=0
"RTN","SAMIDCM1",155,0)
 n name s name=$$normaliz($g(vars("name")))
"RTN","SAMIDCM1",156,0)
 n patid s patid=$g(vars("patid"))
"RTN","SAMIDCM1",157,0)
 n dien,lien,pien
"RTN","SAMIDCM1",158,0)
 ; first look at the dcm-intake for name matches
"RTN","SAMIDCM1",159,0)
 s dien=$o(@droot@("name",name,""))
"RTN","SAMIDCM1",160,0)
 i dien'="" d  ; the name has been found locally
"RTN","SAMIDCM1",161,0)
 . s found=1
"RTN","SAMIDCM1",162,0)
 . n dfn,studyid
"RTN","SAMIDCM1",163,0)
 . s dfn=$g(@droot@(dien,"dfn"))
"RTN","SAMIDCM1",164,0)
 . i dfn'="" s vars("dfn")=dfn
"RTN","SAMIDCM1",165,0)
 . i dfn="" s found=0 q  ;
"RTN","SAMIDCM1",166,0)
 . s studyid=$g(@droot@(dien,"studyid"))
"RTN","SAMIDCM1",167,0)
 . i studyid="" s found=0 q  ;
"RTN","SAMIDCM1",168,0)
 . i studyid'="" s vars("studyid")=studyid
"RTN","SAMIDCM1",169,0)
 if found=1 q found
"RTN","SAMIDCM1",170,0)
 i dien="" d  ; not here, check patient-lookup
"RTN","SAMIDCM1",171,0)
 . s lien=$o(@lroot@("name",name,""))
"RTN","SAMIDCM1",172,0)
 . i lien="" s found=0 q  ;
"RTN","SAMIDCM1",173,0)
 . i lien'="" s found=1
"RTN","SAMIDCM1",174,0)
 . n dfn,studyid
"RTN","SAMIDCM1",175,0)
 . s dfn=$g(@lroot@(lien,"dfn"))
"RTN","SAMIDCM1",176,0)
 . s vars("dfn")=dfn
"RTN","SAMIDCM1",177,0)
 . i dfn="" s found=0 q  ;
"RTN","SAMIDCM1",178,0)
 . s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIDCM1",179,0)
 . d ENROLL^SAMIZPH1(.vars)
"RTN","SAMIDCM1",180,0)
 . s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIDCM1",181,0)
 . i pien="" s found=0 q  ;
"RTN","SAMIDCM1",182,0)
 . s studyid=$g(@proot@(pien,"studyid"))
"RTN","SAMIDCM1",183,0)
 . s vars("studyid")=studyid
"RTN","SAMIDCM1",184,0)
 . i studyid="" s found=0 q  ;
"RTN","SAMIDCM1",185,0)
 ;
"RTN","SAMIDCM1",186,0)
 Q found
"RTN","SAMIDCM1",187,0)
 ;
"RTN","SAMIDCM1",188,0)
normaliz(name) ; extrinsic which tries to normalize the name
"RTN","SAMIDCM1",189,0)
 ;
"RTN","SAMIDCM1",190,0)
 n znam s znam=name
"RTN","SAMIDCM1",191,0)
 i name'["," d  ; if no comma, then try a space
"RTN","SAMIDCM1",192,0)
 . i $l(name," ")>0 d  ;
"RTN","SAMIDCM1",193,0)
 . . n fnam,lnam
"RTN","SAMIDCM1",194,0)
 . . s fnam=$p(name," ",1)
"RTN","SAMIDCM1",195,0)
 . . s lnam=$p(name," ",$l(name," "))
"RTN","SAMIDCM1",196,0)
 . . s fnam=$p(name,lnam,1)
"RTN","SAMIDCM1",197,0)
 . . s znam=lnam_","_fnam
"RTN","SAMIDCM1",198,0)
 q znam
"RTN","SAMIDCM1",199,0)
 ;
"RTN","SAMIDCM1",200,0)
nxtdfn() ; next available dfn
"RTN","SAMIDCM1",201,0)
 ;
"RTN","SAMIDCM1",202,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIDCM1",203,0)
 q $o(@root@("dfn"," "),-1)+1
"RTN","SAMIDCM1",204,0)
 ;
"RTN","SAMIDCM1",205,0)
getsid(name) ; return studyid
"RTN","SAMIDCM1",206,0)
 ;
"RTN","SAMIDCM1",207,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIDCM1",208,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIDCM1",209,0)
 n lien s lien=$o(@root@("name",name,""))
"RTN","SAMIDCM1",210,0)
 n dfn s dfn=$g(@root@(lien,"dfn"))
"RTN","SAMIDCM1",211,0)
 n pien s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIDCM1",212,0)
 q:pien="" ""
"RTN","SAMIDCM1",213,0)
 q $g(@proot@(pien,"sisid"))
"RTN","SAMIDCM1",214,0)
 ;
"RTN","SAMIDCM1",215,0)
T1() ; TEST CREATE A JOHN DOE PATIENT
"RTN","SAMIDCM1",216,0)
 ;
"RTN","SAMIDCM1",217,0)
 D  ;
"RTN","SAMIDCM1",218,0)
 . n vars
"RTN","SAMIDCM1",219,0)
 . s vars("dob")=20000302
"RTN","SAMIDCM1",220,0)
 . s vars("gender")="M"
"RTN","SAMIDCM1",221,0)
 . n nxtdfn s nxtdfn=$$nxtdfn^SAMIDCM1()
"RTN","SAMIDCM1",222,0)
 . s vars("saminame")="DOE"_nxtdfn_",JOHN"
"RTN","SAMIDCM1",223,0)
 . s vars("name")=vars("saminame")
"RTN","SAMIDCM1",224,0)
 . s vars("site")="XXX"
"RTN","SAMIDCM1",225,0)
 . s vars("ssn")=999999999
"RTN","SAMIDCM1",226,0)
 . s vars("sistatus")="active"
"RTN","SAMIDCM1",227,0)
 . d CREATE^SAMIZPH1(.vars)
"RTN","SAMIDCM1",228,0)
 . ZWR vars
"RTN","SAMIDCM1",229,0)
 Q
"RTN","SAMIDCM1",230,0)
 ;
"RTN","SAMIDCM1",231,0)
IDXDCM(dien,ARY) ; index a dcm entry after patient record creation
"RTN","SAMIDCM1",232,0)
 ;
"RTN","SAMIDCM1",233,0)
 n droot s droot=$$setroot^%wd("dcm-intake")
"RTN","SAMIDCM1",234,0)
 i $d(ARY) m @droot@(dien)=ARY
"RTN","SAMIDCM1",235,0)
 d  ;
"RTN","SAMIDCM1",236,0)
 . n x
"RTN","SAMIDCM1",237,0)
 . s x=$g(@droot@(dien,"dfn"))
"RTN","SAMIDCM1",238,0)
 . if x'="" s @droot@("dfn",x,dien)=""
"RTN","SAMIDCM1",239,0)
 . s x=$g(@droot@(dien,"saminame"))
"RTN","SAMIDCM1",240,0)
 . i x="" s x=$g(@droot@(dien,"name"))
"RTN","SAMIDCM1",241,0)
 . i x'="" s @droot@("name",x,dien)=""
"RTN","SAMIDCM1",242,0)
 . s x=$g(@droot@(dien,"studyid"))
"RTN","SAMIDCM1",243,0)
 . i x="" s x=$g(@droot@(dien,"sid"))
"RTN","SAMIDCM1",244,0)
 . i x'="" s @droot@("sid",x,dien)=""
"RTN","SAMIDCM1",245,0)
 ;
"RTN","SAMIDCM1",246,0)
WSDCMQ(return,filter) ; web service which returns dcm json
"RTN","SAMIDCM1",247,0)
 n root s root=$$setroot^%wd("dcm-intake")
"RTN","SAMIDCM1",248,0)
 n sid s sid=$g(filter("studyid"))
"RTN","SAMIDCM1",249,0)
 i sid="" s sid=$g(filter("sid"))
"RTN","SAMIDCM1",250,0)
 i sid="" q ""
"RTN","SAMIDCM1",251,0)
 n ien s ien=$o(@root@("studyid",sid,""))
"RTN","SAMIDCM1",252,0)
 i ien="" q ""
"RTN","SAMIDCM1",253,0)
 ;n ien s ien=$o(@root@(" "),-1)
"RTN","SAMIDCM1",254,0)
 ;
"RTN","SAMIDCM1",255,0)
 n jary,json
"RTN","SAMIDCM1",256,0)
 n cnt s cnt=0
"RTN","SAMIDCM1",257,0)
 s ien=""
"RTN","SAMIDCM1",258,0)
 f  s ien=$o(@root@("studyid",sid,ien)) q:ien=""  d  ;
"RTN","SAMIDCM1",259,0)
 . s cnt=cnt+1
"RTN","SAMIDCM1",260,0)
 . m jary("result",cnt)=@root@(ien,"json")
"RTN","SAMIDCM1",261,0)
 d encode^%webjson("jary","return")
"RTN","SAMIDCM1",262,0)
 q
"RTN","SAMIDCM1",263,0)
 ;
"RTN","SAMIDCM1",264,0)
WSDCMKIL(return,filter) ; kill all but the first entry in dcm-intake
"RTN","SAMIDCM1",265,0)
 ;
"RTN","SAMIDCM1",266,0)
 n lroot,proot,droot
"RTN","SAMIDCM1",267,0)
 n lien,pien,dien s (lien,pien,dien)=""
"RTN","SAMIDCM1",268,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIDCM1",269,0)
 s proot=$$setroot^%wd("vapals-patient")
"RTN","SAMIDCM1",270,0)
 s droot=$$setroot^%wd("dcm-intake")
"RTN","SAMIDCM1",271,0)
 n nam s nam="DOE"
"RTN","SAMIDCM1",272,0)
 f i="DOE","PATIENT" d  ;
"RTN","SAMIDCM1",273,0)
 . s nam=i
"RTN","SAMIDCM1",274,0)
 . f  s nam=$o(@lroot@("name",nam)) q:nam=""  q:nam'[i  d  ;
"RTN","SAMIDCM1",275,0)
 . . f  s lien=$o(@lroot@("name",nam,lien)) q:lien=""  d  ;
"RTN","SAMIDCM1",276,0)
 . . . ;w !,nam," ",lien
"RTN","SAMIDCM1",277,0)
 . . . d UNINDXPT^SAMIHOM4(lien)
"RTN","SAMIDCM1",278,0)
 . . . n newnam
"RTN","SAMIDCM1",279,0)
 . . . s newnam="ZZZ"_$e(nam,4,$l(nam))
"RTN","SAMIDCM1",280,0)
 . . . s @lroot@(lien,"saminame")=newnam
"RTN","SAMIDCM1",281,0)
 . . . s @lroot@(lien,"name")=newnam
"RTN","SAMIDCM1",282,0)
 . . . s @lroot@(lien,"fname")=$p(newnam,",",2)
"RTN","SAMIDCM1",283,0)
 . . . s @lroot@(lien,"lname")=$p(newnam,",",1)
"RTN","SAMIDCM1",284,0)
 . . . d INDXPTLK^SAMIHOM4(lien)
"RTN","SAMIDCM1",285,0)
 n atmp s atmp=@droot@(0)
"RTN","SAMIDCM1",286,0)
 k @droot
"RTN","SAMIDCM1",287,0)
 s @droot@(0)=atmp
"RTN","SAMIDCM1",288,0)
 ;i $d(^webbak(587)) d  ;
"RTN","SAMIDCM1",289,0)
 ;. m @droot=^webbak(587) ; restore default
"RTN","SAMIDCM1",290,0)
 i $d(^webbak(667)) d  ;
"RTN","SAMIDCM1",291,0)
 . m @droot=^webbak(667) ; restore default
"RTN","SAMIDCM1",292,0)
 . n sid,sidien
"RTN","SAMIDCM1",293,0)
 . ;f dfn="9000227"  d  ;
"RTN","SAMIDCM1",294,0)
 . f dfn="9000057","9000058" d  ;
"RTN","SAMIDCM1",295,0)
 . . s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIDCM1",296,0)
 . . q:lien=""
"RTN","SAMIDCM1",297,0)
 . . d UNINDXPT^SAMIHOM4(lien)
"RTN","SAMIDCM1",298,0)
 . . n newname
"RTN","SAMIDCM1",299,0)
 . . s newname="DOE"_dfn_",JOHN"
"RTN","SAMIDCM1",300,0)
 . . s @lroot@(lien,"name")=newname
"RTN","SAMIDCM1",301,0)
 . . s @lroot@(lien,"saminame")=newname
"RTN","SAMIDCM1",302,0)
 . . s @lroot@(lien,"fname")=$p(newname,",",2)
"RTN","SAMIDCM1",303,0)
 . . s @lroot@(lien,"lname")=$p(newname,",",1)
"RTN","SAMIDCM1",304,0)
 . . d INDXPTLK^SAMIHOM4(lien)
"RTN","SAMIDCM1",305,0)
 q
"RTN","SAMIDCM1",306,0)
 ;
"RTN","SAMIDCM1",307,0)
 ;n root s root=$$setroot^%wd("dcm-intake")
"RTN","SAMIDCM1",308,0)
 ;n sid s sid=$g(@root@(1,"sid"))
"RTN","SAMIDCM1",309,0)
 ;i sid="" s sid="XXX0023"
"RTN","SAMIDCM1",310,0)
 ;n atmp m atmp=@root@(1)
"RTN","SAMIDCM1",311,0)
 ;d purgegraph^%wd("dcm-intake")
"RTN","SAMIDCM1",312,0)
 ;s root=$$setroot^%wd("dcm-intake")
"RTN","SAMIDCM1",313,0)
 ;m @root@(1)=atmp
"RTN","SAMIDCM1",314,0)
 ;s @root@("sid",sid,1)=""
"RTN","SAMIDCM1",315,0)
 q
"RTN","SAMIDCM1",316,0)
 ;
"RTN","SAMIDCM1",317,0)
MKSVC() ; create the web services
"RTN","SAMIDCM1",318,0)
 ;
"RTN","SAMIDCM1",319,0)
 d deleteService^%webutils("POST","dcmin")
"RTN","SAMIDCM1",320,0)
 d addService^%webutils("POST","dcmin","WSDCMIN^SAMIDCM1")
"RTN","SAMIDCM1",321,0)
 ;
"RTN","SAMIDCM1",322,0)
 d deleteService^%webutils("GET","dcmquery")
"RTN","SAMIDCM1",323,0)
 d addService^%webutils("GET","dcmquery","WSDCMQ^SAMIDCM1")
"RTN","SAMIDCM1",324,0)
 ;
"RTN","SAMIDCM1",325,0)
 d deleteService^%webutils("GET","dcmreset")
"RTN","SAMIDCM1",326,0)
 d addService^%webutils("GET","dcmreset","WSDCMKIL^SAMIDCM1")
"RTN","SAMIDCM1",327,0)
 ;
"RTN","SAMIDCM1",328,0)
 Q
"RTN","SAMIDCM1",329,0)
 ;
"RTN","SAMIHOM4")
0^1^B977083192
"RTN","SAMIHOM4",1,0)
SAMIHOM4 ;ven/gpl,arc - homepage web services ;;2022-01-17t23:30z
"RTN","SAMIHOM4",2,0)
 ;;18.0;SAMI;**1,4,5,6,9,12,15,16**;2020-01;Build 3
"RTN","SAMIHOM4",3,0)
 ;18-15
"RTN","SAMIHOM4",4,0)
 ;
"RTN","SAMIHOM4",5,0)
 ; SAMIHOM4 contains web services & other subroutines for producing
"RTN","SAMIHOM4",6,0)
 ; the ELCAP Home Page.
"RTN","SAMIHOM4",7,0)
 ;
"RTN","SAMIHOM4",8,0)
 quit  ; no entry from top
"RTN","SAMIHOM4",9,0)
 ;
"RTN","SAMIHOM4",10,0)
 ;
"RTN","SAMIHOM4",11,0)
 ;
"RTN","SAMIHOM4",12,0)
 ;@section 0 primary development
"RTN","SAMIHOM4",13,0)
 ;
"RTN","SAMIHOM4",14,0)
 ;
"RTN","SAMIHOM4",15,0)
 ;
"RTN","SAMIHOM4",16,0)
 ;@license see routine SAMIUL
"RTN","SAMIHOM4",17,0)
 ;@documentation see SAMIHUL
"RTN","SAMIHOM4",18,0)
 ;@contents
"RTN","SAMIHOM4",19,0)
 ;
"RTN","SAMIHOM4",20,0)
 ;  web service get vapals & related subroutines
"RTN","SAMIHOM4",21,0)
 ;
"RTN","SAMIHOM4",22,0)
 ; WSHOME code for wsi WSHOME^SAMIHOM3
"RTN","SAMIHOM4",23,0)
 ;    get vapals (vapals-elcap homepage)
"RTN","SAMIHOM4",24,0)
 ; DEVHOME code for wpi DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",25,0)
 ;    development home page
"RTN","SAMIHOM4",26,0)
 ; GETHOME code for wpi GETHOME^SAMIHOM3
"RTN","SAMIHOM4",27,0)
 ;    get homepage (not subsequent visit)
"RTN","SAMIHOM4",28,0)
 ;
"RTN","SAMIHOM4",29,0)
 ;  web service post vapals & related subroutines
"RTN","SAMIHOM4",30,0)
 ;
"RTN","SAMIHOM4",31,0)
 ; WSVAPALS code for wsi WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",32,0)
 ;    post vapals (main gateway)
"RTN","SAMIHOM4",33,0)
 ;
"RTN","SAMIHOM4",34,0)
 ;  other
"RTN","SAMIHOM4",35,0)
 ;
"RTN","SAMIHOM4",36,0)
 ; REG manual registration
"RTN","SAMIHOM4",37,0)
 ; MKPTLK creates patient-lookup record
"RTN","SAMIHOM4",38,0)
 ; UPDTFRMS update demographics in all forms for patient
"RTN","SAMIHOM4",39,0)
 ; MERGE merge participant records
"RTN","SAMIHOM4",40,0)
 ; ADDUNMAT adds unmatched report web service to system
"RTN","SAMIHOM4",41,0)
 ; DELUNMAT deletes unmatched web service
"RTN","SAMIHOM4",42,0)
 ; WSUNMAT navigates to unmatched report
"RTN","SAMIHOM4",43,0)
 ; $$DUPSSN true if duplicate ssn
"RTN","SAMIHOM4",44,0)
 ; $$DUPICN true if duplicate icn
"RTN","SAMIHOM4",45,0)
 ; $$BADICN true if ICN checkdigits are wrong
"RTN","SAMIHOM4",46,0)
 ; SAVE save patient-lookup record after edit
"RTN","SAMIHOM4",47,0)
 ; $$REMATCH possible match ien
"RTN","SAMIHOM4",48,0)
 ; SETINFO set information message text
"RTN","SAMIHOM4",49,0)
 ; SETWARN set warning message text
"RTN","SAMIHOM4",50,0)
 ; RTNERR redisplay page w/error message
"RTN","SAMIHOM4",51,0)
 ; RTNPAGE display page
"RTN","SAMIHOM4",52,0)
 ; REINDXPL reindex patient lookup
"RTN","SAMIHOM4",53,0)
 ; INDXPTLK generate index entries in patient-lookup graph
"RTN","SAMIHOM4",54,0)
 ; UNINDXPT remove index entries from patient-lookup graph
"RTN","SAMIHOM4",55,0)
 ; $$UCASE uppercase
"RTN","SAMIHOM4",56,0)
 ; WSNEWCAS code for wr newcase (creates new case)
"RTN","SAMIHOM4",57,0)
 ;
"RTN","SAMIHOM4",58,0)
 ;@to-do
"RTN","SAMIHOM4",59,0)
 ; Add label comments
"RTN","SAMIHOM4",60,0)
 ;
"RTN","SAMIHOM4",61,0)
 ;
"RTN","SAMIHOM4",62,0)
 ;
"RTN","SAMIHOM4",63,0)
 ;@section 1 web service get vapals & related subroutines
"RTN","SAMIHOM4",64,0)
 ;
"RTN","SAMIHOM4",65,0)
 ;
"RTN","SAMIHOM4",66,0)
 ;
"RTN","SAMIHOM4",67,0)
 ;@wsi-code WSHOME^SAMIHOM3
"RTN","SAMIHOM4",68,0)
WSHOME ; get vapals (vapals-elcap homepage)
"RTN","SAMIHOM4",69,0)
 ;
"RTN","SAMIHOM4",70,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",71,0)
 ;
"RTN","SAMIHOM4",72,0)
 ;ven/gpl;wsi;procedure;clean;silent;sac;tests
"RTN","SAMIHOM4",73,0)
 ;@signature
"RTN","SAMIHOM4",74,0)
 ; do WSHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",75,0)
 ;@branches-from
"RTN","SAMIHOM4",76,0)
 ; WSHOME^SAMIHOM3
"RTN","SAMIHOM4",77,0)
 ;@wsi-called-by
"RTN","SAMIHOM4",78,0)
 ; web service get vapals
"RTN","SAMIHOM4",79,0)
 ; WSVAPALS^SAMIHOM4
"RTN","SAMIHOM4",80,0)
 ; LOGIN^SAMISITE
"RTN","SAMIHOM4",81,0)
 ;@called-by none
"RTN","SAMIHOM4",82,0)
 ;@calls
"RTN","SAMIHOM4",83,0)
 ; DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",84,0)
 ; WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",85,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMIHOM4",86,0)
 ;@input
"RTN","SAMIHOM4",87,0)
 ; SAMIFILTER (no parameters required)
"RTN","SAMIHOM4",88,0)
 ;@output
"RTN","SAMIHOM4",89,0)
 ; .SAMIRTN
"RTN","SAMIHOM4",90,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",91,0)
 ;@tests
"RTN","SAMIHOM4",92,0)
 ; UTWSHM^SAMIUTH3
"RTN","SAMIHOM4",93,0)
 ; UTWSHM1^SAMIUTH3
"RTN","SAMIHOM4",94,0)
 ; UTWSHM2^SAMIUTH3
"RTN","SAMIHOM4",95,0)
 ;
"RTN","SAMIHOM4",96,0)
 ;
"RTN","SAMIHOM4",97,0)
 ;@stanza 2 route to appropriate homepage or bypass to other webpage
"RTN","SAMIHOM4",98,0)
 ;
"RTN","SAMIHOM4",99,0)
 ; present development homepage for testing
"RTN","SAMIHOM4",100,0)
 if $get(SAMIFILTER("test"))=1 do  quit
"RTN","SAMIHOM4",101,0)
 . do DEVHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER)
"RTN","SAMIHOM4",102,0)
 . quit
"RTN","SAMIHOM4",103,0)
 ;
"RTN","SAMIHOM4",104,0)
 ; bypass for get access to pages
"RTN","SAMIHOM4",105,0)
 if $g(SAMIFILTER("samiroute"))'="" do  quit
"RTN","SAMIHOM4",106,0)
 . new SAMIBODY set SAMIBODY(1)=""
"RTN","SAMIHOM4",107,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",108,0)
 . quit
"RTN","SAMIHOM4",109,0)
 ;
"RTN","SAMIHOM4",110,0)
 ; V4W/DLW - bypass for get access from CPRS
"RTN","SAMIHOM4",111,0)
 if $get(SAMIFILTER("dfn"))'="" do  quit
"RTN","SAMIHOM4",112,0)
 . new dfn set dfn=$get(SAMIFILTER("dfn"))
"RTN","SAMIHOM4",113,0)
 . new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",114,0)
 . new studyid set studyid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIHOM4",115,0)
 . new SAMIBODY
"RTN","SAMIHOM4",116,0)
 . if studyid'="" do
"RTN","SAMIHOM4",117,0)
 . . set SAMIBODY(1)="samiroute=casereview&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",118,0)
 . . quit
"RTN","SAMIHOM4",119,0)
 . else  do
"RTN","SAMIHOM4",120,0)
 . . set SAMIBODY(1)="samiroute=lookup&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",121,0)
 . . quit
"RTN","SAMIHOM4",122,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",123,0)
 . quit
"RTN","SAMIHOM4",124,0)
 ;
"RTN","SAMIHOM4",125,0)
 ; default to VAPALS homepage
"RTN","SAMIHOM4",126,0)
 do GETHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER)
"RTN","SAMIHOM4",127,0)
 ;
"RTN","SAMIHOM4",128,0)
 ;
"RTN","SAMIHOM4",129,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",130,0)
 ;
"RTN","SAMIHOM4",131,0)
 quit  ; end of wsi WSHOME^SAMIHOM3
"RTN","SAMIHOM4",132,0)
 ;
"RTN","SAMIHOM4",133,0)
 ;
"RTN","SAMIHOM4",134,0)
 ;
"RTN","SAMIHOM4",135,0)
 ;@wpi-code DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",136,0)
DEVHOME ; development home page
"RTN","SAMIHOM4",137,0)
 ;
"RTN","SAMIHOM4",138,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",139,0)
 ;
"RTN","SAMIHOM4",140,0)
 ;ven/gpl;wpi;procedure;clean;silent;sac;tests
"RTN","SAMIHOM4",141,0)
 ;@signature
"RTN","SAMIHOM4",142,0)
 ; do DEVHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",143,0)
 ;@branches-from
"RTN","SAMIHOM4",144,0)
 ; DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",145,0)
 ;@wpi-called-by
"RTN","SAMIHOM4",146,0)
 ; wsi WSHOME^SAMIHOM3 [web service get vapals]
"RTN","SAMIHOM4",147,0)
 ;@called-by none
"RTN","SAMIHOM4",148,0)
 ;@calls
"RTN","SAMIHOM4",149,0)
 ; htmltb2^%yottaweb
"RTN","SAMIHOM4",150,0)
 ; PATLIST^SAMIHOM3
"RTN","SAMIHOM4",151,0)
 ; genhtml^%yottautl
"RTN","SAMIHOM4",152,0)
 ; addary^%yottautl
"RTN","SAMIHOM4",153,0)
 ;@input
"RTN","SAMIHOM4",154,0)
 ; SAMIFILTER =
"RTN","SAMIHOM4",155,0)
 ;@output
"RTN","SAMIHOM4",156,0)
 ;.SAMIRTN =
"RTN","SAMIHOM4",157,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",158,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",159,0)
 ;
"RTN","SAMIHOM4",160,0)
 ;
"RTN","SAMIHOM4",161,0)
 ;@stanza 2 present development homepage
"RTN","SAMIHOM4",162,0)
 ;
"RTN","SAMIHOM4",163,0)
 new gtop,gbot
"RTN","SAMIHOM4",164,0)
 do htmltb2^%yottaweb(.gtop,.gbot,"SAMI Test Patients")
"RTN","SAMIHOM4",165,0)
 ;
"RTN","SAMIHOM4",166,0)
 new html,ary,hpat
"RTN","SAMIHOM4",167,0)
 do PATLIST^SAMIHOM3("hpat")
"RTN","SAMIHOM4",168,0)
 quit:'$data(hpat)
"RTN","SAMIHOM4",169,0)
 ;
"RTN","SAMIHOM4",170,0)
 set ary("title")="SAMI Test Patients on this system"
"RTN","SAMIHOM4",171,0)
 set ary("header",1)="StudyId"
"RTN","SAMIHOM4",172,0)
 set ary("header",2)="Name"
"RTN","SAMIHOM4",173,0)
 ;
"RTN","SAMIHOM4",174,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",175,0)
 new zi set zi=""
"RTN","SAMIHOM4",176,0)
 for  do  quit:zi=""
"RTN","SAMIHOM4",177,0)
 . set zi=$order(hpat(zi))
"RTN","SAMIHOM4",178,0)
 . quit:zi=""
"RTN","SAMIHOM4",179,0)
 . ;
"RTN","SAMIHOM4",180,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",181,0)
 . new url set url="<a href=""/cform.cgi?studyId="_zi_""">"_zi_"</a>"
"RTN","SAMIHOM4",182,0)
 . set ary(cnt,1)=url
"RTN","SAMIHOM4",183,0)
 . set ary(cnt,2)=""
"RTN","SAMIHOM4",184,0)
 . quit
"RTN","SAMIHOM4",185,0)
 ;
"RTN","SAMIHOM4",186,0)
 do genhtml^%yottautl("html","ary")
"RTN","SAMIHOM4",187,0)
 ;
"RTN","SAMIHOM4",188,0)
 do addary^%yottautl("SAMIRTN","gtop")
"RTN","SAMIHOM4",189,0)
 do addary^%yottautl("SAMIRTN","html")
"RTN","SAMIHOM4",190,0)
 set SAMIRTN($order(SAMIRTN(""),-1)+1)=gbot
"RTN","SAMIHOM4",191,0)
 kill SAMIRTN(0)
"RTN","SAMIHOM4",192,0)
 ;
"RTN","SAMIHOM4",193,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMIHOM4",194,0)
 ;
"RTN","SAMIHOM4",195,0)
 ;
"RTN","SAMIHOM4",196,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",197,0)
 ;
"RTN","SAMIHOM4",198,0)
 quit  ; end of wpi DEVHOME^SAMIHOM3
"RTN","SAMIHOM4",199,0)
 ;
"RTN","SAMIHOM4",200,0)
 ;
"RTN","SAMIHOM4",201,0)
 ;
"RTN","SAMIHOM4",202,0)
 ;@wpi-code GETHOME^SAMIHOM3
"RTN","SAMIHOM4",203,0)
GETHOME ; get homepage (not subsequent visit)
"RTN","SAMIHOM4",204,0)
 ;
"RTN","SAMIHOM4",205,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",206,0)
 ;
"RTN","SAMIHOM4",207,0)
 ;ven/gpl;wpi;procedure;clean;silent;sac;tests
"RTN","SAMIHOM4",208,0)
 ;@signature
"RTN","SAMIHOM4",209,0)
 ; do GETHOME^SAMIHOM3(SAMIRTN,SAMIFILTER)
"RTN","SAMIHOM4",210,0)
 ;@branches-from
"RTN","SAMIHOM4",211,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMIHOM4",212,0)
 ;@wpi-called-by
"RTN","SAMIHOM4",213,0)
 ; WSHOME
"RTN","SAMIHOM4",214,0)
 ; WSVAPALS
"RTN","SAMIHOM4",215,0)
 ; SAVE
"RTN","SAMIHOM4",216,0)
 ;  WSNEWCAS [commented out]
"RTN","SAMIHOM4",217,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMIHOM4",218,0)
 ; WSLOOKUP^SAMISRC2
"RTN","SAMIHOM4",219,0)
 ; WSREPORT^SAMIUR
"RTN","SAMIHOM4",220,0)
 ; WSREPORT^SAMIUR1
"RTN","SAMIHOM4",221,0)
 ;@called-by none
"RTN","SAMIHOM4",222,0)
 ;@calls
"RTN","SAMIHOM4",223,0)
 ; $$FINDSITE^SAMISITE
"RTN","SAMIHOM4",224,0)
 ; GETTMPL^SAMICASE
"RTN","SAMIHOM4",225,0)
 ; MERGEHTM^%wf
"RTN","SAMIHOM4",226,0)
 ; ADDCRLF^VPRJRUT
"RTN","SAMIHOM4",227,0)
 ;@input
"RTN","SAMIHOM4",228,0)
 ; SAMIFILTER
"RTN","SAMIHOM4",229,0)
 ;@output
"RTN","SAMIHOM4",230,0)
 ; .SAMIRTN
"RTN","SAMIHOM4",231,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",232,0)
 ;@tests
"RTN","SAMIHOM4",233,0)
 ; UTGETHM^SAMIUTH3
"RTN","SAMIHOM4",234,0)
 ; UTSCAN4^SAMIUTH3
"RTN","SAMIHOM4",235,0)
 ;
"RTN","SAMIHOM4",236,0)
 ;
"RTN","SAMIHOM4",237,0)
 ;@stanza 2 get template for homepage
"RTN","SAMIHOM4",238,0)
 ;
"RTN","SAMIHOM4",239,0)
 ; Processing for multi-tenancy
"RTN","SAMIHOM4",240,0)
 ;
"RTN","SAMIHOM4",241,0)
 i $g(HTTPREQ("method"))="GET" d  ;
"RTN","SAMIHOM4",242,0)
 . s SAMIFILTER("siteid")=""
"RTN","SAMIHOM4",243,0)
 ;
"RTN","SAMIHOM4",244,0)
 if $get(SAMIFILTER("siteid"))="" if '$$FINDSITE^SAMISITE(.SAMIRTN,.SAMIFILTER) quit 0
"RTN","SAMIHOM4",245,0)
 new SAMISITE,SAMITITL
"RTN","SAMIHOM4",246,0)
 set SAMISITE=$get(SAMIFILTER("siteid"))
"RTN","SAMIHOM4",247,0)
 set SAMITITL=$get(SAMIFILTER("sitetitle"))
"RTN","SAMIHOM4",248,0)
 ;
"RTN","SAMIHOM4",249,0)
 new VASITE set VASITE=$$GET1PARM^SAMIPARM("veteransAffairsSite",SAMISITE)
"RTN","SAMIHOM4",250,0)
 set SAMIFILTER("veteransAffairsSite")=VASITE
"RTN","SAMIHOM4",251,0)
 ;
"RTN","SAMIHOM4",252,0)
 new temp,tout,form
"RTN","SAMIHOM4",253,0)
 set form="vapals:home"
"RTN","SAMIHOM4",254,0)
 do GETTMPL^SAMICASE("temp",form)
"RTN","SAMIHOM4",255,0)
 quit:'$data(temp)
"RTN","SAMIHOM4",256,0)
 ;
"RTN","SAMIHOM4",257,0)
 ;
"RTN","SAMIHOM4",258,0)
 ;@stanza 3 process homepage template
"RTN","SAMIHOM4",259,0)
 ;
"RTN","SAMIHOM4",260,0)
 new err
"RTN","SAMIHOM4",261,0)
 do MERGEHTM^%wf(.temp,.SAMIFILTER,.err)
"RTN","SAMIHOM4",262,0)
 ;
"RTN","SAMIHOM4",263,0)
 do ADDCRLF^VPRJRUT(.temp)
"RTN","SAMIHOM4",264,0)
 merge SAMIRTN=temp
"RTN","SAMIHOM4",265,0)
 ;
"RTN","SAMIHOM4",266,0)
 ;
"RTN","SAMIHOM4",267,0)
 ;@stanza 4 termination
"RTN","SAMIHOM4",268,0)
 ;
"RTN","SAMIHOM4",269,0)
 quit  ; end of wpi GETHOME^SAMIHOM3
"RTN","SAMIHOM4",270,0)
 ;
"RTN","SAMIHOM4",271,0)
 ;
"RTN","SAMIHOM4",272,0)
 ;
"RTN","SAMIHOM4",273,0)
 ; below is redacted from GETHOME^SAMIHOM3
"RTN","SAMIHOM4",274,0)
 ;
"RTN","SAMIHOM4",275,0)
 ;@old-calls
"RTN","SAMIHOM4",276,0)
 ; FIXHREF^SAMIFORM
"RTN","SAMIHOM4",277,0)
 ; FIXSRC^SAMIFORM
"RTN","SAMIHOM4",278,0)
 ; $$GET^XPAR
"RTN","SAMIHOM4",279,0)
 ; findReplace^%ts
"RTN","SAMIHOM4",280,0)
 ; ADDCRLF^VPRJRUT
"RTN","SAMIHOM4",281,0)
 ;
"RTN","SAMIHOM4",282,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",283,0)
 new zi set zi=0
"RTN","SAMIHOM4",284,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMIHOM4",285,0)
 . ;
"RTN","SAMIHOM4",286,0)
 . n ln s ln=temp(zi)
"RTN","SAMIHOM4",287,0)
 . n touched s touched=0
"RTN","SAMIHOM4",288,0)
 . ;
"RTN","SAMIHOM4",289,0)
 . i ln["href" i 'touched d  ;
"RTN","SAMIHOM4",290,0)
 . . d FIXHREF^SAMIFORM(.ln)
"RTN","SAMIHOM4",291,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",292,0)
 . ;
"RTN","SAMIHOM4",293,0)
 . i ln["src" d  ;
"RTN","SAMIHOM4",294,0)
 . . d FIXSRC^SAMIFORM(.ln)
"RTN","SAMIHOM4",295,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",296,0)
 . ;
"RTN","SAMIHOM4",297,0)
 . i ln["id" i ln["studyIdMenu" d  ;
"RTN","SAMIHOM4",298,0)
 . . s zi=zi+4
"RTN","SAMIHOM4",299,0)
 . ;
"RTN","SAMIHOM4",300,0)
 . if ln["@@MANUALREGISTRATION@@" do  ; turn off manual registration
"RTN","SAMIHOM4",301,0)
 . . n setman,setparm
"RTN","SAMIHOM4",302,0)
 . . s setman="true"
"RTN","SAMIHOM4",303,0)
 . . s setparm=$$GET^XPAR("SYS","SAMI ALLOW MANUAL ENTRY",,"Q")
"RTN","SAMIHOM4",304,0)
 . . i setparm=0 s setman="false"
"RTN","SAMIHOM4",305,0)
 . . do findReplace^%ts(.ln,"@@MANUALREGISTRATION@@",setman)
"RTN","SAMIHOM4",306,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",307,0)
 . . quit 
"RTN","SAMIHOM4",308,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",309,0)
 . set tout(cnt)=temp(zi)
"RTN","SAMIHOM4",310,0)
 . quit
"RTN","SAMIHOM4",311,0)
 ;
"RTN","SAMIHOM4",312,0)
 ;
"RTN","SAMIHOM4",313,0)
 ;@old-stanza 4 add cr/lf & save to return array
"RTN","SAMIHOM4",314,0)
 ;
"RTN","SAMIHOM4",315,0)
 do ADDCRLF^VPRJRUT(.tout)
"RTN","SAMIHOM4",316,0)
 merge SAMIRTN=tout
"RTN","SAMIHOM4",317,0)
 ;
"RTN","SAMIHOM4",318,0)
 ;
"RTN","SAMIHOM4",319,0)
 ;@old-stanza 5 termination
"RTN","SAMIHOM4",320,0)
 ;
"RTN","SAMIHOM4",321,0)
 quit  ; old end of wpi GETHOME^SAMIHOM3
"RTN","SAMIHOM4",322,0)
 ;
"RTN","SAMIHOM4",323,0)
 ;
"RTN","SAMIHOM4",324,0)
 ;
"RTN","SAMIHOM4",325,0)
 ;@section 2 web service post vapals & related subroutines
"RTN","SAMIHOM4",326,0)
 ;
"RTN","SAMIHOM4",327,0)
 ;
"RTN","SAMIHOM4",328,0)
 ;
"RTN","SAMIHOM4",329,0)
 ;@wsi-code WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",330,0)
WSVAPALS ; post vapals (main gateway)
"RTN","SAMIHOM4",331,0)
 ;
"RTN","SAMIHOM4",332,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",333,0)
 ;
"RTN","SAMIHOM4",334,0)
 ;ven/gpl;wsi;procedure;clean;silent;sac;tests
"RTN","SAMIHOM4",335,0)
 ;@signature
"RTN","SAMIHOM4",336,0)
 ; do WSVAPALS^SAMIHOM3(SAMIARG,SAMIBODY,SAMIRESULT)
"RTN","SAMIHOM4",337,0)
 ;@branches-from
"RTN","SAMIHOM4",338,0)
 ; WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",339,0)
 ;@wsi-called-by
"RTN","SAMIHOM4",340,0)
 ;@called-by
"RTN","SAMIHOM4",341,0)
 ;@calls
"RTN","SAMIHOM4",342,0)
 ;@input [tbd]
"RTN","SAMIHOM4",343,0)
 ;@output [tbd]
"RTN","SAMIHOM4",344,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",345,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",346,0)
 ;
"RTN","SAMIHOM4",347,0)
 ; all calls come through this gateway
"RTN","SAMIHOM4",348,0)
 ;
"RTN","SAMIHOM4",349,0)
 k ^SAMIUL("vapals")
"RTN","SAMIHOM4",350,0)
 m ^SAMIUL("vapals")=SAMIARG
"RTN","SAMIHOM4",351,0)
 m ^SAMIUL("vapals","BODY")=SAMIBODY
"RTN","SAMIHOM4",352,0)
 ;
"RTN","SAMIHOM4",353,0)
 new vars,SAMIBDY
"RTN","SAMIHOM4",354,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",355,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",356,0)
 m vars=SAMIARG
"RTN","SAMIHOM4",357,0)
 i $g(vars("siteid"))'="" d  ;
"RTN","SAMIHOM4",358,0)
 . i $g(vars("site"))'=$g(vars("siteid")) s vars("site")=$g(vars("siteid"))
"RTN","SAMIHOM4",359,0)
 i $g(vars("site"))="SYS" s vars("site")=""
"RTN","SAMIHOM4",360,0)
 i $g(HTTPREQ("method"))="GET" d  ;
"RTN","SAMIHOM4",361,0)
 . s vars("site")=""
"RTN","SAMIHOM4",362,0)
 m SAMIARG=vars
"RTN","SAMIHOM4",363,0)
 m SAMIARG=SAMIBODY
"RTN","SAMIHOM4",364,0)
 ;D ^ZTER
"RTN","SAMIHOM4",365,0)
 ;
"RTN","SAMIHOM4",366,0)
 ; Processing for multi-tenancy
"RTN","SAMIHOM4",367,0)
 ;
"RTN","SAMIHOM4",368,0)
 if '$d(vars("siteid")) d  ;
"RTN","SAMIHOM4",369,0)
 . if $g(vars("studyid"))="" q
"RTN","SAMIHOM4",370,0)
 . n sym s sym=$e(vars("studyid"),1,3) ; first 3 chars in studyid
"RTN","SAMIHOM4",371,0)
 . i $$SITENM2^SAMISITE(sym)=-1 q
"RTN","SAMIHOM4",372,0)
 . s vars("siteid")=sym
"RTN","SAMIHOM4",373,0)
 . s vars("site")=sym
"RTN","SAMIHOM4",374,0)
 ;
"RTN","SAMIHOM4",375,0)
 if $G(vars("site"))'="" d  ;
"RTN","SAMIHOM4",376,0)
 . n siteid s siteid=vars("site")
"RTN","SAMIHOM4",377,0)
 . s SAMIARG("siteid")=siteid
"RTN","SAMIHOM4",378,0)
 . s SAMIARG("sitetitle")=$$SITENM2^SAMISITE(siteid)_" - "_siteid
"RTN","SAMIHOM4",379,0)
 k ^gpl("siteselect")
"RTN","SAMIHOM4",380,0)
 m ^gpl("siteselect")=SAMIARG
"RTN","SAMIHOM4",381,0)
 m ^gpl("siteselect","vars")=vars
"RTN","SAMIHOM4",382,0)
 if $G(SAMIARG("siteid"))="" if '$$FINDSITE^SAMISITE(.SAMIRESULT,.SAMIARG) Q 0
"RTN","SAMIHOM4",383,0)
 new SAMISITE,SAMITITL
"RTN","SAMIHOM4",384,0)
 s SAMISITE=$G(SAMIARG("siteid"))
"RTN","SAMIHOM4",385,0)
 i $G(SAMIARG("sitetitle"))="" d  ;
"RTN","SAMIHOM4",386,0)
 . s SAMIARG("sitetitle")=$$SITENM2^SAMISITE(SAMISITE)_" - "_SAMISITE
"RTN","SAMIHOM4",387,0)
 s SAMITITL=$G(SAMIARG("sitetitle"))
"RTN","SAMIHOM4",388,0)
 m vars=SAMIARG
"RTN","SAMIHOM4",389,0)
 ;
"RTN","SAMIHOM4",390,0)
 k ^SAMIUL("vapals","vars")
"RTN","SAMIHOM4",391,0)
 merge ^SAMIUL("vapals","vars")=vars
"RTN","SAMIHOM4",392,0)
 merge ^SAMIUL("vapals","vars")=SAMIBODY
"RTN","SAMIHOM4",393,0)
 ;
"RTN","SAMIHOM4",394,0)
 n route s route=$g(vars("samiroute"))
"RTN","SAMIHOM4",395,0)
 ;i route=""  d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",396,0)
 i route="" d  q 0
"RTN","SAMIHOM4",397,0)
 . n vals
"RTN","SAMIHOM4",398,0)
 . s vals("siteid")=""
"RTN","SAMIHOM4",399,0)
 . s vals("sitetitle")="Unknown Site"
"RTN","SAMIHOM4",400,0)
 . s vals("errorMessage")=""
"RTN","SAMIHOM4",401,0)
 . d RTNERR^SAMIHOM4(.SAMIRETURN,"vapals:login",.vals)
"RTN","SAMIHOM4",402,0)
 ;
"RTN","SAMIHOM4",403,0)
 i route="lookup" d  q 0
"RTN","SAMIHOM4",404,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",405,0)
 . d WSLOOKUP^SAMISRC2(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",406,0)
 ;
"RTN","SAMIHOM4",407,0)
 i route="login" d  q 0
"RTN","SAMIHOM4",408,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",409,0)
 . d LOGIN^SAMISITE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",410,0)
 ;
"RTN","SAMIHOM4",411,0)
 i route="home" d  q 0
"RTN","SAMIHOM4",412,0)
 . k ^gpl("home")
"RTN","SAMIHOM4",413,0)
 . m ^gpl("home")=SAMIARG
"RTN","SAMIHOM4",414,0)
 . s SAMIARG("samiroute")=""
"RTN","SAMIHOM4",415,0)
 . d WSHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",416,0)
 ;
"RTN","SAMIHOM4",417,0)
 i route="logout" d  q 0
"RTN","SAMIHOM4",418,0)
 . ;s SAMIARG("samiroute")="home"
"RTN","SAMIHOM4",419,0)
 . ;do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIARG,.SAMIRESULT)
"RTN","SAMIHOM4",420,0)
 . ;Q
"RTN","SAMIHOM4",421,0)
 . s SAMIARG("sitetitle")="Unknown Site"
"RTN","SAMIHOM4",422,0)
 . s SAMIARG("siteid")=""
"RTN","SAMIHOM4",423,0)
 . s SAMIARG("errorMessage")=""
"RTN","SAMIHOM4",424,0)
 . d RTNERR^SAMIHOM4(.SAMIRESULT,"vapals:login",.SAMIARG)
"RTN","SAMIHOM4",425,0)
 ;
"RTN","SAMIHOM4",426,0)
 i route="newcase" d  q 0
"RTN","SAMIHOM4",427,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",428,0)
 . d WSNEWCAS^SAMIHOM3(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",429,0)
 ;
"RTN","SAMIHOM4",430,0)
 i route="casereview" d  q 0
"RTN","SAMIHOM4",431,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",432,0)
 . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",433,0)
 ;
"RTN","SAMIHOM4",434,0)
 i route="nuform" d  q 0
"RTN","SAMIHOM4",435,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",436,0)
 . d WSNUFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",437,0)
 ;
"RTN","SAMIHOM4",438,0)
 i route="addform" d  q 0
"RTN","SAMIHOM4",439,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",440,0)
 . d WSNFPOST^SAMICASE(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",441,0)
 ;
"RTN","SAMIHOM4",442,0)
 i route="form" d  q 0
"RTN","SAMIHOM4",443,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",444,0)
 . d wsGetForm^%wf(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",445,0)
 ;
"RTN","SAMIHOM4",446,0)
 i route="postform" d  q 0
"RTN","SAMIHOM4",447,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",448,0)
 . d wsPostForm^%wf(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",449,0)
 . i $g(SAMIARG("form"))["siform" d  ;
"RTN","SAMIHOM4",450,0)
 . . n notr s notr=0 ; note return 0 if failure, 1 or greater if success
"RTN","SAMIHOM4",451,0)
 . . ; returns the ien of the note that was created and should be sent
"RTN","SAMIHOM4",452,0)
 . . s notr=$$NOTE^SAMINOT1(.SAMIARG)
"RTN","SAMIHOM4",453,0)
 . . if +notr>0 d  ;
"RTN","SAMIHOM4",454,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",455,0)
 . . . s SAMIFILTER("sid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",456,0)
 . . . s SAMIFILTER("key")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",457,0)
 . . . n tiuien
"RTN","SAMIHOM4",458,0)
 . . . s tiuien=+notr
"RTN","SAMIHOM4",459,0)
 . . . s SAMIFILTER("notenmbr")=tiuien
"RTN","SAMIHOM4",460,0)
 . . . n sendrslt
"RTN","SAMIHOM4",461,0)
 . . . ;s sendrslt="1^MSG9239010"
"RTN","SAMIHOM4",462,0)
 . . . s SAMIFILTER("sendprotocol")=SAMISITE_" ENROLL ORU EVN"
"RTN","SAMIHOM4",463,0)
 . . . s sendrslt=$$EN^SAMIORU(.SAMIFILTER) ; send the note to VistA
"RTN","SAMIHOM4",464,0)
 . . . i +sendrslt>0 d  ; success
"RTN","SAMIHOM4",465,0)
 . . . . n rtnid s rtnid=$p(sendrslt,"^",2) ; return id from HL7
"RTN","SAMIHOM4",466,0)
 . . . . ; post the id to the graph here
"RTN","SAMIHOM4",467,0)
 . . . . n sid s sid=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",468,0)
 . . . . n form s form=$G(SAMIARG("form"))
"RTN","SAMIHOM4",469,0)
 . . . . n nien s nien=$$NTIEN^SAMINOT1(sid,form) ; latest note ien
"RTN","SAMIHOM4",470,0)
 . . . . n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",471,0)
 . . . . s @root@("graph",sid,form,"notes",nien,"hl7id")=rtnid
"RTN","SAMIHOM4",472,0)
 . . . . s SAMIARG("errorMessage")="Note successfully sent to VistA ID: "_rtnid
"RTN","SAMIHOM4",473,0)
 . . . else  d  ;
"RTN","SAMIHOM4",474,0)
 . . . . n rtnmsg s rtnmsg=$p(sendrslt,"^",2)
"RTN","SAMIHOM4",475,0)
 . . . . s SAMIARG("errorMessage")=rtnmsg
"RTN","SAMIHOM4",476,0)
 . . . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",477,0)
 . i $g(SAMIARG("form"))["fuform" d  ;
"RTN","SAMIHOM4",478,0)
 . . n notr s notr=0 ; note return 0 if failure, 1 or greater if success
"RTN","SAMIHOM4",479,0)
 . . ; returns the ien of the note that was created and should be sent
"RTN","SAMIHOM4",480,0)
 . . s notr=$$NOTE^SAMINOT2(.SAMIARG)
"RTN","SAMIHOM4",481,0)
 . . if +notr>0 d  ;
"RTN","SAMIHOM4",482,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",483,0)
 . . . s SAMIFILTER("sid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",484,0)
 . . . s SAMIFILTER("key")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",485,0)
 . . . n tiuien
"RTN","SAMIHOM4",486,0)
 . . . s tiuien=+notr
"RTN","SAMIHOM4",487,0)
 . . . s SAMIFILTER("notenmbr")=tiuien
"RTN","SAMIHOM4",488,0)
 . . . n sendrslt
"RTN","SAMIHOM4",489,0)
 . . . ;s sendrslt="0^Missing ORM Message"
"RTN","SAMIHOM4",490,0)
 . . . s SAMIFILTER("sendprotocol")=SAMISITE_" ENROLL ORU EVN"
"RTN","SAMIHOM4",491,0)
 . . . s sendrslt=$$EN^SAMIORU(.SAMIFILTER) ; send the note to VistA
"RTN","SAMIHOM4",492,0)
 . . . i +sendrslt>0 d  ; success
"RTN","SAMIHOM4",493,0)
 . . . . n rtnid s rtnid=$p(sendrslt,"^",2) ; return id from HL7
"RTN","SAMIHOM4",494,0)
 . . . . ; post the id to the graph here
"RTN","SAMIHOM4",495,0)
 . . . . n sid s sid=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",496,0)
 . . . . n form s form=$G(SAMIARG("form"))
"RTN","SAMIHOM4",497,0)
 . . . . n nien s nien=$$NTIEN^SAMINOT1(sid,form) ; latest note ien
"RTN","SAMIHOM4",498,0)
 . . . . n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",499,0)
 . . . . s @root@("graph",sid,form,"notes",nien,"hl7id")=rtnid
"RTN","SAMIHOM4",500,0)
 . . . . s SAMIARG("errorMessage")="Note successfully sent to VistA ID: "_rtnid
"RTN","SAMIHOM4",501,0)
 . . . else  d  ;
"RTN","SAMIHOM4",502,0)
 . . . . n rtnmsg s rtnmsg=$p(sendrslt,"^",2)
"RTN","SAMIHOM4",503,0)
 . . . . i $g(SAMIARG("errorMessage"))="" d  ;
"RTN","SAMIHOM4",504,0)
 . . . . . s SAMIARG("errorMessage")=rtnmsg
"RTN","SAMIHOM4",505,0)
 . . . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",506,0)
 . . e  d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",507,0)
 . e  d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",508,0)
 ;
"RTN","SAMIHOM4",509,0)
 i route="deleteform" d  q 0
"RTN","SAMIHOM4",510,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",511,0)
 . d DELFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",512,0)
 ;
"RTN","SAMIHOM4",513,0)
 i route="ctreport" d  q 0
"RTN","SAMIHOM4",514,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",515,0)
 . n format s format="html"
"RTN","SAMIHOM4",516,0)
 . s format="text"
"RTN","SAMIHOM4",517,0)
 . i format="text" d WSNOTE^SAMINOT3(.SAMIRESULT,.SAMIARG) q  ;
"RTN","SAMIHOM4",518,0)
 . i format="html" d WSREPORT^SAMICTR0(.SAMIRESULT,.SAMIARG) q  ;
"RTN","SAMIHOM4",519,0)
 . ;d wsReport^SAMICTRT(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",520,0)
 ;
"RTN","SAMIHOM4",521,0)
 i route="note" d  q 0
"RTN","SAMIHOM4",522,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",523,0)
 . d WSNOTE^SAMINOT1(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",524,0)
 ;
"RTN","SAMIHOM4",525,0)
 i route="report" d  q 0
"RTN","SAMIHOM4",526,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",527,0)
 . d WSREPORT^SAMIUR(.SAMIRESULT,.vars)
"RTN","SAMIHOM4",528,0)
 ;
"RTN","SAMIHOM4",529,0)
 i route="about" d  q 0
"RTN","SAMIHOM4",530,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",531,0)
 . n form
"RTN","SAMIHOM4",532,0)
 . s form="vapals:about"
"RTN","SAMIHOM4",533,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",534,0)
 ;
"RTN","SAMIHOM4",535,0)
 i route="addperson" d  q 0
"RTN","SAMIHOM4",536,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",537,0)
 . n form
"RTN","SAMIHOM4",538,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",539,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",540,0)
 ;
"RTN","SAMIHOM4",541,0)
 i route="editperson" d  q 0
"RTN","SAMIHOM4",542,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",543,0)
 . n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",544,0)
 . i dfn="" d  q  ;
"RTN","SAMIHOM4",545,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",546,0)
 . n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",547,0)
 . n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",548,0)
 . i sien="" d  q  ;
"RTN","SAMIHOM4",549,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",550,0)
 . s vars("name")=$g(@root@(sien,"saminame"))
"RTN","SAMIHOM4",551,0)
 . s tdob=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",552,0)
 . s vars("dob")=$p(tdob,"-",2)_"/"_$p(tdob,"-",3)_"/"_$p(tdob,"-",1)
"RTN","SAMIHOM4",553,0)
 . s vars("sbdob")=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",554,0)
 . s vars("gender")=$g(@root@(sien,"sex"))
"RTN","SAMIHOM4",555,0)
 . ; s vars("icn")=$g(@root@(sien,"icn"))
"RTN","SAMIHOM4",556,0)
 . n tssn s tssn=$g(@root@(sien,"ssn"))
"RTN","SAMIHOM4",557,0)
 . s vars("ssn")=$e(tssn,1,3)_"-"_$e(tssn,4,5)_"-"_$e(tssn,6,9)
"RTN","SAMIHOM4",558,0)
 . s vars("last5")=$g(@root@(sien,"last5"))
"RTN","SAMIHOM4",559,0)
 . s vars("dfn")=$g(@root@(sien,"dfn"))
"RTN","SAMIHOM4",560,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",561,0)
 . n form,err,zhtml
"RTN","SAMIHOM4",562,0)
 . s form="vapals:editparticipant"
"RTN","SAMIHOM4",563,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",564,0)
 ;
"RTN","SAMIHOM4",565,0)
 i route="register" d  q 0
"RTN","SAMIHOM4",566,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",567,0)
 . d REG^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",568,0)
 ; 
"RTN","SAMIHOM4",569,0)
 i route="editsave" d  q 0
"RTN","SAMIHOM4",570,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",571,0)
 . d SAVE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",572,0)
 ;
"RTN","SAMIHOM4",573,0)
 i route="merge" d  q 0
"RTN","SAMIHOM4",574,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",575,0)
 . d MERGE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",576,0)
 ;
"RTN","SAMIHOM4",577,0)
 quit 0  ; end of wsi WSVAPALS^SAMIHOM3
"RTN","SAMIHOM4",578,0)
 ;
"RTN","SAMIHOM4",579,0)
 ;
"RTN","SAMIHOM4",580,0)
 ;
"RTN","SAMIHOM4",581,0)
 ;@section 3 other
"RTN","SAMIHOM4",582,0)
 ;
"RTN","SAMIHOM4",583,0)
 ;
"RTN","SAMIHOM4",584,0)
 ;
"RTN","SAMIHOM4",585,0)
REG(SAMIRTN,SAMIARG) ; manual registration
"RTN","SAMIHOM4",586,0)
 ;
"RTN","SAMIHOM4",587,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",588,0)
 ;
"RTN","SAMIHOM4",589,0)
 m ^gpl("reg")=SAMIARG
"RTN","SAMIHOM4",590,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",591,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",592,0)
 s SAMIARG("errorMessage")=""
"RTN","SAMIHOM4",593,0)
 s SAMIARG("errorField")=""
"RTN","SAMIHOM4",594,0)
 ; test for duplicate ssn
"RTN","SAMIHOM4",595,0)
 ;
"RTN","SAMIHOM4",596,0)
 ;i $$DUPSSN(ssn) d  ;
"RTN","SAMIHOM4",597,0)
 ;. ;s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN."
"RTN","SAMIHOM4",598,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN error. A person with that SSN is already entered in the system."
"RTN","SAMIHOM4",599,0)
 ;. s SAMIARG("errorField")="ssn"
"RTN","SAMIHOM4",600,0)
 ;
"RTN","SAMIHOM4",601,0)
 ; test for duplicate icn
"RTN","SAMIHOM4",602,0)
 ;
"RTN","SAMIHOM4",603,0)
 ;n icn s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",604,0)
 ;i icn'="" i $$DUPICN(icn) d  ;
"RTN","SAMIHOM4",605,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate ICN error. A person with that ICN is already entered in the system."
"RTN","SAMIHOM4",606,0)
 ;. s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",607,0)
 ;;
"RTN","SAMIHOM4",608,0)
 ;; test for wellformed ICN
"RTN","SAMIHOM4",609,0)
 ;;
"RTN","SAMIHOM4",610,0)
 ;i icn'="" i $$BADICN(icn) d  ;
"RTN","SAMIHOM4",611,0)
 ;. s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Invalid ICN error. The check digits in the ICN do not match"
"RTN","SAMIHOM4",612,0)
 ;. s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",613,0)
 ;;
"RTN","SAMIHOM4",614,0)
 ; if there is an error, send back to edit with error message
"RTN","SAMIHOM4",615,0)
 i $g(SAMIARG("errorMessage"))'="" d  q  ;
"RTN","SAMIHOM4",616,0)
 . n form
"RTN","SAMIHOM4",617,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",618,0)
 . d RTNERR(.SAMIRESULT,form,.SAMIARG)
"RTN","SAMIHOM4",619,0)
 ;
"RTN","SAMIHOM4",620,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",621,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",622,0)
 n ptlkien s ptlkien=""
"RTN","SAMIHOM4",623,0)
 n dfn s dfn=""
"RTN","SAMIHOM4",624,0)
 n sien s sien=""
"RTN","SAMIHOM4",625,0)
 i ptlkien="" s ptlkien=$o(@root@("AAAAAA"),-1)+1
"RTN","SAMIHOM4",626,0)
 n zm
"RTN","SAMIHOM4",627,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",628,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",629,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",630,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",631,0)
 d MKPTLK(ptlkien,.SAMIARG) ; make the patient-lookup record
"RTN","SAMIHOM4",632,0)
 ;
"RTN","SAMIHOM4",633,0)
 s dfn=$o(@root@("dfn"," "),-1)+1
"RTN","SAMIHOM4",634,0)
 n pdfn
"RTN","SAMIHOM4",635,0)
 s pdfn=$o(@proot@("dfn"," "),-1)+1
"RTN","SAMIHOM4",636,0)
 i pdfn>dfn s dfn=pdfn ; need a dfn that has not been used
"RTN","SAMIHOM4",637,0)
 i dfn<9000001 s dfn=9000001
"RTN","SAMIHOM4",638,0)
 s @root@(ptlkien,"dfn")=dfn
"RTN","SAMIHOM4",639,0)
 s SAMIARG("dfn")=dfn ; pass the new dfn back to the caller
"RTN","SAMIHOM4",640,0)
 ; note: this is the only way to link to the new record via dfn
"RTN","SAMIHOM4",641,0)
 ; since nothing else is unique
"RTN","SAMIHOM4",642,0)
 d INDXPTLK(ptlkien)
"RTN","SAMIHOM4",643,0)
 s SAMIFILTER("samiroute")="addperson"
"RTN","SAMIHOM4",644,0)
 s SAMIFILTER("siteid")=$G(SAMIARG("siteid"))
"RTN","SAMIHOM4",645,0)
 s SAMIFILTER("sitetitle")=$G(SAMIARG("sitetitle"))
"RTN","SAMIHOM4",646,0)
 D  ; slight of hand for handing back SAMIARGS while also returning a form
"RTN","SAMIHOM4",647,0)
 . n SAMIARG ; return to a blank manual registration form
"RTN","SAMIHOM4",648,0)
 . s SAMIARG("siteid")=$G(SAMIFILTER("siteid"))
"RTN","SAMIHOM4",649,0)
 . s SAMIARG("sitetitle")=$G(SAMIFILTER("sitetitle"))
"RTN","SAMIHOM4",650,0)
 . d SETINFO(.SAMIFILTER,name_" was successfully entered")
"RTN","SAMIHOM4",651,0)
 . ;d SETWARN(.SAMIFILTER,"We might want to give you a warning")
"RTN","SAMIHOM4",652,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIARG,.SAMIRESULT)
"RTN","SAMIHOM4",653,0)
 ;
"RTN","SAMIHOM4",654,0)
 quit  ; end of REG
"RTN","SAMIHOM4",655,0)
 ;
"RTN","SAMIHOM4",656,0)
 ;
"RTN","SAMIHOM4",657,0)
 ;
"RTN","SAMIHOM4",658,0)
MKPTLK(ptlkien,SAMIARG) ; creates patient-lookup record
"RTN","SAMIHOM4",659,0)
 ;
"RTN","SAMIHOM4",660,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",661,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",662,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",663,0)
 n sinamef,sinamel
"RTN","SAMIHOM4",664,0)
 s sinamel=$p(name,","),sinamel=$$TRIM^XLFSTR(sinamel,"LR")
"RTN","SAMIHOM4",665,0)
 s sinamef=$p(name,",",2),sinamef=$$TRIM^XLFSTR(sinamef,"LR")
"RTN","SAMIHOM4",666,0)
 s name=sinamel_","_sinamef
"RTN","SAMIHOM4",667,0)
 n siteid s siteid=$g(SAMIARG("siteid"))
"RTN","SAMIHOM4",668,0)
 i siteid="" s siteid=$g(SAMIARG("site"))
"RTN","SAMIHOM4",669,0)
 ;
"RTN","SAMIHOM4",670,0)
 s @root@(ptlkien,"siteid")=siteid
"RTN","SAMIHOM4",671,0)
 s @root@(ptlkien,"saminame")=name
"RTN","SAMIHOM4",672,0)
 s @root@(ptlkien,"sinamef")=sinamef
"RTN","SAMIHOM4",673,0)
 s @root@(ptlkien,"sinamel")=sinamel
"RTN","SAMIHOM4",674,0)
 n dob s dob=$g(SAMIARG("dob"))
"RTN","SAMIHOM4",675,0)
 i dob="" s dob=$g(SAMIARG("sidob"))
"RTN","SAMIHOM4",676,0)
 n fmdob s fmdob=$$FMDT^SAMIUR2(dob)
"RTN","SAMIHOM4",677,0)
 n ptlkdob s ptlkdob=$$FMTE^XLFDT(fmdob,7)
"RTN","SAMIHOM4",678,0)
 s ptlkdob=$TR(ptlkdob,"/","-")
"RTN","SAMIHOM4",679,0)
 s @root@(ptlkien,"dob")=ptlkdob
"RTN","SAMIHOM4",680,0)
 s @root@(ptlkien,"sbdob")=ptlkdob
"RTN","SAMIHOM4",681,0)
 n gender s gender=$g(SAMIARG("gender"))
"RTN","SAMIHOM4",682,0)
 i gender="" s gender=$g(SAMIARG("sex"))
"RTN","SAMIHOM4",683,0)
 s @root@(ptlkien,"gender")=$s(gender="M":"M^MALE",1:"F^FEMALE")
"RTN","SAMIHOM4",684,0)
 s @root@(ptlkien,"sex")=$g(SAMIARG("gender"))
"RTN","SAMIHOM4",685,0)
 ; s @root@(ptlkien,"icn")=SAMIARG("icn")
"RTN","SAMIHOM4",686,0)
 s @root@(ptlkien,"ssn")=ssn
"RTN","SAMIHOM4",687,0)
 n last5 s last5=$$UCASE($e(name,1))_$e(ssn,6,9)
"RTN","SAMIHOM4",688,0)
 s @root@(ptlkien,"last5")=last5
"RTN","SAMIHOM4",689,0)
 n mymatch s mymatch=$g(SAMIARG("MATCHLOG"))
"RTN","SAMIHOM4",690,0)
 i mymatch'="" s @root@(ptlkien,"MATCHLOG")=mymatch
"RTN","SAMIHOM4",691,0)
 ;
"RTN","SAMIHOM4",692,0)
 quit  ; end of MKPTLK
"RTN","SAMIHOM4",693,0)
 ;
"RTN","SAMIHOM4",694,0)
 ;
"RTN","SAMIHOM4",695,0)
 ;
"RTN","SAMIHOM4",696,0)
UPDTFRMS(dfn) ; update demographics in all forms for patient
"RTN","SAMIHOM4",697,0)
 ;
"RTN","SAMIHOM4",698,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",699,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",700,0)
 n lien s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM4",701,0)
 q:lien=""
"RTN","SAMIHOM4",702,0)
 n pien s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIHOM4",703,0)
 q:pien=""
"RTN","SAMIHOM4",704,0)
 ; this patient has forms
"RTN","SAMIHOM4",705,0)
 m @proot@(pien)=@lroot@(lien) ; refresh the demos in the patient record
"RTN","SAMIHOM4",706,0)
 n ssn s ssn=$g(@proot@(pien,"ssn"))
"RTN","SAMIHOM4",707,0)
 s @proot@(pien,"sissn")=$e(ssn,1,3)_"-"_$e(ssn,4,5)_"-"_$e(ssn,6,9)
"RTN","SAMIHOM4",708,0)
 n sid s sid=$g(@proot@("sisid")) ; studyid 
"RTN","SAMIHOM4",709,0)
 q:sid=""  ; no studyid
"RTN","SAMIHOM4",710,0)
 n zi s zi=""
"RTN","SAMIHOM4",711,0)
 f  s zi=$o(@proot@("graph",sid,zi)) q:zi=""  d  ; for each form
"RTN","SAMIHOM4",712,0)
 . m @proot@("graph",sid,zi)=@proot@(pien) ; stamp each form with new demos
"RTN","SAMIHOM4",713,0)
 ;
"RTN","SAMIHOM4",714,0)
 quit  ; end of UPDTFRMS
"RTN","SAMIHOM4",715,0)
 ;
"RTN","SAMIHOM4",716,0)
 ;
"RTN","SAMIHOM4",717,0)
 ;
"RTN","SAMIHOM4",718,0)
MERGE(SAMIRESULT,SAMIARGS) ; merge participant records
"RTN","SAMIHOM4",719,0)
 ;
"RTN","SAMIHOM4",720,0)
 ; called from pressing the merge button on the unmatched report
"RTN","SAMIHOM4",721,0)
 ;
"RTN","SAMIHOM4",722,0)
 n toien s toien=$g(SAMIARGS("toien"))
"RTN","SAMIHOM4",723,0)
 i toien="" d  q  ;
"RTN","SAMIHOM4",724,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",725,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",726,0)
 n fromien s fromien=$g(@lroot@(toien,"MATCHLOG"))
"RTN","SAMIHOM4",727,0)
 i fromien="" d  q  ;
"RTN","SAMIHOM4",728,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",729,0)
 ;
"RTN","SAMIHOM4",730,0)
 ; test for remotedfn in from record - not valid if absent
"RTN","SAMIHOM4",731,0)
 ;
"RTN","SAMIHOM4",732,0)
 i $g(@lroot@(fromien,"remotedfn"))="" d  q  ;
"RTN","SAMIHOM4",733,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",734,0)
 ;
"RTN","SAMIHOM4",735,0)
 ; remove index entries for from and to records
"RTN","SAMIHOM4",736,0)
 ;
"RTN","SAMIHOM4",737,0)
 d UNINDXPT(fromien) ; delete index entries
"RTN","SAMIHOM4",738,0)
 d UNINDXPT(toien)
"RTN","SAMIHOM4",739,0)
 ;
"RTN","SAMIHOM4",740,0)
 ; create changelog entry in to record - contains from record
"RTN","SAMIHOM4",741,0)
 ;
"RTN","SAMIHOM4",742,0)
 m @lroot@(toien,"changelog",$$FMTE^XLFDT($$NOW^XLFDT,5))=@lroot@(fromien)
"RTN","SAMIHOM4",743,0)
 ;
"RTN","SAMIHOM4",744,0)
 ; change the dfn in the from record to the to record dfn for merging
"RTN","SAMIHOM4",745,0)
 ;
"RTN","SAMIHOM4",746,0)
 s @lroot@(fromien,"dfn")=@lroot@(toien,"dfn")
"RTN","SAMIHOM4",747,0)
 n dfn s dfn=@lroot@(toien,"dfn") ; for use in updating forms
"RTN","SAMIHOM4",748,0)
 ;
"RTN","SAMIHOM4",749,0)
 ; merge the from record to the to record
"RTN","SAMIHOM4",750,0)
 ;
"RTN","SAMIHOM4",751,0)
 m @lroot@(toien)=@lroot@(fromien)
"RTN","SAMIHOM4",752,0)
 ;
"RTN","SAMIHOM4",753,0)
 ; delete the from record
"RTN","SAMIHOM4",754,0)
 ;
"RTN","SAMIHOM4",755,0)
 k @lroot@(fromien)
"RTN","SAMIHOM4",756,0)
 ;
"RTN","SAMIHOM4",757,0)
 ; reindex the to record
"RTN","SAMIHOM4",758,0)
 ;
"RTN","SAMIHOM4",759,0)
 d INDXPTLK(toien)
"RTN","SAMIHOM4",760,0)
 ;
"RTN","SAMIHOM4",761,0)
 ; propagate the updated from record to every form
"RTN","SAMIHOM4",762,0)
 ;
"RTN","SAMIHOM4",763,0)
 d UPDTFRMS(dfn) ; updates the patient in the vapals-patient graph
"RTN","SAMIHOM4",764,0)
 ;
"RTN","SAMIHOM4",765,0)
 ; leave and return to the unmatched report
"RTN","SAMIHOM4",766,0)
 ;   note that the form and to records will no longer be in the report
"RTN","SAMIHOM4",767,0)
 ;
"RTN","SAMIHOM4",768,0)
 d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",769,0)
 ;
"RTN","SAMIHOM4",770,0)
 quit  ; end of MERGE
"RTN","SAMIHOM4",771,0)
 ;
"RTN","SAMIHOM4",772,0)
 ;
"RTN","SAMIHOM4",773,0)
 ;
"RTN","SAMIHOM4",774,0)
ADDUNMAT ; adds unmatched report web service to system
"RTN","SAMIHOM4",775,0)
 ;
"RTN","SAMIHOM4",776,0)
 d addService^%webutils("GET","unmatched","WSUNMAT^SAMIHOM4")
"RTN","SAMIHOM4",777,0)
 ;
"RTN","SAMIHOM4",778,0)
 quit  ; end of ADDUNMAT
"RTN","SAMIHOM4",779,0)
 ;
"RTN","SAMIHOM4",780,0)
 ;
"RTN","SAMIHOM4",781,0)
 ;
"RTN","SAMIHOM4",782,0)
DELUNMAT ; deletes unmatched web service
"RTN","SAMIHOM4",783,0)
 ;
"RTN","SAMIHOM4",784,0)
 d deleteService^%webutils("GET","unmatched")
"RTN","SAMIHOM4",785,0)
 ;
"RTN","SAMIHOM4",786,0)
 quit  ; end of DELUNMAT
"RTN","SAMIHOM4",787,0)
 ;
"RTN","SAMIHOM4",788,0)
 ;
"RTN","SAMIHOM4",789,0)
 ;
"RTN","SAMIHOM4",790,0)
WSUNMAT(SAMIRESULT,SAMIARGS) ; navigates to unmatched report
"RTN","SAMIHOM4",791,0)
 ; 
"RTN","SAMIHOM4",792,0)
 n filter,bdy
"RTN","SAMIHOM4",793,0)
 s bdy=""
"RTN","SAMIHOM4",794,0)
 ;s filter("siteid")="PHX"
"RTN","SAMIHOM4",795,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",796,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",797,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",798,0)
 ;
"RTN","SAMIHOM4",799,0)
 quit  ; end of WSUNMAT
"RTN","SAMIHOM4",800,0)
 ;
"RTN","SAMIHOM4",801,0)
 ;
"RTN","SAMIHOM4",802,0)
 ;
"RTN","SAMIHOM4",803,0)
DUPSSN(ssn) ; extrinsic returns true if duplicate ssn
"RTN","SAMIHOM4",804,0)
 ;
"RTN","SAMIHOM4",805,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",806,0)
 i $d(@proot@("ssn",ssn)) q 1
"RTN","SAMIHOM4",807,0)
 ;
"RTN","SAMIHOM4",808,0)
 quit 0 ; end of $$DUPSSN
"RTN","SAMIHOM4",809,0)
 ;
"RTN","SAMIHOM4",810,0)
 ;
"RTN","SAMIHOM4",811,0)
 ;
"RTN","SAMIHOM4",812,0)
DUPICN(icn) ; extrinsic returns true if duplicate icn
"RTN","SAMIHOM4",813,0)
 ;
"RTN","SAMIHOM4",814,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",815,0)
 n tmpicn s tmpicn=$p(icn,"V",1)
"RTN","SAMIHOM4",816,0)
 i $d(@proot@("icn",icn)) q 1
"RTN","SAMIHOM4",817,0)
 i $d(@proot@("icn",tmpicn)) q 1
"RTN","SAMIHOM4",818,0)
 ;
"RTN","SAMIHOM4",819,0)
 quit 0 ; end of $$DUPICN
"RTN","SAMIHOM4",820,0)
 ;
"RTN","SAMIHOM4",821,0)
 ;
"RTN","SAMIHOM4",822,0)
 ;
"RTN","SAMIHOM4",823,0)
BADICN(icn) ; extrinsic returns true if ICN checkdigits are wrong
"RTN","SAMIHOM4",824,0)
 ;
"RTN","SAMIHOM4",825,0)
 n zchk s zchk=$p(icn,"V",2)
"RTN","SAMIHOM4",826,0)
 n zicn s zicn=$p(icn,"V",1)
"RTN","SAMIHOM4",827,0)
 q:zchk="" 1
"RTN","SAMIHOM4",828,0)
 i zchk'=$$CHECKDG^MPIFSPC(zicn) q 1
"RTN","SAMIHOM4",829,0)
 ;
"RTN","SAMIHOM4",830,0)
 quit 0
"RTN","SAMIHOM4",831,0)
 ;
"RTN","SAMIHOM4",832,0)
 ;
"RTN","SAMIHOM4",833,0)
 ;
"RTN","SAMIHOM4",834,0)
SAVE(SAMIRESULT,SAMIARG) ; save patient-lookup record after edit
"RTN","SAMIHOM4",835,0)
 ;
"RTN","SAMIHOM4",836,0)
 n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",837,0)
 i dfn="" d  q  ;
"RTN","SAMIHOM4",838,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",839,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",840,0)
 n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",841,0)
 i sien="" d  q  ;
"RTN","SAMIHOM4",842,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",843,0)
 d UNINDXPT(sien) ; remove old index entries
"RTN","SAMIHOM4",844,0)
 n zm
"RTN","SAMIHOM4",845,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",846,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",847,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",848,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",849,0)
 d MKPTLK(sien,.SAMIARG) ; add the updated fields
"RTN","SAMIHOM4",850,0)
 d INDXPTLK(sien) ; create new index entries
"RTN","SAMIHOM4",851,0)
 d UPDTFRMS(dfn) ; update demographic info in all forms
"RTN","SAMIHOM4",852,0)
 n filter,bdy
"RTN","SAMIHOM4",853,0)
 s bdy=""
"RTN","SAMIHOM4",854,0)
 m filter=SAMIARG
"RTN","SAMIHOM4",855,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",856,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",857,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",858,0)
 ;
"RTN","SAMIHOM4",859,0)
 quit  ; end of SAVE
"RTN","SAMIHOM4",860,0)
 ;
"RTN","SAMIHOM4",861,0)
 ;
"RTN","SAMIHOM4",862,0)
 ;
"RTN","SAMIHOM4",863,0)
REMATCH(sien,SAMIARG) ; extrinsic returns possible match ien
"RTN","SAMIHOM4",864,0)
 ;
"RTN","SAMIHOM4",865,0)
 ; else zero
"RTN","SAMIHOM4",866,0)
 ;
"RTN","SAMIHOM4",867,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",868,0)
 n ssn,name,icn,x,y
"RTN","SAMIHOM4",869,0)
 s ssn=$g(SAMIARG("ssn"))
"RTN","SAMIHOM4",870,0)
 i ssn["-" s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",871,0)
 s name=$g(SAMIARG("saminame"))
"RTN","SAMIHOM4",872,0)
 i name="" s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",873,0)
 s name=$$UCASE(name)
"RTN","SAMIHOM4",874,0)
 ; s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",875,0)
 s x=0
"RTN","SAMIHOM4",876,0)
 i ssn'="" s x=$o(@lroot@("ssn",ssn,""))
"RTN","SAMIHOM4",877,0)
 i x=sien s x=$o(@lroot@("ssn",ssn,x))
"RTN","SAMIHOM4",878,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",879,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",880,0)
 . ;i y>9000000 s x=0
"RTN","SAMIHOM4",881,0)
 i x>0 q x
"RTN","SAMIHOM4",882,0)
 i name'="" s x=$o(@lroot@("name",name,""))
"RTN","SAMIHOM4",883,0)
 i x=sien s x=$o(@lroot@("name",name,x))
"RTN","SAMIHOM4",884,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",885,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",886,0)
 . ;i y>9000000 s x=0
"RTN","SAMIHOM4",887,0)
 i x>0 q x
"RTN","SAMIHOM4",888,0)
 ;i icn'="" s x=$o(@lroot@("icn",icn,""))
"RTN","SAMIHOM4",889,0)
 ;i x=sien s x=$o(@lroot@("icn",icn,x))
"RTN","SAMIHOM4",890,0)
 ;i +x'=0 d  ;
"RTN","SAMIHOM4",891,0)
 ;. s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",892,0)
 ;. i y>9000000 s x=0
"RTN","SAMIHOM4",893,0)
 ;i x>0 q x
"RTN","SAMIHOM4",894,0)
 ;
"RTN","SAMIHOM4",895,0)
 quit 0 ; end of $$REMATCH
"RTN","SAMIHOM4",896,0)
 ;
"RTN","SAMIHOM4",897,0)
 ;
"RTN","SAMIHOM4",898,0)
 ;
"RTN","SAMIHOM4",899,0)
SETINFO(vars,msg) ; set information message text
"RTN","SAMIHOM4",900,0)
 ;
"RTN","SAMIHOM4",901,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",902,0)
 ;
"RTN","SAMIHOM4",903,0)
 s vars("infoMessage")=msg
"RTN","SAMIHOM4",904,0)
 ;
"RTN","SAMIHOM4",905,0)
 quit  ; end of SETINFO
"RTN","SAMIHOM4",906,0)
 ;
"RTN","SAMIHOM4",907,0)
 ;
"RTN","SAMIHOM4",908,0)
 ;
"RTN","SAMIHOM4",909,0)
SETWARN(vars,msg) ; set warning message text
"RTN","SAMIHOM4",910,0)
 ;
"RTN","SAMIHOM4",911,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",912,0)
 ;
"RTN","SAMIHOM4",913,0)
 s vars("warnMessage")=msg
"RTN","SAMIHOM4",914,0)
 ;
"RTN","SAMIHOM4",915,0)
 quit  ; end of SETWARN
"RTN","SAMIHOM4",916,0)
 ;
"RTN","SAMIHOM4",917,0)
 ;
"RTN","SAMIHOM4",918,0)
 ; 
"RTN","SAMIHOM4",919,0)
RTNERR(rtn,form,vals,msg,fld) ; redisplay page w/error message
"RTN","SAMIHOM4",920,0)
 ;
"RTN","SAMIHOM4",921,0)
 ; rtn is the return array
"RTN","SAMIHOM4",922,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",923,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",924,0)
 ; msg is the error message to be displayed
"RTN","SAMIHOM4",925,0)
 ; fld is the name of the field where the cursor should be put
"RTN","SAMIHOM4",926,0)
 ;
"RTN","SAMIHOM4",927,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",928,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",929,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",930,0)
 m rtn=zhtml
"RTN","SAMIHOM4",931,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",932,0)
 ;
"RTN","SAMIHOM4",933,0)
 quit  ; end of RTNERR
"RTN","SAMIHOM4",934,0)
 ;
"RTN","SAMIHOM4",935,0)
 ;
"RTN","SAMIHOM4",936,0)
 ;
"RTN","SAMIHOM4",937,0)
RTNPAGE(rtn,form,vals) ; display page
"RTN","SAMIHOM4",938,0)
 ;
"RTN","SAMIHOM4",939,0)
 ; rtn is the return array
"RTN","SAMIHOM4",940,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",941,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",942,0)
 ;
"RTN","SAMIHOM4",943,0)
 n err
"RTN","SAMIHOM4",944,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",945,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",946,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",947,0)
 m SAMIRESULT=zhtml
"RTN","SAMIHOM4",948,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",949,0)
 ;
"RTN","SAMIHOM4",950,0)
 quit  ; end of RTNPAGE
"RTN","SAMIHOM4",951,0)
 ;
"RTN","SAMIHOM4",952,0)
 ;
"RTN","SAMIHOM4",953,0)
 ;
"RTN","SAMIHOM4",954,0)
REINDXPL ; reindex patient lookup
"RTN","SAMIHOM4",955,0)
 ;
"RTN","SAMIHOM4",956,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",957,0)
 n zi s zi=0
"RTN","SAMIHOM4",958,0)
 k @root@("dfn")
"RTN","SAMIHOM4",959,0)
 k @root@("ssn")
"RTN","SAMIHOM4",960,0)
 k @root@("name")
"RTN","SAMIHOM4",961,0)
 k @root@("last5")
"RTN","SAMIHOM4",962,0)
 k @root@("sinamef")
"RTN","SAMIHOM4",963,0)
 k @root@("sinamel")
"RTN","SAMIHOM4",964,0)
 ; k @root@("icn")
"RTN","SAMIHOM4",965,0)
 f  s zi=$o(@root@(zi)) q:+zi=0  d  ;
"RTN","SAMIHOM4",966,0)
 . d INDXPTLK(zi)
"RTN","SAMIHOM4",967,0)
 ;
"RTN","SAMIHOM4",968,0)
 quit  ; end of REINDXPL
"RTN","SAMIHOM4",969,0)
 ;
"RTN","SAMIHOM4",970,0)
 ;
"RTN","SAMIHOM4",971,0)
 ;
"RTN","SAMIHOM4",972,0)
INDXPTLK(ien) ; generate index entries in patient-lookup graph
"RTN","SAMIHOM4",973,0)
 ;
"RTN","SAMIHOM4",974,0)
 ; for entry ien
"RTN","SAMIHOM4",975,0)
 ;
"RTN","SAMIHOM4",976,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",977,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",978,0)
 s @proot@("name",name,ien)=""
"RTN","SAMIHOM4",979,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",980,0)
 s @proot@("name",ucname,ien)=""
"RTN","SAMIHOM4",981,0)
 n x
"RTN","SAMIHOM4",982,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",983,0)
 i x="" d  ;
"RTN","SAMIHOM4",984,0)
 . s x=$o(@proot@("dfn","   "),-1)+1
"RTN","SAMIHOM4",985,0)
 . s @proot@(ien,"dfn")=x
"RTN","SAMIHOM4",986,0)
 s:x'="" @proot@("dfn",x,ien)=""
"RTN","SAMIHOM4",987,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",988,0)
 s:x'="" @proot@("last5",x,ien)=""
"RTN","SAMIHOM4",989,0)
 ;
"RTN","SAMIHOM4",990,0)
 ; s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",991,0)
 ; i x'["V" d  ;
"RTN","SAMIHOM4",992,0)
 ; . i x="" q
"RTN","SAMIHOM4",993,0)
 ; . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",994,0)
 ; . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",995,0)
 ; . s x=x_"V"_chk
"RTN","SAMIHOM4",996,0)
 ; s:x'="" @proot@("icn",x,ien)=""
"RTN","SAMIHOM4",997,0)
 ;
"RTN","SAMIHOM4",998,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",999,0)
 s:x'="" @proot@("ssn",x,ien)=""
"RTN","SAMIHOM4",1000,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",1001,0)
 s:x'="" @proot@("sinamef",x,ien)=""
"RTN","SAMIHOM4",1002,0)
 s x=$g(@proot@(ien,"sinamel")) ;w !,x
"RTN","SAMIHOM4",1003,0)
 s:x'="" @proot@("sinamel",x,ien)=""
"RTN","SAMIHOM4",1004,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",1005,0)
 ;
"RTN","SAMIHOM4",1006,0)
 quit  ; end of INDXPTLK
"RTN","SAMIHOM4",1007,0)
 ;
"RTN","SAMIHOM4",1008,0)
 ;
"RTN","SAMIHOM4",1009,0)
 ;
"RTN","SAMIHOM4",1010,0)
UNINDXPT(ien) ; remove index entries from patient-lookup graph
"RTN","SAMIHOM4",1011,0)
 ;
"RTN","SAMIHOM4",1012,0)
 ; for entry ien
"RTN","SAMIHOM4",1013,0)
 ;
"RTN","SAMIHOM4",1014,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",1015,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",1016,0)
 k @proot@("name",name,ien)
"RTN","SAMIHOM4",1017,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",1018,0)
 k @proot@("name",ucname,ien)
"RTN","SAMIHOM4",1019,0)
 n x
"RTN","SAMIHOM4",1020,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",1021,0)
 k:x'="" @proot@("dfn",x,ien)
"RTN","SAMIHOM4",1022,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",1023,0)
 k:x'="" @proot@("last5",x,ien)
"RTN","SAMIHOM4",1024,0)
 ;
"RTN","SAMIHOM4",1025,0)
 ; s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",1026,0)
 ; i x'["V" d  ;
"RTN","SAMIHOM4",1027,0)
 ; . i x="" q
"RTN","SAMIHOM4",1028,0)
 ; . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",1029,0)
 ; . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",1030,0)
 ; . s x=x_"V"_chk
"RTN","SAMIHOM4",1031,0)
 ; k:x'="" @proot@("icn",x,ien)
"RTN","SAMIHOM4",1032,0)
 ;
"RTN","SAMIHOM4",1033,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",1034,0)
 k:x'="" @proot@("ssn",x,ien)
"RTN","SAMIHOM4",1035,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",1036,0)
 k:x'="" @proot@("sinamef",x,ien)
"RTN","SAMIHOM4",1037,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",1038,0)
 k:x'="" @proot@("sinamel",x,ien)
"RTN","SAMIHOM4",1039,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",1040,0)
 ;
"RTN","SAMIHOM4",1041,0)
 quit  ; end of UNINDXPT
"RTN","SAMIHOM4",1042,0)
 ;
"RTN","SAMIHOM4",1043,0)
 ;
"RTN","SAMIHOM4",1044,0)
 ;
"RTN","SAMIHOM4",1045,0)
UCASE(STR) ; extrinsic returns uppercase of STR
"RTN","SAMIHOM4",1046,0)
 ;
"RTN","SAMIHOM4",1047,0)
 N X,Y
"RTN","SAMIHOM4",1048,0)
 S X=STR
"RTN","SAMIHOM4",1049,0)
 X ^%ZOSF("UPPERCASE")
"RTN","SAMIHOM4",1050,0)
 ;
"RTN","SAMIHOM4",1051,0)
 quit Y ; end of $$UCASE
"RTN","SAMIHOM4",1052,0)
 ;
"RTN","SAMIHOM4",1053,0)
 ;
"RTN","SAMIHOM4",1054,0)
 ;
"RTN","SAMIHOM4",1055,0)
 ;@wri-code WSNEWCAS^SAMIHOM3
"RTN","SAMIHOM4",1056,0)
WSNEWCAS ; web route newcase (creates new case)
"RTN","SAMIHOM4",1057,0)
 ;
"RTN","SAMIHOM4",1058,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",1059,0)
 ;
"RTN","SAMIHOM4",1060,0)
 ;ven/gpl;wri;procedure;
"RTN","SAMIHOM4",1061,0)
 ;@signature
"RTN","SAMIHOM4",1062,0)
 ; do WSNEWCAS^SAMIHOM3(SAMIARGS,SAMIBODY,SAMIRESULT)
"RTN","SAMIHOM4",1063,0)
 ;@branches-from
"RTN","SAMIHOM4",1064,0)
 ; wri WSNEWCAS^SAMIHOM3 [wr newcase]
"RTN","SAMIHOM4",1065,0)
 ;@wri-called-by
"RTN","SAMIHOM4",1066,0)
 ; wsi WSVAPALS^SAMIHOM3 [ws post vapals]
"RTN","SAMIHOM4",1067,0)
 ;@called-by none
"RTN","SAMIHOM4",1068,0)
 ;@calls
"RTN","SAMIHOM4",1069,0)
 ; parseBody^%wf
"RTN","SAMIHOM4",1070,0)
 ; $$setroot^%wd
"RTN","SAMIHOM4",1071,0)
 ;  $$VALDTNM [commented out]
"RTN","SAMIHOM4",1072,0)
 ;  GETHOME [commented out]
"RTN","SAMIHOM4",1073,0)
 ;  $$NEXTNUM [commented out]
"RTN","SAMIHOM4",1074,0)
 ; $$GENSTDID^SAMIHOM3
"RTN","SAMIHOM4",1075,0)
 ; $$NOW^XLFDT
"RTN","SAMIHOM4",1076,0)
 ; $$KEYDATE^SAMIHOM3
"RTN","SAMIHOM4",1077,0)
 ; PREFILL^SAMIHOM3
"RTN","SAMIHOM4",1078,0)
 ;  makeSbform [commented out]
"RTN","SAMIHOM4",1079,0)
 ; $$MKSIFORM^SAMIHOM3
"RTN","SAMIHOM4",1080,0)
 ; wsGetForm^%wf
"RTN","SAMIHOM4",1081,0)
 ;  WSCASE^SAMICASE [commented out]
"RTN","SAMIHOM4",1082,0)
 ;@input
"RTN","SAMIHOM4",1083,0)
 ;.ARGS =
"RTN","SAMIHOM4",1084,0)
 ; BODY =
"RTN","SAMIHOM4",1085,0)
 ;.RESULT =
"RTN","SAMIHOM4",1086,0)
 ;@output: ?
"RTN","SAMIHOM4",1087,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",1088,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",1089,0)
 ;
"RTN","SAMIHOM4",1090,0)
 ;
"RTN","SAMIHOM4",1091,0)
 ;@stanza 2 create new case
"RTN","SAMIHOM4",1092,0)
 ;
"RTN","SAMIHOM4",1093,0)
 merge ^SAMIUL("newCase","ARGS")=SAMIARGS
"RTN","SAMIHOM4",1094,0)
 merge ^SAMIUL("newCase","BODY")=SAMIBODY
"RTN","SAMIHOM4",1095,0)
 ;
"RTN","SAMIHOM4",1096,0)
 new vars,bdy
"RTN","SAMIHOM4",1097,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",1098,0)
 if SAMIBDY="" M vars=SAMIARGS
"RTN","SAMIHOM4",1099,0)
 else  do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",1100,0)
 merge ^SAMIUL("newCase","vars")=vars
"RTN","SAMIHOM4",1101,0)
 ;
"RTN","SAMIHOM4",1102,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",1103,0)
 ;
"RTN","SAMIHOM4",1104,0)
 new saminame set saminame=$get(vars("name"))
"RTN","SAMIHOM4",1105,0)
 if saminame="" s saminame=$get(vars("saminame"))
"RTN","SAMIHOM4",1106,0)
 ;if $$VALDTNM(saminame,.ARGS)=-1 do  quit  ;
"RTN","SAMIHOM4",1107,0)
 ;. new r1
"RTN","SAMIHOM4",1108,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",1109,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",1110,0)
 ;. quit
"RTN","SAMIHOM4",1111,0)
 ;
"RTN","SAMIHOM4",1112,0)
 new dfn s dfn=$get(vars("dfn"))
"RTN","SAMIHOM4",1113,0)
 ;if dfn="" do  quit  ;
"RTN","SAMIHOM4",1114,0)
 ;. new r1
"RTN","SAMIHOM4",1115,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",1116,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",1117,0)
 ;. quit
"RTN","SAMIHOM4",1118,0)
 ;
"RTN","SAMIHOM4",1119,0)
 ; new gien set gien=$$NEXTNUM
"RTN","SAMIHOM4",1120,0)
 new gien set gien=dfn
"RTN","SAMIHOM4",1121,0)
 ;
"RTN","SAMIHOM4",1122,0)
 merge ^SAMIUL("newCase","G1")=root
"RTN","SAMIHOM4",1123,0)
 ; create dfn index
"RTN","SAMIHOM4",1124,0)
 set @root@("dfn",dfn,gien)=""
"RTN","SAMIHOM4",1125,0)
 ;
"RTN","SAMIHOM4",1126,0)
 set @root@(gien,"saminum")=gien
"RTN","SAMIHOM4",1127,0)
 set @root@(gien,"saminame")=saminame
"RTN","SAMIHOM4",1128,0)
 ;
"RTN","SAMIHOM4",1129,0)
 new studyid set studyid=$$GENSTDID^SAMIHOM3(gien,.SAMIARGS)
"RTN","SAMIHOM4",1130,0)
 set @root@(gien,"samistudyid")=studyid
"RTN","SAMIHOM4",1131,0)
 set @root@("sid",studyid,gien)=""
"RTN","SAMIHOM4",1132,0)
 ;
"RTN","SAMIHOM4",1133,0)
 new datekey set datekey=$$KEYDATE^SAMIHOM3($$NOW^XLFDT)
"RTN","SAMIHOM4",1134,0)
 set @root@(gien,"samicreatedate")=datekey
"RTN","SAMIHOM4",1135,0)
 ;
"RTN","SAMIHOM4",1136,0)
 merge ^SAMIUL("newCase",gien)=@root@(gien)
"RTN","SAMIHOM4",1137,0)
 ;
"RTN","SAMIHOM4",1138,0)
 ;
"RTN","SAMIHOM4",1139,0)
 do PREFILL^SAMIHOM3(dfn) ; prefills from the "patient-lookup" graph
"RTN","SAMIHOM4",1140,0)
 ;
"RTN","SAMIHOM4",1141,0)
 new siformkey
"RTN","SAMIHOM4",1142,0)
 ; do makeSbform(gien) ; create background form for new patient
"RTN","SAMIHOM4",1143,0)
 set siformkey=$$MKSIFORM^SAMIHOM3(gien) ; create intake for new patient
"RTN","SAMIHOM4",1144,0)
 ;
"RTN","SAMIHOM4",1145,0)
 set SAMIARGS("studyid")=studyid
"RTN","SAMIHOM4",1146,0)
 set SAMIARGS("form")="vapals:"_siformkey
"RTN","SAMIHOM4",1147,0)
 do wsGetForm^%wf(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",1148,0)
 ; do WSCASE^SAMICASE(.SAMIRESULT,.SAMIARGS) ; navigate to case review page
"RTN","SAMIHOM4",1149,0)
 ;
"RTN","SAMIHOM4",1150,0)
 ;
"RTN","SAMIHOM4",1151,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",1152,0)
 ;
"RTN","SAMIHOM4",1153,0)
 quit  ; end of wri WSNEWCAS^SAMIHOM3
"RTN","SAMIHOM4",1154,0)
 ;
"RTN","SAMIHOM4",1155,0)
 ;
"RTN","SAMIHOM4",1156,0)
 ;
"RTN","SAMIHOM4",1157,0)
EOR ; end of routine SAMIHOM4
"RTN","SAMIHUL")
0^2^B117874
"RTN","SAMIHUL",1,0)
SAMIHUL ;ven/gpl - ielcap: home page log ;2022-01-17t23:29z
"RTN","SAMIHUL",2,0)
 ;;18.0;SAMI;**9,12,15,16**;2020-01;Build 3
"RTN","SAMIHUL",3,0)
 ;18-15
"RTN","SAMIHUL",4,0)
 ;
"RTN","SAMIHUL",5,0)
 ; SAMIHOM3 contains subroutines for producing the ELCAP Home Page.
"RTN","SAMIHUL",6,0)
 ; SAMIHUL contains the development log for the SAMIHOM* routines.
"RTN","SAMIHUL",7,0)
 ; It contains no executable code.
"RTN","SAMIHUL",8,0)
 ;
"RTN","SAMIHUL",9,0)
 quit  ; no entry from top
"RTN","SAMIHUL",10,0)
 ;
"RTN","SAMIHUL",11,0)
 ;
"RTN","SAMIHUL",12,0)
 ;
"RTN","SAMIHUL",13,0)
 ;@section 0 primary development
"RTN","SAMIHUL",14,0)
 ;
"RTN","SAMIHUL",15,0)
 ;
"RTN","SAMIHUL",16,0)
 ;
"RTN","SAMIHUL",17,0)
 ;@routine-credits
"RTN","SAMIHUL",18,0)
 ;@dev-main George P. Lilly (gpl)
"RTN","SAMIHUL",19,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIHUL",20,0)
 ;@dev-org-main Vista Expertise Network (ven)
"RTN","SAMIHUL",21,0)
 ; http://vistaexpertise.net
"RTN","SAMIHUL",22,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIHUL",23,0)
 ;@license see routine SAMIUL
"RTN","SAMIHUL",24,0)
 ;
"RTN","SAMIHUL",25,0)
 ;@last-update 2022-01-17t23:29z
"RTN","SAMIHUL",26,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIHUL",27,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIHUL",28,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIHUL",29,0)
 ;@version 18-15
"RTN","SAMIHUL",30,0)
 ;@release-date 2020-01
"RTN","SAMIHUL",31,0)
 ;@patch-list **9,12,15,16**
"RTN","SAMIHUL",32,0)
 ;
"RTN","SAMIHUL",33,0)
 ;@dev-add Frederick D. S. Marshall (toad)
"RTN","SAMIHUL",34,0)
 ; toad@vistaexpertise.net
"RTN","SAMIHUL",35,0)
 ;@dev-add Kenneth W. McGlothlen (mcglk)
"RTN","SAMIHUL",36,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMIHUL",37,0)
 ;@dev-add Linda M. R. Yaw (lmry)
"RTN","SAMIHUL",38,0)
 ; linda.yaw@vistaexpertise.net
"RTN","SAMIHUL",39,0)
 ;@dev-add Larry G. Carlson (lgc)
"RTN","SAMIHUL",40,0)
 ; larry.g.carlson@gmail.com
"RTN","SAMIHUL",41,0)
 ;@dev-add Alexis R. Carlson (arc)
"RTN","SAMIHUL",42,0)
 ; whatisthehumanspirit@gmail.com
"RTN","SAMIHUL",43,0)
 ;@dev-add Domenick DiNatale (ddn)
"RTN","SAMIHUL",44,0)
 ; domenic@intellitechinnovations.com
"RTN","SAMIHUL",45,0)
 ;
"RTN","SAMIHUL",46,0)
 ;@module-credits
"RTN","SAMIHUL",47,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMIHUL",48,0)
 ; (VA-PALS)
"RTN","SAMIHUL",49,0)
 ; http://va-pals.org/
"RTN","SAMIHUL",50,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMIHUL",51,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMIHUL",52,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMIHUL",53,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMIHUL",54,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMIHUL",55,0)
 ; http://ielcap.com/
"RTN","SAMIHUL",56,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMIHUL",57,0)
 ; http://paraxialtech.com/
"RTN","SAMIHUL",58,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMIHUL",59,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMIHUL",60,0)
 ;
"RTN","SAMIHUL",61,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIHUL",62,0)
 ;
"RTN","SAMIHUL",63,0)
 ; 2018-01-13 ven/gpl 18.0-t4
"RTN","SAMIHUL",64,0)
 ;  SAMIHOM3 create routine from SAMIFRM to implement ELCAP Home Page.
"RTN","SAMIHUL",65,0)
 ;
"RTN","SAMIHUL",66,0)
 ; 2018-02-05 ven/toad 18.0-t4
"RTN","SAMIHUL",67,0)
 ;  SAMIHOM3 update license & attribution & hdr comments, add white
"RTN","SAMIHUL",68,0)
 ; space & do-dot quits, spell out language elements.
"RTN","SAMIHUL",69,0)
 ;
"RTN","SAMIHUL",70,0)
 ; 2018-02-27 ven/gpl 18.0-t4
"RTN","SAMIHUL",71,0)
 ;  SAMIHOM3 new subroutines PREFIX,GETHOME,SCANFOR,WSNEWCAS,PREFILL,
"RTN","SAMIHUL",72,0)
 ; MKSBFORM,MKSIFORM,VALDTNM,SID2NUM,KEYDATE,GENSTDID,NEXTNUM to
"RTN","SAMIHUL",73,0)
 ; support creation of new cases.
"RTN","SAMIHUL",74,0)
 ;
"RTN","SAMIHUL",75,0)
 ; 2018-03-01 ven/toad 18.0-t4
"RTN","SAMIHUL",76,0)
 ;  SAMIHOM3 refactor & reorganize new code, add hdr comments,
"RTN","SAMIHUL",77,0)
 ; r/findReplaceAll^%wf w/findReplace^%ts.
"RTN","SAMIHUL",78,0)
 ;
"RTN","SAMIHUL",79,0)
 ; 2018-03-06 ven/gpl 18.0-t4
"RTN","SAMIHUL",80,0)
 ;  SAMIHOM3 ?
"RTN","SAMIHUL",81,0)
 ;
"RTN","SAMIHUL",82,0)
 ; 2018-03-07 ven/toad 18.0-t4
"RTN","SAMIHUL",83,0)
 ;  SAMIHOM3 in $$SID2NUM add WSNUFORM^SAMICASE to called-by; in
"RTN","SAMIHUL",84,0)
 ; keyDate,GETHOME update called-by.
"RTN","SAMIHUL",85,0)
 ;
"RTN","SAMIHUL",86,0)
 ; 2018-05-18/25 ven/lgc&arc 18.0-t4 76020fd,81b1048,65afd99
"RTN","SAMIHUL",87,0)
 ;  SAMIHOM3 new SAMIHOM3 for new patient search page, chg submit
"RTN","SAMIHUL",88,0)
 ; processing on forms, fix bug in postform.
"RTN","SAMIHUL",89,0)
 ;
"RTN","SAMIHUL",90,0)
 ; 2018-06-14/07-10 ven/lgc&arc 18.0-t4 d71f4fe,8b0a432,ce345db,
"RTN","SAMIHUL",91,0)
 ; 402b6a8,14f991d,2e9662b
"RTN","SAMIHUL",92,0)
 ;  SAMIHOM3 make background form optional; 1st version of CT Eval
"RTN","SAMIHUL",93,0)
 ; Report; reorg ctreport routines & 1st crack at impressions &
"RTN","SAMIHUL",94,0)
 ; recommendations; note produced for intake form on submit; add
"RTN","SAMIHUL",95,0)
 ; support for routing by patient in CPRS Tools Menu, modify
"RTN","SAMIHUL",96,0)
 ; wsHOME^SAMIHOM3 to properly route VA-PALS web app when launced via
"RTN","SAMIHUL",97,0)
 ; CPRS Tools Menu; repair SAMIHOM3 & redact report link.
"RTN","SAMIHUL",98,0)
 ;
"RTN","SAMIHUL",99,0)
 ; 2018-08-22 ven/gpl 18.0-t4 6e696a9
"RTN","SAMIHUL",100,0)
 ;  SAMIHOM3 add PTINFO call to vista to pull ssn.
"RTN","SAMIHUL",101,0)
 ;
"RTN","SAMIHUL",102,0)
 ; 2018-09-30/11-01 ven/lgc&arc 18.0-t4 d93c640,482f522,a8e4226,
"RTN","SAMIHUL",103,0)
 ; ee5e8a1
"RTN","SAMIHUL",104,0)
 ;  SAMIHOM3 hdr & prefill of intake; new input form features, report
"RTN","SAMIHUL",105,0)
 ; menu fix; set urban/rural status at siform setup; handle zip code
"RTN","SAMIHUL",106,0)
 ; unknown.
"RTN","SAMIHUL",107,0)
 ;
"RTN","SAMIHUL",108,0)
 ; 2018-11-09/2019-01-22 ven/lgc&arc&lmry 18.0-t4 bac4f73,5400035,
"RTN","SAMIHUL",109,0)
 ; dd341e0,a953946,e2a44e6,2356c2b,3ceb74b,3088307,4271b46,7a5d340,
"RTN","SAMIHUL",110,0)
 ; dfbb0bc,fd1bcee,8dd6f34,51eb163,dbdb5a4,0880027,ccba017,5368121
"RTN","SAMIHUL",111,0)
 ;  SAMIHOM3 unit tests, annotation, sac compliance, XINDEX bugs, fix
"RTN","SAMIHUL",112,0)
 ; accidental reversions, add license info.
"RTN","SAMIHUL",113,0)
 ;
"RTN","SAMIHUL",114,0)
 ; 2018-12-18/20 ven/arc 18.0-t4 3088307f,4271b46b,dfbb0bca,
"RTN","SAMIHUL",115,0)
 ;  b8ff6da9,fd1bceee
"RTN","SAMIHUL",116,0)
 ;  SAMIHOM4 va sac compliance & variable namespacing.
"RTN","SAMIHUL",117,0)
 ;
"RTN","SAMIHUL",118,0)
 ; 2019-01-01/02-18 ven/lgc 18.0-t4 0880027c,18aa0fec,fcd635c1,
"RTN","SAMIHUL",119,0)
 ;  53681219,76874314
"RTN","SAMIHUL",120,0)
 ;  SAMIHOM3 update w/ recent changes.
"RTN","SAMIHUL",121,0)
 ;  SAMIHOM4 updates for va sac & code coverage, add license info.
"RTN","SAMIHUL",122,0)
 ;
"RTN","SAMIHUL",123,0)
 ; 2019-04-15 ven/gpl 18.0-t4 b403bf01
"RTN","SAMIHUL",124,0)
 ;  SAMIHOM4 support for new intake notes.
"RTN","SAMIHUL",125,0)
 ;
"RTN","SAMIHUL",126,0)
 ; 2019-04-16 ven/lgc 18.0-t4 e54b76d1
"RTN","SAMIHUL",127,0)
 ;  SAMIHOM4 update for SAMIFORM project.
"RTN","SAMIHUL",128,0)
 ;
"RTN","SAMIHUL",129,0)
 ; 2019-04-17 ven/gpl 18.0-t4 7d1f86db
"RTN","SAMIHUL",130,0)
 ;  SAMIHOM3 prefill date on intake prelim discussion section.
"RTN","SAMIHUL",131,0)
 ;
"RTN","SAMIHUL",132,0)
 ; 2019-06-18 ven/arc 18.0-t4 91022482
"RTN","SAMIHUL",133,0)
 ;  SAMIHOM4 switch fr/global ^SAMIGPL to/^SAMIUL.
"RTN","SAMIHUL",134,0)
 ;
"RTN","SAMIHUL",135,0)
 ; 2019-08-05 ven/gpl 18.0-t4 9c0c2ed3
"RTN","SAMIHUL",136,0)
 ;  SAMIHOM3 add GETPRFX to get right prefix at registration.
"RTN","SAMIHUL",137,0)
 ;
"RTN","SAMIHUL",138,0)
 ; 2019-08-07 ven/lgc&arc 18.0-t4 603194b9,37967fc5
"RTN","SAMIHUL",139,0)
 ;  SAMIHOM3 consolidate calls to retrieve facility prefix.
"RTN","SAMIHUL",140,0)
 ;
"RTN","SAMIHUL",141,0)
 ; 2019-11-22 par/ddn 18.0-t4 b2cc389d vap-458
"RTN","SAMIHUL",142,0)
 ;  SAMIHOM4 manual registration.
"RTN","SAMIHUL",143,0)
 ;
"RTN","SAMIHUL",144,0)
 ; 2020-01-01/05 ven/lgc 18.0-t4 c169f4b1,5928064a,62e3200f
"RTN","SAMIHUL",145,0)
 ;  SAMIHOM4 support for unmatched patient processing, more changes
"RTN","SAMIHUL",146,0)
 ; for participant matching, unmatched participant processing ready
"RTN","SAMIHUL",147,0)
 ; for testing.
"RTN","SAMIHUL",148,0)
 ;
"RTN","SAMIHUL",149,0)
 ; 2020-01-08/10 ven/gpl 18.0 a002f850,47dfe3cd
"RTN","SAMIHUL",150,0)
 ;  SAMIHOM4 bug fix for unmatched processing, turn off & on manual
"RTN","SAMIHUL",151,0)
 ; registration link on home page.
"RTN","SAMIHUL",152,0)
 ;
"RTN","SAMIHUL",153,0)
 ; 2020-01-10 ven/gpl 18.0 4c8e6ebc,76b465cb
"RTN","SAMIHUL",154,0)
 ;  SAMIHOM4 3 quits with returns for cache.
"RTN","SAMIHUL",155,0)
 ;
"RTN","SAMIHUL",156,0)
 ; 2020-01-16 ven/lgc 18.0 0a2af965
"RTN","SAMIHUL",157,0)
 ;  SAMIHOM4 bulk commit due to switch to cache.
"RTN","SAMIHUL",158,0)
 ;
"RTN","SAMIHUL",159,0)
 ; 2020-01-17/20 ven/lgc 18.1 8557207f,dc5f618c
"RTN","SAMIHUL",160,0)
 ;  SAMIHOM4 followup note, limit to one note per followup form.
"RTN","SAMIHUL",161,0)
 ;
"RTN","SAMIHUL",162,0)
 ; 2020-02-01/02 ven/lgc 18.4 3065146d,36ae0ed1
"RTN","SAMIHUL",163,0)
 ;  SAMIHOM4 set options for text based ctreport, switch default
"RTN","SAMIHUL",164,0)
 ; ctreport to text.
"RTN","SAMIHUL",165,0)
 ;
"RTN","SAMIHUL",166,0)
 ; 2020-04-02/11 ven/gpl 18.5 d36b7cad,36607664,befde317,56bfaed6,
"RTN","SAMIHUL",167,0)
 ; 666f5b91,2f2c29c1
"RTN","SAMIHUL",168,0)
 ;  SAMIHOM3 multitenancy; in GENSTDID add ARG param, determin prefix
"RTN","SAMIHUL",169,0)
 ; from site or siteid (ARG) instead of calling $$GETPRFX^SAMIFORM.
"RTN","SAMIHUL",170,0)
 ;  SAMIHOM4 multitenancy + fix bug in WSVAPALS.
"RTN","SAMIHUL",171,0)
 ;
"RTN","SAMIHUL",172,0)
 ; 2020-04-18/05-07 ven/gpl 18.5 29d7dba7,d55de214,521e0bdc,d018f52e,
"RTN","SAMIHUL",173,0)
 ; 476b2ff4,61c7d208
"RTN","SAMIHUL",174,0)
 ;  SAMIHOM4 fix bug & weird error in manual registration, fix bug in
"RTN","SAMIHUL",175,0)
 ; logout, logout working, superuser site selection, worklist
"RTN","SAMIHUL",176,0)
 ; functionality.
"RTN","SAMIHUL",177,0)
 ;
"RTN","SAMIHUL",178,0)
 ; 2020-08-06 ven/gpl 18.6 781744c3
"RTN","SAMIHUL",179,0)
 ;  SAMIHOM4 changes to support hl7 transmission of notes.
"RTN","SAMIHUL",180,0)
 ;
"RTN","SAMIHUL",181,0)
 ; 2020-09-22 ven/gpl 18.9 06459eda
"RTN","SAMIHUL",182,0)
 ;  SAMIHOM4 correct to match kids file.
"RTN","SAMIHUL",183,0)
 ;
"RTN","SAMIHUL",184,0)
 ; 2021-03-02 ven/gpl 18.9 479dc041
"RTN","SAMIHUL",185,0)
 ;  SAMIHOM4 return error message if no ct eval form exists when
"RTN","SAMIHUL",186,0)
 ; generating a fu note.
"RTN","SAMIHUL",187,0)
 ;
"RTN","SAMIHUL",188,0)
 ; 2021-03-11 ven/toad 18.9 a46a2cc1
"RTN","SAMIHUL",189,0)
 ;  SAMIHUL create routine.
"RTN","SAMIHUL",190,0)
 ;  SAMIHOM4 bump date & patch list, add contents, lt refactor.
"RTN","SAMIHUL",191,0)
 ;
"RTN","SAMIHUL",192,0)
 ; 2021-03-17 ven/toad 18.9
"RTN","SAMIHUL",193,0)
 ;  SAMIHOM4 remove blank from end of 1 line.
"RTN","SAMIHUL",194,0)
 ;
"RTN","SAMIHUL",195,0)
 ; 2021-05-29 ven/gpl 18.12-t2 59ea0811
"RTN","SAMIHUL",196,0)
 ;  SAMIHOM3 in SID2NUM look up by pien instead of relying on sid
"RTN","SAMIHUL",197,0)
 ; containing pien.
"RTN","SAMIHUL",198,0)
 ;
"RTN","SAMIHUL",199,0)
 ; 2021-06-15 ven/gpl 18.12-t2 e247ea59
"RTN","SAMIHUL",200,0)
 ;  SAMIHOM4 eliminate icn.
"RTN","SAMIHUL",201,0)
 ;
"RTN","SAMIHUL",202,0)
 ; 2021-06-15/16 ven/mcglk&toad 18.12-t2 cbf7e46b,fa794d60
"RTN","SAMIHUL",203,0)
 ;  SAMIHOM3 move log to SAMIHUL, bump dates & versions, annotate,
"RTN","SAMIHUL",204,0)
 ; reorg, lt refactor.
"RTN","SAMIHUL",205,0)
 ;  SAMIHOM4 bump dates & versions; begin annotate, reorg, lt refactor
"RTN","SAMIHUL",206,0)
 ; but interrupted by addition of critical fix to patch & bronchitis,
"RTN","SAMIHUL",207,0)
 ; so leave refactor unfinished (but stable as far as it went).
"RTN","SAMIHUL",208,0)
 ;  SAMIUTH3 bump dates & versions, lt refactor, add COVER, in UTSCAN4
"RTN","SAMIHUL",209,0)
 ; fix $random bug, but after discovering the SAMI test suite is so
"RTN","SAMIHUL",210,0)
 ; far out of date that it fails catastrophically with thousands of
"RTN","SAMIHUL",211,0)
 ; errors, back out changes and leave as it was.
"RTN","SAMIHUL",212,0)
 ;
"RTN","SAMIHUL",213,0)
 ; 2021-08-01 ven/gpl 18.12 5bd7c627
"RTN","SAMIHUL",214,0)
 ;  SAMIHOM3 set intake form to incomplete on creation: in MKSIFORM
"RTN","SAMIHUL",215,0)
 ; r/complete w/incomplete.
"RTN","SAMIHUL",216,0)
 ;
"RTN","SAMIHUL",217,0)
 ; 2021-09-20/23 ven/gpl 18-x-16 db1b173a,465b009d
"RTN","SAMIHUL",218,0)
 ;  SAMIHOM4 (with new routine SAMIZPH1) developed to import data from 
"RTN","SAMIHUL",219,0)
 ;  Philadelphia VA's previous LCS database in Red Cap, bump dates & versions.
"RTN","SAMIHUL",220,0)
 ;
"RTN","SAMIHUL",221,0)
 ; 2021-9-24 ven/lmry 18-16 465b009d
"RTN","SAMIHUL",222,0)
 ;  SAMIHOM4 bumped versions and dates
"RTN","SAMIHUL",223,0)
 ;
"RTN","SAMIHUL",224,0)
 ; 2021-10-19 ven/gpl 18-15 138d45e5
"RTN","SAMIHUL",225,0)
 ;  SAMIHOM4 parameterize veteran vs participant or candidate for notes
"RTN","SAMIHUL",226,0)
 ;
"RTN","SAMIHUL",227,0)
 ; 2021-10-29 ven/lmry 18-15  4267917c
"RTN","SAMIHUL",228,0)
 ;  SAMIHOM4 and SAMIHUL bumped versions and dates
"RTN","SAMIHUL",229,0)
 ;
"RTN","SAMIHUL",230,0)
 ; 2021-11-01 ven/gpl 18-15  e4722e8f0
"RTN","SAMIHUL",231,0)
 ;  SAMIHOM4 prevent using SYS as a site
"RTN","SAMIHUL",232,0)
 ;
"RTN","SAMIHUL",233,0)
 ; 2021-11-09 ven/gpl 18-15 34367ef0
"RTN","SAMIHUL",234,0)
 ;  SAMIHOM4 change GETHOME to cut off GET requests
"RTN","SAMIHUL",235,0)
 ;
"RTN","SAMIHUL",236,0)
 ; 2021-11-10 ven/gpl 18-15 ed2a3480
"RTN","SAMIHUL",237,0)
 ;  SAMIHOM4 support for samiroute=about points to vapals:about
"RTN","SAMIHUL",238,0)
 ;
"RTN","SAMIHUL",239,0)
 ; 2021-11-18 ven/lmry 18-15 596ea463
"RTN","SAMIHUL",240,0)
 ;  SAMIHOM4 and SAMIHUL bumped versions and dates
"RTN","SAMIHUL",241,0)
 ;
"RTN","SAMIHUL",242,0)
 ; 2021-11-22 ven/gpl 18-16  d26d00a7
"RTN","SAMIHUL",243,0)
 ;  SAMIHOM4 patch 16 DCM functionality
"RTN","SAMIHUL",244,0)
 ;
"RTN","SAMIHUL",245,0)
 ; 2022-01-02 ven/gpl 18-16 45fa4633
"RTN","SAMIHUL",246,0)
 ;  SAMIHOM4 Nashville sample data processing
"RTN","SAMIHUL",247,0)
 ;
"RTN","SAMIHUL",248,0)
 ; 2022-01-12 ven/gpl 18-15  ea379b6b
"RTN","SAMIHUL",249,0)
 ;  SAMIHOM4 change calls to SAMIORU to use a parameterized site
"RTN","SAMIHUL",250,0)
 ;
"RTN","SAMIHUL",251,0)
 ; 2022-01-12 ven/lmry 18-15  bcef2106
"RTN","SAMIHUL",252,0)
 ;  SAMIHOM4 and SAMIHUL bumped versions and dates
"RTN","SAMIHUL",253,0)
 ;
"RTN","SAMIHUL",254,0)
 ; 2022-01-17 ven/lmry 18-16
"RTN","SAMIHUL",255,0)
 ;  SAMIHOM4 and SAMIHUL bumped versions and dates
"RTN","SAMIHUL",256,0)
 ;  
"RTN","SAMIHUL",257,0)
 ;
"RTN","SAMIHUL",258,0)
 ;@contents
"RTN","SAMIHUL",259,0)
 ; SAMIHOM3 homepage interface library
"RTN","SAMIHUL",260,0)
 ; SAMIHOM4 homepage subroutines
"RTN","SAMIHUL",261,0)
 ; SAMIHUL homepage development log
"RTN","SAMIHUL",262,0)
 ; SAMIUTH3 tests for SAMIHOM3
"RTN","SAMIHUL",263,0)
 ; SAMIUTH4 tests for SAMIHOM4
"RTN","SAMIHUL",264,0)
 ;
"RTN","SAMIHUL",265,0)
 ;
"RTN","SAMIHUL",266,0)
 ;
"RTN","SAMIHUL",267,0)
EOR ; end of routine SAMIHUL
"RTN","SAMILD2")
0^5^B86184080
"RTN","SAMILD2",1,0)
SAMILD2 ;ven/gpl - LOAD TVH INTAKE SPREADSHEET ; 2022-01-18t00:21z
"RTN","SAMILD2",2,0)
 ;;18.0;SAMI;**16**;;Build 3
"RTN","SAMILD2",3,0)
 ;;18-16
"RTN","SAMILD2",4,0)
 ;
"RTN","SAMILD2",5,0)
 ;@license: see routine SAMIUL
"RTN","SAMILD2",6,0)
 ;
"RTN","SAMILD2",7,0)
 ; allow fallthrough
"RTN","SAMILD2",8,0)
 ;
"RTN","SAMILD2",9,0)
 ;
"RTN","SAMILD2",10,0)
 ;@section 0 primary development
"RTN","SAMILD2",11,0)
 ;
"RTN","SAMILD2",12,0)
 ;
"RTN","SAMILD2",13,0)
 ;
"RTN","SAMILD2",14,0)
 ;@routine-credits
"RTN","SAMILD2",15,0)
 ;@dev-main George P. Lilly (gpl)
"RTN","SAMILD2",16,0)
 ; gpl@vistaexpertise.net
"RTN","SAMILD2",17,0)
 ;@dev-org-main Vista Expertise Network (ven)
"RTN","SAMILD2",18,0)
 ; http://vistaexpertise.net
"RTN","SAMILD2",19,0)
 ;@copyright 2022, gpl, all rights reserved
"RTN","SAMILD2",20,0)
 ;@license see routine SAMIUL
"RTN","SAMILD2",21,0)
 ;
"RTN","SAMILD2",22,0)
 ;@last-update 2022-01-18t00:21z
"RTN","SAMILD2",23,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMILD2",24,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMILD2",25,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMILD2",26,0)
 ;@version 18.16
"RTN","SAMILD2",27,0)
 ;@release-date 2021-01
"RTN","SAMILD2",28,0)
 ;@patch-list **16**
"RTN","SAMILD2",29,0)
 ;
"RTN","SAMILD2",30,0)
 ;@dev-add Frederick D. S. Marshall (toad)
"RTN","SAMILD2",31,0)
 ; toad@vistaexpertise.net
"RTN","SAMILD2",32,0)
 ;@dev-add Kenneth W. McGlothlen (mcglk)
"RTN","SAMILD2",33,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMILD2",34,0)
 ;@dev-add Linda M. R. Yaw (lmry)
"RTN","SAMILD2",35,0)
 ; linda.yaw@vistaexpertise.net
"RTN","SAMILD2",36,0)
 ;
"RTN","SAMILD2",37,0)
 ; 2022-01-18 ven/lmry
"RTN","SAMILD2",38,0)
 ;  SAMILD2 fixes for XINDEX
"RTN","SAMILD2",39,0)
 ;
"RTN","SAMILD2",40,0)
 ;
"RTN","SAMILD2",41,0)
SEP() ; extrinsic returns the separator character used
"RTN","SAMILD2",42,0)
 Q $CHAR(9)
"RTN","SAMILD2",43,0)
 ;
"RTN","SAMILD2",44,0)
LOAD ;
"RTN","SAMILD2",45,0)
 N SITE
"RTN","SAMILD2",46,0)
 s SITE=$$PICSITE^SAMIMOV()
"RTN","SAMILD2",47,0)
 Q:SITE="^"
"RTN","SAMILD2",48,0)
 N FN,GN
"RTN","SAMILD2",49,0)
 ;S DIR="/tmp/"
"RTN","SAMILD2",50,0)
  ; prompt for the directory
"RTN","SAMILD2",51,0)
 N SAMIDIR
"RTN","SAMILD2",52,0)
 D GETDIR^SAMIFDM(.SAMIDIR)
"RTN","SAMILD2",53,0)
 Q:SAMIDIR=""
"RTN","SAMILD2",54,0)
 ;
"RTN","SAMILD2",55,0)
 do
"RTN","SAMILD2",56,0)
 . N DIR,X,Y,DA,DIRUT,DTOUT,DUOUT,DIROUT
"RTN","SAMILD2",57,0)
 . S DIR(0)="F^0:1024"
"RTN","SAMILD2",58,0)
 . S DIR("A")="Enter filename to load."
"RTN","SAMILD2",59,0)
 . S DIR("B")="LCSV2_DATA_2021-06-29_REDCAP.tsv"
"RTN","SAMILD2",60,0)
 . D ^DIR
"RTN","SAMILD2",61,0)
 . W !
"RTN","SAMILD2",62,0)
 . if '$data(DIRUT) set FN=Y
"RTN","SAMILD2",63,0)
 quit:'$data(FN)
"RTN","SAMILD2",64,0)
 ;
"RTN","SAMILD2",65,0)
 ;S FN="LCSV2_DATA_2021-06-29_REDCAP.csv"
"RTN","SAMILD2",66,0)
 ;S FN="LCSV2_DATA_2021-06-29_REDCAP.tsv"
"RTN","SAMILD2",67,0)
 S GN=$NA(^TMP("SAMICSV",$J,1))
"RTN","SAMILD2",68,0)
 K @GN
"RTN","SAMILD2",69,0)
 N OK
"RTN","SAMILD2",70,0)
 S OK=$$FTG^%ZISH(SAMIDIR,FN,GN,3)
"RTN","SAMILD2",71,0)
 D  ;
"RTN","SAMILD2",72,0)
 . ;
"RTN","SAMILD2",73,0)
 . ; Normalize overflow nodes (and hope for the best that we don't go over 32k)
"RTN","SAMILD2",74,0)
 . new i,j set (i,j)=""
"RTN","SAMILD2",75,0)
 . for  set i=$order(^TMP("SAMICSV",$J,i)) quit:'i  for  set j=$order(^TMP("SAMICSV",$J,i,"OVF",j)) quit:'j  do
"RTN","SAMILD2",76,0)
 .. set ^TMP("SAMICSV",$J,i)=^TMP("SAMICSV",$J,i)_^TMP("SAMICSV",$J,i,"OVF",j)  ;
"RTN","SAMILD2",77,0)
 K ^gpl("CSV")
"RTN","SAMILD2",78,0)
 M ^gpl("CSV")=^TMP("SAMICSV",$J)
"RTN","SAMILD2",79,0)
 D TOGRAPH(SITE) ; clear the load graph and read first line to key
"RTN","SAMILD2",80,0)
 D UNWRAP(SITE) ; parse all records into the graph
"RTN","SAMILD2",81,0)
 D IMPORT(SITE) ; do conversions where necessary and create SAMI patient
"RTN","SAMILD2",82,0)
 Q
"RTN","SAMILD2",83,0)
 ;
"RTN","SAMILD2",84,0)
TOGRAPH(SITE) ;
"RTN","SAMILD2",85,0)
 N GN S GN=$NA(^TMP("SAMICSV",$J))
"RTN","SAMILD2",86,0)
 d purgegraph^%wd(SITE_"-INTAKE")
"RTN","SAMILD2",87,0)
 n root s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMILD2",88,0)
 n keyrow,done s (keyrow,done)=0
"RTN","SAMILD2",89,0)
 f  s keyrow=$o(@GN@(keyrow)) q:keyrow=0  q:done  d  ;
"RTN","SAMILD2",90,0)
 . ; searching for the row with the field names
"RTN","SAMILD2",91,0)
 . i $l(@GN@(keyrow),$$SEP)<5 q  ; it will have at least 5 fields
"RTN","SAMILD2",92,0)
 . n tmprow s tmprow=$g(@GN@(keyrow))
"RTN","SAMILD2",93,0)
 . i $e(tmprow,1,9)["record_id" s done=1 q  ;
"RTN","SAMILD2",94,0)
 . i $e(tmprow,1,8)["saminame" s done=1 q  ;
"RTN","SAMILD2",95,0)
 s keyrow=keyrow-1
"RTN","SAMILD2",96,0)
 w !,"keyrow is ",keyrow," ROW="_@GN@(keyrow)
"RTN","SAMILD2",97,0)
 i keyrow=0 d  q  ;
"RTN","SAMILD2",98,0)
 . w !,"error reading tsv file, no key row found"
"RTN","SAMILD2",99,0)
 n zi,zl
"RTN","SAMILD2",100,0)
 ; first row
"RTN","SAMILD2",101,0)
 f zi=1:1:$l(@GN@(keyrow),$$SEP) d  ;
"RTN","SAMILD2",102,0)
 . s zl=$p(@GN@(keyrow),$$SEP,zi)
"RTN","SAMILD2",103,0)
 . s @root@("key",zi,zl)=""
"RTN","SAMILD2",104,0)
 . s @root@("key","B",zl,zi)=""
"RTN","SAMILD2",105,0)
 q
"RTN","SAMILD2",106,0)
 ;
"RTN","SAMILD2",107,0)
UNWRAP(SITE) ;
"RTN","SAMILD2",108,0)
 n root s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMILD2",109,0)
 n proot s proot=$na(@root@("records"))
"RTN","SAMILD2",110,0)
 n GN s GN=$NA(^TMP("SAMICSV",$J))
"RTN","SAMILD2",111,0)
 n key s key=$na(@root@("key"))
"RTN","SAMILD2",112,0)
 ; compute first data row
"RTN","SAMILD2",113,0)
 n datarow,done s datarow=1 s done=0 ;can't be the first row
"RTN","SAMILD2",114,0)
 f  s datarow=$o(@GN@(datarow)) q:done  q:+datarow=0  d  ;
"RTN","SAMILD2",115,0)
 . i $e(@GN@(1),1,9)["record_id" s done=1 s datarow=1
"RTN","SAMILD2",116,0)
 . i @GN@(datarow)["LAST,FIRST MIDDLE SUFFIX" s done=1 ;s datarow=datarow+1
"RTN","SAMILD2",117,0)
 i datarow=0 d  q  ;
"RTN","SAMILD2",118,0)
 . w !,"error, data row cannot be found"
"RTN","SAMILD2",119,0)
 w !,"data row is ",datarow," ROW=",@GN@(datarow)
"RTN","SAMILD2",120,0)
 n zi s zi=datarow-1
"RTN","SAMILD2",121,0)
 s done=0
"RTN","SAMILD2",122,0)
 f  s zi=$o(@GN@(zi)) q:+zi=0  q:done  d  ;
"RTN","SAMILD2",123,0)
 . i $g(@GN@(zi))="" s done=1 q  ; quit on a null line
"RTN","SAMILD2",124,0)
 . i $p(@GN@(zi),$$SEP,1)="" s done=1 q  ; quit if name is null
"RTN","SAMILD2",125,0)
 . i $e(@GN@(zi),1,1)=$CHAR(9) s done=1 q  ; quit if first field is null
"RTN","SAMILD2",126,0)
 . n zj
"RTN","SAMILD2",127,0)
 . f zj=1:1:$l(@GN@(zi),$$SEP) d  ;
"RTN","SAMILD2",128,0)
 . . n zl s zl=$o(@key@(zj,""))
"RTN","SAMILD2",129,0)
 . . i zl="" s zl="piece"_zj
"RTN","SAMILD2",130,0)
 . . n data s data=$p(@GN@(zi),$$SEP,zj)
"RTN","SAMILD2",131,0)
 . . i data["""" s data=$tr(data,"""")
"RTN","SAMILD2",132,0)
 . . s @proot@(zi,zl)=data
"RTN","SAMILD2",133,0)
 q
"RTN","SAMILD2",134,0)
 ;
"RTN","SAMILD2",135,0)
IMPORT(SITE) ; import from csv stored in SITE-INTAKE graph
"RTN","SAMILD2",136,0)
 N root,zi,croot,lroot,proot
"RTN","SAMILD2",137,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMILD2",138,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMILD2",139,0)
 s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMILD2",140,0)
 s croot=$na(@root@("records"))
"RTN","SAMILD2",141,0)
 s zi=0
"RTN","SAMILD2",142,0)
 f  s zi=$o(@croot@(zi)) q:+zi=0  d  ;
"RTN","SAMILD2",143,0)
 . n onepat,ztbl
"RTN","SAMILD2",144,0)
 . m onepat=@croot@(zi)
"RTN","SAMILD2",145,0)
 . s onepat("siteid")=SITE
"RTN","SAMILD2",146,0)
 . i '$d(onepat("saminame")) d  ;
"RTN","SAMILD2",147,0)
 . . i $d(onepat("last_name")) d  ;
"RTN","SAMILD2",148,0)
 . . . d RCAPHACK^SAMIZPH1("ztbl","onepat") ; this is a REDCAP record, convert
"RTN","SAMILD2",149,0)
 . e  d  ;
"RTN","SAMILD2",150,0)
 . . d CONVSS2^SAMISS("onepat") ; gpl plan B
"RTN","SAMILD2",151,0)
 . . ;d SSCONV^SAMISS("onepat") ; Ken's conversion routine
"RTN","SAMILD2",152,0)
 . i $g(onepat("saminame"))="" d  q  ; we must at least have a name
"RTN","SAMILD2",153,0)
 . . w !,SITE," error, name missing. Record=",zi," ROW=",$g(@GN@(zi))
"RTN","SAMILD2",154,0)
 . s onepat("site")=SITE
"RTN","SAMILD2",155,0)
 . i $$DEDUP(.onepat) d  q  ; is this a duplicate? if so, set studyid
"RTN","SAMILD2",156,0)
 . . w !,"error, duplicate patient. Skipping ",$g(onepat("saminame"))
"RTN","SAMILD2",157,0)
 . . q
"RTN","SAMILD2",158,0)
 . . n siform,sid
"RTN","SAMILD2",159,0)
 . . s sid=$g(onepat("studyid"))
"RTN","SAMILD2",160,0)
 . . i sid="" d  ;b  ;
"RTN","SAMILD2",161,0)
 . . . w !,"error processing duplicate record "
"RTN","SAMILD2",162,0)
 . . . d ^ZTER
"RTN","SAMILD2",163,0)
 . . s siform=$o(@proot@("graph",sid,"si"))
"RTN","SAMILD2",164,0)
 . . i siform="" d  ;b  ;
"RTN","SAMILD2",165,0)
 . . . w !,"error finding siform for sid ",sid
"RTN","SAMILD2",166,0)
 . . m @proot@("graph",sid,siform)=onepat
"RTN","SAMILD2",167,0)
 . d CREATE(.onepat)
"RTN","SAMILD2",168,0)
 Q
"RTN","SAMILD2",169,0)
 ;
"RTN","SAMILD2",170,0)
DEDUP(onepat) ; extrinsic which identifies a duplicate patient
"RTN","SAMILD2",171,0)
 ; if found, returns 1. also sets onepat("studyid")
"RTN","SAMILD2",172,0)
 n lroot,proot,dfn,lien,pien,sid
"RTN","SAMILD2",173,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMILD2",174,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMILD2",175,0)
 n inname s inname=$g(onepat("saminame"))
"RTN","SAMILD2",176,0)
 w !,"inname=",inname
"RTN","SAMILD2",177,0)
 i inname="" d  q 1 ;
"RTN","SAMILD2",178,0)
 . w !,"error, inname is null"
"RTN","SAMILD2",179,0)
 s lien=""
"RTN","SAMILD2",180,0)
 n tlien s tlien=""
"RTN","SAMILD2",181,0)
 f  s tlien=$o(@lroot@("name",inname,tlien)) q:tlien=""  d  ;
"RTN","SAMILD2",182,0)
 . q:'$d(@lroot@(tlien))
"RTN","SAMILD2",183,0)
 . q:$g(@lroot@(tlien,"siteid"))'=SITE
"RTN","SAMILD2",184,0)
 . s lien=tlien
"RTN","SAMILD2",185,0)
 q:lien="" 0
"RTN","SAMILD2",186,0)
 w !,"lien=",lien
"RTN","SAMILD2",187,0)
 i '$d(@lroot@("last5",$g(@lroot@(lien,"last5")))) d  q 0 ;
"RTN","SAMILD2",188,0)
 . ;w !,"last5 not found"
"RTN","SAMILD2",189,0)
 i '$d(onepat("dob")) s onepat("dob")=$g(onepat("sbdob"))
"RTN","SAMILD2",190,0)
 ;zwr @lroot@(lien,*)
"RTN","SAMILD2",191,0)
 ;n inlast5 s inlast5=$g(onepat("last5"))
"RTN","SAMILD2",192,0)
 ;w !,"inlast5=",inlast5
"RTN","SAMILD2",193,0)
 ;n last5 s last5=$o(@lroot@("last5",inlast5,""))
"RTN","SAMILD2",194,0)
 ;w !,"last5=",last5
"RTN","SAMILD2",195,0)
 ;q:last5="" 0
"RTN","SAMILD2",196,0)
 ;q:last5'=lien 0
"RTN","SAMILD2",197,0)
 s dfn=$g(@lroot@(lien,"dfn"))
"RTN","SAMILD2",198,0)
 w !,"dfn=",dfn
"RTN","SAMILD2",199,0)
 ;B
"RTN","SAMILD2",200,0)
 q:dfn="" 0
"RTN","SAMILD2",201,0)
 s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMILD2",202,0)
 q:pien=""
"RTN","SAMILD2",203,0)
 s sid=$g(@proot@(pien,"sisid"))
"RTN","SAMILD2",204,0)
 i sid="" s sid=$g(@proot@(pien,"samistudyid"))
"RTN","SAMILD2",205,0)
 w !,"sid=",sid
"RTN","SAMILD2",206,0)
 q:sid="" 0
"RTN","SAMILD2",207,0)
 s onepat("studyid")=sid
"RTN","SAMILD2",208,0)
 s onepat("dfn")=dfn
"RTN","SAMILD2",209,0)
 q 1
"RTN","SAMILD2",210,0)
 ; 
"RTN","SAMILD2",211,0)
CREATE(vars) ; create a patient record and an intake form from vars
"RTN","SAMILD2",212,0)
 ;
"RTN","SAMILD2",213,0)
 D REGISTER(.vars)
"RTN","SAMILD2",214,0)
 D ENROLL(.vars)
"RTN","SAMILD2",215,0)
 q
"RTN","SAMILD2",216,0)
 ;
"RTN","SAMILD2",217,0)
REGISTER(vars)  ;
"RTN","SAMILD2",218,0)
 N saminame
"RTN","SAMILD2",219,0)
 s saminame=$g(vars("saminame"))
"RTN","SAMILD2",220,0)
 i saminame="" s saminame=$g(vars("name"))
"RTN","SAMILD2",221,0)
 i saminame="" d  ;
"RTN","SAMILD2",222,0)
 . n nxtdfn s nxtdfn=$$nxtdfn^SAMIDCM1()
"RTN","SAMILD2",223,0)
 . s saminame="DOE"_nxtdfn_",JOHN"
"RTN","SAMILD2",224,0)
 . s vars("saminame")=saminame
"RTN","SAMILD2",225,0)
 s vars("name")=saminame
"RTN","SAMILD2",226,0)
 n varscpy m varscpy=vars
"RTN","SAMILD2",227,0)
 N SAMIRTN
"RTN","SAMILD2",228,0)
 D REG^SAMIHOM4(.SAMIRTN,.varscpy)
"RTN","SAMILD2",229,0)
 m vars=varscpy
"RTN","SAMILD2",230,0)
 ;s vars("dfn")=$$GETDFN(saminame)
"RTN","SAMILD2",231,0)
 ;m varscpy=vars
"RTN","SAMILD2",232,0)
 ;B
"RTN","SAMILD2",233,0)
 q
"RTN","SAMILD2",234,0)
 ;
"RTN","SAMILD2",235,0)
ENROLL(vars) ; 
"RTN","SAMILD2",236,0)
 n varscpy
"RTN","SAMILD2",237,0)
 m varscpy=vars
"RTN","SAMILD2",238,0)
 D WSNEWCAS^SAMIHOM3(.varscpy,.SAMIBDY,.SAMIRESULT)
"RTN","SAMILD2",239,0)
 ;ZWR varscpy
"RTN","SAMILD2",240,0)
 n sid,sikey
"RTN","SAMILD2",241,0)
 s sid=$g(varscpy("studyid"))
"RTN","SAMILD2",242,0)
 s sikey=$g(varscpy("form"))
"RTN","SAMILD2",243,0)
 s sikey=$p(sikey,"vapals:",2)
"RTN","SAMILD2",244,0)
 m vars=varscpy
"RTN","SAMILD2",245,0)
 ;w !,"sid: ",sid," sikey: ",sikey
"RTN","SAMILD2",246,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMILD2",247,0)
 q:sid=""
"RTN","SAMILD2",248,0)
 q:sikey=""
"RTN","SAMILD2",249,0)
 m @root@("graph",sid,sikey)=vars
"RTN","SAMILD2",250,0)
 ;N NUM S NUM=$$GETNUM(saminame)
"RTN","SAMILD2",251,0)
 ;D MKSIFORM^SAMIHOM3(NUM)
"RTN","SAMILD2",252,0)
 Q
"RTN","SAMILD2",253,0)
 ;
"RTN","SAMILD2",254,0)
FIX() ; look for bad patient records and fix them
"RTN","SAMILD2",255,0)
 ; doesn't delete unless DELETE=1 is set
"RTN","SAMILD2",256,0)
 N lroot,zi,proot,pien
"RTN","SAMILD2",257,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMILD2",258,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMILD2",259,0)
 s zi=0
"RTN","SAMILD2",260,0)
 f  s zi=$o(@lroot@(zi)) q:+zi=0  d  ;
"RTN","SAMILD2",261,0)
 . n site,dfn,sid
"RTN","SAMILD2",262,0)
 . s dfn=$g(@lroot@(zi,"dfn"))
"RTN","SAMILD2",263,0)
 . if dfn="" d  q  ;
"RTN","SAMILD2",264,0)
 . . w !,"bad lookup record, no dfn. lien=",zi
"RTN","SAMILD2",265,0)
 . . q:'$g(DELETE)
"RTN","SAMILD2",266,0)
 . . k @lroot@(zi)
"RTN","SAMILD2",267,0)
 . s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMILD2",268,0)
 . s site=$g(@lroot@(zi,"siteid"))
"RTN","SAMILD2",269,0)
 . if site="" d  q  ;
"RTN","SAMILD2",270,0)
 . . w !,"bad lookup record, no siteid. lien=",zi
"RTN","SAMILD2",271,0)
 . . q:'$g(DELETE)
"RTN","SAMILD2",272,0)
 . . k @lroot@(zi)
"RTN","SAMILD2",273,0)
 . . k @lroot@("dfn",dfn)
"RTN","SAMILD2",274,0)
 . . zwr @lroot@(zi,*)
"RTN","SAMILD2",275,0)
 . q:pien=""
"RTN","SAMILD2",276,0)
 . s sid=$g(@proot@(pien,"samistudyid"))
"RTN","SAMILD2",277,0)
 . i sid'="" d
"RTN","SAMILD2",278,0)
 . . i $e(sid,1,3)'[site d  ;
"RTN","SAMILD2",279,0)
 . . . w !,"error, sid does not match site lien=",zi," site=",site," sid=",sid
"RTN","SAMILD2",280,0)
 . . . q:'$g(DELETE)
"RTN","SAMILD2",281,0)
 . . . k @lroot@(zi)
"RTN","SAMILD2",282,0)
 . . . k @lroot@("dfn",dfn)
"RTN","SAMILD2",283,0)
 . . . k @proot@(pien)
"RTN","SAMILD2",284,0)
 . . . k @proot@("dfn",dfn)
"RTN","SAMILD2",285,0)
 . . . k @proot@("graph",sid)
"RTN","SAMILD2",286,0)
 q
"RTN","SAMILD2",287,0)
 ;
"RTN","SAMILOAD")
0^6^B65426323
"RTN","SAMILOAD",1,0)
SAMILOAD ;ven/gpl - LOAD REDCAP INTAKE SPREADSHEET ; 2022-01-18t00:26z
"RTN","SAMILOAD",2,0)
 ;;18.0;SAMI;**16**;;Build 3
"RTN","SAMILOAD",3,0)
 ;;18-16
"RTN","SAMILOAD",4,0)
 ;
"RTN","SAMILOAD",5,0)
 ;@license: see routine SAMIUL
"RTN","SAMILOAD",6,0)
 ;
"RTN","SAMILOAD",7,0)
 ; allow fallthrough
"RTN","SAMILOAD",8,0)
 ;
"RTN","SAMILOAD",9,0)
 ;
"RTN","SAMILOAD",10,0)
 ;@section 0 primary development
"RTN","SAMILOAD",11,0)
 ;
"RTN","SAMILOAD",12,0)
 ;
"RTN","SAMILOAD",13,0)
 ;
"RTN","SAMILOAD",14,0)
 ;@routine-credits
"RTN","SAMILOAD",15,0)
 ;@dev-main George P. Lilly (gpl)
"RTN","SAMILOAD",16,0)
 ; gpl@vistaexpertise.net
"RTN","SAMILOAD",17,0)
 ;@dev-org-main Vista Expertise Network (ven)
"RTN","SAMILOAD",18,0)
 ; http://vistaexpertise.net
"RTN","SAMILOAD",19,0)
 ;@copyright 2022, gpl, all rights reserved
"RTN","SAMILOAD",20,0)
 ;@license see routine SAMIUL
"RTN","SAMILOAD",21,0)
 ;
"RTN","SAMILOAD",22,0)
 ;@last-update 2022-01-18t00:26z
"RTN","SAMILOAD",23,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMILOAD",24,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMILOAD",25,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMILOAD",26,0)
 ;@version 18.16
"RTN","SAMILOAD",27,0)
 ;@release-date 2021-01
"RTN","SAMILOAD",28,0)
 ;@patch-list **16**
"RTN","SAMILOAD",29,0)
 ;
"RTN","SAMILOAD",30,0)
 ;@dev-add Frederick D. S. Marshall (toad)
"RTN","SAMILOAD",31,0)
 ; toad@vistaexpertise.net
"RTN","SAMILOAD",32,0)
 ;@dev-add Kenneth W. McGlothlen (mcglk)
"RTN","SAMILOAD",33,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMILOAD",34,0)
 ;@dev-add Linda M. R. Yaw (lmry)
"RTN","SAMILOAD",35,0)
 ; linda.yaw@vistaexpertise.net
"RTN","SAMILOAD",36,0)
 ;
"RTN","SAMILOAD",37,0)
 ; 2022-01-18 ven/lmry
"RTN","SAMILOAD",38,0)
 ;  SAMILOAD fixes for XINDEX
"RTN","SAMILOAD",39,0)
 ;
"RTN","SAMILOAD",40,0)
SEP() ; extrinsic returns the separator character used
"RTN","SAMILOAD",41,0)
 Q $CHAR(9)
"RTN","SAMILOAD",42,0)
 ;
"RTN","SAMILOAD",43,0)
LOAD ;
"RTN","SAMILOAD",44,0)
 N SITE
"RTN","SAMILOAD",45,0)
 s SITE=$$PICSITE^SAMIMOV()
"RTN","SAMILOAD",46,0)
 Q:SITE="^"
"RTN","SAMILOAD",47,0)
 N FN,GN
"RTN","SAMILOAD",48,0)
 ;S DIR="/tmp/"
"RTN","SAMILOAD",49,0)
  ; prompt for the directory
"RTN","SAMILOAD",50,0)
 N SAMIDIR
"RTN","SAMILOAD",51,0)
 D GETDIR^SAMIFDM(.SAMIDIR)
"RTN","SAMILOAD",52,0)
 Q:SAMIDIR=""
"RTN","SAMILOAD",53,0)
 ;
"RTN","SAMILOAD",54,0)
 do
"RTN","SAMILOAD",55,0)
 . N DIR,X,Y,DA,DIRUT,DTOUT,DUOUT,DIROUT
"RTN","SAMILOAD",56,0)
 . S DIR(0)="F^0:1024"
"RTN","SAMILOAD",57,0)
 . S DIR("A")="Enter filename to load."
"RTN","SAMILOAD",58,0)
 . S DIR("B")="LCSV2_DATA_2021-06-29_REDCAP.tsv"
"RTN","SAMILOAD",59,0)
 . D ^DIR
"RTN","SAMILOAD",60,0)
 . W !
"RTN","SAMILOAD",61,0)
 . if '$data(DIRUT) set FN=Y
"RTN","SAMILOAD",62,0)
 quit:'$data(FN)
"RTN","SAMILOAD",63,0)
 ;
"RTN","SAMILOAD",64,0)
 ;S FN="LCSV2_DATA_2021-06-29_REDCAP.csv"
"RTN","SAMILOAD",65,0)
 ;S FN="LCSV2_DATA_2021-06-29_REDCAP.tsv"
"RTN","SAMILOAD",66,0)
 S GN=$NA(^TMP("SAMICSV",$J,1))
"RTN","SAMILOAD",67,0)
 K @GN
"RTN","SAMILOAD",68,0)
 N OK
"RTN","SAMILOAD",69,0)
 S OK=$$FTG^%ZISH(SAMIDIR,FN,GN,3)
"RTN","SAMILOAD",70,0)
 D  ;
"RTN","SAMILOAD",71,0)
 . ;
"RTN","SAMILOAD",72,0)
 . ; Normalize overflow nodes (and hope for the best that we don't go over 32k)
"RTN","SAMILOAD",73,0)
 . new i,j set (i,j)=""
"RTN","SAMILOAD",74,0)
 . for  set i=$order(^TMP("SAMICSV",$J,i)) quit:'i  for  set j=$order(^TMP("SAMICSV",$J,i,"OVF",j)) quit:'j  do
"RTN","SAMILOAD",75,0)
 .. set ^TMP("SAMICSV",$J,i)=^TMP("SAMICSV",$J,i)_^TMP("SAMICSV",$J,i,"OVF",j)  ;
"RTN","SAMILOAD",76,0)
 K ^gpl("CSV")
"RTN","SAMILOAD",77,0)
 M ^gpl("CSV")=^TMP("SAMICSV",$J)
"RTN","SAMILOAD",78,0)
 D TOGRAPH(SITE) ; clear the load graph and read first line to key
"RTN","SAMILOAD",79,0)
 D UNWRAP(SITE) ; parse all records into the graph
"RTN","SAMILOAD",80,0)
 D IMPORT(SITE) ; do conversions where necessary and create SAMI patient
"RTN","SAMILOAD",81,0)
 Q
"RTN","SAMILOAD",82,0)
 ;
"RTN","SAMILOAD",83,0)
TOGRAPH(SITE) ;
"RTN","SAMILOAD",84,0)
 N GN S GN=$NA(^TMP("SAMICSV",$J))
"RTN","SAMILOAD",85,0)
 d purgegraph^%wd(SITE_"-INTAKE")
"RTN","SAMILOAD",86,0)
 n root s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMILOAD",87,0)
 n zi,zl
"RTN","SAMILOAD",88,0)
 ; first row
"RTN","SAMILOAD",89,0)
 f zi=1:1:$l(@GN@(1),$$SEP) d  ;
"RTN","SAMILOAD",90,0)
 . s zl=$p(@GN@(1),$$SEP,zi)
"RTN","SAMILOAD",91,0)
 . s @root@("key",zi,zl)=""
"RTN","SAMILOAD",92,0)
 . s @root@("key","B",zl,zi)=""
"RTN","SAMILOAD",93,0)
 q
"RTN","SAMILOAD",94,0)
 ;
"RTN","SAMILOAD",95,0)
UNWRAP(SITE) ;
"RTN","SAMILOAD",96,0)
 n root s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMILOAD",97,0)
 n proot s proot=$na(@root@("records"))
"RTN","SAMILOAD",98,0)
 n GN s GN=$NA(^TMP("SAMICSV",$J))
"RTN","SAMILOAD",99,0)
 n key s key=$na(@root@("key"))
"RTN","SAMILOAD",100,0)
 n zi s zi=1
"RTN","SAMILOAD",101,0)
 f  s zi=$o(@GN@(zi)) q:+zi=0  d  ;
"RTN","SAMILOAD",102,0)
 . n zj
"RTN","SAMILOAD",103,0)
 . f zj=1:1:$l(@GN@(zi),$$SEP) d  ;
"RTN","SAMILOAD",104,0)
 . . n zl s zl=$o(@key@(zj,""))
"RTN","SAMILOAD",105,0)
 . . i zl="" s zl="piece"_zj
"RTN","SAMILOAD",106,0)
 . . n data s data=$p(@GN@(zi),$$SEP,zj)
"RTN","SAMILOAD",107,0)
 . . i data["""" s data=$tr(data,"""")
"RTN","SAMILOAD",108,0)
 . . s @proot@(zi,zl)=data
"RTN","SAMILOAD",109,0)
 q
"RTN","SAMILOAD",110,0)
 ;
"RTN","SAMILOAD",111,0)
IMPORT(SITE) ; import from csv stored in SITE-INTAKE graph
"RTN","SAMILOAD",112,0)
 N root,zi,croot,lroot,proot
"RTN","SAMILOAD",113,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMILOAD",114,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMILOAD",115,0)
 s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMILOAD",116,0)
 s croot=$na(@root@("records"))
"RTN","SAMILOAD",117,0)
 s zi=""
"RTN","SAMILOAD",118,0)
 f  s zi=$o(@croot@(zi)) q:zi=""  d  ;
"RTN","SAMILOAD",119,0)
 . n onepat,ztbl
"RTN","SAMILOAD",120,0)
 . m onepat=@croot@(zi)
"RTN","SAMILOAD",121,0)
 . s onepat("siteid")=SITE
"RTN","SAMILOAD",122,0)
 . i '$d(onepat("saminame")) d  ;
"RTN","SAMILOAD",123,0)
 . . i $d(onepat("last_name")) d  ;
"RTN","SAMILOAD",124,0)
 . . . d RCAPHACK^SAMIZPH1("ztbl","onepat") ; this is a REDCAP record, convert
"RTN","SAMILOAD",125,0)
 . e  d SSCONV^SAMISS("ztbl","hack","onepat") ; Ken's conversion routine
"RTN","SAMILOAD",126,0)
 . i '$d(onepat("saminame")) d  q  ; we must at least have a name
"RTN","SAMILOAD",127,0)
 . . w !,SITE," error, name missing. Record=",zi
"RTN","SAMILOAD",128,0)
 . s onepat("site")=SITE
"RTN","SAMILOAD",129,0)
 . i $$DEDUP(.onepat) d  q  ; is this a duplicate? if so, set studyid
"RTN","SAMILOAD",130,0)
 . . w !,"error, duplicate patient. Skipping ",$g(onepat("saminame"))
"RTN","SAMILOAD",131,0)
 . . n siform,sid
"RTN","SAMILOAD",132,0)
 . . s sid=$g(onepat("studyid"))
"RTN","SAMILOAD",133,0)
 . . i sid="" d  ;b  ;
"RTN","SAMILOAD",134,0)
 . . . w !,"error processing duplicate record "
"RTN","SAMILOAD",135,0)
 . . . d ^ZTER
"RTN","SAMILOAD",136,0)
 . . s siform=$o(@proot@("graph",sid,"si"))
"RTN","SAMILOAD",137,0)
 . . i siform="" d  ;b  ;
"RTN","SAMILOAD",138,0)
 . . . w !,"error finding siform for sid ",sid
"RTN","SAMILOAD",139,0)
 . . m @proot@("graph",sid,siform)=onepat
"RTN","SAMILOAD",140,0)
 . d CREATE(.onepat)
"RTN","SAMILOAD",141,0)
 Q
"RTN","SAMILOAD",142,0)
 ;
"RTN","SAMILOAD",143,0)
DEDUP(onepat) ; extrinsic which identifies a duplicate patient
"RTN","SAMILOAD",144,0)
 ; if found, returns 1. also sets onepat("studyid")
"RTN","SAMILOAD",145,0)
 n lroot,proot,dfn,lien,pien,sid
"RTN","SAMILOAD",146,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMILOAD",147,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMILOAD",148,0)
 n inname s inname=$g(onepat("saminame"))
"RTN","SAMILOAD",149,0)
 w !,"inname=",inname
"RTN","SAMILOAD",150,0)
 s lien=""
"RTN","SAMILOAD",151,0)
 n tlien s tlien=""
"RTN","SAMILOAD",152,0)
 f  s tlien=$o(@lroot@("name",inname,tlien)) q:tlien=""  d  ;
"RTN","SAMILOAD",153,0)
 . q:'$d(@lroot@(tlien))
"RTN","SAMILOAD",154,0)
 . q:$g(@lroot@(tlien,"siteid"))'=SITE
"RTN","SAMILOAD",155,0)
 . s lien=tlien
"RTN","SAMILOAD",156,0)
 q:lien="" 0
"RTN","SAMILOAD",157,0)
 w !,"lien=",lien
"RTN","SAMILOAD",158,0)
 i '$d(@lroot@("last5",$g(@lroot@(lien,"last5")))) d  q 0 ;
"RTN","SAMILOAD",159,0)
 . ;w !,"last5 not found"
"RTN","SAMILOAD",160,0)
 i '$d(onepat("dob")) s onepat("dob")=$g(onepat("sbdob"))
"RTN","SAMILOAD",161,0)
 ;zwr @lroot@(lien,*)
"RTN","SAMILOAD",162,0)
 ;n inlast5 s inlast5=$g(onepat("last5"))
"RTN","SAMILOAD",163,0)
 ;w !,"inlast5=",inlast5
"RTN","SAMILOAD",164,0)
 ;n last5 s last5=$o(@lroot@("last5",inlast5,""))
"RTN","SAMILOAD",165,0)
 ;w !,"last5=",last5
"RTN","SAMILOAD",166,0)
 ;q:last5="" 0
"RTN","SAMILOAD",167,0)
 ;q:last5'=lien 0
"RTN","SAMILOAD",168,0)
 s dfn=$g(@lroot@(lien,"dfn"))
"RTN","SAMILOAD",169,0)
 w !,"dfn=",dfn
"RTN","SAMILOAD",170,0)
 ;B
"RTN","SAMILOAD",171,0)
 q:dfn="" 0
"RTN","SAMILOAD",172,0)
 s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMILOAD",173,0)
 q:pien=""
"RTN","SAMILOAD",174,0)
 s sid=$g(@proot@(pien,"sisid"))
"RTN","SAMILOAD",175,0)
 i sid="" s sid=$g(@proot@(pien,"samistudyid"))
"RTN","SAMILOAD",176,0)
 w !,"sid=",sid
"RTN","SAMILOAD",177,0)
 q:sid="" 0
"RTN","SAMILOAD",178,0)
 s onepat("studyid")=sid
"RTN","SAMILOAD",179,0)
 s onepat("dfn")=dfn
"RTN","SAMILOAD",180,0)
 q 1
"RTN","SAMILOAD",181,0)
 ; 
"RTN","SAMILOAD",182,0)
CREATE(vars) ; create a patient record and an intake form from vars
"RTN","SAMILOAD",183,0)
 ;
"RTN","SAMILOAD",184,0)
 D REGISTER(.vars)
"RTN","SAMILOAD",185,0)
 D ENROLL(.vars)
"RTN","SAMILOAD",186,0)
 q
"RTN","SAMILOAD",187,0)
 ;
"RTN","SAMILOAD",188,0)
REGISTER(vars)  ;
"RTN","SAMILOAD",189,0)
 N saminame
"RTN","SAMILOAD",190,0)
 s saminame=$g(vars("saminame"))
"RTN","SAMILOAD",191,0)
 i saminame="" s saminame=$g(vars("name"))
"RTN","SAMILOAD",192,0)
 i saminame="" d  ;
"RTN","SAMILOAD",193,0)
 . n nxtdfn s nxtdfn=$$nxtdfn^SAMIDCM1()
"RTN","SAMILOAD",194,0)
 . s saminame="DOE"_nxtdfn_",JOHN"
"RTN","SAMILOAD",195,0)
 . s vars("saminame")=saminame
"RTN","SAMILOAD",196,0)
 s vars("name")=saminame
"RTN","SAMILOAD",197,0)
 n varscpy m varscpy=vars
"RTN","SAMILOAD",198,0)
 N SAMIRTN
"RTN","SAMILOAD",199,0)
 D REG^SAMIHOM4(.SAMIRTN,.varscpy)
"RTN","SAMILOAD",200,0)
 m vars=varscpy
"RTN","SAMILOAD",201,0)
 ;s vars("dfn")=$$GETDFN(saminame)
"RTN","SAMILOAD",202,0)
 ;m varscpy=vars
"RTN","SAMILOAD",203,0)
 ;B
"RTN","SAMILOAD",204,0)
 q
"RTN","SAMILOAD",205,0)
 ;
"RTN","SAMILOAD",206,0)
ENROLL(vars) ; 
"RTN","SAMILOAD",207,0)
 n varscpy
"RTN","SAMILOAD",208,0)
 m varscpy=vars
"RTN","SAMILOAD",209,0)
 D WSNEWCAS^SAMIHOM3(.varscpy,.SAMIBDY,.SAMIRESULT)
"RTN","SAMILOAD",210,0)
 ;ZWR varscpy
"RTN","SAMILOAD",211,0)
 n sid,sikey
"RTN","SAMILOAD",212,0)
 s sid=$g(varscpy("studyid"))
"RTN","SAMILOAD",213,0)
 s sikey=$g(varscpy("form"))
"RTN","SAMILOAD",214,0)
 s sikey=$p(sikey,"vapals:",2)
"RTN","SAMILOAD",215,0)
 m vars=varscpy
"RTN","SAMILOAD",216,0)
 ;w !,"sid: ",sid," sikey: ",sikey
"RTN","SAMILOAD",217,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMILOAD",218,0)
 q:sid=""
"RTN","SAMILOAD",219,0)
 q:sikey=""
"RTN","SAMILOAD",220,0)
 m @root@("graph",sid,sikey)=vars
"RTN","SAMILOAD",221,0)
 ;N NUM S NUM=$$GETNUM(saminame)
"RTN","SAMILOAD",222,0)
 ;D MKSIFORM^SAMIHOM3(NUM)
"RTN","SAMILOAD",223,0)
 Q
"RTN","SAMILOAD",224,0)
 ;
"RTN","SAMILOAD",225,0)
FIX() ; look for bad patient records and fix them
"RTN","SAMILOAD",226,0)
 ; doesn't delete unless DELETE=1 is set
"RTN","SAMILOAD",227,0)
 N lroot,zi,proot,pien
"RTN","SAMILOAD",228,0)
 s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMILOAD",229,0)
 s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMILOAD",230,0)
 s zi=0
"RTN","SAMILOAD",231,0)
 f  s zi=$o(@lroot@(zi)) q:+zi=0  d  ;
"RTN","SAMILOAD",232,0)
 . n site,dfn,sid
"RTN","SAMILOAD",233,0)
 . s dfn=$g(@lroot@(zi,"dfn"))
"RTN","SAMILOAD",234,0)
 . if dfn="" d  q  ;
"RTN","SAMILOAD",235,0)
 . . w !,"bad lookup record, no dfn. lien=",zi
"RTN","SAMILOAD",236,0)
 . . q:'$g(DELETE)
"RTN","SAMILOAD",237,0)
 . . k @lroot@(zi)
"RTN","SAMILOAD",238,0)
 . s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMILOAD",239,0)
 . s site=$g(@lroot@(zi,"siteid"))
"RTN","SAMILOAD",240,0)
 . if site="" d  q  ;
"RTN","SAMILOAD",241,0)
 . . w !,"bad lookup record, no siteid. lien=",zi
"RTN","SAMILOAD",242,0)
 . . q:'$g(DELETE)
"RTN","SAMILOAD",243,0)
 . . k @lroot@(zi)
"RTN","SAMILOAD",244,0)
 . . k @lroot@("dfn",dfn)
"RTN","SAMILOAD",245,0)
 . . zwr @lroot@(zi,*)
"RTN","SAMILOAD",246,0)
 . q:pien=""
"RTN","SAMILOAD",247,0)
 . s sid=$g(@proot@(pien,"samistudyid"))
"RTN","SAMILOAD",248,0)
 . i sid'="" d
"RTN","SAMILOAD",249,0)
 . . i $e(sid,1,3)'[site d  ;
"RTN","SAMILOAD",250,0)
 . . . w !,"error, sid does not match site lien=",zi," site=",site," sid=",sid
"RTN","SAMILOAD",251,0)
 . . . q:'$g(DELETE)
"RTN","SAMILOAD",252,0)
 . . . k @lroot@(zi)
"RTN","SAMILOAD",253,0)
 . . . k @lroot@("dfn",dfn)
"RTN","SAMILOAD",254,0)
 . . . k @proot@(pien)
"RTN","SAMILOAD",255,0)
 . . . k @proot@("dfn",dfn)
"RTN","SAMILOAD",256,0)
 . . . k @proot@("graph",sid)
"RTN","SAMILOAD",257,0)
 q
"RTN","SAMILOAD",258,0)
 ;
"RTN","SAMISS")
0^7^B285157914
"RTN","SAMISS",1,0)
SAMISS ;ven/mcglk - VAPALS 'intake.xls' importer ; 2022-01-18t20:46z
"RTN","SAMISS",2,0)
 ;;18.0;SAMI;**16**;2020-01;Build 3
"RTN","SAMISS",3,0)
 ;18-16
"RTN","SAMISS",4,0)
 ;
"RTN","SAMISS",5,0)
 ;@license: see routine SAMIUL
"RTN","SAMISS",6,0)
 ;
"RTN","SAMISS",7,0)
 ;@section 0 primary development
"RTN","SAMISS",8,0)
 ;
"RTN","SAMISS",9,0)
 ;
"RTN","SAMISS",10,0)
 ;@routine-credits
"RTN","SAMISS",11,0)
 ;@dev-main George P. Lilly (gpl)
"RTN","SAMISS",12,0)
 ; gpl@vistaexpertise.net
"RTN","SAMISS",13,0)
 ;@dev-add Ken McGlothlen (mcglk)
"RTN","SAMISS",14,0)
 ; mcglk@vistaexpertise.net
"RTN","SAMISS",15,0)
 ;@dev-org-main Vista Expertise Network (ven)
"RTN","SAMISS",16,0)
 ; http://vistaexpertise.net
"RTN","SAMISS",17,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMISS",18,0)
 ;@license see routine SAMIUL
"RTN","SAMISS",19,0)
 ;
"RTN","SAMISS",20,0)
 ;@last-update 2022-01-18t20:46z
"RTN","SAMISS",21,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMISS",22,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMISS",23,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMISS",24,0)
 ;@version 18-14-16
"RTN","SAMISS",25,0)
 ;@release-date 2020-01
"RTN","SAMISS",26,0)
 ;@patch-list **16**
"RTN","SAMISS",27,0)
 ;
"RTN","SAMISS",28,0)
 ;
"RTN","SAMISS",29,0)
 ;@module-credits
"RTN","SAMISS",30,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMISS",31,0)
 ; (VA-PALS)
"RTN","SAMISS",32,0)
 ; http://va-pals.org/
"RTN","SAMISS",33,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMISS",34,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.
"RTN","SAMISS",35,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMISS",36,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMISS",37,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMISS",38,0)
 ; http://ielcap.com/
"RTN","SAMISS",39,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMISS",40,0)
 ; http://paraxialtech.com/
"RTN","SAMISS",41,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMISS",42,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMISS",43,0)
 ;
"RTN","SAMISS",44,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMISS",45,0)
 ;
"RTN","SAMISS",46,0)
 ; 2022-01-18 ven/lmry
"RTN","SAMISS",47,0)
 ;  SAMISS normalize line breaks, bump version and date, detab
"RTN","SAMISS",48,0)
 ;
"RTN","SAMISS",49,0)
 quit
"RTN","SAMISS",50,0)
 ;
"RTN","SAMISS",51,0)
YMDTOMDY(YMD) ; Convert "YYYY-MM-DD" to "MM/DD/YYYY"
"RTN","SAMISS",52,0)
 ; If YMD doesn't match the format, returns the string unchanged.
"RTN","SAMISS",53,0)
 new MDY set MDY=YMD
"RTN","SAMISS",54,0)
 if YMD?4N1"-"2N1"-"2N do
"RTN","SAMISS",55,0)
 . new YR set YR=$piece(YMD,"-")
"RTN","SAMISS",56,0)
 . new MO set MO=$piece(YMD,"-",2)
"RTN","SAMISS",57,0)
 . new DY set DY=$piece(YMD,"-",3)
"RTN","SAMISS",58,0)
 . set MDY=MO_"/"_DY_"/"_YR
"RTN","SAMISS",59,0)
 . quit
"RTN","SAMISS",60,0)
 ;
"RTN","SAMISS",61,0)
 quit MDY ; End of $$YMDTOMDY
"RTN","SAMISS",62,0)
 ;
"RTN","SAMISS",63,0)
 ;
"RTN","SAMISS",64,0)
FLDNUM(DROOT,FLDNAM) ; Returns the field number (IEN?) for a given field name.
"RTN","SAMISS",65,0)
 new FLDNUM set FLDNUM=""
"RTN","SAMISS",66,0)
 quit $order(@DROOT@("field","B",FLDNAM,""))
"RTN","SAMISS",67,0)
 ;
"RTN","SAMISS",68,0)
 ;
"RTN","SAMISS",69,0)
SSCONV(SS) ; converts the SS array, passed by name, to a
"RTN","SAMISS",70,0)
 merge ^KBBSSS=@SS
"RTN","SAMISS",71,0)
 ; loadable array for the import form
"RTN","SAMISS",72,0)
 ; NOTES
"RTN","SAMISS",73,0)
 ; SSCONV is being used in three places.
"RTN","SAMISS",74,0)
 ; (a) try to put formulas to be executed later to give values: PARY (unfinished)
"RTN","SAMISS",75,0)
 ; (b) a shortcut containing the actual precomputed data: HACK (operational)
"RTN","SAMISS",76,0)
 ; (c) HACK was also used for RedCap.
"RTN","SAMISS",77,0)
 ; SS contains raw data from the spreadsheet, with the intent on
"RTN","SAMISS",78,0)
 ; replacing those values with what should be there. HACK is to be
"RTN","SAMISS",79,0)
 ; ignored, and PARY is non-operational.
"RTN","SAMISS",80,0)
 ; *Data dictionaries*
"RTN","SAMISS",81,0)
 ; new DROOT
"RTN","SAMISS",82,0)
 ; set DROOT=$$setroot^%wd("form fields - intake")
"RTN","SAMISS",83,0)
 ; -> $$FLDNUM(DROOT,"siceiden") -> IEN
"RTN","SAMISS",84,0)
 ; input fields
"RTN","SAMISS",85,0)
 ; saminame LAST,FIRST MIDDLE SUFFIX
"RTN","SAMISS",86,0)
 ; ssn 000-00-0000
"RTN","SAMISS",87,0)
 ; sigi Select
"RTN","SAMISS",88,0)
 ; sex Select
"RTN","SAMISS",89,0)
 ; sbdob yyyy-mm-dd
"RTN","SAMISS",90,0)
 ; siceiden Select
"RTN","SAMISS",91,0)
 ; sicerfdt yyyy-mm-dd
"RTN","SAMISS",92,0)
 ; sicerfpc Select
"RTN","SAMISS",93,0)
 ; sicerfwh Select
"RTN","SAMISS",94,0)
 ; sicerfge Select
"RTN","SAMISS",95,0)
 ; sicerfpu Select
"RTN","SAMISS",96,0)
 ; sicerfon Select
"RTN","SAMISS",97,0)
 ; sicerfsc Select
"RTN","SAMISS",98,0)
 ; sicerfot Select
"RTN","SAMISS",99,0)
 ; sicerfoo Describe
"RTN","SAMISS",100,0)
 ; sicechrt Select
"RTN","SAMISS",101,0)
 ; sicemhlc Select
"RTN","SAMISS",102,0)
 ; sicemhhs Select
"RTN","SAMISS",103,0)
 ; sicemhot Select
"RTN","SAMISS",104,0)
 ; sicemhoo Describe
"RTN","SAMISS",105,0)
 ; sicecepc Select
"RTN","SAMISS",106,0)
 ; sicecenc Select
"RTN","SAMISS",107,0)
 ; siceceho Select
"RTN","SAMISS",108,0)
 ; sicecepr Select
"RTN","SAMISS",109,0)
 ; siceceot Select
"RTN","SAMISS",110,0)
 ; siceceoo Describe
"RTN","SAMISS",111,0)
 ; siceshqd Select
"RTN","SAMISS",112,0)
 ; siceshpy Select
"RTN","SAMISS",113,0)
 ; siceshnc Select
"RTN","SAMISS",114,0)
 ; siceshot Select
"RTN","SAMISS",115,0)
 ; siceshoo Describe
"RTN","SAMISS",116,0)
 ; sipedisc Select
"RTN","SAMISS",117,0)
 ; sipedc yyyy-mm-dd
"RTN","SAMISS",118,0)
 ; sipecnip Select
"RTN","SAMISS",119,0)
 ; sipecnte Select
"RTN","SAMISS",120,0)
 ; sipecnth Select
"RTN","SAMISS",121,0)
 ; sipecnml Select
"RTN","SAMISS",122,0)
 ; sipecnpp Select
"RTN","SAMISS",123,0)
 ; sipecnvd Select
"RTN","SAMISS",124,0)
 ; sipecnot Select
"RTN","SAMISS",125,0)
 ; sipecnoo Describe
"RTN","SAMISS",126,0)
 ; siperslt Select
"RTN","SAMISS",127,0)
 ; sipecmnt Comment
"RTN","SAMISS",128,0)
 ; sidc yyyy-mm-dd
"RTN","SAMISS",129,0)
 ; silnip Select
"RTN","SAMISS",130,0)
 ; silnph Select
"RTN","SAMISS",131,0)
 ; silnth Select
"RTN","SAMISS",132,0)
 ; silnml Select
"RTN","SAMISS",133,0)
 ; silnpp Select
"RTN","SAMISS",134,0)
 ; silnvd Select
"RTN","SAMISS",135,0)
 ; silnot Select
"RTN","SAMISS",136,0)
 ; silnoo Describe
"RTN","SAMISS",137,0)
 ; sipav Select
"RTN","SAMISS",138,0)
 ; sipsa Insert
"RTN","SAMISS",139,0)
 ; sipan Insert
"RTN","SAMISS",140,0)
 ; sipcn Insert
"RTN","SAMISS",141,0)
 ; sipc Insert
"RTN","SAMISS",142,0)
 ; sips Insert
"RTN","SAMISS",143,0)
 ; sipz Insert
"RTN","SAMISS",144,0)
 ; sipcr Insert
"RTN","SAMISS",145,0)
 ; sippn +1 (000) 000-0000
"RTN","SAMISS",146,0)
 ; sirs Select
"RTN","SAMISS",147,0)
 ; siesm Select
"RTN","SAMISS",148,0)
 ; siesq Select
"RTN","SAMISS",149,0)
 ; sies Comment
"RTN","SAMISS",150,0)
 ; sicpd Number
"RTN","SAMISS",151,0)
 ; sisny Number
"RTN","SAMISS",152,0)
 ; siq yyyy-mm-dd
"RTN","SAMISS",153,0)
 ; sicep Describe
"RTN","SAMISS",154,0)
 ; sicadx yyyy-mm-dd
"RTN","SAMISS",155,0)
 ; sicadxl Describe
"RTN","SAMISS",156,0)
 ; siptct yyyy-mm-dd
"RTN","SAMISS",157,0)
 ; siptctl Describe
"RTN","SAMISS",158,0)
 ; siidmdc Select
"RTN","SAMISS",159,0)
 ; sildct Select
"RTN","SAMISS",160,0)
 ; siclin Describe
"RTN","SAMISS",161,0)
 ; sipcrn Describe
"RTN","SAMISS",162,0)
 ; sistatus Select
"RTN","SAMISS",163,0)
 ; sicectap yyyy-mm-dd
"RTN","SAMISS",164,0)
 ; sistachg Select
"RTN","SAMISS",165,0)
 ; sidod yyyy-mm-dd
"RTN","SAMISS",166,0)
 ; sistreas       Describe
"RTN","SAMISS",167,0)
 ;
"RTN","SAMISS",168,0)
 ; 
"RTN","SAMISS",169,0)
 ;old RCAPHACK(PARY,HACK) ; initialize the redcap mapping table
"RTN","SAMISS",170,0)
 ;chart-eligibility-complete true
"RTN","SAMISS",171,0)
 ; this hack version accepts a redcap data array in HACK, passed by name
"RTN","SAMISS",172,0)
 ; and hard codes the results of the mapping rules in that same array
"RTN","SAMISS",173,0)
 ; for use while we are trying to get the mapper to work.
"RTN","SAMISS",174,0)
 ;
"RTN","SAMISS",175,0)
 ; S @PARY@("chart-eligibility-complete")="true"
"RTN","SAMISS",176,0)
 ; S @HACK@("chart-eligibility-complete")="true"
"RTN","SAMISS",177,0)
 ; S @SS@("chart-eligibility-complete")="true"
"RTN","SAMISS",178,0)
 ; ;dfn 9000098
"RTN","SAMISS",179,0)
 ; ;dob 1952-1-12
"RTN","SAMISS",180,0)
 ; S @PARY@("dob","dob")=""
"RTN","SAMISS",181,0)
 ; ;form siform-2021-09-21
"RTN","SAMISS",182,0)
 ; ;gender M^MALE
"RTN","SAMISS",183,0)
 ; S @PARY@("gender","gender")="$S(gender=2:""F^FEMALE"",1:""M^MALE"")"
"RTN","SAMISS",184,0)
 ; I $g(@HACK@("gender"))=2 s @HACK@("gender")="F"
"RTN","SAMISS",185,0)
 ; e  s @HACK@("gender")="M"
"RTN","SAMISS",186,0)
 ; ;last5 G0027
"RTN","SAMISS",187,0)
 ; S @PARY@("last5","ssn")="$$CALC5"
"RTN","SAMISS",188,0)
 ; S @HACK@("last5")=$$CALC5(HACK)
"RTN","SAMISS",189,0)
 ; ;notes 
"RTN","SAMISS",190,0)
 ; ;samicreatedate 2021-09-21
"RTN","SAMISS",191,0)
 ; S @PARY@("samicreatedate","sdm_visit_date")=""
"RTN","SAMISS",192,0)
 ; N formdate
"RTN","SAMISS",193,0)
 ; s formdate=$g(@HACK@("sdm_visit_date"))
"RTN","SAMISS",194,0)
 ; i formdate='"" s @HACK@("samicreatedate")=formdate
"RTN","SAMISS",195,0)
 ; ;samifirsttime false
"RTN","SAMISS",196,0)
 ; S @PARY@("samifirsttime")="false"
"RTN","SAMISS",197,0)
 ; S @HACK@("samifirsttime")="false"
"RTN","SAMISS",198,0)
 ; ;saminame GPL34567,TEST76543
"RTN","SAMISS",199,0)
 ; S @PARY@("saminame","last_name")="$$CALCNAME"
"RTN","SAMISS",200,0)
 ; S @HACK@("saminame")=$$CALCNAME(HACK)
"RTN","SAMISS",201,0)
 ; S @HACK@("name")=@HACK@("saminame")
"RTN","SAMISS",202,0)
 ; ;saminum 9000098
"RTN","SAMISS",203,0)
 ; ;samiroute postform
"RTN","SAMISS",204,0)
 ; ;samistatus complete
"RTN","SAMISS",205,0)
 ; ;samistudyid XXX9000098
"RTN","SAMISS",206,0)
 ; ;sbdob 1/12/1952
"RTN","SAMISS",207,0)
 ; S @PARY@("sbdob","dob")=""
"RTN","SAMISS",208,0)
 ; S @HACK@("sbdob")=@HACK@("dob")
"RTN","SAMISS",209,0)
 ; ;sex M
"RTN","SAMISS",210,0)
 ; S @HACK@("sex")=$g(@HACK@("gender"))
"RTN","SAMISS",211,0)
 ; ;I $g(@HACK@("gender"))=2 s @HACK@("sex")="F"
"RTN","SAMISS",212,0)
 ; ;e  s @HACK@("sex")="M"
"RTN","SAMISS",213,0)
 ; S @PARY@("sex","gender")="$S(gender=2:""F"",1:""M"")"
"RTN","SAMISS",214,0)
 ; ;sicadx 
"RTN","SAMISS",215,0)
 ; ;sicadxl 
"RTN","SAMISS",216,0)
 ; ;siceceho 
"RTN","SAMISS",217,0)
 ; ;sicecenc 
"RTN","SAMISS",218,0)
 ; ;siceceoo 
"RTN","SAMISS",219,0)
 ; ;siceceot 
"RTN","SAMISS",220,0)
 ; ;sicecepc 
"RTN","SAMISS",221,0)
 ; ;sicecepr 
"RTN","SAMISS",222,0)
 ; ;sicechrt y
"RTN","SAMISS",223,0)
 ; S @PARY@("sicechrt")="y"
"RTN","SAMISS",224,0)
 ; S @HACK@("sicechrt")="y"
"RTN","SAMISS",225,0)
 ; ;sicectap 08/27/2018
"RTN","SAMISS",226,0)
 ; S @PARY@("sicectap","base_order_date")=""
"RTN","SAMISS",227,0)
 ; S @HACK@("sicectap")=$g(@HACK@("base_order_date"))
"RTN","SAMISS",228,0)
 ; ;siceiden outreach
"RTN","SAMISS",229,0)
 ; S @PARY@("siceiden")="primary/self"
"RTN","SAMISS",230,0)
 ; S @HACK@("siceiden")="primary/self"
"RTN","SAMISS",231,0)
 ; ;sicemhhs 
"RTN","SAMISS",232,0)
 ; ;sicemhlc 
"RTN","SAMISS",233,0)
 ; ;sicemhoo 
"RTN","SAMISS",234,0)
 ; ;sicemhot 
"RTN","SAMISS",235,0)
 ; ;sicep declined smoking cessation
"RTN","SAMISS",236,0)
 ; S @PARY@("sicep","smoking_cessation_not")=""
"RTN","SAMISS",237,0)
 ; S @HACK@("sicep")=$G(@HACK@("smoking_cessation_not"))
"RTN","SAMISS",238,0)
 ; ;sicerfdt
"RTN","SAMISS",239,0)
 ; S @PARY@("sicerfdt","consult")=""
"RTN","SAMISS",240,0)
 ; S @HACK@("sicerfdt")=$G(@HACK@("consult"))
"RTN","SAMISS",241,0)
 ; ;sicerfge 
"RTN","SAMISS",242,0)
 ; ;sicerfon 
"RTN","SAMISS",243,0)
 ; ;sicerfoo 
"RTN","SAMISS",244,0)
 ; ;sicerfot 
"RTN","SAMISS",245,0)
 ; ;sicerfpc 
"RTN","SAMISS",246,0)
 ; ;sicerfpu 
"RTN","SAMISS",247,0)
 ; ;sicerfsc 
"RTN","SAMISS",248,0)
 ; ;sicerfwh 
"RTN","SAMISS",249,0)
 ; ;siceshnc 
"RTN","SAMISS",250,0)
 ; ;siceshoo 
"RTN","SAMISS",251,0)
 ; ;siceshot 
"RTN","SAMISS",252,0)
 ; ;siceshpy 
"RTN","SAMISS",253,0)
 ; ;siceshqd 
"RTN","SAMISS",254,0)
 ; ;siclin 2s-pcp notified
"RTN","SAMISS",255,0)
 ; S @PARY@("siclin","patient_notes")=""
"RTN","SAMISS",256,0)
 ; S @HACK@("siclin")=$g(@HACK@("patient_notes"))
"RTN","SAMISS",257,0)
 ; ;sicpd 40
"RTN","SAMISS",258,0)
 ; S @PARY@("sicpd","smoking_per_day")=""
"RTN","SAMISS",259,0)
 ; S @HACK@("sicpd")=$g(@HACK@("smoking_per_day"))
"RTN","SAMISS",260,0)
 ; ;sidc 09/21/2021
"RTN","SAMISS",261,0)
 ; S @PARY@("sidc","sdm_visit_date")=""
"RTN","SAMISS",262,0)
 ; s formdate=$g(@HACK@("sdm_visit_date"))
"RTN","SAMISS",263,0)
 ; i formdate'="" s @HACK@("sidc")=formdate
"RTN","SAMISS",264,0)
 ; ;sidob 1/12/1952
"RTN","SAMISS",265,0)
 ; S @PARY@("sidob","dob")=""
"RTN","SAMISS",266,0)
 ; s @HACK@("sidob")=$g(@HACK@("dob"))
"RTN","SAMISS",267,0)
 ; ;sies 
"RTN","SAMISS",268,0)
 ; ;siesm p
"RTN","SAMISS",269,0)
 ; S @PARY@("siesm","smoking_history")="$$HISTORY"
"RTN","SAMISS",270,0)
 ; n history s history=$g(@HACK@("smoking_history"))
"RTN","SAMISS",271,0)
 ; S @HACK@("siesm")=$s(history=2:"p",history=3:"n",1:"c")
"RTN","SAMISS",272,0)
 ; ;siesq 
"RTN","SAMISS",273,0)
 ; ;siidmdc 1
"RTN","SAMISS",274,0)
 ; S @PARY@("siidmdc")=1
"RTN","SAMISS",275,0)
 ; S @HACK@("siidmdc")=1
"RTN","SAMISS",276,0)
 ; ;sildct y
"RTN","SAMISS",277,0)
 ; S @PARY@("sildct")="y"
"RTN","SAMISS",278,0)
 ; S @HACK@("sildct")="y"
"RTN","SAMISS",279,0)
 ; ;silnip 
"RTN","SAMISS",280,0)
 ; ;silnml 
"RTN","SAMISS",281,0)
 ; ;silnot 
"RTN","SAMISS",282,0)
 ; ;silnph 1
"RTN","SAMISS",283,0)
 ; S @PARY@("silnph")=1
"RTN","SAMISS",284,0)
 ; S @HACK@("silnph")=1
"RTN","SAMISS",285,0)
 ; ;silnpp 
"RTN","SAMISS",286,0)
 ; ;silnth 
"RTN","SAMISS",287,0)
 ; ;silnvd 
"RTN","SAMISS",288,0)
 ; ;sinamef TEST76543
"RTN","SAMISS",289,0)
 ; S @PARY@("sinamef","first_name")=""
"RTN","SAMISS",290,0)
 ; S @HACK@("sinamef")=$G(@HACK@("first_name"))
"RTN","SAMISS",291,0)
 ; ;sinamel GPL34567
"RTN","SAMISS",292,0)
 ; S @PARY@("sinamel","last_name")=""
"RTN","SAMISS",293,0)
 ; S @HACK@("sinamel")=$G(@HACK@("last_name"))
"RTN","SAMISS",294,0)
 ; ;sipan 
"RTN","SAMISS",295,0)
 ; ;sipav n
"RTN","SAMISS",296,0)
 ; S @PARY@("sipav")="n"
"RTN","SAMISS",297,0)
 ; S @HACK@("sipav")="n"
"RTN","SAMISS",298,0)
 ; ;sipc 
"RTN","SAMISS",299,0)
 ; ;sipcn 
"RTN","SAMISS",300,0)
 ; ;sipcr USA
"RTN","SAMISS",301,0)
 ; S @PARY@("sipcr")="USA"
"RTN","SAMISS",302,0)
 ; S @HACK@("sipcr")="USA"
"RTN","SAMISS",303,0)
 ; ;sipcrn 
"RTN","SAMISS",304,0)
 ; ;sipecmnt 
"RTN","SAMISS",305,0)
 ; ;sipecnip 
"RTN","SAMISS",306,0)
 ; ;sipecnml 
"RTN","SAMISS",307,0)
 ; ;sipecnot 
"RTN","SAMISS",308,0)
 ; ;sipecnpp 
"RTN","SAMISS",309,0)
 ; ;sipecnte 
"RTN","SAMISS",310,0)
 ; ;sipecnth 
"RTN","SAMISS",311,0)
 ; ;sipecnvd 
"RTN","SAMISS",312,0)
 ; ;sipedc 09/21/2021
"RTN","SAMISS",313,0)
 ; S @PARY@("sipedc","sdm_visit_date")=""
"RTN","SAMISS",314,0)
 ; i formdate'="" s @HACK@("sipedc")=formdate
"RTN","SAMISS",315,0)
 ; ;sipedisc n
"RTN","SAMISS",316,0)
 ; S @PARY@("sipedisc")="n"
"RTN","SAMISS",317,0)
 ; S @HACK@("sipedisc")="n"
"RTN","SAMISS",318,0)
 ; ;sippd 2.00
"RTN","SAMISS",319,0)
 ; ;sippn 
"RTN","SAMISS",320,0)
 ; ;sippy 118.00
"RTN","SAMISS",321,0)
 ; ;sips 
"RTN","SAMISS",322,0)
 ; ;sipsa 
"RTN","SAMISS",323,0)
 ; ;siptct 
"RTN","SAMISS",324,0)
 ; ;siptctl 
"RTN","SAMISS",325,0)
 ; ;sipz 
"RTN","SAMISS",326,0)
 ; ;siq 01/01/2018
"RTN","SAMISS",327,0)
 ; S @PARY@("siq","year_quit")=""
"RTN","SAMISS",328,0)
 ; S @HACK@("siq")=$g(@HACK@("year_quit"))
"RTN","SAMISS",329,0)
 ; ;sirs r
"RTN","SAMISS",330,0)
 ; S @PARY@("sirs","rural")="$$RURAL"
"RTN","SAMISS",331,0)
 ; n rural s rural=$g(@HACK@("rural"))
"RTN","SAMISS",332,0)
 ; S @HACK@("sirs")=$s(rural=1:"r",rural=0:"u",1:"n")
"RTN","SAMISS",333,0)
 ; ;sisid XXX9000098
"RTN","SAMISS",334,0)
 ; ;sisny 59.0
"RTN","SAMISS",335,0)
 ; S @PARY@("sisny","smoked_years")=""
"RTN","SAMISS",336,0)
 ; S @HACK@("sisny")=$G(@HACK@("smoked_years"))
"RTN","SAMISS",337,0)
 ; ;sissn 999-99-0027
"RTN","SAMISS",338,0)
 ; S @PARY@("sissn","ssn")="$$CALCSSN"
"RTN","SAMISS",339,0)
 ; S @HACK@("sissn")=$$CALCSSN(HACK)
"RTN","SAMISS",340,0)
 ; ;sistatus active
"RTN","SAMISS",341,0)
 ; n noshow s noshow=$g(@HACK@("ldct_no_show_base"))
"RTN","SAMISS",342,0)
 ; S @PARY@("sistatus")="active"
"RTN","SAMISS",343,0)
 ; S @HACK@("sistatus")=$S(noshow'="":"inactive",1:"active")
"RTN","SAMISS",344,0)
 ; ;site XXX
"RTN","SAMISS",345,0)
 ; ;siteid XXX
"RTN","SAMISS",346,0)
 ; ;ssn 999990027
"RTN","SAMISS",347,0)
 ; S @PARY@("ssn","ssn")="$$CALCSSN"
"RTN","SAMISS",348,0)
 ; S @HACK@("ssn")=$$CALCSSN(HACK)
"RTN","SAMISS",349,0)
 ; ;studyid XXX9000098
"RTN","SAMISS",350,0)
 Q
"RTN","SAMISS",351,0)
 ;
"RTN","SAMISS",352,0)
INPUTBL(ARY) ; generate a table for intake form intake from tsv
"RTN","SAMISS",353,0)
 n DROOT s DROOT=$$setroot^%wd("form fields - intake")
"RTN","SAMISS",354,0)
 n zi s zi=0
"RTN","SAMISS",355,0)
 f  s zi=$o(@DROOT@("field",zi)) q:+zi=0  d  ;
"RTN","SAMISS",356,0)
 . n var,label,value,type s (var,label,value,type)=""
"RTN","SAMISS",357,0)
 . n zj s zj=0
"RTN","SAMISS",358,0)
 . f  s zj=$o(@DROOT@("field",zi,"input",zj)) q:+zj=0  d  ;
"RTN","SAMISS",359,0)
 . . s var=$g(@DROOT@("field",zi,"input",zj,"name"))
"RTN","SAMISS",360,0)
 . . s label=$g(@DROOT@("field",zi,"input",zj,"label"))
"RTN","SAMISS",361,0)
 . . s label=$tr(label,$C(13))
"RTN","SAMISS",362,0)
 . . s type=$g(@DROOT@("field",zi,"input",zj,"type"))
"RTN","SAMISS",363,0)
 . . s value=$g(@DROOT@("field",zi,"input",zj,"value"))
"RTN","SAMISS",364,0)
 . . q:var=""
"RTN","SAMISS",365,0)
 . . q:label=""
"RTN","SAMISS",366,0)
 . . s label=$tr(label,"""")
"RTN","SAMISS",367,0)
 . . s @ARY@(var,label)=value
"RTN","SAMISS",368,0)
 . . i type="checkbox" s @ARY@(var,"Yes")=value
"RTN","SAMISS",369,0)
 ;zwr @ARY@(*)
"RTN","SAMISS",370,0)
 s zi=""
"RTN","SAMISS",371,0)
 s zj=""
"RTN","SAMISS",372,0)
 f  s zi=$o(@ARY@(zi)) q:zi=""  d  ;
"RTN","SAMISS",373,0)
 . f  s zj=$o(@ARY@(zi,zj)) q:zj=""  d  ;
"RTN","SAMISS",374,0)
 . . n ln
"RTN","SAMISS",375,0)
 . . s ln=" S G("""_zi_""","""_zj_""")="""_$g(@ARY@(zi,zj))_""""
"RTN","SAMISS",376,0)
 . . w !,ln
"RTN","SAMISS",377,0)
 ;
"RTN","SAMISS",378,0)
 q
"RTN","SAMISS",379,0)
 ;
"RTN","SAMISS",380,0)
INITG2(G) ;
"RTN","SAMISS",381,0)
 S G("sicadx","MM/DD/YYYY")=""
"RTN","SAMISS",382,0)
 S G("sicadxl","Location if not in VA")=""
"RTN","SAMISS",383,0)
 S G("siceceho","Yes")="y"
"RTN","SAMISS",384,0)
 S G("siceceho","followed in hematology-oncology")="y"
"RTN","SAMISS",385,0)
 S G("sicecenc","Yes")="y"
"RTN","SAMISS",386,0)
 S G("sicecenc","followed in nodule clinic")="y"
"RTN","SAMISS",387,0)
 S G("siceceot","Yes")="y"
"RTN","SAMISS",388,0)
 S G("siceceot","other")="y"
"RTN","SAMISS",389,0)
 S G("sicecepc","Yes")="y"
"RTN","SAMISS",390,0)
 S G("sicecepc","followed in pulmonary clinic")="y"
"RTN","SAMISS",391,0)
 S G("sicecepr","Yes")="y"
"RTN","SAMISS",392,0)
 S G("sicecepr","private care")="y"
"RTN","SAMISS",393,0)
 S G("sicechrt","No")="n"
"RTN","SAMISS",394,0)
 S G("sicechrt","Yes")="y"
"RTN","SAMISS",395,0)
 S G("sicectap","CT Appointment")=""
"RTN","SAMISS",396,0)
 S G("siceiden","Low-dose CT placed directly by clinician")="ldct"
"RTN","SAMISS",397,0)
 S G("siceiden","Lung screening program outreach")="outreach"
"RTN","SAMISS",398,0)
 S G("siceiden","Referral")="referral"
"RTN","SAMISS",399,0)
 S G("siceiden","Self-referred")="self"
"RTN","SAMISS",400,0)
 S G("sicemhhs","Yes")="y"
"RTN","SAMISS",401,0)
 S G("sicemhhs","health status")="y"
"RTN","SAMISS",402,0)
 S G("sicemhlc","Yes")="y"
"RTN","SAMISS",403,0)
 S G("sicemhlc","lung cancer")="y"
"RTN","SAMISS",404,0)
 S G("sicemhot","Yes")="y"
"RTN","SAMISS",405,0)
 S G("sicemhot","other")="y"
"RTN","SAMISS",406,0)
 S G("sicep","Smoking cessation education provided")=""
"RTN","SAMISS",407,0)
 S G("sicerfdt","Date of referral")=""
"RTN","SAMISS",408,0)
 S G("sicerfge","Geriatrics")="y"
"RTN","SAMISS",409,0)
 S G("sicerfge","Yes")="y"
"RTN","SAMISS",410,0)
 S G("sicerfon","Oncology")="y"
"RTN","SAMISS",411,0)
 S G("sicerfon","Yes")="y"
"RTN","SAMISS",412,0)
 S G("sicerfot","Other")="y"
"RTN","SAMISS",413,0)
 S G("sicerfot","Yes")="y"
"RTN","SAMISS",414,0)
 S G("sicerfpc","Primary Care")="y"
"RTN","SAMISS",415,0)
 S G("sicerfpc","Yes")="y"
"RTN","SAMISS",416,0)
 S G("sicerfpu","Pulmonology")="y"
"RTN","SAMISS",417,0)
 S G("sicerfpu","Yes")="y"
"RTN","SAMISS",418,0)
 S G("sicerfsc","Smoking Cessation")="y"
"RTN","SAMISS",419,0)
 S G("sicerfsc","Yes")="y"
"RTN","SAMISS",420,0)
 S G("sicerfwh","Women's Health")="y"
"RTN","SAMISS",421,0)
 S G("sicerfwh","Yes")="y"
"RTN","SAMISS",422,0)
 S G("siceshnc","non-cigarette use (e.g. pipe, smokeless, vape, cannabis)")="y"
"RTN","SAMISS",423,0)
 S G("siceshnc","Yes")="y"
"RTN","SAMISS",424,0)
 S G("siceshnc","non-cigarette use (e.g. pipe, smokeless, vape, cannabis)")="y"
"RTN","SAMISS",425,0)
 S G("siceshot","Yes")="y"
"RTN","SAMISS",426,0)
 S G("siceshot","other")="y"
"RTN","SAMISS",427,0)
 S G("siceshpy","Yes")="y"
"RTN","SAMISS",428,0)
 S G("siceshpy","less than 30 pack years")="y"
"RTN","SAMISS",429,0)
 S G("siceshqd","Yes")="y"
"RTN","SAMISS",430,0)
 S G("siceshqd","quit date greater than 15 years")="y"
"RTN","SAMISS",431,0)
 S G("siclin","Clinical Indications for Initial Screening CT")=""
"RTN","SAMISS",432,0)
 S G("sicpd","How many cigarettes did you smoke per day?")=""
"RTN","SAMISS",433,0)
 S G("sidc","Date of contact")=""
"RTN","SAMISS",434,0)
 S G("sidod","Date of death")=""
"RTN","SAMISS",435,0)
 S G("sies","Comments")=""
"RTN","SAMISS",436,0)
 S G("siesm","Current")="c"
"RTN","SAMISS",437,0)
 S G("siesm","Never")="n"
"RTN","SAMISS",438,0)
 S G("siesm","Past")="p"
"RTN","SAMISS",439,0)
 S G("siesq","Yes")="1"
"RTN","SAMISS",440,0)
 S G("siidmdc","Discussion complete")="1"
"RTN","SAMISS",441,0)
 S G("siidmdc","Not applicable")="0"
"RTN","SAMISS",442,0)
 S G("sildct","Enroll in the Lung Screening program and have an LDCT ordered. Coordination of care will be made by the LSS team")="y"
"RTN","SAMISS",443,0)
 S G("sildct","Not enroll")="n"
"RTN","SAMISS",444,0)
 S G("sildct","Not enroll at this time -- okay to contact in the future")="l"
"RTN","SAMISS",445,0)
 S G("silnip","In person")="1"
"RTN","SAMISS",446,0)
 S G("silnip","Yes")="1"
"RTN","SAMISS",447,0)
 S G("silnml","Mailed letter")="1"
"RTN","SAMISS",448,0)
 S G("silnml","Yes")="1"
"RTN","SAMISS",449,0)
 S G("silnoo","Other contact method")=""
"RTN","SAMISS",450,0)
 S G("silnot","Other")="1"
"RTN","SAMISS",451,0)
 S G("silnot","Yes")="1"
"RTN","SAMISS",452,0)
 S G("silnph","Telephone")="1"
"RTN","SAMISS",453,0)
 S G("silnph","Yes")="1"
"RTN","SAMISS",454,0)
 S G("silnpp","Message in Patient Portal")="1"
"RTN","SAMISS",455,0)
 S G("silnpp","Yes")="1"
"RTN","SAMISS",456,0)
 S G("silnth","TeleHealth")="1"
"RTN","SAMISS",457,0)
 S G("silnth","Yes")="1"
"RTN","SAMISS",458,0)
 S G("silnvd","Video-on-Demand (VOD)")="1"
"RTN","SAMISS",459,0)
 S G("silnvd","Yes")="1"
"RTN","SAMISS",460,0)
 S G("sipan","Apt #")=""
"RTN","SAMISS",461,0)
 S G("sipav","No")="n"
"RTN","SAMISS",462,0)
 S G("sipav","Yes")="y"
"RTN","SAMISS",463,0)
 S G("sipc","City")=""
"RTN","SAMISS",464,0)
 S G("sipcn","County")=""
"RTN","SAMISS",465,0)
 S G("sipcr","Country")=""
"RTN","SAMISS",466,0)
 S G("sipcrn","Participant communication record")=""
"RTN","SAMISS",467,0)
 S G("sipecmnt","Comments")=""
"RTN","SAMISS",468,0)
 S G("sipecnip","In person")="1"
"RTN","SAMISS",469,0)
 S G("sipecnip","Yes")="1"
"RTN","SAMISS",470,0)
 S G("sipecnml","Mailed letter")="1"
"RTN","SAMISS",471,0)
 S G("sipecnml","Yes")="1"
"RTN","SAMISS",472,0)
 S G("sipecnoo","Other contact method")=""
"RTN","SAMISS",473,0)
 S G("sipecnot","Other")="1"
"RTN","SAMISS",474,0)
 S G("sipecnot","Yes")="1"
"RTN","SAMISS",475,0)
 S G("sipecnpp","Message in Patient Portal")="1"
"RTN","SAMISS",476,0)
 S G("sipecnpp","Yes")="1"
"RTN","SAMISS",477,0)
 S G("sipecnte","Telephone")="1"
"RTN","SAMISS",478,0)
 S G("sipecnte","Yes")="1"
"RTN","SAMISS",479,0)
 S G("sipecnth","TeleHealth")="1"
"RTN","SAMISS",480,0)
 S G("sipecnth","Yes")="1"
"RTN","SAMISS",481,0)
 S G("sipecnvd","Video-on-Demand (VOD)")="1"
"RTN","SAMISS",482,0)
 S G("sipecnvd","Yes")="1"
"RTN","SAMISS",483,0)
 S G("sipedc","Date of contact")=""
"RTN","SAMISS",484,0)
 S G("sipedisc","No")="n"
"RTN","SAMISS",485,0)
 S G("sipedisc","Yes")="y"
"RTN","SAMISS",486,0)
 S G("siperslt","Participant is interested in discussing lung screening. The program will proceed with enrollment process.")="y"
"RTN","SAMISS",487,0)
 S G("siperslt","Participant is not interested in discussing lung screening at this time. Ok to contact in the future.")="nn"
"RTN","SAMISS",488,0)
 S G("siperslt","Participant is not interested in discussing lung screening in the future.")="nf"
"RTN","SAMISS",489,0)
 S G("siperslt","Participant is unsure of lung screening. Ok to contact in the future.")="u"
"RTN","SAMISS",490,0)
 S G("siperslt","Unable to reach participant at this time.")="na"
"RTN","SAMISS",491,0)
 S G("sippn","Phone number")=""
"RTN","SAMISS",492,0)
 S G("sips","State")=""
"RTN","SAMISS",493,0)
 S G("sipsa","Preferred address")=""
"RTN","SAMISS",494,0)
 S G("siptct","MM/DD/YYYY")=""
"RTN","SAMISS",495,0)
 S G("siptctl","Location if not in VA")=""
"RTN","SAMISS",496,0)
 S G("sipz","Zip")=""
"RTN","SAMISS",497,0)
 S G("siq","Quit")=""
"RTN","SAMISS",498,0)
 S G("sirs","Rural")="r"
"RTN","SAMISS",499,0)
 S G("sirs","Unknown")="n"
"RTN","SAMISS",500,0)
 S G("sirs","Urban")="u"
"RTN","SAMISS",501,0)
 S G("sisny","# of years")=""
"RTN","SAMISS",502,0)
 S G("sistachg","-")=""
"RTN","SAMISS",503,0)
 S G("sistachg","-")=""
"RTN","SAMISS",504,0)
 S G("sistachg","Being followed elsewhere (get results)")="followed"
"RTN","SAMISS",505,0)
 S G("sistachg","Being followed elsewhere (get results)")="followed"
"RTN","SAMISS",506,0)
 S G("sistachg","Burden of cost")="cost"
"RTN","SAMISS",507,0)
 S G("sistachg","Concern about radiation")="radiation"
"RTN","SAMISS",508,0)
 S G("sistachg","Deceased")="deceased"
"RTN","SAMISS",509,0)
 S G("sistachg","Excluded (specify)")="excluded"
"RTN","SAMISS",510,0)
 S G("sistachg","Moved and unable to return")="moved"
"RTN","SAMISS",511,0)
 S G("sistachg","No insurance, can't have Dx CT")="insurance"
"RTN","SAMISS",512,0)
 S G("sistachg","No response to 3 calls + 3 letters")="noresponse"
"RTN","SAMISS",513,0)
 S G("sistachg","Other (specify)")="other"
"RTN","SAMISS",514,0)
 S G("sistachg","Physician advised against")="illadvised"
"RTN","SAMISS",515,0)
 S G("sistachg","Refused to continue")="refused"
"RTN","SAMISS",516,0)
 S G("sistachg","Study complete")="complete"
"RTN","SAMISS",517,0)
 S G("sistachg","Transferred to another institution (specify)")="transferred"
"RTN","SAMISS",518,0)
 S G("sistachg","Unable due to medical reason (specify)")="medical"
"RTN","SAMISS",519,0)
 S G("sistachg","Unable to contact")="nocontact"
"RTN","SAMISS",520,0)
 S G("sistachg","Unwilling due to personal reason (specify)")="unwilling"
"RTN","SAMISS",521,0)
 S G("sistatus","Active")="active"
"RTN","SAMISS",522,0)
 S G("sistatus","Not active")="inactive"
"RTN","SAMISS",523,0)
 S G("sistreas","Explanation")=""
"RTN","SAMISS",524,0)
 Q
"RTN","SAMISS",525,0)
 ;
"RTN","SAMISS",526,0)
CONVSS2(SS) ;
"RTN","SAMISS",527,0)
 N G D INITG2(.G)
"RTN","SAMISS",528,0)
 n zi s zi=""
"RTN","SAMISS",529,0)
 f  s zi=$o(@SS@(zi)) q:zi=""  d  ;
"RTN","SAMISS",530,0)
 . ; reserve for later processing
"RTN","SAMISS",531,0)
 . q:zi="sbdob"
"RTN","SAMISS",532,0)
 . q:zi="dob"
"RTN","SAMISS",533,0)
 . q:zi="sex"
"RTN","SAMISS",534,0)
 . q:zi="gender"
"RTN","SAMISS",535,0)
 . n val
"RTN","SAMISS",536,0)
 . s val=$g(@SS@(zi))
"RTN","SAMISS",537,0)
 . i $d(G(zi)) d  ;
"RTN","SAMISS",538,0)
 . . q:val=""
"RTN","SAMISS",539,0)
 . . n newval,found
"RTN","SAMISS",540,0)
 . . s newval=""
"RTN","SAMISS",541,0)
 . . s found=0
"RTN","SAMISS",542,0)
 . . i $d(G(zi,val)) d  ;
"RTN","SAMISS",543,0)
 . . . s newval=$g(G(zi,val))
"RTN","SAMISS",544,0)
 . . . s found=1
"RTN","SAMISS",545,0)
 . . i 'found d  ;
"RTN","SAMISS",546,0)
 . . . i val="Yes" d  q  ;
"RTN","SAMISS",547,0)
 . . . . s newval="y"
"RTN","SAMISS",548,0)
 . . . . s found=1
"RTN","SAMISS",549,0)
 . . . i $l(val,"-")=3 d  q  ;
"RTN","SAMISS",550,0)
 . . . . s newval=$$YMDTOMDY^SAMISS(val)
"RTN","SAMISS",551,0)
 . . . . s found=1
"RTN","SAMISS",552,0)
 . . . i val["(" d  ;
"RTN","SAMISS",553,0)
 . . . . n val2
"RTN","SAMISS",554,0)
 . . . . s val2=$p(val," (",1)
"RTN","SAMISS",555,0)
 . . . . i $d(G(zi,val2)) d  ;
"RTN","SAMISS",556,0)
 . . . . . s newval=$g(G(zi,val2))
"RTN","SAMISS",557,0)
 . . . . . s found=1
"RTN","SAMISS",558,0)
 . . . . q:found
"RTN","SAMISS",559,0)
 . . i found d  ;
"RTN","SAMISS",560,0)
 . . . w !,zi," ",val," changed to ",newval
"RTN","SAMISS",561,0)
 . . . s @SS@(zi)=newval
"RTN","SAMISS",562,0)
 . . e  d  ;
"RTN","SAMISS",563,0)
 . . . w !,"******** exception *********"
"RTN","SAMISS",564,0)
 . . . w "* ",zi," ",val," not found *"
"RTN","SAMISS",565,0)
 . . . ;w !,"*******************************"
"RTN","SAMISS",566,0)
 n gender s gender=$g(@SS@("sex"))
"RTN","SAMISS",567,0)
 s gender=$e(gender,1) ; either M or F
"RTN","SAMISS",568,0)
 s @SS@("gender")=gender
"RTN","SAMISS",569,0)
 s @SS@("sex")=gender
"RTN","SAMISS",570,0)
 n dob s dob=$g(@SS@("sbdob"))
"RTN","SAMISS",571,0)
 s @SS@("dob")=dob
"RTN","SAMISS",572,0)
 n saminame s saminame=$g(@SS@("saminame"))
"RTN","SAMISS",573,0)
 i saminame[", " s @SS@("saminame")=$p(saminame,", ",1)_","_$p(saminame,", ",2)
"RTN","SAMISS",574,0)
 q
"RTN","SAMISS",575,0)
 ; 
"RTN","SAMISS",576,0)
eor ; end of SAMISS
"RTN","SAMIZPH1")
0^3^B266456408
"RTN","SAMIZPH1",1,0)
SAMIZPH1 ;ven/gpl - VAPALS PATIENT IMPORT FOR PHILIDELPHIA ; 2022-01-18t00:32z
"RTN","SAMIZPH1",2,0)
 ;;18.0;SAMI;**16**;2020-01;Build 3
"RTN","SAMIZPH1",3,0)
 ;18-x-16-t2
"RTN","SAMIZPH1",4,0)
 ;
"RTN","SAMIZPH1",5,0)
 ;@license: see routine SAMIUL
"RTN","SAMIZPH1",6,0)
 ;
"RTN","SAMIZPH1",7,0)
 ;@section 0 primary development
"RTN","SAMIZPH1",8,0)
 ;
"RTN","SAMIZPH1",9,0)
 ;
"RTN","SAMIZPH1",10,0)
 ;
"RTN","SAMIZPH1",11,0)
 ;@routine-credits
"RTN","SAMIZPH1",12,0)
 ;@dev-main George P. Lilly (gpl)
"RTN","SAMIZPH1",13,0)
 ; gpl@vistaexpertise.net
"RTN","SAMIZPH1",14,0)
 ;@dev-org-main Vista Expertise Network (ven)
"RTN","SAMIZPH1",15,0)
 ; http://vistaexpertise.net
"RTN","SAMIZPH1",16,0)
 ;@copyright 2017/2021, gpl, all rights reserved
"RTN","SAMIZPH1",17,0)
 ;@license see routine SAMIUL
"RTN","SAMIZPH1",18,0)
 ;
"RTN","SAMIZPH1",19,0)
 ;@last-update 2022-01-18t00:32z
"RTN","SAMIZPH1",20,0)
 ;@application Screening Applications Management (SAM)
"RTN","SAMIZPH1",21,0)
 ;@module Screening Applications Management - IELCAP (SAMI)
"RTN","SAMIZPH1",22,0)
 ;@suite-of-files SAMI Forms (311.101-311.199)
"RTN","SAMIZPH1",23,0)
 ;@version 18-14-16
"RTN","SAMIZPH1",24,0)
 ;@release-date 2020-01
"RTN","SAMIZPH1",25,0)
 ;@patch-list **16**
"RTN","SAMIZPH1",26,0)
 ;
"RTN","SAMIZPH1",27,0)
 ;
"RTN","SAMIZPH1",28,0)
 ;@module-credits
"RTN","SAMIZPH1",29,0)
 ;@project VA Partnership to Increase Access to Lung Screening
"RTN","SAMIZPH1",30,0)
 ; (VA-PALS)
"RTN","SAMIZPH1",31,0)
 ; http://va-pals.org/
"RTN","SAMIZPH1",32,0)
 ;@funding 2017/2021, Bristol-Myers Squibb Foundation (bmsf)
"RTN","SAMIZPH1",33,0)
 ; https://www.bms.com/about-us/responsibility/bristol-myers-squibb-foundation.html
"RTN","SAMIZPH1",34,0)
 ;@partner-org Veterans Affairs Office of Rural health
"RTN","SAMIZPH1",35,0)
 ; https://www.ruralhealth.va.gov/
"RTN","SAMIZPH1",36,0)
 ;@partner-org International Early Lung Cancer Action Program (I-ELCAP)
"RTN","SAMIZPH1",37,0)
 ; http://ielcap.com/
"RTN","SAMIZPH1",38,0)
 ;@partner-org Paraxial Technologies (par)
"RTN","SAMIZPH1",39,0)
 ; http://paraxialtech.com/
"RTN","SAMIZPH1",40,0)
 ;@partner-org Open Source Electronic Health Record Alliance (OSEHRA)
"RTN","SAMIZPH1",41,0)
 ; https://www.osehra.org/groups/va-pals-open-source-project-group
"RTN","SAMIZPH1",42,0)
 ;
"RTN","SAMIZPH1",43,0)
 ;@module-log repo github.com:VA-PALS-ELCAP/SAMI-VAPALS-ELCAP.git
"RTN","SAMIZPH1",44,0)
 ;
"RTN","SAMIZPH1",45,0)
 ; 2021-09-20/23 ven/gpl sami-18-14-16-t1
"RTN","SAMIZPH1",46,0)
 ; SAMIZPH1 develop method to import data from a REDCap data system used by
"RTN","SAMIZPH1",47,0)
 ; the Philadelphia VA.
"RTN","SAMIZPH1",48,0)
 ;
"RTN","SAMIZPH1",49,0)
 ; 2021-09-27 ven/gpl sami-18-14-16-t1
"RTN","SAMIZPH1",50,0)
 ; SAMIZPH1 fix bug where Cache was putting the TSV records in overflow
"RTN","SAMIZPH1",51,0)
 ;
"RTN","SAMIZPH1",52,0)
 ; 2022-01-18 ven/lmry 18-16
"RTN","SAMIZPH1",53,0)
 ;  SAMIZPH1 Bump dates, fixes for XINDEX
"RTN","SAMIZPH1",54,0)
 ;
"RTN","SAMIZPH1",55,0)
 Q
"RTN","SAMIZPH1",56,0)
 ;
"RTN","SAMIZPH1",57,0)
SEP() ; extrinsic returns the separator character used
"RTN","SAMIZPH1",58,0)
 Q $CHAR(9)
"RTN","SAMIZPH1",59,0)
 ;
"RTN","SAMIZPH1",60,0)
EN ;
"RTN","SAMIZPH1",61,0)
 N SITE
"RTN","SAMIZPH1",62,0)
 s SITE=$$PICSITE^SAMIMOV()
"RTN","SAMIZPH1",63,0)
 Q:SITE="^"
"RTN","SAMIZPH1",64,0)
 N FN,GN
"RTN","SAMIZPH1",65,0)
 ;S DIR="/tmp/"
"RTN","SAMIZPH1",66,0)
  ; prompt for the directory
"RTN","SAMIZPH1",67,0)
 N SAMIDIR
"RTN","SAMIZPH1",68,0)
 D GETDIR^SAMIFDM(.SAMIDIR)
"RTN","SAMIZPH1",69,0)
 Q:SAMIDIR=""
"RTN","SAMIZPH1",70,0)
 ;
"RTN","SAMIZPH1",71,0)
 do
"RTN","SAMIZPH1",72,0)
 . N DIR,X,Y,DA,DIRUT,DTOUT,DUOUT,DIROUT
"RTN","SAMIZPH1",73,0)
 . S DIR(0)="F^0:1024"
"RTN","SAMIZPH1",74,0)
 . S DIR("A")="Enter filename to load."
"RTN","SAMIZPH1",75,0)
 . S DIR("B")="LCSV2_DATA_2021-06-29_REDCAP.tsv"
"RTN","SAMIZPH1",76,0)
 . D ^DIR
"RTN","SAMIZPH1",77,0)
 . W !
"RTN","SAMIZPH1",78,0)
 . if '$data(DIRUT) set FN=Y
"RTN","SAMIZPH1",79,0)
 quit:'$data(FN)
"RTN","SAMIZPH1",80,0)
 ;
"RTN","SAMIZPH1",81,0)
 ;S FN="LCSV2_DATA_2021-06-29_REDCAP.csv"
"RTN","SAMIZPH1",82,0)
 ;S FN="LCSV2_DATA_2021-06-29_REDCAP.tsv"
"RTN","SAMIZPH1",83,0)
 S GN=$NA(^TMP("SAMICSV",$J,1))
"RTN","SAMIZPH1",84,0)
 K @GN
"RTN","SAMIZPH1",85,0)
 N OK
"RTN","SAMIZPH1",86,0)
 S OK=$$FTG^%ZISH(SAMIDIR,FN,GN,3)
"RTN","SAMIZPH1",87,0)
 D  ;
"RTN","SAMIZPH1",88,0)
 . ;
"RTN","SAMIZPH1",89,0)
 . ; Normalize overflow nodes (and hope for the best that we don't go over 32k)
"RTN","SAMIZPH1",90,0)
 . new i,j set (i,j)=""
"RTN","SAMIZPH1",91,0)
 . for  set i=$order(^TMP("SAMICSV",$J,i)) quit:'i  for  set j=$order(^TMP("SAMICSV",$J,i,"OVF",j)) quit:'j  do
"RTN","SAMIZPH1",92,0)
 .. set ^TMP("SAMICSV",$J,i)=^TMP("SAMICSV",$J,i)_^TMP("SAMICSV",$J,i,"OVF",j)  ;
"RTN","SAMIZPH1",93,0)
 K ^gpl("CSV")
"RTN","SAMIZPH1",94,0)
 M ^gpl("CSV")=^TMP("SAMICSV",$J)
"RTN","SAMIZPH1",95,0)
 D TOGRAPH(SITE)
"RTN","SAMIZPH1",96,0)
 D REDCAP(SITE)
"RTN","SAMIZPH1",97,0)
 D IMPORT(SITE)
"RTN","SAMIZPH1",98,0)
 Q
"RTN","SAMIZPH1",99,0)
 ;
"RTN","SAMIZPH1",100,0)
TOGRAPH(SITE) ;
"RTN","SAMIZPH1",101,0)
 N GN S GN=$NA(^TMP("SAMICSV",$J))
"RTN","SAMIZPH1",102,0)
 d purgegraph^%wd(SITE_"-INTAKE")
"RTN","SAMIZPH1",103,0)
 n root s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMIZPH1",104,0)
 n zi,zl
"RTN","SAMIZPH1",105,0)
 ; first row
"RTN","SAMIZPH1",106,0)
 f zi=1:1:$l(@GN@(1),$$SEP) d  ;
"RTN","SAMIZPH1",107,0)
 . s zl=$p(@GN@(1),$$SEP,zi)
"RTN","SAMIZPH1",108,0)
 . s @root@("key",zi,zl)=""
"RTN","SAMIZPH1",109,0)
 . s @root@("key","B",zl,zi)=""
"RTN","SAMIZPH1",110,0)
 q
"RTN","SAMIZPH1",111,0)
 ;
"RTN","SAMIZPH1",112,0)
REDCAP(SITE) ;
"RTN","SAMIZPH1",113,0)
 n root s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMIZPH1",114,0)
 n proot s proot=$na(@root@("REDCAP"))
"RTN","SAMIZPH1",115,0)
 n GN s GN=$NA(^TMP("SAMICSV",$J))
"RTN","SAMIZPH1",116,0)
 n key s key=$na(@root@("key"))
"RTN","SAMIZPH1",117,0)
 n zi s zi=1
"RTN","SAMIZPH1",118,0)
 f  s zi=$o(@GN@(zi)) q:+zi=0  d  ;
"RTN","SAMIZPH1",119,0)
 . n zj
"RTN","SAMIZPH1",120,0)
 . f zj=1:1:$l(@GN@(zi),$$SEP) d  ;
"RTN","SAMIZPH1",121,0)
 . . n zl s zl=$o(@key@(zj,""))
"RTN","SAMIZPH1",122,0)
 . . i zl="" s zl="piece"_zj
"RTN","SAMIZPH1",123,0)
 . . s @proot@(zi,zl)=$p(@GN@(zi),$$SEP,zj)
"RTN","SAMIZPH1",124,0)
 q
"RTN","SAMIZPH1",125,0)
 ;
"RTN","SAMIZPH1",126,0)
IMPORT(SITE) ; import from csv stored in SITE-INTAKE graph
"RTN","SAMIZPH1",127,0)
 N root,zi,proot
"RTN","SAMIZPH1",128,0)
 s root=$$setroot^%wd(SITE_"-INTAKE")
"RTN","SAMIZPH1",129,0)
 s proot=$na(@root@("REDCAP"))
"RTN","SAMIZPH1",130,0)
 s zi=""
"RTN","SAMIZPH1",131,0)
 f  s zi=$o(@proot@(zi)) q:zi=""  d  ;
"RTN","SAMIZPH1",132,0)
 . n onepat,ztbl
"RTN","SAMIZPH1",133,0)
 . m onepat=@proot@(zi)
"RTN","SAMIZPH1",134,0)
 . d RCAPHACK("ztbl","onepat")
"RTN","SAMIZPH1",135,0)
 . s onepat("site")=SITE
"RTN","SAMIZPH1",136,0)
 . d CREATE(.onepat)
"RTN","SAMIZPH1",137,0)
 Q
"RTN","SAMIZPH1",138,0)
 ;
"RTN","SAMIZPH1",139,0)
T1() ;
"RTN","SAMIZPH1",140,0)
 ;
"RTN","SAMIZPH1",141,0)
 n vars
"RTN","SAMIZPH1",142,0)
 n saminame
"RTN","SAMIZPH1",143,0)
 s saminame="GPL34567,TEST76543"
"RTN","SAMIZPH1",144,0)
 s vars("name")=saminame
"RTN","SAMIZPH1",145,0)
 S vars("ssn")="999990027"
"RTN","SAMIZPH1",146,0)
 s vars("dob")="1952-01-12"
"RTN","SAMIZPH1",147,0)
 s vars("gender")="M"
"RTN","SAMIZPH1",148,0)
 s vars("site")="XXX"
"RTN","SAMIZPH1",149,0)
 d CREATE(.vars)
"RTN","SAMIZPH1",150,0)
 q
"RTN","SAMIZPH1",151,0)
 ;
"RTN","SAMIZPH1",152,0)
CREATE(vars) ; create a patient record and an intake form from vars
"RTN","SAMIZPH1",153,0)
 ;
"RTN","SAMIZPH1",154,0)
 D REGISTER(.vars)
"RTN","SAMIZPH1",155,0)
 D ENROLL(.vars)
"RTN","SAMIZPH1",156,0)
 q
"RTN","SAMIZPH1",157,0)
 ;
"RTN","SAMIZPH1",158,0)
REGISTER(vars)  ;
"RTN","SAMIZPH1",159,0)
 N saminame
"RTN","SAMIZPH1",160,0)
 s saminame=$g(vars("saminame"))
"RTN","SAMIZPH1",161,0)
 i saminame="" s saminame=$g(vars("name"))
"RTN","SAMIZPH1",162,0)
 i saminame="" d  ;
"RTN","SAMIZPH1",163,0)
 . n nxtdfn s nxtdfn=$$nxtdfn^SAMIDCM1()
"RTN","SAMIZPH1",164,0)
 . s saminame="DOE"_nxtdfn_",JOHN"
"RTN","SAMIZPH1",165,0)
 . s vars("saminame")=saminame
"RTN","SAMIZPH1",166,0)
 s vars("name")=saminame
"RTN","SAMIZPH1",167,0)
 n varscpy m varscpy=vars
"RTN","SAMIZPH1",168,0)
 N SAMIRTN
"RTN","SAMIZPH1",169,0)
 D REG^SAMIHOM4(.SAMIRTN,.varscpy)
"RTN","SAMIZPH1",170,0)
 m vars=varscpy
"RTN","SAMIZPH1",171,0)
 ;s vars("dfn")=$$GETDFN(saminame)
"RTN","SAMIZPH1",172,0)
 ;m varscpy=vars
"RTN","SAMIZPH1",173,0)
 ;B
"RTN","SAMIZPH1",174,0)
 q
"RTN","SAMIZPH1",175,0)
 ;
"RTN","SAMIZPH1",176,0)
ENROLL(vars) ; 
"RTN","SAMIZPH1",177,0)
 n varscpy
"RTN","SAMIZPH1",178,0)
 m varscpy=vars
"RTN","SAMIZPH1",179,0)
 D WSNEWCAS^SAMIHOM3(.varscpy,.SAMIBDY,.SAMIRESULT)
"RTN","SAMIZPH1",180,0)
 ;ZWR varscpy
"RTN","SAMIZPH1",181,0)
 n sid,sikey
"RTN","SAMIZPH1",182,0)
 s sid=$g(varscpy("studyid"))
"RTN","SAMIZPH1",183,0)
 s sikey=$g(varscpy("form"))
"RTN","SAMIZPH1",184,0)
 s sikey=$p(sikey,"vapals:",2)
"RTN","SAMIZPH1",185,0)
 m vars=varscpy
"RTN","SAMIZPH1",186,0)
 ;w !,"sid: ",sid," sikey: ",sikey
"RTN","SAMIZPH1",187,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMIZPH1",188,0)
 q:sid=""
"RTN","SAMIZPH1",189,0)
 q:sikey=""
"RTN","SAMIZPH1",190,0)
 m @root@("graph",sid,sikey)=vars
"RTN","SAMIZPH1",191,0)
 ;N NUM S NUM=$$GETNUM(saminame)
"RTN","SAMIZPH1",192,0)
 ;D MKSIFORM^SAMIHOM3(NUM)
"RTN","SAMIZPH1",193,0)
 Q
"RTN","SAMIZPH1",194,0)
 ;
"RTN","SAMIZPH1",195,0)
GETNUM(SAMINAME) ; extrinsic returns the ien in vapals-patients for 
"RTN","SAMIZPH1",196,0)
 ; name of SAMINAME
"RTN","SAMIZPH1",197,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIZPH1",198,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIZPH1",199,0)
 n lien s lien=$o(@lroot@("name",SAMINAME,""))
"RTN","SAMIZPH1",200,0)
 n dfn s dfn=$g(@lroot@(lien,"dfn"))
"RTN","SAMIZPH1",201,0)
 n num s num=$o(@proot@("dfn",dfn,""))
"RTN","SAMIZPH1",202,0)
 q num
"RTN","SAMIZPH1",203,0)
 ;
"RTN","SAMIZPH1",204,0)
GETDFN(SAMINAME) ; extrinsic returns the ien in vapals-patients for 
"RTN","SAMIZPH1",205,0)
 ; name of SAMINAME
"RTN","SAMIZPH1",206,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIZPH1",207,0)
 n lien s lien=$o(@lroot@("name",SAMINAME,""))
"RTN","SAMIZPH1",208,0)
 n dfn s dfn=$g(@lroot@(lien,"dfn"))
"RTN","SAMIZPH1",209,0)
 q dfn
"RTN","SAMIZPH1",210,0)
 ;
"RTN","SAMIZPH1",211,0)
PROCTBL(ARY,TBL) ; process an array (ARY) using a mapping table (TBL)
"RTN","SAMIZPH1",212,0)
 ; both passed by name
"RTN","SAMIZPH1",213,0)
 ;
"RTN","SAMIZPH1",214,0)
 n samiv s samiv=""
"RTN","SAMIZPH1",215,0)
 f  s samiv=$o(@TBL@(samiv)) q:samiv=""  d  ;
"RTN","SAMIZPH1",216,0)
 . W !,samiv
"RTN","SAMIZPH1",217,0)
 . n otherv
"RTN","SAMIZPH1",218,0)
 . s otherv=$o(@TBL@(samiv,""))
"RTN","SAMIZPH1",219,0)
 . w !,"otherv: "_otherv
"RTN","SAMIZPH1",220,0)
 . ;if $g(@ARY@(samiv))'="" q  ;
"RTN","SAMIZPH1",221,0)
 . if otherv="" s @ARY@(samiv)=$G(@TBL@(samiv)) q  ;
"RTN","SAMIZPH1",222,0)
 . n proc
"RTN","SAMIZPH1",223,0)
 . s proc=$g(@TBL@(samiv,otherv))
"RTN","SAMIZPH1",224,0)
 . i $e(proc,1,2)="$$" d  q  ;
"RTN","SAMIZPH1",225,0)
 . . ; call an extrinsic
"RTN","SAMIZPH1",226,0)
 . . n X s X="S @ARY@("""_samiv_""")="_proc_"(ARY)"
"RTN","SAMIZPH1",227,0)
 . . ;B
"RTN","SAMIZPH1",228,0)
 . . X @X
"RTN","SAMIZPH1",229,0)
 . i $e(proc,1,1)="$" d  q  ;
"RTN","SAMIZPH1",230,0)
 . . ; execute a line of code ie $select or $tr
"RTN","SAMIZPH1",231,0)
 . . n X s X="S @ARY@("""_samiv_""")="_proc
"RTN","SAMIZPH1",232,0)
 . . W !,"proc: ",X
"RTN","SAMIZPH1",233,0)
 . . X @X
"RTN","SAMIZPH1",234,0)
 . set @ARY@(samiv)=@ARY@(otherv) ; simple assignment
"RTN","SAMIZPH1",235,0)
 ;
"RTN","SAMIZPH1",236,0)
 Q
"RTN","SAMIZPH1",237,0)
 ;
"RTN","SAMIZPH1",238,0)
CALC5(SARY) ; extrinsic returns last5
"RTN","SAMIZPH1",239,0)
 n lname,ssn
"RTN","SAMIZPH1",240,0)
 s lname=@SARY@("last_name")
"RTN","SAMIZPH1",241,0)
 s ssn=@SARY@("ssn")
"RTN","SAMIZPH1",242,0)
 if $l(ssn)<4 s ssn=$e("0000",1,4-$l(ssn))_ssn
"RTN","SAMIZPH1",243,0)
 Q $e(lname,1,1)_ssn
"RTN","SAMIZPH1",244,0)
 ;
"RTN","SAMIZPH1",245,0)
CALCNAME(SARY) ; extrinsic returns lastname,firstname from array
"RTN","SAMIZPH1",246,0)
 Q $g(@SARY@("last_name"))_","_$g(@SARY@("first_name"))
"RTN","SAMIZPH1",247,0)
 ;
"RTN","SAMIZPH1",248,0)
CALCSSN(SARY) ; extrinsic returns false but correctly formatted ssn
"RTN","SAMIZPH1",249,0)
 n ssn s ssn=$g(@SARY@("ssn"))
"RTN","SAMIZPH1",250,0)
 i $l(ssn)<9 d  ;
"RTN","SAMIZPH1",251,0)
 . i $l(ssn)=4 s ssn=99999_ssn q
"RTN","SAMIZPH1",252,0)
 . s ssn=99999_$e("0000",1,4-$l(ssn))_ssn
"RTN","SAMIZPH1",253,0)
 Q ssn
"RTN","SAMIZPH1",254,0)
 ;
"RTN","SAMIZPH1",255,0)
RCAPTBL(PARY) ; initialize the redcap mapping table
"RTN","SAMIZPH1",256,0)
 ;chart-eligibility-complete true
"RTN","SAMIZPH1",257,0)
 S @PARY@("chart-eligibility-complete")="true"
"RTN","SAMIZPH1",258,0)
 ;dfn 9000098
"RTN","SAMIZPH1",259,0)
 ;dob 1952-1-12
"RTN","SAMIZPH1",260,0)
 S @PARY@("dob","dob")=""
"RTN","SAMIZPH1",261,0)
 ;form siform-2021-09-21
"RTN","SAMIZPH1",262,0)
 ;gender M^MALE
"RTN","SAMIZPH1",263,0)
 S @PARY@("gender","gender")="$S(gender=2:""F"",1:""M"")"
"RTN","SAMIZPH1",264,0)
 ;last5 G0027
"RTN","SAMIZPH1",265,0)
 S @PARY@("last5","ssn")="$$CALC5"
"RTN","SAMIZPH1",266,0)
 ;notes 
"RTN","SAMIZPH1",267,0)
 ;samicreatedate 2021-09-21
"RTN","SAMIZPH1",268,0)
 S @PARY@("samicreatedate","sdm_visit_date")=""
"RTN","SAMIZPH1",269,0)
 ;samifirsttime false
"RTN","SAMIZPH1",270,0)
 S @PARY@("samifirsttime")="false"
"RTN","SAMIZPH1",271,0)
 ;saminame GPL34567,TEST76543
"RTN","SAMIZPH1",272,0)
 S @PARY@("saminame","last_name")="$$CALCNAME"
"RTN","SAMIZPH1",273,0)
 ;saminum 9000098
"RTN","SAMIZPH1",274,0)
 ;samiroute postform
"RTN","SAMIZPH1",275,0)
 ;samistatus complete
"RTN","SAMIZPH1",276,0)
 ;samistudyid XXX9000098
"RTN","SAMIZPH1",277,0)
 ;sbdob 1/12/1952
"RTN","SAMIZPH1",278,0)
 S @PARY@("sbdob","dob")=""
"RTN","SAMIZPH1",279,0)
 ;sex M
"RTN","SAMIZPH1",280,0)
 S @PARY@("sex","gender")="$S(gender=2:""F"",1:""M"")"
"RTN","SAMIZPH1",281,0)
 ;sicadx 
"RTN","SAMIZPH1",282,0)
 ;sicadxl 
"RTN","SAMIZPH1",283,0)
 ;siceceho 
"RTN","SAMIZPH1",284,0)
 ;sicecenc 
"RTN","SAMIZPH1",285,0)
 ;siceceoo 
"RTN","SAMIZPH1",286,0)
 ;siceceot 
"RTN","SAMIZPH1",287,0)
 ;sicecepc 
"RTN","SAMIZPH1",288,0)
 ;sicecepr 
"RTN","SAMIZPH1",289,0)
 ;sicechrt y
"RTN","SAMIZPH1",290,0)
 S @PARY@("sicechrt")="y"
"RTN","SAMIZPH1",291,0)
 n elig s elig=$g(@HACK@("elig_enroll"))
"RTN","SAMIZPH1",292,0)
 S @HACK@("sicechrt")=$s(elig=0:"n",1:"y")
"RTN","SAMIZPH1",293,0)
 ;sicectap 08/27/2018
"RTN","SAMIZPH1",294,0)
 S @PARY@("sicectap","base_order_date")=""
"RTN","SAMIZPH1",295,0)
 ;siceiden outreach
"RTN","SAMIZPH1",296,0)
 S @PARY@("siceiden")="outreach"
"RTN","SAMIZPH1",297,0)
 ;sicemhhs 
"RTN","SAMIZPH1",298,0)
 ;sicemhlc 
"RTN","SAMIZPH1",299,0)
 ;sicemhoo 
"RTN","SAMIZPH1",300,0)
 ;sicemhot 
"RTN","SAMIZPH1",301,0)
 ;sicep declined smoking cessation
"RTN","SAMIZPH1",302,0)
 S @PARY@("sicep","smoking_cessation_not")=""
"RTN","SAMIZPH1",303,0)
 ;sicerfdt 
"RTN","SAMIZPH1",304,0)
 ;sicerfge 
"RTN","SAMIZPH1",305,0)
 ;sicerfon 
"RTN","SAMIZPH1",306,0)
 ;sicerfoo 
"RTN","SAMIZPH1",307,0)
 ;sicerfot 
"RTN","SAMIZPH1",308,0)
 ;sicerfpc 
"RTN","SAMIZPH1",309,0)
 ;sicerfpu 
"RTN","SAMIZPH1",310,0)
 ;sicerfsc 
"RTN","SAMIZPH1",311,0)
 ;sicerfwh 
"RTN","SAMIZPH1",312,0)
 ;siceshnc 
"RTN","SAMIZPH1",313,0)
 ;siceshoo 
"RTN","SAMIZPH1",314,0)
 ;siceshot 
"RTN","SAMIZPH1",315,0)
 ;siceshpy 
"RTN","SAMIZPH1",316,0)
 ;siceshqd 
"RTN","SAMIZPH1",317,0)
 ;siclin 2s-pcp notified
"RTN","SAMIZPH1",318,0)
 S @PARY@("siclin","patient_notes")=""
"RTN","SAMIZPH1",319,0)
 ;sicpd 40
"RTN","SAMIZPH1",320,0)
 S @PARY@("sicpd","smoking_per_day")=""
"RTN","SAMIZPH1",321,0)
 ;sidc 09/21/2021
"RTN","SAMIZPH1",322,0)
 S @PARY@("sidc","sdm_visit_date")=""
"RTN","SAMIZPH1",323,0)
 ;sidob 1/12/1952
"RTN","SAMIZPH1",324,0)
 S @PARY@("sidob","dob")=""
"RTN","SAMIZPH1",325,0)
 ;sies 
"RTN","SAMIZPH1",326,0)
 ;siesm p
"RTN","SAMIZPH1",327,0)
 S @PARY@("siesm")="p"
"RTN","SAMIZPH1",328,0)
 ;siesq 
"RTN","SAMIZPH1",329,0)
 ;siidmdc 1
"RTN","SAMIZPH1",330,0)
 S @PARY@("siidmdc")=1
"RTN","SAMIZPH1",331,0)
 ;sildct y
"RTN","SAMIZPH1",332,0)
 S @PARY@("sildct")="y"
"RTN","SAMIZPH1",333,0)
 ;silnip 
"RTN","SAMIZPH1",334,0)
 ;silnml 
"RTN","SAMIZPH1",335,0)
 ;silnot 
"RTN","SAMIZPH1",336,0)
 ;silnph 1
"RTN","SAMIZPH1",337,0)
 S @PARY@("silnph")=1
"RTN","SAMIZPH1",338,0)
 ;silnpp 
"RTN","SAMIZPH1",339,0)
 ;silnth 
"RTN","SAMIZPH1",340,0)
 ;silnvd 
"RTN","SAMIZPH1",341,0)
 ;sinamef TEST76543
"RTN","SAMIZPH1",342,0)
 S @PARY@("sinamef","first_name")=""
"RTN","SAMIZPH1",343,0)
 ;sinamel GPL34567
"RTN","SAMIZPH1",344,0)
 S @PARY@("sinamel","last_name")=""
"RTN","SAMIZPH1",345,0)
 ;sipan 
"RTN","SAMIZPH1",346,0)
 ;sipav n
"RTN","SAMIZPH1",347,0)
 S @PARY@("sipav")="n"
"RTN","SAMIZPH1",348,0)
 ;sipc 
"RTN","SAMIZPH1",349,0)
 ;sipcn 
"RTN","SAMIZPH1",350,0)
 ;sipcr USA
"RTN","SAMIZPH1",351,0)
 S @PARY@("sipcr")="USA"
"RTN","SAMIZPH1",352,0)
 ;sipcrn 
"RTN","SAMIZPH1",353,0)
 ;sipecmnt 
"RTN","SAMIZPH1",354,0)
 ;sipecnip 
"RTN","SAMIZPH1",355,0)
 ;sipecnml 
"RTN","SAMIZPH1",356,0)
 ;sipecnot 
"RTN","SAMIZPH1",357,0)
 ;sipecnpp 
"RTN","SAMIZPH1",358,0)
 ;sipecnte 
"RTN","SAMIZPH1",359,0)
 ;sipecnth 
"RTN","SAMIZPH1",360,0)
 ;sipecnvd 
"RTN","SAMIZPH1",361,0)
 ;sipedc 09/21/2021
"RTN","SAMIZPH1",362,0)
 S @PARY@("sipedc","sdm_visit_date")=""
"RTN","SAMIZPH1",363,0)
 ;sipedisc n
"RTN","SAMIZPH1",364,0)
 S @PARY@("sipedisc")="n"
"RTN","SAMIZPH1",365,0)
 ;sippd 2.00
"RTN","SAMIZPH1",366,0)
 ;sippn 
"RTN","SAMIZPH1",367,0)
 ;sippy 118.00
"RTN","SAMIZPH1",368,0)
 ;sips 
"RTN","SAMIZPH1",369,0)
 ;sipsa 
"RTN","SAMIZPH1",370,0)
 ;siptct 
"RTN","SAMIZPH1",371,0)
 ;siptctl 
"RTN","SAMIZPH1",372,0)
 ;sipz 
"RTN","SAMIZPH1",373,0)
 ;siq 01/01/2018
"RTN","SAMIZPH1",374,0)
 S @PARY@("siq","year_quit")=""
"RTN","SAMIZPH1",375,0)
 ;sisid XXX9000098
"RTN","SAMIZPH1",376,0)
 ;sisny 59.0
"RTN","SAMIZPH1",377,0)
 S @PARY@("sisny","smoked_years")=""
"RTN","SAMIZPH1",378,0)
 ;sissn 999-99-0027
"RTN","SAMIZPH1",379,0)
 S @PARY@("sissn","ssn")="$$CALCSSN"
"RTN","SAMIZPH1",380,0)
 ;sistatus active
"RTN","SAMIZPH1",381,0)
 S @PARY@("sistatus")="active"
"RTN","SAMIZPH1",382,0)
 ;site XXX
"RTN","SAMIZPH1",383,0)
 ;siteid XXX
"RTN","SAMIZPH1",384,0)
 ;ssn 999990027
"RTN","SAMIZPH1",385,0)
 S @PARY@("ssn","ssn")="$$CALCSSN"
"RTN","SAMIZPH1",386,0)
 ;studyid XXX9000098
"RTN","SAMIZPH1",387,0)
 Q
"RTN","SAMIZPH1",388,0)
 ;
"RTN","SAMIZPH1",389,0)
RCAPHACK(PARY,HACK) ; initialize the redcap mapping table
"RTN","SAMIZPH1",390,0)
 ;chart-eligibility-complete true
"RTN","SAMIZPH1",391,0)
 ; this hack version accepts a redcap data array in HACK, passed by name
"RTN","SAMIZPH1",392,0)
 ; and hard codes the results of the mapping rules in that same array
"RTN","SAMIZPH1",393,0)
 ; for use while we are trying to get the mapper to work.
"RTN","SAMIZPH1",394,0)
 ;
"RTN","SAMIZPH1",395,0)
 S @PARY@("chart-eligibility-complete")="true"
"RTN","SAMIZPH1",396,0)
 S @HACK@("chart-eligibility-complete")="true"
"RTN","SAMIZPH1",397,0)
 ;dfn 9000098
"RTN","SAMIZPH1",398,0)
 ;dob 1952-1-12
"RTN","SAMIZPH1",399,0)
 S @PARY@("dob","dob")=""
"RTN","SAMIZPH1",400,0)
 ;form siform-2021-09-21
"RTN","SAMIZPH1",401,0)
 ;gender M^MALE
"RTN","SAMIZPH1",402,0)
 S @PARY@("gender","gender")="$S(gender=2:""F^FEMALE"",1:""M^MALE"")"
"RTN","SAMIZPH1",403,0)
 I $g(@HACK@("gender"))=2 s @HACK@("gender")="F"
"RTN","SAMIZPH1",404,0)
 e  s @HACK@("gender")="M"
"RTN","SAMIZPH1",405,0)
 ;last5 G0027
"RTN","SAMIZPH1",406,0)
 S @PARY@("last5","ssn")="$$CALC5"
"RTN","SAMIZPH1",407,0)
 S @HACK@("last5")=$$CALC5(HACK)
"RTN","SAMIZPH1",408,0)
 ;notes 
"RTN","SAMIZPH1",409,0)
 ;samicreatedate 2021-09-21
"RTN","SAMIZPH1",410,0)
 S @PARY@("samicreatedate","sdm_visit_date")=""
"RTN","SAMIZPH1",411,0)
 N formdate
"RTN","SAMIZPH1",412,0)
 s formdate=$g(@HACK@("sdm_visit_date"))
"RTN","SAMIZPH1",413,0)
 i formdate='"" s @HACK@("samicreatedate")=formdate
"RTN","SAMIZPH1",414,0)
 ;samifirsttime false
"RTN","SAMIZPH1",415,0)
 S @PARY@("samifirsttime")="false"
"RTN","SAMIZPH1",416,0)
 S @HACK@("samifirsttime")="false"
"RTN","SAMIZPH1",417,0)
 ;saminame GPL34567,TEST76543
"RTN","SAMIZPH1",418,0)
 S @PARY@("saminame","last_name")="$$CALCNAME"
"RTN","SAMIZPH1",419,0)
 S @HACK@("saminame")=$$CALCNAME(HACK)
"RTN","SAMIZPH1",420,0)
 S @HACK@("name")=@HACK@("saminame")
"RTN","SAMIZPH1",421,0)
 ;saminum 9000098
"RTN","SAMIZPH1",422,0)
 ;samiroute postform
"RTN","SAMIZPH1",423,0)
 ;samistatus complete
"RTN","SAMIZPH1",424,0)
 ;samistudyid XXX9000098
"RTN","SAMIZPH1",425,0)
 ;sbdob 1/12/1952
"RTN","SAMIZPH1",426,0)
 S @PARY@("sbdob","dob")=""
"RTN","SAMIZPH1",427,0)
 S @HACK@("sbdob")=@HACK@("dob")
"RTN","SAMIZPH1",428,0)
 ;sex M
"RTN","SAMIZPH1",429,0)
 S @HACK@("sex")=$g(@HACK@("gender"))
"RTN","SAMIZPH1",430,0)
 ;I $g(@HACK@("gender"))=2 s @HACK@("sex")="F"
"RTN","SAMIZPH1",431,0)
 ;e  s @HACK@("sex")="M"
"RTN","SAMIZPH1",432,0)
 S @PARY@("sex","gender")="$S(gender=2:""F"",1:""M"")"
"RTN","SAMIZPH1",433,0)
 ;sicadx 
"RTN","SAMIZPH1",434,0)
 ;sicadxl 
"RTN","SAMIZPH1",435,0)
 ;siceceho 
"RTN","SAMIZPH1",436,0)
 ;sicecenc 
"RTN","SAMIZPH1",437,0)
 ;siceceoo 
"RTN","SAMIZPH1",438,0)
 ;siceceot 
"RTN","SAMIZPH1",439,0)
 ;sicecepc 
"RTN","SAMIZPH1",440,0)
 ;sicecepr 
"RTN","SAMIZPH1",441,0)
 ;sicechrt y
"RTN","SAMIZPH1",442,0)
 S @PARY@("sicechrt")="y"
"RTN","SAMIZPH1",443,0)
 S @HACK@("sicechrt")="y"
"RTN","SAMIZPH1",444,0)
 ;sicectap 08/27/2018
"RTN","SAMIZPH1",445,0)
 S @PARY@("sicectap","base_order_date")=""
"RTN","SAMIZPH1",446,0)
 S @HACK@("sicectap")=$g(@HACK@("base_order_date"))
"RTN","SAMIZPH1",447,0)
 ;siceiden outreach
"RTN","SAMIZPH1",448,0)
 S @PARY@("siceiden")="primary/self"
"RTN","SAMIZPH1",449,0)
 S @HACK@("siceiden")="primary/self"
"RTN","SAMIZPH1",450,0)
 ;sicemhhs 
"RTN","SAMIZPH1",451,0)
 ;sicemhlc 
"RTN","SAMIZPH1",452,0)
 ;sicemhoo 
"RTN","SAMIZPH1",453,0)
 ;sicemhot 
"RTN","SAMIZPH1",454,0)
 ;sicep declined smoking cessation
"RTN","SAMIZPH1",455,0)
 S @PARY@("sicep","smoking_cessation_not")=""
"RTN","SAMIZPH1",456,0)
 S @HACK@("sicep")=$G(@HACK@("smoking_cessation_not"))
"RTN","SAMIZPH1",457,0)
 ;sicerfdt
"RTN","SAMIZPH1",458,0)
 S @PARY@("sicerfdt","consult")=""
"RTN","SAMIZPH1",459,0)
 S @HACK@("sicerfdt")=$G(@HACK@("consult"))
"RTN","SAMIZPH1",460,0)
 ;sicerfge 
"RTN","SAMIZPH1",461,0)
 ;sicerfon 
"RTN","SAMIZPH1",462,0)
 ;sicerfoo 
"RTN","SAMIZPH1",463,0)
 ;sicerfot 
"RTN","SAMIZPH1",464,0)
 ;sicerfpc 
"RTN","SAMIZPH1",465,0)
 ;sicerfpu 
"RTN","SAMIZPH1",466,0)
 ;sicerfsc 
"RTN","SAMIZPH1",467,0)
 ;sicerfwh 
"RTN","SAMIZPH1",468,0)
 ;siceshnc 
"RTN","SAMIZPH1",469,0)
 ;siceshoo 
"RTN","SAMIZPH1",470,0)
 ;siceshot 
"RTN","SAMIZPH1",471,0)
 ;siceshpy 
"RTN","SAMIZPH1",472,0)
 ;siceshqd 
"RTN","SAMIZPH1",473,0)
 ;siclin 2s-pcp notified
"RTN","SAMIZPH1",474,0)
 S @PARY@("siclin","patient_notes")=""
"RTN","SAMIZPH1",475,0)
 S @HACK@("siclin")=$g(@HACK@("patient_notes"))
"RTN","SAMIZPH1",476,0)
 ;sicpd 40
"RTN","SAMIZPH1",477,0)
 S @PARY@("sicpd","smoking_per_day")=""
"RTN","SAMIZPH1",478,0)
 S @HACK@("sicpd")=$g(@HACK@("smoking_per_day"))
"RTN","SAMIZPH1",479,0)
 ;sidc 09/21/2021
"RTN","SAMIZPH1",480,0)
 S @PARY@("sidc","sdm_visit_date")=""
"RTN","SAMIZPH1",481,0)
 s formdate=$g(@HACK@("sdm_visit_date"))
"RTN","SAMIZPH1",482,0)
 i formdate'="" s @HACK@("sidc")=formdate
"RTN","SAMIZPH1",483,0)
 ;sidob 1/12/1952
"RTN","SAMIZPH1",484,0)
 S @PARY@("sidob","dob")=""
"RTN","SAMIZPH1",485,0)
 s @HACK@("sidob")=$g(@HACK@("dob"))
"RTN","SAMIZPH1",486,0)
 ;sies 
"RTN","SAMIZPH1",487,0)
 ;siesm p
"RTN","SAMIZPH1",488,0)
 S @PARY@("siesm","smoking_history")="$$HISTORY"
"RTN","SAMIZPH1",489,0)
 n history s history=$g(@HACK@("smoking_history"))
"RTN","SAMIZPH1",490,0)
 S @HACK@("siesm")=$s(history=2:"p",history=3:"n",1:"c")
"RTN","SAMIZPH1",491,0)
 ;siesq 
"RTN","SAMIZPH1",492,0)
 ;siidmdc 1
"RTN","SAMIZPH1",493,0)
 S @PARY@("siidmdc")=1
"RTN","SAMIZPH1",494,0)
 S @HACK@("siidmdc")=1
"RTN","SAMIZPH1",495,0)
 ;sildct y
"RTN","SAMIZPH1",496,0)
 S @PARY@("sildct")="y"
"RTN","SAMIZPH1",497,0)
 S @HACK@("sildct")="y"
"RTN","SAMIZPH1",498,0)
 ;silnip 
"RTN","SAMIZPH1",499,0)
 ;silnml 
"RTN","SAMIZPH1",500,0)
 ;silnot 
"RTN","SAMIZPH1",501,0)
 ;silnph 1
"RTN","SAMIZPH1",502,0)
 S @PARY@("silnph")=1
"RTN","SAMIZPH1",503,0)
 S @HACK@("silnph")=1
"RTN","SAMIZPH1",504,0)
 ;silnpp 
"RTN","SAMIZPH1",505,0)
 ;silnth 
"RTN","SAMIZPH1",506,0)
 ;silnvd 
"RTN","SAMIZPH1",507,0)
 ;sinamef TEST76543
"RTN","SAMIZPH1",508,0)
 S @PARY@("sinamef","first_name")=""
"RTN","SAMIZPH1",509,0)
 S @HACK@("sinamef")=$G(@HACK@("first_name"))
"RTN","SAMIZPH1",510,0)
 ;sinamel GPL34567
"RTN","SAMIZPH1",511,0)
 S @PARY@("sinamel","last_name")=""
"RTN","SAMIZPH1",512,0)
 S @HACK@("sinamel")=$G(@HACK@("last_name"))
"RTN","SAMIZPH1",513,0)
 ;sipan 
"RTN","SAMIZPH1",514,0)
 ;sipav n
"RTN","SAMIZPH1",515,0)
 S @PARY@("sipav")="n"
"RTN","SAMIZPH1",516,0)
 S @HACK@("sipav")="n"
"RTN","SAMIZPH1",517,0)
 ;sipc 
"RTN","SAMIZPH1",518,0)
 ;sipcn 
"RTN","SAMIZPH1",519,0)
 ;sipcr USA
"RTN","SAMIZPH1",520,0)
 S @PARY@("sipcr")="USA"
"RTN","SAMIZPH1",521,0)
 S @HACK@("sipcr")="USA"
"RTN","SAMIZPH1",522,0)
 ;sipcrn 
"RTN","SAMIZPH1",523,0)
 ;sipecmnt 
"RTN","SAMIZPH1",524,0)
 ;sipecnip 
"RTN","SAMIZPH1",525,0)
 ;sipecnml 
"RTN","SAMIZPH1",526,0)
 ;sipecnot 
"RTN","SAMIZPH1",527,0)
 ;sipecnpp 
"RTN","SAMIZPH1",528,0)
 ;sipecnte 
"RTN","SAMIZPH1",529,0)
 ;sipecnth 
"RTN","SAMIZPH1",530,0)
 ;sipecnvd 
"RTN","SAMIZPH1",531,0)
 ;sipedc 09/21/2021
"RTN","SAMIZPH1",532,0)
 S @PARY@("sipedc","sdm_visit_date")=""
"RTN","SAMIZPH1",533,0)
 i formdate'="" s @HACK@("sipedc")=formdate
"RTN","SAMIZPH1",534,0)
 ;sipedisc n
"RTN","SAMIZPH1",535,0)
 S @PARY@("sipedisc")="n"
"RTN","SAMIZPH1",536,0)
 S @HACK@("sipedisc")="n"
"RTN","SAMIZPH1",537,0)
 ;sippd 2.00
"RTN","SAMIZPH1",538,0)
 ;sippn 
"RTN","SAMIZPH1",539,0)
 ;sippy 118.00
"RTN","SAMIZPH1",540,0)
 ;sips 
"RTN","SAMIZPH1",541,0)
 ;sipsa 
"RTN","SAMIZPH1",542,0)
 ;siptct 
"RTN","SAMIZPH1",543,0)
 ;siptctl 
"RTN","SAMIZPH1",544,0)
 ;sipz 
"RTN","SAMIZPH1",545,0)
 ;siq 01/01/2018
"RTN","SAMIZPH1",546,0)
 S @PARY@("siq","year_quit")=""
"RTN","SAMIZPH1",547,0)
 S @HACK@("siq")=$g(@HACK@("year_quit"))
"RTN","SAMIZPH1",548,0)
 ;sirs r
"RTN","SAMIZPH1",549,0)
 S @PARY@("sirs","rural")="$$RURAL"
"RTN","SAMIZPH1",550,0)
 n rural s rural=$g(@HACK@("rural"))
"RTN","SAMIZPH1",551,0)
 S @HACK@("sirs")=$s(rural=1:"r",rural=0:"u",1:"n")
"RTN","SAMIZPH1",552,0)
 ;sisid XXX9000098
"RTN","SAMIZPH1",553,0)
 ;sisny 59.0
"RTN","SAMIZPH1",554,0)
 S @PARY@("sisny","smoked_years")=""
"RTN","SAMIZPH1",555,0)
 S @HACK@("sisny")=$G(@HACK@("smoked_years"))
"RTN","SAMIZPH1",556,0)
 ;sissn 999-99-0027
"RTN","SAMIZPH1",557,0)
 S @PARY@("sissn","ssn")="$$CALCSSN"
"RTN","SAMIZPH1",558,0)
 S @HACK@("sissn")=$$CALCSSN(HACK)
"RTN","SAMIZPH1",559,0)
 ;sistatus active
"RTN","SAMIZPH1",560,0)
 n noshow s noshow=$g(@HACK@("ldct_no_show_base"))
"RTN","SAMIZPH1",561,0)
 S @PARY@("sistatus")="active"
"RTN","SAMIZPH1",562,0)
 S @HACK@("sistatus")=$S(noshow'="":"inactive",1:"active")
"RTN","SAMIZPH1",563,0)
 ;site XXX
"RTN","SAMIZPH1",564,0)
 ;siteid XXX
"RTN","SAMIZPH1",565,0)
 ;ssn 999990027
"RTN","SAMIZPH1",566,0)
 S @PARY@("ssn","ssn")="$$CALCSSN"
"RTN","SAMIZPH1",567,0)
 S @HACK@("ssn")=$$CALCSSN(HACK)
"RTN","SAMIZPH1",568,0)
 ;studyid XXX9000098
"RTN","SAMIZPH1",569,0)
 Q
"RTN","SAMIZPH1",570,0)
 ;
"RTN","SAMIZPH1",571,0)
T2() ;
"RTN","SAMIZPH1",572,0)
 N RCAPARY,ZTBL
"RTN","SAMIZPH1",573,0)
 D RCAPTBL("ZTBL")
"RTN","SAMIZPH1",574,0)
 D RCAPTST("RCAPARY")
"RTN","SAMIZPH1",575,0)
 ;
"RTN","SAMIZPH1",576,0)
 D PROCTBL("RCAPARY","ZTBL")
"RTN","SAMIZPH1",577,0)
 ZWR RCAPARY
"RTN","SAMIZPH1",578,0)
 Q
"RTN","SAMIZPH1",579,0)
 ;
"RTN","SAMIZPH1",580,0)
T3() ; HACK VERSION 
"RTN","SAMIZPH1",581,0)
 N RCAPARY,ZTBL
"RTN","SAMIZPH1",582,0)
 D RCAPTST("RCAPARY")
"RTN","SAMIZPH1",583,0)
 D RCAPHACK("ZTBL","RCAPARY")
"RTN","SAMIZPH1",584,0)
 ZWR RCAPARY
"RTN","SAMIZPH1",585,0)
 S RCAPARY("site")="XXX"
"RTN","SAMIZPH1",586,0)
 D CREATE(.RCAPARY)
"RTN","SAMIZPH1",587,0)
 Q
"RTN","SAMIZPH1",588,0)
 ;
"RTN","SAMIZPH1",589,0)
RCAPTST(RARY) ; initialize a Redcap test array
"RTN","SAMIZPH1",590,0)
 ;|--REDCAP 
"RTN","SAMIZPH1",591,0)
 S @RARY@("age")=70.1
"RTN","SAMIZPH1",592,0)
 S @RARY@("airway_disease___1")=1
"RTN","SAMIZPH1",593,0)
 S @RARY@("airway_disease___2")=1
"RTN","SAMIZPH1",594,0)
 S @RARY@("airway_disease___3")=0
"RTN","SAMIZPH1",595,0)
 S @RARY@("base_completion_date")="8/27/2018"
"RTN","SAMIZPH1",596,0)
 S @RARY@("base_order_date")="8/27/2018"
"RTN","SAMIZPH1",597,0)
 S @RARY@("base_schedule")=""
"RTN","SAMIZPH1",598,0)
 S @RARY@("bmi")=38.7
"RTN","SAMIZPH1",599,0)
 S @RARY@("cancer_hx")=1
"RTN","SAMIZPH1",600,0)
 S @RARY@("cancer_type")=""
"RTN","SAMIZPH1",601,0)
 S @RARY@("consult")="8/3/2018"
"RTN","SAMIZPH1",602,0)
 S @RARY@("dob")="6/15/1948"
"RTN","SAMIZPH1",603,0)
 S @RARY@("educ_level")=""
"RTN","SAMIZPH1",604,0)
 S @RARY@("elig_enroll")=1
"RTN","SAMIZPH1",605,0)
 S @RARY@("environ_exp___1")=0
"RTN","SAMIZPH1",606,0)
 S @RARY@("environ_exp___2")=0
"RTN","SAMIZPH1",607,0)
 S @RARY@("environ_exp___3")=0
"RTN","SAMIZPH1",608,0)
 S @RARY@("environ_exp___4")=0
"RTN","SAMIZPH1",609,0)
 S @RARY@("ethnicity")=2
"RTN","SAMIZPH1",610,0)
 S @RARY@("failed_enroll")=""
"RTN","SAMIZPH1",611,0)
 S @RARY@("failed_other")=""
"RTN","SAMIZPH1",612,0)
 S @RARY@("fam_hx")=1
"RTN","SAMIZPH1",613,0)
 S @RARY@("first_name")="Mac5"
"RTN","SAMIZPH1",614,0)
 S @RARY@("gender")=1
"RTN","SAMIZPH1",615,0)
 S @RARY@("height")=69
"RTN","SAMIZPH1",616,0)
 S @RARY@("imported_age")=70
"RTN","SAMIZPH1",617,0)
 S @RARY@("last_name")="McDonald"
"RTN","SAMIZPH1",618,0)
 S @RARY@("ldct_no_show_base")=""
"RTN","SAMIZPH1",619,0)
 S @RARY@("oth_enviorn_exp")=""
"RTN","SAMIZPH1",620,0)
 S @RARY@("other_referral_type")=""
"RTN","SAMIZPH1",621,0)
 S @RARY@("pack_years")=100
"RTN","SAMIZPH1",622,0)
 S @RARY@("patient_notes")="2s-pcp notified"
"RTN","SAMIZPH1",623,0)
 S @RARY@("pt_age")=72.1
"RTN","SAMIZPH1",624,0)
 S @RARY@("pt_pcp")="Keenan"
"RTN","SAMIZPH1",625,0)
 S @RARY@("quit_smoking")=""
"RTN","SAMIZPH1",626,0)
 S @RARY@("record_id")=1
"RTN","SAMIZPH1",627,0)
 S @RARY@("referral_type")=""
"RTN","SAMIZPH1",628,0)
 S @RARY@("rural")=0
"RTN","SAMIZPH1",629,0)
 S @RARY@("sdm___1")=1
"RTN","SAMIZPH1",630,0)
 S @RARY@("sdm___2")=0
"RTN","SAMIZPH1",631,0)
 S @RARY@("sdm___3")=0
"RTN","SAMIZPH1",632,0)
 S @RARY@("sdm_visit_date")="8/27/2018"
"RTN","SAMIZPH1",633,0)
 S @RARY@("smoked_years")=59
"RTN","SAMIZPH1",634,0)
 S @RARY@("smoking_cessation_not")="Declined smoking cessation support"
"RTN","SAMIZPH1",635,0)
 S @RARY@("smoking_history")=1
"RTN","SAMIZPH1",636,0)
 S @RARY@("smoking_per_day")=40
"RTN","SAMIZPH1",637,0)
 S @RARY@("ssn")=4958
"RTN","SAMIZPH1",638,0)
 S @RARY@("tobacco_cessation_referral")=2
"RTN","SAMIZPH1",639,0)
 S @RARY@("weight")=262
"RTN","SAMIZPH1",640,0)
 S @RARY@("year_quit")=""
"RTN","SAMIZPH1",641,0)
 q
"RTN","SAMIZPH1",642,0)
 ;
"VER")
8.0^22.2
**END**
**END**
