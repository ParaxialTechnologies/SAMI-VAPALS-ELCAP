KIDS Distribution saved on Jan 21, 2020@09:41:41
Creates notes from followup forms
**KIDS**:SAMI*18.0*1^

**INSTALL NAME**
SAMI*18.0*1
"BLD",11430,0)
SAMI*18.0*1^SAMI^0^3200121^y
"BLD",11430,4,0)
^9.64PA^^
"BLD",11430,6.3)
1
"BLD",11430,"KRN",0)
^9.67PA^1.5^24
"BLD",11430,"KRN",.4,0)
.4
"BLD",11430,"KRN",.401,0)
.401
"BLD",11430,"KRN",.402,0)
.402
"BLD",11430,"KRN",.403,0)
.403
"BLD",11430,"KRN",.5,0)
.5
"BLD",11430,"KRN",.84,0)
.84
"BLD",11430,"KRN",1.5,0)
1.5
"BLD",11430,"KRN",1.6,0)
1.6
"BLD",11430,"KRN",1.61,0)
1.61
"BLD",11430,"KRN",1.62,0)
1.62
"BLD",11430,"KRN",3.6,0)
3.6
"BLD",11430,"KRN",3.8,0)
3.8
"BLD",11430,"KRN",9.2,0)
9.2
"BLD",11430,"KRN",9.8,0)
9.8
"BLD",11430,"KRN",9.8,"NM",0)
^9.68A^4^4
"BLD",11430,"KRN",9.8,"NM",1,0)
SAMICASE^^0^B4139384
"BLD",11430,"KRN",9.8,"NM",2,0)
SAMICAS2^^0^B331580525
"BLD",11430,"KRN",9.8,"NM",3,0)
SAMIHOM4^^0^B457477392
"BLD",11430,"KRN",9.8,"NM",4,0)
SAMINOT2^^0^B55754036
"BLD",11430,"KRN",9.8,"NM","B","SAMICAS2",2)

"BLD",11430,"KRN",9.8,"NM","B","SAMICASE",1)

"BLD",11430,"KRN",9.8,"NM","B","SAMIHOM4",3)

"BLD",11430,"KRN",9.8,"NM","B","SAMINOT2",4)

"BLD",11430,"KRN",19,0)
19
"BLD",11430,"KRN",19.1,0)
19.1
"BLD",11430,"KRN",101,0)
101
"BLD",11430,"KRN",409.61,0)
409.61
"BLD",11430,"KRN",771,0)
771
"BLD",11430,"KRN",779.2,0)
779.2
"BLD",11430,"KRN",870,0)
870
"BLD",11430,"KRN",8989.51,0)
8989.51
"BLD",11430,"KRN",8989.52,0)
8989.52
"BLD",11430,"KRN",8994,0)
8994
"BLD",11430,"KRN","B",.4,.4)

"BLD",11430,"KRN","B",.401,.401)

"BLD",11430,"KRN","B",.402,.402)

"BLD",11430,"KRN","B",.403,.403)

"BLD",11430,"KRN","B",.5,.5)

"BLD",11430,"KRN","B",.84,.84)

"BLD",11430,"KRN","B",1.5,1.5)

"BLD",11430,"KRN","B",1.6,1.6)

"BLD",11430,"KRN","B",1.61,1.61)

"BLD",11430,"KRN","B",1.62,1.62)

"BLD",11430,"KRN","B",3.6,3.6)

"BLD",11430,"KRN","B",3.8,3.8)

"BLD",11430,"KRN","B",9.2,9.2)

"BLD",11430,"KRN","B",9.8,9.8)

"BLD",11430,"KRN","B",19,19)

"BLD",11430,"KRN","B",19.1,19.1)

"BLD",11430,"KRN","B",101,101)

"BLD",11430,"KRN","B",409.61,409.61)

"BLD",11430,"KRN","B",771,771)

"BLD",11430,"KRN","B",779.2,779.2)

"BLD",11430,"KRN","B",870,870)

"BLD",11430,"KRN","B",8989.51,8989.51)

"BLD",11430,"KRN","B",8989.52,8989.52)

"BLD",11430,"KRN","B",8994,8994)

"MBREQ")
0
"PKG",230,-1)
1^1
"PKG",230,0)
SAMI^SAMI^SCREENING APPLICATIONS MANAGEMENT - IELCAP
"PKG",230,22,0)
^9.49I^1^1
"PKG",230,22,1,0)
18.0^3191203
"PKG",230,22,1,"PAH",1,0)
1^3200121
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
4
"RTN","SAMICAS2")
0^2^B331580525
"RTN","SAMICAS2",1,0)
SAMICAS2 ;ven/gpl - ielcap: case review page ; 2019-08-01T15:42Z
"RTN","SAMICAS2",2,0)
 ;;18.0;SAM;;;Build 1
"RTN","SAMICAS2",3,0)
 ;
"RTN","SAMICAS2",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMICAS2",5,0)
 ;
"RTN","SAMICAS2",6,0)
 ;@documentation : see SAMICUL
"RTN","SAMICAS2",7,0)
 ;
"RTN","SAMICAS2",8,0)
 ;@contents
"RTN","SAMICAS2",9,0)
 ; wsCASE: generate case review page
"RTN","SAMICAS2",10,0)
 ; $$GETDTKEY = date part of form key
"RTN","SAMICAS2",11,0)
 ; $$KEY2DSPD = date in elcap format from key date
"RTN","SAMICAS2",12,0)
 ; GETTMPL: return html template
"RTN","SAMICAS2",13,0)
 ; GETITEMS: get items available for studyid
"RTN","SAMICAS2",14,0)
 ;
"RTN","SAMICAS2",15,0)
 ; wsNuForm: select a new form for patient (get service)
"RTN","SAMICAS2",16,0)
 ; wsNuFormPost: post new form selection (post service)
"RTN","SAMICAS2",17,0)
 ; MKCEFORM: create ct evaluation form
"RTN","SAMICAS2",18,0)
 ;
"RTN","SAMICAS2",19,0)
 ; casetbl: generate case review table
"RTN","SAMICAS2",20,0)
 ;
"RTN","SAMICAS2",21,0)
 ;
"RTN","SAMICAS2",22,0)
 ;
"RTN","SAMICAS2",23,0)
 ;@section 1 wsCASE & related ppis
"RTN","SAMICAS2",24,0)
 ;
"RTN","SAMICAS2",25,0)
 ;
"RTN","SAMICAS2",26,0)
 ;@ppi - generate case review page
"RTN","SAMICAS2",27,0)
WSCASE ; generate case review page
"RTN","SAMICAS2",28,0)
 ;
"RTN","SAMICAS2",29,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",30,0)
 ;
"RTN","SAMICAS2",31,0)
 ;ven/gpl;web service;procedure;
"RTN","SAMICAS2",32,0)
 ;@web service
"RTN","SAMICAS2",33,0)
 ; SAMICASE-wsCASE
"RTN","SAMICAS2",34,0)
 ;@called by :
"RTN","SAMICAS2",35,0)
 ; WSCASE^SAMICASE
"RTN","SAMICAS2",36,0)
 ; _wfhform
"RTN","SAMICAS2",37,0)
 ; %wfhform
"RTN","SAMICAS2",38,0)
 ;@calls :
"RTN","SAMICAS2",39,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",40,0)
 ; GETTMPL^SAMICAS2
"RTN","SAMICAS2",41,0)
 ; GETITEMS^SAMICASE
"RTN","SAMICAS2",42,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS2",43,0)
 ; findReplace^%ts
"RTN","SAMICAS2",44,0)
 ; FIXHREF^SAMIFORM
"RTN","SAMICAS2",45,0)
 ; FIXSRC^SAMIFORM
"RTN","SAMICAS2",46,0)
 ; $$GETDTKEY^SAMICAS2
"RTN","SAMICAS2",47,0)
 ; $$KEY2DSPD^SAMICAS2
"RTN","SAMICAS2",48,0)
 ; $$GETLAST5^SAMIFORM
"RTN","SAMICAS2",49,0)
 ; $$GETSSN^SAMIFORM
"RTN","SAMICAS2",50,0)
 ; $$GETNAME^SAMIFORM
"RTN","SAMICAS2",51,0)
 ; $$GSAMISTA^SAMICAS2
"RTN","SAMICAS2",52,0)
 ; D ADDCRLF^VPRJRUT
"RTN","SAMICAS2",53,0)
 ;@input :
"RTN","SAMICAS2",54,0)
 ; .filter =
"RTN","SAMICAS2",55,0)
 ; .filter("studyid")=studyid of the patient
"RTN","SAMICAS2",56,0)
 ;@output :
"RTN","SAMICAS2",57,0)
 ; .rtn
"RTN","SAMICAS2",58,0)
 ;@tests :
"RTN","SAMICAS2",59,0)
 ; SAMIUTS2
"RTN","SAMICAS2",60,0)
 ;
"RTN","SAMICAS2",61,0)
 ;@stanza 2 initialize
"RTN","SAMICAS2",62,0)
 ;
"RTN","SAMICAS2",63,0)
 kill rtn
"RTN","SAMICAS2",64,0)
 ;
"RTN","SAMICAS2",65,0)
 new groot set groot=$$setroot^%wd("vapals-patients") ; root of patient graphs
"RTN","SAMICAS2",66,0)
 ;
"RTN","SAMICAS2",67,0)
 new temp ; html template
"RTN","SAMICAS2",68,0)
 do GETTMPL^SAMICASE("temp","vapals:casereview")
"RTN","SAMICAS2",69,0)
 quit:'$data(temp)
"RTN","SAMICAS2",70,0)
 ;
"RTN","SAMICAS2",71,0)
 new sid set sid=$get(filter("studyid"))
"RTN","SAMICAS2",72,0)
 if sid="" set sid=$get(filter("studyId"))
"RTN","SAMICAS2",73,0)
 if sid="" set sid=$get(filter("fvalue"))
"RTN","SAMICAS2",74,0)
 quit:sid=""
"RTN","SAMICAS2",75,0)
 ;
"RTN","SAMICAS2",76,0)
 new items
"RTN","SAMICAS2",77,0)
 do GETITEMS^SAMICASE("items",sid)
"RTN","SAMICAS2",78,0)
 quit:'$data(items)
"RTN","SAMICAS2",79,0)
 ;
"RTN","SAMICAS2",80,0)
 new gien set gien=$$SID2NUM^SAMIHOM3(sid) ; graph ien
"RTN","SAMICAS2",81,0)
 new name set name=$get(@groot@(gien,"saminame"))
"RTN","SAMICAS2",82,0)
 quit:name=""
"RTN","SAMICAS2",83,0)
 new fname set fname=$piece(name,",",2)
"RTN","SAMICAS2",84,0)
 new lname set lname=$piece(name,",")
"RTN","SAMICAS2",85,0)
 ;
"RTN","SAMICAS2",86,0)
 ;@stanza 3 change resource paths to /see/
"RTN","SAMICAS2",87,0)
 ;
"RTN","SAMICAS2",88,0)
 new cnt set cnt=0
"RTN","SAMICAS2",89,0)
 new zi set zi=0
"RTN","SAMICAS2",90,0)
 ;for  set zi=$order(temp(zi)) quit:+zi=0  quit:temp(zi)["VEP0001"  do  ;
"RTN","SAMICAS2",91,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  quit:temp(zi)["tbody"  do  ;
"RTN","SAMICAS2",92,0)
 . new ln set ln=temp(zi)
"RTN","SAMICAS2",93,0)
 . new touched set touched=0
"RTN","SAMICAS2",94,0)
 . ;
"RTN","SAMICAS2",95,0)
 . if ln["id" if ln["studyIdMenu" do  ;
"RTN","SAMICAS2",96,0)
 . . set zi=zi+4
"RTN","SAMICAS2",97,0)
 . ;
"RTN","SAMICAS2",98,0)
 . if ln["home.html" do  ;
"RTN","SAMICAS2",99,0)
 . . do findReplace^%ts(.ln,"home.html","/vapals")
"RTN","SAMICAS2",100,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",101,0)
 . . set touched=1
"RTN","SAMICAS2",102,0)
 . ;
"RTN","SAMICAS2",103,0)
 . if ln["href" if 'touched do  ;
"RTN","SAMICAS2",104,0)
 . . do FIXHREF^SAMIFORM(.ln)
"RTN","SAMICAS2",105,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",106,0)
 . ;
"RTN","SAMICAS2",107,0)
 . if ln["src" do  ;
"RTN","SAMICAS2",108,0)
 . . do FIXSRC^SAMIFORM(.ln)
"RTN","SAMICAS2",109,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",110,0)
 . ;
"RTN","SAMICAS2",111,0)
 . set cnt=cnt+1
"RTN","SAMICAS2",112,0)
 . set rtn(cnt)=temp(zi)
"RTN","SAMICAS2",113,0)
 . quit
"RTN","SAMICAS2",114,0)
 ;
"RTN","SAMICAS2",115,0)
 ; ready to insert rows for selection
"RTN","SAMICAS2",116,0)
 ;
"RTN","SAMICAS2",117,0)
 ;@stanza 4 intake form
"RTN","SAMICAS2",118,0)
 ;
"RTN","SAMICAS2",119,0)
 new sikey set sikey=$order(items("sifor"))
"RTN","SAMICAS2",120,0)
 if sikey="" set sikey="siform-2017-12-10"
"RTN","SAMICAS2",121,0)
 new sidate set sidate=$$GETDTKEY(sikey)
"RTN","SAMICAS2",122,0)
 set sikey="vapals:"_sikey
"RTN","SAMICAS2",123,0)
 new sidispdate set sidispdate=$$KEY2DSPD(sidate)
"RTN","SAMICAS2",124,0)
 ;new geturl set geturl="/form?form=vapals:siform&studyid="_sid_"&key="_sikey
"RTN","SAMICAS2",125,0)
 new nuhref set nuhref="<form method=POST action=""/vapals"">"
"RTN","SAMICAS2",126,0)
 set nuhref=nuhref_"<td><input type=hidden name=""samiroute"" value=""nuform"">"
"RTN","SAMICAS2",127,0)
 set nuhref=nuhref_"<input type=hidden name=""studyid"" value="_sid_">"
"RTN","SAMICAS2",128,0)
 set nuhref=nuhref_"<input value=""New Form"" class=""btn label label-warning"" role=""link"" type=""submit""></form></td>"
"RTN","SAMICAS2",129,0)
 ; new intake notes table
"RTN","SAMICAS2",130,0)
 n notehref,form
"RTN","SAMICAS2",131,0)
 set form=$p(sikey,":",2)
"RTN","SAMICAS2",132,0)
 set notehref=$$NOTEHREF^SAMICASE(sid,form) ; table of notes
"RTN","SAMICAS2",133,0)
 set cnt=cnt+1
"RTN","SAMICAS2",134,0)
 new facilitycode set facilitycode=$$GETPRFX^SAMIFORM()
"RTN","SAMICAS2",135,0)
 new last5 set last5=$$GETLAST5^SAMIFORM(sid)
"RTN","SAMICAS2",136,0)
 new pssn set pssn=$$GETSSN^SAMIFORM(sid)
"RTN","SAMICAS2",137,0)
 new pname set pname=$$GETNAME^SAMIFORM(sid)
"RTN","SAMICAS2",138,0)
 new useid set useid=pssn
"RTN","SAMICAS2",139,0)
 if useid="" set useid=last5
"RTN","SAMICAS2",140,0)
 set rtn(cnt)="<tr><td> "_useid_" </td><td> "_pname_" </td><td> "_facilitycode_" </td><td>"_sidispdate_"</td><td>"_$char(13)
"RTN","SAMICAS2",141,0)
 set cnt=cnt+1
"RTN","SAMICAS2",142,0)
 set rtn(cnt)="<form method=""post"" action=""/vapals"">"
"RTN","SAMICAS2",143,0)
 set cnt=cnt+1
"RTN","SAMICAS2",144,0)
 set rtn(cnt)="<input name=""samiroute"" value=""form"" type=""hidden"">"
"RTN","SAMICAS2",145,0)
 set rtn(cnt)=rtn(cnt)_" <input name=""studyid"" value="""_sid_""" type=""hidden"">"
"RTN","SAMICAS2",146,0)
 set rtn(cnt)=rtn(cnt)_" <input name=""form"" value="""_sikey_""" type=""hidden"">"
"RTN","SAMICAS2",147,0)
 set rtn(cnt)=rtn(cnt)_" <input value=""Intake"" class=""btn btn-link"" role=""link"" type=""submit"">"
"RTN","SAMICAS2",148,0)
 ;
"RTN","SAMICAS2",149,0)
 new samistatus set samistatus=""
"RTN","SAMICAS2",150,0)
 if $$GSAMISTA(sid,sikey)="incomplete" set samistatus="(incomplete)"
"RTN","SAMICAS2",151,0)
 set cnt=cnt+1
"RTN","SAMICAS2",152,0)
 set rtn(cnt)="</form>"_samistatus_notehref_"</td>"_$char(13)
"RTN","SAMICAS2",153,0)
 set cnt=cnt+1
"RTN","SAMICAS2",154,0)
 set rtn(cnt)=nuhref_"</tr>"
"RTN","SAMICAS2",155,0)
 ;
"RTN","SAMICAS2",156,0)
 ;@stanza 6 rest of the forms
"RTN","SAMICAS2",157,0)
 ;
"RTN","SAMICAS2",158,0)
 new zj set zj="" ; each of the rest of the forms
"RTN","SAMICAS2",159,0)
 if $data(items("sort")) do  ; we have more forms
"RTN","SAMICAS2",160,0)
 . for  set zj=$order(items("sort",zj)) quit:zj=""  do  ;
"RTN","SAMICAS2",161,0)
 . . new cdate set cdate=zj
"RTN","SAMICAS2",162,0)
 . . new zk set zk=""
"RTN","SAMICAS2",163,0)
 . . for  set zk=$order(items("sort",cdate,zk)) q:zk=""  do  ;
"RTN","SAMICAS2",164,0)
 . . . new zform set zform=zk
"RTN","SAMICAS2",165,0)
 . . . new zkey set zkey=$order(items("sort",cdate,zform,""))
"RTN","SAMICAS2",166,0)
 . . . new zname set zname=$order(items("sort",cdate,zform,zkey,""))
"RTN","SAMICAS2",167,0)
 . . . new dispdate set dispdate=$$KEY2DSPD(cdate)
"RTN","SAMICAS2",168,0)
 . . . set zform="vapals:"_zkey ; all the new forms are vapals:key
"RTN","SAMICAS2",169,0)
 . . . ;new geturl set geturl="/form?form="_zform_"&studyid="_sid_"&key="_zkey
"RTN","SAMICAS2",170,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",171,0)
 . . . ;set rtn(cnt)="<tr><td> "_sid_" </td><td> - </td><td> - </td><td> - </td><td>"_dispdate_"</td><td>"
"RTN","SAMICAS2",172,0)
 . . . set rtn(cnt)="<tr><td> "_useid_" </td><td> - </td><td> - </td><td>"_dispdate_"</td><td>"
"RTN","SAMICAS2",173,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",174,0)
 . . . set rtn(cnt)="<form method=""post"" action=""/vapals"">"_$char(13)
"RTN","SAMICAS2",175,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",176,0)
 . . . set rtn(cnt)="<input name=""samiroute"" value=""form"" type=""hidden"">"_$char(13)
"RTN","SAMICAS2",177,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",178,0)
 . . . set rtn(cnt)=" <input name=""studyid"" value="""_sid_""" type=""hidden"">"_$char(13)
"RTN","SAMICAS2",179,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",180,0)
 . . . set rtn(cnt)=" <input name=""form"" value="""_zform_""" type=""hidden"">"_$char(13)
"RTN","SAMICAS2",181,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",182,0)
 . . . set rtn(cnt)=" <input value="""_zname_""" class=""btn btn-link"" role=""link"" type=""submit"">"_$char(13)
"RTN","SAMICAS2",183,0)
 . . . ;
"RTN","SAMICAS2",184,0)
 . . . new samistatus set samistatus=""
"RTN","SAMICAS2",185,0)
 . . . if $$GSAMISTA(sid,zform)="incomplete" set samistatus="(incomplete)"
"RTN","SAMICAS2",186,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",187,0)
 . . . set rtn(cnt)="</form>"_samistatus_$$NOTEHREF^SAMICASE(sid,zkey)_"</td>"
"RTN","SAMICAS2",188,0)
 . . . set cnt=cnt+1
"RTN","SAMICAS2",189,0)
 . . . if zform["ceform" do  ;
"RTN","SAMICAS2",190,0)
 . . . . new rpthref set rpthref="<form method=POST action=""/vapals"">"
"RTN","SAMICAS2",191,0)
 . . . . set rpthref=rpthref_"<td><input type=hidden name=""samiroute"" value=""ctreport"">"
"RTN","SAMICAS2",192,0)
 . . . . set rpthref=rpthref_"<input type=hidden name=""form"" value="_$p(zform,":",2)_">"
"RTN","SAMICAS2",193,0)
 . . . . set rpthref=rpthref_"<input type=hidden name=""studyid"" value="_sid_">"
"RTN","SAMICAS2",194,0)
 . . . . set rpthref=rpthref_"<input value=""Report"" class=""btn label label-warning"" role=""link"" type=""submit""></form></td>"
"RTN","SAMICAS2",195,0)
 . . . . set rtn(cnt)=rpthref_"</tr>"
"RTN","SAMICAS2",196,0)
 . . . . ;set rtn(cnt)="</tr>" ; turn off report
"RTN","SAMICAS2",197,0)
 . . . else  set rtn(cnt)="<td></td></tr>"
"RTN","SAMICAS2",198,0)
 . . . quit
"RTN","SAMICAS2",199,0)
 . . quit
"RTN","SAMICAS2",200,0)
 . quit
"RTN","SAMICAS2",201,0)
 ;
"RTN","SAMICAS2",202,0)
 ;
"RTN","SAMICAS2",203,0)
 ;@stanza 7 skip ahead in template to tbody
"RTN","SAMICAS2",204,0)
 ;
"RTN","SAMICAS2",205,0)
 new loc set loc=zi+1
"RTN","SAMICAS2",206,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  quit:temp(zi)["/tbody"  do  ;
"RTN","SAMICAS2",207,0)
 . set x=$get(x)
"RTN","SAMICAS2",208,0)
 . quit
"RTN","SAMICAS2",209,0)
 set zi=zi-1
"RTN","SAMICAS2",210,0)
 ;
"RTN","SAMICAS2",211,0)
 ;@stanza 8 rest of lines
"RTN","SAMICAS2",212,0)
 ;
"RTN","SAMICAS2",213,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMICAS2",214,0)
 . new line
"RTN","SAMICAS2",215,0)
 . set line=temp(zi)
"RTN","SAMICAS2",216,0)
 . if line["XX0002" do  ;
"RTN","SAMICAS2",217,0)
 . . do findReplace^%ts(.line,"XX0002",sid)
"RTN","SAMICAS2",218,0)
 . ;
"RTN","SAMICAS2",219,0)
 . if line["@@ERROR_MESSAGE@@" do ;
"RTN","SAMICAS2",220,0)
 . . n zerr
"RTN","SAMICAS2",221,0)
 . . k ^gpl("error")
"RTN","SAMICAS2",222,0)
 . . m ^gpl("error")=filter
"RTN","SAMICAS2",223,0)
 . . s zerr=$g(filter("errorMessage"))
"RTN","SAMICAS2",224,0)
 . . ;i err="" q  ;
"RTN","SAMICAS2",225,0)
 . . s ^gpl("error","zerr")=zerr
"RTN","SAMICAS2",226,0)
 . . do findReplace^%ts(.line,"@@ERROR_MESSAGE@@",zerr)
"RTN","SAMICAS2",227,0)
 . . s ^gpl("error","newline")=line
"RTN","SAMICAS2",228,0)
 . set cnt=cnt+1
"RTN","SAMICAS2",229,0)
 . set rtn(cnt)=line
"RTN","SAMICAS2",230,0)
 . quit
"RTN","SAMICAS2",231,0)
 ;
"RTN","SAMICAS2",232,0)
 do ADDCRLF^VPRJRUT(.rtn)
"RTN","SAMICAS2",233,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMICAS2",234,0)
 ;
"RTN","SAMICAS2",235,0)
 ;@stanza 9 termination
"RTN","SAMICAS2",236,0)
 ;
"RTN","SAMICAS2",237,0)
 quit  ; end of wsCASE
"RTN","SAMICAS2",238,0)
 ;
"RTN","SAMICAS2",239,0)
 ;@ppi NOTHREF
"RTN","SAMICAS2",240,0)
NOTEHREF ; extrinsic returns html for the list of notes for the form
"RTN","SAMICAS2",241,0)
 n notehref,ntlist
"RTN","SAMICAS2",242,0)
 s notehref=""
"RTN","SAMICAS2",243,0)
 i form["sifor" d NTLIST^SAMINOT1("ntlist",sid,form)
"RTN","SAMICAS2",244,0)
 i form["fufor" d NTLIST^SAMINOT2("ntlist",sid,form)
"RTN","SAMICAS2",245,0)
 i $o(ntlist(""))="" q notehref
"RTN","SAMICAS2",246,0)
 set notehref="<table>"
"RTN","SAMICAS2",247,0)
 n zi
"RTN","SAMICAS2",248,0)
 s zi=0
"RTN","SAMICAS2",249,0)
 f  s zi=$o(ntlist(zi)) q:+zi=0  d  ;
"RTN","SAMICAS2",250,0)
 . set notehref=notehref_"<td><form method=POST action=""/vapals"">"
"RTN","SAMICAS2",251,0)
 . set notehref=notehref_"<input type=hidden name=""nien"" value="""_$g(ntlist(zi,"nien"))_""">"
"RTN","SAMICAS2",252,0)
 . set notehref=notehref_"<input type=hidden name=""samiroute"" value=""note"">"
"RTN","SAMICAS2",253,0)
 . set notehref=notehref_"<input type=hidden name=""studyid"" value="_sid_">"
"RTN","SAMICAS2",254,0)
 . set notehref=notehref_"<input type=hidden name=""form"" value="_form_">"
"RTN","SAMICAS2",255,0)
 . set notehref=notehref_"<input value="""_$g(ntlist(zi,"name"))_""" class=""btn btn-link"" role=""link"" type=""submit""></form></td></tr>"
"RTN","SAMICAS2",256,0)
 set notehref=notehref_"</table>"
"RTN","SAMICAS2",257,0)
 q notehref
"RTN","SAMICAS2",258,0)
 ;
"RTN","SAMICAS2",259,0)
 ;@ppi - get html template
"RTN","SAMICAS2",260,0)
GETTMPL ; get html template
"RTN","SAMICAS2",261,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",262,0)
 ;
"RTN","SAMICAS2",263,0)
 ;ven/gpl;private;procedure;
"RTN","SAMICAS2",264,0)
 ;@called-by
"RTN","SAMICAS2",265,0)
 ; GETTMPL^SAMICASE
"RTN","SAMICAS2",266,0)
 ;@calls
"RTN","SAMICAS2",267,0)
 ; $$getTemplate^%wf
"RTN","SAMICAS2",268,0)
 ; getThis^%wd
"RTN","SAMICAS2",269,0)
 ;@input
"RTN","SAMICAS2",270,0)
 ; return = name of array to return template in
"RTN","SAMICAS2",271,0)
 ; form = name of form
"RTN","SAMICAS2",272,0)
 ;@output
"RTN","SAMICAS2",273,0)
 ; @return = template
"RTN","SAMICAS2",274,0)
 ;@examples [tbd]
"RTN","SAMICAS2",275,0)
 ;@tests [tbd]
"RTN","SAMICAS2",276,0)
 ;
"RTN","SAMICAS2",277,0)
 ;@stanza 2 get html template
"RTN","SAMICAS2",278,0)
 ;
"RTN","SAMICAS2",279,0)
 quit:$get(form)=""
"RTN","SAMICAS2",280,0)
 ;
"RTN","SAMICAS2",281,0)
 new fn set fn=$$getTemplate^%wf(form)
"RTN","SAMICAS2",282,0)
 do getThis^%wd(return,fn)
"RTN","SAMICAS2",283,0)
 ;
"RTN","SAMICAS2",284,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMICAS2",285,0)
 ;
"RTN","SAMICAS2",286,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",287,0)
 ;
"RTN","SAMICAS2",288,0)
 quit  ; end of GETTMPL
"RTN","SAMICAS2",289,0)
 ;
"RTN","SAMICAS2",290,0)
 ;
"RTN","SAMICAS2",291,0)
CNTITEMS(sid) ; extrinsic returns how many forms the patient has
"RTN","SAMICAS2",292,0)
 ; used before deleting a patient
"RTN","SAMICAS2",293,0)
 ;@called by : none
"RTN","SAMICAS2",294,0)
 ;@calls :
"RTN","SAMICAS2",295,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",296,0)
 ;@input ;
"RTN","SAMICAS2",297,0)
 ; sid = patient's study ID (e.g. "XXX00001")
"RTN","SAMICAS2",298,0)
 ;@output ;
"RTN","SAMICAS2",299,0)
 ;@tests :
"RTN","SAMICAS2",300,0)
 ; SAMIUTS2
"RTN","SAMICAS2",301,0)
 new groot set groot=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",302,0)
 quit:'$data(@groot@("graph",sid)) 0  ; nothing there
"RTN","SAMICAS2",303,0)
 new cnt,zi
"RTN","SAMICAS2",304,0)
 set zi=""
"RTN","SAMICAS2",305,0)
 set cnt=0
"RTN","SAMICAS2",306,0)
 for  set zi=$o(@groot@("graph",sid,zi)) quit:zi=""  do  ;
"RTN","SAMICAS2",307,0)
 . set cnt=cnt+1
"RTN","SAMICAS2",308,0)
 quit cnt
"RTN","SAMICAS2",309,0)
 ;
"RTN","SAMICAS2",310,0)
 ;@ppi - get items available for studyid
"RTN","SAMICAS2",311,0)
GETITEMS ; get items available for studyid
"RTN","SAMICAS2",312,0)
 ;
"RTN","SAMICAS2",313,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",314,0)
 ;
"RTN","SAMICAS2",315,0)
 ;ven/gpl;private;procedure;
"RTN","SAMICAS2",316,0)
 ;@called by
"RTN","SAMICAS2",317,0)
 ; GETITEMS^SAMICASE
"RTN","SAMICAS2",318,0)
 ;@calls
"RTN","SAMICAS2",319,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",320,0)
 ;@input
"RTN","SAMICAS2",321,0)
 ; @ary = returned items available
"RTN","SAMICAS2",322,0)
 ; sid = patient's study ID (e.g. "XXX00001")
"RTN","SAMICAS2",323,0)
 ;@output
"RTN","SAMICAS2",324,0)
 ;@tests
"RTN","SAMICAS2",325,0)
 ; SAMIUTS2
"RTN","SAMICAS2",326,0)
 ;
"RTN","SAMICAS2",327,0)
 ;@stanza 2 get items
"RTN","SAMICAS2",328,0)
 ;
"RTN","SAMICAS2",329,0)
 new groot set groot=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",330,0)
 quit:'$data(@groot@("graph",sid))  ; nothing there
"RTN","SAMICAS2",331,0)
 ;
"RTN","SAMICAS2",332,0)
 kill @ary
"RTN","SAMICAS2",333,0)
 new zi set zi=""
"RTN","SAMICAS2",334,0)
 for  set zi=$order(@groot@("graph",sid,zi)) quit:zi=""  do  ;
"RTN","SAMICAS2",335,0)
 . set @ary@(zi)=""
"RTN","SAMICAS2",336,0)
 . quit
"RTN","SAMICAS2",337,0)
 ;
"RTN","SAMICAS2",338,0)
 ;@stanza 3 get rest of forms (many-to-one, get dates)
"RTN","SAMICAS2",339,0)
 ;
"RTN","SAMICAS2",340,0)
 new tary
"RTN","SAMICAS2",341,0)
 for  set zi=$order(@ary@(zi)) quit:zi=""  do  ;
"RTN","SAMICAS2",342,0)
 . new zkey1,zform set zkey1=$piece(zi,"-",1)
"RTN","SAMICAS2",343,0)
 . ;if zkey1="sbform" quit  ;
"RTN","SAMICAS2",344,0)
 . if zkey1="siform" quit  ;
"RTN","SAMICAS2",345,0)
 . new fname
"RTN","SAMICAS2",346,0)
 . if zkey1="ceform" set fname="CT Evaluation"
"RTN","SAMICAS2",347,0)
 . set zform=zkey1
"RTN","SAMICAS2",348,0)
 . if zkey1="sbform" set zform="vapals:sbform"
"RTN","SAMICAS2",349,0)
 . if zkey1="sbform" set fname="Background"
"RTN","SAMICAS2",350,0)
 . if zkey1="ceform" set zform="vapals:ceform"
"RTN","SAMICAS2",351,0)
 . if zkey1="fuform" set zform="vapals:fuform"
"RTN","SAMICAS2",352,0)
 . if zkey1="fuform" set fname="Follow-up"
"RTN","SAMICAS2",353,0)
 . if zkey1="bxform" set fname="Biopsy"
"RTN","SAMICAS2",354,0)
 . if zkey1="bxform" set zform="vapals:bxform"
"RTN","SAMICAS2",355,0)
 . if zkey1="ptform" set zform="vapals:ptform"
"RTN","SAMICAS2",356,0)
 . if zkey1="ptform" set fname="PET Evaluation"
"RTN","SAMICAS2",357,0)
 . if zkey1="itform" set zform="vapals:itform"
"RTN","SAMICAS2",358,0)
 . if zkey1="itform" set fname="Intervention"
"RTN","SAMICAS2",359,0)
 . if $get(fname)="" set fname="unknown"
"RTN","SAMICAS2",360,0)
 . new zdate set zdate=$extract(zi,$length(zkey1)+2,$length(zi))
"RTN","SAMICAS2",361,0)
 . quit:$get(zdate)=""
"RTN","SAMICAS2",362,0)
 . quit:$get(zform)=""
"RTN","SAMICAS2",363,0)
 . quit:$get(zi)=""
"RTN","SAMICAS2",364,0)
 . quit:$get(fname)=""
"RTN","SAMICAS2",365,0)
 . set tary("sort",zdate,zform,zi,fname)=""
"RTN","SAMICAS2",366,0)
 . set tary("type",zform,zi,fname)=""
"RTN","SAMICAS2",367,0)
 . quit
"RTN","SAMICAS2",368,0)
 merge @ary=tary
"RTN","SAMICAS2",369,0)
 ;
"RTN","SAMICAS2",370,0)
 ;@stanza 4 termination
"RTN","SAMICAS2",371,0)
 ;
"RTN","SAMICAS2",372,0)
 quit  ; end of GETITEMS
"RTN","SAMICAS2",373,0)
 ;
"RTN","SAMICAS2",374,0)
 ;
"RTN","SAMICAS2",375,0)
 ;
"RTN","SAMICAS2",376,0)
GETDTKEY(formid) ; date portion of form key
"RTN","SAMICAS2",377,0)
 ;
"RTN","SAMICAS2",378,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",379,0)
 ;
"RTN","SAMICAS2",380,0)
 ;ven/gpl;private;function;
"RTN","SAMICAS2",381,0)
 ;@called by
"RTN","SAMICAS2",382,0)
 ;  WSCASE^SAMICAS2
"RTN","SAMICAS2",383,0)
 ;@calls :
"RTN","SAMICAS2",384,0)
 ;@input
"RTN","SAMICAS2",385,0)
 ; formid form key
"RTN","SAMICAS2",386,0)
 ;@output
"RTN","SAMICAS2",387,0)
 ; date from form key
"RTN","SAMICAS2",388,0)
 ;@examples
"RTN","SAMICAS2",389,0)
 ; $$GETDTKEY("sbform-2018-02-26") = "2018-02-26"
"RTN","SAMICAS2",390,0)
 ;@tests :
"RTN","SAMICAS2",391,0)
 ; SAMIUTS2
"RTN","SAMICAS2",392,0)
 ;
"RTN","SAMICAS2",393,0)
 ;@stanza 2 calculate date from key
"RTN","SAMICAS2",394,0)
 ;
"RTN","SAMICAS2",395,0)
 new frm set frm=$piece(formid,"-")
"RTN","SAMICAS2",396,0)
 new date set date=$piece(formid,frm_"-",2)
"RTN","SAMICAS2",397,0)
 ;
"RTN","SAMICAS2",398,0)
 ;@stanza 3 return & termination
"RTN","SAMICAS2",399,0)
 ;
"RTN","SAMICAS2",400,0)
 quit date ; return date; end of $$GETDTKEY
"RTN","SAMICAS2",401,0)
 ;
"RTN","SAMICAS2",402,0)
 ;
"RTN","SAMICAS2",403,0)
 ;
"RTN","SAMICAS2",404,0)
KEY2DSPD(zkey) ; date in elcap format from key date
"RTN","SAMICAS2",405,0)
 ;
"RTN","SAMICAS2",406,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",407,0)
 ;
"RTN","SAMICAS2",408,0)
 ;ven/gpl;private;function;
"RTN","SAMICAS2",409,0)
 ;@called by
"RTN","SAMICAS2",410,0)
 ;  WSCASE^SAMICAS2
"RTN","SAMICAS2",411,0)
 ;@calls
"RTN","SAMICAS2",412,0)
 ; ^%DT
"RTN","SAMICAS2",413,0)
 ; $$FMTE^XLFDT
"RTN","SAMICAS2",414,0)
 ; $$VAPALSDT^SAMICAS2
"RTN","SAMICAS2",415,0)
 ;@input
"RTN","SAMICAS2",416,0)
 ; zkey = date in any format %DT can process
"RTN","SAMICAS2",417,0)
 ;@output
"RTN","SAMICAS2",418,0)
 ; date in elcap format
"RTN","SAMICAS2",419,0)
 ;@examples
"RTN","SAMICAS2",420,0)
 ; date 2018-02-26 => 26/Feb/2018
"RTN","SAMICAS2",421,0)
 ;@tests
"RTN","SAMICAS2",422,0)
 ; SAMIUTS2
"RTN","SAMICAS2",423,0)
 ;
"RTN","SAMICAS2",424,0)
 ;@stanza 2 convert date to elcap display format
"RTN","SAMICAS2",425,0)
 ;
"RTN","SAMICAS2",426,0)
 new X set X=zkey
"RTN","SAMICAS2",427,0)
 new Y
"RTN","SAMICAS2",428,0)
 do ^%DT
"RTN","SAMICAS2",429,0)
 ;new Z set Z=$$FMTE^XLFDT(Y,"9D")
"RTN","SAMICAS2",430,0)
 ;set Z=$translate(Z," ","/")
"RTN","SAMICAS2",431,0)
 new zdate
"RTN","SAMICAS2",432,0)
 set zdate=$$VAPALSDT^SAMICASE(Y)
"RTN","SAMICAS2",433,0)
 ;
"RTN","SAMICAS2",434,0)
 ;@stanza 3 return & termination
"RTN","SAMICAS2",435,0)
 ;
"RTN","SAMICAS2",436,0)
 quit zdate  ; return date; end of $$keysdispDate
"RTN","SAMICAS2",437,0)
 ;
"RTN","SAMICAS2",438,0)
 ;
"RTN","SAMICAS2",439,0)
 ;@ppi - extrinsic which return the vapals format for dates
"RTN","SAMICAS2",440,0)
VAPALSDT ; extrinsic which return the vapals format for dates
"RTN","SAMICAS2",441,0)
 ; fmdate is the date in fileman format
"RTN","SAMICAS2",442,0)
 ;@called by
"RTN","SAMICAS2",443,0)
 ; VAPALSDT^SAMICASE
"RTN","SAMICAS2",444,0)
 ;@calls
"RTN","SAMICAS2",445,0)
 ; $$FMTE^XLFDT
"RTN","SAMICAS2",446,0)
 ;@input
"RTN","SAMICAS2",447,0)
 ; fmdate = date in fileman format
"RTN","SAMICAS2",448,0)
 ;@output
"RTN","SAMICAS2",449,0)
 ; vapals date format
"RTN","SAMICAS2",450,0)
 ;@tests
"RTN","SAMICAS2",451,0)
 ; SAMIUTS2
"RTN","SAMICAS2",452,0)
 ;
"RTN","SAMICAS2",453,0)
 ;new Z set Z=$$FMTE^XLFDT(fmdate,"9D")
"RTN","SAMICAS2",454,0)
 ;set Z=$translate(Z," ","/")
"RTN","SAMICAS2",455,0)
 new Z set Z=$$FMTE^XLFDT(fmdate,"5D")
"RTN","SAMICAS2",456,0)
 quit Z
"RTN","SAMICAS2",457,0)
 ;
"RTN","SAMICAS2",458,0)
 ;@section 2 wsNuForm, wsNuFormPost, & related ppis
"RTN","SAMICAS2",459,0)
 ;
"RTN","SAMICAS2",460,0)
 ;
"RTN","SAMICAS2",461,0)
 ;
"RTN","SAMICAS2",462,0)
WSNUFORM ; select new form for patient (get service)
"RTN","SAMICAS2",463,0)
 ;
"RTN","SAMICAS2",464,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMICAS2",465,0)
 ;
"RTN","SAMICAS2",466,0)
 ;ven/gpl;web service;procedure;
"RTN","SAMICAS2",467,0)
 ;@called by
"RTN","SAMICAS2",468,0)
 ; WSNUFORM^SAMICASE
"RTN","SAMICAS2",469,0)
 ;@web service
"RTN","SAMICAS2",470,0)
 ;  SAMICASE-wsNuForm
"RTN","SAMICAS2",471,0)
 ;@calls
"RTN","SAMICAS2",472,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICAS2",473,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",474,0)
 ; GETTMPL^SAMICAS2
"RTN","SAMICAS2",475,0)
 ; findReplace^%ts
"RTN","SAMICAS2",476,0)
 ; FIXHREF^SAMIFORM
"RTN","SAMICAS2",477,0)
 ; FIXSRC^SAMIFORM
"RTN","SAMICAS2",478,0)
 ; findReplace^%ts
"RTN","SAMICAS2",479,0)
 ;@input
"RTN","SAMICAS2",480,0)
 ; .filter =
"RTN","SAMICAS2",481,0)
 ; .filter("studyid")=studyid of the patient
"RTN","SAMICAS2",482,0)
 ;@output
"RTN","SAMICAS2",483,0)
 ; @rtn
"RTN","SAMICAS2",484,0)
 ;@tests
"RTN","SAMICAS2",485,0)
 ; SAMIUTS
"RTN","SAMICAS2",486,0)
 ;
"RTN","SAMICAS2",487,0)
 ;@stanza 2 get select-new-form form
"RTN","SAMICAS2",488,0)
 ;
"RTN","SAMICAS2",489,0)
 new sid set sid=$get(filter("studyid"))
"RTN","SAMICAS2",490,0)
 quit:sid=""
"RTN","SAMICAS2",491,0)
 new sien set sien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICAS2",492,0)
 quit:+sien=0
"RTN","SAMICAS2",493,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",494,0)
 new groot set groot=$name(@root@(sien))
"RTN","SAMICAS2",495,0)
 ;
"RTN","SAMICAS2",496,0)
 new saminame set saminame=$get(@groot@("saminame"))
"RTN","SAMICAS2",497,0)
 quit:saminame=""
"RTN","SAMICAS2",498,0)
 ;
"RTN","SAMICAS2",499,0)
 new temp,tout,form
"RTN","SAMICAS2",500,0)
 set return="temp",form="vapals:nuform"
"RTN","SAMICAS2",501,0)
 do GETTMPL
"RTN","SAMICAS2",502,0)
 quit:'$data(temp)
"RTN","SAMICAS2",503,0)
 ;
"RTN","SAMICAS2",504,0)
 new cnt set cnt=0
"RTN","SAMICAS2",505,0)
 new zi set zi=0
"RTN","SAMICAS2",506,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMICAS2",507,0)
 . new ln set ln=temp(zi)
"RTN","SAMICAS2",508,0)
 . new touched set touched=0
"RTN","SAMICAS2",509,0)
 . ;
"RTN","SAMICAS2",510,0)
 . ;if ln["id" if ln["studyIdMenu" do  ;
"RTN","SAMICAS2",511,0)
 . ;. set zi=zi+4
"RTN","SAMICAS2",512,0)
 . ;
"RTN","SAMICAS2",513,0)
 . ;if ln["home.html" do  ;
"RTN","SAMICAS2",514,0)
 . ;. do findReplace^%ts(.ln,"home.html","/vapals")
"RTN","SAMICAS2",515,0)
 . ;. set temp(zi)=ln
"RTN","SAMICAS2",516,0)
 . ;. set touched=1
"RTN","SAMICAS2",517,0)
 . ;
"RTN","SAMICAS2",518,0)
 . if ln["href" if 'touched do  ;
"RTN","SAMICAS2",519,0)
 . . do FIXHREF^SAMIFORM(.ln)
"RTN","SAMICAS2",520,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",521,0)
 . ;
"RTN","SAMICAS2",522,0)
 . if ln["src" d  ;
"RTN","SAMICAS2",523,0)
 . . do FIXSRC^SAMIFORM(.ln)
"RTN","SAMICAS2",524,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",525,0)
 . ;
"RTN","SAMICAS2",526,0)
 . ;if ln["form" if ln["todo" do  ;
"RTN","SAMICAS2",527,0)
 . ;. do findReplace^%ts(.ln,"todo","/vapals")
"RTN","SAMICAS2",528,0)
 . ;. set cnt=cnt+1
"RTN","SAMICAS2",529,0)
 . ;. set rtn(cnt)=ln
"RTN","SAMICAS2",530,0)
 . ;. set cnt=cnt+1
"RTN","SAMICAS2",531,0)
 . ;. set rtn(cnt)="<input type=hidden name=""samiroute"" value=""addform"">"
"RTN","SAMICAS2",532,0)
 . ;. set cnt=cnt+1
"RTN","SAMICAS2",533,0)
 . ;. set rtn(cnt)="<input type=hidden name=""sid"" value="_sid_">"
"RTN","SAMICAS2",534,0)
 . ;. set zi=zi+1
"RTN","SAMICAS2",535,0)
 . ;
"RTN","SAMICAS2",536,0)
 . ;if ln["background" set temp(zi)=""
"RTN","SAMICAS2",537,0)
 . ;if ln["background" do  ;
"RTN","SAMICAS2",538,0)
 . ;. do findReplace^%ts(.ln,"background","sbform")
"RTN","SAMICAS2",539,0)
 . ;. set temp(zi)=ln
"RTN","SAMICAS2",540,0)
 . ;if ln["followup" do  ;
"RTN","SAMICAS2",541,0)
 . ;. do findReplace^%ts(.ln,"followup","fuform")
"RTN","SAMICAS2",542,0)
 . ;. set temp(zi)=ln
"RTN","SAMICAS2",543,0)
 . ;if ln["pet" do  ;
"RTN","SAMICAS2",544,0)
 . ;. do findReplace^%ts(.ln,"pet","ptform")
"RTN","SAMICAS2",545,0)
 . ;. set temp(zi)=ln
"RTN","SAMICAS2",546,0)
 . ;if ln["ctevaluation" do ;
"RTN","SAMICAS2",547,0)
 . ;. do findReplace^%ts(.ln,"ctevaluation","ceform")
"RTN","SAMICAS2",548,0)
 . ;. set temp(zi)=ln
"RTN","SAMICAS2",549,0)
 . ;if ln["biopsy" do  ;
"RTN","SAMICAS2",550,0)
 . ;. do findReplace^%ts(.ln,"biopsy","bxform")
"RTN","SAMICAS2",551,0)
 . ;. set temp(zi)=ln
"RTN","SAMICAS2",552,0)
 . ;if ln["newform" do  ;
"RTN","SAMICAS2",553,0)
 . ;. set temp(zi)=""
"RTN","SAMICAS2",554,0)
 . ;. set temp(zi+1)=""
"RTN","SAMICAS2",555,0)
 . ;
"RTN","SAMICAS2",556,0)
 . if ln["@@SID@@" do  ;
"RTN","SAMICAS2",557,0)
 . . do findReplace^%ts(.ln,"@@SID@@",sid)
"RTN","SAMICAS2",558,0)
 . . set temp(zi)=ln
"RTN","SAMICAS2",559,0)
 . . quit
"RTN","SAMICAS2",560,0)
 . ;
"RTN","SAMICAS2",561,0)
 . ;if ln["<script" if temp(zi+1)["function" do  ;
"RTN","SAMICAS2",562,0)
 . ;. set zi=$$SCANFOR^SAMIHOM3(.temp,zi,"</script")
"RTN","SAMICAS2",563,0)
 . ;. set zi=zi+1
"RTN","SAMICAS2",564,0)
 . ;
"RTN","SAMICAS2",565,0)
 . set cnt=cnt+1
"RTN","SAMICAS2",566,0)
 . set rtn(cnt)=temp(zi)
"RTN","SAMICAS2",567,0)
 ;
"RTN","SAMICAS2",568,0)
 ;merge tout=rtn
"RTN","SAMICAS2",569,0)
 ;do ADDCRLF^VPRJRUT(.tout)
"RTN","SAMICAS2",570,0)
 ;merge rtn=tout
"RTN","SAMICAS2",571,0)
 ;
"RTN","SAMICAS2",572,0)
 ;@stanza 3 termination
"RTN","SAMICAS2",573,0)
 ;
"RTN","SAMICAS2",574,0)
 quit  ; end of wsNuForm
"RTN","SAMICAS2",575,0)
 ;
"RTN","SAMICAS2",576,0)
 ;
"RTN","SAMICAS2",577,0)
 ;@ppi - convert a key to a fileman date
"RTN","SAMICAS2",578,0)
KEY2FM ; convert a key to a fileman date
"RTN","SAMICAS2",579,0)
 ;@called by
"RTN","SAMICAS2",580,0)
 ; SAVFILTR^SAMISAV
"RTN","SAMICAS2",581,0)
 ; SELECT^SAMIUR1
"RTN","SAMICAS2",582,0)
 ;@calls
"RTN","SAMICAS2",583,0)
 ; ^%DT
"RTN","SAMICAS2",584,0)
 ;@input
"RTN","SAMICAS2",585,0)
 ; key = vapals key (e.g.
"RTN","SAMICAS2",586,0)
 ;@output
"RTN","SAMICAS2",587,0)
 ;@examples
"RTN","SAMICAS2",588,0)
 ;  $$KEY2FM("sbform-2018-02-26") = 3180226
"RTN","SAMICAS2",589,0)
 ;@tests
"RTN","SAMICAS2",590,0)
 ; SAMIUTS2
"RTN","SAMICAS2",591,0)
 ;
"RTN","SAMICAS2",592,0)
 new datepart,X,Y,frm
"RTN","SAMICAS2",593,0)
 set datepart=key
"RTN","SAMICAS2",594,0)
 if $length(key,"-")=4 do  ; allow key to be the whole key ie ceform-2018-10-3
"RTN","SAMICAS2",595,0)
 . set frm=$piece(key,"-",1)
"RTN","SAMICAS2",596,0)
 . set datepart=$piece(key,frm_"-",2)
"RTN","SAMICAS2",597,0)
 set X=datepart
"RTN","SAMICAS2",598,0)
 do ^%DT
"RTN","SAMICAS2",599,0)
 quit Y
"RTN","SAMICAS2",600,0)
 ;
"RTN","SAMICAS2",601,0)
 ;@section 3 casetbl
"RTN","SAMICAS2",602,0)
 ;
"RTN","SAMICAS2",603,0)
 ;@ppi - extrinsic returns the value of 'samistatus' from the form
"RTN","SAMICAS2",604,0)
GSAMISTA(sid,form) ; extrinsic returns the value of 'samistatus' from the form
"RTN","SAMICAS2",605,0)
 ;@called by
"RTN","SAMICAS2",606,0)
 ; WSCASE^SAMICAS2
"RTN","SAMICAS2",607,0)
 ;@calls
"RTN","SAMICAS2",608,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",609,0)
 ;@input
"RTN","SAMICAS2",610,0)
 ; sid  = patient's studyid
"RTN","SAMICAS2",611,0)
 ; form = specific study form (e.g. "sbform-2018-02-26")
"RTN","SAMICAS2",612,0)
 ;@output
"RTN","SAMICAS2",613,0)
 ; status of the form
"RTN","SAMICAS2",614,0)
 ;@tests
"RTN","SAMICAS2",615,0)
 ; SAMIUTS2
"RTN","SAMICAS2",616,0)
 ;
"RTN","SAMICAS2",617,0)
 new stat,root,useform
"RTN","SAMICAS2",618,0)
 set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",619,0)
 set useform=form
"RTN","SAMICAS2",620,0)
 if form["vapals:" set useform=$p(form,"vapals:",2)
"RTN","SAMICAS2",621,0)
 set stat=$get(@root@("graph",sid,useform,"samistatus"))
"RTN","SAMICAS2",622,0)
 quit stat
"RTN","SAMICAS2",623,0)
 ;
"RTN","SAMICAS2",624,0)
 ;@ppi - sets 'samistatus' to val in form
"RTN","SAMICAS2",625,0)
SSAMISTA ; sets 'samistatus' to val in form
"RTN","SAMICAS2",626,0)
 ;@called by
"RTN","SAMICAS2",627,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS2",628,0)
 ;@calls
"RTN","SAMICAS2",629,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",630,0)
 ;@input
"RTN","SAMICAS2",631,0)
 ; sid   = patient's studyid
"RTN","SAMICAS2",632,0)
 ; form  = specific study form (e.g. "sbform-2018-02-26")
"RTN","SAMICAS2",633,0)
 ; value = status (complete, incomplete)
"RTN","SAMICAS2",634,0)
 ;@output
"RTN","SAMICAS2",635,0)
 ; sets 'samistatus' to val in form
"RTN","SAMICAS2",636,0)
 ;@tests
"RTN","SAMICAS2",637,0)
 ;
"RTN","SAMICAS2",638,0)
 new root,useform
"RTN","SAMICAS2",639,0)
 set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",640,0)
 set useform=form
"RTN","SAMICAS2",641,0)
 if form["vapals:" set useform=$piece(form,"vapals:",2)
"RTN","SAMICAS2",642,0)
 if '$d(@root@("graph",sid,useform)) quit  ; no form there
"RTN","SAMICAS2",643,0)
 set @root@("graph",sid,useform,"samistatus")=val
"RTN","SAMICAS2",644,0)
 quit
"RTN","SAMICAS2",645,0)
 ;
"RTN","SAMICAS2",646,0)
 ;
"RTN","SAMICAS2",647,0)
 ;@ppi - deletes a form if it is incomplete
"RTN","SAMICAS2",648,0)
DELFORM ; deletes a form if it is incomplete
"RTN","SAMICAS2",649,0)
 ; will not delete intake or background forms
"RTN","SAMICAS2",650,0)
 ;@called by
"RTN","SAMICAS2",651,0)
 ; DELFORM^SAMICASE
"RTN","SAMICAS2",652,0)
 ;@calls
"RTN","SAMICAS2",653,0)
 ; $$setroot^%wd
"RTN","SAMICAS2",654,0)
 ; $$GSAMISTA^SAMICAS2
"RTN","SAMICAS2",655,0)
 ; WSCASE^SAMICAS2
"RTN","SAMICAS2",656,0)
 ;@input
"RTN","SAMICAS2",657,0)
 ; .ARGS=
"RTN","SAMICAS2",658,0)
 ; .ARGS("studyid")
"RTN","SAMICAS2",659,0)
 ; .ARGS("form")
"RTN","SAMICAS2",660,0)
 ;@output
"RTN","SAMICAS2",661,0)
 ; @RESULT
"RTN","SAMICAS2",662,0)
 ;@tests
"RTN","SAMICAS2",663,0)
 ; SAMIUTS2
"RTN","SAMICAS2",664,0)
 ;
"RTN","SAMICAS2",665,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",666,0)
 new sid,form
"RTN","SAMICAS2",667,0)
 set sid=$get(ARGS("studyid"))
"RTN","SAMICAS2",668,0)
 quit:sid=""
"RTN","SAMICAS2",669,0)
 set form=$get(ARGS("form"))
"RTN","SAMICAS2",670,0)
 quit:form=""
"RTN","SAMICAS2",671,0)
 if form["siform" quit  ;
"RTN","SAMICAS2",672,0)
 ;if '$data(@root@("graph",sid,form)) quit  ; form does not exist
"RTN","SAMICAS2",673,0)
 if $$GSAMISTA(sid,form)="incomplete" do  ;
"RTN","SAMICAS2",674,0)
 . kill @root@("graph",sid,form)
"RTN","SAMICAS2",675,0)
 kill ARGS("samiroute")
"RTN","SAMICAS2",676,0)
 do WSCASE^SAMICASE(.RESULT,.ARGS)
"RTN","SAMICAS2",677,0)
 quit
"RTN","SAMICAS2",678,0)
 ;
"RTN","SAMICAS2",679,0)
 ;
"RTN","SAMICAS2",680,0)
INITSTAT ; set all forms to 'incomplete'
"RTN","SAMICAS2",681,0)
 ;@called by : none
"RTN","SAMICAS2",682,0)
 ;@calls
"RTN","SAMICAS2",683,0)
 ; SSAMISTA^SAMICASE
"RTN","SAMICAS2",684,0)
 ;@input : none
"RTN","SAMICAS2",685,0)
 ;@output
"RTN","SAMICAS2",686,0)
 ; set all forms to 'incomplete'
"RTN","SAMICAS2",687,0)
 ;@tests
"RTN","SAMICAS2",688,0)
 ;
"RTN","SAMICAS2",689,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMICAS2",690,0)
 new zi,zj set (zi,zj)=""
"RTN","SAMICAS2",691,0)
 for  set zi=$order(@root@("graph",zi)) quit:zi=""  do  ;
"RTN","SAMICAS2",692,0)
 . for  set zj=$order(@root@("graph",zi,zj)) quit:zj=""  do  ;
"RTN","SAMICAS2",693,0)
 . . if zj["siform" do SSAMISTA^SAMICASE(zi,zj,"complete") quit  ;
"RTN","SAMICAS2",694,0)
 . . do SSAMISTA^SAMICASE(zi,zj,"incomplete")
"RTN","SAMICAS2",695,0)
 quit
"RTN","SAMICAS2",696,0)
 ;
"RTN","SAMICAS2",697,0)
 ;
"RTN","SAMICAS2",698,0)
EOR ; end of routine SAMICAS2
"RTN","SAMICASE")
0^1^B4139384
"RTN","SAMICASE",1,0)
SAMICASE ;ven/gpl - ielcap: case review page module; 2/14/19 10:11am ; 3/29/19 10:18am
"RTN","SAMICASE",2,0)
 ;;18.0;SAM;;;Build 1
"RTN","SAMICASE",3,0)
 ;
"RTN","SAMICASE",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMICASE",5,0)
 ;@documentation: see routine SAMICUL
"RTN","SAMICASE",6,0)
 ;
"RTN","SAMICASE",7,0)
 ; SAMICASE contains subroutines for producing the ELCAP Case Review Page.
"RTN","SAMICASE",8,0)
 ;
"RTN","SAMICASE",9,0)
 ;
"RTN","SAMICASE",10,0)
 quit  ; no entry from top
"RTN","SAMICASE",11,0)
 ;
"RTN","SAMICASE",12,0)
 ;@ppi - generate case review page
"RTN","SAMICASE",13,0)
WSCASE(rtn,filter) ; generate case review page
"RTN","SAMICASE",14,0)
 ;@called by :
"RTN","SAMICASE",15,0)
 ; WSVAPALS^SAMIHOM4
"RTN","SAMICASE",16,0)
 ; WSLOOKUP^SAMISRC2
"RTN","SAMICASE",17,0)
 ; WSCASE^SAMICAS2
"RTN","SAMICASE",18,0)
 ; _wfhform
"RTN","SAMICASE",19,0)
 ; %wfhform
"RTN","SAMICASE",20,0)
 ;@web service
"RTN","SAMICASE",21,0)
 ; SAMICASE-wsCASE
"RTN","SAMICASE",22,0)
 ;@calls :
"RTN","SAMICASE",23,0)
 ; $$setroot^%wd
"RTN","SAMICASE",24,0)
 ; GETTMPL^SAMICAS2
"RTN","SAMICASE",25,0)
 ; GETITEMS^SAMICAS2
"RTN","SAMICASE",26,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICASE",27,0)
 ; findReplace^%ts
"RTN","SAMICASE",28,0)
 ; FIXHREF^SAMIFORM
"RTN","SAMICASE",29,0)
 ; FIXSRC^SAMIFORM
"RTN","SAMICASE",30,0)
 ; $$GETDTKEY^SAMICAS2
"RTN","SAMICASE",31,0)
 ; $$KEY2DSPD^SAMICAS2
"RTN","SAMICASE",32,0)
 ; $$GETLAST5^SAMIFORM
"RTN","SAMICASE",33,0)
 ; $$GETSSN^SAMIFORM
"RTN","SAMICASE",34,0)
 ; $$GETNAME^SAMIFORM
"RTN","SAMICASE",35,0)
 ; $$GSAMISTA^SAMICAS2
"RTN","SAMICASE",36,0)
 ; D ADDCRLF^VPRJRUT
"RTN","SAMICASE",37,0)
 ;@input :
"RTN","SAMICASE",38,0)
 ; .filter =
"RTN","SAMICASE",39,0)
 ; .filter("studyid")=studyid of the patient
"RTN","SAMICASE",40,0)
 ;@output :
"RTN","SAMICASE",41,0)
 ; .rtn
"RTN","SAMICASE",42,0)
 ;@tests :
"RTN","SAMICASE",43,0)
 ; SAMIUTS2
"RTN","SAMICASE",44,0)
 goto WSCASE^SAMICAS2
"RTN","SAMICASE",45,0)
 ;
"RTN","SAMICASE",46,0)
 ;
"RTN","SAMICASE",47,0)
 ;@ppi - get html template
"RTN","SAMICASE",48,0)
GETTMPL(return,form) ; get html template
"RTN","SAMICASE",49,0)
 ;@called by :
"RTN","SAMICASE",50,0)
 ; GETHOME^SAMIHOM4
"RTN","SAMICASE",51,0)
 ; WSNOTE^SAMINOTI
"RTN","SAMICASE",52,0)
 ;@calls :
"RTN","SAMICASE",53,0)
 ; $$getTemplate^%wf
"RTN","SAMICASE",54,0)
 ; getThis^%wd
"RTN","SAMICASE",55,0)
 ;@input
"RTN","SAMICASE",56,0)
 ; return = name of array to return template in
"RTN","SAMICASE",57,0)
 ; form = name of form
"RTN","SAMICASE",58,0)
 ;@output
"RTN","SAMICASE",59,0)
 ; @return = template
"RTN","SAMICASE",60,0)
 ;@tests :
"RTN","SAMICASE",61,0)
 ; SAMIUTS2
"RTN","SAMICASE",62,0)
 goto GETTMPL^SAMICAS2
"RTN","SAMICASE",63,0)
 ;
"RTN","SAMICASE",64,0)
 ;
"RTN","SAMICASE",65,0)
 ;@ppi - get items available for studyid
"RTN","SAMICASE",66,0)
GETITEMS(ary,sid) ; get items available for studyid
"RTN","SAMICASE",67,0)
 ;@called by
"RTN","SAMICASE",68,0)
 ; GETITEMS^SAMICAS2
"RTN","SAMICASE",69,0)
 ; MKCEFORM^SAMICAS3
"RTN","SAMICASE",70,0)
 ; GETFILTR^SAMICTR0
"RTN","SAMICASE",71,0)
 ; WSSBFORM^SAMIFORM
"RTN","SAMICASE",72,0)
 ; WSSIFORM^SAMIFORM
"RTN","SAMICASE",73,0)
 ; WSCEFORM^SAMIFORM
"RTN","SAMICASE",74,0)
 ; SELECT^SAMIUR1
"RTN","SAMICASE",75,0)
 ;@calls
"RTN","SAMICASE",76,0)
 ; $$setroot^%wd
"RTN","SAMICASE",77,0)
 ;@input
"RTN","SAMICASE",78,0)
 ; @ary = returned items available
"RTN","SAMICASE",79,0)
 ; sid = patient's study ID (e.g. "XXX00001")
"RTN","SAMICASE",80,0)
 ;@output
"RTN","SAMICASE",81,0)
 ;@tests
"RTN","SAMICASE",82,0)
 ; SAMIUTS2
"RTN","SAMICASE",83,0)
 goto GETITEMS^SAMICAS2
"RTN","SAMICASE",84,0)
 ;
"RTN","SAMICASE",85,0)
 ;@ppi extrinsic returns html for the list of notes for the form
"RTN","SAMICASE",86,0)
NOTEHREF(sid,form) ; extrinsic returns html for the list of notes for the form
"RTN","SAMICASE",87,0)
 goto NOTEHREF^SAMICAS2
"RTN","SAMICASE",88,0)
 ;
"RTN","SAMICASE",89,0)
 ;@ppi - extrinsic which return the vapals format for dates
"RTN","SAMICASE",90,0)
VAPALSDT(fmdate) ; extrinsic which return the vapals format for dates
"RTN","SAMICASE",91,0)
 ;@called by
"RTN","SAMICASE",92,0)
 ; PREFILL^SAMIHOM3
"RTN","SAMICASE",93,0)
 ; MKSIFORM^SAMIHOM3
"RTN","SAMICASE",94,0)
 ; SELECT^SAMIUR1
"RTN","SAMICASE",95,0)
 ;@calls
"RTN","SAMICASE",96,0)
 ; $$FMTE^XLFDT
"RTN","SAMICASE",97,0)
 ;@input
"RTN","SAMICASE",98,0)
 ; fmdate = date in fileman format
"RTN","SAMICASE",99,0)
 ;@output
"RTN","SAMICASE",100,0)
 ; vapals date format
"RTN","SAMICASE",101,0)
 ;@tests
"RTN","SAMICASE",102,0)
 ; SAMIUTS2
"RTN","SAMICASE",103,0)
 goto VAPALSDT^SAMICAS2
"RTN","SAMICASE",104,0)
 ;
"RTN","SAMICASE",105,0)
 ;
"RTN","SAMICASE",106,0)
WSNUFORM(rtn,filter) ; select new form for patient (get service)
"RTN","SAMICASE",107,0)
 ;@called by
"RTN","SAMICASE",108,0)
 ; WSVAPALS^SAMIHOM4
"RTN","SAMICASE",109,0)
 ;@web service
"RTN","SAMICASE",110,0)
 ;  SAMICASE-wsNuForm
"RTN","SAMICASE",111,0)
 ;@calls
"RTN","SAMICASE",112,0)
 ; $$SID2NUM^SAMIHOM3
"RTN","SAMICASE",113,0)
 ; $$setroot^%wd
"RTN","SAMICASE",114,0)
 ; GETTMPL^SAMICAS2
"RTN","SAMICASE",115,0)
 ; findReplace^%ts
"RTN","SAMICASE",116,0)
 ; FIXHREF^SAMIFORM
"RTN","SAMICASE",117,0)
 ; FIXSRC^SAMIFORM
"RTN","SAMICASE",118,0)
 ; findReplace^%ts
"RTN","SAMICASE",119,0)
 ;@input
"RTN","SAMICASE",120,0)
 ; .filter =
"RTN","SAMICASE",121,0)
 ; .filter("studyid")=studyid of the patient
"RTN","SAMICASE",122,0)
 ;@output
"RTN","SAMICASE",123,0)
 ; @rtn
"RTN","SAMICASE",124,0)
 ;@tests
"RTN","SAMICASE",125,0)
 ; SAMIUTS
"RTN","SAMICASE",126,0)
 goto WSNUFORM^SAMICAS2
"RTN","SAMICASE",127,0)
 ;
"RTN","SAMICASE",128,0)
 ;
"RTN","SAMICASE",129,0)
 ;@ppi - convert a key to a fileman date
"RTN","SAMICASE",130,0)
KEY2FM(key) ; convert a key to a fileman date
"RTN","SAMICASE",131,0)
 ;@called by
"RTN","SAMICASE",132,0)
 ; WSNFPOST^SAMICAS3
"RTN","SAMICASE",133,0)
 ; SAVFILTR^SAMISAV
"RTN","SAMICASE",134,0)
 ; SELECT^SAMIUR1
"RTN","SAMICASE",135,0)
 ;@calls
"RTN","SAMICASE",136,0)
 ; ^%DT
"RTN","SAMICASE",137,0)
 ;@input
"RTN","SAMICASE",138,0)
 ; key = vapals key (e.g.
"RTN","SAMICASE",139,0)
 ;@output
"RTN","SAMICASE",140,0)
 ;@examples
"RTN","SAMICASE",141,0)
 ;  $$KEY2FM("sbform-2018-02-26") = 3180226
"RTN","SAMICASE",142,0)
 ;@tests
"RTN","SAMICASE",143,0)
 ; SAMIUTS2
"RTN","SAMICASE",144,0)
 goto KEY2FM^SAMICAS2
"RTN","SAMICASE",145,0)
 ;
"RTN","SAMICASE",146,0)
 ;@ppi - sets 'samistatus' to val in form
"RTN","SAMICASE",147,0)
SSAMISTA(sid,form,val) ; sets 'samistatus' to val in form
"RTN","SAMICASE",148,0)
 ;@called by
"RTN","SAMICASE",149,0)
 ; INITSTAT^SAMICAS2
"RTN","SAMICASE",150,0)
 ; MKBSFORM^SAMIHOM3
"RTN","SAMICASE",151,0)
 ; MKSIFORM^SAMIHOM3
"RTN","SAMICASE",152,0)
 ;@calls
"RTN","SAMICASE",153,0)
 ; $$setroot^%wd
"RTN","SAMICASE",154,0)
 ;@input
"RTN","SAMICASE",155,0)
 ; sid   = patient's studyid
"RTN","SAMICASE",156,0)
 ; form  = specific study form (e.g. "sbform-2018-02-26")
"RTN","SAMICASE",157,0)
 ; value = status (complete, incomplete)
"RTN","SAMICASE",158,0)
 ;@output
"RTN","SAMICASE",159,0)
 ; sets 'samistatus' to val in form
"RTN","SAMICASE",160,0)
 ;@tests
"RTN","SAMICASE",161,0)
 goto SSAMISTA^SAMICAS2
"RTN","SAMICASE",162,0)
 ;
"RTN","SAMICASE",163,0)
 ;@ppi - deletes a form if it is incomplete
"RTN","SAMICASE",164,0)
DELFORM(RESULT,ARGS) ; deletes a form if it is incomplete
"RTN","SAMICASE",165,0)
 ;@called by
"RTN","SAMICASE",166,0)
 ; WSVAPALS^SAMIHOM4
"RTN","SAMICASE",167,0)
 ;@calls
"RTN","SAMICASE",168,0)
 ; $$setroot^%wd
"RTN","SAMICASE",169,0)
 ; $$GSAMISTA^SAMICAS2
"RTN","SAMICASE",170,0)
 ; WSCASE^SAMICAS2
"RTN","SAMICASE",171,0)
 ;@input
"RTN","SAMICASE",172,0)
 ; .ARGS=
"RTN","SAMICASE",173,0)
 ; .ARGS("studyid")
"RTN","SAMICASE",174,0)
 ; .ARGS("form")
"RTN","SAMICASE",175,0)
 ;@output
"RTN","SAMICASE",176,0)
 ; @RESULT
"RTN","SAMICASE",177,0)
 ;@tests
"RTN","SAMICASE",178,0)
 ; SAMIUTS2
"RTN","SAMICASE",179,0)
 goto DELFORM^SAMICAS2
"RTN","SAMICASE",180,0)
 ;
"RTN","SAMICASE",181,0)
 ;
"RTN","SAMICASE",182,0)
 ;@ppi - post new form selection (post service)
"RTN","SAMICASE",183,0)
WSNFPOST(ARGS,BODY,RESULT) ; post new form selection (post service)
"RTN","SAMICASE",184,0)
 ;@called by
"RTN","SAMICASE",185,0)
 ; WSVAPALS^SAMIHOM4
"RTN","SAMICASE",186,0)
 ;@web service
"RTN","SAMICASE",187,0)
 ; SAMICASE-wsNuFormPost
"RTN","SAMICASE",188,0)
 ;@calls
"RTN","SAMICASE",189,0)
 ; parseBody^%wf
"RTN","SAMICASE",190,0)
 ; GETHOME^SAMIHOM3
"RTN","SAMICASE",191,0)
 ; $$KEYDATE^SAMIHOM3
"RTN","SAMICASE",192,0)
 ; $$setroot^%wd
"RTN","SAMICASE",193,0)
 ; $$KEY2FM^SAMICAS2
"RTN","SAMICASE",194,0)
 ; MKSBFORM^SAMICAS3
"RTN","SAMICASE",195,0)
 ; MKCEFORM^SAMICAS3
"RTN","SAMICASE",196,0)
 ; MKFUFORM^SAMICAS3
"RTN","SAMICASE",197,0)
 ; MKBXFORM^SAMICAS3
"RTN","SAMICASE",198,0)
 ; MKPTFORM^SAMICAS3
"RTN","SAMICASE",199,0)
 ; MKITFORM^SAMICAS3
"RTN","SAMICASE",200,0)
 ;@input
"RTN","SAMICASE",201,0)
 ; .ARGS
"RTN","SAMICASE",202,0)
 ; .ARGS("form")
"RTN","SAMICASE",203,0)
 ; .ARGS("studyid")
"RTN","SAMICASE",204,0)
 ; .ARGS("sid")
"RTN","SAMICASE",205,0)
 ; .BODY
"RTN","SAMICASE",206,0)
 ; .BODY(1) (e.g. "samiroute=casereview&dfn="_dfn_"&studyid="_studyid)
"RTN","SAMICASE",207,0)
 ;@output
"RTN","SAMICASE",208,0)
 ; @RESULT
"RTN","SAMICASE",209,0)
 ;@tests
"RTN","SAMICASE",210,0)
 ; SAMIUTS2
"RTN","SAMICASE",211,0)
 goto WSNFPOST^SAMICAS3
"RTN","SAMICASE",212,0)
 ;
"RTN","SAMICASE",213,0)
EOR ; end of routine SAMICASE
"RTN","SAMIHOM4")
0^3^B457477392
"RTN","SAMIHOM4",1,0)
SAMIHOM4 ;ven/gpl,arc - ielcap: forms;2018-11-30T17:45Z ;Jan 14, 2020@16:04
"RTN","SAMIHOM4",2,0)
 ;;18.0;SAMI;;;Build 1
"RTN","SAMIHOM4",3,0)
 ;
"RTN","SAMIHOM4",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMIHOM4",5,0)
 ;
"RTN","SAMIHOM4",6,0)
 ; @section 0 primary development
"RTN","SAMIHOM4",7,0)
 ;
"RTN","SAMIHOM4",8,0)
 ; @routine-credits
"RTN","SAMIHOM4",9,0)
 ; @primary-dev: George P. Lilly (gpl)
"RTN","SAMIHOM4",10,0)
 ;  gpl@vistaexpertise.net
"RTN","SAMIHOM4",11,0)
 ; @additional-dev: Alexis Carlson (arc)
"RTN","SAMIHOM4",12,0)
 ;  alexis@vistaexpertise.net
"RTN","SAMIHOM4",13,0)
 ; @primary-dev-org: Vista Expertise Network (ven)
"RTN","SAMIHOM4",14,0)
 ;  http://vistaexpertise.net
"RTN","SAMIHOM4",15,0)
 ; @copyright: 2012/2018, ven, all rights reserved
"RTN","SAMIHOM4",16,0)
 ; @license: Apache 2.0
"RTN","SAMIHOM4",17,0)
 ;  https://www.apache.org/licenses/LICENSE-2.0.html
"RTN","SAMIHOM4",18,0)
 ;
"RTN","SAMIHOM4",19,0)
 ; @application: SAMI
"RTN","SAMIHOM4",20,0)
 ; @version: 18.0
"RTN","SAMIHOM4",21,0)
 ; @patch-list: none yet
"RTN","SAMIHOM4",22,0)
 ;
"RTN","SAMIHOM4",23,0)
 ; @to-do
"RTN","SAMIHOM4",24,0)
 ;   Add label comments
"RTN","SAMIHOM4",25,0)
 ;
"RTN","SAMIHOM4",26,0)
 ; @section 1 code
"RTN","SAMIHOM4",27,0)
 ;
"RTN","SAMIHOM4",28,0)
 quit  ; No entry from top
"RTN","SAMIHOM4",29,0)
 ;
"RTN","SAMIHOM4",30,0)
 ;
"RTN","SAMIHOM4",31,0)
WSHOME ; web service for SAMI homepage
"RTN","SAMIHOM4",32,0)
 ; WSHOME^SAMIHOM3(SAMIRTN,SAMIFILTER) goto WSHOME^SAMIHOM4
"RTN","SAMIHOM4",33,0)
 ;
"RTN","SAMIHOM4",34,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",35,0)
 ;
"RTN","SAMIHOM4",36,0)
 ;ven/gpl;web service;procedure;
"RTN","SAMIHOM4",37,0)
 ;@called-by
"RTN","SAMIHOM4",38,0)
 ;@calls
"RTN","SAMIHOM4",39,0)
 ; GETHOME
"RTN","SAMIHOM4",40,0)
 ;@input
"RTN","SAMIHOM4",41,0)
 ; SAMIFILTER
"RTN","SAMIHOM4",42,0)
 ;@output
"RTN","SAMIHOM4",43,0)
 ;.SAMIRTN
"RTN","SAMIHOM4",44,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",45,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",46,0)
 ;
"RTN","SAMIHOM4",47,0)
 ; no parameters required
"RTN","SAMIHOM4",48,0)
 ;
"RTN","SAMIHOM4",49,0)
 ;@stanza 2 present development or temporary homepage
"RTN","SAMIHOM4",50,0)
 ;
"RTN","SAMIHOM4",51,0)
 if $get(SAMIFILTER("test"))=1 do  quit
"RTN","SAMIHOM4",52,0)
 . do DEVHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER)
"RTN","SAMIHOM4",53,0)
 . quit
"RTN","SAMIHOM4",54,0)
 ;
"RTN","SAMIHOM4",55,0)
 if $g(SAMIFILTER("samiroute"))'="" do  quit  ; workaround for "get" access to pages
"RTN","SAMIHOM4",56,0)
 . new SAMIBODY set SAMIBODY(1)=""
"RTN","SAMIHOM4",57,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",58,0)
 ;
"RTN","SAMIHOM4",59,0)
 if $get(SAMIFILTER("dfn"))'="" do  quit  ; V4W/DLW - workaround for "get" access from CPRS
"RTN","SAMIHOM4",60,0)
 . new dfn set dfn=$get(SAMIFILTER("dfn"))
"RTN","SAMIHOM4",61,0)
 . new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",62,0)
 . new studyid set studyid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIHOM4",63,0)
 . new SAMIBODY
"RTN","SAMIHOM4",64,0)
 . if studyid'="" do
"RTN","SAMIHOM4",65,0)
 . . set SAMIBODY(1)="samiroute=casereview&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",66,0)
 . else  do
"RTN","SAMIHOM4",67,0)
 . . set SAMIBODY(1)="samiroute=lookup&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",68,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",69,0)
 ;
"RTN","SAMIHOM4",70,0)
 do GETHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER) ; VAPALS homepage
"RTN","SAMIHOM4",71,0)
 ;
"RTN","SAMIHOM4",72,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",73,0)
 ;
"RTN","SAMIHOM4",74,0)
 quit  ; end of WSHOME
"RTN","SAMIHOM4",75,0)
 ;
"RTN","SAMIHOM4",76,0)
 ;
"RTN","SAMIHOM4",77,0)
WSVAPALS ; vapals post web service - all calls come through this gateway
"RTN","SAMIHOM4",78,0)
 ; WSVAPALS^SAMIHOM3(SAMIARG,SAMIBODY,SAMIRESULT) goto WSVAPALS^SAMIHOM4
"RTN","SAMIHOM4",79,0)
 m ^SAMIUL("vapals")=SAMIARG
"RTN","SAMIHOM4",80,0)
 m ^SAMIUL("vapals","BODY")=SAMIBODY
"RTN","SAMIHOM4",81,0)
 ;
"RTN","SAMIHOM4",82,0)
 new vars,SAMIBDY
"RTN","SAMIHOM4",83,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",84,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",85,0)
 m vars=SAMIARG
"RTN","SAMIHOM4",86,0)
 k ^SAMIUL("vapals","vars")
"RTN","SAMIHOM4",87,0)
 merge ^SAMIUL("vapals","vars")=vars
"RTN","SAMIHOM4",88,0)
 ;
"RTN","SAMIHOM4",89,0)
 n route s route=$g(vars("samiroute"))
"RTN","SAMIHOM4",90,0)
 i route=""  d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",91,0)
 ;
"RTN","SAMIHOM4",92,0)
 i route="lookup" d  q 0
"RTN","SAMIHOM4",93,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",94,0)
 . d WSLOOKUP^SAMISRC2(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",95,0)
 ;
"RTN","SAMIHOM4",96,0)
 i route="newcase" d  q 0
"RTN","SAMIHOM4",97,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",98,0)
 . d WSNEWCAS^SAMIHOM3(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",99,0)
 ;
"RTN","SAMIHOM4",100,0)
 i route="casereview" d  q 0
"RTN","SAMIHOM4",101,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",102,0)
 . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",103,0)
 ;
"RTN","SAMIHOM4",104,0)
 i route="nuform" d  q 0
"RTN","SAMIHOM4",105,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",106,0)
 . d WSNUFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",107,0)
 ;
"RTN","SAMIHOM4",108,0)
 i route="addform" d  q 0
"RTN","SAMIHOM4",109,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",110,0)
 . d WSNFPOST^SAMICASE(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",111,0)
 ;
"RTN","SAMIHOM4",112,0)
 i route="form" d  q 0
"RTN","SAMIHOM4",113,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",114,0)
 . d wsGetForm^%wf(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",115,0)
 ;
"RTN","SAMIHOM4",116,0)
 i route="postform" d  q 0
"RTN","SAMIHOM4",117,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",118,0)
 . d wsPostForm^%wf(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",119,0)
 . i $g(SAMIARG("form"))["siform" d  ;
"RTN","SAMIHOM4",120,0)
 . . if $$NOTE^SAMINOT1(.SAMIARG) d  ;
"RTN","SAMIHOM4",121,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",122,0)
 . . . s SAMIFILTER("studyid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",123,0)
 . . . s SAMIFILTER("form")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",124,0)
 . . . n tiuien
"RTN","SAMIHOM4",125,0)
 . . . ;s tiuien=$$SV2VISTA^SAMIVSTA(.SAMIFILTER)
"RTN","SAMIHOM4",126,0)
 . . . ;s SAMIFILTER("tiuien")=tiuien
"RTN","SAMIHOM4",127,0)
 . . . ;d SV2VSTA^SAMIVSTA(.FILTER)
"RTN","SAMIHOM4",128,0)
 . . . ;m ^SAMIUL("newFILTER")=SAMIFILTER
"RTN","SAMIHOM4",129,0)
 . . . d WSNOTE^SAMINOT1(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",130,0)
 . i $g(SAMIARG("form"))["fuform" d  ;
"RTN","SAMIHOM4",131,0)
 . . if $$NOTE^SAMINOT2(.SAMIARG) d  ;
"RTN","SAMIHOM4",132,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",133,0)
 . . . s SAMIFILTER("studyid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",134,0)
 . . . s SAMIFILTER("form")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",135,0)
 . . . ;n tiuien
"RTN","SAMIHOM4",136,0)
 . . . ;s tiuien=$$SV2VISTA^SAMIVSTA(.SAMIFILTER)
"RTN","SAMIHOM4",137,0)
 . . . ;s SAMIFILTER("tiuien")=tiuien
"RTN","SAMIHOM4",138,0)
 . . . ;d SV2VSTA^SAMIVSTA(.FILTER)
"RTN","SAMIHOM4",139,0)
 . . . ;m ^SAMIUL("newFILTER")=SAMIFILTER
"RTN","SAMIHOM4",140,0)
 . . . d WSNOTE^SAMINOT2(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",141,0)
 . . e  d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",142,0)
 ;
"RTN","SAMIHOM4",143,0)
 i route="deleteform" d  q 0
"RTN","SAMIHOM4",144,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",145,0)
 . d DELFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",146,0)
 ;
"RTN","SAMIHOM4",147,0)
 i route="ctreport" d  q 0
"RTN","SAMIHOM4",148,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",149,0)
 . d WSREPORT^SAMICTR0(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",150,0)
 . ;d wsReport^SAMICTRT(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",151,0)
 ;
"RTN","SAMIHOM4",152,0)
 i route="note" d  q 0
"RTN","SAMIHOM4",153,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",154,0)
 . d WSNOTE^SAMINOT1(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",155,0)
 ;
"RTN","SAMIHOM4",156,0)
 i route="report" d  q 0 
"RTN","SAMIHOM4",157,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",158,0)
 . d WSREPORT^SAMIUR(.SAMIRESULT,.vars)
"RTN","SAMIHOM4",159,0)
 ;
"RTN","SAMIHOM4",160,0)
 i route="addperson" d  q 0
"RTN","SAMIHOM4",161,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",162,0)
 . n form
"RTN","SAMIHOM4",163,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",164,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",165,0)
 ;
"RTN","SAMIHOM4",166,0)
 i route="editperson" d  q 0
"RTN","SAMIHOM4",167,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",168,0)
 . n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",169,0)
 . i dfn="" d  q  ;
"RTN","SAMIHOM4",170,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",171,0)
 . n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",172,0)
 . n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",173,0)
 . i sien="" d  q  ;
"RTN","SAMIHOM4",174,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",175,0)
 . s vars("name")=$g(@root@(sien,"saminame"))
"RTN","SAMIHOM4",176,0)
 . s tdob=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",177,0)
 . s vars("dob")=$p(tdob,"-",2)_"/"_$p(tdob,"-",3)_"/"_$p(tdob,"-",1)
"RTN","SAMIHOM4",178,0)
 . s vars("sbdob")=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",179,0)
 . s vars("gender")=$g(@root@(sien,"sex"))
"RTN","SAMIHOM4",180,0)
 . s vars("icn")=$g(@root@(sien,"icn"))
"RTN","SAMIHOM4",181,0)
 . n tssn s tssn=$g(@root@(sien,"ssn"))
"RTN","SAMIHOM4",182,0)
 . s vars("ssn")=$e(tssn,1,3)_"-"_$e(tssn,4,5)_"-"_$e(tssn,6,9)
"RTN","SAMIHOM4",183,0)
 . s vars("last5")=$g(@root@(sien,"last5"))
"RTN","SAMIHOM4",184,0)
 . s vars("dfn")=$g(@root@(sien,"dfn"))
"RTN","SAMIHOM4",185,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",186,0)
 . n form,err,zhtml
"RTN","SAMIHOM4",187,0)
 . s form="vapals:editparticipant"
"RTN","SAMIHOM4",188,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",189,0)
 ;
"RTN","SAMIHOM4",190,0)
 i route="register" d  q 0
"RTN","SAMIHOM4",191,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",192,0)
 . d REG^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",193,0)
 ; 
"RTN","SAMIHOM4",194,0)
 i route="editsave" d  q 0
"RTN","SAMIHOM4",195,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",196,0)
 . d SAVE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",197,0)
 ;
"RTN","SAMIHOM4",198,0)
 i route="merge" d  q 0
"RTN","SAMIHOM4",199,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",200,0)
 . d MERGE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",201,0)
 ;
"RTN","SAMIHOM4",202,0)
 quit 0  ; End of WSVAPALS
"RTN","SAMIHOM4",203,0)
 ;
"RTN","SAMIHOM4",204,0)
 ;
"RTN","SAMIHOM4",205,0)
REG(SAMIRTN,SAMIARG) ; manual registration
"RTN","SAMIHOM4",206,0)
 ;
"RTN","SAMIHOM4",207,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",208,0)
 ;
"RTN","SAMIHOM4",209,0)
 m ^gpl("reg")=SAMIARG
"RTN","SAMIHOM4",210,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",211,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",212,0)
 s SAMIARG("errorMessage")=""
"RTN","SAMIHOM4",213,0)
 s SAMIARG("errorField")=""
"RTN","SAMIHOM4",214,0)
 ; test for duplicate ssn
"RTN","SAMIHOM4",215,0)
 ;
"RTN","SAMIHOM4",216,0)
 i $$DUPSSN(ssn) d  ;
"RTN","SAMIHOM4",217,0)
 . ;s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN."
"RTN","SAMIHOM4",218,0)
 . s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN error. A person with that SSN is already entered in the system."
"RTN","SAMIHOM4",219,0)
 . s SAMIARG("errorField")="ssn"
"RTN","SAMIHOM4",220,0)
 ;
"RTN","SAMIHOM4",221,0)
 ; test for duplicate icn
"RTN","SAMIHOM4",222,0)
 ;
"RTN","SAMIHOM4",223,0)
 n icn s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",224,0)
 i icn'="" i $$DUPICN(icn) d  ;
"RTN","SAMIHOM4",225,0)
 . s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate ICN error. A person with that ICN is already entered in the system."
"RTN","SAMIHOM4",226,0)
 . s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",227,0)
 ;
"RTN","SAMIHOM4",228,0)
 ; test for wellformed ICN
"RTN","SAMIHOM4",229,0)
 ;
"RTN","SAMIHOM4",230,0)
 i icn'="" i $$BADICN(icn) d  ;
"RTN","SAMIHOM4",231,0)
 . s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Invalid ICN error. The check digits in the ICN do not match"
"RTN","SAMIHOM4",232,0)
 . s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",233,0)
 ;
"RTN","SAMIHOM4",234,0)
 ; if there is an error, send back to edit with error message
"RTN","SAMIHOM4",235,0)
 i $g(SAMIARG("errorMessage"))'="" d  q  ;
"RTN","SAMIHOM4",236,0)
 . n form
"RTN","SAMIHOM4",237,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",238,0)
 . d RTNERR(.SAMIRESULT,form,.SAMIARG)
"RTN","SAMIHOM4",239,0)
 ;
"RTN","SAMIHOM4",240,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",241,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",242,0)
 n ptlkien s ptlkien=""
"RTN","SAMIHOM4",243,0)
 n dfn s dfn=""
"RTN","SAMIHOM4",244,0)
 n sien s sien=""
"RTN","SAMIHOM4",245,0)
 i ptlkien="" s ptlkien=$o(@root@("AAAAAA"),-1)+1
"RTN","SAMIHOM4",246,0)
 n zm
"RTN","SAMIHOM4",247,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",248,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",249,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",250,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",251,0)
 d MKPTLK(ptlkien,.SAMIARG) ; make the patient-lookup record
"RTN","SAMIHOM4",252,0)
 ;
"RTN","SAMIHOM4",253,0)
 s dfn=$o(@root@("dfn"," "),-1)+1
"RTN","SAMIHOM4",254,0)
 i dfn<9000001 s dfn=9000001
"RTN","SAMIHOM4",255,0)
 s @root@(ptlkien,"dfn")=dfn
"RTN","SAMIHOM4",256,0)
 d INDXPTLK(ptlkien)
"RTN","SAMIHOM4",257,0)
 s SAMIFILTER("samiroute")="addperson"
"RTN","SAMIHOM4",258,0)
 d SETINFO(.SAMIFILTER,name_" was successfully entered")
"RTN","SAMIHOM4",259,0)
 ;d SETWARN(.SAMIFILTER,"We might want to give you a warning")
"RTN","SAMIHOM4",260,0)
 do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIARG,.SAMIRESULT)
"RTN","SAMIHOM4",261,0)
 q
"RTN","SAMIHOM4",262,0)
 ;
"RTN","SAMIHOM4",263,0)
MKPTLK(ptlkien,SAMIARG) ; creates the patient-lookup record
"RTN","SAMIHOM4",264,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",265,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",266,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",267,0)
 n sinamef,sinamel
"RTN","SAMIHOM4",268,0)
 s sinamel=$p(name,","),sinamel=$$TRIM^XLFSTR(sinamel,"LR")
"RTN","SAMIHOM4",269,0)
 s sinamef=$p(name,",",2),sinamef=$$TRIM^XLFSTR(sinamef,"LR")
"RTN","SAMIHOM4",270,0)
 s name=sinamel_","_sinamef
"RTN","SAMIHOM4",271,0)
 s @root@(ptlkien,"saminame")=name
"RTN","SAMIHOM4",272,0)
 s @root@(ptlkien,"sinamef")=sinamef
"RTN","SAMIHOM4",273,0)
 s @root@(ptlkien,"sinamel")=sinamel
"RTN","SAMIHOM4",274,0)
 n fmdob s fmdob=$$FMDT^SAMIUR2(SAMIARG("dob"))
"RTN","SAMIHOM4",275,0)
 n ptlkdob s ptlkdob=$$FMTE^XLFDT(fmdob,7)
"RTN","SAMIHOM4",276,0)
 s ptlkdob=$TR(ptlkdob,"/","-")
"RTN","SAMIHOM4",277,0)
 s @root@(ptlkien,"dob")=ptlkdob
"RTN","SAMIHOM4",278,0)
 s @root@(ptlkien,"sbdob")=ptlkdob
"RTN","SAMIHOM4",279,0)
 n gender s gender=SAMIARG("gender")
"RTN","SAMIHOM4",280,0)
 s @root@(ptlkien,"gender")=$s(gender="M":"M^MALE",1:"F^FEMALE")
"RTN","SAMIHOM4",281,0)
 s @root@(ptlkien,"sex")=SAMIARG("gender")
"RTN","SAMIHOM4",282,0)
 s @root@(ptlkien,"icn")=SAMIARG("icn")
"RTN","SAMIHOM4",283,0)
 s @root@(ptlkien,"ssn")=ssn
"RTN","SAMIHOM4",284,0)
 n last5 s last5=$$UCASE($e(name,1))_$e(ssn,6,9)
"RTN","SAMIHOM4",285,0)
 s @root@(ptlkien,"last5")=last5
"RTN","SAMIHOM4",286,0)
 n mymatch s mymatch=$g(SAMIARG("MATCHLOG"))
"RTN","SAMIHOM4",287,0)
 i mymatch'="" s @root@(ptlkien,"MATCHLOG")=mymatch
"RTN","SAMIHOM4",288,0)
 q
"RTN","SAMIHOM4",289,0)
 ;
"RTN","SAMIHOM4",290,0)
UPDTFRMS(dfn) ; update demographics in all patient forms for patient dfn
"RTN","SAMIHOM4",291,0)
 ;
"RTN","SAMIHOM4",292,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",293,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",294,0)
 n lien s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM4",295,0)
 q:lien=""
"RTN","SAMIHOM4",296,0)
 n pien s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIHOM4",297,0)
 q:pien=""
"RTN","SAMIHOM4",298,0)
 ; this patient has forms
"RTN","SAMIHOM4",299,0)
 m @proot@(pien)=@lroot@(lien) ; refresh the demos in the patient record
"RTN","SAMIHOM4",300,0)
 n ssn s ssn=$g(@proot@(pien,"ssn"))
"RTN","SAMIHOM4",301,0)
 s @proot@(pien,"sissn")=$e(ssn,1,3)_"-"_$e(ssn,4,5)_"-"_$e(ssn,6,9)
"RTN","SAMIHOM4",302,0)
 n sid s sid=$g(@proot@("sisid")) ; studyid 
"RTN","SAMIHOM4",303,0)
 q:sid=""  ; no studyid
"RTN","SAMIHOM4",304,0)
 n zi s zi=""
"RTN","SAMIHOM4",305,0)
 f  s zi=$o(@proot@("graph",sid,zi)) q:zi=""  d  ; for each form
"RTN","SAMIHOM4",306,0)
 . m @proot@("graph",sid,zi)=@proot@(pien) ; stamp each form with new demos
"RTN","SAMIHOM4",307,0)
 q
"RTN","SAMIHOM4",308,0)
 ;
"RTN","SAMIHOM4",309,0)
MERGE(SAMIRESULT,SAMIARGS) ; merge participant records
"RTN","SAMIHOM4",310,0)
 ; called from pressing the merge button on the unmatched report
"RTN","SAMIHOM4",311,0)
 n toien s toien=$g(SAMIARGS("toien"))
"RTN","SAMIHOM4",312,0)
 i toien="" d  q  ;
"RTN","SAMIHOM4",313,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",314,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",315,0)
 n fromien s fromien=$g(@lroot@(toien,"MATCHLOG"))
"RTN","SAMIHOM4",316,0)
 i fromien="" d  q  ;
"RTN","SAMIHOM4",317,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",318,0)
 ;
"RTN","SAMIHOM4",319,0)
 ; test for remotedfn in from record - not valid if absent
"RTN","SAMIHOM4",320,0)
 ;
"RTN","SAMIHOM4",321,0)
 i $g(@lroot@(fromien,"remotedfn"))="" d  q  ;
"RTN","SAMIHOM4",322,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",323,0)
 ;
"RTN","SAMIHOM4",324,0)
 ; remove index entries for from and to records
"RTN","SAMIHOM4",325,0)
 ;
"RTN","SAMIHOM4",326,0)
 d UNINDXPT(fromien) ; delete index entries
"RTN","SAMIHOM4",327,0)
 d UNINDXPT(toien)
"RTN","SAMIHOM4",328,0)
 ;
"RTN","SAMIHOM4",329,0)
 ; create changelog entry in to record - contains from record
"RTN","SAMIHOM4",330,0)
 ;
"RTN","SAMIHOM4",331,0)
 m @lroot@(toien,"changelog",$$FMTE^XLFDT($$NOW^XLFDT,5))=@lroot@(fromien)
"RTN","SAMIHOM4",332,0)
 ;
"RTN","SAMIHOM4",333,0)
 ; change the dfn in the from record to the to record dfn for merging
"RTN","SAMIHOM4",334,0)
 ;
"RTN","SAMIHOM4",335,0)
 s @lroot@(fromien,"dfn")=@lroot@(toien,"dfn")
"RTN","SAMIHOM4",336,0)
 n dfn s dfn=@lroot@(toien,"dfn") ; for use in updating forms
"RTN","SAMIHOM4",337,0)
 ;
"RTN","SAMIHOM4",338,0)
 ; merge the from record to the to record
"RTN","SAMIHOM4",339,0)
 ;
"RTN","SAMIHOM4",340,0)
 m @lroot@(toien)=@lroot@(fromien)
"RTN","SAMIHOM4",341,0)
 ;
"RTN","SAMIHOM4",342,0)
 ; delete the from record
"RTN","SAMIHOM4",343,0)
 ;
"RTN","SAMIHOM4",344,0)
 k @lroot@(fromien)
"RTN","SAMIHOM4",345,0)
 ;
"RTN","SAMIHOM4",346,0)
 ; reindex the to record
"RTN","SAMIHOM4",347,0)
 ;
"RTN","SAMIHOM4",348,0)
 d INDXPTLK(toien)
"RTN","SAMIHOM4",349,0)
 ;
"RTN","SAMIHOM4",350,0)
 ; propagate the updated from record to every form
"RTN","SAMIHOM4",351,0)
 ;
"RTN","SAMIHOM4",352,0)
 d UPDTFRMS(dfn) ; updates the patient in the vapals-patient graph
"RTN","SAMIHOM4",353,0)
 ;
"RTN","SAMIHOM4",354,0)
 ; leave and return to the unmatched report
"RTN","SAMIHOM4",355,0)
 ;   note that the form and to records will no longer be in the report
"RTN","SAMIHOM4",356,0)
 ;
"RTN","SAMIHOM4",357,0)
 d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",358,0)
 ;
"RTN","SAMIHOM4",359,0)
 q
"RTN","SAMIHOM4",360,0)
 ;
"RTN","SAMIHOM4",361,0)
ADDUNMAT ; adds the unmatched report web service to the system
"RTN","SAMIHOM4",362,0)
 ;
"RTN","SAMIHOM4",363,0)
 d addService^%webutils("GET","unmatched","WSUNMAT^SAMIHOM4")
"RTN","SAMIHOM4",364,0)
 q
"RTN","SAMIHOM4",365,0)
 ;
"RTN","SAMIHOM4",366,0)
DELUNMAT ; deletes the unmatched web service
"RTN","SAMIHOM4",367,0)
 ;
"RTN","SAMIHOM4",368,0)
 d deleteService^%webutils("GET","unmatched")
"RTN","SAMIHOM4",369,0)
 q
"RTN","SAMIHOM4",370,0)
 ;
"RTN","SAMIHOM4",371,0)
WSUNMAT(SAMIRESULT,SAMIARGS) ; navigates to unmatched report
"RTN","SAMIHOM4",372,0)
 ; 
"RTN","SAMIHOM4",373,0)
 n filter,bdy
"RTN","SAMIHOM4",374,0)
 s bdy=""
"RTN","SAMIHOM4",375,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",376,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",377,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",378,0)
 q
"RTN","SAMIHOM4",379,0)
 ;
"RTN","SAMIHOM4",380,0)
DUPSSN(ssn) ; extrinsic returns true if duplicate ssn
"RTN","SAMIHOM4",381,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",382,0)
 i $d(@proot@("ssn",ssn)) q 1
"RTN","SAMIHOM4",383,0)
 q 0
"RTN","SAMIHOM4",384,0)
 ;
"RTN","SAMIHOM4",385,0)
DUPICN(icn) ; extrinsic returns true if duplicate icn
"RTN","SAMIHOM4",386,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",387,0)
 n tmpicn s tmpicn=$p(icn,"V",1)
"RTN","SAMIHOM4",388,0)
 i $d(@proot@("icn",icn)) q 1
"RTN","SAMIHOM4",389,0)
 i $d(@proot@("icn",tmpicn)) q 1
"RTN","SAMIHOM4",390,0)
 q 0
"RTN","SAMIHOM4",391,0)
 ;
"RTN","SAMIHOM4",392,0)
BADICN(icn) ; extrinsic returns true if ICN checkdigits are wrong
"RTN","SAMIHOM4",393,0)
 n zchk s zchk=$p(icn,"V",2)
"RTN","SAMIHOM4",394,0)
 n zicn s zicn=$p(icn,"V",1)
"RTN","SAMIHOM4",395,0)
 q:zchk="" 1
"RTN","SAMIHOM4",396,0)
 i zchk'=$$CHECKDG^MPIFSPC(zicn) q 1
"RTN","SAMIHOM4",397,0)
 q 0
"RTN","SAMIHOM4",398,0)
 ;
"RTN","SAMIHOM4",399,0)
SAVE(SAMIRESULT,SAMIARG) ; save patient-lookup record after edit
"RTN","SAMIHOM4",400,0)
 ;
"RTN","SAMIHOM4",401,0)
 n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",402,0)
 i dfn="" d  q  ;
"RTN","SAMIHOM4",403,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",404,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",405,0)
 n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",406,0)
 i sien="" d  q  ;
"RTN","SAMIHOM4",407,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",408,0)
 d UNINDXPT(sien) ; remove old index entries
"RTN","SAMIHOM4",409,0)
 n zm
"RTN","SAMIHOM4",410,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",411,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",412,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",413,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",414,0)
 d MKPTLK(sien,.SAMIARG) ; add the updated fields
"RTN","SAMIHOM4",415,0)
 d INDXPTLK(sien) ; create new index entries
"RTN","SAMIHOM4",416,0)
 d UPDTFRMS(dfn) ; update demographic info in all forms
"RTN","SAMIHOM4",417,0)
 n filter,bdy
"RTN","SAMIHOM4",418,0)
 s bdy=""
"RTN","SAMIHOM4",419,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",420,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",421,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",422,0)
 q
"RTN","SAMIHOM4",423,0)
 ;
"RTN","SAMIHOM4",424,0)
REMATCH(sien,SAMIARG) ; extrinsic returns a possible match ien
"RTN","SAMIHOM4",425,0)
 ; else zero
"RTN","SAMIHOM4",426,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",427,0)
 n ssn,name,icn,x,y
"RTN","SAMIHOM4",428,0)
 s ssn=$g(SAMIARG("ssn"))
"RTN","SAMIHOM4",429,0)
 i ssn["-" s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",430,0)
 s name=$g(SAMIARG("saminame"))
"RTN","SAMIHOM4",431,0)
 i name="" s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",432,0)
 s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",433,0)
 s x=0
"RTN","SAMIHOM4",434,0)
 i ssn'="" s x=$o(@lroot@("ssn",ssn,""))
"RTN","SAMIHOM4",435,0)
 i x=sien s x=$o(@lroot@("ssn",ssn,x))
"RTN","SAMIHOM4",436,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",437,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",438,0)
 . i y>9000000 s x=0
"RTN","SAMIHOM4",439,0)
 i x>0 q x
"RTN","SAMIHOM4",440,0)
 i name'="" s x=$o(@lroot@("name",name,""))
"RTN","SAMIHOM4",441,0)
 i x=sien s x=$o(@lroot@("name",name,x))
"RTN","SAMIHOM4",442,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",443,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",444,0)
 . i y>9000000 s x=0
"RTN","SAMIHOM4",445,0)
 i x>0 q x
"RTN","SAMIHOM4",446,0)
 ;i icn'="" s x=$o(@lroot@("icn",icn,""))
"RTN","SAMIHOM4",447,0)
 ;i x=sien s x=$o(@lroot@("icn",icn,x))
"RTN","SAMIHOM4",448,0)
 ;i +x'=0 d  ;
"RTN","SAMIHOM4",449,0)
 ;. s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",450,0)
 ;. i y>9000000 s x=0
"RTN","SAMIHOM4",451,0)
 ;i x>0 q x
"RTN","SAMIHOM4",452,0)
 q 0
"RTN","SAMIHOM4",453,0)
 ;
"RTN","SAMIHOM4",454,0)
SETINFO(vars,msg) ; set the information message text
"RTN","SAMIHOM4",455,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",456,0)
 s vars("infoMessage")=msg
"RTN","SAMIHOM4",457,0)
 q
"RTN","SAMIHOM4",458,0)
 ;
"RTN","SAMIHOM4",459,0)
SETWARN(vars,msg) ; set warning message text
"RTN","SAMIHOM4",460,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",461,0)
 s vars("warnMessage")=msg
"RTN","SAMIHOM4",462,0)
 q
"RTN","SAMIHOM4",463,0)
 ; 
"RTN","SAMIHOM4",464,0)
RTNERR(rtn,form,vals,msg,fld) ; redisplays a page with an error message
"RTN","SAMIHOM4",465,0)
 ; rtn is the return array
"RTN","SAMIHOM4",466,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",467,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",468,0)
 ; msg is the error message to be displayed
"RTN","SAMIHOM4",469,0)
 ; fld is the name of the field where the cursor should be put
"RTN","SAMIHOM4",470,0)
 ;
"RTN","SAMIHOM4",471,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",472,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",473,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",474,0)
 m SAMIRESULT=zhtml
"RTN","SAMIHOM4",475,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",476,0)
 q
"RTN","SAMIHOM4",477,0)
 ;
"RTN","SAMIHOM4",478,0)
RTNPAGE(rtn,form,vals) ; displays a page
"RTN","SAMIHOM4",479,0)
 ; rtn is the return array
"RTN","SAMIHOM4",480,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",481,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",482,0)
 ;
"RTN","SAMIHOM4",483,0)
 n err
"RTN","SAMIHOM4",484,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",485,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",486,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",487,0)
 m SAMIRESULT=zhtml
"RTN","SAMIHOM4",488,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",489,0)
 q
"RTN","SAMIHOM4",490,0)
 ;
"RTN","SAMIHOM4",491,0)
REINDXPL ; reindex patient lookup
"RTN","SAMIHOM4",492,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",493,0)
 n zi s zi=0
"RTN","SAMIHOM4",494,0)
 k @root@("ssn")
"RTN","SAMIHOM4",495,0)
 k @root@("name")
"RTN","SAMIHOM4",496,0)
 k @root@("last5")
"RTN","SAMIHOM4",497,0)
 k @root@("sinamef")
"RTN","SAMIHOM4",498,0)
 k @root@("sinamel")
"RTN","SAMIHOM4",499,0)
 k @root@("icn")
"RTN","SAMIHOM4",500,0)
 f  s zi=$o(@root@(zi)) q:+zi=0  d  ;
"RTN","SAMIHOM4",501,0)
 . d INDXPTLK(zi)
"RTN","SAMIHOM4",502,0)
 q
"RTN","SAMIHOM4",503,0)
 ;
"RTN","SAMIHOM4",504,0)
INDXPTLK(ien) ; generate index entries in patient-lookup graph
"RTN","SAMIHOM4",505,0)
 ; for entry ien
"RTN","SAMIHOM4",506,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",507,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",508,0)
 s @proot@("name",name,ien)=""
"RTN","SAMIHOM4",509,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",510,0)
 s @proot@("name",ucname,ien)=""
"RTN","SAMIHOM4",511,0)
 n x
"RTN","SAMIHOM4",512,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",513,0)
 s:x'="" @proot@("dfn",x,ien)=""
"RTN","SAMIHOM4",514,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",515,0)
 s:x'="" @proot@("last5",x,ien)=""
"RTN","SAMIHOM4",516,0)
 s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",517,0)
 i x'["V" d  ;
"RTN","SAMIHOM4",518,0)
 . i x="" q
"RTN","SAMIHOM4",519,0)
 . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",520,0)
 . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",521,0)
 . s x=x_"V"_chk
"RTN","SAMIHOM4",522,0)
 s:x'="" @proot@("icn",x,ien)=""
"RTN","SAMIHOM4",523,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",524,0)
 s:x'="" @proot@("ssn",x,ien)=""
"RTN","SAMIHOM4",525,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",526,0)
 s:x'="" @proot@("sinamef",x,ien)=""
"RTN","SAMIHOM4",527,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",528,0)
 s:x'="" @proot@("sinamel",x,ien)=""
"RTN","SAMIHOM4",529,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",530,0)
 q
"RTN","SAMIHOM4",531,0)
 ;
"RTN","SAMIHOM4",532,0)
UNINDXPT(ien) ; remove index entries in patient-lookup graph
"RTN","SAMIHOM4",533,0)
 ; for entry ien
"RTN","SAMIHOM4",534,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",535,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",536,0)
 k @proot@("name",name,ien)
"RTN","SAMIHOM4",537,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",538,0)
 k @proot@("name",ucname,ien)
"RTN","SAMIHOM4",539,0)
 n x
"RTN","SAMIHOM4",540,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",541,0)
 k:x'="" @proot@("dfn",x,ien)
"RTN","SAMIHOM4",542,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",543,0)
 k:x'="" @proot@("last5",x,ien)
"RTN","SAMIHOM4",544,0)
 s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",545,0)
 i x'["V" d  ;
"RTN","SAMIHOM4",546,0)
 . i x="" q
"RTN","SAMIHOM4",547,0)
 . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",548,0)
 . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",549,0)
 . s x=x_"V"_chk
"RTN","SAMIHOM4",550,0)
 k:x'="" @proot@("icn",x,ien)
"RTN","SAMIHOM4",551,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",552,0)
 k:x'="" @proot@("ssn",x,ien)
"RTN","SAMIHOM4",553,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",554,0)
 k:x'="" @proot@("sinamef",x,ien)
"RTN","SAMIHOM4",555,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",556,0)
 k:x'="" @proot@("sinamel",x,ien)
"RTN","SAMIHOM4",557,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",558,0)
 q
"RTN","SAMIHOM4",559,0)
 ;
"RTN","SAMIHOM4",560,0)
UCASE(STR) ; extrinsic returns uppercase of STR
"RTN","SAMIHOM4",561,0)
 N X,Y
"RTN","SAMIHOM4",562,0)
 S X=STR
"RTN","SAMIHOM4",563,0)
 X ^%ZOSF("UPPERCASE")
"RTN","SAMIHOM4",564,0)
 q Y
"RTN","SAMIHOM4",565,0)
 ;
"RTN","SAMIHOM4",566,0)
DEVHOME ; temporary home page for development
"RTN","SAMIHOM4",567,0)
 ; DEVHOME^SAMIHOM3(SAMIRTN,SAMIFILTER) goto DEVHOME^SAMIHOM4
"RTN","SAMIHOM4",568,0)
 ;
"RTN","SAMIHOM4",569,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",570,0)
 ;
"RTN","SAMIHOM4",571,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",572,0)
 ;@called-by
"RTN","SAMIHOM4",573,0)
 ; WSHOME
"RTN","SAMIHOM4",574,0)
 ;@calls
"RTN","SAMIHOM4",575,0)
 ; htmltb2^%yottaweb
"RTN","SAMIHOM4",576,0)
 ; PATLIST
"RTN","SAMIHOM4",577,0)
 ; genhtml^%yottautl
"RTN","SAMIHOM4",578,0)
 ; addary^%yottautl
"RTN","SAMIHOM4",579,0)
 ;@input
"RTN","SAMIHOM4",580,0)
 ; SAMIFILTER =
"RTN","SAMIHOM4",581,0)
 ;@output
"RTN","SAMIHOM4",582,0)
 ;.SAMIRTN =
"RTN","SAMIHOM4",583,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",584,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",585,0)
 ;
"RTN","SAMIHOM4",586,0)
 ;@stanza 2 ?
"RTN","SAMIHOM4",587,0)
 ;
"RTN","SAMIHOM4",588,0)
 new gtop,gbot
"RTN","SAMIHOM4",589,0)
 do htmltb2^%yottaweb(.gtop,.gbot,"SAMI Test Patients")
"RTN","SAMIHOM4",590,0)
 ;
"RTN","SAMIHOM4",591,0)
 new html,ary,hpat
"RTN","SAMIHOM4",592,0)
 do PATLIST^SAMIHOM3("hpat")
"RTN","SAMIHOM4",593,0)
 quit:'$data(hpat)
"RTN","SAMIHOM4",594,0)
 ;
"RTN","SAMIHOM4",595,0)
 set ary("title")="SAMI Test Patients on this system"
"RTN","SAMIHOM4",596,0)
 set ary("header",1)="StudyId"
"RTN","SAMIHOM4",597,0)
 set ary("header",2)="Name"
"RTN","SAMIHOM4",598,0)
 ;
"RTN","SAMIHOM4",599,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",600,0)
 new zi set zi=""
"RTN","SAMIHOM4",601,0)
 for  set zi=$order(hpat(zi)) quit:zi=""  do  ;
"RTN","SAMIHOM4",602,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",603,0)
 . new url set url="<a href=""/cform.cgi?studyId="_zi_""">"_zi_"</a>"
"RTN","SAMIHOM4",604,0)
 . set ary(cnt,1)=url
"RTN","SAMIHOM4",605,0)
 . set ary(cnt,2)=""
"RTN","SAMIHOM4",606,0)
 . quit
"RTN","SAMIHOM4",607,0)
 ;
"RTN","SAMIHOM4",608,0)
 do genhtml^%yottautl("html","ary")
"RTN","SAMIHOM4",609,0)
 ;
"RTN","SAMIHOM4",610,0)
 do addary^%yottautl("SAMIRTN","gtop")
"RTN","SAMIHOM4",611,0)
 do addary^%yottautl("SAMIRTN","html")
"RTN","SAMIHOM4",612,0)
 set SAMIRTN($order(SAMIRTN(""),-1)+1)=gbot
"RTN","SAMIHOM4",613,0)
 kill SAMIRTN(0)
"RTN","SAMIHOM4",614,0)
 ;
"RTN","SAMIHOM4",615,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMIHOM4",616,0)
 ;
"RTN","SAMIHOM4",617,0)
 ;@stanza ? termination
"RTN","SAMIHOM4",618,0)
 ;
"RTN","SAMIHOM4",619,0)
 quit  ; end of DEVHOME
"RTN","SAMIHOM4",620,0)
 ;
"RTN","SAMIHOM4",621,0)
 ;
"RTN","SAMIHOM4",622,0)
GETHOME ; homepage accessed using GET
"RTN","SAMIHOM4",623,0)
 ; GETHOME^SAMIHOM3(SAMIRTN,SAMIFILTER) goto GETHOME^SAMIHOM4
"RTN","SAMIHOM4",624,0)
 ;
"RTN","SAMIHOM4",625,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",626,0)
 ;
"RTN","SAMIHOM4",627,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",628,0)
 ;@called-by
"RTN","SAMIHOM4",629,0)
 ; WSHOME
"RTN","SAMIHOM4",630,0)
 ; WSNEWCAS
"RTN","SAMIHOM4",631,0)
 ; WSNFPOST^SAMICASE
"RTN","SAMIHOM4",632,0)
 ; wsLookup^SAMISRCH
"RTN","SAMIHOM4",633,0)
 ;@calls
"RTN","SAMIHOM4",634,0)
 ; GETTMPL^SAMICASE
"RTN","SAMIHOM4",635,0)
 ; findReplace^%ts
"RTN","SAMIHOM4",636,0)
 ; $$SCANFOR
"RTN","SAMIHOM4",637,0)
 ; ADDCRLF^VPRJRUT
"RTN","SAMIHOM4",638,0)
 ;@input
"RTN","SAMIHOM4",639,0)
 ; SAMIFILTER =
"RTN","SAMIHOM4",640,0)
 ;@output
"RTN","SAMIHOM4",641,0)
 ;.SAMIRTN =
"RTN","SAMIHOM4",642,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",643,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",644,0)
 ;
"RTN","SAMIHOM4",645,0)
 ;@stanza 2 get template for homepage
"RTN","SAMIHOM4",646,0)
 ;
"RTN","SAMIHOM4",647,0)
 new temp,tout
"RTN","SAMIHOM4",648,0)
 do GETTMPL^SAMICASE("temp","vapals:home")
"RTN","SAMIHOM4",649,0)
 quit:'$data(temp)
"RTN","SAMIHOM4",650,0)
 ;
"RTN","SAMIHOM4",651,0)
 ;@stanza 3 process homepage template
"RTN","SAMIHOM4",652,0)
 ;
"RTN","SAMIHOM4",653,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",654,0)
 new zi set zi=0
"RTN","SAMIHOM4",655,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMIHOM4",656,0)
 . ;
"RTN","SAMIHOM4",657,0)
 . n ln s ln=temp(zi)
"RTN","SAMIHOM4",658,0)
 . n touched s touched=0
"RTN","SAMIHOM4",659,0)
 . ;
"RTN","SAMIHOM4",660,0)
 . i ln["href" i 'touched d  ;
"RTN","SAMIHOM4",661,0)
 . . d FIXHREF^SAMIFORM(.ln)
"RTN","SAMIHOM4",662,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",663,0)
 . ;
"RTN","SAMIHOM4",664,0)
 . i ln["src" d  ;
"RTN","SAMIHOM4",665,0)
 . . d FIXSRC^SAMIFORM(.ln)
"RTN","SAMIHOM4",666,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",667,0)
 . ;
"RTN","SAMIHOM4",668,0)
 . i ln["id" i ln["studyIdMenu" d  ;
"RTN","SAMIHOM4",669,0)
 . . s zi=zi+4
"RTN","SAMIHOM4",670,0)
 . ;
"RTN","SAMIHOM4",671,0)
 . if ln["@@MANUALREGISTRATION@@" do  ; turn off manual registration
"RTN","SAMIHOM4",672,0)
 . . n setman,setparm
"RTN","SAMIHOM4",673,0)
 . . s setman="true"
"RTN","SAMIHOM4",674,0)
 . . s setparm=$$GET^XPAR("SYS","SAMI ALLOW MANUAL ENTRY",,"Q")
"RTN","SAMIHOM4",675,0)
 . . i setparm=0 s setman="false"
"RTN","SAMIHOM4",676,0)
 . . do findReplace^%ts(.ln,"@@MANUALREGISTRATION@@",setman)
"RTN","SAMIHOM4",677,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",678,0)
 . . quit 
"RTN","SAMIHOM4",679,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",680,0)
 . set tout(cnt)=temp(zi)
"RTN","SAMIHOM4",681,0)
 . quit
"RTN","SAMIHOM4",682,0)
 ;
"RTN","SAMIHOM4",683,0)
 ;@stanza 4 add cr/lf & save to return array
"RTN","SAMIHOM4",684,0)
 ;
"RTN","SAMIHOM4",685,0)
 do ADDCRLF^VPRJRUT(.tout)
"RTN","SAMIHOM4",686,0)
 merge SAMIRTN=tout
"RTN","SAMIHOM4",687,0)
 ;
"RTN","SAMIHOM4",688,0)
 ;@stanza 5 termination
"RTN","SAMIHOM4",689,0)
 ;
"RTN","SAMIHOM4",690,0)
 quit  ; end of GETHOME
"RTN","SAMIHOM4",691,0)
 ;
"RTN","SAMIHOM4",692,0)
 ;
"RTN","SAMIHOM4",693,0)
WSNEWCAS ; receives post from home & creates new case
"RTN","SAMIHOM4",694,0)
 ; WSNEWCAS^SAMIHOM3(SAMIARGS,SAMIBODY,SAMIRESULT) goto WSNEWCAS^SAMIHOM4
"RTN","SAMIHOM4",695,0)
 ;
"RTN","SAMIHOM4",696,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",697,0)
 ;
"RTN","SAMIHOM4",698,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",699,0)
 ;@called-by
"RTN","SAMIHOM4",700,0)
 ;@calls
"RTN","SAMIHOM4",701,0)
 ; parseBody^%wf
"RTN","SAMIHOM4",702,0)
 ; $$setroot^%wd
"RTN","SAMIHOM4",703,0)
 ; $$NEXTNUM
"RTN","SAMIHOM4",704,0)
 ; $$GENSTDID^SAMIHOM3
"RTN","SAMIHOM4",705,0)
 ; $$NOW^XLFDT
"RTN","SAMIHOM4",706,0)
 ; $$KEYDATE^SAMIHOM3
"RTN","SAMIHOM4",707,0)
 ; $$VALDTNM
"RTN","SAMIHOM4",708,0)
 ; GETHOME
"RTN","SAMIHOM4",709,0)
 ; PREFILL
"RTN","SAMIHOM4",710,0)
 ; MKSBFORM
"RTN","SAMIHOM4",711,0)
 ; MKSIFORM^SAMIHOM3
"RTN","SAMIHOM4",712,0)
 ; WSCASE^SAMICASE
"RTN","SAMIHOM4",713,0)
 ;@input
"RTN","SAMIHOM4",714,0)
 ;.ARGS =
"RTN","SAMIHOM4",715,0)
 ; BODY =
"RTN","SAMIHOM4",716,0)
 ;.RESULT =
"RTN","SAMIHOM4",717,0)
 ;@output: ?
"RTN","SAMIHOM4",718,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",719,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",720,0)
 ;
"RTN","SAMIHOM4",721,0)
 ;@stanza 2 ?
"RTN","SAMIHOM4",722,0)
 ;
"RTN","SAMIHOM4",723,0)
 merge ^SAMIUL("newCase","ARGS")=SAMIARGS
"RTN","SAMIHOM4",724,0)
 merge ^SAMIUL("newCase","BODY")=SAMIBODY
"RTN","SAMIHOM4",725,0)
 ;
"RTN","SAMIHOM4",726,0)
 new vars,bdy
"RTN","SAMIHOM4",727,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",728,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",729,0)
 merge ^SAMIUL("newCase","vars")=vars
"RTN","SAMIHOM4",730,0)
 ;
"RTN","SAMIHOM4",731,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",732,0)
 ;
"RTN","SAMIHOM4",733,0)
 new saminame set saminame=$get(vars("name"))
"RTN","SAMIHOM4",734,0)
 if saminame="" s saminame=$get(vars("saminame"))
"RTN","SAMIHOM4",735,0)
 ;if $$VALDTNM(saminame,.ARGS)=-1 do  quit  ;
"RTN","SAMIHOM4",736,0)
 ;. new r1
"RTN","SAMIHOM4",737,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",738,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",739,0)
 ;. quit
"RTN","SAMIHOM4",740,0)
 ;
"RTN","SAMIHOM4",741,0)
 new dfn s dfn=$get(vars("dfn"))
"RTN","SAMIHOM4",742,0)
 ;if dfn="" do  quit  ;
"RTN","SAMIHOM4",743,0)
 ;. new r1
"RTN","SAMIHOM4",744,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",745,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",746,0)
 ;. quit
"RTN","SAMIHOM4",747,0)
 ;
"RTN","SAMIHOM4",748,0)
 ;new gien set gien=$$NEXTNUM
"RTN","SAMIHOM4",749,0)
 new gien set gien=dfn
"RTN","SAMIHOM4",750,0)
 ;
"RTN","SAMIHOM4",751,0)
 m ^SAMIUL("newCase","G1")=root
"RTN","SAMIHOM4",752,0)
 ; create dfn index
"RTN","SAMIHOM4",753,0)
 set @root@("dfn",dfn,gien)=""
"RTN","SAMIHOM4",754,0)
 ;
"RTN","SAMIHOM4",755,0)
 set @root@(gien,"saminum")=gien
"RTN","SAMIHOM4",756,0)
 set @root@(gien,"saminame")=saminame
"RTN","SAMIHOM4",757,0)
 ;
"RTN","SAMIHOM4",758,0)
 new studyid set studyid=$$GENSTDID^SAMIHOM3(gien)
"RTN","SAMIHOM4",759,0)
 set @root@(gien,"samistudyid")=studyid
"RTN","SAMIHOM4",760,0)
 set @root@("sid",studyid,gien)=""
"RTN","SAMIHOM4",761,0)
 ;
"RTN","SAMIHOM4",762,0)
 new datekey set datekey=$$KEYDATE^SAMIHOM3($$NOW^XLFDT)
"RTN","SAMIHOM4",763,0)
 set @root@(gien,"samicreatedate")=datekey
"RTN","SAMIHOM4",764,0)
 ;
"RTN","SAMIHOM4",765,0)
 merge ^SAMIUL("newCase",gien)=@root@(gien)
"RTN","SAMIHOM4",766,0)
 ;
"RTN","SAMIHOM4",767,0)
 ;
"RTN","SAMIHOM4",768,0)
 do PREFILL^SAMIHOM3(dfn) ; prefills from the "patient-lookup" graph
"RTN","SAMIHOM4",769,0)
 ;
"RTN","SAMIHOM4",770,0)
 n siformkey
"RTN","SAMIHOM4",771,0)
 ;do makeSbform(gien) ; create a background form for new patient
"RTN","SAMIHOM4",772,0)
 set siformkey=$$MKSIFORM^SAMIHOM3(gien) ; create an intake for for new patient
"RTN","SAMIHOM4",773,0)
 ;
"RTN","SAMIHOM4",774,0)
 set SAMIARGS("studyid")=studyid
"RTN","SAMIHOM4",775,0)
 set SAMIARGS("form")="vapals:"_siformkey
"RTN","SAMIHOM4",776,0)
 do wsGetForm^%wf(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",777,0)
 ;do WSCASE^SAMICASE(.SAMIRESULT,.SAMIARGS) ; navigate to the case review page
"RTN","SAMIHOM4",778,0)
 ;
"RTN","SAMIHOM4",779,0)
 ;@stanza ? termination
"RTN","SAMIHOM4",780,0)
 ;
"RTN","SAMIHOM4",781,0)
 quit  ; end of WSNEWCAS
"RTN","SAMIHOM4",782,0)
 ;
"RTN","SAMIHOM4",783,0)
 ;
"RTN","SAMIHOM4",784,0)
EOR ; End of routine SAMIHOM4
"RTN","SAMINOT2")
0^4^B55754036
"RTN","SAMINOT2",1,0)
SAMINOT2 ;ven/gpl - followup form notes ; 5/7/19 4:48pm
"RTN","SAMINOT2",2,0)
 ;;18.0;SAMI;;;Build 1
"RTN","SAMINOT2",3,0)
 ;
"RTN","SAMINOT2",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMINOT2",5,0)
 ;
"RTN","SAMINOT2",6,0)
 quit  ; no entry from top
"RTN","SAMINOT2",7,0)
 ;
"RTN","SAMINOT2",8,0)
WSNOTE(return,filter) ; web service which returns a text note
"RTN","SAMINOT2",9,0)
 ;
"RTN","SAMINOT2",10,0)
 n debug s debug=0
"RTN","SAMINOT2",11,0)
 i $g(filter("debug"))=1 s debug=1
"RTN","SAMINOT2",12,0)
 ;
"RTN","SAMINOT2",13,0)
 k return
"RTN","SAMINOT2",14,0)
 s HTTPRSP("mime")="text/html"
"RTN","SAMINOT2",15,0)
 ;
"RTN","SAMINOT2",16,0)
 n si
"RTN","SAMINOT2",17,0)
 s si=$g(filter("studyid"))
"RTN","SAMINOT2",18,0)
 i si="" d  ;
"RTN","SAMINOT2",19,0)
 . s si="XXX00333"
"RTN","SAMINOT2",20,0)
 q:si=""
"RTN","SAMINOT2",21,0)
 ;
"RTN","SAMINOT2",22,0)
 n samikey
"RTN","SAMINOT2",23,0)
 s samikey=$g(filter("form"))
"RTN","SAMINOT2",24,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",25,0)
 i samikey="" d  ;
"RTN","SAMINOT2",26,0)
 . s samikey=$o(@root@("graph",si,"siform"))
"RTN","SAMINOT2",27,0)
 . ;w !,samikey
"RTN","SAMINOT2",28,0)
 . ;b
"RTN","SAMINOT2",29,0)
 ;
"RTN","SAMINOT2",30,0)
 n vals
"RTN","SAMINOT2",31,0)
 m vals=@root@("graph",si,samikey)
"RTN","SAMINOT2",32,0)
 ;
"RTN","SAMINOT2",33,0)
 n note,nien,ntype
"RTN","SAMINOT2",34,0)
 s ntype=""
"RTN","SAMINOT2",35,0)
 s note=""
"RTN","SAMINOT2",36,0)
 s nien=$g(filter("nien"))
"RTN","SAMINOT2",37,0)
 i nien="" d
"RTN","SAMINOT2",38,0)
 . s:$g(vals("samistatus"))="complete" ntype="intake"
"RTN","SAMINOT2",39,0)
 . s:$g(vals("samistatus"))="chart-eligibility" ntype="eligibility"
"RTN","SAMINOT2",40,0)
 . s:$g(vals("samistatus"))="pre-enrollment-discussion" ntype="pre-note"
"RTN","SAMINOT2",41,0)
 . q:ntype=""
"RTN","SAMINOT2",42,0)
 . ;d nien=$$NTTYPE add code to pull the latest note by type
"RTN","SAMINOT2",43,0)
 q:nien=""
"RTN","SAMINOT2",44,0)
 n notebase
"RTN","SAMINOT2",45,0)
 s notebase=$$NTLOCN(si,samikey,nien) ; global location for the note
"RTN","SAMINOT2",46,0)
 s note=$na(@notebase@("text"))
"RTN","SAMINOT2",47,0)
 i '$d(@note) q
"RTN","SAMINOT2",48,0)
 ;
"RTN","SAMINOT2",49,0)
 new temp,tout
"RTN","SAMINOT2",50,0)
 do GETTMPL^SAMICASE("temp","vapals:note")
"RTN","SAMINOT2",51,0)
 quit:'$data(temp)
"RTN","SAMINOT2",52,0)
 ;
"RTN","SAMINOT2",53,0)
 n cnt s cnt=0
"RTN","SAMINOT2",54,0)
 n zi s zi=""
"RTN","SAMINOT2",55,0)
 ;
"RTN","SAMINOT2",56,0)
 f  s zi=$o(temp(zi)) q:zi=""  d  ;
"RTN","SAMINOT2",57,0)
 . ;
"RTN","SAMINOT2",58,0)
 . n line s line=temp(zi)
"RTN","SAMINOT2",59,0)
 . D LOAD^SAMIFORM(.line,samikey,si,.filter,.vals)
"RTN","SAMINOT2",60,0)
 . s temp(zi)=line
"RTN","SAMINOT2",61,0)
 . ;
"RTN","SAMINOT2",62,0)
 . s cnt=cnt+1
"RTN","SAMINOT2",63,0)
 . s tout(cnt)=temp(zi)
"RTN","SAMINOT2",64,0)
 . ;
"RTN","SAMINOT2",65,0)
 . i temp(zi)["report-text" d  ;
"RTN","SAMINOT2",66,0)
 . . i temp(zi)["#" q  ;
"RTN","SAMINOT2",67,0)
 . . n zj s zj=""
"RTN","SAMINOT2",68,0)
 . . f  s zj=$o(@note@(zj)) q:zj=""  d  ;
"RTN","SAMINOT2",69,0)
 . . . s cnt=cnt+1
"RTN","SAMINOT2",70,0)
 . . . ;s tout(cnt)=@note@(zj)_"<br>"
"RTN","SAMINOT2",71,0)
 . . . s tout(cnt)=@note@(zj)_$char(13,10)
"RTN","SAMINOT2",72,0)
 m return=tout
"RTN","SAMINOT2",73,0)
 q
"RTN","SAMINOT2",74,0)
 ;
"RTN","SAMINOT2",75,0)
NOTE(filter) ; extrnisic which creates a note
"RTN","SAMINOT2",76,0)
 ; returns 1 if successful, 0 if not
"RTN","SAMINOT2",77,0)
 ;
"RTN","SAMINOT2",78,0)
 ;
"RTN","SAMINOT2",79,0)
 k ^gpl("funote")
"RTN","SAMINOT2",80,0)
 m ^gpl("funote")=filter
"RTN","SAMINOT2",81,0)
 ;q 0  ; while we are developing
"RTN","SAMINOT2",82,0)
 ;
"RTN","SAMINOT2",83,0)
 ; set up patient values
"RTN","SAMINOT2",84,0)
 ;
"RTN","SAMINOT2",85,0)
 n vals
"RTN","SAMINOT2",86,0)
 ;
"RTN","SAMINOT2",87,0)
 n si
"RTN","SAMINOT2",88,0)
 s si=$g(filter("studyid"))
"RTN","SAMINOT2",89,0)
 q:si="" 0
"RTN","SAMINOT2",90,0)
 ;
"RTN","SAMINOT2",91,0)
 n samikey
"RTN","SAMINOT2",92,0)
 s samikey=$g(filter("form"))
"RTN","SAMINOT2",93,0)
 q:samikey="" 0
"RTN","SAMINOT2",94,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",95,0)
 ;
"RTN","SAMINOT2",96,0)
 s vals=$na(@root@("graph",si,samikey))
"RTN","SAMINOT2",97,0)
 ;
"RTN","SAMINOT2",98,0)
 i '$d(@vals) d  q 0 ;
"RTN","SAMINOT2",99,0)
 . ;w !,"error, patient values not found"
"RTN","SAMINOT2",100,0)
 ;zwr @vals@(*)
"RTN","SAMINOT2",101,0)
 ;
"RTN","SAMINOT2",102,0)
 k ^SAMIUL("NOTE")
"RTN","SAMINOT2",103,0)
 m ^SAMIUL("NOTE","vals")=@vals
"RTN","SAMINOT2",104,0)
 m ^SAMIUL("NOTE","filter")=filter
"RTN","SAMINOT2",105,0)
 ;
"RTN","SAMINOT2",106,0)
 n didnote s didnote=0
"RTN","SAMINOT2",107,0)
 ;
"RTN","SAMINOT2",108,0)
 i $d(@vals@("notes")) d  q didnote ;
"RTN","SAMINOT2",109,0)
 . s filter("errorMessage")="Note already exists for this form."
"RTN","SAMINOT2",110,0)
 ;
"RTN","SAMINOT2",111,0)
 i $g(@vals@("futype"))="other" d  ;
"RTN","SAMINOT2",112,0)
 . i $g(@vals@("samistatus"))'="complete" q  ;
"RTN","SAMINOT2",113,0)
 . ;q:$$HASVCNT(vals)
"RTN","SAMINOT2",114,0)
 . d MKVC(si,samikey,vals,.filter) ;
"RTN","SAMINOT2",115,0)
 . s didnote=1
"RTN","SAMINOT2",116,0)
 ;
"RTN","SAMINOT2",117,0)
 i $g(@vals@("futype"))="ct" d  ;
"RTN","SAMINOT2",118,0)
 . i $g(@vals@("samistatus"))'="complete" q  ;
"RTN","SAMINOT2",119,0)
 . ;q:$$HASLCSNT(vals)
"RTN","SAMINOT2",120,0)
 . d MKLCS(si,samikey,vals,.filter) ;
"RTN","SAMINOT2",121,0)
 . s didnote=1
"RTN","SAMINOT2",122,0)
 ;
"RTN","SAMINOT2",123,0)
 ;i $g(@vals@("samistatus"))="complete" d  ;
"RTN","SAMINOT2",124,0)
 ;. q:$$HASVCNT(vals)
"RTN","SAMINOT2",125,0)
 ;. d MKVC(si,samikey,vals,.filter) ;
"RTN","SAMINOT2",126,0)
 ;. s didnote=1
"RTN","SAMINOT2",127,0)
 ;
"RTN","SAMINOT2",128,0)
 q didnote
"RTN","SAMINOT2",129,0)
 ;
"RTN","SAMINOT2",130,0)
HASINNT(vals) ; extrinsic returns 1 if intake note is present
"RTN","SAMINOT2",131,0)
 ; else returns 0
"RTN","SAMINOT2",132,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT2",133,0)
 q:'$d(@vals)
"RTN","SAMINOT2",134,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT2",135,0)
 . i $g(@vals@("notes",zzi,"name"))["Intake" s zzrtn=1
"RTN","SAMINOT2",136,0)
 q zzrtn
"RTN","SAMINOT2",137,0)
 ;
"RTN","SAMINOT2",138,0)
HASVCNT(vals) ; extrinsic returns 1 if communication note is present
"RTN","SAMINOT2",139,0)
 ; else returns 0
"RTN","SAMINOT2",140,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT2",141,0)
 q:'$d(@vals)
"RTN","SAMINOT2",142,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT2",143,0)
 . i $g(@vals@("notes",zzi,"name"))["Communication" s zzrtn=1
"RTN","SAMINOT2",144,0)
 q zzrtn
"RTN","SAMINOT2",145,0)
 ;
"RTN","SAMINOT2",146,0)
HASLCSNT(vals) ; extrinsic returns 1 if communication note is present
"RTN","SAMINOT2",147,0)
 ; else returns 0
"RTN","SAMINOT2",148,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT2",149,0)
 q:'$d(@vals)
"RTN","SAMINOT2",150,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT2",151,0)
 . i $g(@vals@("notes",zzi,"name"))["Lung" s zzrtn=1
"RTN","SAMINOT2",152,0)
 q zzrtn
"RTN","SAMINOT2",153,0)
 ;
"RTN","SAMINOT2",154,0)
MKVC(sid,form,vals,filter) ;
"RTN","SAMINOT2",155,0)
 n cnt s cnt=0
"RTN","SAMINOT2",156,0)
 ;n dest s dest=$na(@vals@("communication-note"))
"RTN","SAMINOT2",157,0)
 n dest s dest=$$MKNT(vals,"Communication Note","communication",.filter)
"RTN","SAMINOT2",158,0)
 k @dest
"RTN","SAMINOT2",159,0)
 d OUT("Veteran Communication Note")
"RTN","SAMINOT2",160,0)
 d OUT("")
"RTN","SAMINOT2",161,0)
 d VCNOTE(vals,dest,cnt)
"RTN","SAMINOT2",162,0)
 q
"RTN","SAMINOT2",163,0)
 ;
"RTN","SAMINOT2",164,0)
MKLCS(sid,form,vals,filter) ;
"RTN","SAMINOT2",165,0)
 n cnt s cnt=0
"RTN","SAMINOT2",166,0)
 ;n dest s dest=$na(@vals@("lcs-note"))
"RTN","SAMINOT2",167,0)
 n dest s dest=$$MKNT(vals,"Lung Cancer Screening Note","lcs",.filter)
"RTN","SAMINOT2",168,0)
 k @dest
"RTN","SAMINOT2",169,0)
 d OUT("Lung Screening and Surveillance Follow up Note")
"RTN","SAMINOT2",170,0)
 d OUT("")
"RTN","SAMINOT2",171,0)
 d LCSNOTE(vals,dest,cnt)
"RTN","SAMINOT2",172,0)
 q
"RTN","SAMINOT2",173,0)
 ;
"RTN","SAMINOT2",174,0)
MKNT(vals,title,ntype,filter) ; extrinsic makes a note date=now returns 
"RTN","SAMINOT2",175,0)
 ; global addr. filter must be passed by reference
"RTN","SAMINOT2",176,0)
 n ntdt s ntdt=$$NTDTTM($$NOW^XLFDT)
"RTN","SAMINOT2",177,0)
 n ntptr
"RTN","SAMINOT2",178,0)
 s ntptr=$$MKNTLOC(vals,title,ntdt,$g(ntype),.filter)
"RTN","SAMINOT2",179,0)
 q ntptr
"RTN","SAMINOT2",180,0)
 ;
"RTN","SAMINOT2",181,0)
MKNTLOC(vals,title,ndate,ntype,filter) ; extrinsic returns the 
"RTN","SAMINOT2",182,0)
 ;location for the note
"RTN","SAMINOT2",183,0)
 n nien
"RTN","SAMINOT2",184,0)
 s nien=$o(@vals@("notes",""),-1)+1
"RTN","SAMINOT2",185,0)
 s filter("nien")=nien
"RTN","SAMINOT2",186,0)
 n nloc s nloc=$na(@vals@("notes",nien))
"RTN","SAMINOT2",187,0)
 s @nloc@("name")=title_" "_$g(ndate)
"RTN","SAMINOT2",188,0)
 s @nloc@("date")=$g(ndate)
"RTN","SAMINOT2",189,0)
 s @nloc@("type")=$g(ntype)
"RTN","SAMINOT2",190,0)
 q $na(@nloc@("text"))
"RTN","SAMINOT2",191,0)
 ;
"RTN","SAMINOT2",192,0)
NTDTTM(ZFMDT) ; extrinsic returns the date and time in Note format
"RTN","SAMINOT2",193,0)
 ; ZFMDT is the fileman date/time to translate
"RTN","SAMINOT2",194,0)
 q $$FMTE^XLFDT(ZFMDT,"5")
"RTN","SAMINOT2",195,0)
 ;
"RTN","SAMINOT2",196,0)
NTLOCN(sid,form,nien) ; extrinsic returns the location of the Nth note
"RTN","SAMINOT2",197,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",198,0)
 q $na(@root@("graph",sid,form,"notes",nien))
"RTN","SAMINOT2",199,0)
 ;
"RTN","SAMINOT2",200,0)
NTLAST(sid,form,ntype) ; extrinsic returns the location of the latest note
"RTN","SAMINOT2",201,0)
 ; of the type ntype
"RTN","SAMINOT2",202,0)
 q
"RTN","SAMINOT2",203,0)
 ;
"RTN","SAMINOT2",204,0)
NTLIST(nlist,sid,form) ; returns the note list in nlist, passed by ref
"RTN","SAMINOT2",205,0)
 ;
"RTN","SAMINOT2",206,0)
 n zn,root,gn
"RTN","SAMINOT2",207,0)
 s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",208,0)
 s zn=0
"RTN","SAMINOT2",209,0)
 s gn=$na(@root@("graph",sid,form,"notes"))
"RTN","SAMINOT2",210,0)
 q:'$d(@gn)
"RTN","SAMINOT2",211,0)
 f  s zn=$o(@gn@(zn)) q:+zn=0  d  ;
"RTN","SAMINOT2",212,0)
 . s @nlist@(zn,"name")=@gn@(zn,"name")
"RTN","SAMINOT2",213,0)
 . s @nlist@(zn,"nien")=zn
"RTN","SAMINOT2",214,0)
 ;
"RTN","SAMINOT2",215,0)
 q
"RTN","SAMINOT2",216,0)
 ;
"RTN","SAMINOT2",217,0)
TLST ;
"RTN","SAMINOT2",218,0)
 S SID="XXX00677"
"RTN","SAMINOT2",219,0)
 S FORM="siform-2019-04-23"
"RTN","SAMINOT2",220,0)
 D NTLIST("G",SID,FORM)
"RTN","SAMINOT2",221,0)
 ;ZWR G
"RTN","SAMINOT2",222,0)
 Q
"RTN","SAMINOT2",223,0)
 ;
"RTN","SAMINOT2",224,0)
VCNOTE(vals,dest,cnt) ; Veteran Communication Note
"RTN","SAMINOT2",225,0)
 ;d OUT("")
"RTN","SAMINOT2",226,0)
 d OUT("Veteran was contacted via:")
"RTN","SAMINOT2",227,0)
 n sp1 s sp1="    "
"RTN","SAMINOT2",228,0)
 d:$$XVAL("fucmotip",vals) OUT(sp1_"In person")
"RTN","SAMINOT2",229,0)
 d:$$XVAL("fucmotte",vals) OUT(sp1_"Telephone")
"RTN","SAMINOT2",230,0)
 d:$$XVAL("fucmotth",vals) OUT(sp1_"TeleHealth")
"RTN","SAMINOT2",231,0)
 d:$$XVAL("fucmotml",vals) OUT(sp1_"Mailed Letter")
"RTN","SAMINOT2",232,0)
 d:$$XVAL("fucmotpp",vals) OUT(sp1_"Message in patient portal")
"RTN","SAMINOT2",233,0)
 d:$$XVAL("fucmotvd",vals) OUT(sp1_"Video-on-demand (VOD)")
"RTN","SAMINOT2",234,0)
 d:$$XVAL("fucmotot",vals) OUT(sp1_"Other: "_$$XVAL("fucmotoo",vals))
"RTN","SAMINOT2",235,0)
 d OUT("")
"RTN","SAMINOT2",236,0)
 ;
"RTN","SAMINOT2",237,0)
 d:$$XVAL("fucmotde",vals)'=""
"RTN","SAMINOT2",238,0)
 . d OUT("Communication details:")
"RTN","SAMINOT2",239,0)
 . d OUT(sp1_$$XVAL("fucmotde",vals))
"RTN","SAMINOT2",240,0)
 ;
"RTN","SAMINOT2",241,0)
 d SSTATUS(vals) ; insert smoking status section
"RTN","SAMINOT2",242,0)
 q
"RTN","SAMINOT2",243,0)
 ;
"RTN","SAMINOT2",244,0)
SSTATUS(vals)
"RTN","SAMINOT2",245,0)
 n sstat s sstat=""
"RTN","SAMINOT2",246,0)
 i $$XVAL("sisa",vals)="y" d  ; 
"RTN","SAMINOT2",247,0)
 . s sstat="Current"
"RTN","SAMINOT2",248,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT2",249,0)
 . d OUT(sp1_"Current cigarette smoker (patient advised that active tobacco use")
"RTN","SAMINOT2",250,0)
 . d OUT(sp1_"increases risk of future lung cancer, heart disease and stroke,")
"RTN","SAMINOT2",251,0)
 . d OUT(sp1_"advised stability now does not guarantee will not develop future")
"RTN","SAMINOT2",252,0)
 . d OUT(sp1_"lung cancer or risks of premature death from tobacco related heart")
"RTN","SAMINOT2",253,0)
 . d OUT(sp1_"disease and stroke)")
"RTN","SAMINOT2",254,0)
 i $$XVAL("sisa",vals)="n" d  ;
"RTN","SAMINOT2",255,0)
 . s sstat="Former"
"RTN","SAMINOT2",256,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT2",257,0)
 . n qdate s qdate=""
"RTN","SAMINOT2",258,0)
 . s qdate=$$XVAL("siq",vals)
"RTN","SAMINOT2",259,0)
 . i qdate'="" d OUT(sp1_"Former cigarette smoker. Quit date: "_qdate)
"RTN","SAMINOT2",260,0)
 . e  d OUT(sp1_"Former cigarette smoker.")
"RTN","SAMINOT2",261,0)
 i $$XVAL("sisa",vals)="o" d  ;
"RTN","SAMINOT2",262,0)
 . s sstat="Never"
"RTN","SAMINOT2",263,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT2",264,0)
 . d OUT(sp1_"Never cigarette smoker")
"RTN","SAMINOT2",265,0)
 ;
"RTN","SAMINOT2",266,0)
 n cumary
"RTN","SAMINOT2",267,0)
 d CUMPY^SAMIUR2("cumary",sid,form)
"RTN","SAMINOT2",268,0)
 k ^gpl("funote","cumary")
"RTN","SAMINOT2",269,0)
 m ^gpl("funote","cumary")=cumary
"RTN","SAMINOT2",270,0)
 n cur s cur=$g(cumary("current"))
"RTN","SAMINOT2",271,0)
 n newcum s newcum=$g(cumary("rpt",cur,4)) ; new cumulative pack years
"RTN","SAMINOT2",272,0)
 ;
"RTN","SAMINOT2",273,0)
 i $$XVAL("sisa",vals)="y" d  ;  
"RTN","SAMINOT2",274,0)
 . d OUT("Smoking history (since last visit):")
"RTN","SAMINOT2",275,0)
 . d OUT(sp1_"Cigarettes/day: "_$$XVAL("sicpd",vals))
"RTN","SAMINOT2",276,0)
 . d OUT(sp1_"PPD: "_$$XVAL("sippd",vals))
"RTN","SAMINOT2",277,0)
 . d OUT(sp1_"Current cumulative pack years: "_newcum)
"RTN","SAMINOT2",278,0)
 i $$XVAL("sisa",vals)'="y" d  ;  
"RTN","SAMINOT2",279,0)
 . d OUT("Smoking History") 
"RTN","SAMINOT2",280,0)
 n zi
"RTN","SAMINOT2",281,0)
 f zi=1:1:cur d  ;
"RTN","SAMINOT2",282,0)
 . d OUT(sp1_cumary("rpt",zi,1)_" "_cumary("rpt",zi,2))
"RTN","SAMINOT2",283,0)
 . d OUT(sp1_sp1_"Pack Years: "_cumary("rpt",zi,3))
"RTN","SAMINOT2",284,0)
 . d OUT(sp1_sp1_"Cumulative: "_cumary("rpt",zi,4))
"RTN","SAMINOT2",285,0)
 ;
"RTN","SAMINOT2",286,0)
 n tried s tried=$$XVAL("sittq",vals)
"RTN","SAMINOT2",287,0)
 n ptried s ptried=$s(tried="y":"Yes",tried="n":"No",tried="o":"Not applicable",1:"")
"RTN","SAMINOT2",288,0)
 i ptried'="" d OUT("Since your prior CT scan have you ever tried to quit smoking? "_ptried)
"RTN","SAMINOT2",289,0)
 ;
"RTN","SAMINOT2",290,0)
 n tryary,cnt
"RTN","SAMINOT2",291,0)
 s cnt=0
"RTN","SAMINOT2",292,0)
 i $$XVAL("sisca",vals)'="" s cnt=cnt+1 s tryary(cnt)="Have not tried to quit"
"RTN","SAMINOT2",293,0)
 i $$XVAL("siscb",vals)'="" s cnt=cnt+1 s tryary(cnt)="""Cold Turkey"" by completely stopping on your own with no other assistance"
"RTN","SAMINOT2",294,0)
 i $$XVAL("siscc",vals)'="" s cnt=cnt+1 s tryary(cnt)="Tapering or reducing number of cigarettes smoked per day"
"RTN","SAMINOT2",295,0)
 i $$XVAL("siscd",vals)'="" s cnt=cnt+1 s tryary(cnt)="Self-help material (e.g., brochure, cessation website)"
"RTN","SAMINOT2",296,0)
 i $$XVAL("sisce",vals)'="" s cnt=cnt+1 s tryary(cnt)="Individual consultation or cessation counseling"
"RTN","SAMINOT2",297,0)
 i $$XVAL("siscf",vals)'="" s cnt=cnt+1 s tryary(cnt)="Telephone cessation counseling hotline (e.g., 1-855-QUIT-VET, 1-800-QUIT-NOW)"
"RTN","SAMINOT2",298,0)
 i $$XVAL("siscg",vals)'="" s cnt=cnt+1 s tryary(cnt)="Peer support (e.g., Nicotine Anonymous)"
"RTN","SAMINOT2",299,0)
 i $$XVAL("sisch",vals)'="" s cnt=cnt+1 s tryary(cnt)="Nicotine replacement therapy (e.g., patch, gum, inhaler, nasal spray, lozenge)"
"RTN","SAMINOT2",300,0)
 i $$XVAL("sisci",vals)'="" s cnt=cnt+1 s tryary(cnt)="Zyban"
"RTN","SAMINOT2",301,0)
 i $$XVAL("siscj",vals)'="" s cnt=cnt+1 s tryary(cnt)="Hypnosis"
"RTN","SAMINOT2",302,0)
 i $$XVAL("sisck",vals)'="" s cnt=cnt+1 s tryary(cnt)="Acupuncture / acupressure"
"RTN","SAMINOT2",303,0)
 n tryot s tryot=""
"RTN","SAMINOT2",304,0)
 i $$XVAL("siscl",vals)'="" d  ;
"RTN","SAMINOT2",305,0)
 . s cnt=cnt+1 s tryary(cnt)="Other (specify)"
"RTN","SAMINOT2",306,0)
 . s tryot=$$XVAL("siscos",vals)
"RTN","SAMINOT2",307,0)
 ;
"RTN","SAMINOT2",308,0)
 i cnt>0 d  ;
"RTN","SAMINOT2",309,0)
 .  i ptried="" d OUT("Since your prior CT scan have you ever tried to quit smoking? ")
"RTN","SAMINOT2",310,0)
 . n zi s zi=""
"RTN","SAMINOT2",311,0)
 . f  s zi=$o(tryary(zi)) q:zi=""  d  ;
"RTN","SAMINOT2",312,0)
 . . d OUT(sp1_tryary(zi))
"RTN","SAMINOT2",313,0)
 . i tryot'="" d OUT(sp1_sp1_tryot)
"RTN","SAMINOT2",314,0)
 ;
"RTN","SAMINOT2",315,0)
 n cess,cess2 s cess="" s cess2=""
"RTN","SAMINOT2",316,0)
 i $$XVAL("siscmd",vals)="d" s cess="Declined"
"RTN","SAMINOT2",317,0)
 i $$XVAL("siscmd",vals)="a" s cess="Advised to quit smoking; VA resources provided"
"RTN","SAMINOT2",318,0)
 i $$XVAL("siscmd",vals)="i" d  ;
"RTN","SAMINOT2",319,0)
 . s cess="Interested in VA tobacco cessation medication. Encouraged Veteran"
"RTN","SAMINOT2",320,0)
 . s cess2="to talk to provider or pharmacist about which medication option is best for you."
"RTN","SAMINOT2",321,0)
 i cess'="" d  ;
"RTN","SAMINOT2",322,0)
 . d OUT("Tobacco cessation provided:")
"RTN","SAMINOT2",323,0)
 . d OUT(sp1_cess)
"RTN","SAMINOT2",324,0)
 . i cess2'="" d OUT(sp1_cess2)
"RTN","SAMINOT2",325,0)
 q
"RTN","SAMINOT2",326,0)
 ;
"RTN","SAMINOT2",327,0)
LCSNOTE(vals,dest,cnt) ; Lung Screening Note
"RTN","SAMINOT2",328,0)
 ;d OUT("")
"RTN","SAMINOT2",329,0)
 n sp1 s sp1="    "
"RTN","SAMINOT2",330,0)
 d OUT("Initial LDCT/Baseline: "_$$XVAL("sidoe",vals))
"RTN","SAMINOT2",331,0)
 d OUT("Date of most recent CT/LDCT: "_$$XVAL("fulctdt",vals))
"RTN","SAMINOT2",332,0)
 d OUT(sp1_"Notification of Results: "_$$XVAL("sidof",vals))
"RTN","SAMINOT2",333,0)
 n addcmt s addcmt=$$XVAL("fucmctde",vals)
"RTN","SAMINOT2",334,0)
 i addcmt'="" d  ;
"RTN","SAMINOT2",335,0)
 . d OUT("Additional comments:")
"RTN","SAMINOT2",336,0)
 . d OUT(sp1_addcmt)
"RTN","SAMINOT2",337,0)
 n impress s impress=""
"RTN","SAMINOT2",338,0)
 n ctary
"RTN","SAMINOT2",339,0)
 d CTINFO("ctary",sid,form)
"RTN","SAMINOT2",340,0)
 s impress=$g(ctary("impression"))
"RTN","SAMINOT2",341,0)
 ; get impression from lastest CT Eval here
"RTN","SAMINOT2",342,0)
 d IMPRESS("ctary",sid)
"RTN","SAMINOT2",343,0)
 ;i impress'="" d  ;
"RTN","SAMINOT2",344,0)
 ;. d OUT("Impression:")
"RTN","SAMINOT2",345,0)
 ;. d OUT(sp1_impress)
"RTN","SAMINOT2",346,0)
 ; smoking status follows
"RTN","SAMINOT2",347,0)
 d SSTATUS(vals)
"RTN","SAMINOT2",348,0)
 ;d OUT("Veteran was contacted via:")
"RTN","SAMINOT2",349,0)
 ;n sp1 s sp1="    "
"RTN","SAMINOT2",350,0)
 ;d:$$XVAL("fucmctip",vals) OUT(sp1_"In person")
"RTN","SAMINOT2",351,0)
 ;d:$$XVAL("fucmctte",vals) OUT(sp1_"Telephone")
"RTN","SAMINOT2",352,0)
 ;d:$$XVAL("fucmctth",vals) OUT(sp1_"TeleHealth")
"RTN","SAMINOT2",353,0)
 ;d:$$XVAL("fucmctml",vals) OUT(sp1_"Mailed Letter")
"RTN","SAMINOT2",354,0)
 ;d:$$XVAL("fucmctpp",vals) OUT(sp1_"Message in patient portal")
"RTN","SAMINOT2",355,0)
 ;d:$$XVAL("fucmctvd",vals) OUT(sp1_"Video-on-demand (VOD)")
"RTN","SAMINOT2",356,0)
 ;d:$$XVAL("fucmctot",vals) OUT(sp1_"Other: "_$$XVAL("fucmctoo",vals))
"RTN","SAMINOT2",357,0)
 ;d OUT("")
"RTN","SAMINOT2",358,0)
 ;
"RTN","SAMINOT2",359,0)
 ;d:$$XVAL("fucmctde",vals)'=""
"RTN","SAMINOT2",360,0)
 ;. d OUT("Communication details:")
"RTN","SAMINOT2",361,0)
 ;. d OUT(sp1_$$XVAL("fucmctde",vals))
"RTN","SAMINOT2",362,0)
 n recom s recom=""
"RTN","SAMINOT2",363,0)
 ; get recommendations from CT eval form here
"RTN","SAMINOT2",364,0)
 s recom=$g(ctary("followup"))
"RTN","SAMINOT2",365,0)
 i recom'="" d  ;
"RTN","SAMINOT2",366,0)
 . d OUT("Recommendations:")
"RTN","SAMINOT2",367,0)
 . d OUT(sp1_recom)
"RTN","SAMINOT2",368,0)
 . i $g(ctary("followup2"))'="" d  ;
"RTN","SAMINOT2",369,0)
 . . d OUT(sp1_ctary("followup2"))
"RTN","SAMINOT2",370,0)
 . i $g(ctary("followup3"))'="" d  ;
"RTN","SAMINOT2",371,0)
 . . d OUT(sp1_ctary("followup3"))
"RTN","SAMINOT2",372,0)
 n ordered s ordered=$$XVAL("funewct",vals)
"RTN","SAMINOT2",373,0)
 i ordered'="" d  ;
"RTN","SAMINOT2",374,0)
 . s ordered=$s(ordered="y":"Yes",ordered="n":"No",1:"")
"RTN","SAMINOT2",375,0)
 . d OUT("CT/LDCT ordered: "_ordered)
"RTN","SAMINOT2",376,0)
 n pulmon s pulmon=$$XVAL("fucompul",vals)
"RTN","SAMINOT2",377,0)
 i pulmon'="" d  ;
"RTN","SAMINOT2",378,0)
 . s pulmon=$s(pulmon="y":"Yes",pulmon="n":"No",1:"")
"RTN","SAMINOT2",379,0)
 . d OUT("Communicated to Pulmonary: "_pulmon)
"RTN","SAMINOT2",380,0)
 q
"RTN","SAMINOT2",381,0)
 ;
"RTN","SAMINOT2",382,0)
OUT(ln) ;
"RTN","SAMINOT2",383,0)
 s cnt=cnt+1
"RTN","SAMINOT2",384,0)
 n lnn
"RTN","SAMINOT2",385,0)
 ;s debug=1
"RTN","SAMINOT2",386,0)
 s lnn=$o(@dest@(" "),-1)+1
"RTN","SAMINOT2",387,0)
 s @dest@(lnn)=ln
"RTN","SAMINOT2",388,0)
 ;i $g(debug)=1 d  ;
"RTN","SAMINOT2",389,0)
 ;. i ln["<" q  ; no markup
"RTN","SAMINOT2",390,0)
 ;. n zs s zs=$STACK
"RTN","SAMINOT2",391,0)
 ;. n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMINOT2",392,0)
 ;. s @dest@(lnn)=zp_":"_ln
"RTN","SAMINOT2",393,0)
 q
"RTN","SAMINOT2",394,0)
 ;
"RTN","SAMINOT2",395,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMINOT2",396,0)
 ; vals is passed by name
"RTN","SAMINOT2",397,0)
 n zr
"RTN","SAMINOT2",398,0)
 s zr=$g(@vals@(var))
"RTN","SAMINOT2",399,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMINOT2",400,0)
 q zr
"RTN","SAMINOT2",401,0)
 ;
"RTN","SAMINOT2",402,0)
PREVCT(SID,FORM) ; extrinic returns the form key to the CT Eval form
"RTN","SAMINOT2",403,0)
 ; previous to FORM. If FORM is null, the latest CT Eval form key is returned
"RTN","SAMINOT2",404,0)
 ; FORM sensitivity is tbd.. always returns latest CTEval
"RTN","SAMINOT2",405,0)
 n gn s gn=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",406,0)
 n prev s prev=$o(@gn@("graph",SID,"ceform-30"),-1)
"RTN","SAMINOT2",407,0)
 q prev
"RTN","SAMINOT2",408,0)
 ;
"RTN","SAMINOT2",409,0)
CTINFO(ARY,SID,FORM) ; returns extracts from latest CT Eval form
"RTN","SAMINOT2",410,0)
 ; ARY passed by name
"RTN","SAMINOT2",411,0)
 ;
"RTN","SAMINOT2",412,0)
 n ctkey s ctkey=$$PREVCT(SID,$G(FORM))
"RTN","SAMINOT2",413,0)
 q:ctkey=""
"RTN","SAMINOT2",414,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",415,0)
 n ctroot s ctroot=$na(@root@("graph",SID,ctkey))
"RTN","SAMINOT2",416,0)
 ;
"RTN","SAMINOT2",417,0)
 s @ARY@("ctform")=ctkey
"RTN","SAMINOT2",418,0)
 s @ARY@("impression")=$g(@ctroot@("ceimre"))
"RTN","SAMINOT2",419,0)
 n futext
"RTN","SAMINOT2",420,0)
 s futext=$g(@ctroot@("cefuw"))
"RTN","SAMINOT2",421,0)
 n futbl
"RTN","SAMINOT2",422,0)
 s futbl("1y")="Annual repeat"
"RTN","SAMINOT2",423,0)
 s futbl("nw")="Now"
"RTN","SAMINOT2",424,0)
 s futbl("1m")="1 month"
"RTN","SAMINOT2",425,0)
 s futbl("3m")="3 months"
"RTN","SAMINOT2",426,0)
 s futbl("6m")="6 months"
"RTN","SAMINOT2",427,0)
 s futbl("os")="other"
"RTN","SAMINOT2",428,0)
 i futext'="" s futext=$g(futbl(futext))
"RTN","SAMINOT2",429,0)
 n fudate s fudate=$g(@ctroot@("cefud"))
"RTN","SAMINOT2",430,0)
; #Other followup
"RTN","SAMINOT2",431,0)
 n zfu,ofu,tofu,comma
"RTN","SAMINOT2",432,0)
 n vals s vals=ctroot
"RTN","SAMINOT2",433,0)
 s comma=0,tofu=""
"RTN","SAMINOT2",434,0)
 s ofu=""
"RTN","SAMINOT2",435,0)
 f zfu="cefuaf","cefucc","cefupe","cefufn","cefubr","cefupc","cefutb" d  ;
"RTN","SAMINOT2",436,0)
 . i $$XVAL(zfu,vals)="y" s ofu=ofu_zfu
"RTN","SAMINOT2",437,0)
 i $$XVAL("cefuo",vals)'="" s ofu=ofu_"cefuo"
"RTN","SAMINOT2",438,0)
 i ofu'="" d  ;
"RTN","SAMINOT2",439,0)
 . s tofu="Other followup: "
"RTN","SAMINOT2",440,0)
 . i ofu["cefuaf" s tofu=tofu_"Antibiotics" s comma=1
"RTN","SAMINOT2",441,0)
 . i ofu["cefucc" s tofu=tofu_$s(comma:", ",1:"")_"Diagnostic CT" s comma=1
"RTN","SAMINOT2",442,0)
 . i ofu["cefupe" s tofu=tofu_$s(comma:", ",1:"")_"PET" s comma=1
"RTN","SAMINOT2",443,0)
 . i ofu["cefufn" s tofu=tofu_$s(comma:", ",1:"")_"Percutaneous biopsy" s comma=1
"RTN","SAMINOT2",444,0)
 . i ofu["cefubr" s tofu=tofu_$s(comma:", ",1:"")_"Bronchoscopy" s comma=1
"RTN","SAMINOT2",445,0)
 . i ofu["cefupc" s tofu=tofu_$s(comma:", ",1:"")_"Pulmonary consultation" s comma=1
"RTN","SAMINOT2",446,0)
 . i ofu["cefutb" s tofu=tofu_$s(comma:", ",1:"")_"Refer to tumor board" s comma=1
"RTN","SAMINOT2",447,0)
 . i ofu["cefuo" s tofu=tofu_$s(comma:", ",1:"")_"Other:" s comma=1
"RTN","SAMINOT2",448,0)
 s @ARY@("followup")=futext_" "_fudate
"RTN","SAMINOT2",449,0)
 s @ARY@("followup2")=tofu
"RTN","SAMINOT2",450,0)
 s @ARY@("followup3")=$$XVAL("cefuoo",vals)
"RTN","SAMINOT2",451,0)
 ;
"RTN","SAMINOT2",452,0)
 q
"RTN","SAMINOT2",453,0)
 ; 
"RTN","SAMINOT2",454,0)
IMPRESS(ARY,SID) ; impressions from CTEval report
"RTN","SAMINOT2",455,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT2",456,0)
 n ctkey s ctkey=$g(@ARY@("ctform"))
"RTN","SAMINOT2",457,0)
 n vals s vals=$na(@root@("graph",SID,ctkey))
"RTN","SAMINOT2",458,0)
 n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMINOT2",459,0)
 s dict=$na(@dict@("cteval-dict"))
"RTN","SAMINOT2",460,0)
 n para s para=""
"RTN","SAMINOT2",461,0)
 n sp1 s sp1="    "
"RTN","SAMINOT2",462,0)
 ; 
"RTN","SAMINOT2",463,0)
 d OUT("Impression:")
"RTN","SAMINOT2",464,0)
 d OUT(sp1_$$XSUB("ceimn",vals,dict)_para)
"RTN","SAMINOT2",465,0)
 ;
"RTN","SAMINOT2",466,0)
 ;# Report CAC Score and Extent of Emphysema
"RTN","SAMINOT2",467,0)
 s cacval=0
"RTN","SAMINOT2",468,0)
 d  ;if $$XVAL("ceccv",vals)'="e" d  ;
"RTN","SAMINOT2",469,0)
 . set vcac=$$XVAL("cecccac",vals)
"RTN","SAMINOT2",470,0)
 . if vcac'="" d  ;
"RTN","SAMINOT2",471,0)
 . . s cacrec=""
"RTN","SAMINOT2",472,0)
 . . s cac="The Visual Coronary Artery Calcium (CAC) Score is "_vcac_". "
"RTN","SAMINOT2",473,0)
 . . s cacval=vcac
"RTN","SAMINOT2",474,0)
 . . i cacval>3 s cacrec=$g(@dict@("CAC_recommendation"))_para
"RTN","SAMINOT2",475,0)
 ;
"RTN","SAMINOT2",476,0)
 i cacval>0 d  ;
"RTN","SAMINOT2",477,0)
 . d OUT(sp1_cac_" "_cacrec_" "_para)
"RTN","SAMINOT2",478,0)
 . d  ;if $$XVAL("ceemv",vals)="e" d  ;
"RTN","SAMINOT2",479,0)
 . . if $$XVAL("ceem",vals)'="no" d  ;
"RTN","SAMINOT2",480,0)
 . . . if $$XVAL("ceem",vals)="nv" q  ;
"RTN","SAMINOT2",481,0)
 . . . d OUT(sp1_"Emphysema: "_$$XSUB("ceem",vals,dict)_"."_para)
"RTN","SAMINOT2",482,0)
 ;
"RTN","SAMINOT2",483,0)
 i $$XVAL("ceclini",vals)="y" d  ;
"RTN","SAMINOT2",484,0)
 . d OUT(sp1_$$XVAL("ceclin",vals)_"."_para)
"RTN","SAMINOT2",485,0)
 ;
"RTN","SAMINOT2",486,0)
 i $$XVAL("ceoppai",vals)="y" d  ;
"RTN","SAMINOT2",487,0)
 . d OUT(sp1_$$XVAL("ceoppa",vals)_"."_para)
"RTN","SAMINOT2",488,0)
 ;
"RTN","SAMINOT2",489,0)
 i $$XVAL("ceoppabi",vals)="y" d  ;
"RTN","SAMINOT2",490,0)
 . d OUT(sp1_$$XVAL("ceoppab",vals)_"."_para)
"RTN","SAMINOT2",491,0)
 ;
"RTN","SAMINOT2",492,0)
 i $$XVAL("cecommcai",vals)="y" d  ;
"RTN","SAMINOT2",493,0)
 . d OUT(sp1_$$XVAL("cecommca",vals)_"."_para)
"RTN","SAMINOT2",494,0)
 ;
"RTN","SAMINOT2",495,0)
 i $$XVAL("ceotabnmi",vals)="y" d  ;
"RTN","SAMINOT2",496,0)
 . d OUT(sp1_$$XVAL("ceotabnm",vals)_"."_para)
"RTN","SAMINOT2",497,0)
 ;
"RTN","SAMINOT2",498,0)
 i $$XVAL("ceobrci",vals)="y" d  ;
"RTN","SAMINOT2",499,0)
 . d OUT(sp1_$$XVAL("ceobrc",vals)_"."_para)
"RTN","SAMINOT2",500,0)
 ;
"RTN","SAMINOT2",501,0)
 i $$XVAL("ceaoabbi",vals)="y" d  ;
"RTN","SAMINOT2",502,0)
 . d OUT(sp1_$$XVAL("ceaoabb",vals)_"."_para)
"RTN","SAMINOT2",503,0)
 ;
"RTN","SAMINOT2",504,0)
 i $$XVAL("ceaoabi",vals)="y" d  ;
"RTN","SAMINOT2",505,0)
 . d OUT(sp1_$$XVAL("ceaoab",vals)_"."_para)
"RTN","SAMINOT2",506,0)
 ;
"RTN","SAMINOT2",507,0)
 ;# Impression Remarks
"RTN","SAMINOT2",508,0)
 i $$XVAL("ceimre",vals)'="" d  ;
"RTN","SAMINOT2",509,0)
 . d OUT(sp1_$$XVAL("ceimre",vals)_"."_para)
"RTN","SAMINOT2",510,0)
 q
"RTN","SAMINOT2",511,0)
 ;
"RTN","SAMINOT2",512,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMINOT2",513,0)
 ; vals and dict are passed by name
"RTN","SAMINOT2",514,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMINOT2",515,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMINOT2",516,0)
 n zr,zv,zdx
"RTN","SAMINOT2",517,0)
 s zdx=$g(valdx)
"RTN","SAMINOT2",518,0)
 i zdx="" s zdx=var
"RTN","SAMINOT2",519,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMINOT2",520,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMINOT2",521,0)
 i zv="" s zr="" q zr
"RTN","SAMINOT2",522,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMINOT2",523,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMINOT2",524,0)
 q zr
"RTN","SAMINOT2",525,0)
 ;
"VER")
8.0^22.2
**END**
**END**
