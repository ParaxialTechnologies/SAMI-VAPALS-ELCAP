KIDS Distribution saved on Feb 04, 2020@11:50:21
Text only version of CTEval report
**KIDS**:SAMI*18.0*4^

**INSTALL NAME**
SAMI*18.0*4
"BLD",11433,0)
SAMI*18.0*4^SAMI^0^3200204^y
"BLD",11433,1,0)
^^1^1^3200202^
"BLD",11433,1,1,0)
CTReport in text format
"BLD",11433,4,0)
^9.64PA^^
"BLD",11433,6.3)
2
"BLD",11433,"KRN",0)
^9.67PA^1.5^24
"BLD",11433,"KRN",.4,0)
.4
"BLD",11433,"KRN",.401,0)
.401
"BLD",11433,"KRN",.402,0)
.402
"BLD",11433,"KRN",.403,0)
.403
"BLD",11433,"KRN",.5,0)
.5
"BLD",11433,"KRN",.84,0)
.84
"BLD",11433,"KRN",1.5,0)
1.5
"BLD",11433,"KRN",1.6,0)
1.6
"BLD",11433,"KRN",1.61,0)
1.61
"BLD",11433,"KRN",1.62,0)
1.62
"BLD",11433,"KRN",3.6,0)
3.6
"BLD",11433,"KRN",3.8,0)
3.8
"BLD",11433,"KRN",9.2,0)
9.2
"BLD",11433,"KRN",9.8,0)
9.8
"BLD",11433,"KRN",9.8,"NM",0)
^9.68A^10^10
"BLD",11433,"KRN",9.8,"NM",1,0)
SAMINOT3^^0^B48541042
"BLD",11433,"KRN",9.8,"NM",2,0)
SAMICTRT^^0^B16024017
"BLD",11433,"KRN",9.8,"NM",3,0)
SAMICTT0^^0^B70496932
"BLD",11433,"KRN",9.8,"NM",4,0)
SAMICTT1^^0^B82363207
"BLD",11433,"KRN",9.8,"NM",5,0)
SAMICTT2^^0^B84755388
"BLD",11433,"KRN",9.8,"NM",6,0)
SAMICTT3^^0^B165906260
"BLD",11433,"KRN",9.8,"NM",7,0)
SAMICTT4^^0^B35570521
"BLD",11433,"KRN",9.8,"NM",8,0)
SAMICTT9^^0^B10292811
"BLD",11433,"KRN",9.8,"NM",9,0)
SAMICTTA^^0^B24206954
"BLD",11433,"KRN",9.8,"NM",10,0)
SAMIHOM4^^0^B462206546
"BLD",11433,"KRN",9.8,"NM","B","SAMICTRT",2)

"BLD",11433,"KRN",9.8,"NM","B","SAMICTT0",3)

"BLD",11433,"KRN",9.8,"NM","B","SAMICTT1",4)

"BLD",11433,"KRN",9.8,"NM","B","SAMICTT2",5)

"BLD",11433,"KRN",9.8,"NM","B","SAMICTT3",6)

"BLD",11433,"KRN",9.8,"NM","B","SAMICTT4",7)

"BLD",11433,"KRN",9.8,"NM","B","SAMICTT9",8)

"BLD",11433,"KRN",9.8,"NM","B","SAMICTTA",9)

"BLD",11433,"KRN",9.8,"NM","B","SAMIHOM4",10)

"BLD",11433,"KRN",9.8,"NM","B","SAMINOT3",1)

"BLD",11433,"KRN",19,0)
19
"BLD",11433,"KRN",19.1,0)
19.1
"BLD",11433,"KRN",101,0)
101
"BLD",11433,"KRN",409.61,0)
409.61
"BLD",11433,"KRN",771,0)
771
"BLD",11433,"KRN",779.2,0)
779.2
"BLD",11433,"KRN",870,0)
870
"BLD",11433,"KRN",8989.51,0)
8989.51
"BLD",11433,"KRN",8989.52,0)
8989.52
"BLD",11433,"KRN",8994,0)
8994
"BLD",11433,"KRN","B",.4,.4)

"BLD",11433,"KRN","B",.401,.401)

"BLD",11433,"KRN","B",.402,.402)

"BLD",11433,"KRN","B",.403,.403)

"BLD",11433,"KRN","B",.5,.5)

"BLD",11433,"KRN","B",.84,.84)

"BLD",11433,"KRN","B",1.5,1.5)

"BLD",11433,"KRN","B",1.6,1.6)

"BLD",11433,"KRN","B",1.61,1.61)

"BLD",11433,"KRN","B",1.62,1.62)

"BLD",11433,"KRN","B",3.6,3.6)

"BLD",11433,"KRN","B",3.8,3.8)

"BLD",11433,"KRN","B",9.2,9.2)

"BLD",11433,"KRN","B",9.8,9.8)

"BLD",11433,"KRN","B",19,19)

"BLD",11433,"KRN","B",19.1,19.1)

"BLD",11433,"KRN","B",101,101)

"BLD",11433,"KRN","B",409.61,409.61)

"BLD",11433,"KRN","B",771,771)

"BLD",11433,"KRN","B",779.2,779.2)

"BLD",11433,"KRN","B",870,870)

"BLD",11433,"KRN","B",8989.51,8989.51)

"BLD",11433,"KRN","B",8989.52,8989.52)

"BLD",11433,"KRN","B",8994,8994)

"MBREQ")
0
"PKG",230,-1)
1^1
"PKG",230,0)
SAMI^SAMI^SCREENING APPLICATIONS MANAGEMENT - IELCAP
"PKG",230,22,0)
^9.49I^1^1
"PKG",230,22,1,0)
18.0^3191203
"PKG",230,22,1,"PAH",1,0)
4^3200204
"PKG",230,22,1,"PAH",1,1,0)
^^1^1^3200204
"PKG",230,22,1,"PAH",1,1,1,0)
CTReport in text format
"QUES","XPF1",0)
Y
"QUES","XPF1","??")
^D REP^XPDH
"QUES","XPF1","A")
Shall I write over your |FLAG| File
"QUES","XPF1","B")
YES
"QUES","XPF1","M")
D XPF1^XPDIQ
"QUES","XPF2",0)
Y
"QUES","XPF2","??")
^D DTA^XPDH
"QUES","XPF2","A")
Want my data |FLAG| yours
"QUES","XPF2","B")
YES
"QUES","XPF2","M")
D XPF2^XPDIQ
"QUES","XPI1",0)
YO
"QUES","XPI1","??")
^D INHIBIT^XPDH
"QUES","XPI1","A")
Want KIDS to INHIBIT LOGONs during the install
"QUES","XPI1","B")
NO
"QUES","XPI1","M")
D XPI1^XPDIQ
"QUES","XPM1",0)
PO^VA(200,:EM
"QUES","XPM1","??")
^D MG^XPDH
"QUES","XPM1","A")
Enter the Coordinator for Mail Group '|FLAG|'
"QUES","XPM1","B")

"QUES","XPM1","M")
D XPM1^XPDIQ
"QUES","XPO1",0)
Y
"QUES","XPO1","??")
^D MENU^XPDH
"QUES","XPO1","A")
Want KIDS to Rebuild Menu Trees Upon Completion of Install
"QUES","XPO1","B")
NO
"QUES","XPO1","M")
D XPO1^XPDIQ
"QUES","XPZ1",0)
Y
"QUES","XPZ1","??")
^D OPT^XPDH
"QUES","XPZ1","A")
Want to DISABLE Scheduled Options, Menu Options, and Protocols
"QUES","XPZ1","B")
NO
"QUES","XPZ1","M")
D XPZ1^XPDIQ
"QUES","XPZ2",0)
Y
"QUES","XPZ2","??")
^D RTN^XPDH
"QUES","XPZ2","A")
Want to MOVE routines to other CPUs
"QUES","XPZ2","B")
NO
"QUES","XPZ2","M")
D XPZ2^XPDIQ
"RTN")
10
"RTN","SAMICTRT")
0^2^B16024017
"RTN","SAMICTRT",1,0)
SAMICTRT ;ven/gpl - CTReport Test Routine ;2018-03-07T18:48Z
"RTN","SAMICTRT",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMICTRT",3,0)
 ;
"RTN","SAMICTRT",4,0)
 ; This routine is for testing only and should not be distributed
"RTN","SAMICTRT",5,0)
 ;
"RTN","SAMICTRT",6,0)
 quit  ; no entry from top
"RTN","SAMICTRT",7,0)
 ;
"RTN","SAMICTRT",8,0)
wsReport(testout,filter) ; web service
"RTN","SAMICTRT",9,0)
 n vapals ; first do vapals report
"RTN","SAMICTRT",10,0)
 d WSREPORT^SAMICTR0(.vapals,.filter)
"RTN","SAMICTRT",11,0)
 n fglb,fglb1,fn,dir
"RTN","SAMICTRT",12,0)
 s fglb=$na(^TMP("SAMITEST",$J))
"RTN","SAMICTRT",13,0)
 k @fglb
"RTN","SAMICTRT",14,0)
 s fglb1=$na(@fglb@(1))
"RTN","SAMICTRT",15,0)
 s fn=$$filename(.filter)
"RTN","SAMICTRT",16,0)
 s dir=$$whereIs("/ctvapals")
"RTN","SAMICTRT",17,0)
 m @fglb=vapals
"RTN","SAMICTRT",18,0)
 d GTF^%ZISH(fglb1,3,dir,"vapals_"_fn_".html")
"RTN","SAMICTRT",19,0)
 ;
"RTN","SAMICTRT",20,0)
 d makeData(fn,.filter) ; data for elcap report generator
"RTN","SAMICTRT",21,0)
 l +ctreport:2 e  d  q  ; need to make go.sh
"RTN","SAMICTRT",22,0)
 d makeGo(fn,.filter)
"RTN","SAMICTRT",23,0)
 zsy "bash /home/osehra/www/ctcontrol/go.sh"
"RTN","SAMICTRT",24,0)
 l -ctreport  ; all done with go.sh
"RTN","SAMICTRT",25,0)
 ;
"RTN","SAMICTRT",26,0)
 d makeFrame(.testout,fn,.filter)
"RTN","SAMICTRT",27,0)
 q
"RTN","SAMICTRT",28,0)
 ;
"RTN","SAMICTRT",29,0)
filename(filter) ; extrinsic returns the filename for output
"RTN","SAMICTRT",30,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMICTRT",31,0)
 n sid
"RTN","SAMICTRT",32,0)
 s sid=$g(filter("studyid"))
"RTN","SAMICTRT",33,0)
 i sid="" s sid="XXX00102"
"RTN","SAMICTRT",34,0)
 n pien s pien=$$SID2NUM^SAMIHOM3(sid)
"RTN","SAMICTRT",35,0)
 n fname,lname
"RTN","SAMICTRT",36,0)
 s fname=@root@(pien,"sinamef")
"RTN","SAMICTRT",37,0)
 s lname=@root@(pien,"sinamel")
"RTN","SAMICTRT",38,0)
 q lname_"_"_fname
"RTN","SAMICTRT",39,0)
 ;
"RTN","SAMICTRT",40,0)
makeGo(fn,filter) ; creates a bash script to run the elcap report
"RTN","SAMICTRT",41,0)
 n fglb,fglb1,dir,destdir
"RTN","SAMICTRT",42,0)
 s fglb=$na(^TMP("SAMITEST",$J))
"RTN","SAMICTRT",43,0)
 k @fglb
"RTN","SAMICTRT",44,0)
 s fglb1=$na(@fglb@(1))
"RTN","SAMICTRT",45,0)
 s destdir=$$whereIs("/ctelcap")
"RTN","SAMICTRT",46,0)
 n fname,lname,sid
"RTN","SAMICTRT",47,0)
 s fname=$p(fn,"_",2)
"RTN","SAMICTRT",48,0)
 s lname=$p(fn,"_",1)
"RTN","SAMICTRT",49,0)
 s sid=$g(filter("studyid"))
"RTN","SAMICTRT",50,0)
 i sid="" s sid="XXX00102"
"RTN","SAMICTRT",51,0)
 ;script run command redacted
"RTN","SAMICTRT",52,0)
 s dir="/home/osehra/www/ctcontrol/"
"RTN","SAMICTRT",53,0)
 d GTF^%ZISH(fglb1,3,dir,"go.sh") 
"RTN","SAMICTRT",54,0)
 q
"RTN","SAMICTRT",55,0)
 ;
"RTN","SAMICTRT",56,0)
makeFrame(out,fn,filter) ; creates an html file with a frame in /ctcompare
"RTN","SAMICTRT",57,0)
 n fglb,fglb1,dir
"RTN","SAMICTRT",58,0)
 s fglb=$na(^TMP("SAMITEST",$J))
"RTN","SAMICTRT",59,0)
 k @fglb
"RTN","SAMICTRT",60,0)
 s fglb1=$na(@fglb@(1))
"RTN","SAMICTRT",61,0)
 s dir=$$whereIs("/ctcompare")
"RTN","SAMICTRT",62,0)
 s @fglb@(1)="<html><head></head>"
"RTN","SAMICTRT",63,0)
 s @fglb@(2)=" <frameset cols=""50,50"">"
"RTN","SAMICTRT",64,0)
 s @fglb@(3)="    <frame src=""/resources/ctelcap/elcap_"_fn_".html"" name=""ELCAP"">"
"RTN","SAMICTRT",65,0)
 s @fglb@(4)="   <frame src=""/resources/ctvapals/vapals_"_fn_".html"" name=""VAPALS"">"
"RTN","SAMICTRT",66,0)
 s @fglb@(5)="   </frameset></html>"
"RTN","SAMICTRT",67,0)
 d GTF^%ZISH(fglb1,3,dir,fn_".html")
"RTN","SAMICTRT",68,0)
 ;
"RTN","SAMICTRT",69,0)
 s out=fglb
"RTN","SAMICTRT",70,0)
 q
"RTN","SAMICTRT",71,0)
 ;
"RTN","SAMICTRT",72,0)
makeData(fn,filter) ; creates an elcap compatible data file
"RTN","SAMICTRT",73,0)
 n sid,form
"RTN","SAMICTRT",74,0)
 s sid=$g(filter("studyid"))
"RTN","SAMICTRT",75,0)
 q:sid=""
"RTN","SAMICTRT",76,0)
 s form=$g(filter("form"))
"RTN","SAMICTRT",77,0)
 q:form=""
"RTN","SAMICTRT",78,0)
 n fglb s fglb=$na(^TMP("SAMITEST",$J))
"RTN","SAMICTRT",79,0)
 n fglb1 s fglb1=$na(@fglb@(1))
"RTN","SAMICTRT",80,0)
 ;
"RTN","SAMICTRT",81,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMICTRT",82,0)
 q:root=""
"RTN","SAMICTRT",83,0)
 ;
"RTN","SAMICTRT",84,0)
 n cnt s cnt=0
"RTN","SAMICTRT",85,0)
 n groot s groot=$na(@root@("graph",sid,form))
"RTN","SAMICTRT",86,0)
 n zi s zi=""
"RTN","SAMICTRT",87,0)
 f  s zi=$o(@groot@(zi)) q:zi=""  d  ;
"RTN","SAMICTRT",88,0)
 . q:zi[" "
"RTN","SAMICTRT",89,0)
 . s cnt=cnt+1
"RTN","SAMICTRT",90,0)
 . n ln
"RTN","SAMICTRT",91,0)
 . s ln=zi_"="_$g(@groot@(zi))
"RTN","SAMICTRT",92,0)
 . s @fglb@(cnt)=ln
"RTN","SAMICTRT",93,0)
 n dir s dir=$$whereIs("/ctdata")
"RTN","SAMICTRT",94,0)
 d GTF^%ZISH(fglb1,3,dir,fn_".txt")
"RTN","SAMICTRT",95,0)
 k @fglb
"RTN","SAMICTRT",96,0)
 q
"RTN","SAMICTRT",97,0)
 ;
"RTN","SAMICTRT",98,0)
testdata ;
"RTN","SAMICTRT",99,0)
 s filter("studyid")="XXX00102"
"RTN","SAMICTRT",100,0)
 s filter("form")="ceform-2018-10-09"
"RTN","SAMICTRT",101,0)
 s pgraph=$na(^%wd(17.040801,15,102))
"RTN","SAMICTRT",102,0)
 s name=@pgraph@("sinamel")_"-"_@pgraph@("sinamef")
"RTN","SAMICTRT",103,0)
 d makeData(name,.filter)
"RTN","SAMICTRT",104,0)
 q
"RTN","SAMICTRT",105,0)
 ;
"RTN","SAMICTRT",106,0)
whereIs(dirname) ; extrinsic which returns a directory path
"RTN","SAMICTRT",107,0)
 n root s root=$$setroot^%wd("seeGraph")
"RTN","SAMICTRT",108,0)
 q:root=""
"RTN","SAMICTRT",109,0)
 n dien,dir
"RTN","SAMICTRT",110,0)
 s dien=$o(@root@("graph","ops",dirname,"distdir",""))
"RTN","SAMICTRT",111,0)
 i $o(@root@("graph",dien,"type",""))'="directory" q  ;
"RTN","SAMICTRT",112,0)
 s dir=$o(@root@("graph",dien,"localdir",""))
"RTN","SAMICTRT",113,0)
 i dir'="" s dir=dir_"/"
"RTN","SAMICTRT",114,0)
 q dir
"RTN","SAMICTRT",115,0)
 ;
"RTN","SAMICTT0")
0^3^B70496932
"RTN","SAMICTT0",1,0)
SAMICTT0 ;ven/gpl - text based ctreport ; 2/14/19 10:29am
"RTN","SAMICTT0",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMICTT0",3,0)
 ;
"RTN","SAMICTT0",4,0)
 ;
"RTN","SAMICTT0",5,0)
 quit  ; no entry from top
"RTN","SAMICTT0",6,0)
 ;
"RTN","SAMICTT0",7,0)
WSREPORT(return,filter) ; web service which returns an html cteval report
"RTN","SAMICTT0",8,0)
 ;
"RTN","SAMICTT0",9,0)
 s debug=0
"RTN","SAMICTT0",10,0)
 n outmode s outmode="go"
"RTN","SAMICTT0",11,0)
 n line s line=""
"RTN","SAMICTT0",12,0)
 i $g(filter("debug"))=1 s debug=1
"RTN","SAMICTT0",13,0)
 ;
"RTN","SAMICTT0",14,0)
 ;s rtn=$na(^TMP("SAMICTT",$J))
"RTN","SAMICTT0",15,0)
 s rtn="return"
"RTN","SAMICTT0",16,0)
 k @rtn
"RTN","SAMICTT0",17,0)
 s HTTPRSP("mime")="text/html"
"RTN","SAMICTT0",18,0)
 ;
"RTN","SAMICTT0",19,0)
 n cnt s cnt=0 ; line number
"RTN","SAMICTT0",20,0)
 ;
"RTN","SAMICTT0",21,0)
 ; set up dictionary and patient values
"RTN","SAMICTT0",22,0)
 ;
"RTN","SAMICTT0",23,0)
 n dict,vals
"RTN","SAMICTT0",24,0)
 ;d INIT^SAMICTD2("dict")
"RTN","SAMICTT0",25,0)
 s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMICTT0",26,0)
 s dict=$na(@dict@("cteval-dict"))
"RTN","SAMICTT0",27,0)
 i $g(@dict@("pet"))="" d INIT2GPH^SAMICTD2 ; initialize the dictionary first time
"RTN","SAMICTT0",28,0)
 n si
"RTN","SAMICTT0",29,0)
 s si=$g(filter("studyid"))
"RTN","SAMICTT0",30,0)
 i si="" d  ;
"RTN","SAMICTT0",31,0)
 . s si="XXX00102"
"RTN","SAMICTT0",32,0)
 q:si=""
"RTN","SAMICTT0",33,0)
 n samikey
"RTN","SAMICTT0",34,0)
 s samikey=$g(filter("form"))
"RTN","SAMICTT0",35,0)
 i samikey="" d  ;
"RTN","SAMICTT0",36,0)
 . s samikey="ceform-2018-10-09"
"RTN","SAMICTT0",37,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMICTT0",38,0)
 i $g(filter("studyid"))="" s root=$$setroot^%wd("vapals-patients")
"RTN","SAMICTT0",39,0)
 s vals=$na(@root@("graph",si,samikey))
"RTN","SAMICTT0",40,0)
 ;W !,vals
"RTN","SAMICTT0",41,0)
 ;zwr @vals@(*)
"RTN","SAMICTT0",42,0)
 i '$d(@vals) d  q  ;
"RTN","SAMICTT0",43,0)
 . w !,"error, patient values not found"
"RTN","SAMICTT0",44,0)
 ;
"RTN","SAMICTT0",45,0)
 ; report parameters
"RTN","SAMICTT0",46,0)
 ;
"RTN","SAMICTT0",47,0)
 n nt,sectionheader,dummy,cac,tex,para,legout
"RTN","SAMICTT0",48,0)
 ;; n lang,lanread
"RTN","SAMICTT0",49,0)
 ;
"RTN","SAMICTT0",50,0)
 s nt=1
"RTN","SAMICTT0",51,0)
 s sectionheader=1
"RTN","SAMICTT0",52,0)
 ;;s dummy="******"
"RTN","SAMICTT0",53,0)
 s cac=""
"RTN","SAMICTT0",54,0)
 n cacrec s cacrec=""
"RTN","SAMICTT0",55,0)
 ;;s tex=0
"RTN","SAMICTT0",56,0)
 ;s para="<p>"
"RTN","SAMICTT0",57,0)
 ;s para=$char(13,10)
"RTN","SAMICTT0",58,0)
 s para=""
"RTN","SAMICTT0",59,0)
 ;;s legout=0
"RTN","SAMICTT0",60,0)
 n qheader s qheader=0
"RTN","SAMICTT0",61,0)
 ;
"RTN","SAMICTT0",62,0)
 n lang s lang=""
"RTN","SAMICTT0",63,0)
 n langread s langread=0
"RTN","SAMICTT0",64,0)
 ;
"RTN","SAMICTT0",65,0)
 n auth s auth("perm")="a"
"RTN","SAMICTT0",66,0)
 s auth("inst")=$g(filter("auth"))
"RTN","SAMICTT0",67,0)
 ;
"RTN","SAMICTT0",68,0)
 n newct s newct=0
"RTN","SAMICTT0",69,0)
 i $$XVAL("ceoppa",vals)'="" s newct=1
"RTN","SAMICTT0",70,0)
 ;
"RTN","SAMICTT0",71,0)
 n registryForm s registryForm=0
"RTN","SAMICTT0",72,0)
 i $$XVAL("ceaf",vals)'="" s registryForm=1
"RTN","SAMICTT0",73,0)
 ;
"RTN","SAMICTT0",74,0)
 ;d OUT("<HTML>")
"RTN","SAMICTT0",75,0)
 ;d OUT("<HEAD>")
"RTN","SAMICTT0",76,0)
 ;d OUT("<!-- Calling TR: CT Evaluation Report -->")
"RTN","SAMICTT0",77,0)
 ;d OUT("<TITLE>CT Evaluation Report</TITLE>")
"RTN","SAMICTT0",78,0)
 ;d OUT("<link rel='stylesheet' href='/css/report.css'>")
"RTN","SAMICTT0",79,0)
 ;d OUT("</HEAD>")
"RTN","SAMICTT0",80,0)
 ;d OUT("<BODY BGCOLOR=""#ffffff"" TEXT=""#000000"">")
"RTN","SAMICTT0",81,0)
 ;;d OUT("<TABLE border=""0"" cellspacing=""0"" cellpadding=""3"" WIDTH=""640""><TR><TD>")
"RTN","SAMICTT0",82,0)
 ;d OUT("<FONT SIZE=""+2""><CENTER>")
"RTN","SAMICTT0",83,0)
 ;d OUT("<!-- Calling TR: CT Evaluation Report -->")
"RTN","SAMICTT0",84,0)
 ;d OUT("<B>CT Evaluation Report</B>")
"RTN","SAMICTT0",85,0)
 d OUT("CT Evaluation Report")
"RTN","SAMICTT0",86,0)
 ;d OUT("</CENTER></FONT>")
"RTN","SAMICTT0",87,0)
 ;d OUT("</TD></TR><TR><TD>")
"RTN","SAMICTT0",88,0)
 ;d OUT("<HR SIZE=""2"" WIDTH=""100%"" ALIGN=""center"" NOSHADE>")
"RTN","SAMICTT0",89,0)
 ;d OUT("</TD></TR>")
"RTN","SAMICTT0",90,0)
 ;
"RTN","SAMICTT0",91,0)
 ;d OUT("<!-- patient information -->")
"RTN","SAMICTT0",92,0)
 ;d OUT("<TR><TD><TABLE border=""0"" cellspacing=""0"" cellpadding=""3"" WIDTH=""640"">")
"RTN","SAMICTT0",93,0)
 ;
"RTN","SAMICTT0",94,0)
 ; generate header
"RTN","SAMICTT0",95,0)
 ;
"RTN","SAMICTT0",96,0)
 d  ;
"RTN","SAMICTT0",97,0)
 . n pname
"RTN","SAMICTT0",98,0)
 . ;s pname=$$XVAL("sinamel",vals)_", "_$$XVAL("sinamef",vals)
"RTN","SAMICTT0",99,0)
 . s pname=$$XVAL("saminame",vals)
"RTN","SAMICTT0",100,0)
 . d OUT("Participant Name: "_pname)
"RTN","SAMICTT0",101,0)
 ;d OUT("<TR><TD WIDTH=""180""><B>Participant Name:</B></TD><TD WIDTH=""365"">")
"RTN","SAMICTT0",102,0)
 ;d OUT($$XVAL("sinamel",vals)_", "_$$XVAL("sinamef",vals))
"RTN","SAMICTT0",103,0)
 ;d OUT("</TD>")
"RTN","SAMICTT0",104,0)
 ;
"RTN","SAMICTT0",105,0)
 d  ;
"RTN","SAMICTT0",106,0)
 . n sid s sid=$$XVAL("sisid",vals)
"RTN","SAMICTT0",107,0)
 . d OUT("Study ID: "_sid)
"RTN","SAMICTT0",108,0)
 ;d OUT("<TD WIDTH=""120""><B>Study ID:</B></TD><TD WIDTH=""75"">")
"RTN","SAMICTT0",109,0)
 ;d OUT($$XVAL("sisid",vals))
"RTN","SAMICTT0",110,0)
 ;d OUT("</TD>")
"RTN","SAMICTT0",111,0)
 ;
"RTN","SAMICTT0",112,0)
 d  ;
"RTN","SAMICTT0",113,0)
 . n etype s etype=$$XSUB("cetex",vals,dict)_" "_$$XSUB("cectp",vals,dict)
"RTN","SAMICTT0",114,0)
 . d OUT("Type of Examination: "_etype)
"RTN","SAMICTT0",115,0)
 ;d OUT("<TR><TD><B>Type of Examination:</B></TD><TD>")
"RTN","SAMICTT0",116,0)
 ;d OUT($$XSUB("cetex",vals,dict)_" "_$$XSUB("cectp",vals,dict))
"RTN","SAMICTT0",117,0)
 ;d OUT("</TD>")
"RTN","SAMICTT0",118,0)
 ;d OUT("<TD> &nbsp; </TD><TD> &nbsp; </TD></TR>")
"RTN","SAMICTT0",119,0)
 ;
"RTN","SAMICTT0",120,0)
 d  ;
"RTN","SAMICTT0",121,0)
 . n edate s edate=$$XVAL("cedos",vals)
"RTN","SAMICTT0",122,0)
 . d OUT("Examination Date: "_edate)
"RTN","SAMICTT0",123,0)
 ;d OUT("<TR><TD><B>Examination Date:</B></TD><TD>")
"RTN","SAMICTT0",124,0)
 ;d OUT($$XVAL("cedos",vals))
"RTN","SAMICTT0",125,0)
 ;
"RTN","SAMICTT0",126,0)
 ;i $$XVAL("sidob",vals)'=-1 d  ;
"RTN","SAMICTT0",127,0)
 ;. d OUT("<TD><B>Date of Birth:</B></TD><TD>")
"RTN","SAMICTT0",128,0)
 ;. d OUT($$XVAL("sidob",vals))
"RTN","SAMICTT0",129,0)
 ;e  d OUT("<TD> &nbsp; </TD><TD> &nbsp; </TD></TR>")
"RTN","SAMICTT0",130,0)
 ;
"RTN","SAMICTT0",131,0)
 d  ;
"RTN","SAMICTT0",132,0)
 . n dob s dob=$$XVAL("sidob",vals)
"RTN","SAMICTT0",133,0)
 . i dob>0 d OUT("Date of Birth: "_dob)
"RTN","SAMICTT0",134,0)
 . d OUT("")
"RTN","SAMICTT0",135,0)
 ;i $$XVAL("sidob",vals)>0 d  ;
"RTN","SAMICTT0",136,0)
 ;. d OUT("<TD><B>Date of Birth:</B></TD><TD>")
"RTN","SAMICTT0",137,0)
 ;. d OUT($$XVAL("sidob",vals))
"RTN","SAMICTT0",138,0)
 ;. d OUT("</TD></TR>")
"RTN","SAMICTT0",139,0)
 ;e  d  ;
"RTN","SAMICTT0",140,0)
 ;. d OUT("<TD> &nbsp; </TD><TD> &nbsp; </TD></TR>")
"RTN","SAMICTT0",141,0)
 ;
"RTN","SAMICTT0",142,0)
 ;# End of Header
"RTN","SAMICTT0",143,0)
 ;
"RTN","SAMICTT0",144,0)
 ;d OUT("</TABLE>")
"RTN","SAMICTT0",145,0)
 ;;d OUT("</TD></TR><TR><TD>")
"RTN","SAMICTT0",146,0)
 ;d OUT("<HR SIZE=""2"" WIDTH=""100%"" ALIGN=""center"" NOSHADE>")
"RTN","SAMICTT0",147,0)
 ;d OUT("</TD></TR>")
"RTN","SAMICTT0",148,0)
 ;d OUT("<!-- report -->")
"RTN","SAMICTT0",149,0)
 ;d OUT("<TR><TD>")
"RTN","SAMICTT0",150,0)
 ;d OUT("<FONT SIZE=""+2""><B>")
"RTN","SAMICTT0",151,0)
 ;d OUT("Report:")
"RTN","SAMICTT0",152,0)
 ;d OUT("</B></FONT>")
"RTN","SAMICTT0",153,0)
 ;d OUT("</TD></TR><TR><TD><TABLE><TR><TD WIDTH=20></TD><TD>")
"RTN","SAMICTT0",154,0)
 d OUT("Report:")
"RTN","SAMICTT0",155,0)
 ;
"RTN","SAMICTT0",156,0)
 s outmode="hold"
"RTN","SAMICTT0",157,0)
 s line=""
"RTN","SAMICTT0",158,0)
 i $$XVAL("ceclin",vals)'="" d  ;
"RTN","SAMICTT0",159,0)
 . d HOUT("Clinical Information: ")
"RTN","SAMICTT0",160,0)
 . d OUT($$XVAL("ceclin",vals))
"RTN","SAMICTT0",161,0)
 . s outmode="go" d OUT("")
"RTN","SAMICTT0",162,0)
 ;
"RTN","SAMICTT0",163,0)
 s outmode="hold"
"RTN","SAMICTT0",164,0)
 n nopri s nopri=1
"RTN","SAMICTT0",165,0)
 d HOUT("Comparison CT Scans: ")
"RTN","SAMICTT0",166,0)
 if $$XVAL("cedcs",vals)'="" d  ;
"RTN","SAMICTT0",167,0)
 . d OUT($$XSUB("cetex",vals,dict)_". ")
"RTN","SAMICTT0",168,0)
 . d OUT("Comparisons: "_$$XVAL("cedcs",vals))
"RTN","SAMICTT0",169,0)
 . s nopri=0
"RTN","SAMICTT0",170,0)
 if $$XVAL("cedps",vals)'="" d  ;
"RTN","SAMICTT0",171,0)
 . d OUT(" "_$$XVAL("cedps",vals))
"RTN","SAMICTT0",172,0)
 . s nopri=0
"RTN","SAMICTT0",173,0)
 d:nopri OUT("None")
"RTN","SAMICTT0",174,0)
 s outmode="go" d OUT("")
"RTN","SAMICTT0",175,0)
 ;
"RTN","SAMICTT0",176,0)
 s outmode="hold"
"RTN","SAMICTT0",177,0)
 d HOUT(" Description: ")
"RTN","SAMICTT0",178,0)
 i $$XVAL("cectp",vals)="i" d  ;
"RTN","SAMICTT0",179,0)
 . d OUT("Limited Diagnostic CT examination was performed.")
"RTN","SAMICTT0",180,0)
 e  d  ;
"RTN","SAMICTT0",181,0)
 . d OUT("CT examination of the entire thorax was performed at "_$$XSUB("cectp",vals,dict)_" settings.")
"RTN","SAMICTT0",182,0)
 ;
"RTN","SAMICTT0",183,0)
 i $$XVAL("cectrst",vals)'="" d  ;
"RTN","SAMICTT0",184,0)
 . d OUT(" Images were obtained at "_$$XVAL("cectrst",vals)_" mm slice thickness.")
"RTN","SAMICTT0",185,0)
 . d OUT(" Multiplanar reconstructions were performed.")
"RTN","SAMICTT0",186,0)
 ;
"RTN","SAMICTT0",187,0)
 i newct d  ;
"RTN","SAMICTT0",188,0)
 . n nvadbo s nvadbo=1
"RTN","SAMICTT0",189,0)
 . n ii
"RTN","SAMICTT0",190,0)
 . f ii="ceoaa","ceaga","ceasa","ceala","ceapa","ceaaa","ceaka" d  ;
"RTN","SAMICTT0",191,0)
 . . i $$XVAL(ii,vals)="y" set nvadbo=0
"RTN","SAMICTT0",192,0)
 . ;
"RTN","SAMICTT0",193,0)
 . i nvadbo=1 d  ;
"RTN","SAMICTT0",194,0)
 . . d OUT("Upper abdominal images were not acquired on the current scan due to its limited nature.")
"RTN","SAMICTT0",195,0)
 s outmode="go" d OUT("")
"RTN","SAMICTT0",196,0)
 ;
"RTN","SAMICTT0",197,0)
 ; lung nodules
"RTN","SAMICTT0",198,0)
 ;
"RTN","SAMICTT0",199,0)
 ;d OUT("")
"RTN","SAMICTT0",200,0)
 d HOUT("Lung Nodules:")
"RTN","SAMICTT0",201,0)
 ;d OUT("")
"RTN","SAMICTT0",202,0)
 ;
"RTN","SAMICTT0",203,0)
 ; see if there are any nodules using the cectXch fields
"RTN","SAMICTT0",204,0)
 ;
"RTN","SAMICTT0",205,0)
 n ij,hasnodules s hasnodules=0
"RTN","SAMICTT0",206,0)
 f ij=1:1:10 i ($$XVAL("cect"_ij_"ch",vals)'="")&($$XVAL("cect"_ij_"ch",vals)'="-") s hasnodules=1
"RTN","SAMICTT0",207,0)
 ;
"RTN","SAMICTT0",208,0)
 i hasnodules=0 d  ;
"RTN","SAMICTT0",209,0)
 . d OUT(para)
"RTN","SAMICTT0",210,0)
 . d OUT("No pulmonary nodules are seen."_para)
"RTN","SAMICTT0",211,0)
 ;
"RTN","SAMICTT0",212,0)
 ;i $$XVAL("cennod",vals)="" d  ;
"RTN","SAMICTT0",213,0)
 ;. d OUT(para)
"RTN","SAMICTT0",214,0)
 ;. d OUT("No pulmonary nodules are seen."_para)
"RTN","SAMICTT0",215,0)
 ;e  i $$XVAL("ceanod",vals)="n" d  ;
"RTN","SAMICTT0",216,0)
 ;. d OUT(para)
"RTN","SAMICTT0",217,0)
 ;. d OUT("No pulmonary nodules are seen."_para)
"RTN","SAMICTT0",218,0)
 ;
"RTN","SAMICTT0",219,0)
 d NODULES^SAMICTT1(rtn,.vals,.dict)
"RTN","SAMICTT0",220,0)
 ;
"RTN","SAMICTT0",221,0)
 d OTHRLUNG^SAMICTT2(rtn,.vals,.dict)
"RTN","SAMICTT0",222,0)
 ;
"RTN","SAMICTT0",223,0)
 d EMPHYS^SAMICTT3(rtn,.vals,.dict)
"RTN","SAMICTT0",224,0)
 ;
"RTN","SAMICTT0",225,0)
 d BREAST^SAMICTT4(rtn,.vals,.dict)
"RTN","SAMICTT0",226,0)
 ;
"RTN","SAMICTT0",227,0)
 d IMPRSN^SAMICTT9(rtn,.vals,.dict)
"RTN","SAMICTT0",228,0)
 ;
"RTN","SAMICTT0",229,0)
 d RCMND^SAMICTTA(rtn,.vals,.dict)
"RTN","SAMICTT0",230,0)
 ;
"RTN","SAMICTT0",231,0)
 ; etc etc
"RTN","SAMICTT0",232,0)
 ;
"RTN","SAMICTT0",233,0)
 d  ;
"RTN","SAMICTT0",234,0)
 . d OUT("References:")
"RTN","SAMICTT0",235,0)
 . d OUT("Recommendations for nodules and other findings are detailed in the I-ELCAP Protocol.")
"RTN","SAMICTT0",236,0)
 . d OUT("A summary and the full I-ELCAP protocol can be viewed at: http://ielcap.org/protocols")
"RTN","SAMICTT0",237,0)
 ;d OUT("</TABLE>")
"RTN","SAMICTT0",238,0)
 ;d OUT("<p><br></p><p><b>References:</b><br></p>")
"RTN","SAMICTT0",239,0)
 ;d OUT("<p>Recommendations for nodules and other findings are detailed in the I-ELCAP Protocol.<BR>")
"RTN","SAMICTT0",240,0)
 ;d OUT("A summary and the full I-ELCAP protocol can be viewed at: <a href=""http://ielcap.org/protocols"">http://ielcap.org/protocols</a></p>")
"RTN","SAMICTT0",241,0)
 ;d OUT("</TD></TR></TABLE></TD></TR></TABLE>")
"RTN","SAMICTT0",242,0)
 ;s debug=1
"RTN","SAMICTT0",243,0)
 d:$g(debug)  ;
"RTN","SAMICTT0",244,0)
 . n zi s zi=""
"RTN","SAMICTT0",245,0)
 . f  s zi=$o(@vals@(zi)) q:zi=""  d  ;
"RTN","SAMICTT0",246,0)
 . . d OUT(zi_" "_$g(@vals@(zi)))
"RTN","SAMICTT0",247,0)
 ;d OUT("</BODY></HTML>")
"RTN","SAMICTT0",248,0)
 ;
"RTN","SAMICTT0",249,0)
 q
"RTN","SAMICTT0",250,0)
 ;
"RTN","SAMICTT0",251,0)
OUT(ln) ;
"RTN","SAMICTT0",252,0)
 i outmode="hold" s line=line_ln q  ;
"RTN","SAMICTT0",253,0)
 s cnt=cnt+1
"RTN","SAMICTT0",254,0)
 n lnn
"RTN","SAMICTT0",255,0)
 i $g(debug)'=1 s debug=0
"RTN","SAMICTT0",256,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT0",257,0)
 i outmode="go" d  ;
"RTN","SAMICTT0",258,0)
 . s @rtn@(lnn)=line
"RTN","SAMICTT0",259,0)
 . s line=""
"RTN","SAMICTT0",260,0)
 . s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT0",261,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT0",262,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT0",263,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT0",264,0)
 . n zs s zs=$STACK
"RTN","SAMICTT0",265,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT0",266,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT0",267,0)
 q
"RTN","SAMICTT0",268,0)
 ;
"RTN","SAMICTT0",269,0)
OUTOLD(ln) ;
"RTN","SAMICTT0",270,0)
 s cnt=cnt+1
"RTN","SAMICTT0",271,0)
 n lnn
"RTN","SAMICTT0",272,0)
 ;s debug=1
"RTN","SAMICTT0",273,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT0",274,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT0",275,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT0",276,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT0",277,0)
 . n zs s zs=$STACK
"RTN","SAMICTT0",278,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT0",279,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT0",280,0)
 q
"RTN","SAMICTT0",281,0)
 ;
"RTN","SAMICTT0",282,0)
HOUT(ln) ;
"RTN","SAMICTT0",283,0)
 d OUT(ln)
"RTN","SAMICTT0",284,0)
 ;d OUT("<p><span class='sectionhead'>"_ln_"</span>")
"RTN","SAMICTT0",285,0)
 q
"RTN","SAMICTT0",286,0)
 ;
"RTN","SAMICTT0",287,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMICTT0",288,0)
 ; vals is passed by name
"RTN","SAMICTT0",289,0)
 n zr
"RTN","SAMICTT0",290,0)
 s zr=$g(@vals@(var))
"RTN","SAMICTT0",291,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMICTT0",292,0)
 q zr
"RTN","SAMICTT0",293,0)
 ;
"RTN","SAMICTT0",294,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMICTT0",295,0)
 ; vals and dict are passed by name
"RTN","SAMICTT0",296,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMICTT0",297,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMICTT0",298,0)
 n zr,zv,zdx
"RTN","SAMICTT0",299,0)
 s zdx=$g(valdx)
"RTN","SAMICTT0",300,0)
 i zdx="" s zdx=var
"RTN","SAMICTT0",301,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMICTT0",302,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMICTT0",303,0)
 i zv="" s zr="" q zr
"RTN","SAMICTT0",304,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMICTT0",305,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMICTT0",306,0)
 q zr
"RTN","SAMICTT0",307,0)
 ;
"RTN","SAMICTT0",308,0)
GETFILTR(filter,sid) ; fill in the filter for Ct Eval for sid
"RTN","SAMICTT0",309,0)
 s filter("studyid")=sid
"RTN","SAMICTT0",310,0)
 n items,zform
"RTN","SAMICTT0",311,0)
 d GETITEMS^SAMICASE("items",sid)
"RTN","SAMICTT0",312,0)
 s zform=$o(items("ceform"))
"RTN","SAMICTT0",313,0)
 s filter("form")=zform
"RTN","SAMICTT0",314,0)
 ;zwr filter
"RTN","SAMICTT0",315,0)
 q
"RTN","SAMICTT0",316,0)
T1(grtn,debug) ; 
"RTN","SAMICTT0",317,0)
 n filter
"RTN","SAMICTT0",318,0)
 ;n sid s sid="XXX00333"
"RTN","SAMICTT0",319,0)
 ;n sid s sid="XXX00484"
"RTN","SAMICTT0",320,0)
 n sid s sid="XXX9000001"
"RTN","SAMICTT0",321,0)
 d GETFILTR(.filter,sid)
"RTN","SAMICTT0",322,0)
 i $g(debug)=1 s filter("debug")=1
"RTN","SAMICTT0",323,0)
 d WSNOTE^SAMINOT3(.grtn,.filter)
"RTN","SAMICTT0",324,0)
 ;d WSREPORT^SAMICTT0(.grtn,.filter)
"RTN","SAMICTT0",325,0)
 q
"RTN","SAMICTT0",326,0)
 ;
"RTN","SAMICTT1")
0^4^B82363207
"RTN","SAMICTT1",1,0)
SAMICTT1 ;ven/gpl - ielcap: forms ; 12/28/18 10:54am
"RTN","SAMICTT1",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMICTT1",3,0)
 ;
"RTN","SAMICTT1",4,0)
 ;
"RTN","SAMICTT1",5,0)
 quit  ; no entry from top
"RTN","SAMICTT1",6,0)
 ;
"RTN","SAMICTT1",7,0)
NODULES(rtn,vals,dict) ;
"RTN","SAMICTT1",8,0)
 ;
"RTN","SAMICTT1",9,0)
 ;
"RTN","SAMICTT1",10,0)
 ;# Report on Nodules
"RTN","SAMICTT1",11,0)
 n firstitem
"RTN","SAMICTT1",12,0)
 set firstitem=0
"RTN","SAMICTT1",13,0)
 n outmode s outmode="hold"
"RTN","SAMICTT1",14,0)
 n line s line=""
"RTN","SAMICTT1",15,0)
 n ii set ii=1
"RTN","SAMICTT1",16,0)
 ;# Information for each nodule
"RTN","SAMICTT1",17,0)
 f ii=1:1:10 d  ;
"RTN","SAMICTT1",18,0)
 . i $$XSUB("cectch",vals,dict,"cect"_ii_"ch")="px" q  ;
"RTN","SAMICTT1",19,0)
 . i $$XSUB("cectch",vals,dict,"cect"_ii_"ch")="" q  ;
"RTN","SAMICTT1",20,0)
 . i firstitem=0 d  ;
"RTN","SAMICTT1",21,0)
 . . ;d OUT("<!-- begin nodule info -->")
"RTN","SAMICTT1",22,0)
 . . ;d OUT("<UL TYPE=disc>")
"RTN","SAMICTT1",23,0)
 . . set firstitem=1
"RTN","SAMICTT1",24,0)
 . ;
"RTN","SAMICTT1",25,0)
 . ;d OUT("<LI>")
"RTN","SAMICTT1",26,0)
 . n specialcase s specialcase=0
"RTN","SAMICTT1",27,0)
 . n ij,ik
"RTN","SAMICTT1",28,0)
 . s ik=$$XVAL("cect"_ii_"ch",vals)
"RTN","SAMICTT1",29,0)
 . ;f ij="pw","px","pr","pv" i ij=ik s specialcase=1
"RTN","SAMICTT1",30,0)
 . i "pwpxprpv"[ik s specialcase=1
"RTN","SAMICTT1",31,0)
 . ;
"RTN","SAMICTT1",32,0)
 . ;# Example Sentence
"RTN","SAMICTT1",33,0)
 . ;# LUL Nodule 1 is non-calcified, non-solid, 6 mm x 6 mm (with 3 x 3) solid component), smooth edge, previously seen and unchanged. (Series 2, Image 65)
"RTN","SAMICTT1",34,0)
 . ;# [LOCATION] Nodule [N] is [CALCIFICATION], [SOLID], [L] mm x mm, [SMOOTH], [NEW].  (Series [Series], Image [ImageNum]).
"RTN","SAMICTT1",35,0)
 . ;
"RTN","SAMICTT1",36,0)
 . n spic s spic=""
"RTN","SAMICTT1",37,0)
 . i $$XVAL("cect"_ii_"sp",vals)="y" s spic="spiculated, "
"RTN","SAMICTT1",38,0)
 . ;
"RTN","SAMICTT1",39,0)
 . n calcification,calcstr,status
"RTN","SAMICTT1",40,0)
 . s status=$$XVAL("cect"_ii_"st",vals)
"RTN","SAMICTT1",41,0)
 . s @vals@("cect"_ii_"ca")=$s(status="bc":"y",status="pc":"q",1:"n")
"RTN","SAMICTT1",42,0)
 . s calcification=$$XSUB("cectca",vals,dict,"cect"_ii_"ca")
"RTN","SAMICTT1",43,0)
 . i calcification="" s calcstr="is "_spic_$$XSUB("cectnt",vals,dict,"cect"_ii_"nt")_", "
"RTN","SAMICTT1",44,0)
 . e  s calcstr="is "_calcification_", "_spic_$$XSUB("cectnt",vals,dict,"cect"_ii_"nt")_", "
"RTN","SAMICTT1",45,0)
 . ;
"RTN","SAMICTT1",46,0)
 . n scomp
"RTN","SAMICTT1",47,0)
 . s scomp=""
"RTN","SAMICTT1",48,0)
 . i $$XVAL("cect"_ii_"ssl",vals)'="" d  ;
"RTN","SAMICTT1",49,0)
 . . s scomp=" (solid component "_$$XVAL("cect"_ii_"ssl",vals)_" mm x "_$$XVAL("cect"_ii_"ssw",vals)_" mm)"
"RTN","SAMICTT1",50,0)
 . ;
"RTN","SAMICTT1",51,0)
 . s calcstr=calcstr_$$XVAL("cect"_ii_"sl",vals)_" mm x "_$$XVAL("cect"_ii_"sw",vals)_" mm"_scomp_", "
"RTN","SAMICTT1",52,0)
 . ;
"RTN","SAMICTT1",53,0)
 . n smooth
"RTN","SAMICTT1",54,0)
 . ;s smooth=$$XSUB("cectse",vals,dict,"cect"_ii_"se")
"RTN","SAMICTT1",55,0)
 . s smooth=$$XVAL("cect"_ii_"se",vals)
"RTN","SAMICTT1",56,0)
 . i smooth="y" s calcstr=calcstr_"smooth edges, "
"RTN","SAMICTT1",57,0)
 . ;e  s calcstr=calcstr_smooth_" edges, " ;nothing if not smooth
"RTN","SAMICTT1",58,0)
 . ;
"RTN","SAMICTT1",59,0)
 . ; adding distance from costal pleura
"RTN","SAMICTT1",60,0)
 . n pldstr
"RTN","SAMICTT1",61,0)
 . s pldstr="within "_$$XVAL("cect"_ii_"pld",vals)_" mm of the costal pleura"
"RTN","SAMICTT1",62,0)
 . ;
"RTN","SAMICTT1",63,0)
 . n skip s skip=0
"RTN","SAMICTT1",64,0)
 . ;# 3 cases: parenchymal, endobronchial, and both
"RTN","SAMICTT1",65,0)
 . ;
"RTN","SAMICTT1",66,0)
 . n en,loc,nloc,endo,ll
"RTN","SAMICTT1",67,0)
 . s loc=""
"RTN","SAMICTT1",68,0)
 . s nloc=""
"RTN","SAMICTT1",69,0)
 . s en=$$XVAL("cect"_ii_"en",vals)
"RTN","SAMICTT1",70,0)
 . s ll=$$XVAL("cect"_ii_"ll",vals)
"RTN","SAMICTT1",71,0)
 . i ($l(en)<2)!(en="no")!(en="") d  ;
"RTN","SAMICTT1",72,0)
 . . ;# 1) parenchymal only
"RTN","SAMICTT1",73,0)
 . . n X,Y s X=ll
"RTN","SAMICTT1",74,0)
 . . X ^%ZOSF("UPPERCASE")
"RTN","SAMICTT1",75,0)
 . . s loc=Y
"RTN","SAMICTT1",76,0)
 . . s nloc=Y
"RTN","SAMICTT1",77,0)
 . . s endo="Nodule"
"RTN","SAMICTT1",78,0)
 . e  d  ;
"RTN","SAMICTT1",79,0)
 . . i ll="end" d  ;
"RTN","SAMICTT1",80,0)
 . . . ;# 2) Endobronchial only
"RTN","SAMICTT1",81,0)
 . . . i en="tr" d  ;
"RTN","SAMICTT1",82,0)
 . . . . s endo="Endotracheal Nodule"
"RTN","SAMICTT1",83,0)
 . . . . i specialcase=1 d  ;
"RTN","SAMICTT1",84,0)
 . . . . . d OUT("Previously seen "_endo_" "_ii_" "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",85,0)
 . . . . e  d  ;
"RTN","SAMICTT1",86,0)
 . . . . . i ($$XVAL("cetex",vals)="b")&($$XVAL("cectch"_ii_"ch",vals)="n") d  ;
"RTN","SAMICTT1",87,0)
 . . . . . . d OUT(endo_" "_ii_" "_calcstr_" is seen.")
"RTN","SAMICTT1",88,0)
 . . . . . e  d OUT(endo_" "_ii_" "_calcstr_" "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",89,0)
 . . . . s skip=1
"RTN","SAMICTT1",90,0)
 . . . i en="rm" d  ;
"RTN","SAMICTT1",91,0)
 . . . . s endo="Nodule"
"RTN","SAMICTT1",92,0)
 . . . . s nloc=$$XSUB("cecten",vals,dict,"cect"_ii_"en")
"RTN","SAMICTT1",93,0)
 . . . . i specialcase=1 d  ;
"RTN","SAMICTT1",94,0)
 . . . . . ;d OUT("Previously seen "_nloc_" "_endo_" "_ii_" ")
"RTN","SAMICTT1",95,0)
 . . . . . d OUT("Previously seen "_endo_" "_ii_" in the "_nloc_" "_calcstr_" ")
"RTN","SAMICTT1",96,0)
 . . . . . d OUT($$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",97,0)
 . . . . e  d  ;
"RTN","SAMICTT1",98,0)
 . . . . . i ($$XVAL("cetex",vals)="b")&($$XVAL("cect"_ii_"ch",vals)="n") d  ;
"RTN","SAMICTT1",99,0)
 . . . . . . ;d OUT(nloc_" "_endo_" "_ii_".")
"RTN","SAMICTT1",100,0)
 . . . . . . d OUT(endo_" "_ii_" is seen in the "_nloc_" "_calcstr_".")
"RTN","SAMICTT1",101,0)
 . . . . . ;e  d OUT(nloc_" "_endo_" "_ii_" "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",102,0)
 . . . . . e  d OUT(endo_" "_ii_" in the "_nloc_" "_calcstr_", "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",103,0)
 . . . . s skip=1
"RTN","SAMICTT1",104,0)
 . . . i en="bi" d  ;
"RTN","SAMICTT1",105,0)
 . . . . s endo="Nodule"
"RTN","SAMICTT1",106,0)
 . . . . s loc=$$XSUB("cecten",vals,dict,"cect"_ii_"en")
"RTN","SAMICTT1",107,0)
 . . . . i specialcase=1 d  ;
"RTN","SAMICTT1",108,0)
 . . . . . ;d OUT("Previously seen "_endo_" "_ii_" in the "_loc)
"RTN","SAMICTT1",109,0)
 . . . . . d OUT("Previously seen "_endo_" "_ii_" in the "_nloc_" "_calcstr_" ")
"RTN","SAMICTT1",110,0)
 . . . . . d OUT($$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",111,0)
 . . . . e  d  ;
"RTN","SAMICTT1",112,0)
 . . . . . i ($$XVAL("cetex",vals)="b")&($$XVAL("cect"_ii_"ch",vals)="n") d  ;
"RTN","SAMICTT1",113,0)
 . . . . . . ;d OUT(endo_" "_ii_" is seen in the "_loc_".")
"RTN","SAMICTT1",114,0)
 . . . . . . d OUT(endo_" "_ii_" is seen in the "_loc_" "_calcstr_".")
"RTN","SAMICTT1",115,0)
 . . . . . e  d OUT(nloc_" "_endo_" "_ii_" "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",116,0)
 . . . . s skip=1
"RTN","SAMICTT1",117,0)
 . . . i skip=0 d  ; "default"
"RTN","SAMICTT1",118,0)
 . . . . s endo="Nodule"
"RTN","SAMICTT1",119,0)
 . . . . n X,Y
"RTN","SAMICTT1",120,0)
 . . . . s X=$$XVAL("cect"_ii_"en",vals)
"RTN","SAMICTT1",121,0)
 . . . . X ^%ZOSF("UPPERCASE")
"RTN","SAMICTT1",122,0)
 . . . . s nloc=Y
"RTN","SAMICTT1",123,0)
 . . . . i specialcase=1 d  ;
"RTN","SAMICTT1",124,0)
 . . . . . d OUT(nloc_" "_endo_" "_ii_" "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_", likely endobronchial.")
"RTN","SAMICTT1",125,0)
 . . . . e  d  ;
"RTN","SAMICTT1",126,0)
 . . . . . ;i ($$XVAL("cetex",vals)="b")&($$XSUB("cectch",vals,dict,"cect"_ii_"ch")="n") d  ;
"RTN","SAMICTT1",127,0)
 . . . . . i (($$XVAL("cetex",vals)="b")&($$XVAL("cect"_ii_"ch",vals)="n")) d  ; gpl 1002
"RTN","SAMICTT1",128,0)
 . . . . . . d OUT(nloc_" "_endo_" "_ii_" "_calcstr_" likely endobronchial.")
"RTN","SAMICTT1",129,0)
 . . . . . e  d OUT(nloc_" "_endo_" "_ii_" "_calcstr_" "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_" likely endobronchial.")
"RTN","SAMICTT1",130,0)
 . . . . s skip=1
"RTN","SAMICTT1",131,0)
 . . e  d  ;
"RTN","SAMICTT1",132,0)
 . . . s endo="Nodule"
"RTN","SAMICTT1",133,0)
 . . . s loc=$$XSUB("cectll",vals,dict,"cect"_ii_"ll")
"RTN","SAMICTT1",134,0)
 . . . n X,Y
"RTN","SAMICTT1",135,0)
 . . . s X=$$XVAL("cect"_ii_"en",vals)
"RTN","SAMICTT1",136,0)
 . . . X ^%ZOSF("UPPERCASE")
"RTN","SAMICTT1",137,0)
 . . . s nloc=Y
"RTN","SAMICTT1",138,0)
 . . . i specialcase=1 d  ;
"RTN","SAMICTT1",139,0)
 . . . . d OUT(nloc_" "_endo_" "_ii_" previously seen with possible endobronchial component")
"RTN","SAMICTT1",140,0)
 . . . . d OUT($$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",141,0)
 . . . e  d  ;
"RTN","SAMICTT1",142,0)
 . . . . ;i ($$XVAL("cetex",vals)="b")&($$XSUB("cectch",vals,dict,"cect"_ii_"ch")="n") d  ;
"RTN","SAMICTT1",143,0)
 . . . . i (($$XVAL("cetex",vals)="b")&($$XVAL("cect"_ii_"ch",vals)="n")) d  ; gpl 1002
"RTN","SAMICTT1",144,0)
 . . . . . d OUT(nloc_" "_endo_" "_ii_" "_calcstr_" with possible endobronchial component")
"RTN","SAMICTT1",145,0)
 . . . . e  d OUT(nloc_" "_endo_" "_ii_" "_calcstr_" with possible endobronchial component "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",146,0)
 . . . s skip=1
"RTN","SAMICTT1",147,0)
 . i specialcase=1 d  ;
"RTN","SAMICTT1",148,0)
 . . i skip=0 d  ;
"RTN","SAMICTT1",149,0)
 . . . d OUT("Previously seen "_nloc_" "_endo_" "_ii_" ")
"RTN","SAMICTT1",150,0)
 . . . d OUT($$XSUB("cectch",vals,dict,"cect"_ii_"ch")_".")
"RTN","SAMICTT1",151,0)
 . e  d  ;
"RTN","SAMICTT1",152,0)
 . . i skip=0 d  ;
"RTN","SAMICTT1",153,0)
 . . . ;# pleural distance only goes here
"RTN","SAMICTT1",154,0)
 . . . i $$XVAL("cect"_ii_"pld",vals)'="" s calcstr=calcstr_" "_pldstr_","
"RTN","SAMICTT1",155,0)
 . . . ;# Special Handling for "newly seen" on baseline
"RTN","SAMICTT1",156,0)
 . . . ;i ($$XVAL("cetex",vals)="b")&($$XSUB("cectch",vals,dict,"cect"_ii_"ch")="n") d  ;
"RTN","SAMICTT1",157,0)
 . . . i (($$XVAL("cetex",vals)="b")&($$XVAL("cect"_ii_"ch",vals)="n")) d  ; gpl 1002
"RTN","SAMICTT1",158,0)
 . . . . d OUT(nloc_" "_endo_" "_ii_" "_calcstr)
"RTN","SAMICTT1",159,0)
 . . . e  d OUT(nloc_" "_endo_" "_ii_" "_calcstr_" "_$$XSUB("cectch",vals,dict,"cect"_ii_"ch")_" ")
"RTN","SAMICTT1",160,0)
 . . d OUT(" (Series "_$$XVAL("cect"_ii_"sn",vals)_",") ; added from 1114 gpl1
"RTN","SAMICTT1",161,0)
 . . ;i $$XVAL("cect"_ii_"inl",vals)=$$XVAL("cect"_ii_"inh",vals) d  ;
"RTN","SAMICTT1",162,0)
 . . ;. d OUT(" image "_$$XVAL("cect"_ii_"inh",vals)_"). ")
"RTN","SAMICTT1",163,0)
 . . ;e  d  ;
"RTN","SAMICTT1",164,0)
 . . ;. d OUT(" image "_$$XVAL("cect"_ii_"inl",vals)_$$XVAL("cect"_ii_"inh",vals)_"). ")
"RTN","SAMICTT1",165,0)
 . . i $$XVAL("cect"_ii_"inh",vals)="" d  ;
"RTN","SAMICTT1",166,0)
 . . . d OUT(" image "_$$XVAL("cect"_ii_"inl",vals)_"). ")
"RTN","SAMICTT1",167,0)
 . . e  d  ;
"RTN","SAMICTT1",168,0)
 . . . d OUT(" image "_$$XVAL("cect"_ii_"inl",vals)_"-"_$$XVAL("cect"_ii_"inh",vals)_"). ")
"RTN","SAMICTT1",169,0)
 . . i $$XVAL("cect"_ii_"co",vals)'="" d OUT($$XVAL("cect"_ii_"co",vals)_". ") ;1122 gpl1
"RTN","SAMICTT1",170,0)
 . . n ac
"RTN","SAMICTT1",171,0)
 . . s ac=$$XVAL("cect"_ii_"ac",vals)
"RTN","SAMICTT1",172,0)
 . . i ac'="" i (ac'="-") i (ac'="s") d  ;
"RTN","SAMICTT1",173,0)
 . . . d OUT($$XSUB("cectac",vals,dict,"cect"_ii_"ac")_" recommended.")
"RTN","SAMICTT1",174,0)
 . ;
"RTN","SAMICTT1",175,0)
 . ; end of nodule processing
"RTN","SAMICTT1",176,0)
 . ;
"RTN","SAMICTT1",177,0)
 . s outmode="go"
"RTN","SAMICTT1",178,0)
 . d OUT("")
"RTN","SAMICTT1",179,0)
 . s outmode="hold"
"RTN","SAMICTT1",180,0)
 i firstitem'=0 d  ;
"RTN","SAMICTT1",181,0)
 . ;d OUT("</UL>")
"RTN","SAMICTT1",182,0)
 . ;d OUT("<!-- end nodule info -->")
"RTN","SAMICTT1",183,0)
 ;d OUT("</p>")
"RTN","SAMICTT1",184,0)
 ;
"RTN","SAMICTT1",185,0)
 q
"RTN","SAMICTT1",186,0)
 ;
"RTN","SAMICTT1",187,0)
OUT(ln) ;
"RTN","SAMICTT1",188,0)
 i outmode="hold" s line=line_ln q  ;
"RTN","SAMICTT1",189,0)
 s cnt=cnt+1
"RTN","SAMICTT1",190,0)
 n lnn
"RTN","SAMICTT1",191,0)
 ;s debug=1
"RTN","SAMICTT1",192,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT1",193,0)
 i outmode="go" d  ;
"RTN","SAMICTT1",194,0)
 . s @rtn@(lnn)=line
"RTN","SAMICTT1",195,0)
 . s line=""
"RTN","SAMICTT1",196,0)
 . s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT1",197,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT1",198,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT1",199,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT1",200,0)
 . n zs s zs=$STACK
"RTN","SAMICTT1",201,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT1",202,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT1",203,0)
 q
"RTN","SAMICTT1",204,0)
 ;
"RTN","SAMICTT1",205,0)
HOUT(ln) ;
"RTN","SAMICTT1",206,0)
 d OUT(ln)
"RTN","SAMICTT1",207,0)
 ;d OUT("<p><span class='sectionhead'>"_ln_"</span>")
"RTN","SAMICTT1",208,0)
 q
"RTN","SAMICTT1",209,0)
 ;
"RTN","SAMICTT1",210,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMICTT1",211,0)
 ; vals is passed by name
"RTN","SAMICTT1",212,0)
 n zr
"RTN","SAMICTT1",213,0)
 s zr=$g(@vals@(var))
"RTN","SAMICTT1",214,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMICTT1",215,0)
 q zr
"RTN","SAMICTT1",216,0)
 ;
"RTN","SAMICTT1",217,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMICTT1",218,0)
 ; vals and dict are passed by name
"RTN","SAMICTT1",219,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMICTT1",220,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMICTT1",221,0)
 n zr,zv,zdx
"RTN","SAMICTT1",222,0)
 s zdx=$g(valdx)
"RTN","SAMICTT1",223,0)
 i zdx="" s zdx=var
"RTN","SAMICTT1",224,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMICTT1",225,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMICTT1",226,0)
 i zv="" s zr="" q zr
"RTN","SAMICTT1",227,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMICTT1",228,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMICTT1",229,0)
 q zr
"RTN","SAMICTT1",230,0)
 ;
"RTN","SAMICTT2")
0^5^B84755388
"RTN","SAMICTT2",1,0)
SAMICTT2 ;ven/gpl - ielcap: forms ; 4/22/19 9:04am
"RTN","SAMICTT2",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMICTT2",3,0)
 ;
"RTN","SAMICTT2",4,0)
 ;
"RTN","SAMICTT2",5,0)
 quit  ; no entry from top
"RTN","SAMICTT2",6,0)
 ;
"RTN","SAMICTT2",7,0)
OTHRLUNG(rtn,vals,dict) ;
"RTN","SAMICTT2",8,0)
 ; repgen2,repgen3
"RTN","SAMICTT2",9,0)
 ;
"RTN","SAMICTT2",10,0)
 ; starts at "Other lung findings:"
"RTN","SAMICTT2",11,0)
 ;
"RTN","SAMICTT2",12,0)
 ;#hputs "Other lung findings:"
"RTN","SAMICTT2",13,0)
 s outmode="hold"
"RTN","SAMICTT2",14,0)
 n line s line=""
"RTN","SAMICTT2",15,0)
 ;
"RTN","SAMICTT2",16,0)
 n sp1 s sp1="  "
"RTN","SAMICTT2",17,0)
 n hfind,lfind,yespp,newct
"RTN","SAMICTT2",18,0)
 s (hfind,lfind,yespp)=0
"RTN","SAMICTT2",19,0)
 s newct=1
"RTN","SAMICTT2",20,0)
 ;
"RTN","SAMICTT2",21,0)
 ;# Add handling for new sections
"RTN","SAMICTT2",22,0)
 ;# ceopp is new, if it doensn't exist skip whole section
"RTN","SAMICTT2",23,0)
 ;# only then should old fields be included.
"RTN","SAMICTT2",24,0)
 ;
"RTN","SAMICTT2",25,0)
 i $g(newct)=1 d  ;
"RTN","SAMICTT2",26,0)
 . i "y"="y" d  ;
"RTN","SAMICTT2",27,0)
 . . s yespp=1
"RTN","SAMICTT2",28,0)
 . . i $$XVAL("cecbc",vals)="y" d  ;
"RTN","SAMICTT2",29,0)
 . . . d HLFIND ;
"RTN","SAMICTT2",30,0)
 . . . d OUT(sp1_"Cyst seen in the "_$$LOBESTR("cecbcl1^cecbcl2^cecbcl3^cecbcl4^cecbcl5",0)_".") d OUT("")
"RTN","SAMICTT2",31,0)
 . . . ;d OUT($$LOBESTR("cecbcl1^cecbcl2^cecbcl3^cecbcl4^cecbcl5",0)_".")
"RTN","SAMICTT2",32,0)
 . . . s yespp=1
"RTN","SAMICTT2",33,0)
 . . if $$XVAL("cecbb",vals)="y" d  ;
"RTN","SAMICTT2",34,0)
 . . . d HLFIND ; 
"RTN","SAMICTT2",35,0)
 . . . ;d OUT("<br>"_"Bleb or bullae seen in the ")
"RTN","SAMICTT2",36,0)
 . . . d OUT(sp1_"Bleb or bullae seen in the "_$$LOBESTR("cecbbl1^cecbbl2^cecbbl3^cecbbl4^cecbbl5",0)_".") d OUT("")
"RTN","SAMICTT2",37,0)
 . . . set yespp=1
"RTN","SAMICTT2",38,0)
 . . if $$XVAL("cebrsb",vals)="y" d  ;
"RTN","SAMICTT2",39,0)
 . . . d HLFIND ; 
"RTN","SAMICTT2",40,0)
 . . . ;d OUT("<br>"_"Bronchiectasis in the ")
"RTN","SAMICTT2",41,0)
 . . . d OUT(sp1_"Bronchiectasis in the "_$$LOBESTR("cebrsbl1^cebrsbl2^cebrsbl3^cebrsbl4^cebrsbl5",0)_".") d OUT("")
"RTN","SAMICTT2",42,0)
 . . . set yespp=1
"RTN","SAMICTT2",43,0)
 . . if $$XVAL("cebrs",vals)="y" d  ;
"RTN","SAMICTT2",44,0)
 . . . if $$XVAL("cebrsb",vals)'="y" d  ;
"RTN","SAMICTT2",45,0)
 . . . . if $$XVAL("cebrss",vals)'="y" d  ;
"RTN","SAMICTT2",46,0)
 . . . . . d HLFIND ;
"RTN","SAMICTT2",47,0)
 . . . . . ;d OUT("<br>"_"Small Airways Disease in the ")
"RTN","SAMICTT2",48,0)
 . . . . . d OUT(sp1_"Small Airways Disease in the "_$$LOBESTR("cebrsl1^cebrsl2^cebrsl3^cebrsl4^cebrsl5",0)_".") d OUT("")
"RTN","SAMICTT2",49,0)
 . . . . . set yespp=1
"RTN","SAMICTT2",50,0)
 . . if $$XVAL("cebrss",vals)="y" d  ;
"RTN","SAMICTT2",51,0)
 . . . d HLFIND ;
"RTN","SAMICTT2",52,0)
 . . . ;d OUT("<br>"_"Small Airways Disease/Bronchiolectasis in the ")
"RTN","SAMICTT2",53,0)
 . . . d OUT(sp1_"Small Airways Disease/Bronchiolectasis in the "_$$LOBESTR("cebrssl1^cebrssl2^cebrssl3^cebrssl4^cebrssl5",0)_".") d OUT("")
"RTN","SAMICTT2",54,0)
 . . . set yespp=1
"RTN","SAMICTT2",55,0)
 . . n numl,str
"RTN","SAMICTT2",56,0)
 . . s numl=0
"RTN","SAMICTT2",57,0)
 . . s str=""
"RTN","SAMICTT2",58,0)
 . . if $$XVAL("cebs",vals)="o" d  ;
"RTN","SAMICTT2",59,0)
 . . . set yespp=1
"RTN","SAMICTT2",60,0)
 . . . set numl=0
"RTN","SAMICTT2",61,0)
 . . . set str="Normal bronchial resection margin on"
"RTN","SAMICTT2",62,0)
 . . . if $$XVAL("cebsrt",vals)="r" d  ;
"RTN","SAMICTT2",63,0)
 . . . . s str=str_" right"
"RTN","SAMICTT2",64,0)
 . . . . s numl=numl+1
"RTN","SAMICTT2",65,0)
 . . . if $$XVAL("cebslt",vals)="l" d  ;
"RTN","SAMICTT2",66,0)
 . . . . if numl>0 d  ;
"RTN","SAMICTT2",67,0)
 . . . . . s str=str_" and"
"RTN","SAMICTT2",68,0)
 . . . . s str=str_" left"
"RTN","SAMICTT2",69,0)
 . . . . s numl=numl+1
"RTN","SAMICTT2",70,0)
 . . . s str=str_"."
"RTN","SAMICTT2",71,0)
 . . . if numl=0 d  ;
"RTN","SAMICTT2",72,0)
 . . . . set str="Normal bronchial resection margin noted."
"RTN","SAMICTT2",73,0)
 . . . d HLFIND ;
"RTN","SAMICTT2",74,0)
 . . . d OUT(sp1_str)
"RTN","SAMICTT2",75,0)
 . . . ;d OUT("<br>")
"RTN","SAMICTT2",76,0)
 . . ;if $$XVAL("cebrsb",vals)="y" d  ;
"RTN","SAMICTT2",77,0)
 . . ;. d HLFIND
"RTN","SAMICTT2",78,0)
 . . ;. d OUT("<br>"_"Bronchiectasis in the ")
"RTN","SAMICTT2",79,0)
 . . ;. d OUT($$LOBESTR("cebrsbl1^cebrsbl2^cebrsbl3^cebrsbl4^cebrsbl5",0)_".")
"RTN","SAMICTT2",80,0)
 . . ;. set yespp=1
"RTN","SAMICTT2",81,0)
 . . if $$XVAL("ceild",vals)="y" d  ;
"RTN","SAMICTT2",82,0)
 . . . d HLFIND
"RTN","SAMICTT2",83,0)
 . . . ;d OUT("<br>"_"Evidence of interstitial lung disease in the ")
"RTN","SAMICTT2",84,0)
 . . . d OUT(sp1_"Evidence of interstitial lung disease in the "_$$LOBESTR("ceildl1^ceildl2^ceildl3^ceildl4^ceildl5",0)_".") d OUT("")
"RTN","SAMICTT2",85,0)
 . . . set yespp=1
"RTN","SAMICTT2",86,0)
 . . if $$XVAL("cerdc",vals)="y" d  ;
"RTN","SAMICTT2",87,0)
 . . . d HLFIND
"RTN","SAMICTT2",88,0)
 . . . ;d OUT("<br>"_"Regional or diffuse consolidation in the ")
"RTN","SAMICTT2",89,0)
 . . . d OUT(sp1_"Regional or diffuse consolidation in the "_$$LOBESTR("cerdcl1^cerdcl2^cerdcl3^cerdcl4^cerdcl5",0)_".") d OUT("")
"RTN","SAMICTT2",90,0)
 . . . set yespp=1
"RTN","SAMICTT2",91,0)
 . . ;# scarring may be more complicated (apical, and bilateral)
"RTN","SAMICTT2",92,0)
 . . if $$XVAL("cescr",vals)="y" d  ;
"RTN","SAMICTT2",93,0)
 . . . d HLFIND
"RTN","SAMICTT2",94,0)
 . . . ;# If apical use "unilateral apical scarring", if bilateral use "bilateral apical scarring"
"RTN","SAMICTT2",95,0)
 . . . ;# Otherwise use our previouse construct
"RTN","SAMICTT2",96,0)
 . . . n done s done=0 ; flag to use for other scarring 
"RTN","SAMICTT2",97,0)
 . . . if $$XVAL("cescrl6",vals)="au" d  ;
"RTN","SAMICTT2",98,0)
 . . . . d OUT(sp1_"Unilateral apical scarring.") d OUT("")
"RTN","SAMICTT2",99,0)
 . . . . s done=1
"RTN","SAMICTT2",100,0)
 . . . else  if $$XVAL("cescrl7",vals)="ab" d  ;
"RTN","SAMICTT2",101,0)
 . . . . d OUT(sp1_"Bilateral apical scarring.") d OUT("")
"RTN","SAMICTT2",102,0)
 . . . . s done=1
"RTN","SAMICTT2",103,0)
 . . . if done=0  d  ;
"RTN","SAMICTT2",104,0)
 . . . . ;d OUT("<br>"_"Scarring in the ")
"RTN","SAMICTT2",105,0)
 . . . . d OUT(sp1_"Scarring in the "_$$LOBESTR("cescrl1^cescrl2^cescrl3^cescrl4^cescrl5",1)_".") d OUT("")
"RTN","SAMICTT2",106,0)
 . . . . set yespp=1
"RTN","SAMICTT2",107,0)
 . . if $$XVAL("cebat",vals)="y" d  ;
"RTN","SAMICTT2",108,0)
 . . . d HLFIND
"RTN","SAMICTT2",109,0)
 . . . ;d OUT("<br>"_"Other atelectasis in the ")
"RTN","SAMICTT2",110,0)
 . . . d OUT(sp1_"Other atelectasis in the "_$$LOBESTR("cebatl1^cebatl2^cebatl3^cebatl4^cebatl5",0)_".") d OUT("")
"RTN","SAMICTT2",111,0)
 . . . set yespp=1
"RTN","SAMICTT2",112,0)
 . . if $$XVAL("cerb",vals)="y" d  ;
"RTN","SAMICTT2",113,0)
 . . . d HLFIND
"RTN","SAMICTT2",114,0)
 . . . ;d OUT("<br>"_"Traction bronchiectasis in the ")
"RTN","SAMICTT2",115,0)
 . . . d OUT(sp1_"Traction bronchiectasis in the "_$$LOBESTR("cerbl1^cerbl2^cerbl3^cerbl4^cerbl5",0)_".") d OUT("")
"RTN","SAMICTT2",116,0)
 . . . set yespp=1
"RTN","SAMICTT2",117,0)
 . . if $$XVAL("cepgo",vals)="y" d  ;
"RTN","SAMICTT2",118,0)
 . . . d HLFIND
"RTN","SAMICTT2",119,0)
 . . . ;d OUT("<br>"_"Peripheral Ground-glass Opacities in the ")
"RTN","SAMICTT2",120,0)
 . . . d OUT(sp1_"Peripheral Ground-glass Opacities in the "_$$LOBESTR("cepgol1^cepgol2^cepgol3^cepgol4^cepgol5",0)_".") d OUT("")
"RTN","SAMICTT2",121,0)
 . . . set yespp=1
"RTN","SAMICTT2",122,0)
 . . if $$XVAL("ceret",vals)="y" d  ;
"RTN","SAMICTT2",123,0)
 . . . d HLFIND
"RTN","SAMICTT2",124,0)
 . . . ;d OUT("<br>"_"Reticulations in the ")
"RTN","SAMICTT2",125,0)
 . . . d OUT(sp1_"Reticulations in the "_$$LOBESTR("ceretl1^ceretl2^ceretl3^ceretl4^ceretl5",0)_".") d OUT("")
"RTN","SAMICTT2",126,0)
 . . . set yespp=1
"RTN","SAMICTT2",127,0)
 . . if $$XVAL("cephc",vals)="y" d  ;
"RTN","SAMICTT2",128,0)
 . . . d HLFIND
"RTN","SAMICTT2",129,0)
 . . . ;d OUT("<br>"_"Honeycombing in the ")
"RTN","SAMICTT2",130,0)
 . . . d OUT(sp1_"Honeycombing in the "_$$LOBESTR("cephcl1^cephcl2^cephcl3^cephcl4^cephcl5",0)_".") d OUT("")
"RTN","SAMICTT2",131,0)
 . . . set yespp=1
"RTN","SAMICTT2",132,0)
 . . if $$XVAL("cepp",vals)="y" d  ;
"RTN","SAMICTT2",133,0)
 . . . set yespp=1
"RTN","SAMICTT2",134,0)
 . . . set numl=0
"RTN","SAMICTT2",135,0)
 . . . set str="Pleural or fissural plaques in the "
"RTN","SAMICTT2",136,0)
 . . . if $$XVAL("cepprt",vals)="r" d  ;
"RTN","SAMICTT2",137,0)
 . . . . s str=str_"right"
"RTN","SAMICTT2",138,0)
 . . . . s numl=numl+1
"RTN","SAMICTT2",139,0)
 . . . if $$XVAL("cepplt",vals)="l" d  ;
"RTN","SAMICTT2",140,0)
 . . . . if numl>0 d  ;
"RTN","SAMICTT2",141,0)
 . . . . . s str=str_" and"
"RTN","SAMICTT2",142,0)
 . . . . s str=str_" left"
"RTN","SAMICTT2",143,0)
 . . . . s numl=numl+1
"RTN","SAMICTT2",144,0)
 . . . . if numl>1 s str=str_" lobes"
"RTN","SAMICTT2",145,0)
 . . . . else  s str=str_" lobe"
"RTN","SAMICTT2",146,0)
 . . . . if $$XVAL("ceppca",vals)="c" s str=str_" with calcifications"
"RTN","SAMICTT2",147,0)
 . . . . s str=str_"."_para
"RTN","SAMICTT2",148,0)
 . . . if numl=0 set str="Pleural or fissural plaques are noted."
"RTN","SAMICTT2",149,0)
 . . . d HLFIND
"RTN","SAMICTT2",150,0)
 . . . d OUT(sp1_str)
"RTN","SAMICTT2",151,0)
 . . ;
"RTN","SAMICTT2",152,0)
 . . ;# Note: Not used for newer CT Evaluation Forms
"RTN","SAMICTT2",153,0)
 . . ;if { 0 == [ string compare y [xval cepc] ] } {
"RTN","SAMICTT2",154,0)
 . . ;  set yespp 1
"RTN","SAMICTT2",155,0)
 . . ;     hlfind
"RTN","SAMICTT2",156,0)
 . . ;     puts "[sidestr {Pleural calcifications} cepcrt cepclt]"
"RTN","SAMICTT2",157,0)
 . . ;
"RTN","SAMICTT2",158,0)
 . . if $$XVAL("cebs",vals)="y" d  ;
"RTN","SAMICTT2",159,0)
 . . . set yespp=1
"RTN","SAMICTT2",160,0)
 . . . set numl=0
"RTN","SAMICTT2",161,0)
 . . . set str="Abnormal bronchial resection margin on"
"RTN","SAMICTT2",162,0)
 . . . d  ;
"RTN","SAMICTT2",163,0)
 . . . . if $$XVAL("cebsrt",vals)="r" d  ;
"RTN","SAMICTT2",164,0)
 . . . . . s str=str_" right"
"RTN","SAMICTT2",165,0)
 . . . . . s numl=numl+1
"RTN","SAMICTT2",166,0)
 . . . . if $$XVAL("cebslt",vals)="l" d  ;
"RTN","SAMICTT2",167,0)
 . . . . . if numl>0 s str=str_" and"
"RTN","SAMICTT2",168,0)
 . . . . . s str=str_" left"
"RTN","SAMICTT2",169,0)
 . . . . . s numl=numl+1
"RTN","SAMICTT2",170,0)
 . . . . s str=str_"."
"RTN","SAMICTT2",171,0)
 . . . if numl=0 set str="<br>"_"Abnormal bronchial resection margin noted."
"RTN","SAMICTT2",172,0)
 . . . d HLFIND
"RTN","SAMICTT2",173,0)
 . . . d OUT(sp1_str)
"RTN","SAMICTT2",174,0)
 . . . ;d OUT(para)
"RTN","SAMICTT2",175,0)
 . . ;
"RTN","SAMICTT2",176,0)
 . . if $L($$XVAL("ceoppa",vals))'=0 d  ;
"RTN","SAMICTT2",177,0)
 . . . ;# puts "Additional Comments on Parenchymal or Pleural Abnormalities:"
"RTN","SAMICTT2",178,0)
 . . . d HLFIND
"RTN","SAMICTT2",179,0)
 . . . d OUT(sp1_$$XVAL("ceoppa",vals)_".") d OUT("")
"RTN","SAMICTT2",180,0)
 . . . ;d OUT(para)
"RTN","SAMICTT2",181,0)
 . . else  if yespp=1  ;d OUT(para)
"RTN","SAMICTT2",182,0)
 s outmode="go" d OUT("")
"RTN","SAMICTT2",183,0)
 q
"RTN","SAMICTT2",184,0)
 ;
"RTN","SAMICTT2",185,0)
LOBESTR(lst,opt) ; extrinsic returns lobes
"RTN","SAMICTT2",186,0)
 ; lst is of the for a^b^c where a,b and c are variable names
"RTN","SAMICTT2",187,0)
 n rtstr,lln,tary
"RTN","SAMICTT2",188,0)
 s tary=""
"RTN","SAMICTT2",189,0)
 s rtstr=""
"RTN","SAMICTT2",190,0)
 s lln=$l(lst,"^")
"RTN","SAMICTT2",191,0)
 f lzi=1:1:lln d  ;
"RTN","SAMICTT2",192,0)
 . n tval
"RTN","SAMICTT2",193,0)
 . s tval=$$XVAL($p(lst,"^",lzi),vals)
"RTN","SAMICTT2",194,0)
 . n X,Y S X=tval X ^%ZOSF("UPPERCASE")
"RTN","SAMICTT2",195,0)
 . s tval=Y
"RTN","SAMICTT2",196,0)
 . i tval'="" s tary($o(tary(""),-1)+1)=tval
"RTN","SAMICTT2",197,0)
 n tcnt s tcnt=$o(tary(""),-1)
"RTN","SAMICTT2",198,0)
 q:tcnt=0
"RTN","SAMICTT2",199,0)
 i tcnt=1 q tary(1)
"RTN","SAMICTT2",200,0)
 i tcnt=2 q tary(1)_" and "_tary(2)
"RTN","SAMICTT2",201,0)
 f lzi=1:1:tcnt s rtstr=rtstr_tary(lzi)_$s(lzi<tcnt:", ",1:"")
"RTN","SAMICTT2",202,0)
 q rtstr
"RTN","SAMICTT2",203,0)
 ;
"RTN","SAMICTT2",204,0)
HLFIND() ; references and sets lfind in calling routine
"RTN","SAMICTT2",205,0)
 i $g(lfind)=0 d  ;
"RTN","SAMICTT2",206,0)
 . d HOUT("Other lung findings:")
"RTN","SAMICTT2",207,0)
 . d OUT("")
"RTN","SAMICTT2",208,0)
 . s lfind=1
"RTN","SAMICTT2",209,0)
 q
"RTN","SAMICTT2",210,0)
 ;
"RTN","SAMICTT2",211,0)
OUT(ln) ;
"RTN","SAMICTT2",212,0)
 i outmode="hold" s line=line_ln q  ;
"RTN","SAMICTT2",213,0)
 s cnt=cnt+1
"RTN","SAMICTT2",214,0)
 n lnn
"RTN","SAMICTT2",215,0)
 i $g(debug)'=1 s debug=0
"RTN","SAMICTT2",216,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT2",217,0)
 i outmode="go" d  ;
"RTN","SAMICTT2",218,0)
 . s @rtn@(lnn)=line
"RTN","SAMICTT2",219,0)
 . s line=""
"RTN","SAMICTT2",220,0)
 . s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT2",221,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT2",222,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT2",223,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT2",224,0)
 . n zs s zs=$STACK
"RTN","SAMICTT2",225,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT2",226,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT2",227,0)
 q
"RTN","SAMICTT2",228,0)
 ;
"RTN","SAMICTT2",229,0)
OUTold(ln) ;
"RTN","SAMICTT2",230,0)
 s cnt=cnt+1
"RTN","SAMICTT2",231,0)
 n lnn
"RTN","SAMICTT2",232,0)
 ;s debug=1
"RTN","SAMICTT2",233,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT2",234,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT2",235,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT2",236,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT2",237,0)
 . n zs s zs=$STACK
"RTN","SAMICTT2",238,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT2",239,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT2",240,0)
 q
"RTN","SAMICTT2",241,0)
 ;
"RTN","SAMICTT2",242,0)
HOUT(ln) ;
"RTN","SAMICTT2",243,0)
 d OUT("<p><span class='sectionhead'>"_ln_"</span>")
"RTN","SAMICTT2",244,0)
 q
"RTN","SAMICTT2",245,0)
 ;
"RTN","SAMICTT2",246,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMICTT2",247,0)
 ; vals is passed by name
"RTN","SAMICTT2",248,0)
 n zr
"RTN","SAMICTT2",249,0)
 s zr=$g(@vals@(var))
"RTN","SAMICTT2",250,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMICTT2",251,0)
 q zr
"RTN","SAMICTT2",252,0)
 ;
"RTN","SAMICTT2",253,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMICTT2",254,0)
 ; vals and dict are passed by name
"RTN","SAMICTT2",255,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMICTT2",256,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMICTT2",257,0)
 n zr,zv,zdx
"RTN","SAMICTT2",258,0)
 s zdx=$g(valdx)
"RTN","SAMICTT2",259,0)
 i zdx="" s zdx=var
"RTN","SAMICTT2",260,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMICTT2",261,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMICTT2",262,0)
 i zv="" s zr="" q zr
"RTN","SAMICTT2",263,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMICTT2",264,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMICTT2",265,0)
 q zr
"RTN","SAMICTT2",266,0)
 ;
"RTN","SAMICTT3")
0^6^B165906260
"RTN","SAMICTT3",1,0)
SAMICTR3 ;ven/gpl - ielcap: forms ; 1/23/19 5:14pm
"RTN","SAMICTT3",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMICTT3",3,0)
 ;
"RTN","SAMICTT3",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMICTT3",5,0)
 ;
"RTN","SAMICTT3",6,0)
 quit  ; no entry from top
"RTN","SAMICTT3",7,0)
 ;
"RTN","SAMICTT3",8,0)
EMPHYS(rtn,vals,dict) ;
"RTN","SAMICTT3",9,0)
 ; repgen4,repgen5
"RTN","SAMICTT3",10,0)
 ;  
"RTN","SAMICTT3",11,0)
 ;# Emphysema
"RTN","SAMICTT3",12,0)
 ;
"RTN","SAMICTT3",13,0)
 n sp1 s sp1="  "
"RTN","SAMICTT3",14,0)
 s outmode="hold" s line=""
"RTN","SAMICTT3",15,0)
 ;if $$XVAL("ceemv",vals)'="e" d  ;
"RTN","SAMICTT3",16,0)
 if $$XVAL("ceem",vals)'="" d  ;
"RTN","SAMICTT3",17,0)
 . if $$XVAL("ceem",vals)="nv" q  ;
"RTN","SAMICTT3",18,0)
 . if $$XVAL("ceem",vals)="no" q  ;
"RTN","SAMICTT3",19,0)
 . ;d OUT("")
"RTN","SAMICTT3",20,0)
 . D HOUT("Emphysema: ")
"RTN","SAMICTT3",21,0)
 . ;d OUT("")
"RTN","SAMICTT3",22,0)
 . D OUT(sp1_$$XSUB("ceem",vals,dict))
"RTN","SAMICTT3",23,0)
 . s outmode="go" d OUT("")
"RTN","SAMICTT3",24,0)
 ;
"RTN","SAMICTT3",25,0)
 ;d OUT("")
"RTN","SAMICTT3",26,0)
 s outmode="hold"
"RTN","SAMICTT3",27,0)
 D HOUT("Pleura: ")
"RTN","SAMICTT3",28,0)
 ;d OUT("")
"RTN","SAMICTT3",29,0)
 ; hputs "Pleura:"
"RTN","SAMICTT3",30,0)
 N pe s pe=0
"RTN","SAMICTT3",31,0)
 ;
"RTN","SAMICTT3",32,0)
 ; # Pleural Effusion
"RTN","SAMICTT3",33,0)
 ; 
"RTN","SAMICTT3",34,0)
 i $$XVAL("cepev",vals)="y" d  ;
"RTN","SAMICTT3",35,0)
 . if $$XVAL("ceper",vals)="-" d  ;
"RTN","SAMICTT3",36,0)
 . . if $$XVAL("cepel",vals)="-" d  ;
"RTN","SAMICTT3",37,0)
 . . . s @vals@("cepev")="e"
"RTN","SAMICTT3",38,0)
 . ;
"RTN","SAMICTT3",39,0)
 . if $$XVAL("cepev",vals)'="e" d  ;
"RTN","SAMICTT3",40,0)
 . . if $$XVAL("ceper",vals)'="-" d  ;
"RTN","SAMICTT3",41,0)
 . . . if $$XVAL("cepel",vals)'="-" d  ;
"RTN","SAMICTT3",42,0)
 . . . . if $$XVAL("cepel",vals)=$$XVAL("ceper",vals) d  ;
"RTN","SAMICTT3",43,0)
 . . . . . d OUT(sp1_"Bilateral "_$$XSUB("cepe",vals,dict,"cepel")_" pleural effusions.") d OUT("")
"RTN","SAMICTT3",44,0)
 . . . . else  d  ;
"RTN","SAMICTT3",45,0)
 . . . . . d OUT(sp1_"Bilateral pleural effusions ; "_$$XSUB("cepe",vals,dict,"cepel")_" on left, and "_$$XSUB("cepe",vals,dict,"ceper")_" on right.")
"RTN","SAMICTT3",46,0)
 . . . . . s pe=1
"RTN","SAMICTT3",47,0)
 . . . else  d  ;
"RTN","SAMICTT3",48,0)
 . . . . d OUT(sp1_"On right "_$$XSUB("cepe",vals,dict,"cepr")_" pleural effusion and on left "_$$XSUB("cepe",vals,dict,"cepel")_" pleural effusion.") d OUT("")
"RTN","SAMICTT3",49,0)
 . . . . s pe=1
"RTN","SAMICTT3",50,0)
 . . else  d  ;
"RTN","SAMICTT3",51,0)
 . . . d OUT(sp1_"On right "_$$XSUB("cepe",vals,dict,"cepr")_" pleural effusion and on left "_$$XSUB("cepe",vals,dict,"cepel")_" pleural effusion.") d OUT("")
"RTN","SAMICTT3",52,0)
 . . . s pe=1
"RTN","SAMICTT3",53,0)
 . ;
"RTN","SAMICTT3",54,0)
 i $$XVAL("cepev",vals)'="y" d  ; 
"RTN","SAMICTT3",55,0)
 . d OUT(sp1_"No pleural effusions.") d OUT("")
"RTN","SAMICTT3",56,0)
 ;  if { $pe == 0 } {
"RTN","SAMICTT3",57,0)
 ;    puts "[tr "No pleural effusions"].${para}"
"RTN","SAMICTT3",58,0)
 ;  }
"RTN","SAMICTT3",59,0)
 ;  
"RTN","SAMICTT3",60,0)
 n yespp s yespp=0
"RTN","SAMICTT3",61,0)
 ;
"RTN","SAMICTT3",62,0)
 if $$XVAL("cebatr",vals)="y" d  ;
"RTN","SAMICTT3",63,0)
 . ;d OUT("Rounded atelectasis in the ")
"RTN","SAMICTT3",64,0)
 . d OUT(sp1_"Rounded atelectasis in the "_$$LOBESTR^SAMICTR2("cebatrl1^cebatrl2^cebatrl3^cebatrl4^cebatrl5",0)_".") ;d OUT("")
"RTN","SAMICTT3",65,0)
 . s yespp=1
"RTN","SAMICTT3",66,0)
 ;
"RTN","SAMICTT3",67,0)
 if $$XVAL("cept",vals)="y" d  ;
"RTN","SAMICTT3",68,0)
 . s yespp=1
"RTN","SAMICTT3",69,0)
 . s numl=0
"RTN","SAMICTT3",70,0)
 . set str=sp1_"Pleural thickening/plaques in the "
"RTN","SAMICTT3",71,0)
 . if $$XVAL("ceptrt",vals)="r" d  ;
"RTN","SAMICTT3",72,0)
 . . s str=str_"right"
"RTN","SAMICTT3",73,0)
 . . s numl=numl+1
"RTN","SAMICTT3",74,0)
 . if $$XVAL("ceptlt",vals)="l" d  ;
"RTN","SAMICTT3",75,0)
 . . i numl>0 d  ;
"RTN","SAMICTT3",76,0)
 . . . s str=str_" and"
"RTN","SAMICTT3",77,0)
 . . s str=str_" left"
"RTN","SAMICTT3",78,0)
 . . s numl=numl+1
"RTN","SAMICTT3",79,0)
 . ;if numl>1 d  ;
"RTN","SAMICTT3",80,0)
 . ;. s str=str_" lungs."
"RTN","SAMICTT3",81,0)
 . ;else  d  ;
"RTN","SAMICTT3",82,0)
 . ;. s str=str_" lung."
"RTN","SAMICTT3",83,0)
 . s str=str_"."
"RTN","SAMICTT3",84,0)
 . if numl=0 set str=sp1_"Pleural thickening/plaques."
"RTN","SAMICTT3",85,0)
 . d OUT(str) ;d OUT("")
"RTN","SAMICTT3",86,0)
 ;
"RTN","SAMICTT3",87,0)
 if $$XVAL("cepu",vals)="y" d  ;
"RTN","SAMICTT3",88,0)
 . s yespp=1
"RTN","SAMICTT3",89,0)
 . if $l($$XVAL("cepus",vals))'=0 d  ;
"RTN","SAMICTT3",90,0)
 . . d OUT(sp1_"Pleural rumor: "_$$XVAL("cepus",vals)) 
"RTN","SAMICTT3",91,0)
 . e  d OUT(sp1_"Pleural tumor.")
"RTN","SAMICTT3",92,0)
 . ;d OUT("")
"RTN","SAMICTT3",93,0)
 ;
"RTN","SAMICTT3",94,0)
 i yespp=0 d OUT("")
"RTN","SAMICTT3",95,0)
 ;
"RTN","SAMICTT3",96,0)
 d  ;
"RTN","SAMICTT3",97,0)
 . if $$XVAL("ceoppab",vals)'="" d OUT(sp1_$$XVAL("ceoppab",vals)_".") ;d OUT("")
"RTN","SAMICTT3",98,0)
 . else  d
"RTN","SAMICTT3",99,0)
 . . if yespp=1 d OUT("")
"RTN","SAMICTT3",100,0)
 ;
"RTN","SAMICTT3",101,0)
 s outmode="go" d OUT("")
"RTN","SAMICTT3",102,0)
 ;
"RTN","SAMICTT3",103,0)
 s outmode="hold"
"RTN","SAMICTT3",104,0)
 d OUT("Coronary Artery Calcifications: ")
"RTN","SAMICTT3",105,0)
 ;# Coronary Calcification
"RTN","SAMICTT3",106,0)
 n vcac,cac,cacrec
"RTN","SAMICTT3",107,0)
 s (cac,cacrec)=""
"RTN","SAMICTT3",108,0)
 ;
"RTN","SAMICTT3",109,0)
 if $$XVAL("cecccac",vals)'="" d  ;
"RTN","SAMICTT3",110,0)
 . s @vals@("ceccv")="e"
"RTN","SAMICTT3",111,0)
 ;
"RTN","SAMICTT3",112,0)
 d  if $$XVAL("ceccv",vals)'="n" d  ;
"RTN","SAMICTT3",113,0)
 . set vcac=$$XVAL("cecccac",vals)
"RTN","SAMICTT3",114,0)
 . if vcac'="" d  ;
"RTN","SAMICTT3",115,0)
 . . s cacrec=""
"RTN","SAMICTT3",116,0)
 . . s cac="The Visual Coronary Artery Calcium (CAC) Score is "_vcac_". "
"RTN","SAMICTT3",117,0)
 . . s cacval=vcac
"RTN","SAMICTT3",118,0)
 . . i cacval>3 s cacrec=$g(@dict@("CAC_recommendation"))
"RTN","SAMICTT3",119,0)
 ;
"RTN","SAMICTT3",120,0)
 ;
"RTN","SAMICTT3",121,0)
 n samicac s samicac=0
"RTN","SAMICTT3",122,0)
 i $$XVAL("cecclm",vals)'="no" s samicac=1
"RTN","SAMICTT3",123,0)
 i $$XVAL("ceccld",vals)'="no" s samicac=1
"RTN","SAMICTT3",124,0)
 ;i $$XVAL("cecclf",vals)'="no" s samicac=1
"RTN","SAMICTT3",125,0)
 i $$XVAL("cecccf",vals)'="no" s samicac=1
"RTN","SAMICTT3",126,0)
 i $$XVAL("ceccrc",vals)'="no" s samicac=1
"RTN","SAMICTT3",127,0)
 ;
"RTN","SAMICTT3",128,0)
 ;s outmode="hold" s line=""
"RTN","SAMICTT3",129,0)
 i samicac=1 d  ;
"RTN","SAMICTT3",130,0)
 . d OUT($$XSUB("cecc",vals,dict,"cecclm")_" in left main, ")
"RTN","SAMICTT3",131,0)
 . d OUT($$XSUB("cecc",vals,dict,"ceccld")_" in left anterior descending, ")
"RTN","SAMICTT3",132,0)
 . ;d OUT($$XSUB("cecc",vals,dict,"cecclf")_" in circumflex, and ")
"RTN","SAMICTT3",133,0)
 . d OUT($$XSUB("cecc",vals,dict,"cecccf")_" in circumflex, and ")
"RTN","SAMICTT3",134,0)
 . d OUT($$XSUB("cecc",vals,dict,"ceccrc")_" in right coronary. "_cac)
"RTN","SAMICTT3",135,0)
 . s outmode="go"
"RTN","SAMICTT3",136,0)
 . d OUT("")
"RTN","SAMICTT3",137,0)
 ; 
"RTN","SAMICTT3",138,0)
 s outmode="hold"
"RTN","SAMICTT3",139,0)
 if $$XVAL("cecca",vals)'="-" d  ;
"RTN","SAMICTT3",140,0)
 . d HOUT("Aortic Calcifications: ")
"RTN","SAMICTT3",141,0)
 . d OUT($$XSUB("cecc",vals,dict,"cecca"))
"RTN","SAMICTT3",142,0)
 . s outmode="go" d OUT("")
"RTN","SAMICTT3",143,0)
 ;
"RTN","SAMICTT3",144,0)
 s outmode="hold"
"RTN","SAMICTT3",145,0)
 d HOUT("Cardiac Findings: ")
"RTN","SAMICTT3",146,0)
 ;
"RTN","SAMICTT3",147,0)
 ;s outmode="hold"
"RTN","SAMICTT3",148,0)
 ;# Pericardial Effusion
"RTN","SAMICTT3",149,0)
 if $$XVAL("ceprevm",vals)'="-" d  ;
"RTN","SAMICTT3",150,0)
 . if $$XVAL("ceprevm",vals)'="no" d  ;
"RTN","SAMICTT3",151,0)
 . . if $$XVAL("ceprevm",vals)'="" d
"RTN","SAMICTT3",152,0)
 . . . d OUT("A "_$$XSUB("ceprevm",vals,dict,"ceprevm")_" pericardial effusion"_".") d OUT("")
"RTN","SAMICTT3",153,0)
 . . . s pe=1
"RTN","SAMICTT3",154,0)
 . . else  d OUT("No pericardial effusion.") d OUT("")
"RTN","SAMICTT3",155,0)
 ;
"RTN","SAMICTT3",156,0)
 ;
"RTN","SAMICTT3",157,0)
 ;;# Pulmonary and Aortic Diameter
"RTN","SAMICTT3",158,0)
 i $$XVAL("cepaw",vals)'="" d  ;
"RTN","SAMICTT3",159,0)
 . d OUT("Widest main pulmonary artery diameter is "_$$XVAL("cepaw",vals)_" mm. ")
"RTN","SAMICTT3",160,0)
 . if $$XVAL("ceaow",vals)'="" d  ;
"RTN","SAMICTT3",161,0)
 . . d OUT("Widest ascending aortic diameter at the same level is "_$$XVAL("ceaow",vals)_" mm. ")
"RTN","SAMICTT3",162,0)
 . . if $$XVAL("cepar",vals)'="" d  ;
"RTN","SAMICTT3",163,0)
 . . . d OUT("The ratio is "_$$XVAL("cepar",vals)_". ")
"RTN","SAMICTT3",164,0)
 . d OUT("")
"RTN","SAMICTT3",165,0)
 ;
"RTN","SAMICTT3",166,0)
 ; #"Additional Comments on Cardiac Abnormalities:"
"RTN","SAMICTT3",167,0)
 if $$XVAL("cecommca",vals)'="" d  ;
"RTN","SAMICTT3",168,0)
 . d OUT($$XVAL("cecommca",vals)_".")
"RTN","SAMICTT3",169,0)
 s outmode="go"
"RTN","SAMICTT3",170,0)
 d OUT("")
"RTN","SAMICTT3",171,0)
 ;
"RTN","SAMICTT3",172,0)
 ;
"RTN","SAMICTT3",173,0)
 s outmode="hold"
"RTN","SAMICTT3",174,0)
 d HOUT("Mediastinum: ")
"RTN","SAMICTT3",175,0)
 n yesmm s yesmm=0
"RTN","SAMICTT3",176,0)
 n abn
"RTN","SAMICTT3",177,0)
 i ($$XVAL("ceoma",vals)="y")&($$XVAL("ceata",vals)="y") d  ;
"RTN","SAMICTT3",178,0)
 . s yeamm=1
"RTN","SAMICTT3",179,0)
 . s abn=$$CCMSTR("ceatc^ceaty^ceatm",vals)
"RTN","SAMICTT3",180,0)
 . ;d OUT("[abn="_abn_"]")
"RTN","SAMICTT3",181,0)
 . i abn="" d OUT(sp1_"Noted in the thyroid.")
"RTN","SAMICTT3",182,0)
 . i abn'="" d OUT(sp1_abn_" thyroid.")
"RTN","SAMICTT3",183,0)
 . i $$XVAL("ceato",vals)="o" d OUT(sp1_$$XVAL("ceatos",vals)_"<br>")
"RTN","SAMICTT3",184,0)
 i $$XVAL("ceaya",vals)="y" d  ;
"RTN","SAMICTT3",185,0)
 . s yesmm=1
"RTN","SAMICTT3",186,0)
 . s abn=$$CCMSTR("ceayc^ceayy^ceaym",vals)
"RTN","SAMICTT3",187,0)
 . i abn="" d OUT(sp1_"Noted in the thymus")
"RTN","SAMICTT3",188,0)
 . i abn'="" d OUT(sp1_abn_" thymus.")
"RTN","SAMICTT3",189,0)
 . i $$XVAL("ceayo",vals)="o" d OUT(sp1_$$XVAL("ceayos",vals))
"RTN","SAMICTT3",190,0)
 ;
"RTN","SAMICTT3",191,0)
 ;   # Non-calcified lymph nodes
"RTN","SAMICTT3",192,0)
 n lnlist,lnlistt
"RTN","SAMICTT3",193,0)
 set lnlist(1)="cemlnl1"
"RTN","SAMICTT3",194,0)
 set lnlist(2)="cemlnl2r"
"RTN","SAMICTT3",195,0)
 set lnlist(3)="cemlnl2l"
"RTN","SAMICTT3",196,0)
 set lnlist(4)="cemlnl3"
"RTN","SAMICTT3",197,0)
 set lnlist(5)="cemlnl4r"
"RTN","SAMICTT3",198,0)
 set lnlist(6)="cemlnl4l"
"RTN","SAMICTT3",199,0)
 set lnlist(7)="cemlnl5"
"RTN","SAMICTT3",200,0)
 set lnlist(8)="cemlnl6"
"RTN","SAMICTT3",201,0)
 set lnlist(9)="cemlnl7"
"RTN","SAMICTT3",202,0)
 set lnlist(10)="cemlnl8"
"RTN","SAMICTT3",203,0)
 set lnlist(11)="cemlnl9"
"RTN","SAMICTT3",204,0)
 set lnlist(12)="cemlnl10r"
"RTN","SAMICTT3",205,0)
 set lnlist(13)="cemlnl10l"
"RTN","SAMICTT3",206,0)
 ;
"RTN","SAMICTT3",207,0)
 set lnlistt(1)="high mediastinal"
"RTN","SAMICTT3",208,0)
 set lnlistt(2)="right upper paratracheal"
"RTN","SAMICTT3",209,0)
 set lnlistt(3)="left upper paratracheal"
"RTN","SAMICTT3",210,0)
 set lnlistt(4)="prevascular/retrotracheal"
"RTN","SAMICTT3",211,0)
 set lnlistt(5)="right lower paratracheal"
"RTN","SAMICTT3",212,0)
 set lnlistt(6)="left lower paratracheal"
"RTN","SAMICTT3",213,0)
 set lnlistt(7)="sub-aortic (A-P window)"
"RTN","SAMICTT3",214,0)
 set lnlistt(8)="para-aortic"
"RTN","SAMICTT3",215,0)
 set lnlistt(9)="subcarinal"
"RTN","SAMICTT3",216,0)
 set lnlistt(10)="para-esophageal"
"RTN","SAMICTT3",217,0)
 set lnlistt(11)="pulmonary ligament"
"RTN","SAMICTT3",218,0)
 set lnlistt(12)="right hilar"
"RTN","SAMICTT3",219,0)
 set lnlistt(13)="left hilar"
"RTN","SAMICTT3",220,0)
 ;
"RTN","SAMICTT3",221,0)
 ;
"RTN","SAMICTT3",222,0)
 ;s outmode="hold"
"RTN","SAMICTT3",223,0)
 if $$XVAL("cemln",vals)="y" d  ;
"RTN","SAMICTT3",224,0)
 . s yesmm=1
"RTN","SAMICTT3",225,0)
 . n llist,item
"RTN","SAMICTT3",226,0)
 . s (llist,item)=""
"RTN","SAMICTT3",227,0)
 . f  s item=$o(lnlist(item)) q:item=""  d  ;
"RTN","SAMICTT3",228,0)
 . . i $$XVAL(lnlist(item),vals)'="" s llist($o(llist(""),-1)+1)=lnlist(item)
"RTN","SAMICTT3",229,0)
 . n lnum,slnum
"RTN","SAMICTT3",230,0)
 . s lnum=$o(llist(""),-1)
"RTN","SAMICTT3",231,0)
 . i lnum=0 d OUT("Enlarged or growing lymph nodes are noted.")
"RTN","SAMICTT3",232,0)
 . i lnum>0 d  ;
"RTN","SAMICTT3",233,0)
 . . s slnum=lnum
"RTN","SAMICTT3",234,0)
 . . d OUT("Enlarged or growing lymph nodes in the ")
"RTN","SAMICTT3",235,0)
 . . s item=""
"RTN","SAMICTT3",236,0)
 . . f  s item=$o(llist(item)) q:item=""  d  ;
"RTN","SAMICTT3",237,0)
 . . . d OUT(lnlistt(item))
"RTN","SAMICTT3",238,0)
 . . . i lnum>2 d OUT(", ")
"RTN","SAMICTT3",239,0)
 . . . i lnum=2 d OUT(" and ")
"RTN","SAMICTT3",240,0)
 . . . s lnum=lnum-1
"RTN","SAMICTT3",241,0)
 . . i slnum>1 d OUT(" locations.")
"RTN","SAMICTT3",242,0)
 . . i slnum=1 d OUT(" location.")
"RTN","SAMICTT3",243,0)
 ;
"RTN","SAMICTT3",244,0)
 ;s outmode="go"
"RTN","SAMICTT3",245,0)
 ;d OUT("")
"RTN","SAMICTT3",246,0)
 ;
"RTN","SAMICTT3",247,0)
 if $$XVAL("cemlncab",vals)="y" d  ;
"RTN","SAMICTT3",248,0)
 . set yesmm=1
"RTN","SAMICTT3",249,0)
 . d OUT("Calcified lymph nodes present.")
"RTN","SAMICTT3",250,0)
 ;
"RTN","SAMICTT3",251,0)
 if $$XVAL("ceagaln",vals)="y" d  ;
"RTN","SAMICTT3",252,0)
 . set yesmm=1
"RTN","SAMICTT3",253,0)
 . d OUT("Enlarged or growing axillary lymph nodes without central fat are seen.")
"RTN","SAMICTT3",254,0)
 . d OUT($$XVAL("ceagalns",vals))
"RTN","SAMICTT3",255,0)
 ;
"RTN","SAMICTT3",256,0)
 if $$XVAL("cemva",vals)="y" d  ;
"RTN","SAMICTT3",257,0)
 . set yesmm=1
"RTN","SAMICTT3",258,0)
 . if $$XVAL("cemvaa",vals)="a" d  ;
"RTN","SAMICTT3",259,0)
 . . d OUT("Other vascular abnormalities are seen in the aorta.")
"RTN","SAMICTT3",260,0)
 . if $$XVAL("cemvaa",vals)="w" d  ;
"RTN","SAMICTT3",261,0)
 . . d OUT("Other vascular abnormalities are seen in the pulmonary series.")
"RTN","SAMICTT3",262,0)
 . d OUT($$XVAL("cemvaos",vals)_"<br>")
"RTN","SAMICTT3",263,0)
 ;
"RTN","SAMICTT3",264,0)
 ;s outmode="hold"
"RTN","SAMICTT3",265,0)
 ;   # Esophageal
"RTN","SAMICTT3",266,0)
 if $$XVAL("cemeln",vals)="y" d  ;
"RTN","SAMICTT3",267,0)
 . set yesmm=1
"RTN","SAMICTT3",268,0)
 . n elist s elist=""
"RTN","SAMICTT3",269,0)
 . set numl=0
"RTN","SAMICTT3",270,0)
 . if $$XVAL("cemelna",vals)="a" d  ;
"RTN","SAMICTT3",271,0)
 . . s elist($o(elist(""),-1)+1)="Air-fluid level"
"RTN","SAMICTT3",272,0)
 . . s numl=numl+1
"RTN","SAMICTT3",273,0)
 . if $$XVAL("cemelnw",vals)="w" d  ;
"RTN","SAMICTT3",274,0)
 . . s elist($o(elist(""),-1)+1)="Wall thickening"
"RTN","SAMICTT3",275,0)
 . . s numl=numl+1
"RTN","SAMICTT3",276,0)
 . if $$XVAL("cemelnm",vals)="m" d  ;
"RTN","SAMICTT3",277,0)
 . . s elist($o(elist(""),-1)+1)="A mass"
"RTN","SAMICTT3",278,0)
 . . s numl=numl+1
"RTN","SAMICTT3",279,0)
 . if numl=0 d OUT("Esophageal abnormality noted.")
"RTN","SAMICTT3",280,0)
 . e  d  ;
"RTN","SAMICTT3",281,0)
 . . d OUT($g(elist(1)))
"RTN","SAMICTT3",282,0)
 . . if numl=1 d OUT(" is ")
"RTN","SAMICTT3",283,0)
 . . e  d  ;
"RTN","SAMICTT3",284,0)
 . . . if numl=2 d  ;
"RTN","SAMICTT3",285,0)
 . . . . d OUT(" and ")
"RTN","SAMICTT3",286,0)
 . . . e  d OUT(", ")
"RTN","SAMICTT3",287,0)
 . . . d OUT($$LOWC($g(elist(2))))
"RTN","SAMICTT3",288,0)
 . . . if numl=3 d  ;
"RTN","SAMICTT3",289,0)
 . . . . d OUT(", and "_$$LOWC($g(elist(3))))
"RTN","SAMICTT3",290,0)
 . . d OUT("seen in the esophagus.")
"RTN","SAMICTT3",291,0)
 . d OUT($$XVAL("cemelnos",vals))
"RTN","SAMICTT3",292,0)
 ;s outmode="go"
"RTN","SAMICTT3",293,0)
 ;d OUT("")
"RTN","SAMICTT3",294,0)
 ;
"RTN","SAMICTT3",295,0)
 ;
"RTN","SAMICTT3",296,0)
 if $$XVAL("cehhn",vals)="y" d  ;
"RTN","SAMICTT3",297,0)
 . set yesmm=1
"RTN","SAMICTT3",298,0)
 . if $$XVAL("cehhnos",vals)'="" d OUT("Hiatal hernia: "_$$XVAL("cehhnos",vals))
"RTN","SAMICTT3",299,0)
 . if $$XVAL("cehhnos",vals)="" d OUT("Hiatal hernia.")
"RTN","SAMICTT3",300,0)
 . d OUT("")
"RTN","SAMICTT3",301,0)
 ;
"RTN","SAMICTT3",302,0)
 if $$XVAL("ceomm",vals)="y" d  ;
"RTN","SAMICTT3",303,0)
 . set yesmm=1
"RTN","SAMICTT3",304,0)
 . n tval
"RTN","SAMICTT3",305,0)
 . set tval=$$XVAL("ceommos",vals)
"RTN","SAMICTT3",306,0)
 . set abn=$$CCMSTR("ceamc^ceamy^ceamm",vals)
"RTN","SAMICTT3",307,0)
 . if abn="" d OUT(sp1_"Abnormality noted in the mediastinum. ")
"RTN","SAMICTT3",308,0)
 . e  d OUT(sp1_abn_" mediastinum. ")
"RTN","SAMICTT3",309,0)
 . d OUT(tval)
"RTN","SAMICTT3",310,0)
 i yesmm=0 d OUT(sp1_"No abnormalities.")
"RTN","SAMICTT3",311,0)
 i $$XVAL("ceotabnm",vals)'="" d  ;
"RTN","SAMICTT3",312,0)
 . d OUT(sp1_$$XVAL("ceotabnm",vals)_".")
"RTN","SAMICTT3",313,0)
 s outmode="go"
"RTN","SAMICTT3",314,0)
 d OUT("")
"RTN","SAMICTT3",315,0)
 ;
"RTN","SAMICTT3",316,0)
 ;
"RTN","SAMICTT3",317,0)
 q
"RTN","SAMICTT3",318,0)
 ;
"RTN","SAMICTT3",319,0)
 ;
"RTN","SAMICTT3",320,0)
CCMSTR(lst,vals) ; extrinsic that forms phrases
"RTN","SAMICTT3",321,0)
 n retstr s retstr=""
"RTN","SAMICTT3",322,0)
 n lblist s lblist=""
"RTN","SAMICTT3",323,0)
 n lb,ib s ib=""
"RTN","SAMICTT3",324,0)
 f lb=1:1:$l(lst,"^") d  ;
"RTN","SAMICTT3",325,0)
 . n lvar s lvar=$p(lst,"^",lb)
"RTN","SAMICTT3",326,0)
 . s ib=$$XVAL($p(lst,"^",lb),vals)
"RTN","SAMICTT3",327,0)
 . if ib'="" d  ;
"RTN","SAMICTT3",328,0)
 . . i ib="y" d  ; 
"RTN","SAMICTT3",329,0)
 . . . i $f("ceasc cealc ceapc ceapc ceaac ceakc",lvar)>0 s lblist($o(lblist(""),-1)+1)="Calcification"
"RTN","SAMICTT3",330,0)
 . . . ;i "ceasc cealc ceapc ceapc ceaac ceakc"[lb s lblist($o(lblist(""),-1)+1)="Calcification"
"RTN","SAMICTT3",331,0)
 . . . else  s lblist($o(lblist(""),-1)+1)="Cyst"
"RTN","SAMICTT3",332,0)
 . . i ib="c" s lblist($o(lblist(""),-1)+1)="Calcification"
"RTN","SAMICTT3",333,0)
 . . i ib="m" s lblist($o(lblist(""),-1)+1)="Mass"
"RTN","SAMICTT3",334,0)
 i $o(lblist(""),-1)=1 s retstr=retstr_lblist(1)_" is seen in the"
"RTN","SAMICTT3",335,0)
 e  i $o(lblist(""),-1)=2 s retstr=retstr_lblist(1)_" and "_$$LOWC(lblist(2))_" are seen in the"
"RTN","SAMICTT3",336,0)
 e  i $o(lblist(""),-1)=3 s retstr=retstr_"Calicification, cyst, and mass are seen in the"
"RTN","SAMICTT3",337,0)
 q retstr
"RTN","SAMICTT3",338,0)
 ;
"RTN","SAMICTT3",339,0)
LOWC(X) ;  CONVERT X TO LOWERCASE
"RTN","SAMICTT3",340,0)
 Q $TR(X,"ABCDEFGHIJKLMNOPQRSTUVWXYZ","abcdefghijklmnopqrstuvwxyz")
"RTN","SAMICTT3",341,0)
 ;
"RTN","SAMICTT3",342,0)
OUT(ln) ;
"RTN","SAMICTT3",343,0)
 i outmode="hold" s line=line_ln q  ;
"RTN","SAMICTT3",344,0)
 s cnt=cnt+1
"RTN","SAMICTT3",345,0)
 n lnn
"RTN","SAMICTT3",346,0)
 ;s debug=1
"RTN","SAMICTT3",347,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT3",348,0)
 i outmode="go" d  ;
"RTN","SAMICTT3",349,0)
 . s @rtn@(lnn)=line
"RTN","SAMICTT3",350,0)
 . s line=""
"RTN","SAMICTT3",351,0)
 . s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT3",352,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT3",353,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT3",354,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT3",355,0)
 . n zs s zs=$STACK
"RTN","SAMICTT3",356,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT3",357,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT3",358,0)
 q
"RTN","SAMICTT3",359,0)
 ;
"RTN","SAMICTT3",360,0)
OUTOLD(ln) ;
"RTN","SAMICTT3",361,0)
 s cnt=cnt+1
"RTN","SAMICTT3",362,0)
 n lnn
"RTN","SAMICTT3",363,0)
 ;s debug=1
"RTN","SAMICTT3",364,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT3",365,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT3",366,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT3",367,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT3",368,0)
 . n zs s zs=$STACK
"RTN","SAMICTT3",369,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT3",370,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT3",371,0)
 q
"RTN","SAMICTT3",372,0)
 ;
"RTN","SAMICTT3",373,0)
HOUT(ln) ;
"RTN","SAMICTT3",374,0)
 D OUT(ln)
"RTN","SAMICTT3",375,0)
 ;d OUT("<p><span class='sectionhead'>"_ln_"</span>")
"RTN","SAMICTT3",376,0)
 q
"RTN","SAMICTT3",377,0)
 ;
"RTN","SAMICTT3",378,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMICTT3",379,0)
 ; vals is passed by name
"RTN","SAMICTT3",380,0)
 n zr
"RTN","SAMICTT3",381,0)
 s zr=$g(@vals@(var))
"RTN","SAMICTT3",382,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMICTT3",383,0)
 q zr
"RTN","SAMICTT3",384,0)
 ;
"RTN","SAMICTT3",385,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMICTT3",386,0)
 ; vals and dict are passed by name
"RTN","SAMICTT3",387,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMICTT3",388,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMICTT3",389,0)
 n zr,zv,zdx
"RTN","SAMICTT3",390,0)
 s zdx=$g(valdx)
"RTN","SAMICTT3",391,0)
 i zdx="" s zdx=var
"RTN","SAMICTT3",392,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMICTT3",393,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMICTT3",394,0)
 i zv="" s zr="" q zr
"RTN","SAMICTT3",395,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMICTT3",396,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMICTT3",397,0)
 q zr
"RTN","SAMICTT3",398,0)
 ;
"RTN","SAMICTT4")
0^7^B35570521
"RTN","SAMICTT4",1,0)
SAMICTT4 ;ven/gpl - ielcap: forms ; 3/19/19 1:27pm
"RTN","SAMICTT4",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMICTT4",3,0)
 ;
"RTN","SAMICTT4",4,0)
 ;
"RTN","SAMICTT4",5,0)
 quit  ; no entry from top
"RTN","SAMICTT4",6,0)
 ;
"RTN","SAMICTT4",7,0)
BREAST(rtn,vals,dict) ;
"RTN","SAMICTT4",8,0)
 ; repgen6
"RTN","SAMICTT4",9,0)
 n sp1 s sp1="  "
"RTN","SAMICTT4",10,0)
 n outmode s outmode="hold"
"RTN","SAMICTT4",11,0)
 n line s line=""
"RTN","SAMICTT4",12,0)
 n destr s destr="is seen"
"RTN","SAMICTT4",13,0)
 n sba set sba=0
"RTN","SAMICTT4",14,0)
 ;   # Breast Abnormalities
"RTN","SAMICTT4",15,0)
 n bd,brt,blt
"RTN","SAMICTT4",16,0)
 s (bd,brt,blt)=0
"RTN","SAMICTT4",17,0)
 if $$XVAL("ceobard",vals)'="-" s brt=$$XVAL("ceobard",vals)
"RTN","SAMICTT4",18,0)
 if $$XVAL("ceobald",vals)'="-" s brt=$$XVAL("ceobald",vals)
"RTN","SAMICTT4",19,0)
 if (blt'=0)!(brt'=0) d  ;
"RTN","SAMICTT4",20,0)
 . d OUT("Breast:")
"RTN","SAMICTT4",21,0)
 . s bd=1
"RTN","SAMICTT4",22,0)
 s outmode="hold"
"RTN","SAMICTT4",23,0)
 if $$XVAL("ceara",vals)="y" d  ; our substitute for ceoba, which is null
"RTN","SAMICTT4",24,0)
 . if bd=0 d OUT("Breast:")
"RTN","SAMICTT4",25,0)
 . if $$XVAL("ceara",vals)="y" d  ;
"RTN","SAMICTT4",26,0)
 . . set sba=1
"RTN","SAMICTT4",27,0)
 . . n br
"RTN","SAMICTT4",28,0)
 . . set br=$$CCMSTR^SAMICTR3("ceobarc^ceobary^ceobarm",vals)
"RTN","SAMICTT4",29,0)
 . . if br="" d OUT("Noted in right breast: ")
"RTN","SAMICTT4",30,0)
 . . if br'="" d OUT(br_" right breast. ")
"RTN","SAMICTT4",31,0)
 . . d OUT($$XVAL("ceobaros",vals))
"RTN","SAMICTT4",32,0)
 if $$XVAL("ceafa",vals)="y" d  ; our substitute for ceoba, which is null
"RTN","SAMICTT4",33,0)
 . if bd=0 d OUT("Breast:")
"RTN","SAMICTT4",34,0)
 . if $$XVAL("ceafa",vals)="y" d  ;
"RTN","SAMICTT4",35,0)
 . . set sba=1
"RTN","SAMICTT4",36,0)
 . . n br
"RTN","SAMICTT4",37,0)
 . . set br=$$CCMSTR^SAMICTR3("ceobafc^ceobafy^ceobafm",vals)
"RTN","SAMICTT4",38,0)
 . . if br="" d OUT("Noted in left breast: ")
"RTN","SAMICTT4",39,0)
 . . if br'="" d OUT(br_" left breast. ")
"RTN","SAMICTT4",40,0)
 . . d OUT($$XVAL("ceobafos",vals))
"RTN","SAMICTT4",41,0)
 if bd=1 d  ;
"RTN","SAMICTT4",42,0)
 . if blt=brt d OUT("Density: "_$$XSUB("ceobad",vals,dict,"ceobald"))
"RTN","SAMICTT4",43,0)
 . else  d OUT("Density: Left "_$$XSUB("ceobad",vals,dict,"ceobald")_", Right "_$$XSUB("ceobad",vals,dict,"ceobard")_". ")
"RTN","SAMICTT4",44,0)
 if $$XVAL("ceobrc",vals)'="" d OUT($$XVAL("ceobrc",vals))
"RTN","SAMICTT4",45,0)
 else  if sba=1 d OUT("")
"RTN","SAMICTT4",46,0)
 s outmode="go"
"RTN","SAMICTT4",47,0)
 d OUT("")
"RTN","SAMICTT4",48,0)
 ;
"RTN","SAMICTT4",49,0)
 ;
"RTN","SAMICTT4",50,0)
 s outmode="hold"
"RTN","SAMICTT4",51,0)
 d OUT("Abdomen: ")
"RTN","SAMICTT4",52,0)
 n yesaa s yesaa=0
"RTN","SAMICTT4",53,0)
 ;  # Special Handling for the gallbladder
"RTN","SAMICTT4",54,0)
 ;
"RTN","SAMICTT4",55,0)
 if $$XVAL("ceaga",vals)="y" d  ;
"RTN","SAMICTT4",56,0)
 . d OUT(sp1_"Limited view of the upper abdomen reveals the following: ")
"RTN","SAMICTT4",57,0)
 . set yesaa=1
"RTN","SAMICTT4",58,0)
 . if $$XVAL("ceagh",vals)="h" d  ;
"RTN","SAMICTT4",59,0)
 . . d OUT(sp1_"status post cholecystectomy. ")
"RTN","SAMICTT4",60,0)
 . if $$XVAL("ceags",vals)="s" d  ;
"RTN","SAMICTT4",61,0)
 . . d OUT(sp1_"Gallstones are noted. ")
"RTN","SAMICTT4",62,0)
 . if $$XVAL("ceagl",vals)="l" d  ;
"RTN","SAMICTT4",63,0)
 . . d OUT(sp1_"Sludge is seen in the gall bladder. ")
"RTN","SAMICTT4",64,0)
 . if $$XVAL("ceago",vals)="y" d  ;
"RTN","SAMICTT4",65,0)
 . . d OUT(sp1_"An abnormality was noted in the gall bladder: ")
"RTN","SAMICTT4",66,0)
 if $$XVAL("ceagos",vals)'="" d  ;
"RTN","SAMICTT4",67,0)
 . d OUT($$XVAL("ceagos",vals))
"RTN","SAMICTT4",68,0)
 ;
"RTN","SAMICTT4",69,0)
 n aalist
"RTN","SAMICTT4",70,0)
 s aalist(1,"spleen",0)=$$XVAL("ceasa",vals)
"RTN","SAMICTT4",71,0)
 s aalist(1,"spleen",1)="ceasc^ceasy^ceasm"
"RTN","SAMICTT4",72,0)
 s aalist(1,"spleen",2)=$$XVAL("ceasos",vals)
"RTN","SAMICTT4",73,0)
 s aalist(2,"liver",0)=$$XVAL("ceala",vals)
"RTN","SAMICTT4",74,0)
 s aalist(2,"liver",1)="cealc^cealy^cealm"
"RTN","SAMICTT4",75,0)
 s aalist(2,"liver",2)=$$XVAL("cealos",vals)
"RTN","SAMICTT4",76,0)
 s aalist(3,"pancreas",0)=$$XVAL("ceapa",vals)
"RTN","SAMICTT4",77,0)
 s aalist(3,"pancreas",1)="ceapc^ceapy^ceapm"
"RTN","SAMICTT4",78,0)
 s aalist(3,"pancreas",2)=$$XVAL("ceapos",vals)
"RTN","SAMICTT4",79,0)
 s aalist(4,"adrenals",0)=$$XVAL("ceaaa",vals)
"RTN","SAMICTT4",80,0)
 s aalist(4,"adrenals",1)="ceaac^ceaay^ceaam"
"RTN","SAMICTT4",81,0)
 s aalist(4,"adrenals",2)=$$XVAL("ceaaos",vals)
"RTN","SAMICTT4",82,0)
 s aalist(5,"kidneys",0)=$$XVAL("ceaka",vals)
"RTN","SAMICTT4",83,0)
 s aalist(5,"kidneys",1)="ceakc^ceaky^ceakm"
"RTN","SAMICTT4",84,0)
 s aalist(5,"kidneys",2)=$$XVAL("ceakos",vals)
"RTN","SAMICTT4",85,0)
 ;
"RTN","SAMICTT4",86,0)
 n zan,zaa s zaa=""
"RTN","SAMICTT4",87,0)
 f zan=1:1:5  d  ;
"RTN","SAMICTT4",88,0)
 . s zaa=$o(aalist(zan,""))
"RTN","SAMICTT4",89,0)
 . if aalist(zan,zaa,0)="y" d  ;
"RTN","SAMICTT4",90,0)
 . . n zout
"RTN","SAMICTT4",91,0)
 . . s zout=$$CCMSTR^SAMICTR3(aalist(zan,zaa,1),vals)
"RTN","SAMICTT4",92,0)
 . . set yesaa=1
"RTN","SAMICTT4",93,0)
 . . if zout="" d  ;
"RTN","SAMICTT4",94,0)
 . . . ;d OUT(aalist(zan,zaa,2))
"RTN","SAMICTT4",95,0)
 . . . if aalist(zan,zaa,2)'="" d OUT(aalist(zan,zaa,2))
"RTN","SAMICTT4",96,0)
 . . if zout'="" d  ;
"RTN","SAMICTT4",97,0)
 . . . d OUT(sp1_"A "_$$LOWC^SAMICTR3(zout)_" "_zaa_". "_aalist(zan,zaa,2))
"RTN","SAMICTT4",98,0)
 ;
"RTN","SAMICTT4",99,0)
 ;# Other Abdominal Abnormalities
"RTN","SAMICTT4",100,0)
 ;
"RTN","SAMICTT4",101,0)
 if $$XVAL("ceaoab",vals)'="" d  ;
"RTN","SAMICTT4",102,0)
 . d OUT($$XVAL("ceaoab",vals)_".")
"RTN","SAMICTT4",103,0)
 if yesaa=0  d  ;
"RTN","SAMICTT4",104,0)
 . d OUT(sp1_"Limited view of the upper abdomen reveals no abnormalities.")
"RTN","SAMICTT4",105,0)
 ;
"RTN","SAMICTT4",106,0)
 ;
"RTN","SAMICTT4",107,0)
 ;# Other Chest Abnormalities
"RTN","SAMICTT4",108,0)
 ;
"RTN","SAMICTT4",109,0)
 if $$XVAL("ceotab",vals)'="" d
"RTN","SAMICTT4",110,0)
 . d OUT("Other chest abnormalities:")
"RTN","SAMICTT4",111,0)
 . d OUT($$XVAL("ceotab",vals)_". ")
"RTN","SAMICTT4",112,0)
 ;
"RTN","SAMICTT4",113,0)
 s outmode="go"
"RTN","SAMICTT4",114,0)
 d OUT("")
"RTN","SAMICTT4",115,0)
 ;
"RTN","SAMICTT4",116,0)
 ;# Bone Abnormalities
"RTN","SAMICTT4",117,0)
 ;
"RTN","SAMICTT4",118,0)
 s outmode="hold"
"RTN","SAMICTT4",119,0)
 if $$XVAL("ceaoabb",vals)'="" d  ;
"RTN","SAMICTT4",120,0)
 . d OUT("Bone:")
"RTN","SAMICTT4",121,0)
 . d OUT($$XVAL("ceaoabb",vals)_para)
"RTN","SAMICTT4",122,0)
 d  ;
"RTN","SAMICTT4",123,0)
 . q  ; LungRADS moved to SAMICTRA
"RTN","SAMICTT4",124,0)
 . n lradModifiers
"RTN","SAMICTT4",125,0)
 . s lradModifiers=$$XVAL("celradc",vals)_$$XVAL("celrads",vals)
"RTN","SAMICTT4",126,0)
 . ;
"RTN","SAMICTT4",127,0)
 . i ($$XVAL("celrad",vals)'="-")&($$XVAL("celrad",vals)'="") d  ;
"RTN","SAMICTT4",128,0)
 . . d OUT("The LungRADS category for this scan is: "_$$XVAL("celrad",vals)_" "_lradModifiers)
"RTN","SAMICTT4",129,0)
 . . d OUT("")
"RTN","SAMICTT4",130,0)
 s outmode="go"
"RTN","SAMICTT4",131,0)
 d OUT("")
"RTN","SAMICTT4",132,0)
 q
"RTN","SAMICTT4",133,0)
 ;
"RTN","SAMICTT4",134,0)
 ;
"RTN","SAMICTT4",135,0)
OUT(ln) ;
"RTN","SAMICTT4",136,0)
 i outmode="hold" s line=line_ln q  ;
"RTN","SAMICTT4",137,0)
 s cnt=cnt+1
"RTN","SAMICTT4",138,0)
 n lnn
"RTN","SAMICTT4",139,0)
 i $g(debug)'=1 s debug=0
"RTN","SAMICTT4",140,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT4",141,0)
 i outmode="go" d  ;
"RTN","SAMICTT4",142,0)
 . s @rtn@(lnn)=line
"RTN","SAMICTT4",143,0)
 . s line=""
"RTN","SAMICTT4",144,0)
 . s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT4",145,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT4",146,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT4",147,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT4",148,0)
 . n zs s zs=$STACK
"RTN","SAMICTT4",149,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT4",150,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT4",151,0)
 q
"RTN","SAMICTT4",152,0)
 ;
"RTN","SAMICTT4",153,0)
OUTOLD(ln) ;
"RTN","SAMICTT4",154,0)
 s cnt=cnt+1
"RTN","SAMICTT4",155,0)
 n lnn
"RTN","SAMICTT4",156,0)
 ;s debug=1
"RTN","SAMICTT4",157,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT4",158,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT4",159,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT4",160,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT4",161,0)
 . n zs s zs=$STACK
"RTN","SAMICTT4",162,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT4",163,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT4",164,0)
 q
"RTN","SAMICTT4",165,0)
 ;
"RTN","SAMICTT4",166,0)
HOUT(ln) ;
"RTN","SAMICTT4",167,0)
 d OUT(ln)
"RTN","SAMICTT4",168,0)
 ;d OUT("<p><span class='sectionhead'>"_ln_"</span>")
"RTN","SAMICTT4",169,0)
 q
"RTN","SAMICTT4",170,0)
 ;
"RTN","SAMICTT4",171,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMICTT4",172,0)
 ; vals is passed by name
"RTN","SAMICTT4",173,0)
 n zr
"RTN","SAMICTT4",174,0)
 s zr=$g(@vals@(var))
"RTN","SAMICTT4",175,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMICTT4",176,0)
 q zr
"RTN","SAMICTT4",177,0)
 ;
"RTN","SAMICTT4",178,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMICTT4",179,0)
 ; vals and dict are passed by name
"RTN","SAMICTT4",180,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMICTT4",181,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMICTT4",182,0)
 n zr,zv,zdx
"RTN","SAMICTT4",183,0)
 s zdx=$g(valdx)
"RTN","SAMICTT4",184,0)
 i zdx="" s zdx=var
"RTN","SAMICTT4",185,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMICTT4",186,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMICTT4",187,0)
 i zv="" s zr="" q zr
"RTN","SAMICTT4",188,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMICTT4",189,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMICTT4",190,0)
 q zr
"RTN","SAMICTT4",191,0)
 ;
"RTN","SAMICTT4",192,0)
 ;
"RTN","SAMICTT9")
0^8^B10292811
"RTN","SAMICTT9",1,0)
SAMICTR9 ;ven/gpl - ielcap: forms ; 12/28/18 10:26am
"RTN","SAMICTT9",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMICTT9",3,0)
 ;
"RTN","SAMICTT9",4,0)
 ;
"RTN","SAMICTT9",5,0)
 quit  ; no entry from top
"RTN","SAMICTT9",6,0)
 ;
"RTN","SAMICTT9",7,0)
IMPRSN(rtn,vals,dict) ;
"RTN","SAMICTT9",8,0)
 ; repgen13
"RTN","SAMICTT9",9,0)
 ;
"RTN","SAMICTT9",10,0)
 ;
"RTN","SAMICTT9",11,0)
 ; # Impression
"RTN","SAMICTT9",12,0)
 ;d OUT("</TD></TR></TABLE><TR><TD>")
"RTN","SAMICTT9",13,0)
 ;d OUT("<HR SIZE=""2"" WIDTH=""100%"" ALIGN=""center"" NOSHADE>")
"RTN","SAMICTT9",14,0)
 ;d OUT("</TD></TR>")
"RTN","SAMICTT9",15,0)
 ;d OUT("<!-- impression -->")
"RTN","SAMICTT9",16,0)
 ;d OUT("<TR><TD>")
"RTN","SAMICTT9",17,0)
 ;d OUT("<FONT SIZE=""+2"">")
"RTN","SAMICTT9",18,0)
 ;d OUT("<B>IMPRESSION:</B>")
"RTN","SAMICTT9",19,0)
 ;d OUT("</FONT>")
"RTN","SAMICTT9",20,0)
 ;d OUT("</TD></TR><TR><TD><TABLE>")
"RTN","SAMICTT9",21,0)
 ;d OUT("<TR><TD WIDTH=20></TD><TD>")
"RTN","SAMICTT9",22,0)
 d OUT("")
"RTN","SAMICTT9",23,0)
 d OUT("IMPRESSION:")
"RTN","SAMICTT9",24,0)
 d OUT("")
"RTN","SAMICTT9",25,0)
 ;
"RTN","SAMICTT9",26,0)
 d OUT($$XSUB("ceimn",vals,dict)_para)
"RTN","SAMICTT9",27,0)
 ;
"RTN","SAMICTT9",28,0)
 ;# Report CAC Score and Extent of Emphysema
"RTN","SAMICTT9",29,0)
 s cacval=0
"RTN","SAMICTT9",30,0)
 d  ;if $$XVAL("ceccv",vals)'="e" d  ;
"RTN","SAMICTT9",31,0)
 . set vcac=$$XVAL("cecccac",vals)
"RTN","SAMICTT9",32,0)
 . if vcac'="" d  ;
"RTN","SAMICTT9",33,0)
 . . s cacrec=""
"RTN","SAMICTT9",34,0)
 . . s cac="The Visual Coronary Artery Calcium (CAC) Score is "_vcac_". "
"RTN","SAMICTT9",35,0)
 . . s cacval=vcac
"RTN","SAMICTT9",36,0)
 . . i cacval>3 s cacrec=$g(@dict@("CAC_recommendation"))_para
"RTN","SAMICTT9",37,0)
 ;
"RTN","SAMICTT9",38,0)
 i cacval>0 d  ;
"RTN","SAMICTT9",39,0)
 . d OUT("")
"RTN","SAMICTT9",40,0)
 . d OUT(cac_" "_cacrec_" ") d OUT("")
"RTN","SAMICTT9",41,0)
 . d  ;if $$XVAL("ceemv",vals)="e" d  ;
"RTN","SAMICTT9",42,0)
 . . if $$XVAL("ceem",vals)'="no" d  ;
"RTN","SAMICTT9",43,0)
 . . . if $$XVAL("ceem",vals)="nv" q  ;
"RTN","SAMICTT9",44,0)
 . . . d OUT("Emphysema:") d OUT("")
"RTN","SAMICTT9",45,0)
 . . . d OUT($$XSUB("ceem",vals,dict)_".") d OUT("")
"RTN","SAMICTT9",46,0)
 ;
"RTN","SAMICTT9",47,0)
 i $$XVAL("ceclini",vals)="y" d  ;
"RTN","SAMICTT9",48,0)
 . d OUT($$XVAL("ceclin",vals)_".") d OUT("")
"RTN","SAMICTT9",49,0)
 ;
"RTN","SAMICTT9",50,0)
 i $$XVAL("ceoppai",vals)="y" d  ;
"RTN","SAMICTT9",51,0)
 . d OUT($$XVAL("ceoppa",vals)_".") d OUT("")
"RTN","SAMICTT9",52,0)
 ;
"RTN","SAMICTT9",53,0)
 i $$XVAL("ceoppabi",vals)="y" d  ;
"RTN","SAMICTT9",54,0)
 . d OUT($$XVAL("ceoppab",vals)_".") d OUT("")
"RTN","SAMICTT9",55,0)
 ;
"RTN","SAMICTT9",56,0)
 i $$XVAL("cecommcai",vals)="y" d  ;
"RTN","SAMICTT9",57,0)
 . d OUT($$XVAL("cecommca",vals)_".") d OUT("")
"RTN","SAMICTT9",58,0)
 ;
"RTN","SAMICTT9",59,0)
 i $$XVAL("ceotabnmi",vals)="y" d  ;
"RTN","SAMICTT9",60,0)
 . d OUT($$XVAL("ceotabnm",vals)_".") d OUT("")
"RTN","SAMICTT9",61,0)
 ;
"RTN","SAMICTT9",62,0)
 i $$XVAL("ceobrci",vals)="y" d  ;
"RTN","SAMICTT9",63,0)
 . d OUT($$XVAL("ceobrc",vals)_".") d OUT("")
"RTN","SAMICTT9",64,0)
 ;
"RTN","SAMICTT9",65,0)
 i $$XVAL("ceaoabbi",vals)="y" d  ;
"RTN","SAMICTT9",66,0)
 . d OUT($$XVAL("ceaoabb",vals)_".") d OUT("")
"RTN","SAMICTT9",67,0)
 ;
"RTN","SAMICTT9",68,0)
 i $$XVAL("ceaoabi",vals)="y" d  ;
"RTN","SAMICTT9",69,0)
 . d OUT($$XVAL("ceaoab",vals)_".") d OUT("")
"RTN","SAMICTT9",70,0)
 ;
"RTN","SAMICTT9",71,0)
 ;# Impression Remarks
"RTN","SAMICTT9",72,0)
 i $$XVAL("ceimre",vals)'="" d  ;
"RTN","SAMICTT9",73,0)
 . d OUT($$XVAL("ceimre",vals)_".") d OUT("")
"RTN","SAMICTT9",74,0)
 q
"RTN","SAMICTT9",75,0)
 ;
"RTN","SAMICTT9",76,0)
 ;
"RTN","SAMICTT9",77,0)
OUT(ln) ;
"RTN","SAMICTT9",78,0)
 s cnt=cnt+1
"RTN","SAMICTT9",79,0)
 n lnn
"RTN","SAMICTT9",80,0)
 ;s debug=1
"RTN","SAMICTT9",81,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTT9",82,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTT9",83,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTT9",84,0)
 . i ln["<" q  ; no markup
"RTN","SAMICTT9",85,0)
 . n zs s zs=$STACK
"RTN","SAMICTT9",86,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTT9",87,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTT9",88,0)
 q
"RTN","SAMICTT9",89,0)
 ;
"RTN","SAMICTT9",90,0)
HOUT(ln) ;
"RTN","SAMICTT9",91,0)
 d OUT("<p><span class='sectionhead'>"_ln_"</span>")
"RTN","SAMICTT9",92,0)
 q
"RTN","SAMICTT9",93,0)
 ;
"RTN","SAMICTT9",94,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMICTT9",95,0)
 ; vals is passed by name
"RTN","SAMICTT9",96,0)
 n zr
"RTN","SAMICTT9",97,0)
 s zr=$g(@vals@(var))
"RTN","SAMICTT9",98,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMICTT9",99,0)
 q zr
"RTN","SAMICTT9",100,0)
 ;
"RTN","SAMICTT9",101,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMICTT9",102,0)
 ; vals and dict are passed by name
"RTN","SAMICTT9",103,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMICTT9",104,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMICTT9",105,0)
 n zr,zv,zdx
"RTN","SAMICTT9",106,0)
 s zdx=$g(valdx)
"RTN","SAMICTT9",107,0)
 i zdx="" s zdx=var
"RTN","SAMICTT9",108,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMICTT9",109,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMICTT9",110,0)
 i zv="" s zr="" q zr
"RTN","SAMICTT9",111,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMICTT9",112,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMICTT9",113,0)
 q zr
"RTN","SAMICTT9",114,0)
 ;
"RTN","SAMICTTA")
0^9^B24206954
"RTN","SAMICTTA",1,0)
SAMICTTA ;ven/gpl - ielcap: forms ; 12/28/18 9:43am
"RTN","SAMICTTA",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMICTTA",3,0)
 ;
"RTN","SAMICTTA",4,0)
 ;
"RTN","SAMICTTA",5,0)
 quit  ; no entry from top
"RTN","SAMICTTA",6,0)
 ;
"RTN","SAMICTTA",7,0)
RCMND(rtn,vals,dict) ;
"RTN","SAMICTTA",8,0)
 ; repgen14
"RTN","SAMICTTA",9,0)
 ;
"RTN","SAMICTTA",10,0)
 ;
"RTN","SAMICTTA",11,0)
 ;# Recommendation
"RTN","SAMICTTA",12,0)
 ;d OUT("</TD></TR>")
"RTN","SAMICTTA",13,0)
 ;d OUT("</TABLE>")
"RTN","SAMICTTA",14,0)
 ;d OUT("<TR><TD></TD></TR>")
"RTN","SAMICTTA",15,0)
 ;d OUT("<!-- Recommendation -->")
"RTN","SAMICTTA",16,0)
 ;
"RTN","SAMICTTA",17,0)
 i $$XVAL("cefu",vals)'="nf" d  ; 2445-2450 gpl1
"RTN","SAMICTTA",18,0)
 . ;d OUT("<TR><TD><FONT SIZE=""+2""><B>")
"RTN","SAMICTTA",19,0)
 . ;d OUT("<FONT SIZE=""+2""><B>")
"RTN","SAMICTTA",20,0)
 . d OUT("")
"RTN","SAMICTTA",21,0)
 . d OUT("Recommendations:")
"RTN","SAMICTTA",22,0)
 . d OUT("")
"RTN","SAMICTTA",23,0)
 . ;d OUT("</B></FONT>")
"RTN","SAMICTTA",24,0)
 . ;d OUT("</TD></TR><TR><TD><TABLE><TR><TD WIDTH=20></TD><TD>")
"RTN","SAMICTTA",25,0)
 ;
"RTN","SAMICTTA",26,0)
 n fuw
"RTN","SAMICTTA",27,0)
 s fuw=$$XSUB("cefuw",vals,dict)
"RTN","SAMICTTA",28,0)
 ;d OUT("fuw= "_fuw)
"RTN","SAMICTTA",29,0)
 ;d OUT("vals= "_vals)
"RTN","SAMICTTA",30,0)
 ;d OUT(" dict= "_dict)
"RTN","SAMICTTA",31,0)
 ;d OUT($o(@vals@("cefuw","")))
"RTN","SAMICTTA",32,0)
 ;zwr @vals@(*)
"RTN","SAMICTTA",33,0)
 ;zwr @dict@(*)
"RTN","SAMICTTA",34,0)
 ;i fuw="" d  ;
"RTN","SAMICTTA",35,0)
 ;. d OUT(para_"<B>"_$$XSUB("cefu",vals,dict)_" on "_$$XVAL("cefud",vals)_".</B>"_para)
"RTN","SAMICTTA",36,0)
 ;e  d  ;
"RTN","SAMICTTA",37,0)
 ;. d OUT(para_"<B>"_$$XSUB("cefu",vals,dict)_" "_fuw_" on "_$$XVAL("cefud",vals)_".</B>"_para)
"RTN","SAMICTTA",38,0)
 i fuw="" d  ;
"RTN","SAMICTTA",39,0)
 . ;d OUT(para_"<B>A followup CT scan is recommended on "_$$XVAL("cefud",vals)_".</B>"_para)
"RTN","SAMICTTA",40,0)
 . d OUT("A followup CT scan is recommended on "_$$XVAL("cefud",vals)_".") d OUT("")
"RTN","SAMICTTA",41,0)
 e  d  ;
"RTN","SAMICTTA",42,0)
 . ;d OUT(para_"<B>A followup CT scan is recommended "_fuw_" on "_$$XVAL("cefud",vals)_".</B>"_para)
"RTN","SAMICTTA",43,0)
 . d OUT("A followup CT scan is recommended "_fuw_" on "_$$XVAL("cefud",vals)_".") d OUT("")
"RTN","SAMICTTA",44,0)
 ;
"RTN","SAMICTTA",45,0)
 ; #Other followup
"RTN","SAMICTTA",46,0)
 n zfu,ofu,tofu,comma
"RTN","SAMICTTA",47,0)
 s comma=0,tofu=""
"RTN","SAMICTTA",48,0)
 s ofu=""
"RTN","SAMICTTA",49,0)
 f zfu="cefuaf","cefucc","cefupe","cefufn","cefubr","cefupc","cefutb" d  ;
"RTN","SAMICTTA",50,0)
 . i $$XVAL(zfu,vals)="y" s ofu=ofu_zfu
"RTN","SAMICTTA",51,0)
 i $$XVAL("cefuo",vals)'="" s ofu=ofu_"cefuo"
"RTN","SAMICTTA",52,0)
 i ofu'="" d  ;
"RTN","SAMICTTA",53,0)
 . s tofu="Other followup: "
"RTN","SAMICTTA",54,0)
 . i ofu["cefuaf" s tofu=tofu_"Antibiotics" s comma=1
"RTN","SAMICTTA",55,0)
 . i ofu["cefucc" s tofu=tofu_$s(comma:", ",1:"")_"Diagnostic CT" s comma=1
"RTN","SAMICTTA",56,0)
 . i ofu["cefupe" s tofu=tofu_$s(comma:", ",1:"")_"PET" s comma=1
"RTN","SAMICTTA",57,0)
 . i ofu["cefufn" s tofu=tofu_$s(comma:", ",1:"")_"Percutaneous biopsy" s comma=1
"RTN","SAMICTTA",58,0)
 . i ofu["cefubr" s tofu=tofu_$s(comma:", ",1:"")_"Bronchoscopy" s comma=1
"RTN","SAMICTTA",59,0)
 . i ofu["cefupc" s tofu=tofu_$s(comma:", ",1:"")_"Pulmonary consultation" s comma=1
"RTN","SAMICTTA",60,0)
 . i ofu["cefutb" s tofu=tofu_$s(comma:", ",1:"")_"Refer to tumor board" s comma=1
"RTN","SAMICTTA",61,0)
 . i ofu["cefuo" s tofu=tofu_$s(comma:", ",1:"")_$$XVAL("cefuoo",vals) s comma=1
"RTN","SAMICTTA",62,0)
 i ofu'="" d OUT(para_tofu_para) d OUT("")
"RTN","SAMICTTA",63,0)
 ;d OUT("<TR><TD></TD></TR>")
"RTN","SAMICTTA",64,0)
 ; # LungRADS
"RTN","SAMICTTA",65,0)
 ;
"RTN","SAMICTTA",66,0)
 ;d OUT("<TR><TD>")
"RTN","SAMICTTA",67,0)
 ;n lrstyle
"RTN","SAMICTTA",68,0)
 ;i $$XVAL("celrc",vals)'="" s lrstyle=1 ; dom's style
"RTN","SAMICTTA",69,0)
 ;e  s lrstyle=0 ; artit's style
"RTN","SAMICTTA",70,0)
 ;s lrstyle=0
"RTN","SAMICTTA",71,0)
 ;
"RTN","SAMICTTA",72,0)
 d  ;
"RTN","SAMICTTA",73,0)
 . q  ; LUNGRADS moved to SAMICTR4
"RTN","SAMICTTA",74,0)
 . n lradModifiers
"RTN","SAMICTTA",75,0)
 . s lradModifiers=$$XVAL("celradc",vals)_$$XVAL("celrads",vals)
"RTN","SAMICTTA",76,0)
 . ;
"RTN","SAMICTTA",77,0)
 . i ($$XVAL("celrad",vals)'="-")&($$XVAL("celrad",vals)'="") d  ;
"RTN","SAMICTTA",78,0)
 . . d OUT("The LungRADS category for this scan is: "_$$XVAL("celrad",vals)_" "_lradModifiers)
"RTN","SAMICTTA",79,0)
 . . d OUT(para)
"RTN","SAMICTTA",80,0)
 ;
"RTN","SAMICTTA",81,0)
 ;d OUT("</TD></TR>")
"RTN","SAMICTTA",82,0)
 ;
"RTN","SAMICTTA",83,0)
 ;d OUT("<TR><TD><TABLE><TR><TD WIDTH=20></TD><TD>")
"RTN","SAMICTTA",84,0)
 ;
"RTN","SAMICTTA",85,0)
 ;# Check if Study is Completed
"RTN","SAMICTTA",86,0)
 ;# Find Current Study ID
"RTN","SAMICTTA",87,0)
 ;# locate most recent followup
"RTN","SAMICTTA",88,0)
 ;# get status (sies)
"RTN","SAMICTTA",89,0)
 ;# if sc=Study Complete and cefu=rs
"RTN","SAMICTTA",90,0)
 ;
"RTN","SAMICTTA",91,0)
 n patstatus
"RTN","SAMICTTA",92,0)
 s patstatus=$$XVAL("cedos",vals)
"RTN","SAMICTTA",93,0)
 ;i patstatus="sc" d OUT(para_$g(@dict@("study_complete")))
"RTN","SAMICTTA",94,0)
 i patstatus="sc" d OUT($g(@dict@("study_complete"))) d OUT("")
"RTN","SAMICTTA",95,0)
 ;
"RTN","SAMICTTA",96,0)
 ;# Radiologist
"RTN","SAMICTTA",97,0)
 i $$XVAL("cerad",vals)'="" d  ;
"RTN","SAMICTTA",98,0)
 . d OUT("Interpreted by: "_$$XVAL("cerad",vals)) d OUT("")
"RTN","SAMICTTA",99,0)
 ;
"RTN","SAMICTTA",100,0)
 ;d OUT("<TR><TD></TD></TR>")
"RTN","SAMICTTA",101,0)
 ; # LungRADS
"RTN","SAMICTTA",102,0)
 ;
"RTN","SAMICTTA",103,0)
 ;d OUT("<TR><TD>")
"RTN","SAMICTTA",104,0)
 n lrstyle
"RTN","SAMICTTA",105,0)
 i $$XVAL("celrc",vals)'="" s lrstyle=1 ; dom's style
"RTN","SAMICTTA",106,0)
 e  s lrstyle=0 ; artit's style
"RTN","SAMICTTA",107,0)
 s lrstyle=0
"RTN","SAMICTTA",108,0)
 ;
"RTN","SAMICTTA",109,0)
 d  ;
"RTN","SAMICTTA",110,0)
 . ;q  ; LUNGRADS moved to SAMICTR4
"RTN","SAMICTTA",111,0)
 . n lradModifiers
"RTN","SAMICTTA",112,0)
 . s lradModifiers=$$XVAL("celradc",vals)_$$XVAL("celrads",vals)
"RTN","SAMICTTA",113,0)
 . ;
"RTN","SAMICTTA",114,0)
 . i ($$XVAL("celrad",vals)'="-")&($$XVAL("celrad",vals)'="") d  ;
"RTN","SAMICTTA",115,0)
 . . d OUT("The LungRADS category for this scan is: "_$$XVAL("celrad",vals)_" "_lradModifiers)
"RTN","SAMICTTA",116,0)
 . . d OUT("")
"RTN","SAMICTTA",117,0)
 ;
"RTN","SAMICTTA",118,0)
 ;d OUT("</TD></TR>")
"RTN","SAMICTTA",119,0)
 ;
"RTN","SAMICTTA",120,0)
 ;d OUT("<TR><TD><TABLE><TR><TD WIDTH=20></TD><TD>")
"RTN","SAMICTTA",121,0)
 q
"RTN","SAMICTTA",122,0)
 ;
"RTN","SAMICTTA",123,0)
 ;
"RTN","SAMICTTA",124,0)
OUT(ln) ;
"RTN","SAMICTTA",125,0)
 s cnt=cnt+1
"RTN","SAMICTTA",126,0)
 n lnn
"RTN","SAMICTTA",127,0)
 ;s debug=1
"RTN","SAMICTTA",128,0)
 s lnn=$o(@rtn@(" "),-1)+1
"RTN","SAMICTTA",129,0)
 s @rtn@(lnn)=ln
"RTN","SAMICTTA",130,0)
 i $g(debug)=1 d  ;
"RTN","SAMICTTA",131,0)
 . i ln["<T" q  ; no markup
"RTN","SAMICTTA",132,0)
 . i ln["</" q  ; no markup
"RTN","SAMICTTA",133,0)
 . n zs s zs=$STACK
"RTN","SAMICTTA",134,0)
 . n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMICTTA",135,0)
 . s @rtn@(lnn)=zp_":"_ln
"RTN","SAMICTTA",136,0)
 q
"RTN","SAMICTTA",137,0)
 ;
"RTN","SAMICTTA",138,0)
HOUT(ln) ;
"RTN","SAMICTTA",139,0)
 d OUT("<p><span class='sectionhead'>"_ln_"</span>")
"RTN","SAMICTTA",140,0)
 q
"RTN","SAMICTTA",141,0)
 ;
"RTN","SAMICTTA",142,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMICTTA",143,0)
 ; vals is passed by name
"RTN","SAMICTTA",144,0)
 n zr
"RTN","SAMICTTA",145,0)
 s zr=$g(@vals@(var))
"RTN","SAMICTTA",146,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMICTTA",147,0)
 q zr
"RTN","SAMICTTA",148,0)
 ;
"RTN","SAMICTTA",149,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMICTTA",150,0)
 ; vals and dict are passed by name
"RTN","SAMICTTA",151,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMICTTA",152,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMICTTA",153,0)
 n zr,zv,zdx
"RTN","SAMICTTA",154,0)
 s zdx=$g(valdx)
"RTN","SAMICTTA",155,0)
 i zdx="" s zdx=var
"RTN","SAMICTTA",156,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMICTTA",157,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMICTTA",158,0)
 i zv="" s zr="" q zr
"RTN","SAMICTTA",159,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMICTTA",160,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMICTTA",161,0)
 q zr
"RTN","SAMICTTA",162,0)
 ;
"RTN","SAMIHOM4")
0^10^B462206546
"RTN","SAMIHOM4",1,0)
SAMIHOM4 ;ven/gpl,arc - ielcap: forms;2018-11-30T17:45Z ;Jan 14, 2020@16:04
"RTN","SAMIHOM4",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMIHOM4",3,0)
 ;
"RTN","SAMIHOM4",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMIHOM4",5,0)
 ;
"RTN","SAMIHOM4",6,0)
 ; @section 0 primary development
"RTN","SAMIHOM4",7,0)
 ;
"RTN","SAMIHOM4",8,0)
 ; @routine-credits
"RTN","SAMIHOM4",9,0)
 ; @primary-dev: George P. Lilly (gpl)
"RTN","SAMIHOM4",10,0)
 ;  gpl@vistaexpertise.net
"RTN","SAMIHOM4",11,0)
 ; @additional-dev: Alexis Carlson (arc)
"RTN","SAMIHOM4",12,0)
 ;  alexis@vistaexpertise.net
"RTN","SAMIHOM4",13,0)
 ; @primary-dev-org: Vista Expertise Network (ven)
"RTN","SAMIHOM4",14,0)
 ;  http://vistaexpertise.net
"RTN","SAMIHOM4",15,0)
 ; @copyright: 2012/2018, ven, all rights reserved
"RTN","SAMIHOM4",16,0)
 ; @license: Apache 2.0
"RTN","SAMIHOM4",17,0)
 ;  https://www.apache.org/licenses/LICENSE-2.0.html
"RTN","SAMIHOM4",18,0)
 ;
"RTN","SAMIHOM4",19,0)
 ; @application: SAMI
"RTN","SAMIHOM4",20,0)
 ; @version: 18.0
"RTN","SAMIHOM4",21,0)
 ; @patch-list: none yet
"RTN","SAMIHOM4",22,0)
 ;
"RTN","SAMIHOM4",23,0)
 ; @to-do
"RTN","SAMIHOM4",24,0)
 ;   Add label comments
"RTN","SAMIHOM4",25,0)
 ;
"RTN","SAMIHOM4",26,0)
 ; @section 1 code
"RTN","SAMIHOM4",27,0)
 ;
"RTN","SAMIHOM4",28,0)
 quit  ; No entry from top
"RTN","SAMIHOM4",29,0)
 ;
"RTN","SAMIHOM4",30,0)
 ;
"RTN","SAMIHOM4",31,0)
WSHOME ; web service for SAMI homepage
"RTN","SAMIHOM4",32,0)
 ; WSHOME^SAMIHOM3(SAMIRTN,SAMIFILTER) goto WSHOME^SAMIHOM4
"RTN","SAMIHOM4",33,0)
 ;
"RTN","SAMIHOM4",34,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",35,0)
 ;
"RTN","SAMIHOM4",36,0)
 ;ven/gpl;web service;procedure;
"RTN","SAMIHOM4",37,0)
 ;@called-by
"RTN","SAMIHOM4",38,0)
 ;@calls
"RTN","SAMIHOM4",39,0)
 ; GETHOME
"RTN","SAMIHOM4",40,0)
 ;@input
"RTN","SAMIHOM4",41,0)
 ; SAMIFILTER
"RTN","SAMIHOM4",42,0)
 ;@output
"RTN","SAMIHOM4",43,0)
 ;.SAMIRTN
"RTN","SAMIHOM4",44,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",45,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",46,0)
 ;
"RTN","SAMIHOM4",47,0)
 ; no parameters required
"RTN","SAMIHOM4",48,0)
 ;
"RTN","SAMIHOM4",49,0)
 ;@stanza 2 present development or temporary homepage
"RTN","SAMIHOM4",50,0)
 ;
"RTN","SAMIHOM4",51,0)
 if $get(SAMIFILTER("test"))=1 do  quit
"RTN","SAMIHOM4",52,0)
 . do DEVHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER)
"RTN","SAMIHOM4",53,0)
 . quit
"RTN","SAMIHOM4",54,0)
 ;
"RTN","SAMIHOM4",55,0)
 if $g(SAMIFILTER("samiroute"))'="" do  quit  ; workaround for "get" access to pages
"RTN","SAMIHOM4",56,0)
 . new SAMIBODY set SAMIBODY(1)=""
"RTN","SAMIHOM4",57,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",58,0)
 ;
"RTN","SAMIHOM4",59,0)
 if $get(SAMIFILTER("dfn"))'="" do  quit  ; V4W/DLW - workaround for "get" access from CPRS
"RTN","SAMIHOM4",60,0)
 . new dfn set dfn=$get(SAMIFILTER("dfn"))
"RTN","SAMIHOM4",61,0)
 . new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",62,0)
 . new studyid set studyid=$get(@root@(dfn,"samistudyid"))
"RTN","SAMIHOM4",63,0)
 . new SAMIBODY
"RTN","SAMIHOM4",64,0)
 . if studyid'="" do
"RTN","SAMIHOM4",65,0)
 . . set SAMIBODY(1)="samiroute=casereview&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",66,0)
 . else  do
"RTN","SAMIHOM4",67,0)
 . . set SAMIBODY(1)="samiroute=lookup&dfn="_dfn_"&studyid="_studyid
"RTN","SAMIHOM4",68,0)
 . do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIBODY,.SAMIRTN)
"RTN","SAMIHOM4",69,0)
 ;
"RTN","SAMIHOM4",70,0)
 do GETHOME^SAMIHOM3(.SAMIRTN,.SAMIFILTER) ; VAPALS homepage
"RTN","SAMIHOM4",71,0)
 ;
"RTN","SAMIHOM4",72,0)
 ;@stanza 3 termination
"RTN","SAMIHOM4",73,0)
 ;
"RTN","SAMIHOM4",74,0)
 quit  ; end of WSHOME
"RTN","SAMIHOM4",75,0)
 ;
"RTN","SAMIHOM4",76,0)
 ;
"RTN","SAMIHOM4",77,0)
WSVAPALS ; vapals post web service - all calls come through this gateway
"RTN","SAMIHOM4",78,0)
 ; WSVAPALS^SAMIHOM3(SAMIARG,SAMIBODY,SAMIRESULT) goto WSVAPALS^SAMIHOM4
"RTN","SAMIHOM4",79,0)
 m ^SAMIUL("vapals")=SAMIARG
"RTN","SAMIHOM4",80,0)
 m ^SAMIUL("vapals","BODY")=SAMIBODY
"RTN","SAMIHOM4",81,0)
 ;
"RTN","SAMIHOM4",82,0)
 new vars,SAMIBDY
"RTN","SAMIHOM4",83,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",84,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",85,0)
 m vars=SAMIARG
"RTN","SAMIHOM4",86,0)
 k ^SAMIUL("vapals","vars")
"RTN","SAMIHOM4",87,0)
 merge ^SAMIUL("vapals","vars")=vars
"RTN","SAMIHOM4",88,0)
 ;
"RTN","SAMIHOM4",89,0)
 n route s route=$g(vars("samiroute"))
"RTN","SAMIHOM4",90,0)
 i route=""  d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home
"RTN","SAMIHOM4",91,0)
 ;
"RTN","SAMIHOM4",92,0)
 i route="lookup" d  q 0
"RTN","SAMIHOM4",93,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",94,0)
 . d WSLOOKUP^SAMISRC2(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",95,0)
 ;
"RTN","SAMIHOM4",96,0)
 i route="newcase" d  q 0
"RTN","SAMIHOM4",97,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",98,0)
 . d WSNEWCAS^SAMIHOM3(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",99,0)
 ;
"RTN","SAMIHOM4",100,0)
 i route="casereview" d  q 0
"RTN","SAMIHOM4",101,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",102,0)
 . d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",103,0)
 ;
"RTN","SAMIHOM4",104,0)
 i route="nuform" d  q 0
"RTN","SAMIHOM4",105,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",106,0)
 . d WSNUFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",107,0)
 ;
"RTN","SAMIHOM4",108,0)
 i route="addform" d  q 0
"RTN","SAMIHOM4",109,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",110,0)
 . d WSNFPOST^SAMICASE(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",111,0)
 ;
"RTN","SAMIHOM4",112,0)
 i route="form" d  q 0
"RTN","SAMIHOM4",113,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",114,0)
 . d wsGetForm^%wf(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",115,0)
 ;
"RTN","SAMIHOM4",116,0)
 i route="postform" d  q 0
"RTN","SAMIHOM4",117,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",118,0)
 . d wsPostForm^%wf(.SAMIARG,.SAMIBODY,.SAMIRESULT)
"RTN","SAMIHOM4",119,0)
 . i $g(SAMIARG("form"))["siform" d  ;
"RTN","SAMIHOM4",120,0)
 . . if $$NOTE^SAMINOT1(.SAMIARG) d  ;
"RTN","SAMIHOM4",121,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",122,0)
 . . . s SAMIFILTER("studyid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",123,0)
 . . . s SAMIFILTER("form")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",124,0)
 . . . n tiuien
"RTN","SAMIHOM4",125,0)
 . . . ;s tiuien=$$SV2VISTA^SAMIVSTA(.SAMIFILTER)
"RTN","SAMIHOM4",126,0)
 . . . ;s SAMIFILTER("tiuien")=tiuien
"RTN","SAMIHOM4",127,0)
 . . . ;d SV2VSTA^SAMIVSTA(.FILTER)
"RTN","SAMIHOM4",128,0)
 . . . ;m ^SAMIUL("newFILTER")=SAMIFILTER
"RTN","SAMIHOM4",129,0)
 . . . d WSNOTE^SAMINOT1(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",130,0)
 . i $g(SAMIARG("form"))["fuform" d  ;
"RTN","SAMIHOM4",131,0)
 . . if $$NOTE^SAMINOT2(.SAMIARG) d  ;
"RTN","SAMIHOM4",132,0)
 . . . n SAMIFILTER
"RTN","SAMIHOM4",133,0)
 . . . s SAMIFILTER("studyid")=$G(SAMIARG("studyid"))
"RTN","SAMIHOM4",134,0)
 . . . s SAMIFILTER("form")=$g(SAMIARG("form")) ;
"RTN","SAMIHOM4",135,0)
 . . . ;n tiuien
"RTN","SAMIHOM4",136,0)
 . . . ;s tiuien=$$SV2VISTA^SAMIVSTA(.SAMIFILTER)
"RTN","SAMIHOM4",137,0)
 . . . ;s SAMIFILTER("tiuien")=tiuien
"RTN","SAMIHOM4",138,0)
 . . . ;d SV2VSTA^SAMIVSTA(.FILTER)
"RTN","SAMIHOM4",139,0)
 . . . ;m ^SAMIUL("newFILTER")=SAMIFILTER
"RTN","SAMIHOM4",140,0)
 . . . d WSNOTE^SAMINOT2(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",141,0)
 . . e  d WSCASE^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",142,0)
 ;
"RTN","SAMIHOM4",143,0)
 i route="deleteform" d  q 0
"RTN","SAMIHOM4",144,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",145,0)
 . d DELFORM^SAMICASE(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",146,0)
 ;
"RTN","SAMIHOM4",147,0)
 i route="ctreport" d  q 0
"RTN","SAMIHOM4",148,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",149,0)
 . n format s format="html"
"RTN","SAMIHOM4",150,0)
 . s format="text"
"RTN","SAMIHOM4",151,0)
 . i format="text" d WSNOTE^SAMINOT3(.SAMIRESULT,.SAMIARG) q  ;
"RTN","SAMIHOM4",152,0)
 . i format="html" d WSREPORT^SAMICTR0(.SAMIRESULT,.SAMIARG) q  ;
"RTN","SAMIHOM4",153,0)
 . ;d wsReport^SAMICTRT(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",154,0)
 ;
"RTN","SAMIHOM4",155,0)
 i route="note" d  q 0
"RTN","SAMIHOM4",156,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",157,0)
 . d WSNOTE^SAMINOT1(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",158,0)
 ;
"RTN","SAMIHOM4",159,0)
 i route="report" d  q 0 
"RTN","SAMIHOM4",160,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",161,0)
 . d WSREPORT^SAMIUR(.SAMIRESULT,.vars)
"RTN","SAMIHOM4",162,0)
 ;
"RTN","SAMIHOM4",163,0)
 i route="addperson" d  q 0
"RTN","SAMIHOM4",164,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",165,0)
 . n form
"RTN","SAMIHOM4",166,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",167,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",168,0)
 ;
"RTN","SAMIHOM4",169,0)
 i route="editperson" d  q 0
"RTN","SAMIHOM4",170,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",171,0)
 . n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",172,0)
 . i dfn="" d  q  ;
"RTN","SAMIHOM4",173,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",174,0)
 . n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",175,0)
 . n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",176,0)
 . i sien="" d  q  ;
"RTN","SAMIHOM4",177,0)
 . . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",178,0)
 . s vars("name")=$g(@root@(sien,"saminame"))
"RTN","SAMIHOM4",179,0)
 . s tdob=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",180,0)
 . s vars("dob")=$p(tdob,"-",2)_"/"_$p(tdob,"-",3)_"/"_$p(tdob,"-",1)
"RTN","SAMIHOM4",181,0)
 . s vars("sbdob")=$g(@root@(sien,"dob"))
"RTN","SAMIHOM4",182,0)
 . s vars("gender")=$g(@root@(sien,"sex"))
"RTN","SAMIHOM4",183,0)
 . s vars("icn")=$g(@root@(sien,"icn"))
"RTN","SAMIHOM4",184,0)
 . n tssn s tssn=$g(@root@(sien,"ssn"))
"RTN","SAMIHOM4",185,0)
 . s vars("ssn")=$e(tssn,1,3)_"-"_$e(tssn,4,5)_"-"_$e(tssn,6,9)
"RTN","SAMIHOM4",186,0)
 . s vars("last5")=$g(@root@(sien,"last5"))
"RTN","SAMIHOM4",187,0)
 . s vars("dfn")=$g(@root@(sien,"dfn"))
"RTN","SAMIHOM4",188,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",189,0)
 . n form,err,zhtml
"RTN","SAMIHOM4",190,0)
 . s form="vapals:editparticipant"
"RTN","SAMIHOM4",191,0)
 . d RTNPAGE^SAMIHOM4(.SAMIRESULT,form,.SAMIARG) q  ;
"RTN","SAMIHOM4",192,0)
 ;
"RTN","SAMIHOM4",193,0)
 i route="register" d  q 0
"RTN","SAMIHOM4",194,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",195,0)
 . d REG^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",196,0)
 ; 
"RTN","SAMIHOM4",197,0)
 i route="editsave" d  q 0
"RTN","SAMIHOM4",198,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",199,0)
 . d SAVE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",200,0)
 ;
"RTN","SAMIHOM4",201,0)
 i route="merge" d  q 0
"RTN","SAMIHOM4",202,0)
 . m SAMIARG=vars
"RTN","SAMIHOM4",203,0)
 . d MERGE^SAMIHOM4(.SAMIRESULT,.SAMIARG)
"RTN","SAMIHOM4",204,0)
 ;
"RTN","SAMIHOM4",205,0)
 quit 0  ; End of WSVAPALS
"RTN","SAMIHOM4",206,0)
 ;
"RTN","SAMIHOM4",207,0)
 ;
"RTN","SAMIHOM4",208,0)
REG(SAMIRTN,SAMIARG) ; manual registration
"RTN","SAMIHOM4",209,0)
 ;
"RTN","SAMIHOM4",210,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",211,0)
 ;
"RTN","SAMIHOM4",212,0)
 m ^gpl("reg")=SAMIARG
"RTN","SAMIHOM4",213,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",214,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",215,0)
 s SAMIARG("errorMessage")=""
"RTN","SAMIHOM4",216,0)
 s SAMIARG("errorField")=""
"RTN","SAMIHOM4",217,0)
 ; test for duplicate ssn
"RTN","SAMIHOM4",218,0)
 ;
"RTN","SAMIHOM4",219,0)
 i $$DUPSSN(ssn) d  ;
"RTN","SAMIHOM4",220,0)
 . ;s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN."
"RTN","SAMIHOM4",221,0)
 . s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate SSN error. A person with that SSN is already entered in the system."
"RTN","SAMIHOM4",222,0)
 . s SAMIARG("errorField")="ssn"
"RTN","SAMIHOM4",223,0)
 ;
"RTN","SAMIHOM4",224,0)
 ; test for duplicate icn
"RTN","SAMIHOM4",225,0)
 ;
"RTN","SAMIHOM4",226,0)
 n icn s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",227,0)
 i icn'="" i $$DUPICN(icn) d  ;
"RTN","SAMIHOM4",228,0)
 . s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Duplicate ICN error. A person with that ICN is already entered in the system."
"RTN","SAMIHOM4",229,0)
 . s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",230,0)
 ;
"RTN","SAMIHOM4",231,0)
 ; test for wellformed ICN
"RTN","SAMIHOM4",232,0)
 ;
"RTN","SAMIHOM4",233,0)
 i icn'="" i $$BADICN(icn) d  ;
"RTN","SAMIHOM4",234,0)
 . s SAMIARG("errorMessage")=SAMIARG("errorMessage")_" Invalid ICN error. The check digits in the ICN do not match"
"RTN","SAMIHOM4",235,0)
 . s SAMIARG("errorField")="icn"
"RTN","SAMIHOM4",236,0)
 ;
"RTN","SAMIHOM4",237,0)
 ; if there is an error, send back to edit with error message
"RTN","SAMIHOM4",238,0)
 i $g(SAMIARG("errorMessage"))'="" d  q  ;
"RTN","SAMIHOM4",239,0)
 . n form
"RTN","SAMIHOM4",240,0)
 . s form="vapals:addperson"
"RTN","SAMIHOM4",241,0)
 . d RTNERR(.SAMIRESULT,form,.SAMIARG)
"RTN","SAMIHOM4",242,0)
 ;
"RTN","SAMIHOM4",243,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",244,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",245,0)
 n ptlkien s ptlkien=""
"RTN","SAMIHOM4",246,0)
 n dfn s dfn=""
"RTN","SAMIHOM4",247,0)
 n sien s sien=""
"RTN","SAMIHOM4",248,0)
 i ptlkien="" s ptlkien=$o(@root@("AAAAAA"),-1)+1
"RTN","SAMIHOM4",249,0)
 n zm
"RTN","SAMIHOM4",250,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",251,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",252,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",253,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",254,0)
 d MKPTLK(ptlkien,.SAMIARG) ; make the patient-lookup record
"RTN","SAMIHOM4",255,0)
 ;
"RTN","SAMIHOM4",256,0)
 s dfn=$o(@root@("dfn"," "),-1)+1
"RTN","SAMIHOM4",257,0)
 i dfn<9000001 s dfn=9000001
"RTN","SAMIHOM4",258,0)
 s @root@(ptlkien,"dfn")=dfn
"RTN","SAMIHOM4",259,0)
 d INDXPTLK(ptlkien)
"RTN","SAMIHOM4",260,0)
 s SAMIFILTER("samiroute")="addperson"
"RTN","SAMIHOM4",261,0)
 d SETINFO(.SAMIFILTER,name_" was successfully entered")
"RTN","SAMIHOM4",262,0)
 ;d SETWARN(.SAMIFILTER,"We might want to give you a warning")
"RTN","SAMIHOM4",263,0)
 do WSVAPALS^SAMIHOM3(.SAMIFILTER,.SAMIARG,.SAMIRESULT)
"RTN","SAMIHOM4",264,0)
 q
"RTN","SAMIHOM4",265,0)
 ;
"RTN","SAMIHOM4",266,0)
MKPTLK(ptlkien,SAMIARG) ; creates the patient-lookup record
"RTN","SAMIHOM4",267,0)
 n ssn s ssn=SAMIARG("ssn")
"RTN","SAMIHOM4",268,0)
 s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",269,0)
 n name s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",270,0)
 n sinamef,sinamel
"RTN","SAMIHOM4",271,0)
 s sinamel=$p(name,","),sinamel=$$TRIM^XLFSTR(sinamel,"LR")
"RTN","SAMIHOM4",272,0)
 s sinamef=$p(name,",",2),sinamef=$$TRIM^XLFSTR(sinamef,"LR")
"RTN","SAMIHOM4",273,0)
 s name=sinamel_","_sinamef
"RTN","SAMIHOM4",274,0)
 s @root@(ptlkien,"saminame")=name
"RTN","SAMIHOM4",275,0)
 s @root@(ptlkien,"sinamef")=sinamef
"RTN","SAMIHOM4",276,0)
 s @root@(ptlkien,"sinamel")=sinamel
"RTN","SAMIHOM4",277,0)
 n fmdob s fmdob=$$FMDT^SAMIUR2(SAMIARG("dob"))
"RTN","SAMIHOM4",278,0)
 n ptlkdob s ptlkdob=$$FMTE^XLFDT(fmdob,7)
"RTN","SAMIHOM4",279,0)
 s ptlkdob=$TR(ptlkdob,"/","-")
"RTN","SAMIHOM4",280,0)
 s @root@(ptlkien,"dob")=ptlkdob
"RTN","SAMIHOM4",281,0)
 s @root@(ptlkien,"sbdob")=ptlkdob
"RTN","SAMIHOM4",282,0)
 n gender s gender=SAMIARG("gender")
"RTN","SAMIHOM4",283,0)
 s @root@(ptlkien,"gender")=$s(gender="M":"M^MALE",1:"F^FEMALE")
"RTN","SAMIHOM4",284,0)
 s @root@(ptlkien,"sex")=SAMIARG("gender")
"RTN","SAMIHOM4",285,0)
 s @root@(ptlkien,"icn")=SAMIARG("icn")
"RTN","SAMIHOM4",286,0)
 s @root@(ptlkien,"ssn")=ssn
"RTN","SAMIHOM4",287,0)
 n last5 s last5=$$UCASE($e(name,1))_$e(ssn,6,9)
"RTN","SAMIHOM4",288,0)
 s @root@(ptlkien,"last5")=last5
"RTN","SAMIHOM4",289,0)
 n mymatch s mymatch=$g(SAMIARG("MATCHLOG"))
"RTN","SAMIHOM4",290,0)
 i mymatch'="" s @root@(ptlkien,"MATCHLOG")=mymatch
"RTN","SAMIHOM4",291,0)
 q
"RTN","SAMIHOM4",292,0)
 ;
"RTN","SAMIHOM4",293,0)
UPDTFRMS(dfn) ; update demographics in all patient forms for patient dfn
"RTN","SAMIHOM4",294,0)
 ;
"RTN","SAMIHOM4",295,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",296,0)
 n proot s proot=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",297,0)
 n lien s lien=$o(@lroot@("dfn",dfn,""))
"RTN","SAMIHOM4",298,0)
 q:lien=""
"RTN","SAMIHOM4",299,0)
 n pien s pien=$o(@proot@("dfn",dfn,""))
"RTN","SAMIHOM4",300,0)
 q:pien=""
"RTN","SAMIHOM4",301,0)
 ; this patient has forms
"RTN","SAMIHOM4",302,0)
 m @proot@(pien)=@lroot@(lien) ; refresh the demos in the patient record
"RTN","SAMIHOM4",303,0)
 n ssn s ssn=$g(@proot@(pien,"ssn"))
"RTN","SAMIHOM4",304,0)
 s @proot@(pien,"sissn")=$e(ssn,1,3)_"-"_$e(ssn,4,5)_"-"_$e(ssn,6,9)
"RTN","SAMIHOM4",305,0)
 n sid s sid=$g(@proot@("sisid")) ; studyid 
"RTN","SAMIHOM4",306,0)
 q:sid=""  ; no studyid
"RTN","SAMIHOM4",307,0)
 n zi s zi=""
"RTN","SAMIHOM4",308,0)
 f  s zi=$o(@proot@("graph",sid,zi)) q:zi=""  d  ; for each form
"RTN","SAMIHOM4",309,0)
 . m @proot@("graph",sid,zi)=@proot@(pien) ; stamp each form with new demos
"RTN","SAMIHOM4",310,0)
 q
"RTN","SAMIHOM4",311,0)
 ;
"RTN","SAMIHOM4",312,0)
MERGE(SAMIRESULT,SAMIARGS) ; merge participant records
"RTN","SAMIHOM4",313,0)
 ; called from pressing the merge button on the unmatched report
"RTN","SAMIHOM4",314,0)
 n toien s toien=$g(SAMIARGS("toien"))
"RTN","SAMIHOM4",315,0)
 i toien="" d  q  ;
"RTN","SAMIHOM4",316,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",317,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",318,0)
 n fromien s fromien=$g(@lroot@(toien,"MATCHLOG"))
"RTN","SAMIHOM4",319,0)
 i fromien="" d  q  ;
"RTN","SAMIHOM4",320,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",321,0)
 ;
"RTN","SAMIHOM4",322,0)
 ; test for remotedfn in from record - not valid if absent
"RTN","SAMIHOM4",323,0)
 ;
"RTN","SAMIHOM4",324,0)
 i $g(@lroot@(fromien,"remotedfn"))="" d  q  ;
"RTN","SAMIHOM4",325,0)
 . d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",326,0)
 ;
"RTN","SAMIHOM4",327,0)
 ; remove index entries for from and to records
"RTN","SAMIHOM4",328,0)
 ;
"RTN","SAMIHOM4",329,0)
 d UNINDXPT(fromien) ; delete index entries
"RTN","SAMIHOM4",330,0)
 d UNINDXPT(toien)
"RTN","SAMIHOM4",331,0)
 ;
"RTN","SAMIHOM4",332,0)
 ; create changelog entry in to record - contains from record
"RTN","SAMIHOM4",333,0)
 ;
"RTN","SAMIHOM4",334,0)
 m @lroot@(toien,"changelog",$$FMTE^XLFDT($$NOW^XLFDT,5))=@lroot@(fromien)
"RTN","SAMIHOM4",335,0)
 ;
"RTN","SAMIHOM4",336,0)
 ; change the dfn in the from record to the to record dfn for merging
"RTN","SAMIHOM4",337,0)
 ;
"RTN","SAMIHOM4",338,0)
 s @lroot@(fromien,"dfn")=@lroot@(toien,"dfn")
"RTN","SAMIHOM4",339,0)
 n dfn s dfn=@lroot@(toien,"dfn") ; for use in updating forms
"RTN","SAMIHOM4",340,0)
 ;
"RTN","SAMIHOM4",341,0)
 ; merge the from record to the to record
"RTN","SAMIHOM4",342,0)
 ;
"RTN","SAMIHOM4",343,0)
 m @lroot@(toien)=@lroot@(fromien)
"RTN","SAMIHOM4",344,0)
 ;
"RTN","SAMIHOM4",345,0)
 ; delete the from record
"RTN","SAMIHOM4",346,0)
 ;
"RTN","SAMIHOM4",347,0)
 k @lroot@(fromien)
"RTN","SAMIHOM4",348,0)
 ;
"RTN","SAMIHOM4",349,0)
 ; reindex the to record
"RTN","SAMIHOM4",350,0)
 ;
"RTN","SAMIHOM4",351,0)
 d INDXPTLK(toien)
"RTN","SAMIHOM4",352,0)
 ;
"RTN","SAMIHOM4",353,0)
 ; propagate the updated from record to every form
"RTN","SAMIHOM4",354,0)
 ;
"RTN","SAMIHOM4",355,0)
 d UPDTFRMS(dfn) ; updates the patient in the vapals-patient graph
"RTN","SAMIHOM4",356,0)
 ;
"RTN","SAMIHOM4",357,0)
 ; leave and return to the unmatched report
"RTN","SAMIHOM4",358,0)
 ;   note that the form and to records will no longer be in the report
"RTN","SAMIHOM4",359,0)
 ;
"RTN","SAMIHOM4",360,0)
 d WSUNMAT(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",361,0)
 ;
"RTN","SAMIHOM4",362,0)
 q
"RTN","SAMIHOM4",363,0)
 ;
"RTN","SAMIHOM4",364,0)
ADDUNMAT ; adds the unmatched report web service to the system
"RTN","SAMIHOM4",365,0)
 ;
"RTN","SAMIHOM4",366,0)
 d addService^%webutils("GET","unmatched","WSUNMAT^SAMIHOM4")
"RTN","SAMIHOM4",367,0)
 q
"RTN","SAMIHOM4",368,0)
 ;
"RTN","SAMIHOM4",369,0)
DELUNMAT ; deletes the unmatched web service
"RTN","SAMIHOM4",370,0)
 ;
"RTN","SAMIHOM4",371,0)
 d deleteService^%webutils("GET","unmatched")
"RTN","SAMIHOM4",372,0)
 q
"RTN","SAMIHOM4",373,0)
 ;
"RTN","SAMIHOM4",374,0)
WSUNMAT(SAMIRESULT,SAMIARGS) ; navigates to unmatched report
"RTN","SAMIHOM4",375,0)
 ; 
"RTN","SAMIHOM4",376,0)
 n filter,bdy
"RTN","SAMIHOM4",377,0)
 s bdy=""
"RTN","SAMIHOM4",378,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",379,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",380,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",381,0)
 q
"RTN","SAMIHOM4",382,0)
 ;
"RTN","SAMIHOM4",383,0)
DUPSSN(ssn) ; extrinsic returns true if duplicate ssn
"RTN","SAMIHOM4",384,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",385,0)
 i $d(@proot@("ssn",ssn)) q 1
"RTN","SAMIHOM4",386,0)
 q 0
"RTN","SAMIHOM4",387,0)
 ;
"RTN","SAMIHOM4",388,0)
DUPICN(icn) ; extrinsic returns true if duplicate icn
"RTN","SAMIHOM4",389,0)
 n proot s proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",390,0)
 n tmpicn s tmpicn=$p(icn,"V",1)
"RTN","SAMIHOM4",391,0)
 i $d(@proot@("icn",icn)) q 1
"RTN","SAMIHOM4",392,0)
 i $d(@proot@("icn",tmpicn)) q 1
"RTN","SAMIHOM4",393,0)
 q 0
"RTN","SAMIHOM4",394,0)
 ;
"RTN","SAMIHOM4",395,0)
BADICN(icn) ; extrinsic returns true if ICN checkdigits are wrong
"RTN","SAMIHOM4",396,0)
 n zchk s zchk=$p(icn,"V",2)
"RTN","SAMIHOM4",397,0)
 n zicn s zicn=$p(icn,"V",1)
"RTN","SAMIHOM4",398,0)
 q:zchk="" 1
"RTN","SAMIHOM4",399,0)
 i zchk'=$$CHECKDG^MPIFSPC(zicn) q 1
"RTN","SAMIHOM4",400,0)
 q 0
"RTN","SAMIHOM4",401,0)
 ;
"RTN","SAMIHOM4",402,0)
SAVE(SAMIRESULT,SAMIARG) ; save patient-lookup record after edit
"RTN","SAMIHOM4",403,0)
 ;
"RTN","SAMIHOM4",404,0)
 n dfn s dfn=$g(vars("dfn")) ; must have a dfn
"RTN","SAMIHOM4",405,0)
 i dfn="" d  q  ;
"RTN","SAMIHOM4",406,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",407,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",408,0)
 n sien s sien=$o(@root@("dfn",dfn,""))
"RTN","SAMIHOM4",409,0)
 i sien="" d  q  ;
"RTN","SAMIHOM4",410,0)
 . d GETHOME^SAMIHOM3(.SAMIRESULT,.SAMIARG) ; on error go home 
"RTN","SAMIHOM4",411,0)
 d UNINDXPT(sien) ; remove old index entries
"RTN","SAMIHOM4",412,0)
 n zm
"RTN","SAMIHOM4",413,0)
 k SAMIARG("MATCHLOG")
"RTN","SAMIHOM4",414,0)
 s zm=$$REMATCH(sien,.SAMIARG)
"RTN","SAMIHOM4",415,0)
 i zm>0 d  ;
"RTN","SAMIHOM4",416,0)
 . s SAMIARG("MATCHLOG")=zm
"RTN","SAMIHOM4",417,0)
 d MKPTLK(sien,.SAMIARG) ; add the updated fields
"RTN","SAMIHOM4",418,0)
 d INDXPTLK(sien) ; create new index entries
"RTN","SAMIHOM4",419,0)
 d UPDTFRMS(dfn) ; update demographic info in all forms
"RTN","SAMIHOM4",420,0)
 n filter,bdy
"RTN","SAMIHOM4",421,0)
 s bdy=""
"RTN","SAMIHOM4",422,0)
 s filter("samiroute")="report"
"RTN","SAMIHOM4",423,0)
 s filter("samireporttype")="unmatched"
"RTN","SAMIHOM4",424,0)
 d WSVAPALS^SAMIHOM3(.filter,.bdy,.SAMIRESULT) ; back to the unmatched report
"RTN","SAMIHOM4",425,0)
 q
"RTN","SAMIHOM4",426,0)
 ;
"RTN","SAMIHOM4",427,0)
REMATCH(sien,SAMIARG) ; extrinsic returns a possible match ien
"RTN","SAMIHOM4",428,0)
 ; else zero
"RTN","SAMIHOM4",429,0)
 n lroot s lroot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",430,0)
 n ssn,name,icn,x,y
"RTN","SAMIHOM4",431,0)
 s ssn=$g(SAMIARG("ssn"))
"RTN","SAMIHOM4",432,0)
 i ssn["-" s ssn=$tr(ssn,"-")
"RTN","SAMIHOM4",433,0)
 s name=$g(SAMIARG("saminame"))
"RTN","SAMIHOM4",434,0)
 i name="" s name=$g(SAMIARG("name"))
"RTN","SAMIHOM4",435,0)
 s icn=$g(SAMIARG("icn"))
"RTN","SAMIHOM4",436,0)
 s x=0
"RTN","SAMIHOM4",437,0)
 i ssn'="" s x=$o(@lroot@("ssn",ssn,""))
"RTN","SAMIHOM4",438,0)
 i x=sien s x=$o(@lroot@("ssn",ssn,x))
"RTN","SAMIHOM4",439,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",440,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",441,0)
 . i y>9000000 s x=0
"RTN","SAMIHOM4",442,0)
 i x>0 q x
"RTN","SAMIHOM4",443,0)
 i name'="" s x=$o(@lroot@("name",name,""))
"RTN","SAMIHOM4",444,0)
 i x=sien s x=$o(@lroot@("name",name,x))
"RTN","SAMIHOM4",445,0)
 i +x'=0 d  ;
"RTN","SAMIHOM4",446,0)
 . s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",447,0)
 . i y>9000000 s x=0
"RTN","SAMIHOM4",448,0)
 i x>0 q x
"RTN","SAMIHOM4",449,0)
 ;i icn'="" s x=$o(@lroot@("icn",icn,""))
"RTN","SAMIHOM4",450,0)
 ;i x=sien s x=$o(@lroot@("icn",icn,x))
"RTN","SAMIHOM4",451,0)
 ;i +x'=0 d  ;
"RTN","SAMIHOM4",452,0)
 ;. s y=$g(@lroot@(x,"dfn"))
"RTN","SAMIHOM4",453,0)
 ;. i y>9000000 s x=0
"RTN","SAMIHOM4",454,0)
 ;i x>0 q x
"RTN","SAMIHOM4",455,0)
 q 0
"RTN","SAMIHOM4",456,0)
 ;
"RTN","SAMIHOM4",457,0)
SETINFO(vars,msg) ; set the information message text
"RTN","SAMIHOM4",458,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",459,0)
 s vars("infoMessage")=msg
"RTN","SAMIHOM4",460,0)
 q
"RTN","SAMIHOM4",461,0)
 ;
"RTN","SAMIHOM4",462,0)
SETWARN(vars,msg) ; set warning message text
"RTN","SAMIHOM4",463,0)
 ; vars are the screen variables passed by reference
"RTN","SAMIHOM4",464,0)
 s vars("warnMessage")=msg
"RTN","SAMIHOM4",465,0)
 q
"RTN","SAMIHOM4",466,0)
 ; 
"RTN","SAMIHOM4",467,0)
RTNERR(rtn,form,vals,msg,fld) ; redisplays a page with an error message
"RTN","SAMIHOM4",468,0)
 ; rtn is the return array
"RTN","SAMIHOM4",469,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",470,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",471,0)
 ; msg is the error message to be displayed
"RTN","SAMIHOM4",472,0)
 ; fld is the name of the field where the cursor should be put
"RTN","SAMIHOM4",473,0)
 ;
"RTN","SAMIHOM4",474,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",475,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",476,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",477,0)
 m SAMIRESULT=zhtml
"RTN","SAMIHOM4",478,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",479,0)
 q
"RTN","SAMIHOM4",480,0)
 ;
"RTN","SAMIHOM4",481,0)
RTNPAGE(rtn,form,vals) ; displays a page
"RTN","SAMIHOM4",482,0)
 ; rtn is the return array
"RTN","SAMIHOM4",483,0)
 ; form is the form the page requires
"RTN","SAMIHOM4",484,0)
 ; vals are the values for the page. passed by reference
"RTN","SAMIHOM4",485,0)
 ;
"RTN","SAMIHOM4",486,0)
 n err
"RTN","SAMIHOM4",487,0)
 n zhtml ; work area for the tempate
"RTN","SAMIHOM4",488,0)
 d SAMIHTM^%wf(.zhtml,form,.err)
"RTN","SAMIHOM4",489,0)
 d MERGEHTM^%wf(.zhtml,.vals,.err)
"RTN","SAMIHOM4",490,0)
 m SAMIRESULT=zhtml
"RTN","SAMIHOM4",491,0)
 set HTTPRSP("mime")="text/html" ; set mime type
"RTN","SAMIHOM4",492,0)
 q
"RTN","SAMIHOM4",493,0)
 ;
"RTN","SAMIHOM4",494,0)
REINDXPL ; reindex patient lookup
"RTN","SAMIHOM4",495,0)
 n root s root=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",496,0)
 n zi s zi=0
"RTN","SAMIHOM4",497,0)
 k @root@("ssn")
"RTN","SAMIHOM4",498,0)
 k @root@("name")
"RTN","SAMIHOM4",499,0)
 k @root@("last5")
"RTN","SAMIHOM4",500,0)
 k @root@("sinamef")
"RTN","SAMIHOM4",501,0)
 k @root@("sinamel")
"RTN","SAMIHOM4",502,0)
 k @root@("icn")
"RTN","SAMIHOM4",503,0)
 f  s zi=$o(@root@(zi)) q:+zi=0  d  ;
"RTN","SAMIHOM4",504,0)
 . d INDXPTLK(zi)
"RTN","SAMIHOM4",505,0)
 q
"RTN","SAMIHOM4",506,0)
 ;
"RTN","SAMIHOM4",507,0)
INDXPTLK(ien) ; generate index entries in patient-lookup graph
"RTN","SAMIHOM4",508,0)
 ; for entry ien
"RTN","SAMIHOM4",509,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",510,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",511,0)
 s @proot@("name",name,ien)=""
"RTN","SAMIHOM4",512,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",513,0)
 s @proot@("name",ucname,ien)=""
"RTN","SAMIHOM4",514,0)
 n x
"RTN","SAMIHOM4",515,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",516,0)
 s:x'="" @proot@("dfn",x,ien)=""
"RTN","SAMIHOM4",517,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",518,0)
 s:x'="" @proot@("last5",x,ien)=""
"RTN","SAMIHOM4",519,0)
 s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",520,0)
 i x'["V" d  ;
"RTN","SAMIHOM4",521,0)
 . i x="" q
"RTN","SAMIHOM4",522,0)
 . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",523,0)
 . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",524,0)
 . s x=x_"V"_chk
"RTN","SAMIHOM4",525,0)
 s:x'="" @proot@("icn",x,ien)=""
"RTN","SAMIHOM4",526,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",527,0)
 s:x'="" @proot@("ssn",x,ien)=""
"RTN","SAMIHOM4",528,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",529,0)
 s:x'="" @proot@("sinamef",x,ien)=""
"RTN","SAMIHOM4",530,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",531,0)
 s:x'="" @proot@("sinamel",x,ien)=""
"RTN","SAMIHOM4",532,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",533,0)
 q
"RTN","SAMIHOM4",534,0)
 ;
"RTN","SAMIHOM4",535,0)
UNINDXPT(ien) ; remove index entries in patient-lookup graph
"RTN","SAMIHOM4",536,0)
 ; for entry ien
"RTN","SAMIHOM4",537,0)
 n proot set proot=$$setroot^%wd("patient-lookup")
"RTN","SAMIHOM4",538,0)
 n name s name=$g(@proot@(ien,"saminame"))
"RTN","SAMIHOM4",539,0)
 k @proot@("name",name,ien)
"RTN","SAMIHOM4",540,0)
 n ucname s ucname=$$UCASE(name)
"RTN","SAMIHOM4",541,0)
 k @proot@("name",ucname,ien)
"RTN","SAMIHOM4",542,0)
 n x
"RTN","SAMIHOM4",543,0)
 s x=$g(@proot@(ien,"dfn")) ;w !,x
"RTN","SAMIHOM4",544,0)
 k:x'="" @proot@("dfn",x,ien)
"RTN","SAMIHOM4",545,0)
 s x=$g(@proot@(ien,"last5")) ;w !,x
"RTN","SAMIHOM4",546,0)
 k:x'="" @proot@("last5",x,ien)
"RTN","SAMIHOM4",547,0)
 s x=$g(@proot@(ien,"icn")) ;w !,x
"RTN","SAMIHOM4",548,0)
 i x'["V" d  ;
"RTN","SAMIHOM4",549,0)
 . i x="" q
"RTN","SAMIHOM4",550,0)
 . n chk s chk=$$CHECKDG^MPIFSPC(x)
"RTN","SAMIHOM4",551,0)
 . s @proot@(ien,"icn")=x_"V"_chk
"RTN","SAMIHOM4",552,0)
 . s x=x_"V"_chk
"RTN","SAMIHOM4",553,0)
 k:x'="" @proot@("icn",x,ien)
"RTN","SAMIHOM4",554,0)
 s x=$g(@proot@(ien,"ssn")) ;w !,x
"RTN","SAMIHOM4",555,0)
 k:x'="" @proot@("ssn",x,ien)
"RTN","SAMIHOM4",556,0)
 s x=$g(@proot@(ien,"sinamef")) ;w !,x
"RTN","SAMIHOM4",557,0)
 k:x'="" @proot@("sinamef",x,ien)
"RTN","SAMIHOM4",558,0)
 s x=$g(@proot@(ien,"sinamel")) w !,x
"RTN","SAMIHOM4",559,0)
 k:x'="" @proot@("sinamel",x,ien)
"RTN","SAMIHOM4",560,0)
 set @proot@("Date Last Updated")=$$HTE^XLFDT($horolog)
"RTN","SAMIHOM4",561,0)
 q
"RTN","SAMIHOM4",562,0)
 ;
"RTN","SAMIHOM4",563,0)
UCASE(STR) ; extrinsic returns uppercase of STR
"RTN","SAMIHOM4",564,0)
 N X,Y
"RTN","SAMIHOM4",565,0)
 S X=STR
"RTN","SAMIHOM4",566,0)
 X ^%ZOSF("UPPERCASE")
"RTN","SAMIHOM4",567,0)
 q Y
"RTN","SAMIHOM4",568,0)
 ;
"RTN","SAMIHOM4",569,0)
DEVHOME ; temporary home page for development
"RTN","SAMIHOM4",570,0)
 ; DEVHOME^SAMIHOM3(SAMIRTN,SAMIFILTER) goto DEVHOME^SAMIHOM4
"RTN","SAMIHOM4",571,0)
 ;
"RTN","SAMIHOM4",572,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",573,0)
 ;
"RTN","SAMIHOM4",574,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",575,0)
 ;@called-by
"RTN","SAMIHOM4",576,0)
 ; WSHOME
"RTN","SAMIHOM4",577,0)
 ;@calls
"RTN","SAMIHOM4",578,0)
 ; htmltb2^%yottaweb
"RTN","SAMIHOM4",579,0)
 ; PATLIST
"RTN","SAMIHOM4",580,0)
 ; genhtml^%yottautl
"RTN","SAMIHOM4",581,0)
 ; addary^%yottautl
"RTN","SAMIHOM4",582,0)
 ;@input
"RTN","SAMIHOM4",583,0)
 ; SAMIFILTER =
"RTN","SAMIHOM4",584,0)
 ;@output
"RTN","SAMIHOM4",585,0)
 ;.SAMIRTN =
"RTN","SAMIHOM4",586,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",587,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",588,0)
 ;
"RTN","SAMIHOM4",589,0)
 ;@stanza 2 ?
"RTN","SAMIHOM4",590,0)
 ;
"RTN","SAMIHOM4",591,0)
 new gtop,gbot
"RTN","SAMIHOM4",592,0)
 do htmltb2^%yottaweb(.gtop,.gbot,"SAMI Test Patients")
"RTN","SAMIHOM4",593,0)
 ;
"RTN","SAMIHOM4",594,0)
 new html,ary,hpat
"RTN","SAMIHOM4",595,0)
 do PATLIST^SAMIHOM3("hpat")
"RTN","SAMIHOM4",596,0)
 quit:'$data(hpat)
"RTN","SAMIHOM4",597,0)
 ;
"RTN","SAMIHOM4",598,0)
 set ary("title")="SAMI Test Patients on this system"
"RTN","SAMIHOM4",599,0)
 set ary("header",1)="StudyId"
"RTN","SAMIHOM4",600,0)
 set ary("header",2)="Name"
"RTN","SAMIHOM4",601,0)
 ;
"RTN","SAMIHOM4",602,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",603,0)
 new zi set zi=""
"RTN","SAMIHOM4",604,0)
 for  set zi=$order(hpat(zi)) quit:zi=""  do  ;
"RTN","SAMIHOM4",605,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",606,0)
 . new url set url="<a href=""/cform.cgi?studyId="_zi_""">"_zi_"</a>"
"RTN","SAMIHOM4",607,0)
 . set ary(cnt,1)=url
"RTN","SAMIHOM4",608,0)
 . set ary(cnt,2)=""
"RTN","SAMIHOM4",609,0)
 . quit
"RTN","SAMIHOM4",610,0)
 ;
"RTN","SAMIHOM4",611,0)
 do genhtml^%yottautl("html","ary")
"RTN","SAMIHOM4",612,0)
 ;
"RTN","SAMIHOM4",613,0)
 do addary^%yottautl("SAMIRTN","gtop")
"RTN","SAMIHOM4",614,0)
 do addary^%yottautl("SAMIRTN","html")
"RTN","SAMIHOM4",615,0)
 set SAMIRTN($order(SAMIRTN(""),-1)+1)=gbot
"RTN","SAMIHOM4",616,0)
 kill SAMIRTN(0)
"RTN","SAMIHOM4",617,0)
 ;
"RTN","SAMIHOM4",618,0)
 set HTTPRSP("mime")="text/html"
"RTN","SAMIHOM4",619,0)
 ;
"RTN","SAMIHOM4",620,0)
 ;@stanza ? termination
"RTN","SAMIHOM4",621,0)
 ;
"RTN","SAMIHOM4",622,0)
 quit  ; end of DEVHOME
"RTN","SAMIHOM4",623,0)
 ;
"RTN","SAMIHOM4",624,0)
 ;
"RTN","SAMIHOM4",625,0)
GETHOME ; homepage accessed using GET
"RTN","SAMIHOM4",626,0)
 ; GETHOME^SAMIHOM3(SAMIRTN,SAMIFILTER) goto GETHOME^SAMIHOM4
"RTN","SAMIHOM4",627,0)
 ;
"RTN","SAMIHOM4",628,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",629,0)
 ;
"RTN","SAMIHOM4",630,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",631,0)
 ;@called-by
"RTN","SAMIHOM4",632,0)
 ; WSHOME
"RTN","SAMIHOM4",633,0)
 ; WSNEWCAS
"RTN","SAMIHOM4",634,0)
 ; WSNFPOST^SAMICASE
"RTN","SAMIHOM4",635,0)
 ; wsLookup^SAMISRCH
"RTN","SAMIHOM4",636,0)
 ;@calls
"RTN","SAMIHOM4",637,0)
 ; GETTMPL^SAMICASE
"RTN","SAMIHOM4",638,0)
 ; findReplace^%ts
"RTN","SAMIHOM4",639,0)
 ; $$SCANFOR
"RTN","SAMIHOM4",640,0)
 ; ADDCRLF^VPRJRUT
"RTN","SAMIHOM4",641,0)
 ;@input
"RTN","SAMIHOM4",642,0)
 ; SAMIFILTER =
"RTN","SAMIHOM4",643,0)
 ;@output
"RTN","SAMIHOM4",644,0)
 ;.SAMIRTN =
"RTN","SAMIHOM4",645,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",646,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",647,0)
 ;
"RTN","SAMIHOM4",648,0)
 ;@stanza 2 get template for homepage
"RTN","SAMIHOM4",649,0)
 ;
"RTN","SAMIHOM4",650,0)
 new temp,tout
"RTN","SAMIHOM4",651,0)
 do GETTMPL^SAMICASE("temp","vapals:home")
"RTN","SAMIHOM4",652,0)
 quit:'$data(temp)
"RTN","SAMIHOM4",653,0)
 ;
"RTN","SAMIHOM4",654,0)
 ;@stanza 3 process homepage template
"RTN","SAMIHOM4",655,0)
 ;
"RTN","SAMIHOM4",656,0)
 new cnt set cnt=0
"RTN","SAMIHOM4",657,0)
 new zi set zi=0
"RTN","SAMIHOM4",658,0)
 for  set zi=$order(temp(zi)) quit:+zi=0  do  ;
"RTN","SAMIHOM4",659,0)
 . ;
"RTN","SAMIHOM4",660,0)
 . n ln s ln=temp(zi)
"RTN","SAMIHOM4",661,0)
 . n touched s touched=0
"RTN","SAMIHOM4",662,0)
 . ;
"RTN","SAMIHOM4",663,0)
 . i ln["href" i 'touched d  ;
"RTN","SAMIHOM4",664,0)
 . . d FIXHREF^SAMIFORM(.ln)
"RTN","SAMIHOM4",665,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",666,0)
 . ;
"RTN","SAMIHOM4",667,0)
 . i ln["src" d  ;
"RTN","SAMIHOM4",668,0)
 . . d FIXSRC^SAMIFORM(.ln)
"RTN","SAMIHOM4",669,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",670,0)
 . ;
"RTN","SAMIHOM4",671,0)
 . i ln["id" i ln["studyIdMenu" d  ;
"RTN","SAMIHOM4",672,0)
 . . s zi=zi+4
"RTN","SAMIHOM4",673,0)
 . ;
"RTN","SAMIHOM4",674,0)
 . if ln["@@MANUALREGISTRATION@@" do  ; turn off manual registration
"RTN","SAMIHOM4",675,0)
 . . n setman,setparm
"RTN","SAMIHOM4",676,0)
 . . s setman="true"
"RTN","SAMIHOM4",677,0)
 . . s setparm=$$GET^XPAR("SYS","SAMI ALLOW MANUAL ENTRY",,"Q")
"RTN","SAMIHOM4",678,0)
 . . i setparm=0 s setman="false"
"RTN","SAMIHOM4",679,0)
 . . do findReplace^%ts(.ln,"@@MANUALREGISTRATION@@",setman)
"RTN","SAMIHOM4",680,0)
 . . s temp(zi)=ln
"RTN","SAMIHOM4",681,0)
 . . quit 
"RTN","SAMIHOM4",682,0)
 . set cnt=cnt+1
"RTN","SAMIHOM4",683,0)
 . set tout(cnt)=temp(zi)
"RTN","SAMIHOM4",684,0)
 . quit
"RTN","SAMIHOM4",685,0)
 ;
"RTN","SAMIHOM4",686,0)
 ;@stanza 4 add cr/lf & save to return array
"RTN","SAMIHOM4",687,0)
 ;
"RTN","SAMIHOM4",688,0)
 do ADDCRLF^VPRJRUT(.tout)
"RTN","SAMIHOM4",689,0)
 merge SAMIRTN=tout
"RTN","SAMIHOM4",690,0)
 ;
"RTN","SAMIHOM4",691,0)
 ;@stanza 5 termination
"RTN","SAMIHOM4",692,0)
 ;
"RTN","SAMIHOM4",693,0)
 quit  ; end of GETHOME
"RTN","SAMIHOM4",694,0)
 ;
"RTN","SAMIHOM4",695,0)
 ;
"RTN","SAMIHOM4",696,0)
WSNEWCAS ; receives post from home & creates new case
"RTN","SAMIHOM4",697,0)
 ; WSNEWCAS^SAMIHOM3(SAMIARGS,SAMIBODY,SAMIRESULT) goto WSNEWCAS^SAMIHOM4
"RTN","SAMIHOM4",698,0)
 ;
"RTN","SAMIHOM4",699,0)
 ;@stanza 1 invocation, binding, & branching
"RTN","SAMIHOM4",700,0)
 ;
"RTN","SAMIHOM4",701,0)
 ;ven/gpl;private;procedure;
"RTN","SAMIHOM4",702,0)
 ;@called-by
"RTN","SAMIHOM4",703,0)
 ;@calls
"RTN","SAMIHOM4",704,0)
 ; parseBody^%wf
"RTN","SAMIHOM4",705,0)
 ; $$setroot^%wd
"RTN","SAMIHOM4",706,0)
 ; $$NEXTNUM
"RTN","SAMIHOM4",707,0)
 ; $$GENSTDID^SAMIHOM3
"RTN","SAMIHOM4",708,0)
 ; $$NOW^XLFDT
"RTN","SAMIHOM4",709,0)
 ; $$KEYDATE^SAMIHOM3
"RTN","SAMIHOM4",710,0)
 ; $$VALDTNM
"RTN","SAMIHOM4",711,0)
 ; GETHOME
"RTN","SAMIHOM4",712,0)
 ; PREFILL
"RTN","SAMIHOM4",713,0)
 ; MKSBFORM
"RTN","SAMIHOM4",714,0)
 ; MKSIFORM^SAMIHOM3
"RTN","SAMIHOM4",715,0)
 ; WSCASE^SAMICASE
"RTN","SAMIHOM4",716,0)
 ;@input
"RTN","SAMIHOM4",717,0)
 ;.ARGS =
"RTN","SAMIHOM4",718,0)
 ; BODY =
"RTN","SAMIHOM4",719,0)
 ;.RESULT =
"RTN","SAMIHOM4",720,0)
 ;@output: ?
"RTN","SAMIHOM4",721,0)
 ;@examples [tbd]
"RTN","SAMIHOM4",722,0)
 ;@tests [tbd]
"RTN","SAMIHOM4",723,0)
 ;
"RTN","SAMIHOM4",724,0)
 ;@stanza 2 ?
"RTN","SAMIHOM4",725,0)
 ;
"RTN","SAMIHOM4",726,0)
 merge ^SAMIUL("newCase","ARGS")=SAMIARGS
"RTN","SAMIHOM4",727,0)
 merge ^SAMIUL("newCase","BODY")=SAMIBODY
"RTN","SAMIHOM4",728,0)
 ;
"RTN","SAMIHOM4",729,0)
 new vars,bdy
"RTN","SAMIHOM4",730,0)
 set SAMIBDY=$get(SAMIBODY(1))
"RTN","SAMIHOM4",731,0)
 do parseBody^%wf("vars",.SAMIBDY)
"RTN","SAMIHOM4",732,0)
 merge ^SAMIUL("newCase","vars")=vars
"RTN","SAMIHOM4",733,0)
 ;
"RTN","SAMIHOM4",734,0)
 new root set root=$$setroot^%wd("vapals-patients")
"RTN","SAMIHOM4",735,0)
 ;
"RTN","SAMIHOM4",736,0)
 new saminame set saminame=$get(vars("name"))
"RTN","SAMIHOM4",737,0)
 if saminame="" s saminame=$get(vars("saminame"))
"RTN","SAMIHOM4",738,0)
 ;if $$VALDTNM(saminame,.ARGS)=-1 do  quit  ;
"RTN","SAMIHOM4",739,0)
 ;. new r1
"RTN","SAMIHOM4",740,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",741,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",742,0)
 ;. quit
"RTN","SAMIHOM4",743,0)
 ;
"RTN","SAMIHOM4",744,0)
 new dfn s dfn=$get(vars("dfn"))
"RTN","SAMIHOM4",745,0)
 ;if dfn="" do  quit  ;
"RTN","SAMIHOM4",746,0)
 ;. new r1
"RTN","SAMIHOM4",747,0)
 ;. do GETHOME(.r1,.ARGS) ; home page to redisplay
"RTN","SAMIHOM4",748,0)
 ;. merge RESULT=r1
"RTN","SAMIHOM4",749,0)
 ;. quit
"RTN","SAMIHOM4",750,0)
 ;
"RTN","SAMIHOM4",751,0)
 ;new gien set gien=$$NEXTNUM
"RTN","SAMIHOM4",752,0)
 new gien set gien=dfn
"RTN","SAMIHOM4",753,0)
 ;
"RTN","SAMIHOM4",754,0)
 m ^SAMIUL("newCase","G1")=root
"RTN","SAMIHOM4",755,0)
 ; create dfn index
"RTN","SAMIHOM4",756,0)
 set @root@("dfn",dfn,gien)=""
"RTN","SAMIHOM4",757,0)
 ;
"RTN","SAMIHOM4",758,0)
 set @root@(gien,"saminum")=gien
"RTN","SAMIHOM4",759,0)
 set @root@(gien,"saminame")=saminame
"RTN","SAMIHOM4",760,0)
 ;
"RTN","SAMIHOM4",761,0)
 new studyid set studyid=$$GENSTDID^SAMIHOM3(gien)
"RTN","SAMIHOM4",762,0)
 set @root@(gien,"samistudyid")=studyid
"RTN","SAMIHOM4",763,0)
 set @root@("sid",studyid,gien)=""
"RTN","SAMIHOM4",764,0)
 ;
"RTN","SAMIHOM4",765,0)
 new datekey set datekey=$$KEYDATE^SAMIHOM3($$NOW^XLFDT)
"RTN","SAMIHOM4",766,0)
 set @root@(gien,"samicreatedate")=datekey
"RTN","SAMIHOM4",767,0)
 ;
"RTN","SAMIHOM4",768,0)
 merge ^SAMIUL("newCase",gien)=@root@(gien)
"RTN","SAMIHOM4",769,0)
 ;
"RTN","SAMIHOM4",770,0)
 ;
"RTN","SAMIHOM4",771,0)
 do PREFILL^SAMIHOM3(dfn) ; prefills from the "patient-lookup" graph
"RTN","SAMIHOM4",772,0)
 ;
"RTN","SAMIHOM4",773,0)
 n siformkey
"RTN","SAMIHOM4",774,0)
 ;do makeSbform(gien) ; create a background form for new patient
"RTN","SAMIHOM4",775,0)
 set siformkey=$$MKSIFORM^SAMIHOM3(gien) ; create an intake for for new patient
"RTN","SAMIHOM4",776,0)
 ;
"RTN","SAMIHOM4",777,0)
 set SAMIARGS("studyid")=studyid
"RTN","SAMIHOM4",778,0)
 set SAMIARGS("form")="vapals:"_siformkey
"RTN","SAMIHOM4",779,0)
 do wsGetForm^%wf(.SAMIRESULT,.SAMIARGS)
"RTN","SAMIHOM4",780,0)
 ;do WSCASE^SAMICASE(.SAMIRESULT,.SAMIARGS) ; navigate to the case review page
"RTN","SAMIHOM4",781,0)
 ;
"RTN","SAMIHOM4",782,0)
 ;@stanza ? termination
"RTN","SAMIHOM4",783,0)
 ;
"RTN","SAMIHOM4",784,0)
 quit  ; end of WSNEWCAS
"RTN","SAMIHOM4",785,0)
 ;
"RTN","SAMIHOM4",786,0)
 ;
"RTN","SAMIHOM4",787,0)
EOR ; End of routine SAMIHOM4
"RTN","SAMINOT3")
0^1^B48541042
"RTN","SAMINOT3",1,0)
SAMINOT3 ;ven/gpl - CTeval report plain text ; 5/7/19 4:48pm
"RTN","SAMINOT3",2,0)
 ;;18.0;SAMI;;;Build 2
"RTN","SAMINOT3",3,0)
 ;
"RTN","SAMINOT3",4,0)
 ;@license: see routine SAMIUL
"RTN","SAMINOT3",5,0)
 ;
"RTN","SAMINOT3",6,0)
 quit  ; no entry from top
"RTN","SAMINOT3",7,0)
 ;
"RTN","SAMINOT3",8,0)
WSNOTE(return,filter) ; web service which returns a text note
"RTN","SAMINOT3",9,0)
 ;
"RTN","SAMINOT3",10,0)
 n debug s debug=0
"RTN","SAMINOT3",11,0)
 i $g(filter("debug"))=1 s debug=1
"RTN","SAMINOT3",12,0)
 ;
"RTN","SAMINOT3",13,0)
 k return
"RTN","SAMINOT3",14,0)
 s HTTPRSP("mime")="text/html"
"RTN","SAMINOT3",15,0)
 ;
"RTN","SAMINOT3",16,0)
 n si
"RTN","SAMINOT3",17,0)
 s si=$g(filter("studyid"))
"RTN","SAMINOT3",18,0)
 i si="" d  ;
"RTN","SAMINOT3",19,0)
 . s si="XXX00333"
"RTN","SAMINOT3",20,0)
 q:si=""
"RTN","SAMINOT3",21,0)
 ;
"RTN","SAMINOT3",22,0)
 n samikey
"RTN","SAMINOT3",23,0)
 s samikey=$g(filter("form"))
"RTN","SAMINOT3",24,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT3",25,0)
 ;
"RTN","SAMINOT3",26,0)
 n vals
"RTN","SAMINOT3",27,0)
 m vals=@root@("graph",si,samikey)
"RTN","SAMINOT3",28,0)
 ;
"RTN","SAMINOT3",29,0)
 n notebase
"RTN","SAMINOT3",30,0)
 d WSREPORT^SAMICTT0(.notebase,.filter)
"RTN","SAMINOT3",31,0)
 s note="notebase"
"RTN","SAMINOT3",32,0)
 i '$d(@note) q
"RTN","SAMINOT3",33,0)
 ;
"RTN","SAMINOT3",34,0)
 new temp,tout
"RTN","SAMINOT3",35,0)
 do GETTMPL^SAMICASE("temp","vapals:note")
"RTN","SAMINOT3",36,0)
 quit:'$data(temp)
"RTN","SAMINOT3",37,0)
 ;
"RTN","SAMINOT3",38,0)
 n cnt s cnt=0
"RTN","SAMINOT3",39,0)
 n zi s zi=""
"RTN","SAMINOT3",40,0)
 ;
"RTN","SAMINOT3",41,0)
 f  s zi=$o(temp(zi)) q:zi=""  d  ;
"RTN","SAMINOT3",42,0)
 . ;
"RTN","SAMINOT3",43,0)
 . n line s line=temp(zi)
"RTN","SAMINOT3",44,0)
 . D LOAD^SAMIFORM(.line,samikey,si,.filter,.vals)
"RTN","SAMINOT3",45,0)
 . s temp(zi)=line
"RTN","SAMINOT3",46,0)
 . ;
"RTN","SAMINOT3",47,0)
 . s cnt=cnt+1
"RTN","SAMINOT3",48,0)
 . s tout(cnt)=temp(zi)
"RTN","SAMINOT3",49,0)
 . ;
"RTN","SAMINOT3",50,0)
 . i temp(zi)["report-text" d  ;
"RTN","SAMINOT3",51,0)
 . . i temp(zi)["#" q  ;
"RTN","SAMINOT3",52,0)
 . . n zj s zj=""
"RTN","SAMINOT3",53,0)
 . . f  s zj=$o(@note@(zj)) q:zj=""  d  ;
"RTN","SAMINOT3",54,0)
 . . . s cnt=cnt+1
"RTN","SAMINOT3",55,0)
 . . . ;s tout(cnt)=@note@(zj)_"<br>"
"RTN","SAMINOT3",56,0)
 . . . s tout(cnt)=@note@(zj)_$char(13,10)
"RTN","SAMINOT3",57,0)
 m return=tout
"RTN","SAMINOT3",58,0)
 q
"RTN","SAMINOT3",59,0)
 ;
"RTN","SAMINOT3",60,0)
NOTE(filter) ; extrnisic which creates a note
"RTN","SAMINOT3",61,0)
 ; returns 1 if successful, 0 if not
"RTN","SAMINOT3",62,0)
 ;
"RTN","SAMINOT3",63,0)
 ;
"RTN","SAMINOT3",64,0)
 k ^gpl("funote")
"RTN","SAMINOT3",65,0)
 m ^gpl("funote")=filter
"RTN","SAMINOT3",66,0)
 ;q 0  ; while we are developing
"RTN","SAMINOT3",67,0)
 ;
"RTN","SAMINOT3",68,0)
 ; set up patient values
"RTN","SAMINOT3",69,0)
 ;
"RTN","SAMINOT3",70,0)
 n vals
"RTN","SAMINOT3",71,0)
 ;
"RTN","SAMINOT3",72,0)
 n si
"RTN","SAMINOT3",73,0)
 s si=$g(filter("studyid"))
"RTN","SAMINOT3",74,0)
 q:si="" 0
"RTN","SAMINOT3",75,0)
 ;
"RTN","SAMINOT3",76,0)
 n samikey
"RTN","SAMINOT3",77,0)
 s samikey=$g(filter("form"))
"RTN","SAMINOT3",78,0)
 q:samikey="" 0
"RTN","SAMINOT3",79,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT3",80,0)
 ;
"RTN","SAMINOT3",81,0)
 s vals=$na(@root@("graph",si,samikey))
"RTN","SAMINOT3",82,0)
 ;
"RTN","SAMINOT3",83,0)
 i '$d(@vals) d  q 0 ;
"RTN","SAMINOT3",84,0)
 . ;w !,"error, patient values not found"
"RTN","SAMINOT3",85,0)
 ;zwr @vals@(*)
"RTN","SAMINOT3",86,0)
 ;
"RTN","SAMINOT3",87,0)
 k ^SAMIUL("NOTE")
"RTN","SAMINOT3",88,0)
 m ^SAMIUL("NOTE","vals")=@vals
"RTN","SAMINOT3",89,0)
 m ^SAMIUL("NOTE","filter")=filter
"RTN","SAMINOT3",90,0)
 ;
"RTN","SAMINOT3",91,0)
 n didnote s didnote=0
"RTN","SAMINOT3",92,0)
 ;
"RTN","SAMINOT3",93,0)
 i $d(@vals@("notes")) d  q didnote ;
"RTN","SAMINOT3",94,0)
 . s filter("errorMessage")="Note already exists for this form."
"RTN","SAMINOT3",95,0)
 ;
"RTN","SAMINOT3",96,0)
 i $g(@vals@("futype"))="other" d  ;
"RTN","SAMINOT3",97,0)
 . i $g(@vals@("samistatus"))'="complete" q  ;
"RTN","SAMINOT3",98,0)
 . ;q:$$HASVCNT(vals)
"RTN","SAMINOT3",99,0)
 . d MKVC(si,samikey,vals,.filter) ;
"RTN","SAMINOT3",100,0)
 . s didnote=1
"RTN","SAMINOT3",101,0)
 ;
"RTN","SAMINOT3",102,0)
 i $g(@vals@("futype"))="ct" d  ;
"RTN","SAMINOT3",103,0)
 . i $g(@vals@("samistatus"))'="complete" q  ;
"RTN","SAMINOT3",104,0)
 . ;q:$$HASLCSNT(vals)
"RTN","SAMINOT3",105,0)
 . d MKLCS(si,samikey,vals,.filter) ;
"RTN","SAMINOT3",106,0)
 . s didnote=1
"RTN","SAMINOT3",107,0)
 ;
"RTN","SAMINOT3",108,0)
 ;i $g(@vals@("samistatus"))="complete" d  ;
"RTN","SAMINOT3",109,0)
 ;. q:$$HASVCNT(vals)
"RTN","SAMINOT3",110,0)
 ;. d MKVC(si,samikey,vals,.filter) ;
"RTN","SAMINOT3",111,0)
 ;. s didnote=1
"RTN","SAMINOT3",112,0)
 ;
"RTN","SAMINOT3",113,0)
 q didnote
"RTN","SAMINOT3",114,0)
 ;
"RTN","SAMINOT3",115,0)
HASINNT(vals) ; extrinsic returns 1 if intake note is present
"RTN","SAMINOT3",116,0)
 ; else returns 0
"RTN","SAMINOT3",117,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT3",118,0)
 q:'$d(@vals)
"RTN","SAMINOT3",119,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT3",120,0)
 . i $g(@vals@("notes",zzi,"name"))["Intake" s zzrtn=1
"RTN","SAMINOT3",121,0)
 q zzrtn
"RTN","SAMINOT3",122,0)
 ;
"RTN","SAMINOT3",123,0)
HASVCNT(vals) ; extrinsic returns 1 if communication note is present
"RTN","SAMINOT3",124,0)
 ; else returns 0
"RTN","SAMINOT3",125,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT3",126,0)
 q:'$d(@vals)
"RTN","SAMINOT3",127,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT3",128,0)
 . i $g(@vals@("notes",zzi,"name"))["Communication" s zzrtn=1
"RTN","SAMINOT3",129,0)
 q zzrtn
"RTN","SAMINOT3",130,0)
 ;
"RTN","SAMINOT3",131,0)
HASLCSNT(vals) ; extrinsic returns 1 if communication note is present
"RTN","SAMINOT3",132,0)
 ; else returns 0
"RTN","SAMINOT3",133,0)
 n zzi,zzrtn s (zzi,zzrtn)=0
"RTN","SAMINOT3",134,0)
 q:'$d(@vals)
"RTN","SAMINOT3",135,0)
 f  s zzi=$o(@vals@("notes",zzi)) q:+zzi=0  d  ;
"RTN","SAMINOT3",136,0)
 . i $g(@vals@("notes",zzi,"name"))["Lung" s zzrtn=1
"RTN","SAMINOT3",137,0)
 q zzrtn
"RTN","SAMINOT3",138,0)
 ;
"RTN","SAMINOT3",139,0)
MKVC(sid,form,vals,filter) ;
"RTN","SAMINOT3",140,0)
 n cnt s cnt=0
"RTN","SAMINOT3",141,0)
 ;n dest s dest=$na(@vals@("communication-note"))
"RTN","SAMINOT3",142,0)
 n dest s dest=$$MKNT(vals,"Communication Note","communication",.filter)
"RTN","SAMINOT3",143,0)
 k @dest
"RTN","SAMINOT3",144,0)
 d OUT("Veteran Communication Note")
"RTN","SAMINOT3",145,0)
 d OUT("")
"RTN","SAMINOT3",146,0)
 d VCNOTE(vals,dest,cnt)
"RTN","SAMINOT3",147,0)
 q
"RTN","SAMINOT3",148,0)
 ;
"RTN","SAMINOT3",149,0)
MKLCS(sid,form,vals,filter) ;
"RTN","SAMINOT3",150,0)
 n cnt s cnt=0
"RTN","SAMINOT3",151,0)
 ;n dest s dest=$na(@vals@("lcs-note"))
"RTN","SAMINOT3",152,0)
 n dest s dest=$$MKNT(vals,"Lung Cancer Screening Note","lcs",.filter)
"RTN","SAMINOT3",153,0)
 k @dest
"RTN","SAMINOT3",154,0)
 d OUT("Lung Screening and Surveillance Follow up Note")
"RTN","SAMINOT3",155,0)
 d OUT("")
"RTN","SAMINOT3",156,0)
 d LCSNOTE(vals,dest,cnt)
"RTN","SAMINOT3",157,0)
 q
"RTN","SAMINOT3",158,0)
 ;
"RTN","SAMINOT3",159,0)
MKNT(vals,title,ntype,filter) ; extrinsic makes a note date=now returns 
"RTN","SAMINOT3",160,0)
 ; global addr. filter must be passed by reference
"RTN","SAMINOT3",161,0)
 n ntdt s ntdt=$$NTDTTM($$NOW^XLFDT)
"RTN","SAMINOT3",162,0)
 n ntptr
"RTN","SAMINOT3",163,0)
 s ntptr=$$MKNTLOC(vals,title,ntdt,$g(ntype),.filter)
"RTN","SAMINOT3",164,0)
 q ntptr
"RTN","SAMINOT3",165,0)
 ;
"RTN","SAMINOT3",166,0)
MKNTLOC(vals,title,ndate,ntype,filter) ; extrinsic returns the 
"RTN","SAMINOT3",167,0)
 ;location for the note
"RTN","SAMINOT3",168,0)
 n nien
"RTN","SAMINOT3",169,0)
 s nien=$o(@vals@("notes",""),-1)+1
"RTN","SAMINOT3",170,0)
 s filter("nien")=nien
"RTN","SAMINOT3",171,0)
 n nloc s nloc=$na(@vals@("notes",nien))
"RTN","SAMINOT3",172,0)
 s @nloc@("name")=title_" "_$g(ndate)
"RTN","SAMINOT3",173,0)
 s @nloc@("date")=$g(ndate)
"RTN","SAMINOT3",174,0)
 s @nloc@("type")=$g(ntype)
"RTN","SAMINOT3",175,0)
 q $na(@nloc@("text"))
"RTN","SAMINOT3",176,0)
 ;
"RTN","SAMINOT3",177,0)
NTDTTM(ZFMDT) ; extrinsic returns the date and time in Note format
"RTN","SAMINOT3",178,0)
 ; ZFMDT is the fileman date/time to translate
"RTN","SAMINOT3",179,0)
 q $$FMTE^XLFDT(ZFMDT,"5")
"RTN","SAMINOT3",180,0)
 ;
"RTN","SAMINOT3",181,0)
NTLOCN(sid,form,nien) ; extrinsic returns the location of the Nth note
"RTN","SAMINOT3",182,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT3",183,0)
 q $na(@root@("graph",sid,form,"notes",nien))
"RTN","SAMINOT3",184,0)
 ;
"RTN","SAMINOT3",185,0)
NTLAST(sid,form,ntype) ; extrinsic returns the location of the latest note
"RTN","SAMINOT3",186,0)
 ; of the type ntype
"RTN","SAMINOT3",187,0)
 q
"RTN","SAMINOT3",188,0)
 ;
"RTN","SAMINOT3",189,0)
NTLIST(nlist,sid,form) ; returns the note list in nlist, passed by ref
"RTN","SAMINOT3",190,0)
 ;
"RTN","SAMINOT3",191,0)
 n zn,root,gn
"RTN","SAMINOT3",192,0)
 s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT3",193,0)
 s zn=0
"RTN","SAMINOT3",194,0)
 s gn=$na(@root@("graph",sid,form,"notes"))
"RTN","SAMINOT3",195,0)
 q:'$d(@gn)
"RTN","SAMINOT3",196,0)
 f  s zn=$o(@gn@(zn)) q:+zn=0  d  ;
"RTN","SAMINOT3",197,0)
 . s @nlist@(zn,"name")=@gn@(zn,"name")
"RTN","SAMINOT3",198,0)
 . s @nlist@(zn,"nien")=zn
"RTN","SAMINOT3",199,0)
 ;
"RTN","SAMINOT3",200,0)
 q
"RTN","SAMINOT3",201,0)
 ;
"RTN","SAMINOT3",202,0)
TLST ;
"RTN","SAMINOT3",203,0)
 S SID="XXX00677"
"RTN","SAMINOT3",204,0)
 S FORM="siform-2019-04-23"
"RTN","SAMINOT3",205,0)
 D NTLIST("G",SID,FORM)
"RTN","SAMINOT3",206,0)
 ;ZWR G
"RTN","SAMINOT3",207,0)
 Q
"RTN","SAMINOT3",208,0)
 ;
"RTN","SAMINOT3",209,0)
VCNOTE(vals,dest,cnt) ; Veteran Communication Note
"RTN","SAMINOT3",210,0)
 ;d OUT("")
"RTN","SAMINOT3",211,0)
 d OUT("Veteran was contacted via:")
"RTN","SAMINOT3",212,0)
 n sp1 s sp1="    "
"RTN","SAMINOT3",213,0)
 d:$$XVAL("fucmotip",vals) OUT(sp1_"In person")
"RTN","SAMINOT3",214,0)
 d:$$XVAL("fucmotte",vals) OUT(sp1_"Telephone")
"RTN","SAMINOT3",215,0)
 d:$$XVAL("fucmotth",vals) OUT(sp1_"TeleHealth")
"RTN","SAMINOT3",216,0)
 d:$$XVAL("fucmotml",vals) OUT(sp1_"Mailed Letter")
"RTN","SAMINOT3",217,0)
 d:$$XVAL("fucmotpp",vals) OUT(sp1_"Message in patient portal")
"RTN","SAMINOT3",218,0)
 d:$$XVAL("fucmotvd",vals) OUT(sp1_"Video-on-demand (VOD)")
"RTN","SAMINOT3",219,0)
 d:$$XVAL("fucmotot",vals) OUT(sp1_"Other: "_$$XVAL("fucmotoo",vals))
"RTN","SAMINOT3",220,0)
 d OUT("")
"RTN","SAMINOT3",221,0)
 ;
"RTN","SAMINOT3",222,0)
 d:$$XVAL("fucmotde",vals)'=""
"RTN","SAMINOT3",223,0)
 . d OUT("Communication details:")
"RTN","SAMINOT3",224,0)
 . d OUT(sp1_$$XVAL("fucmotde",vals))
"RTN","SAMINOT3",225,0)
 ;
"RTN","SAMINOT3",226,0)
 d SSTATUS(vals) ; insert smoking status section
"RTN","SAMINOT3",227,0)
 q
"RTN","SAMINOT3",228,0)
 ;
"RTN","SAMINOT3",229,0)
SSTATUS(vals)
"RTN","SAMINOT3",230,0)
 n sstat s sstat=""
"RTN","SAMINOT3",231,0)
 i $$XVAL("sisa",vals)="y" d  ; 
"RTN","SAMINOT3",232,0)
 . s sstat="Current"
"RTN","SAMINOT3",233,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT3",234,0)
 . d OUT(sp1_"Current cigarette smoker (patient advised that active tobacco use")
"RTN","SAMINOT3",235,0)
 . d OUT(sp1_"increases risk of future lung cancer, heart disease and stroke,")
"RTN","SAMINOT3",236,0)
 . d OUT(sp1_"advised stability now does not guarantee will not develop future")
"RTN","SAMINOT3",237,0)
 . d OUT(sp1_"lung cancer or risks of premature death from tobacco related heart")
"RTN","SAMINOT3",238,0)
 . d OUT(sp1_"disease and stroke)")
"RTN","SAMINOT3",239,0)
 i $$XVAL("sisa",vals)="n" d  ;
"RTN","SAMINOT3",240,0)
 . s sstat="Former"
"RTN","SAMINOT3",241,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT3",242,0)
 . n qdate s qdate=""
"RTN","SAMINOT3",243,0)
 . s qdate=$$XVAL("siq",vals)
"RTN","SAMINOT3",244,0)
 . i qdate'="" d OUT(sp1_"Former cigarette smoker. Quit date: "_qdate)
"RTN","SAMINOT3",245,0)
 . e  d OUT(sp1_"Former cigarette smoker.")
"RTN","SAMINOT3",246,0)
 i $$XVAL("sisa",vals)="o" d  ;
"RTN","SAMINOT3",247,0)
 . s sstat="Never"
"RTN","SAMINOT3",248,0)
 . d OUT("Smoking status: "_sstat)
"RTN","SAMINOT3",249,0)
 . d OUT(sp1_"Never cigarette smoker")
"RTN","SAMINOT3",250,0)
 ;
"RTN","SAMINOT3",251,0)
 n cumary
"RTN","SAMINOT3",252,0)
 d CUMPY^SAMIUR2("cumary",sid,form)
"RTN","SAMINOT3",253,0)
 k ^gpl("funote","cumary")
"RTN","SAMINOT3",254,0)
 m ^gpl("funote","cumary")=cumary
"RTN","SAMINOT3",255,0)
 n cur s cur=$g(cumary("current"))
"RTN","SAMINOT3",256,0)
 n newcum s newcum=$g(cumary("rpt",cur,4)) ; new cumulative pack years
"RTN","SAMINOT3",257,0)
 ;
"RTN","SAMINOT3",258,0)
 i $$XVAL("sisa",vals)="y" d  ;  
"RTN","SAMINOT3",259,0)
 . d OUT("Smoking history (since last visit):")
"RTN","SAMINOT3",260,0)
 . d OUT(sp1_"Cigarettes/day: "_$$XVAL("sicpd",vals))
"RTN","SAMINOT3",261,0)
 . d OUT(sp1_"PPD: "_$$XVAL("sippd",vals))
"RTN","SAMINOT3",262,0)
 . d OUT(sp1_"Current cumulative pack years: "_newcum)
"RTN","SAMINOT3",263,0)
 i $$XVAL("sisa",vals)'="y" d  ;  
"RTN","SAMINOT3",264,0)
 . d OUT("Smoking History") 
"RTN","SAMINOT3",265,0)
 n zi
"RTN","SAMINOT3",266,0)
 f zi=1:1:cur d  ;
"RTN","SAMINOT3",267,0)
 . d OUT(sp1_cumary("rpt",zi,1)_" "_cumary("rpt",zi,2))
"RTN","SAMINOT3",268,0)
 . d OUT(sp1_sp1_"Pack Years: "_cumary("rpt",zi,3))
"RTN","SAMINOT3",269,0)
 . d OUT(sp1_sp1_"Cumulative: "_cumary("rpt",zi,4))
"RTN","SAMINOT3",270,0)
 ;
"RTN","SAMINOT3",271,0)
 n tried s tried=$$XVAL("sittq",vals)
"RTN","SAMINOT3",272,0)
 n ptried s ptried=$s(tried="y":"Yes",tried="n":"No",tried="o":"Not applicable",1:"")
"RTN","SAMINOT3",273,0)
 i ptried'="" d OUT("Since your prior CT scan have you ever tried to quit smoking? "_ptried)
"RTN","SAMINOT3",274,0)
 ;
"RTN","SAMINOT3",275,0)
 n tryary,cnt
"RTN","SAMINOT3",276,0)
 s cnt=0
"RTN","SAMINOT3",277,0)
 i $$XVAL("sisca",vals)'="" s cnt=cnt+1 s tryary(cnt)="Have not tried to quit"
"RTN","SAMINOT3",278,0)
 i $$XVAL("siscb",vals)'="" s cnt=cnt+1 s tryary(cnt)="""Cold Turkey"" by completely stopping on your own with no other assistance"
"RTN","SAMINOT3",279,0)
 i $$XVAL("siscc",vals)'="" s cnt=cnt+1 s tryary(cnt)="Tapering or reducing number of cigarettes smoked per day"
"RTN","SAMINOT3",280,0)
 i $$XVAL("siscd",vals)'="" s cnt=cnt+1 s tryary(cnt)="Self-help material (e.g., brochure, cessation website)"
"RTN","SAMINOT3",281,0)
 i $$XVAL("sisce",vals)'="" s cnt=cnt+1 s tryary(cnt)="Individual consultation or cessation counseling"
"RTN","SAMINOT3",282,0)
 i $$XVAL("siscf",vals)'="" s cnt=cnt+1 s tryary(cnt)="Telephone cessation counseling hotline (e.g., 1-855-QUIT-VET, 1-800-QUIT-NOW)"
"RTN","SAMINOT3",283,0)
 i $$XVAL("siscg",vals)'="" s cnt=cnt+1 s tryary(cnt)="Peer support (e.g., Nicotine Anonymous)"
"RTN","SAMINOT3",284,0)
 i $$XVAL("sisch",vals)'="" s cnt=cnt+1 s tryary(cnt)="Nicotine replacement therapy (e.g., patch, gum, inhaler, nasal spray, lozenge)"
"RTN","SAMINOT3",285,0)
 i $$XVAL("sisci",vals)'="" s cnt=cnt+1 s tryary(cnt)="Zyban"
"RTN","SAMINOT3",286,0)
 i $$XVAL("siscj",vals)'="" s cnt=cnt+1 s tryary(cnt)="Hypnosis"
"RTN","SAMINOT3",287,0)
 i $$XVAL("sisck",vals)'="" s cnt=cnt+1 s tryary(cnt)="Acupuncture / acupressure"
"RTN","SAMINOT3",288,0)
 n tryot s tryot=""
"RTN","SAMINOT3",289,0)
 i $$XVAL("siscl",vals)'="" d  ;
"RTN","SAMINOT3",290,0)
 . s cnt=cnt+1 s tryary(cnt)="Other (specify)"
"RTN","SAMINOT3",291,0)
 . s tryot=$$XVAL("siscos",vals)
"RTN","SAMINOT3",292,0)
 ;
"RTN","SAMINOT3",293,0)
 i cnt>0 d  ;
"RTN","SAMINOT3",294,0)
 .  i ptried="" d OUT("Since your prior CT scan have you ever tried to quit smoking? ")
"RTN","SAMINOT3",295,0)
 . n zi s zi=""
"RTN","SAMINOT3",296,0)
 . f  s zi=$o(tryary(zi)) q:zi=""  d  ;
"RTN","SAMINOT3",297,0)
 . . d OUT(sp1_tryary(zi))
"RTN","SAMINOT3",298,0)
 . i tryot'="" d OUT(sp1_sp1_tryot)
"RTN","SAMINOT3",299,0)
 ;
"RTN","SAMINOT3",300,0)
 n cess,cess2 s cess="" s cess2=""
"RTN","SAMINOT3",301,0)
 i $$XVAL("siscmd",vals)="d" s cess="Declined"
"RTN","SAMINOT3",302,0)
 i $$XVAL("siscmd",vals)="a" s cess="Advised to quit smoking; VA resources provided"
"RTN","SAMINOT3",303,0)
 i $$XVAL("siscmd",vals)="i" d  ;
"RTN","SAMINOT3",304,0)
 . s cess="Interested in VA tobacco cessation medication. Encouraged Veteran"
"RTN","SAMINOT3",305,0)
 . s cess2="to talk to provider or pharmacist about which medication option is best for you."
"RTN","SAMINOT3",306,0)
 i cess'="" d  ;
"RTN","SAMINOT3",307,0)
 . d OUT("Tobacco cessation provided:")
"RTN","SAMINOT3",308,0)
 . d OUT(sp1_cess)
"RTN","SAMINOT3",309,0)
 . i cess2'="" d OUT(sp1_cess2)
"RTN","SAMINOT3",310,0)
 q
"RTN","SAMINOT3",311,0)
 ;
"RTN","SAMINOT3",312,0)
LCSNOTE(vals,dest,cnt) ; Lung Screening Note
"RTN","SAMINOT3",313,0)
 ;d OUT("")
"RTN","SAMINOT3",314,0)
 n sp1 s sp1="    "
"RTN","SAMINOT3",315,0)
 d OUT("Initial LDCT/Baseline: "_$$XVAL("sidoe",vals))
"RTN","SAMINOT3",316,0)
 d OUT("Date of most recent CT/LDCT: "_$$XVAL("fulctdt",vals))
"RTN","SAMINOT3",317,0)
 d OUT(sp1_"Notification of Results: "_$$XVAL("sidof",vals))
"RTN","SAMINOT3",318,0)
 n addcmt s addcmt=$$XVAL("fucmctde",vals)
"RTN","SAMINOT3",319,0)
 i addcmt'="" d  ;
"RTN","SAMINOT3",320,0)
 . d OUT("Additional comments:")
"RTN","SAMINOT3",321,0)
 . d OUT(sp1_addcmt)
"RTN","SAMINOT3",322,0)
 n impress s impress=""
"RTN","SAMINOT3",323,0)
 n ctary
"RTN","SAMINOT3",324,0)
 d CTINFO("ctary",sid,form)
"RTN","SAMINOT3",325,0)
 s impress=$g(ctary("impression"))
"RTN","SAMINOT3",326,0)
 ; get impression from lastest CT Eval here
"RTN","SAMINOT3",327,0)
 d IMPRESS("ctary",sid)
"RTN","SAMINOT3",328,0)
 ;i impress'="" d  ;
"RTN","SAMINOT3",329,0)
 ;. d OUT("Impression:")
"RTN","SAMINOT3",330,0)
 ;. d OUT(sp1_impress)
"RTN","SAMINOT3",331,0)
 ; smoking status follows
"RTN","SAMINOT3",332,0)
 d SSTATUS(vals)
"RTN","SAMINOT3",333,0)
 ;d OUT("Veteran was contacted via:")
"RTN","SAMINOT3",334,0)
 ;n sp1 s sp1="    "
"RTN","SAMINOT3",335,0)
 ;d:$$XVAL("fucmctip",vals) OUT(sp1_"In person")
"RTN","SAMINOT3",336,0)
 ;d:$$XVAL("fucmctte",vals) OUT(sp1_"Telephone")
"RTN","SAMINOT3",337,0)
 ;d:$$XVAL("fucmctth",vals) OUT(sp1_"TeleHealth")
"RTN","SAMINOT3",338,0)
 ;d:$$XVAL("fucmctml",vals) OUT(sp1_"Mailed Letter")
"RTN","SAMINOT3",339,0)
 ;d:$$XVAL("fucmctpp",vals) OUT(sp1_"Message in patient portal")
"RTN","SAMINOT3",340,0)
 ;d:$$XVAL("fucmctvd",vals) OUT(sp1_"Video-on-demand (VOD)")
"RTN","SAMINOT3",341,0)
 ;d:$$XVAL("fucmctot",vals) OUT(sp1_"Other: "_$$XVAL("fucmctoo",vals))
"RTN","SAMINOT3",342,0)
 ;d OUT("")
"RTN","SAMINOT3",343,0)
 ;
"RTN","SAMINOT3",344,0)
 ;d:$$XVAL("fucmctde",vals)'=""
"RTN","SAMINOT3",345,0)
 ;. d OUT("Communication details:")
"RTN","SAMINOT3",346,0)
 ;. d OUT(sp1_$$XVAL("fucmctde",vals))
"RTN","SAMINOT3",347,0)
 n recom s recom=""
"RTN","SAMINOT3",348,0)
 ; get recommendations from CT eval form here
"RTN","SAMINOT3",349,0)
 s recom=$g(ctary("followup"))
"RTN","SAMINOT3",350,0)
 i recom'="" d  ;
"RTN","SAMINOT3",351,0)
 . d OUT("Recommendations:")
"RTN","SAMINOT3",352,0)
 . d OUT(sp1_recom)
"RTN","SAMINOT3",353,0)
 . i $g(ctary("followup2"))'="" d  ;
"RTN","SAMINOT3",354,0)
 . . d OUT(sp1_ctary("followup2"))
"RTN","SAMINOT3",355,0)
 . i $g(ctary("followup3"))'="" d  ;
"RTN","SAMINOT3",356,0)
 . . d OUT(sp1_ctary("followup3"))
"RTN","SAMINOT3",357,0)
 n ordered s ordered=$$XVAL("funewct",vals)
"RTN","SAMINOT3",358,0)
 i ordered'="" d  ;
"RTN","SAMINOT3",359,0)
 . s ordered=$s(ordered="y":"Yes",ordered="n":"No",1:"")
"RTN","SAMINOT3",360,0)
 . d OUT("CT/LDCT ordered: "_ordered)
"RTN","SAMINOT3",361,0)
 n pulmon s pulmon=$$XVAL("fucompul",vals)
"RTN","SAMINOT3",362,0)
 i pulmon'="" d  ;
"RTN","SAMINOT3",363,0)
 . s pulmon=$s(pulmon="y":"Yes",pulmon="n":"No",1:"")
"RTN","SAMINOT3",364,0)
 . d OUT("Communicated to Pulmonary: "_pulmon)
"RTN","SAMINOT3",365,0)
 q
"RTN","SAMINOT3",366,0)
 ;
"RTN","SAMINOT3",367,0)
OUT(ln) ;
"RTN","SAMINOT3",368,0)
 s cnt=cnt+1
"RTN","SAMINOT3",369,0)
 n lnn
"RTN","SAMINOT3",370,0)
 ;s debug=1
"RTN","SAMINOT3",371,0)
 s lnn=$o(@dest@(" "),-1)+1
"RTN","SAMINOT3",372,0)
 s @dest@(lnn)=ln
"RTN","SAMINOT3",373,0)
 ;i $g(debug)=1 d  ;
"RTN","SAMINOT3",374,0)
 ;. i ln["<" q  ; no markup
"RTN","SAMINOT3",375,0)
 ;. n zs s zs=$STACK
"RTN","SAMINOT3",376,0)
 ;. n zp s zp=$STACK(zs-2,"PLACE")
"RTN","SAMINOT3",377,0)
 ;. s @dest@(lnn)=zp_":"_ln
"RTN","SAMINOT3",378,0)
 q
"RTN","SAMINOT3",379,0)
 ;
"RTN","SAMINOT3",380,0)
XVAL(var,vals) ; extrinsic returns the patient value for var
"RTN","SAMINOT3",381,0)
 ; vals is passed by name
"RTN","SAMINOT3",382,0)
 n zr
"RTN","SAMINOT3",383,0)
 s zr=$g(@vals@(var))
"RTN","SAMINOT3",384,0)
 ;i zr="" s zr="["_var_"]"
"RTN","SAMINOT3",385,0)
 q zr
"RTN","SAMINOT3",386,0)
 ;
"RTN","SAMINOT3",387,0)
PREVCT(SID,FORM) ; extrinic returns the form key to the CT Eval form
"RTN","SAMINOT3",388,0)
 ; previous to FORM. If FORM is null, the latest CT Eval form key is returned
"RTN","SAMINOT3",389,0)
 ; FORM sensitivity is tbd.. always returns latest CTEval
"RTN","SAMINOT3",390,0)
 n gn s gn=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT3",391,0)
 n prev s prev=$o(@gn@("graph",SID,"ceform-30"),-1)
"RTN","SAMINOT3",392,0)
 q prev
"RTN","SAMINOT3",393,0)
 ;
"RTN","SAMINOT3",394,0)
CTINFO(ARY,SID,FORM) ; returns extracts from latest CT Eval form
"RTN","SAMINOT3",395,0)
 ; ARY passed by name
"RTN","SAMINOT3",396,0)
 ;
"RTN","SAMINOT3",397,0)
 n ctkey s ctkey=$$PREVCT(SID,$G(FORM))
"RTN","SAMINOT3",398,0)
 q:ctkey=""
"RTN","SAMINOT3",399,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT3",400,0)
 n ctroot s ctroot=$na(@root@("graph",SID,ctkey))
"RTN","SAMINOT3",401,0)
 ;
"RTN","SAMINOT3",402,0)
 s @ARY@("ctform")=ctkey
"RTN","SAMINOT3",403,0)
 s @ARY@("impression")=$g(@ctroot@("ceimre"))
"RTN","SAMINOT3",404,0)
 n futext
"RTN","SAMINOT3",405,0)
 s futext=$g(@ctroot@("cefuw"))
"RTN","SAMINOT3",406,0)
 n futbl
"RTN","SAMINOT3",407,0)
 s futbl("1y")="Annual repeat"
"RTN","SAMINOT3",408,0)
 s futbl("nw")="Now"
"RTN","SAMINOT3",409,0)
 s futbl("1m")="1 month"
"RTN","SAMINOT3",410,0)
 s futbl("3m")="3 months"
"RTN","SAMINOT3",411,0)
 s futbl("6m")="6 months"
"RTN","SAMINOT3",412,0)
 s futbl("os")="other"
"RTN","SAMINOT3",413,0)
 i futext'="" s futext=$g(futbl(futext))
"RTN","SAMINOT3",414,0)
 n fudate s fudate=$g(@ctroot@("cefud"))
"RTN","SAMINOT3",415,0)
; #Other followup
"RTN","SAMINOT3",416,0)
 n zfu,ofu,tofu,comma
"RTN","SAMINOT3",417,0)
 n vals s vals=ctroot
"RTN","SAMINOT3",418,0)
 s comma=0,tofu=""
"RTN","SAMINOT3",419,0)
 s ofu=""
"RTN","SAMINOT3",420,0)
 f zfu="cefuaf","cefucc","cefupe","cefufn","cefubr","cefupc","cefutb" d  ;
"RTN","SAMINOT3",421,0)
 . i $$XVAL(zfu,vals)="y" s ofu=ofu_zfu
"RTN","SAMINOT3",422,0)
 i $$XVAL("cefuo",vals)'="" s ofu=ofu_"cefuo"
"RTN","SAMINOT3",423,0)
 i ofu'="" d  ;
"RTN","SAMINOT3",424,0)
 . s tofu="Other followup: "
"RTN","SAMINOT3",425,0)
 . i ofu["cefuaf" s tofu=tofu_"Antibiotics" s comma=1
"RTN","SAMINOT3",426,0)
 . i ofu["cefucc" s tofu=tofu_$s(comma:", ",1:"")_"Diagnostic CT" s comma=1
"RTN","SAMINOT3",427,0)
 . i ofu["cefupe" s tofu=tofu_$s(comma:", ",1:"")_"PET" s comma=1
"RTN","SAMINOT3",428,0)
 . i ofu["cefufn" s tofu=tofu_$s(comma:", ",1:"")_"Percutaneous biopsy" s comma=1
"RTN","SAMINOT3",429,0)
 . i ofu["cefubr" s tofu=tofu_$s(comma:", ",1:"")_"Bronchoscopy" s comma=1
"RTN","SAMINOT3",430,0)
 . i ofu["cefupc" s tofu=tofu_$s(comma:", ",1:"")_"Pulmonary consultation" s comma=1
"RTN","SAMINOT3",431,0)
 . i ofu["cefutb" s tofu=tofu_$s(comma:", ",1:"")_"Refer to tumor board" s comma=1
"RTN","SAMINOT3",432,0)
 . i ofu["cefuo" s tofu=tofu_$s(comma:", ",1:"")_"Other:" s comma=1
"RTN","SAMINOT3",433,0)
 s @ARY@("followup")=futext_" "_fudate
"RTN","SAMINOT3",434,0)
 s @ARY@("followup2")=tofu
"RTN","SAMINOT3",435,0)
 s @ARY@("followup3")=$$XVAL("cefuoo",vals)
"RTN","SAMINOT3",436,0)
 ;
"RTN","SAMINOT3",437,0)
 q
"RTN","SAMINOT3",438,0)
 ; 
"RTN","SAMINOT3",439,0)
IMPRESS(ARY,SID) ; impressions from CTEval report
"RTN","SAMINOT3",440,0)
 n root s root=$$setroot^%wd("vapals-patients")
"RTN","SAMINOT3",441,0)
 n ctkey s ctkey=$g(@ARY@("ctform"))
"RTN","SAMINOT3",442,0)
 n vals s vals=$na(@root@("graph",SID,ctkey))
"RTN","SAMINOT3",443,0)
 n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMINOT3",444,0)
 s dict=$na(@dict@("cteval-dict"))
"RTN","SAMINOT3",445,0)
 n para s para=""
"RTN","SAMINOT3",446,0)
 n sp1 s sp1="    "
"RTN","SAMINOT3",447,0)
 ; 
"RTN","SAMINOT3",448,0)
 d OUT("Impression:")
"RTN","SAMINOT3",449,0)
 d OUT(sp1_$$XSUB("ceimn",vals,dict)_para)
"RTN","SAMINOT3",450,0)
 ;
"RTN","SAMINOT3",451,0)
 ;# Report CAC Score and Extent of Emphysema
"RTN","SAMINOT3",452,0)
 s cacval=0
"RTN","SAMINOT3",453,0)
 d  ;if $$XVAL("ceccv",vals)'="e" d  ;
"RTN","SAMINOT3",454,0)
 . set vcac=$$XVAL("cecccac",vals)
"RTN","SAMINOT3",455,0)
 . if vcac'="" d  ;
"RTN","SAMINOT3",456,0)
 . . s cacrec=""
"RTN","SAMINOT3",457,0)
 . . s cac="The Visual Coronary Artery Calcium (CAC) Score is "_vcac_". "
"RTN","SAMINOT3",458,0)
 . . s cacval=vcac
"RTN","SAMINOT3",459,0)
 . . i cacval>3 s cacrec=$g(@dict@("CAC_recommendation"))_para
"RTN","SAMINOT3",460,0)
 ;
"RTN","SAMINOT3",461,0)
 i cacval>0 d  ;
"RTN","SAMINOT3",462,0)
 . d OUT(sp1_cac_" "_cacrec_" "_para)
"RTN","SAMINOT3",463,0)
 . d  ;if $$XVAL("ceemv",vals)="e" d  ;
"RTN","SAMINOT3",464,0)
 . . if $$XVAL("ceem",vals)'="no" d  ;
"RTN","SAMINOT3",465,0)
 . . . if $$XVAL("ceem",vals)="nv" q  ;
"RTN","SAMINOT3",466,0)
 . . . d OUT(sp1_"Emphysema: "_$$XSUB("ceem",vals,dict)_"."_para)
"RTN","SAMINOT3",467,0)
 ;
"RTN","SAMINOT3",468,0)
 i $$XVAL("ceclini",vals)="y" d  ;
"RTN","SAMINOT3",469,0)
 . d OUT(sp1_$$XVAL("ceclin",vals)_"."_para)
"RTN","SAMINOT3",470,0)
 ;
"RTN","SAMINOT3",471,0)
 i $$XVAL("ceoppai",vals)="y" d  ;
"RTN","SAMINOT3",472,0)
 . d OUT(sp1_$$XVAL("ceoppa",vals)_"."_para)
"RTN","SAMINOT3",473,0)
 ;
"RTN","SAMINOT3",474,0)
 i $$XVAL("ceoppabi",vals)="y" d  ;
"RTN","SAMINOT3",475,0)
 . d OUT(sp1_$$XVAL("ceoppab",vals)_"."_para)
"RTN","SAMINOT3",476,0)
 ;
"RTN","SAMINOT3",477,0)
 i $$XVAL("cecommcai",vals)="y" d  ;
"RTN","SAMINOT3",478,0)
 . d OUT(sp1_$$XVAL("cecommca",vals)_"."_para)
"RTN","SAMINOT3",479,0)
 ;
"RTN","SAMINOT3",480,0)
 i $$XVAL("ceotabnmi",vals)="y" d  ;
"RTN","SAMINOT3",481,0)
 . d OUT(sp1_$$XVAL("ceotabnm",vals)_"."_para)
"RTN","SAMINOT3",482,0)
 ;
"RTN","SAMINOT3",483,0)
 i $$XVAL("ceobrci",vals)="y" d  ;
"RTN","SAMINOT3",484,0)
 . d OUT(sp1_$$XVAL("ceobrc",vals)_"."_para)
"RTN","SAMINOT3",485,0)
 ;
"RTN","SAMINOT3",486,0)
 i $$XVAL("ceaoabbi",vals)="y" d  ;
"RTN","SAMINOT3",487,0)
 . d OUT(sp1_$$XVAL("ceaoabb",vals)_"."_para)
"RTN","SAMINOT3",488,0)
 ;
"RTN","SAMINOT3",489,0)
 i $$XVAL("ceaoabi",vals)="y" d  ;
"RTN","SAMINOT3",490,0)
 . d OUT(sp1_$$XVAL("ceaoab",vals)_"."_para)
"RTN","SAMINOT3",491,0)
 ;
"RTN","SAMINOT3",492,0)
 ;# Impression Remarks
"RTN","SAMINOT3",493,0)
 i $$XVAL("ceimre",vals)'="" d  ;
"RTN","SAMINOT3",494,0)
 . d OUT(sp1_$$XVAL("ceimre",vals)_"."_para)
"RTN","SAMINOT3",495,0)
 q
"RTN","SAMINOT3",496,0)
 ;
"RTN","SAMINOT3",497,0)
XSUB(var,vals,dict,valdx) ; extrinsic which returns the dictionary value defined by var
"RTN","SAMINOT3",498,0)
 ; vals and dict are passed by name
"RTN","SAMINOT3",499,0)
 ; valdx is used for nodules ala cect2co with the nodule number included
"RTN","SAMINOT3",500,0)
 ;n dict s dict=$$setroot^%wd("cteval-dict")
"RTN","SAMINOT3",501,0)
 n zr,zv,zdx
"RTN","SAMINOT3",502,0)
 s zdx=$g(valdx)
"RTN","SAMINOT3",503,0)
 i zdx="" s zdx=var
"RTN","SAMINOT3",504,0)
 s zv=$g(@vals@(zdx))
"RTN","SAMINOT3",505,0)
 ;i zv="" s zr="["_var_"]" q zr
"RTN","SAMINOT3",506,0)
 i zv="" s zr="" q zr
"RTN","SAMINOT3",507,0)
 s zr=$g(@dict@(var,zv))
"RTN","SAMINOT3",508,0)
 ;i zr="" s zr="["_var_","_zv_"]"
"RTN","SAMINOT3",509,0)
 q zr
"RTN","SAMINOT3",510,0)
 ;
"VER")
8.0^22.2
**END**
**END**
