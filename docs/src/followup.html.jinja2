{% extends 'layout.jinja2' %}
{% import 'forms.jinja2' as f %}
{% block title %}{{ title | escape }}{% endblock %}

{% block body %}
    <div class="container-fluid" style="max-width:1550px">
        <h1>
            Sample, Sammy G
            <small class="text-muted" title="Study ID">ST0001</small>
        </h1>
        <h2>{{ title | escape }}
            <small class="text-muted" title="Medical Record Number">1234567890</small>
        </h2>

        <hr/>
        {% include '_messages.jinja2' %}
        <form action="{{ formPage+".html" if mockup else "/vapals" }}" method="{{ formMethod }}" class="validated"
              id="main-form">

            <input type="hidden" name="samiroute" value="postform"/>
            <input type="hidden" name="studyid" value="@@SID@@"/>
            <input type="hidden" name="site" value="@@SITE@@"/>
            <input type="hidden" name="form" value="@@FORMKEY@@"/>
            {% if site!='sinai' %}
            <div class="row">
                <div class="form-group col-sm-12" id="interaction-type">
                    <label class="required" for="sidof">This interaction is a</label>
                    {{ f.radio('futype', 'futype-other', 'other', 'Other communication', true) }}
                    {{ f.radio('futype', 'futype-ct', 'ct', 'CT visit and/or communication about CT results', true) }}
                </div>
            </div>
            {% endif %}

            <div class="row">
                <div class="form-group col-sm-3 col-md-3 col-lg-2">
                    <label class="required" for="sidof">Form date</label>
                    {{ f.datepicker("sidof", "past", true) }}
                </div>
                <div class="form-group col-sm-3 col-md-3 col-lg-2">
                    <label class="required" for="sidoe">Date of baseline CT</label>
                    {{ f.datepicker("sidoe", "past", true) }}
                </div>
                <div class="col-sm-4 col-md-3 form-group">
                    <label class="required" for="sico">Coordinator</label>
                    <input type="text" name="sico" id="sico" class="form-control" required="required"/>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-4 col-md-3">
                    <div id="sitsb-alert" class="alert alert-info" style="display: none;">
                        Time since baseline: <span id="sitsb-text">0</span> months
                    </div>
                    <input type="hidden" class="form-control" id="sitsb" name="sitsb"/>
                </div>
            </div>
            {% if site!='sinai' %}
            <div class="row">
                <div class="form-group col-sm-3 col-md-3 col-lg-2">
                    <label for="cefud">New CT follow-up date if needed</label>
                    {{ f.datepicker("cefud", "", true) }}
                </div>
            </div>
            {% endif %}

            <hr/>

            <div class="followup-ct">
                <h3>Ordering Information</h3>
                {% if site == 'sinai' %}
                    <div class="alert alert-warning">
                        Ordering information is required <strong>ONLY</strong> for Medicare/Medicaid patients.
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-md-4">
                            {{ f.floatingLabel('simeq', "Was a CT lung screening scan (CPT code G0297) ordered for this patient?", "required") }}
                        </div>
                        <div class="form-group col-sm-8">
                            <div>
                                {{ f.inlineRadioNY("simeq", false) }}
                            </div>
                        </div>
                    </div>
                    <div id="order-container" style="display:none;">
                        <div class="col-md-12">
                            <div class="panel panel-default" id="order-panel">
                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            {{ f.floatingLabel("siopfn", "Ordered by") }}
                                        </div>
                                        <div class="col-md-4 form-group">
                                            <input value="" class="form-control" id="siopfn" name="siopfn" type="text"/>
                                            <span class="help-block small">First Name</span>
                                        </div>
                                        <div class="col-md-4 form-group">
                                            <input value="" class="form-control" id="siopln" name="siopln"
                                                   title="Last name" type="text"/>
                                            <span class="help-block small">Last Name</span>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            {{ f.floatingLabel("siopnpi", "National provider ID (NPI)", "required") }}
                                        </div>
                                        <div class="col-sm-2 form-group">
                                            <input value="" class="form-control" id="siopnpi" name="siopnpi"
                                                   type="text"/>
                                        </div>
                                        <div class="col-sm-2 form-group">
                                            <a class="btn btn-default" href="#" role="button" id="npi-search">NPI
                                                Search</a>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            {{ f.floatingLabel("sidsd", "Documentation of shared decision making", "required") }}
                                        </div>
                                        <div class="col-sm-8 form-group">
                                            {{ f.inlineRadioNY("sidsd") }}
                                            <p class="help-block small">
                                                (shared decision making is required for reimbursement for G0297 exams on
                                                baseline <strong>only</strong>)
                                            </p>
                                        </div>
                                    </div>
                                    <div class="row" id="sidsdp-container">
                                        <div class="col-md-4">
                                            {{ f.floatingLabel("sidsdp", "Shared decision making performed by", "required") }}
                                        </div>
                                        <div class="col-md-8 form-group">
                                            {{ f.inlineRadio("sidsdp", "sidsdp-e", "e", "ELCAP") }}
                                            {{ f.inlineRadio("sidsdp", "sidsdp-o", "o", "Other") }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            {{ f.floatingLabel("siopss", "Reported smoking status at time of order", "required") }}
                                        </div>
                                        <div class="col-sm-8 form-group">
                                            {{ f.inlineRadio("siopss", "siopss-c", "Current") }}
                                            {{ f.inlineRadio("siopss", "siopss-f", "Former") }}
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            {{ f.floatingLabel("sioppy", "Reported pack years at time of order", "required") }}
                                        </div>
                                        <div class="col-md-2 form-group">
                                            <input value="" class="form-control" id="sioppy" name="sioppy" type="text"/>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div id="siopqy-container">
                                            <div class="col-md-4">
                                                {{ f.floatingLabel("siopqy", "Reported years since quit at time of order", "required") }}
                                            </div>
                                            <div class="col-md-2 form-group">
                                                <input value="" class="form-control" id="siopqy" name="siopqy"
                                                       type="text"/>
                                                <p class="help-block small">(only required for former smokers)</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            {{ f.floatingLabel("sioas", "Reported asymptomatic for lung cancer at time of order", "required") }}
                                        </div>
                                        <div class="col-md-8 form-group">
                                            {{ f.inlineRadioNY("sioas") }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-md-4">
                            {{ f.floatingLabel("siopci", "Clinical Information", "required") }}
                        </div>
                        <div class="col-xs-8 col-md-6 form-group">
                            <textarea class="form-control" id="siopci" name="siopci" rows="4"></textarea>
                            <small class="form-text text-muted">
                                information will be copied to CT report
                            </small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-12 col-md-4">
                            {{ f.floatingLabel("sisloc", "Scanning Location", "required") }}
                        </div>
                        <div class="col-xs-6 col-md-4 form-group">
                            <select name="sisloc" id="sisloc" class="form-control">
                                <option value="-"> -</option>
                                <option value="MSH"> Mount Sinai Medical Center</option>
                                <option value="MSW"> Mount Sinai West</option>
                                <option value="MSL"> Mount Sinai St Luke's</option>
                                <option value="MSB"> Brooklyn Heights</option>
                                <option value="MSK"> Kings Highway</option>
                                <option value="HU">Huntington</option>
                                <option value="MSDUS"> Beth Israel/ Union Square</option>
                                <option value="MSDC"> Chelsea</option>
                                <option value="MS34"> 34th St</option>
                                <option value="MSQ"> Queens</option>
                                <option value="fe"> Being followed elsewhere</option>
                            </select>
                        </div>
                    </div>
                    <div class="alert alert-warning">
                        Referring physician is required for all exams regardless of the information above. This should
                        be the "attending physician", which may be different that the individual ordering the exam. Only
                        enter one physician, and do not use suffixes.
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            {{ f.floatingLabel("sirffn", "Referring Physician Name") }}
                        </div>
                        <div class="col-md-2 form-group">
                            <input value="" class="form-control" id="sirffn" name="sirffn" type="text"/>
                            <span class="help-block small">First Name</span>
                        </div>
                        <div class="col-md-2 form-group">
                            <input value="" class="form-control" id="sirfln" name="sirfln" title="Last name"
                                   type="text"/>
                            <span class="help-block small">Last Name</span>
                        </div>
                    </div>
                {% else %}
                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('fursnscn', 'Reason for CT scan', "required") }}
                    </div>
                    <div class="col-md-8 form-group">
                        <textarea class="form-control" id="fursnscn" name="fursnscn" rows="3"
                                  required="required"></textarea>
                    </div>
                </div>
                {% endif %}
                <hr/>
                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siabx-n', 'Have you taken antibiotics since your last CT scan?', "required") }}
                    </div>
                    <div class="col-md-2 form-group">
                        {{ f.inlineRadio("siabx", "siabx-n", "n", "No", true) }}
                        {{ f.inlineRadio("siabx", "siabx-y", "y", "Yes") }}
                    </div>
                    {% if site=='sinai' %}
                        <div class="col-md-2">
                            <div class="form-group" id="siabxd-container">
                                <label class="control-label" for="siabxd">If so, when?</label>
                                {{ f.datepicker("siabxd", "past", true) }}
                            </div>
                        </div>
                    {% endif %}


                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siaex-n', 'Is this an annual CT scan?', "required") }}
                    </div>
                    <div class="col-md-8 form-group">
                        {{ f.inlineRadio("siaex", "siaex-n", "n", "No", true) }}
                        {{ f.inlineRadio("siaex", "siaex-y", "y", "Yes") }}
                    </div>
                </div>
                <hr/>


                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siwc-b', 'During the past year, have you experienced any of these symptoms?') }}
                    </div>
                    <div class="col-md-8 form-group">
                        {{ f.inlineRadioNY("siwc") }}
                        <div id="siwc-y-container">
                            {{ f.checkbox("siwcb", "b", "Cough producing bloody material") }}
                            {{ f.checkbox("siwcl", "l", "Unexplained weight loss greater than 20 lbs") }}
                            {{ f.checkbox("siwch", "h", "Unexplained hoarseness") }}
                            {{ f.checkbox("siwco", "o", "Other") }}
                            <label for="siwcos" class="aria-hidden">Other</label>
                            <input type="text" class="form-control input-sm" id="siwcos" name="siwcos"
                                   required="required"/>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siwcp-n', 'If yes, have you seen a physician for this?') }}
                    </div>
                    <div class="col-md-2 form-group">
                        {{ f.inlineRadioNY("siwcp") }}
                    </div>
                    <div class="col-md-6 form-group" id="siwcw-container">
                        <label class="control-label" for="siwcw">Whom?</label>
                        <input type="text" id="siwcw" name="siwcw" class="form-control"/>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siwcp-n', 'If yes, are you now experiencing them?') }}
                    </div>
                    <div class="col-md-8 form-group">
                        {{ f.inlineRadioNY("siwcn") }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siact', 'When did you most recently have a chest CT?') }}
                    </div>
                    <div class="col-md-8 form-group">
                        <select id="siact" name="siact" class="form-control">
                            <option value="-">-</option>
                            <option value="a">Less than 6 months ago</option>
                            <option value="b">6 months to 18 months ago</option>
                            <option value="f">18 months to 3 years ago</option>
                            <option value="c">3 years to 5 years ago</option>
                            <option value="d">Over 5 years ago</option>
                            <option value="e">Never</option>
                        </select>
                    </div>
                </div>
                {% if site=='sinai' %}
                    <div class="row" id="siahcl-container">
                        <div class="col-md-4">
                            <label class="visible-xs visible-sm " for="siahcl">
                                If so, where was the test done?
                            </label>
                            <label class="text-right pull-right hidden-xs hidden-sm " for="siahcl">
                                If so, where was the test done?
                            </label>
                        </div>
                        <div class="col-md-4 form-group">
                            <input type="text" name="siahcl" class="form-control"/>
                        </div>
                    </div>
                {% endif %}

                {% if site=='sinai' %}
                    <hr/>
                    <h4>COVID Status</h4>

                    <div class="row">
                        <div class="col-md-3 form-group">
                            <label for="sbcsts">COVID-19 Testing Status</label>
                            <select class="form-control" name="sbcsts">
                                <option value="-">-</option>
                                <option value="pos">tested: positive</option>
                                <option value="neg">tested: negative</option>
                                <option value="inc">tested: inconclusive</option>
                                <option value="nt">not tested</option>
                                <option value="unk">unknown</option>
                            </select>
                        </div>
                        <div class="col-md-3 form-group">
                            <label for="sbcsdot">Date of Test</label>
                            {{ f.datepicker("sbcsdot", "past") }}
                        </div>
                        <div class="col-md-3 form-group">
                            <label for="sbcsl">Where?</label>
                            <input type=text class="form-control" name="sbcsl" value="">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 form-group">
                            <label for="sbcsse"> COVID-19 Serology</label>
                            <select class="form-control" name="sbcsse">
                                <option value="-">-</option>
                                <option value="pos">tested: positive</option>
                                <option value="neg">tested: negative</option>
                                <option value="inc">tested: inconclusive</option>
                                <option value="nt">not tested</option>
                                <option value="unk">unknown</option>
                            </select>
                        </div>
                        <div class="col-md-3 form-group">
                            <label for="sbcsdos">Date of Test</label>
                            {{ f.datepicker("sbcdos", "past") }}
                        </div>
                        <div class="col-md-3 form-group">
                            <label for="sbcssl">Where?</label>
                            <input type=text class="form-control" name="sbcssl" value="">
                        </div>
                    </div>

                    <hr>
                    <h4 class="form-group">COVID-19 Vaccination Record</h4>

                    <div class="row">
                        <div class="col-md-3 form-group">
                            <label for="sbcvv">Have you received the COVID-19 vaccine?</label>
                        </div>
                        <div class="col-md-9 form-group">
                            {{ f.inlineRadioNY("sbcvv") }}
                        </div>
                    </div>

                    <div id="sbcvv-container">
                        <div class="row">
                            <div class="col-md-3 form-group">
                                <label for="sbcvdd1">Date of 1st dose</label>
                                {{ f.datepicker("sbcvdd1", "past") }}
                            </div>

                            <div class="col-md-3 form-group">
                                <label for="sbcvm">Manufacturer</label>
                                <select class="form-control" name="sbcvm">
                                    <option value="-">-</option>
                                    <option value="p">Pfizer/BioNTech</option>
                                    <option value="m">Moderna</option>
                                    <option value="a">AstraZeneca</option>
                                    <option value="j">Johnson & Johnson</option>
                                    <option value="o">Other (specify)</option>
                                </select>
                            </div>
                            <div class="col-md-3 form-group">
                                <label for="sbcvmo">Specify</label>
                                <input type="text" class="form-control" id="sbcvmo" name="sbcvmo">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 form-group">
                                <label for="sbcvdd2">Date of 2nd dose</label>
                                {{ f.datepicker("sbcvdd2", "past") }}
                            </div>
                            <div class="col-md-3 form-group">
                                <label for="sbcvm2">Manufacturer</label>
                                <select class="form-control" name="sbcvm2">
                                    <option value="-">-</option>
                                    <option value="p">Pfizer/BioNTech</option>
                                    <option value="m">Moderna</option>
                                    <option value="a">AstraZeneca</option>
                                    <option value="j">Johnson & Johnson</option>
                                    <option value="o">Other (specify)</option>
                                </select>
                            </div>
                            <div class="col-md-3 form-group">
                                <label for="sbcvmos2">Specify</label>
                                <input type="text" class="form-control" id="sbcvmos2" name="sbcvmos2">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-3 form-group">
                                <label for="sbcvdd3">Date of 3rd dose</label>
                                {{ f.datepicker("sbcvdd3", "past") }}
                            </div>
                            <div class="col-md-3 form-group">
                                <label for="sbcvm3">Manufacturer</label>
                                <select class="form-control" name="sbcvm3">
                                    <option value="-">-</option>
                                    <option value="p">Pfizer/BioNTech</option>
                                    <option value="m">Moderna</option>
                                    <option value="a">AstraZeneca</option>
                                    <option value="j">Johnson & Johnson</option>
                                    <option value="o">Other (specify)</option>
                                </select>
                            </div>
                            <div class="col-md-3 form-group">
                                <label for="sbcvmos3">Specify</label>
                                <input type="text" class="form-control" id="sbcvmos3" name="sbcvmos3">
                            </div>
                        </div>
                    </div>
                {% endif %}

                <hr/>
                <div class="row">
                    <div class="col-md-4 col-lg-6">
                        {{ f.floatingLabel('siho-n', 'Have you been hospitalized in the past year?', "required") }}
                    </div>
                    <div class="col-md-2 form-group">
                        {{ f.inlineRadio("siho", "siho-n", "n", "No", true) }}
                        {{ f.inlineRadio("siho", "siho-y", "y", "Yes") }}
                    </div>
                    <div class="col-md-6 col-lg-4" id="siho-container">
                        <div class="form-group">
                            <label for="sihow" class="control-label">For what?</label>
                            <input type=text id="sihow" name="sihow" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="sihod">When?</label>
                            {{ f.yearpicker("sihod") }}
                        </div>
                        <div class="form-group">
                            <label for="sihol">Where?</label>
                            <input type=text id="sihol" name="sihol" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 col-lg-6">
                        {{ f.floatingLabel('sicd-n', 'Have you had a diagnosis of cancer in the past year?', "required") }}
                    </div>
                    <div class="col-md-2 form-group">
                        {{ f.inlineRadio("sicd", "sicd-n", "n", "No", true) }}
                        {{ f.inlineRadio("sicd", "sicd-y", "y", "Yes") }}
                    </div>
                    <div class="col-md-6 col-lg-4" id="sicd-container">
                        <div class="form-group">
                            <label for="sicdl" class="control-label">What part of the body?</label>
                            <select id="sicdl" name="sicdl" class="form-control">
                                <option value="-">-</option>
                                <option value="br">Breast</option>
                                <option value="co">Colon / rectum</option>
                                <option value="li">Liver</option>
                                <option value="lu">Lung / bronchus</option>
                                <option value="ov">Ovary</option>
                                <option value="pa">Pancreas</option>
                                <option value="pr">Prostate</option>
                                <option value="sk">Skin</option>
                                <option value="st">Stomach</option>
                                <option value="ut">Uterus</option>
                                <option value="os">Other (specify)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sicdls">Other?</label>
                            <input type=text id="sicdls" name="sicdls" class="form-control input-sm">
                        </div>
                        <div class="form-group">
                            <label for="sicdd">When were you diagnosed?</label>
                            {{ f.datepicker("sicdd", "past") }}
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 col-lg-6">
                        {{ f.floatingLabel('silcs-n', 'If lung cancer has been diagnosed, have you had surgery?', "required") }}
                    </div>
                    <div class="col-md-2 form-group">
                        {{ f.inlineRadio("silcs", "silcs-n", "n", "No", true) }}
                        {{ f.inlineRadio("silcs", "silcs-y", "y", "Yes") }}
                        {{ f.inlineRadio("silcs", "silcs-o", "o", "N/A") }}
                    </div>
                    <div class="col-md-6 col-lg-4" id="silcs-container">
                        <div class="form-group">
                            <label for="silcsd">When?</label>
                            {{ f.datepicker("silcsd", "past") }}
                        </div>
                        <div class="form-group">
                            <label for="silcsl">Where?</label>
                            <input type=text id="silcsl" name="silcsl" class="form-control">
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 col-lg-6">
                        {{ f.floatingLabel('sier-n', 'If a lung cancer has been removed, is there evidence of recurrence?', "required") }}
                    </div>
                    <div class="col-md-2 form-group">
                        {{ f.inlineRadio("sier", "sier-n", "n", "No", true) }}
                        {{ f.inlineRadio("sier", "sier-y", "y", "Yes") }}
                        {{ f.inlineRadio("sier", "sier-o", "o", "N/A") }}
                    </div>
                    <div class="col-md-6 col-lg-4" id="sier-container">
                        <div class="form-group">
                            <label for="sierd">Describe</label>
                            <input type=text id="sierd" name="sierd" class="form-control">
                        </div>
                    </div>
                </div>

                <hr/>
            </div>


            <h3>Smoking History</h3>

            {% if site != 'sinai' %}
            {% include '_pack-year-history.jinja2' %}
            {% endif %}

            {% if site=='sinai' %}
                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sisav-n', 'Since your last visit, have you smoked cigarettes at all, even a puff?') }}
                    </div>
                    <div class="col-md-8 form-group">
                        {{ f.inlineRadio("sisav", "sisav-n", "n", "No") }}
                        {{ f.inlineRadio("sisav", "sisav-y", "y", "Yes") }}
                        {{ f.inlineRadio("sisav", "sisav-o", "o", "Never smoked") }}
                    </div>
                </div>
            {% else %}
                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sisa-n', 'Since your last follow-up, have you smoked cigarettes at all, even a puff?') }}
                    </div>
                    <div class="col-md-8 form-group">
                        {{ f.inlineRadio("sisa", "sisa-n", "n", "No") }}
                        {{ f.inlineRadio("sisa", "sisa-y", "y", "Yes") }}
                        {{ f.inlineRadio("sisa", "sisa-o", "o", "Never smoked") }}
                    </div>
                </div>
            {% endif %}

            <div id="sisa-container">
                {% if site=='sinai' %}
                    <div class="row">
                        <div class="col-md-4">
                            {{ f.floatingLabel("sidpw", "On average, on how many days per week are you currently smoking cigarettes?") }}
                        </div>
                        <div class="col-md-1 form-group">
                            <input value="" class="form-control" id="sidpw" name="sidpw" type="text"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            {{ f.floatingLabel("sippd", "On average, on the days that you are smoking cigarettes, how many packs of cigarettes are you currently smoking per day (PPD)?", "required") }}
                        </div>
                        <div class="col-md-1 form-group">
                            <input value="" class="form-control" id="sippd" name="sippd" type="text"/>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            {{ f.floatingLabel("sidlcd", "When was the date of your last cigarette?") }}
                        </div>
                        <div class="col-md-4">
                            <div class="form-group" style="float:left;">
                                <select class="form-control input-sm" id="sidlcd" name="sidlcd"
                                        title="Last cigarette day">

                                    <option value="-">-</option>
                                    {% for i in range(1,31) %}
                                        <option value="{{ i }}">{{ i }}</option>
                                    {% endfor %}
                                </select>
                                <span class="small text-muted">Day</span>
                            </div>
                            <div class="form-group" style="float:left;">
                                <select class="form-control input-sm" id="sidlcm" name="sidlcm"
                                        title="Last cigarette month">
                                    <option value="-">-</option>
                                    <option value="1">Jan</option>
                                    <option value="2">Feb</option>
                                    <option value="3">Mar</option>
                                    <option value="4">Apr</option>
                                    <option value="5">May</option>
                                    <option value="6">Jun</option>
                                    <option value="7">Jul</option>
                                    <option value="8">Aug</option>
                                    <option value="9">Sep</option>
                                    <option value="10">Oct</option>
                                    <option value="11">Nov</option>
                                    <option value="12">Dec</option>
                                </select>
                                <span class="small text-muted">Month</span>
                            </div>
                            <div class="form-group" style="float:left;">
                                <input value="" class="form-control input-sm" id="sidlcy" maxlength="4" name="sidlcy"
                                       placeholder="YYYY" size="5" title="" type="text"/>
                                <small class="help-block">
                                    Year
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            {{ f.floatingLabel("sbcpas", "Since the start of the pandemic has the amount of cigarettes smoked per day changed?") }}
                        </div>
                        <div class="col-md-4 form-group">
                            {{ f.inlineRadioNY("sbcpas") }}
                        </div>
                    </div>
                    <div class="row" id="sbcpas-y-container">
                        <div class="col-md-4">
                            {{ f.floatingLabel("sbcpasy-i", "If Yes:") }}
                        </div>
                        <div class="col-md-4 form-group">
                            {{ f.inlineRadio("sbcpasy", "spcpasy-i", "i", "Increase") }}
                            {{ f.inlineRadio("sbcpasy", "spcpasy-d", "d", "Decrease") }}
                        </div>
                    </div>
                {% else %}
                    <div class="row form-group">
                        <div class="col-md-4">
                            {{ f.floatingLabel('sicpd', 'On average, how many cigarettes did you smoke per day?') }}
                        </div>
                        <div class="col-sm-2">
                            <input class="form-control numeric" type="text" name="sicpd" id="sicpd" maxlength="4">
                        </div>
                    </div>
                    <div class="row form-group">
                        <div class="col-md-4">
                            {{ f.floatingLabel('siq', 'Quit Date') }}
                        </div>
                        <div class="col-sm-4 col-md-3 col-lg-2">
                            {{ f.datepicker ("siq", "past") }}
                        </div>
                    </div>
                    <div class="row form-group">
                        <div class="col-md-4">
                            {{ f.floatingLabel('sippd', 'How many <em>packs</em> of cigarettes did you smoke per day (PPD)?') }}
                        </div>
                        <div class="col-sm-8">
                            <span id="sippd-val"></span>
                        </div>
                        <input type="hidden" name="sippd" id="sippd"/>
                    </div>
                    <div class="row form-group">
                        <div class="col-md-4">
                            {{ f.floatingLabel('sippy', 'Reported pack years') }}
                        </div>
                        <div class="col-sm-8">
                            <span id="sippy-val"></span>
                            <div class="alert alert-info" id="cumulative-pack-years-message"
                                 style="display: none"></div>
                        </div>
                        <input type="hidden" name="sippy" id="sippy"/>
                        <input type="hidden" name="sippycu" id="sippycu" title="Cumulative reported pack years"/>
                    </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-4">
                        {% if site=='sinai' %}
                            {{ f.floatingLabel('sittq', 'Since your prior CT scan, have you ever tried to quit smoking?') }}
                        {% else %}
                            {{ f.floatingLabel('sittq', 'Since we last asked, have you ever tried to quit smoking?') }}
                        {% endif %}
                    </div>
                    <div class="col-md-8 form-group">
                        {{ f.inlineRadio("sittq", "sittq-n", "n", "No") }}
                        {{ f.inlineRadio("sittq", "sittq-y", "y", "Yes") }}
                        {{ f.inlineRadio("sittq", "sittq-o", "o", "N/A") }}
                    </div>
                </div>
                <div class="row" id="sittq-container">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sittqt', 'How many times have you quit smoking for at least 24 hours?') }}
                    </div>
                    <div class="col-md-1 form-group">
                        <input type=text id="sittqt" name="sittqt" class="form-control numeric">
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4">
                        {% if site=='sinai' %}
                            {{ f.floatingLabel('', 'Since your prior CT scan, what, if any, smoking cessation methods have you used?', 'radio-label') }}
                        {% else %}
                            {{ f.floatingLabel('', 'Since we last asked what, if any, smoking cessation methods have you used?', 'radio-label') }}
                        {% endif %}
                    </div>

                    <div class="col-sm-8 form-group">
                        {{ f.checkbox("sisca", "a","Have not tried to quit") }}
                        {{ f.checkbox("siscb", "b","\"Cold Turkey\" by completely stopping on your own with no other assistance") }}
                        {{ f.checkbox("siscc", "c","Tapering or reducing number of cigarettes smoked per day") }}
                        {{ f.checkbox("siscd", "d","Self-help material (e.g., brochure, cessation website)") }}
                        {{ f.checkbox("sisce", "e","Individual consultation or cessation counseling") }}
                        {{ f.checkbox("siscf", "f","Telephone cessation counseling hotline") }}
                        {{ f.checkbox("siscg", "g","Peer support (e.g., Nicotine Anonymous)") }}
                        {{ f.checkbox("sisch", "h","Nicotine replacement therapy (e.g., patch, gum, inhaler, nasal spray, lozenge)") }}
                        {{ f.checkbox("sisci", "i","Zyban") }}
                        {{ f.checkbox("siscj", "j","Hypnosis") }}
                        {{ f.checkbox("sisck", "k","Acupuncture / acupressure") }}
                        {{ f.checkbox("siscl", "l","Other (specify)") }}
                        <label for="siscos" class="aria-hidden">Other</label>
                        <input type="text" class="form-control input-sm" id="siscos" name="siscos" required="required"/>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siqst', 'Are you seriously thinking of quitting smoking?') }}
                    </div>
                    <div class="col-md-8 form-group">
                        <select id="siqst" name="siqst" class="form-control">
                            <option value="-">-</option>
                            <option value="y">Yes, within the next 30 days</option>
                            <option value="m">Yes, within the next 6 months</option>
                            <option value="n">No, not thinking of quitting</option>
                            <option value="o">N/A</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    {% if site=='sinai' %}
                        <div class="col-md-4">
                            {{ f.floatingLabel('sicpd', 'Smoking cessation materials were distributed to subject?', 'radio-label') }}
                        </div>
                        <div class="col-md-8 form-group">
                            {{ f.inlineRadioNY("sicpd") }}
                        </div>
                    {% else %}
                        <div class="col-md-4 ">
                            {{ f.floatingLabel('siscmd-d', 'Tobacco cessation provided:', 'radio-label') }}
                        </div>
                        <div class="col-md-8 form-group">
                            {{ f.radio("siscmd", "siscmd-d", "d", "Declined") }}
                            {{ f.radio("siscmd", "siscmd-a", "a", "Advised to quit smoking; resources provided") }}
                            {{ f.radio("siscmd", "siscmd-i", "i", "Interested in tobacco cessation medication. Encouraged to talk to provider or pharmacist about which medication option is best for you.") }}
                        </div>
                    {% endif %}
                </div>
            </div>

            {% if site!='sinai' %}
            <div class="row followup-other">
                <div class="col-md-4">
                    {{ f.floatingLabel('fucmotip', 'Communications method:', 'checkbox-label required') }}
                </div>

                <div class="col-md-8 form-group">
                    {{ f.checkbox("fucmotip", "1", "In person", {'group':'other-communications-method'}) }}
                    {{ f.checkbox("fucmotte", "1", "Telephone", {'group':'other-communications-method'}) }}
                    {{ f.checkbox("fucmotth", "1", "TeleHealth", {'group':'other-communications-method'}) }}
                    {{ f.checkbox("fucmotml", "1", "Mailed letter", {'group':'other-communications-method'}) }}
                    {{ f.checkbox("fucmotpp", "1", "Message in Patient Portal", {'group':'other-communications-method'}) }}
                    {{ f.checkbox("fucmotvd", "1", "Video-on-Demand (VOD)", {'group':'other-communications-method'}) }}
                    {{ f.checkbox("fucmotot", "1", "Other", {'group':'other-communications-method'}) }}
                    <label class="aria-hidden" for="fucmotoo">Other contact method</label>
                    <input class="form-control input-sm" type="text" name="fucmotoo" id="fucmotoo"
                           required="required">
                </div>
                <div class="col-md-8 col-md-offset-4 form-group">
                    <textarea class="form-control" id="fucmotde" name="fucmotde" rows="3"
                              required="required"></textarea>
                    <small class="help-block">Additional details</small>
                </div>
            </div>
            {% endif %}

            {% if site!='sinai' %}
            <div class="followup-ct">
                <h3>Communication about results</h3>

                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('fulctdt','Last CT date', 'required') }}
                    </div>
                    <div class="form-group col-sm-3 col-md-3 col-lg-2">
                        {{ f.datepicker("fulctdt", "past", true) }}
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        {{ f.floatingLabel('fucmctip', 'Communications method:', 'checkbox-label required') }}
                    </div>

                    <div class="col-md-8 form-group">
                        {{ f.checkbox("fucmctip", "1", "In person", {'group':'ct-communications-method'}) }}
                        {{ f.checkbox("fucmctte", "1", "Telephone", {'group':'ct-communications-method'}) }}
                        {{ f.checkbox("fucmctth", "1", "TeleHealth", {'group':'ct-communications-method'}) }}
                        {{ f.checkbox("fucmctml", "1", "Mailed letter", {'group':'ct-communications-method'}) }}
                        {{ f.checkbox("fucmctpp", "1", "Message in Patient Portal", {'group':'ct-communications-method'}) }}
                        {{ f.checkbox("fucmctvd", "1", "Video-on-Demand (VOD)", {'group':'ct-communications-method'}) }}
                        {{ f.checkbox("fucmctot", "1", "Other", {'group':'ct-communications-method'}) }}
                        <label class="aria-hidden" for="fucmctoo">Other contact method</label>
                        <input class="form-control input-sm" type="text" name="fucmctoo" id="fucmctoo"
                               required="required">
                    </div>
                    <div class="col-md-8 col-md-offset-4 form-group">
                        <textarea class="form-control" id="fucmctde" name="fucmctde" rows="3"
                                  required="required"></textarea>
                        <small class="help-block">Additional details</small>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 ">
                        {{ f.floatingLabel('funewct', 'Has a new CT/LDCT been ordered?', 'required') }}
                    </div>
                    <div class="col-md-8 form-group">
                        {{ f.inlineRadioNY('funewct',true) }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4 ">
                        {{ f.floatingLabel('fucompul', 'Communication to pulmonary?') }}
                    </div>
                    <div class="col-md-8 form-group">
                        {{ f.inlineRadioNY('fucompul') }}
                    </div>
                </div>
            </div>
            {% endif %}

            {% if site=='sinai' %}
                <!-- Deprecated SF8 Health Survey -->
                <hr/>
                <h3> Health Survey <span id="deprec-txt"> </span></h3>
                <div class="alert alert-warning">
                    This survey asks for your views about your health. This information will help you keep track of how
                    you feel and how well you are able to do your usual activities. Answer every question by selecting
                    the answer as indicated. If you are unsure about how to answer a question, please give the best
                    answer you can. For each of the following questions, please choose the one option that best
                    describes your answer.
                </div>
                <div class="row">
                    <div class="col-md-4">
                        {{ f.checkbox("sisfr", "r", "RTA") }}
                    </div>
                </div>
                <div id="sf8">
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisfb1", "1. Overall, how would you rate your health during the
                                <U>past 4 weeks</U>") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisfb1", ["Excellent","Very Good","Good","Fair","Poor","Very Poor"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisfb2", "2. During the
                                <U>past 4 weeks</U>, how much did physical health problems limit your usual physical
                                activities(such as walking or climbing stairs)") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisfb2", ["Not at all","Very little","Somewhat","Quite a lot","Could not do physical activities"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisfb3", "3.During the
                                <U>past 4 weeks</U>, how much difficulty did you have doing your daily work, both at
                                home and away from home, because of your physical health?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisfb3", ["None at all","A little bit","Some","Quite a lot","Could not do daily work"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisfb4", "4. How much
                                <U>bodily</U> pain have you had during the
                                <U>past 4 weeks</U>?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisfb4", ["None","Very mild","Mild","Moderate","Very Severe"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisfb5", "5. During the
                                <U>past 4 weeks</U>, how much energy did you have?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisfb5", ["Very much","Quite a lot","Some","A little","None"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisfb6", "6. During the
                                <U>past 4 weeks</U>, how much did your physical health or emotional problems limit your
                                usual social activities with family or friends?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisfb6", ["None at all","Very little","Somewhat","Quite a lot","Could not do social activities"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisfb7", "7. During the
                                <U>past 4 weeks</U>, how much have you been bothered by
                                <B><U>emotional problems</U></B>(such as feeling anxious, depressed or irritable)?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisfb7", ["Not at all","Slightly","Moderately","Quite a lot","Extremely"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisfb8", "8. During the
                                <U>past 4 weeks</U>, how much did personal or emotional problems keep you from doing
                                your usual work, school or other daily activities?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisfb8", ["Not at all","Very little","Somewhat","Quite a lot","Could not do daily activities"]) }}
                        </div>
                    </div>
                </div>
                <!-- End of Deprecated SF8 Health Survey -->

                <!-- SF12 Health Survey -->
                <div id="sf12">
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisf1", "1. In general, would you say your health is:") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf1", ["Excellent","Very good","Good","Fair","Poor"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12 form-group">
                            {{ f.floatingLeftLabel("sisf2", "2. The following questions are about activities you might do
                            during a typical day. Does <em>your health now limit you</em> in these activities? If so,
                            how much?") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "a) <U>Moderate activities</U>, such as moving a table, pushing a
                            vacuum cleaner, bowling, or playing golf") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf2", ["Yes, limited a lot","Yes, limited a little","No, not limited at all"]) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "b) Climbing <U>several</U> flights of stairs") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf3", ["Yes, limited a lot","Yes, limited a little","No, not limited at all"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12 form-group">
                            {{ f.floatingLeftLabel("", "3. During the
                                <U>past 4 weeks</U>, how much of the time have you had any of the following problems
                                with your work or other regular daily activities
                                <U>as a result of your physical health</U>?") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "a) <U>Accomplished less</U> than you would like") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf4", ["All of the time","Most of the time","Some of the time", "A little of the time", "None of the time"]) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "b) Were limited in the
                                <U>kind</U> of work or other activities") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf5", ["All of the time","Most of the time","Some of the time", "A little of the time", "None of the time"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "4. During the <U>past 4 weeks</U>, how much of the time have you had any of the following problems with your work or other regular daily activities <U>as a result of any emotional problems</U> (such as feeling depressed or anxious)?") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "a) <U>Accomplished less</U> than you would like") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf6", ["All of the time","Most of the time","Some of the time", "A little of the time", "None of the time"]) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "b) Did work or other activities
                                <U>less carefully than usual</U>") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf7", ["All of the time","Most of the time","Some of the time", "A little of the time", "None of the time"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisf8", "5. During the
                                <U>past 4 weeks</U>, how much did
                                <U>pain</U> interfere with your normal work (including both work outside the home and
                                housework)?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf8", ["Not at all","A little bid","Moderately", "Quite a bit", "Extremely"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12 form-group">
                            {{ f.floatingLeftLabel("sisf9", "6. These questions are about how you feel and how things have been with you during the
                                <U>past 4 weeks</U>. For each question, please give the one answer that comes closest to
                                the way you have been feeling. How much of the time during the
                                <U>past 4 weeks</U>...") }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "a) have you felt calm and peaceful?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf9", ["All of the time","Most of the time","Some of the time", "A little of the time", "None of the time"]) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "b) did you have a lot of energy?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf10", ["All of the time","Most of the time","Some of the time", "A little of the time", "None of the time"]) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("", "c) have you felt downhearted and depressed?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf11", ["All of the time","Most of the time","Some of the time", "A little of the time", "None of the time"]) }}
                        </div>
                    </div>
                    <hr class="hs-br"/>
                    <div class="row">
                        <div class="col-md-12">
                            {{ f.floatingLeftLabel("sisf12", "7. During the <U>past 4 weeks</U>, how much of the time
                            has your <U>physical health or emotional problems</U> interfered with your social activities
                            (like visiting friends, relatives, etc.)?") }}
                        </div>
                        <div class="col-md-12 form-group">
                            {{ f.inlineRadioOptions("sisf12", ["All of the time","Most of the time","Some of the time", "A little of the time", "None of the time"]) }}
                        </div>
                    </div>
                </div>
                <hr/>
            {% endif %}

            <div class="pull-left">
                <input type="hidden" id="samistatus" name="samistatus" value=""/>
                <button type="submit" class="btn btn-default" id="save-for-later-button"
                        formnovalidate="formnovalidate">Save for Later
                </button>
                <button type="submit" class="btn btn-primary" id="submit-button">Submit</button>
            </div>
            <div class="pull-right">
                <a id="delete-form" class="btn btn-danger"><span class="glyphicon glyphicon-trash"></span>Delete</a>
            </div>
        </form>
    </div>

    {{ f.deleteFormModal("followup.html", mockup, formMethod) }}
{% endblock %}

{% block script %}
    <script>

        const interactionType = $("[name=futype]:checked").val();
        if (interactionType === "ct" || interactionType === "other") {
            const humanMessage = "This interaction is for a <strong>" + (interactionType === "ct" ? "CT" : "non-CT") + "</strong> follow-up";
            $message = $("<div class=\"alert alert-info\">" + humanMessage + "</div>");
            $hiddenInput = $("<input type=\"hidden\" name=\"futype\" value=\"" + interactionType + "\"/>");
            $("#interaction-type").html("").append($message).append($hiddenInput);
        }

        function createFormValidator() {

            const $form = $('#main-form');

            // for certain validators that use multiple inputs like checkboxes and radio groups, change the location
            // of the error icon to be based on the form-group element, instead of being immediately adjacent to the
            // first control in that group
            const multiInputValidators = ['siabx', 'siaex', 'siho', 'sicd', 'silcs', 'sier', 'sicpd', 'funewct'];

            $form.formValidation({
                    fields: {
                        futype: {validators: {notEmpty: {message: 'Interaction type is required'}}},
                        // SCAN
                        sidof: {
                            validators: {
                                notEmpty: {message: 'Follow-up date is required'},
                                date: {max: VAPALS.todaysDate(), message: 'Follow-up date must not be in the future'}
                            }
                        },
                        sidoe: {
                            validators: {
                                notEmpty: {message: 'Baseline date is required'},
                                date: {max: VAPALS.todaysDate(), message: 'Baseline date must not be in the future'}
                            }
                        },
                        sico: {validators: {notEmpty: {message: 'Coordinator is required'}}},

                        //Ordering Information
                        fursnscn: {validators: {notEmpty: {message: 'Reason for CT scan is required'}}},
                        siabx: {validators: {notEmpty: {message: 'Antibiotics is required'}}},
                        siaex: {validators: {notEmpty: {message: 'Annual scan is required'}}},
                        siwcos: {validators: {notEmpty: {message: 'Other symptom is required'}}},
                        siwcw: {validators: {notEmpty: {message: 'Physician is required'}}},
                        siho: {validators: {notEmpty: {message: 'Hospitalized is required'}}},
                        sicd: {validators: {notEmpty: {message: 'Cancer diagnosis is required'}}},
                        silcs: {validators: {notEmpty: {message: 'Cancer surgery is required'}}},
                        sier: {validators: {notEmpty: {message: 'Recurrence is required'}}},

                        //Smoking
                        siscos: {validators: {notEmpty: {message: 'Other method is required'}}},
                        sicpd: {
                            validators: {
                                integer: {message: 'must be a whole number'}
                            }
                        },
                        siq: {
                            validators: {
                                date: {max: VAPALS.todaysDate(), message: 'Quit date must not be in the future'}
                            }
                        },
                        fucmotoo: {validators: {notEmpty: {message: 'Other communication method is required'}}},
                        fucmotip: { //use a real element name for the field so conditional plugins can toggle the field
                            selector: '[group=other-communications-method]',
                            validators: {choice: {min: 1, message: 'Select one or more contact methods'}}
                        },
                        fulctdt: {validators: {notEmpty: {message: 'Last CT date is required'}}},
                        fucmctoo: {validators: {notEmpty: {message: 'Other communication method is required'}}},
                        fucmctip: { //use a real element name for the field so conditional plugins can toggle the field
                            selector: '[group=ct-communications-method]',
                            validators: {choice: {min: 1, message: 'Select one or more contact methods'}}
                        },
                        funewct: {validators: {notEmpty: {message: 'CT/LDCT order selection is required'}}}
                    },
                    plugins: {
                        declarative: new FormValidation.plugins.Declarative(),
                        trigger: new FormValidation.plugins.Trigger(),
                        bootstrap3: new FormValidation.plugins.Bootstrap3(),
                        submitButton: new FormValidation.plugins.SubmitButton(),
                        defaultSubmit: new FormValidation.plugins.DefaultSubmit(),
                        excluded: new FormValidation.plugins.Excluded(), //disable validators on hidden, disabled fields
                        icon: new FormValidation.plugins.Icon({
                            valid: '',
                            invalid: 'glyphicon glyphicon-remove',
                            validating: 'glyphicon glyphicon-refresh',
                            onPlaced: function (e) {
                                if (multiInputValidators.indexOf(e.field) > -1) {
                                    $fg = $("#" + e.element.id).closest(".form-group");
                                    $c = $fg.find(".fv-plugins-message-container");
                                    if ($c.length == 1) {
                                        $c.append(e.iconElement);
                                    } else {
                                        $fg.append(e.iconElement);
                                    }
                                }
                            },
                        })
                    }
                }
            );

            const fv = $form.data('formValidation');
            fv.on('core.form.invalid', VAPALS.autoScrollToErrorField);
            fv.on('core.element.validated', VAPALS.hideSuccessFormatting);

            return fv;
        }

        const originalCumulativePackYears = parseFloat($("#sippycu").val());

        function calculateCumulativePackYears() {
            const priorFormDate = getPriorFormDate();
            //NB: the last cigarette date will be the quit date IF it is after the prior form date and before the
            // current form date. Otherwise it is the form date
            const thisFormDate = VAPALS.toMoment($("#sidof").val()) || moment();
            const quitDate = VAPALS.toMoment($("#siq").val());
            const validQuitDate = quitDate.isValid() &&
                quitDate.isSameOrAfter(priorFormDate) && quitDate.isSameOrBefore(thisFormDate);
            const lastCigaretteDate = validQuitDate ? quitDate : thisFormDate;
            const daysBetween = VAPALS.computeDaysBetween(priorFormDate, lastCigaretteDate);
            console.log("packYears() thisFormDate=%s, priorFormDate=%s, validQuitDate=%s, lastCigarette=%s, daysBetween=%d",
                thisFormDate.format(), priorFormDate.format(), validQuitDate, lastCigaretteDate.format(), daysBetween);

            const yearsSinceFollowup = (daysBetween / 365.24); //NB: purposely not rounded
            const packsPerDay = parseFloat($("#sippd").val());
            console.log("packYears() yearsSinceFollowup=%f, packsPerDay=%f", yearsSinceFollowup, packsPerDay);

            //if last cigarette was before last form, pack years is 0.
            let packYears = 0;
            if (!isNaN(packsPerDay) && lastCigaretteDate.isAfter(priorFormDate)) {
                packYears = VAPALS.calculatePackYears(packsPerDay, yearsSinceFollowup);
            }

            console.log("packYears() calculated packYears value is %f", packYears);
            if (packYears > 0) {
                $("#sippy").val(packYears.toFixed(2));
                $("#sippy-val").text(packYears + " from " + priorFormDate.format(VAPALS.DATE_FORMAT) + " to " +
                    lastCigaretteDate.format(VAPALS.DATE_FORMAT));
            } else {
                $("#sippy").val("");
                $("#sippy-val").text("-");
            }

            const cumulative = computeCumulativePackYears(packYears);
            if (cumulative > 0 && cumulative !== originalCumulativePackYears) {
                $("#sippycu").val(cumulative.toFixed(2));
                const message = "Cumulative pack years will be updated to <strong>" + cumulative.toFixed(2) + "</strong>";
                $("#cumulative-pack-years-message").html(message).show();
            } else {
                $("#cumulative-pack-years-message").hide();
            }
        }

        $(function () {

            {% if mockup %}
                // Allow mockup to run with data necessary to calculate cumulative pack years
                $("#sidof").val(moment().format(VAPALS.DATE_FORMAT));
                $("#sicpd").val("20");
            {% endif %}

            const fv = createFormValidator();
            $("#save-for-later-button").on('click', function () {
                fv.destroy();
            });

            const $tsbFields = $("#sidof, #sidoe");
            $tsbFields.closest(".datepicker").on("dp.change", function () {
                const baselineDate = $("#sidof").val();
                const studyDate = $("#sidoe").val();
                const months = VAPALS.computeMonthsBetween(baselineDate, studyDate);
                $("#sitsb-text").text(months);
                $("#sitsb-alert").toggle(months > 0);
                $("#sitsb").val(months);
            }); //latch onto datetimepicker change events
            $tsbFields.filter(function () {
                return $(this).val();
            }).first().trigger("dp.change"); //trigger on page load for existing data;

            //Mount Sinai fields
            $("[name=simeq]").conditionallyDisplay({enable: "#order-container"});
            $("[name=sidsd]").conditionallyDisplay({enable: "#sidsdp-container"});
            $("[name=siabx]").conditionallyEnable({enable: "#siabxd-container"});
            $("[name=siwc]").conditionallyEnable({enable: "#siwc-y-container,#siwc-y-container2"});
            $("[name=siact]").conditionallyEnable({sourceValues: "a,b,f,c,d", enable: "#siahcl-container"});
            // COVID Vaccination
            $("[name=sbcvm]").conditionallyDisplay({sourceValues: "o", enable: "#sbcvm-container"});
            $("[name=sbcvv]").conditionallyDisplay({enable: "#sbcvv-container"});
            $("[name=sbcvm]").conditionallyEnable({sourceValues: "o", enable: "#sbcvmo"})
            $("[name=sbcvm2]").conditionallyEnable({sourceValues: "o", enable: "#sbcvmos2"})
            $("[name=sbcvm3]").conditionallyEnable({sourceValues: "o", enable: "#sbcvmos3"})


            $("#siwco").conditionallyEnable({sourceValues: "o", enable: "#siwcos"});
            $("[name=siwcp]").conditionallyEnable({enable: "#siwcw-container"});
            $("[name=siho]").conditionallyDisplay({enable: "#siho-container"});
            $("#sicdl").conditionallyEnable({sourceValues: "os", enable: "#sicdls"});
            $("[name=sicd]").conditionallyDisplay({enable: "#sicd-container"});
            $("[name=silcs]").conditionallyDisplay({enable: "#silcs-container"});
            $("[name=sier]").conditionallyDisplay({enable: "#sier-container"});
            $("[name=sisa],[name=sisav]").conditionallyDisplay({enable: "#sisa-container"});
            $("[name=sittq]").conditionallyDisplay({enable: "#sittq-container"});
            $("#siscl").conditionallyEnable({sourceValues: "l", enable: "#siscos"});
            $("#fucmotot").conditionallyEnable({sourceValues: "1", enable: "#fucmotoo"}); // other contact method
            $("#fucmctot").conditionallyEnable({sourceValues: "1", enable: "#fucmctoo"}); // other contact method
            //Calculate packs per day
            $("#sicpd").on('keyup change', function () {
                const cigsPerDay = $("#sicpd").val();
                const $sippd = $("#sippd");
                const $sippdVal = $("#sippd-val");
                if (cigsPerDay >= 0) {
                    const cpd = VAPALS.calculatePacksPerDay(cigsPerDay);
                    if (cpd > 0) {
                        $sippd.val(cpd);
                        $sippdVal.text(cpd);
                    } else {
                        $sippd.val("");
                        $sippdVal.text("-");
                    }
                    $sippd.change();
                }
            }).trigger('change');

            $("[name=futype]").on('change', function () {
                const interactionType = $("[name=futype]:checked").val() || $("[name=futype]").val();
                let showCT = false;
                let showOther = false;
                if (interactionType == "ct") {
                    showCT = true;
                } else if (interactionType == "other") {
                    showOther = true;
                }
                $(".followup-ct").toggle(showCT);
                $(".followup-other").toggle(showOther);
            }).trigger('change');

            //Calculate pack years and cumulative pack years, displaying and setting field values where appropriate
            $("#sidof, #siq, #sippd").on('keyup change', calculateCumulativePackYears);
            calculateCumulativePackYears();

            // Determine which health survey to show based on the data that is present
            function showSF() {
                // 1. Data present for SF-12 -> show SF-12
                // 2. Data present for both SF-12 and SF-8 -> show SF-12
                // 3. Data present for only SF-8 -> show SF-8
                // 4. Data present for neither -> show SF-12

                var sf12data = $("[name=sisf1]").val();
                var sf8data = $("[name=sisfb1]").val();

                if (sf12data) {
                    document.getElementById('sf8').style.display = "none";
                } else if (sf8data) {
                    document.getElementById('sf12').style.display = "none";
                } else {
                    document.getElementById('sf8').style.display = "none";
                }
            }

            showSF();
        });

        /**
         * Retrieves the previous form date relative to this form in the #pack-years-history table.
         * Used to determine the FROM date when calculating pack years.
         * @returns {moment}
         */
        function getPriorFormDate() {
            const $lastHistoryRow = $("#pack-years-history tbody tr").last();
            const $currentFormRow = $("#pack-years-history tbody tr[data-current-form]").last();
            const $priorFormRow = $currentFormRow.length === 1 ? $currentFormRow.prev() : $lastHistoryRow;
            const priorFormDateStr = $priorFormRow.find(".reported-date").text().trim();
            const priorFormDate = VAPALS.toMoment(priorFormDateStr);
            return priorFormDate;
        }

    </script>

{% endblock %}
