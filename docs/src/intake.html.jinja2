{% extends 'layout.jinja2' %}
{% import 'forms.jinja2' as f %}
{% block title %}{{ title | escape }}{% endblock %}

{% block head %}
    <style>
        #wizard-bar.affix-top {
            position: static;
        }

        #wizard-bar.affix {
            position: sticky;
            top: 0;
            z-index: 1000;
        }
    </style>
{% endblock %}
{% block body %}
    <div class="container-fluid" style="max-width:1550px">
        <h1>
            Sample, Sammy G
            <small class="text-muted" title="Study ID">ST0001</small>
        </h1>
        <h2>{{ title | escape }}
            <small class="text-muted" title="Medical Record Number">1234567890</small>
        </h2>

        <hr/>
        {% include '_messages.jinja2' %}

        {# Build a navigation bar that will affix itself to the top of the screen and highligh active sections#}
        {% set tab_list = [("Chart Eligibility","chart-eligibility"), ("Intake", "intake")] -%}
        <nav class="navbar navbar-default hidden-xs" id="wizard-bar" data-spy="affix" data-offset-top="220"
             data-offset-bottom="70">
            <div class="row">
                <div class="col-sm-12">
                    <ul class="nav navbar-nav">
                        {% for tab_name,tab_id in tab_list -%}
                            <li><a href="#{{ tab_id }}" id="{{ tab_id }}-tab">{{ tab_name }}</a></li>
                        {%- endfor %}
                    </ul>
                </div>
            </div>
        </nav>


        <form action="{{ formPage+".html" if mockup else "/vapals" }}" class="validated" method="{{ formMethod }}"
              id="main-form">
            <input type="hidden" name="samiroute" value="postform"/>
            <input type="hidden" name="studyid" value="@@SID@@"/>
            <input type="hidden" name="site" value="@@SITE@@"/>
            <input type="hidden" name="form" value="@@FORMKEY@@"/>

            <div id="chart-eligibility">
                <div class="row">
                    <div class="col-md-12">
                        <p class="required lead">
                            The participant was identified as a potential lung screening candidate by:
                        </p>
                    </div>
                    <div class="col-sm-6 col-md-4">
                        <div class="form-group">
                            {{ f.radio('siceiden', 'siceiden-referral', 'referral', 'Referral', true) }}
                            {{ f.radio('siceiden', 'siceiden-ldct', 'ldct', 'Low-dose CT placed directly by clinician', true) }}
                            {{ f.radio('siceiden', 'siceiden-lspo', 'outreach', 'Lung screening program outreach', true) }}
                            {{ f.radio('siceiden', 'siceiden-self', 'self', 'Self-referred', true) }}
                        </div>
                    </div>
                    <div class="col-sm-6" id="referral-container" style="display: none;">
                        <div class="form-group">
                            <label for="sicerfdt" class="required">Date of referral</label>
                            {{ f.datepicker('sicerfdt', 'past', true) }}
                        </div>
                        <div class="form-group">
                            <label class="required doc-heading">Specialty of referring provider</label>
                            <br/>
                            {{ f.checkbox('sicerfpc', 'y', 'Primary Care') }}
                            {{ f.checkbox('sicerfwh', 'y', 'Women\'s Health') }}
                            {{ f.checkbox('sicerfge', 'y', 'Geriatrics') }}
                            {{ f.checkbox('sicerfpu', 'y', 'Pulmonology') }}
                            {{ f.checkbox('sicerfon', 'y', 'Oncology') }}
                            {{ f.checkbox('sicerfsc', 'y', 'Smoking Cessation') }}
                            {{ f.checkbox('sicerfot', 'y', 'Other') }}
                            <label class="aria-hidden" for="sicerfoo">Specify</label>
                            <input class="form-control form-inline" type="text" name="sicerfoo" id="sicerfoo"
                                   placeholder="specify" required="required">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-6 col-md-4">
                        <p class="required lead">Eligible based on chart review?</p>
                    </div>
                    <div class="col-sm-6 col-md-8 form-group">
                        {{ f.inlineRadioYN("sicechrt", true) }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="alert alert-info" id="sicechrt-y-alert" style="display:none;">
                            Complete the remainder of the form; an intake note will be generated.
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="panel panel-default" id="reason-container" style="display:none;">
                            <div class="alert alert-warning"
                                 style="margin-bottom: 0;border-bottom-left-radius: 0; border-bottom-right-radius: 0;">
                                Indicate one or more reasons why the participant is not eligible for lung screening. No
                                intake note will be generated.
                            </div>
                            <div class="panel-body">
                                <div class="form-group form-group-sm form-inline">
                                    <label for="sicemhlc">Medical History</label><br/>
                                    {{ f.inlineCheckbox("sicemhlc","y", "lung cancer", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("sicemhhs","y", "health status", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("sicemhot","y", "other", {'group':'ineligible-reason'}) }}
                                    <label class="aria-hidden" for="sicemhoo">Specify</label>
                                    <input class="form-control" type="text" name="sicemhoo" id="sicemhoo"
                                           placeholder="specify" required="required">
                                    <br/>
                                    <br/>

                                    <label>Receiving Care Elsewhere</label><br/>
                                    {{ f.inlineCheckbox("sicecepc","y", "followed in pulmonary clinic", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("sicecenc","y", "followed in nodule clinic", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("siceceho","y", "followed in hematology-oncology", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("sicecepr","y", "private care", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("siceceot","y", "other", {'group':'ineligible-reason'}) }}
                                    <label class="aria-hidden" for="siceceoo">Specify</label>
                                    <input class="form-control" type="text" name="siceceoo" id="siceceoo"
                                           placeholder="specify" required="required">
                                    <br/>
                                    <br/>

                                    <label>Smoking History</label><br/>
                                    {{ f.inlineCheckbox("siceshqd","y", "quit date greater than 15 years", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("siceshpy","y", "less than 30 pack years", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("siceshnc","y", "non-cigarette use (e.g. pipe, smokeless, vape, cannabis)", {'group':'ineligible-reason'}) }}
                                    {{ f.inlineCheckbox("siceshot","y", "other", {'group':'ineligible-reason'}) }}
                                    <label class="aria-hidden" for="siceshoo">Specify</label>
                                    <input class="form-control" type="text" name="siceshoo" id="siceshoo"
                                           placeholder="specify" required="required">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="save-chart-eligibility">Submit Chart Eligibility
                </button>
                <hr/>
            </div>
            <div id="pre-enrollment-discussion">
                <div class="row">
                    <div class="col-sm-12">
                        <p class="required lead">Was a pre-enrollment discussion held?</p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-3 form-group">
                        {{ f.inlineRadioYN("sipedisc", true) }}
                    </div>
                </div>
                <div id="discussion-container">
                    <h4>Pre-Enrollment Discussion</h4>
                    <div class="row">
                        <div class="col-sm-4 col-md-3 form-group">
                            <label for="sipedc" class="required">Date of contact</label>
                            {{ f.datepicker("sipedc", "past", true) }}
                        </div>

                        <div class="col-sm-8 col-md-9 form-group">
                            <label class="required">The lung screening program reached the participant or was contacted
                                via
                                (check all that apply)?</label>
                            {{ f.checkbox("sipecnip", "1", "In person", {'group':'discussion-contact'}) }}
                            {{ f.checkbox("sipecnte", "1", "Telephone", {'group':'discussion-contact'}) }}
                            {{ f.checkbox("sipecnth", "1", "TeleHealth", {'group':'discussion-contact'}) }}
                            {{ f.checkbox("sipecnml", "1", "Mailed letter", {'group':'discussion-contact'}) }}
                            {{ f.checkbox("sipecnpp", "1", "Message in Patient Portal", {'group':'discussion-contact'}) }}
                            {{ f.checkbox("sipecnvd", "1", "Video-on-Demand (VOD)", {'group':'discussion-contact'}) }}
                            {{ f.checkbox("sipecnot", "1", "Other", {'group':'discussion-contact'}) }}
                            <label class="aria-hidden" for="sipecnoo">Other contact method</label>
                            <input class="form-control input-sm" type="text" name="sipecnoo" id="sipecnoo"
                                   required="required">
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-md-12">
                            <p class="lead required">A pre-enrollment discussion with the participant resulted in:</p>
                            <div class="form-group">
                                {{ f.radio("siperslt","siperslt-y","y", "Participant is interested in discussing lung screening. The program will proceed with enrollment process.", true ) }}
                                {{ f.radio("siperslt","siperslt-u","u", "Participant is unsure of lung screening. Ok to contact in the future.", true ) }}
                                {{ f.radio("siperslt","siperslt-nn","nn", "Participant is not interested in discussing lung screening at this time. Ok to contact in the future.", true ) }}
                                {{ f.radio("siperslt","siperslt-nf","nf", "Participant is not interested in discussing lung screening in the future.", true ) }}
                                {{ f.radio("siperslt","siperslt-na","na", "Unable to reach participant at this time.", true ) }}
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="sipecmnt">Comments</label>
                                <textarea id="sipecmnt" name="sipecmnt" class="form-control"></textarea>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary" id="save-pre-enrollment-discussion">
                        Submit Pre-Enrollment Discussion
                    </button>
                </div>
                <hr/>
            </div>
            <div id="intake">
                <h3>Intake discussion</h3>
                <div class="row">
                    <div class="col-sm-4 col-md-3 form-group">
                        <label for="sidc" class="required">Date of contact</label>
                        {{ f.datepicker("sidc", "past", true) }}
                    </div>

                    <div class="col-sm-8 col-md-9 form-group">
                        <label class="doc-heading required">The lung screening program reached the participant or was
                            contacted via (check all that apply):</label>
                        {{ f.checkbox("silnip", "1", "In person", {'group':'intake-contact'}) }}
                        {{ f.checkbox("silnph", "1", "Telephone", {'group':'intake-contact'}) }}
                        {{ f.checkbox("silnth", "1", "TeleHealth", {'group':'intake-contact'}) }}
                        {{ f.checkbox("silnml", "1", "Mailed letter", {'group':'intake-contact'}) }}
                        {{ f.checkbox("silnpp", "1", "Message in Patient Portal", {'group':'intake-contact'}) }}
                        {{ f.checkbox("silnvd", "1", "Video-on-Demand (VOD)", {'group':'intake-contact'}) }}
                        {{ f.checkbox("silnot", "1", "Other", {'group':'intake-contact'}) }}
                        <label class="aria-hidden" for="silnoo">Other contact method</label>
                        <input class="form-control input-sm" type="text" name="silnoo"
                               id="silnoo" title="Other contact method" required="required">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 form-group">
                        <label class="required">Primary address verified</label>
                        {{ f.inlineRadio("sipav", "sipav-y","y","Yes", true) }}
                        {{ f.inlineRadio("sipav", "sipav-n","n","No") }}
                    </div>
                </div>


                <div class="row">
                    <div class="form-group col-sm-6 ">
                        <label for="sipsa">Preferred address</label>
                        <input type="text" name="sipsa" id="sipsa" class="form-control">
                    </div>
                    <div class="form-group col-sm-2">
                        <label for="sipan">Apt # </label>
                        <input type="text" name="sipan" id="sipan" class="form-control">
                    </div>
                    <div class="form-group col-sm-4">
                        <label for="sipcn">County</label>
                        <input type="text" name="sipcn" id="sipcn" class="form-control">
                    </div>
                </div>


                <div class="row">
                    <div class="form-group col-md-6">
                        <label for="sipc">City </label>
                        <input type="text" name="sipc" id="sipc" class="form-control">
                    </div>
                    <div class="form-group col-md-1">
                        <label for="sips">State </label>
                        <input type="text" name="sips" id="sips" class="form-control">
                    </div>
                    <div class="form-group col-md-2">
                        <label for="sipz">Zip </label>
                        <input type="text" name="sipz" id="sipz" class="form-control">
                        <small class="text-muted" id="rural-text"></small>
                    </div>
                    <div class="form-group col-md-3">
                        <label for="sipcr">Country </label>
                        <input type="text" name="sipcr" id="sipcr" class="form-control">
                    </div>
                </div>

                <div class="row">
                    <div class="form-group col-sm-6 ">
                        <label for="sippn">Phone number</label>
                        <input type="text" name="sippn" id="sippn" class="form-control">
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 form-group">
                        <label class="required">Rural status</label>
                        {{ f.inlineRadio("sirs", "sirs-u","u","Urban", true) }}
                        {{ f.inlineRadio("sirs", "sirs-r","r","Rural") }}
                        {{ f.inlineRadio("sirs", "sirs-n","n","Unknown") }}
                    </div>
                </div>

                <hr/>

                <h3>Smoking History</h3>

                {% include '_pack-year-history.jinja2' %}

                <div class="row">
                    <div class="col-lg-4 col-md-6 col-sm-6 form-group">
                        <label>Have you ever smoked</label>
                        <br/>
                        {{ f.inlineRadio("siesm", "siesm-n", "n", "Never") }}
                        {{ f.inlineRadio("siesm", "siesm-p", "p", "Past") }}
                        {{ f.inlineRadio("siesm", "siesm-c", "c", "Current") }}
                        {{ f.inlineCheckbox("siesq","1", "Willing to quit") }}
                    </div>
                    <div class="col-lg-8 col-md-6 col-sm-6 form-group">
                        <label for="sies">Comments</label>
                        <input type="text" name="sies" id="sies" class="form-control"/>
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sicpd', 'How many cigarettes did you smoke per day?', "required") }}
                    </div>
                    <div class="col-sm-2">
                        <input class="form-control numeric" type="text" name="sicpd" id="sicpd" maxlength="4"
                               required="required">
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sippd', 'How many <em>packs</em> of cigarettes did you smoke per day (PPD)?') }}
                    </div>
                    <div class="col-sm-2">
                        <span id="sippd-val" class="control-label"></span>
                    </div>
                    <input type="hidden" name="sippd" id="sippd"/>
                </div>
                <div class="row form-group">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sisny', '# of years', "required") }}
                    </div>
                    <div class="col-sm-2">
                        <input class="form-control numeric decimalformat" type="text" name="sisny" id="sisny"
                               required="required" maxlength="4">
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sippy', 'Reported pack years') }}
                    </div>
                    <div class="col-sm-8">
                        <span id="sippy-val"></span>
                        <div class="alert alert-info" id="cumulative-pack-years-message" style="display: none"></div>
                    </div>
                    <input type="hidden" name="sippy" id="sippy"/>
                </div>
                <div class="row form-group">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siq', 'Quit Date') }}
                    </div>
                    <div class="col-sm-4 col-md-3 col-lg-2">
                        {{ f.datepicker ("siq", "past") }}
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sicep', 'Smoking cessation education provided') }}
                    </div>
                    <div class="col-md-8">
                        <textarea class="form-control" type="text" name="sicep" id="sicep"></textarea>
                        <p class="help-block">Additional information can be provided on the background form</p>
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-md-4">
                        {{ f.floatingLabel('sicadx', 'Lung CA Dx (if applicable)') }}
                    </div>
                    <div class="col-md-4">
                        {{ f.datepicker ("sicadx", "past") }}
                    </div>
                    <div class="col-md-4 form-group">
                        <label class="aria-hidden" for="sicadxl">Lunc CA Dx location</label>
                        <input class="form-control" type="text" name="sicadxl" id="sicadxl"/>
                        <span class="help-block">Location if not in VA</span>
                    </div>
                </div>
                <div class="row form-group">
                    <div class="col-md-4">
                        {{ f.floatingLabel('siptct', 'Any prior CT') }}
                    </div>
                    <div class="col-md-4">
                        {{ f.datepicker ("siptct", "past") }}
                    </div>
                    <div class="col-md-4 form-group">
                        <label class="aria-hidden" for="siptctl">Location CT</label>
                        <input class="form-control" type="text" name="siptctl" id="siptctl"/>
                        <span class="help-block">Location if not in VA</span>
                    </div>
                </div>
                <hr/>
                <div id="enrollment-container">
                    <div class="row">
                        <div class="col-md-12 form-group">
                            <label>Informed decision making</label>
                            <br/>

                            <div class="radio">
                                <label>
                                    <input type="radio" name="siidmdc" id="siidmdc-n" value="0" required="required">
                                    Not applicable
                                </label>
                            </div>
                            <div class="radio">
                                <label>
                                    <input type="radio" name="siidmdc" id="siidmdc-y" value="1" required="required">
                                    Discussion complete
                                </label>
                                <p class="alert alert-warning" id="siidmdc-affirmation">
                                    Veteran of age and exposure to cigarette smoke as described above, and without a
                                    current
                                    diagnosis or obvious symptoms suggestive of lung cancer, has been educated today
                                    about
                                    the estimated risk for lung cancer, the possibility of a cure or life prolonging if
                                    an
                                    early lung cancer were to be found during screening, the possibility of imaging
                                    abnormalities not being lung cancer, the possibility of complications from
                                    additional
                                    diagnostic procedures, and the approximate amount of radiation exposure associated
                                    with
                                    each screening procedure. In addition, the Veteran has been educated today about the
                                    importance of adhering to annual lung screening, the possible impact of other
                                    medical
                                    conditions on the overall health status, the importance of avoiding exposure to
                                    cigarette smoke, available tobacco cessation programs and available lung screening
                                    services at this VA facility. Education material was provided to the Veteran.
                                    <br/>
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 form-group">
                            <label class="required">Based on this information, the Veteran has opted to</label>
                            <div class="radio">
                                <label>
                                    <input type="radio" name="sildct" id="sildct-n" value="n" required="required">
                                    Not enroll
                                </label>
                            </div>
                            <div class="radio">
                                <label>
                                    <input type="radio" name="sildct" id="sildct-l" value="l">
                                    Not enroll at this time, okay to contact in the future
                                </label>
                            </div>
                            <div class="radio">
                                <label>
                                    <input type="radio" name="sildct" id="sildct-y" value="y">
                                    Enroll in the Lung Screening program and have an LDCT ordered.
                                    Coordination of care will be made by the team
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-12 form-group">
                        <label for="siclin" class="control-label">Clinical Indications for Initial Screening CT</label>
                        <textarea class="form-control" id="siclin" name="siclin" rows="3"></textarea>
                    </div>
                </div>

                <hr/>
                <h3>Participant Communication Record</h3>
                <div class="row">
                    <div class="col-md-12 form-group">
                        <label class="aria-hidden">Participant communication record</label>
                        <textarea class="form-control" name="sipcrn" id="sipcrn" rows="3"></textarea>
                        <span class="help-block">Free-form notes to track communications with the participant</span>
                    </div>
                </div>
                <div class="row" id="communication-log-container">
                    <div class="col-sm-12">
                        <h4>Communication Log</h4>
                        <pre class="prettyprint source linenums"
                             id="commlog">{{ "2018-10-31 12:00 PM - {USERNAME}: {TEXT HERE}" if mockup else "" }}</pre>
                    </div>
                </div>

                <hr/>
                <h3>Current Status</h3>
                <div class="row">
                    <div class="col-md-3 col-lg-2 form-group">
                        <label for="sistatus" class="required">Enrollment</label><br/>
                        {{ f.inlineRadio("sistatus", "sistatus-active", "active", "Active", true) }}
                        {{ f.inlineRadio("sistatus", "sistatus-inactive", "inactive", "Not active") }}
                    </div>
                    <div class="col-md-3 col-lg-2" id="ctappt-container">
                        <div class="form-group">
                            <label for="sicectap">CT Appointment</label>
                            {{ f.datepicker('sicectap', '', true) }}
                        </div>
                    </div>
                </div>

                <div id="reason-for-change-container" style="display: none;">
                    <hr/>
                    <h3>Reason for change</h3>
                    <div class="row">
                        <div class="col-md-12 form-group">
                            <label for="sistachg" class="required">Reason</label><br/>
                            <select id="sistachg" name="sistachg" required="required" class="form-control">
                                <option value="">-</option>
                                <option value="transferred">Transferred to another institution (specify)</option>
                                <option value="medical">Unable due to medical reason (specify)</option>
                                <option value="unwilling">Unwilling due to personal reason (specify)</option>
                                <option value="refused">Refused to continue</option>
                                <option value="illadvised">Physician advised against</option>
                                <option value="radiation">Concern about radiation</option>
                                <option value="moved">Moved and unable to return</option>
                                <option value="insurance">No insurance, can't have Dx CT</option>
                                <option value="cost">Burden of cost</option>
                                <option value="deceased">Deceased</option>
                                <option value="other">Other (specify)</option>
                                <option value="excluded">Excluded (specify)</option>
                                <option value="complete">Study complete</option>
                                <option value="noresponse">No response to 3 calls + 3 letters</option>
                                <option value="nocontact">Unable to contact</option>
                                <option value="followed">Being followed elsewhere (get results)</option>
                            </select>
                        </div>
                    </div>

                    <div class="row" id="date-of-death-container">
                        <div class="col-md-4 form-group">
                            <label for="sidod" class="required">Date of death</label>
                            {{ f.datepicker('sidod', 'past', true) }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8 form-group">
                            <label for="sistreas" class="required">Explanation</label><br/>
                            <textarea class="form-control" type="text" name="sistreas" id="sistreas"></textarea>
                        </div>
                    </div>

                </div>

                <div class="row" id="change-log-container">
                    <div class="col-sm-12">
                        <h4>Change Log</h4>
                        <pre class="prettyprint source linenums"
                             id="changelog">{{ "2018-10-31 12:00 PM - {USERNAME} changed to {FIELD} to {VALUE}: {REASON} - {EXPLANATION}" if mockup else "" }}</pre>
                    </div>
                </div>

                <hr/>
                <div class="pull-left">
                    <input type="hidden" name="samistatus" value=""/>
                    <button type="submit" class="btn btn-default" id="save-for-later-button"
                            formnovalidate="formnovalidate">Save for Later
                    </button>
                    <button type="submit" class="btn btn-primary" id="submit-button">Submit</button>
                </div>
                <div class="pull-right">
                    <a id="delete-form" class="btn btn-danger"><span class="glyphicon glyphicon-trash"></span>Delete</a>
                </div>
            </div>
        </form>
    </div>

    {{ f.deleteFormModal("intake.html", mockup, formMethod) }}


{% endblock %}

{% block script %}
    <script>
        //NB: intentionally executed before DOM is rendered so section is never visible
        const newForm = "@@NEWFORM@@";
        const chartEligibilityNoteExists = "@@CHART_ELIGIBILITY_NOTE_EXISTS@@" === "true" || "@@PRE_ENROLLMENT_NOTE_EXISTS@@" === "true" || "@@INTAKE_NOTE_EXISTS@@" === "true";
        const preEnrollmentNoteExists = "@@PRE_ENROLLMENT_NOTE_EXISTS@@" === "true" || "@@INTAKE_NOTE_EXISTS@@" === "true";

        //NB: intentionally evaluated here, before DOM is manipulated
        const eligible = $("[name=sicechrt]:checked").val();
        const enrolledVal = $("[name=sildct]:checked").val() || $("#sildct").val(); //visible checkbox or hidden field value
        const enrolled = enrolledVal === "y";

        if (newForm === "true") {
            $("#reason-for-change-container").remove();
            $("#change-log-container").remove();
        }


        if (chartEligibilityNoteExists) {
            let notice = "";
            let noticeClass = "alert-info";

            if (eligible === 'y' || eligible === 'n') { //NB: question was answered
                $("#chart-eligibility").html("");
                if (eligible === 'y') {
                    notice += "Previously considered to be <em>eligible</em> based on a chart review.";
                } else if (eligible === 'n') {
                    notice += "Previously considered <strong>ineligible<strong> during a chart review. Refer to eligibility note for details.";
                    noticeClass = "alert-warning";
                }
            }

            if (preEnrollmentNoteExists) {
                const discussionHeldValue = $("[name=sipedisc]:checked").val();
                if (discussionHeldValue === 'y') {
                    notice += "<br/><br/>";
                    notice += "A pre-enrollment discussion was held with the participant";

                    const discussionDateValue = $("#sipedc").val();
                    if (discussionDateValue) {
                        notice += " on " + discussionDateValue;
                    }
                    notice += ".";

                    const discussionResultDesc = $("[name=siperslt]:checked").parent("label").text().trim();
                    if (discussionResultDesc) {
                        notice += " The result of that discussion was \"" + discussionResultDesc + "\"";
                    }

                    $("#pre-enrollment-discussion").html(""); //clear out the HTML regardless of value
                }
            }

            //now add the note to the DOM:
            if (notice !== "") {
                const $preSection = $("#chart-eligibility");
                const $preRow = $('<div class="row"></div>');
                const $preCol = $('<div class="col-lg-8 col-md-12"></div>');
                const $alert = $('<div class="alert ' + noticeClass + '">' + notice + '</div>');
                $preCol.append($alert);
                $preRow.append($preCol);
                $preSection.append($preRow);
                $("#wizard-bar").remove(); // no need for the navbar
            }
        }

        if (enrolled) {
            const $enrollSection = $("#enrollment-container").html("");
            const $enrollRow = $('<div class="row"></div>');
            const $enrollCol = $('<div class="col-lg-5 col-md-6 col-sm-8"></div>');
            const $enrollAlert = $("<div class=\"alert alert-info\">Informed decision making was completed and " +
                "participant is enrolled in the Lung Screening program.</div>");
            $enrollCol.append($('<input type="hidden" id="sildct" name="sildct" value="y"/>')); //veteran's option to enroll
            $enrollCol.append($('<input type="hidden" id="siidmdc" name="siidmdc" value="1"/>')); //informed decision making

            $enrollCol.append($enrollAlert);
            $enrollRow.append($enrollCol);
            $enrollSection.append($enrollRow);
        }

        function createFormValidator() {

            const $form = $('#main-form');
            const multiInputValidators = ['siceiden', 'sicechrt', 'sicemhlc', 'sipedisc', 'sipav', 'sirs', 'sistatus'];

            $form.formValidation({
                    fields: {
                        //Intake section only here
                        sidc: {
                            validators: {
                                notEmpty: {message: 'Contact date is required'},
                                date: {max: VAPALS.todaysDate(), message: 'Contact date may not be in the future'}
                            }
                        },
                        silnip: { //use a real element name for the field so conditional plugins can toggle the field
                            selector: '[group=intake-contact]',
                            validators: {choice: {min: 1, message: 'Select one or more contact methods'}}
                        },
                        silnoo: {validators: {notEmpty: {message: 'Other contact method is required'}}},
                        sipav: {validators: {notEmpty: {message: 'Primary address verification is required'}}},
                        //TODO: shouldn't address be required?
                        sippn: {validators: {phone: {message: 'Not a valid US phone number', country: 'US'}}},
                        sirs: {validators: {notEmpty: {message: 'Rural status is required'}}},
                        sicpd: {
                            validators: {
                                notEmpty: {message: 'Packs per day is required'},
                                integer: {message: 'must be a whole number'}
                            }
                        },
                        sisny: {
                            validators: {
                                notEmpty: {message: 'Number of years is required'},
                                integer: {message: 'Must be a whole number'}
                            }
                        },
                        sistatus: {validators: {notEmpty: {message: 'Enrollment status is required'}}},
                        sistachg: {validators: {notEmpty: {message: 'Reason for change is required'}}},
                        sistreas: {validators: {notEmpty: {message: 'Explanation is required'}}},

                    },
                    plugins: {
                        declarative: new FormValidation.plugins.Declarative(),
                        trigger: new FormValidation.plugins.Trigger(),
                        bootstrap3: new FormValidation.plugins.Bootstrap3(),
                        submitButton: new FormValidation.plugins.SubmitButton(),
                        defaultSubmit: new FormValidation.plugins.DefaultSubmit(),
                        excluded: new FormValidation.plugins.Excluded(), //disable validators on hidden, disabled fields
                        icon: new FormValidation.plugins.Icon({
                            valid: '',
                            invalid: 'glyphicon glyphicon-remove',
                            validating: 'glyphicon glyphicon-refresh',
                            onPlaced: function (e) {
                                if (multiInputValidators.indexOf(e.field) > -1) {
                                    $fg = $("#" + e.element.id).closest(".form-group");
                                    $c = $fg.find(".fv-plugins-message-container");
                                    if ($c.length == 1) {
                                        $c.append(e.iconElement);
                                    } else {
                                        $fg.append(e.iconElement);
                                    }
                                }
                            },
                        })
                    }
                }
            );

            //NB: keep this else event handlers won't work.
            const fv = $form.data("formValidation");

            // when enrolled these fields are removed from the DOM, so we add the validators here
            if (!enrolled) {

                // CHART REVIEW
                fv.addField('sicechrt', {validators: {notEmpty: {message: 'Chart review is required'}}});
                fv.addField('siceiden', {validators: {notEmpty: {message: 'Potential candidate is required'}}});
                fv.addField('sicerfdt', {
                    validators: {
                        notEmpty: {message: 'Referral date is required'},
                        date: {max: VAPALS.todaysDate(), message: 'Referral date may not be in the future'}
                    }
                });
                fv.addField('sicerfpc', {
                    //use a real element name for the field so conditional plugins can toggle the field
                    selector: '[name^=sicerf][type=checkbox]',
                    validators: {choice: {min: 1, message: 'Select one or more specialty providers'}}
                });
                fv.addField('sicerfoo', {
                    validators: {notEmpty: {message: 'Other referring provider specialty is required'}}
                });
                fv.addField('sicemhlc', { //use a real element name for the field so conditional plugins can toggle the field
                    selector: '[group=ineligible-reason]',
                    validators: {choice: {min: 1, message: 'Select one or more reasons'}}
                });
                fv.addField('sicemhoo', {validators: {notEmpty: {message: 'Other medical reason is required'}}});
                fv.addField('siceceoo', {validators: {notEmpty: {message: 'Other care is required'}}});
                fv.addField('siceshoo', {validators: {notEmpty: {message: 'Other smoking history is required'}}});

                // PRE-ENROLLMENT DISCUSSION
                fv.addField('sipedisc', {validators: {notEmpty: {message: 'Discussion review is required'}}});
                fv.addField('sipedc', {
                    validators: {
                        notEmpty: {message: 'Contact date is required'},
                        date: {max: VAPALS.todaysDate(), message: 'Contact date may not be in the future'}
                    }
                });
                fv.addField('sipecnip', { //use a real element name for the field so conditional plugins can toggle the field
                    selector: '[group=discussion-contact]',
                    validators: {choice: {min: 1, message: 'Select one or more contact methods'}}
                });
                fv.addField('sipecnoo', {validators: {notEmpty: {message: 'Other contact method is required'}}});
                fv.addField('siperslt', {validators: {notEmpty: {message: 'Discussion result is required'}}});

                // INTAKE AREA
                fv.addField('siidmdc', {validators: {notEmpty: {message: 'Informed decision making is required'}}});
                fv.addField('sildct', {validators: {notEmpty: {message: 'Veteran\'s option is required'}}});
                fv.addField('sidod', {
                    validators: {
                        notEmpty: {message: 'Date of death is required'},
                        date: {max: VAPALS.todaysDate(), message: 'Date of death may not be in the future'}
                    }
                });
            }

            fv.on('core.form.invalid', VAPALS.autoScrollToErrorField);
            fv.on('core.element.validated', VAPALS.hideSuccessFormatting);

            return fv;
        }

        $(function () {

            const fv = createFormValidator();
            $("#save-for-later-button").on('click', function () {
                fv.destroy();
            });

            const initialRuralUrbanValue = $("[name=sirs]").filter(":checked").val();
            const $zipField = $("#sipz");
            const RURAL = 'r';
            const URBAN = 'u';
            const UNKNOWN = 'n';
            let zipLookupTimer = 0;

            function zipLookup(updateSelection) {
                const zipcode = $zipField.val();
                const $ruralText = $("#rural-text");
                $.ajax(("/zipru/" + zipcode), {dataType: "json"})
                    .done(function (json) {
                        const ruralData = json.result;
                        let message = "";
                        if (ruralData === URBAN) {
                            message = zipcode + " is an <em>urban</em> address";
                            if (updateSelection) {
                                $("[name=sirs][value='" + URBAN + "']").prop('checked', true);
                            }
                        } else if (ruralData === RURAL) {
                            message = zipcode + " is a <em>rural</em> address";
                            if (updateSelection) {
                                $("[name=sirs][value='" + RURAL + "']").prop('checked', true);
                            }
                        } else if (ruralData === UNKNOWN) {
                            message = "cannot determine rural/urban status";
                            if (updateSelection) {
                                $("[name=sirs][value='" + UNKNOWN + "']").prop('checked', true);
                            }
                        }
                        $ruralText.html(message);
                    })
                    .fail(function () {
                        $ruralText.html("");
                    });
            }

            //whenever the zip code is changed, determine the zip code designation, but wait until user stops typing.
            $zipField.on('keyup change', function () {
                if (zipLookupTimer) {
                    clearTimeout(zipLookupTimer);
                }
                zipLookupTimer = setTimeout(function () {
                    zipLookup(true);
                }, 400);
            });

            if ($zipField.val() !== "") {
                //if selection is blank, select the appropriate value, otherwise just get the help text
                const updateSelection = initialRuralUrbanValue === undefined;
                zipLookup(updateSelection);
            }

            //PRE-ENROLLMENT CHART ELIGIBILITY
            $("[name=siceiden]").conditionallyDisplay({sourceValues: "referral", enable: "#referral-container"});
            $("#sicerfot").conditionallyDisplay({enable: "#sicerfoo"});

            //If not eligible via chart, require the reason, hide the remainder of the form.
            $("[name=sicechrt]").conditionallyDisplay({
                sourceValues: "n",
                enable: "#reason-container",
                disable: "#pre-enrollment-discussion" //, #intake, #intake-tab
            }).on('change', function () {
                //when participant is eligible, display informational message requiring remaining sections be completed.
                const eligible = $("[name=sicechrt]:checked").val();
                $("#sicechrt-y-alert").toggle(eligible === "y");
            });

            // "other" fields in reason block
            $("#sicemhot").conditionallyDisplay({enable: "#sicemhoo"}); //other medical history
            $("#siceceot").conditionallyDisplay({enable: "#siceceoo"}); //received care elsewhere
            $("#siceshot").conditionallyDisplay({enable: "#siceshoo"}); //other smoking history

            // start the page by hiding the pre-enrollment discussion and intake sections if the current value for
            // eligible based on chart review was not answered or was answered NO
            if (!enrolled && (eligible === undefined || eligible === 'n')) {
                $("#pre-enrollment-discussion").hide(); //, #intake, #intake-tab
            }

            //PRE-ENROLLMENT PATIENT DISCUSSION

            //enable discussion container when pre-enrollment discussion occurred AND enable intake area when
            // pre-enrollment did NOT occur (default)
            $("[name=sipedisc]")
                .conditionallyDisplay({sourceValues: 'y', enable: '#discussion-container'});
            //.conditionallyDisplay({sourceValues: 'n', enable: '#intake,#intake-tab'});

            //enable intake when pre-enrollment result is that the participant want's in.
            //$("[name=siperslt]").conditionallyDisplay({enable: '#intake,#intake-tab'});

            $("#sipecnot").conditionallyEnable({sourceValues: "1", enable: "#sipecnoo"}); // other contact method

            // If unselected (initial form), preselect "no" as the default.
            const hadDiscussion = $("[name=sipedisc]:checked").val();
            if (hadDiscussion === undefined) {
                $("#sipedisc-n").prop("checked", true);
            }

            //INTAKE
            $("#silnot").conditionallyEnable({sourceValues: "1", enable: "#silnoo"});
            $("#sistachg").conditionallyDisplay({sourceValues: "deceased", enable: "#date-of-death-container"})
            $("#sicpd").on('keyup change', function () {
                const cigsPerDay = $("#sicpd").val();
                const $sippd = $("#sippd");
                const $sippdVal = $("#sippd-val");
                if (cigsPerDay >= 0) {
                    const cpd = VAPALS.calculatePacksPerDay(cigsPerDay);
                    if (cpd > 0) {
                        $sippd.val(cpd);
                        $sippdVal.text(cpd);
                    } else {
                        $sippd.val("");
                        $sippdVal.text("-");
                    }
                    $sippd.change();
                }
            }).trigger('keyup');

            $("#sidc, #sippd, #sisny").on('keyup change', function () {
                const packsPerDay = $("#sippd").val();
                const cigYears = $("#sisny").val();
                const packYears = VAPALS.calculatePackYears(packsPerDay, cigYears);

                if (packYears > 0) {
                    $("#sippy").val(packYears.toFixed(2));
                    let packYearsText = packYears.toFixed(2);
                    const $currentFormRow = $("#pack-years-history tbody tr[data-current-form]").last();
                    if ($currentFormRow.length == 1) {
                        let intakeDate = VAPALS.toMoment($("#sidc").val());
                        if (!intakeDate.isValid()) {
                            intakeDate = moment();
                        }
                        packYearsText += " thru " + intakeDate.format(VAPALS.DATE_FORMAT);
                    }
                    $("#sippy-val").text(packYearsText);
                } else {
                    $("#sippy").val("");
                    $("#sippy-val").text("-");
                }

                const cumulative = computeCumulativePackYears(packYears);
                $("#sippycu").val(cumulative.toFixed(2));
                const message = "Cumulative pack years will be updated to <strong>" + cumulative.toFixed(2) + "</strong>";
                $("#cumulative-pack-years-message").html(message).show();
            });
            $("#sidc").trigger('keyup');

            //removed smoking history table if there is none (i.e. initial intake form entry)
            if ($("#pack-years-history tbody tr").length === 0) {
                $("#pack-years-history").remove();
            }

            $("[name=siidmdc]").conditionallyDisplay({sourceValues: "1", enable: "#siidmdc-affirmation"});

            $("[name=sistatus]").on('change', function () {
                //require reason fields when marking participant as "not active"
                $("#reason-for-change-container").toggle($("#sistatus-inactive").is(":checked"));

            });

            $('#body').scrollspy({target: '#wizard-bar'})
        });

        //NB: needs to be outside of jquery fx to prevent default
        $("#save-chart-eligibility").on('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            const fv = $("form").data("formValidation");

            validateSection(fv, $("#chart-eligibility")).then(function (valid) {
                if (valid) {
                    $("[name=samistatus]").val("chart-eligibility");
                    $("form").trigger("submit");
                }
            });
        });
        $("#save-pre-enrollment-discussion").on('click', function (e) {
            e.preventDefault();
            e.stopPropagation();
            const fv = $("form").data("formValidation");

            validateSection(fv, $("#pre-enrollment-discussion")).then(function (valid) {
                if (valid) {
                    $("[name=samistatus]").val("pre-enrollment-discussion");
                    $("form").trigger("submit");
                }
            });
        });


        /**
         * Validates all visible input fields within a section of the page using the provided formValidation instance
         * @param fv the form validator
         * @param $section the area to validate.
         * @returns {Promise<boolean>} true if validated without error; otherwise false.
         */
        function validateSection(fv, $section) {
            const $inputFields = $section.find(":input:visible");
            const fieldNames = $inputFields.map(function () {
                return this.name;
            }).get();
            const distinctNames = fieldNames.filter(VAPALS.unique);
            return new Promise(function (resolve) {
                const validationPromises = [];
                if (fv) {
                    $.each(distinctNames, function (i, fieldName) {
                        if (fieldName in fv.fields) {
                            validationPromises.push(fv.validateField(fieldName));
                        }
                    });
                }

                Promise.all(validationPromises).then(function (values) {
                    $.each(values, function (i, v) {
                        if (v === 'Invalid') {
                            return resolve(false);
                        }
                    });
                    return (resolve(true));
                });
            });
        }
    </script>
{% endblock %}
